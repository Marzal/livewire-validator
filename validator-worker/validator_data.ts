export const VALIDATOR_APP_HASH = 'e92ee54313fe68181283bdb773cb6e9849475f59';
export const VALIDATOR_APP_B64 = 'Ly8gZGVuby1mbXQtaWdub3JlLWZpbGUKLy8gZGVuby1saW50LWlnbm9yZS1maWxlCi8vIFRoaXMgY29kZSB3YXMgYnVuZGxlZCB1c2luZyBgZGVubyBidW5kbGVgIGFuZCBpdCdzIG5vdCByZWNvbW1lbmRlZCB0byBlZGl0IGl0IG1hbnVhbGx5Cgpjb25zdCBkaXJlY3RpdmVzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgaXNEaXJlY3RpdmUgPSAobyk9PnsKICAgIHJldHVybiB0eXBlb2YgbyA9PT0gImZ1bmN0aW9uIiAmJiBkaXJlY3RpdmVzLmhhcyhvKTsKfTsKY29uc3QgaXNDRVBvbHlmaWxsID0gdHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzICE9IG51bGwgJiYgd2luZG93LmN1c3RvbUVsZW1lbnRzLnBvbHlmaWxsV3JhcEZsdXNoQ2FsbGJhY2sgIT09IHZvaWQgMDsKY29uc3QgcmVwYXJlbnROb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsLCBiZWZvcmUgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5pbnNlcnRCZWZvcmUoc3RhcnQsIGJlZm9yZSk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCByZW1vdmVOb2RlcyA9IChjb250YWluZXIsIHN0YXJ0LCBlbmQgPSBudWxsKT0+ewogICAgd2hpbGUoc3RhcnQgIT09IGVuZCl7CiAgICAgICAgY29uc3QgbiA9IHN0YXJ0Lm5leHRTaWJsaW5nOwogICAgICAgIGNvbnRhaW5lci5yZW1vdmVDaGlsZChzdGFydCk7CiAgICAgICAgc3RhcnQgPSBuOwogICAgfQp9Owpjb25zdCBub0NoYW5nZSA9IHt9Owpjb25zdCBub3RoaW5nID0ge307CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7fQp9KSgpOwpjbGFzcyBFdmVudFBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyID0gbmV3IEF0dHJpYnV0ZUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICByZXR1cm4gY29tbWl0dGVyLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0KSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQudHlwZSk7CiAgICBpZiAodGVtcGxhdGVDYWNoZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGVDYWNoZSA9IHsKICAgICAgICAgICAgc3RyaW5nc0FycmF5OiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgICBrZXlTdHJpbmc6IG5ldyBNYXAoKQogICAgICAgIH07CiAgICAgICAgdGVtcGxhdGVDYWNoZXMuc2V0KHJlc3VsdC50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQuc3RyaW5ncyk7CiAgICBpZiAodGVtcGxhdGUgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdC5zdHJpbmdzLmpvaW4obWFya2VyKTsKICAgIHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHJlc3VsdCwgcmVzdWx0LmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZSk7CiAgICB9CiAgICB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5zZXQocmVzdWx0LnN0cmluZ3MsIHRlbXBsYXRlKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKfQpjb25zdCB0ZW1wbGF0ZUNhY2hlcyA9IG5ldyBNYXAoKTsKY29uc3QgcGFydHMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCByZW5kZXIgPSAocmVzdWx0LCBjb250YWluZXIsIG9wdGlvbnMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMpKSk7CiAgICAgICAgcGFydC5hcHBlbmRJbnRvKGNvbnRhaW5lcik7CiAgICB9CiAgICBwYXJ0LnNldFZhbHVlKHJlc3VsdCk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFRlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKY29uc3Qgc3ZnID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9Pm5ldyBTVkdUZW1wbGF0ZVJlc3VsdChzdHJpbmdzLCB2YWx1ZXMsICJzdmciLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKdmFyIF9hOwp3aW5kb3cuSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSA9IChwcm9wLCBfb2JqKT0+cHJvcAo7CmNvbnN0IGRlZmF1bHRDb252ZXJ0ZXIgPSB7CiAgICB0b0F0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICIiIDogbnVsbDsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZnJvbUF0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbDsKICAgICAgICAgICAgY2FzZSBOdW1iZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfTsKY29uc3Qgbm90RXF1YWwgPSAodmFsdWUsIG9sZCk9PnsKICAgIHJldHVybiBvbGQgIT09IHZhbHVlICYmIChvbGQgPT09IG9sZCB8fCB2YWx1ZSA9PT0gdmFsdWUpOwp9Owpjb25zdCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbiA9IHsKICAgIGF0dHJpYnV0ZTogdHJ1ZSwKICAgIHR5cGU6IFN0cmluZywKICAgIGNvbnZlcnRlcjogZGVmYXVsdENvbnZlcnRlciwKICAgIHJlZmxlY3Q6IGZhbHNlLAogICAgaGFzQ2hhbmdlZDogbm90RXF1YWwKfTsKY29uc3QgU1RBVEVfSEFTX1VQREFURUQgPSAxOwpjb25zdCBTVEFURV9VUERBVEVfUkVRVUVTVEVEID0gMSA8PCAyOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSA9IDEgPDwgMzsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSA9IDEgPDwgNDsKY29uc3QgZmluYWxpemVkID0gImZpbmFsaXplZCI7CmNsYXNzIFVwZGF0aW5nRWxlbWVudCBleHRlbmRzIEhUTUxFbGVtZW50IHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT57CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkocCwgdik7CiAgICAgICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuc2V0KGF0dHIsIHApOwogICAgICAgICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBzdGF0aWMgX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX2NsYXNzUHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGNvbnN0IHN1cGVyUHJvcGVydGllcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5fY2xhc3NQcm9wZXJ0aWVzOwogICAgICAgICAgICBpZiAoc3VwZXJQcm9wZXJ0aWVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHN1cGVyUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChrLCB2KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBjcmVhdGVQcm9wZXJ0eShuYW1lLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5vQWNjZXNzb3IgfHwgdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgbmFtZSA9PT0gInN5bWJvbCIgPyBTeW1ib2woKSA6IGBfXyR7bmFtZX1gOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSB0aGlzLmdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpOwogICAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMucHJvdG90eXBlLCBuYW1lLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldCAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1trZXldOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSkgewogICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgJiYgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmdldChuYW1lKSB8fCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBmaW5hbGl6ZSgpIHsKICAgICAgICBjb25zdCBzdXBlckN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgaWYgKCFzdXBlckN0b3IuaGFzT3duUHJvcGVydHkoZmluYWxpemVkKSkgewogICAgICAgICAgICBzdXBlckN0b3IuZmluYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgdGhpc1tmaW5hbGl6ZWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwID0gbmV3IE1hcCgpOwogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoInByb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgY29uc3QgcHJvcHMxID0gdGhpcy5wcm9wZXJ0aWVzOwogICAgICAgICAgICBjb25zdCBwcm9wS2V5cyA9IFsKICAgICAgICAgICAgICAgIC4uLk9iamVjdC5nZXRPd25Qcm9wZXJ0eU5hbWVzKHByb3BzMSksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMxKSA6IFtdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9wS2V5cyl7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5KHAsIHByb3BzMVtwXSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShuYW1lLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgYXR0cmlidXRlID0gb3B0aW9ucy5hdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZSA9PT0gZmFsc2UgPyB2b2lkIDAgOiB0eXBlb2YgYXR0cmlidXRlID09PSAic3RyaW5nIiA/IGF0dHJpYnV0ZSA6IHR5cGVvZiBuYW1lID09PSAic3RyaW5nIiA/IG5hbWUudG9Mb3dlckNhc2UoKSA6IHZvaWQgMDsKICAgIH0KICAgIHN0YXRpYyBfdmFsdWVIYXNDaGFuZ2VkKHZhbHVlLCBvbGQsIGhhc0NoYW5nZWQgPSBub3RFcXVhbCkgewogICAgICAgIHJldHVybiBoYXNDaGFuZ2VkKHZhbHVlLCBvbGQpOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlRnJvbUF0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXIgfHwgZGVmYXVsdENvbnZlcnRlcjsKICAgICAgICBjb25zdCBmcm9tQXR0cmlidXRlID0gdHlwZW9mIGNvbnZlcnRlciA9PT0gImZ1bmN0aW9uIiA/IGNvbnZlcnRlciA6IGNvbnZlcnRlci5mcm9tQXR0cmlidXRlOwogICAgICAgIHJldHVybiBmcm9tQXR0cmlidXRlID8gZnJvbUF0dHJpYnV0ZSh2YWx1ZSwgdHlwZSkgOiB2YWx1ZTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlcjsKICAgICAgICBjb25zdCB0b0F0dHJpYnV0ZSA9IGNvbnZlcnRlciAmJiBjb252ZXJ0ZXIudG9BdHRyaWJ1dGUgfHwgZGVmYXVsdENvbnZlcnRlci50b0F0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gdG9BdHRyaWJ1dGUodmFsdWUsIHR5cGUpOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IDA7CiAgICAgICAgdGhpcy5fdXBkYXRlUHJvbWlzZSA9IG5ldyBQcm9taXNlKChyZXMpPT50aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyID0gcmVzCiAgICAgICAgKTsKICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLl9zYXZlSW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwoKTsKICAgIH0KICAgIF9zYXZlSW5zdGFuY2VQcm9wZXJ0aWVzKCkgewogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2NsYXNzUHJvcGVydGllcy5mb3JFYWNoKChfdiwgcCk9PnsKICAgICAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkocCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gdGhpc1twXTsKICAgICAgICAgICAgICAgIGRlbGV0ZSB0aGlzW3BdOwogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuc2V0KHAsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgfQogICAgX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCkgewogICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5mb3JFYWNoKCh2LCBwKT0+dGhpc1twXSA9IHYKICAgICAgICApOwogICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IHZvaWQgMDsKICAgIH0KICAgIGNvbm5lY3RlZENhbGxiYWNrKCkgewogICAgICAgIHRoaXMuZW5hYmxlVXBkYXRpbmcoKTsKICAgIH0KICAgIGVuYWJsZVVwZGF0aW5nKCkgewogICAgICAgIGlmICh0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlcigpOwogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyID0gdm9pZCAwOwogICAgICAgIH0KICAgIH0KICAgIGRpc2Nvbm5lY3RlZENhbGxiYWNrKCkge30KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHt9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykge30KICAgIGZpcnN0VXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHt9Cn0KX2EgPSBmaW5hbGl6ZWQ7ClVwZGF0aW5nRWxlbWVudFtfYV0gPSB0cnVlOwpjb25zdCBFbGVtZW50UHJvdG8gPSBFbGVtZW50LnByb3RvdHlwZTsKRWxlbWVudFByb3RvLm1zTWF0Y2hlc1NlbGVjdG9yIHx8IEVsZW1lbnRQcm90by53ZWJraXRNYXRjaGVzU2VsZWN0b3I7CmNvbnN0IHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cyA9IHdpbmRvdy5TaGFkb3dSb290ICYmICh3aW5kb3cuU2hhZHlDU1MgPT09IHZvaWQgMCB8fCB3aW5kb3cuU2hhZHlDU1MubmF0aXZlU2hhZG93KSAmJiAiYWRvcHRlZFN0eWxlU2hlZXRzIiBpbiBEb2N1bWVudC5wcm90b3R5cGUgJiYgInJlcGxhY2UiIGluIENTU1N0eWxlU2hlZXQucHJvdG90eXBlOwpjb25zdCBjb25zdHJ1Y3Rpb25Ub2tlbiA9IFN5bWJvbCgpOwpjbGFzcyBDU1NSZXN1bHQgewogICAgY29uc3RydWN0b3IoY3NzVGV4dCwgc2FmZVRva2VuKXsKICAgICAgICBpZiAoc2FmZVRva2VuICE9PSBjb25zdHJ1Y3Rpb25Ub2tlbikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkNTU1Jlc3VsdCBpcyBub3QgY29uc3RydWN0YWJsZS4gVXNlIGB1bnNhZmVDU1NgIG9yIGBjc3NgIGluc3RlYWQuIik7CiAgICAgICAgfQogICAgICAgIHRoaXMuY3NzVGV4dCA9IGNzc1RleHQ7CiAgICB9CiAgICBnZXQgc3R5bGVTaGVldCgpIHsKICAgICAgICBpZiAodGhpcy5fc3R5bGVTaGVldCA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGlmIChzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBuZXcgQ1NTU3R5bGVTaGVldCgpOwogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldC5yZXBsYWNlU3luYyh0aGlzLmNzc1RleHQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG51bGw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXMuX3N0eWxlU2hlZXQ7CiAgICB9CiAgICB0b1N0cmluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jc3NUZXh0OwogICAgfQp9CmNvbnN0IHVuc2FmZUNTUyA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBuZXcgQ1NTUmVzdWx0KFN0cmluZyh2YWx1ZSksIGNvbnN0cnVjdGlvblRva2VuKTsKfTsKY29uc3QgdGV4dEZyb21DU1NSZXN1bHQgPSAodmFsdWUpPT57CiAgICBpZiAodmFsdWUgaW5zdGFuY2VvZiBDU1NSZXN1bHQpIHsKICAgICAgICByZXR1cm4gdmFsdWUuY3NzVGV4dDsKICAgIH0gZWxzZSBpZiAodHlwZW9mIHZhbHVlID09PSAibnVtYmVyIikgewogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBWYWx1ZSBwYXNzZWQgdG8gJ2NzcycgZnVuY3Rpb24gbXVzdCBiZSBhICdjc3MnIGZ1bmN0aW9uIHJlc3VsdDogJHt2YWx1ZX0uIFVzZSAndW5zYWZlQ1NTJyB0byBwYXNzIG5vbi1saXRlcmFsIHZhbHVlcywgYnV0CiAgICAgICAgICAgIHRha2UgY2FyZSB0byBlbnN1cmUgcGFnZSBzZWN1cml0eS5gKTsKICAgIH0KfTsKY29uc3QgY3NzID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9PnsKICAgIGNvbnN0IGNzc1RleHQgPSB2YWx1ZXMucmVkdWNlKChhY2MsIHYsIGlkeCk9PmFjYyArIHRleHRGcm9tQ1NTUmVzdWx0KHYpICsgc3RyaW5nc1tpZHggKyAxXQogICAgLCBzdHJpbmdzWzBdKTsKICAgIHJldHVybiBuZXcgQ1NTUmVzdWx0KGNzc1RleHQsIGNvbnN0cnVjdGlvblRva2VuKTsKfTsKKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0RWxlbWVudFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjIuNS4xIik7CmNvbnN0IHJlbmRlck5vdEltcGxlbWVudGVkID0ge307CmNsYXNzIExpdEVsZW1lbnQgZXh0ZW5kcyBVcGRhdGluZ0VsZW1lbnQgewogICAgc3RhdGljIGdldFN0eWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdHlsZXM7CiAgICB9CiAgICBzdGF0aWMgX2dldFVuaXF1ZVN0eWxlcygpIHsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfc3R5bGVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXNlclN0eWxlcyA9IHRoaXMuZ2V0U3R5bGVzKCk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXNlclN0eWxlcykpIHsKICAgICAgICAgICAgY29uc3QgYWRkU3R5bGVzID0gKHN0eWxlczIsIHNldDIpPT5zdHlsZXMyLnJlZHVjZVJpZ2h0KChzZXQzLCBzKT0+QXJyYXkuaXNBcnJheShzKSA/IGFkZFN0eWxlcyhzLCBzZXQzKSA6IChzZXQzLmFkZChzKSwgc2V0MykKICAgICAgICAgICAgICAgICwgc2V0MikKICAgICAgICAgICAgOwogICAgICAgICAgICBjb25zdCBzZXQgPSBhZGRTdHlsZXModXNlclN0eWxlcywgbmV3IFNldCgpKTsKICAgICAgICAgICAgY29uc3Qgc3R5bGVzID0gW107CiAgICAgICAgICAgIHNldC5mb3JFYWNoKCh2KT0+c3R5bGVzLnVuc2hpZnQodikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gc3R5bGVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHVzZXJTdHlsZXMgPT09IHZvaWQgMCA/IFtdIDogWwogICAgICAgICAgICAgICAgdXNlclN0eWxlcwogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdHlsZXMgPSB0aGlzLl9zdHlsZXMubWFwKChzKT0+ewogICAgICAgICAgICBpZiAocyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgJiYgIXN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgY29uc3QgY3NzVGV4dCA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHMuY3NzUnVsZXMpLnJlZHVjZSgoY3NzMiwgcnVsZSk9PmNzczIgKyBydWxlLmNzc1RleHQKICAgICAgICAgICAgICAgICwgIiIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuc2FmZUNTUyhjc3NUZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9KTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2dldFVuaXF1ZVN0eWxlcygpOwogICAgICAgIHRoaXMucmVuZGVyUm9vdCA9IHRoaXMuY3JlYXRlUmVuZGVyUm9vdCgpOwogICAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiB0aGlzLnJlbmRlclJvb3QgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCkgewogICAgICAgICAgICB0aGlzLmFkb3B0U3R5bGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY3JlYXRlUmVuZGVyUm9vdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hTaGFkb3codGhpcy5jb25zdHJ1Y3Rvci5zaGFkb3dSb290T3B0aW9ucyk7CiAgICB9CiAgICBhZG9wdFN0eWxlcygpIHsKICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXM7CiAgICAgICAgaWYgKHN0eWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAod2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDAgJiYgIXdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLlNjb3BpbmdTaGltLnByZXBhcmVBZG9wdGVkQ3NzVGV4dChzdHlsZXMubWFwKChzKT0+cy5jc3NUZXh0CiAgICAgICAgICAgICksIHRoaXMubG9jYWxOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYWRvcHRlZFN0eWxlU2hlZXRzID0gc3R5bGVzLm1hcCgocyk9PnMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ID8gcyA6IHMuc3R5bGVTaGVldAogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgc3VwZXIuY29ubmVjdGVkQ2FsbGJhY2soKTsKICAgICAgICBpZiAodGhpcy5oYXNVcGRhdGVkICYmIHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5zdHlsZUVsZW1lbnQodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgdXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZXN1bHQgPSB0aGlzLnJlbmRlcigpOwogICAgICAgIHN1cGVyLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgaWYgKHRlbXBsYXRlUmVzdWx0ICE9PSByZW5kZXJOb3RJbXBsZW1lbnRlZCkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnJlbmRlcih0ZW1wbGF0ZVJlc3VsdCwgdGhpcy5yZW5kZXJSb290LCB7CiAgICAgICAgICAgICAgICBzY29wZU5hbWU6IHRoaXMubG9jYWxOYW1lLAogICAgICAgICAgICAgICAgZXZlbnRDb250ZXh0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXMuZm9yRWFjaCgocyk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcy5jc3NUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmVuZGVyKCkgewogICAgICAgIHJldHVybiByZW5kZXJOb3RJbXBsZW1lbnRlZDsKICAgIH0KfQpMaXRFbGVtZW50WyJmaW5hbGl6ZWQiXSA9IHRydWU7CkxpdEVsZW1lbnQucmVuZGVyID0gcmVuZGVyOwpMaXRFbGVtZW50LnNoYWRvd1Jvb3RPcHRpb25zID0gewogICAgbW9kZTogIm9wZW4iCn07CmNsYXNzIFRoZW1lIHsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IyMDBIZXggPSAnIzY5YjdmZic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMzAwSGV4ID0gJyMwMDg4RkYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjkwMEhleCA9ICcjMDA1Y2NiJzsKICAgIHN0YXRpYyBiYWNrZ3JvdW5kQ29sb3JIZXggPSAnIzEyMTIxMic7CiAgICBzdGF0aWMgdGV4dENvbG9ySGV4ID0gJyNlYmViZWInOwogICAgc3RhdGljIHRleHRDb2xvclNlY29uZGFyeUhleCA9ICcjODg4ODg4JzsKICAgIHN0YXRpYyBzYW5zU2VyaWZGb250RmFtaWx5ID0gJy1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgYXZlbmlyIG5leHQsIGF2ZW5pciwgaGVsdmV0aWNhIG5ldWUsIGhlbHZldGljYSwgVWJ1bnR1LCByb2JvdG8sIG5vdG8sIHNlZ29lIHVpLCBhcmlhbCwgc2Fucy1zZXJpZic7CiAgICBzdGF0aWMgbW9ub3NwYWNlRm9udEZhbWlseSA9ICdNZW5sbywgIlNGIE1vbm8iLCAiQW5kYWxlIE1vbm8iLCAiUm9ib3RvIE1vbm8iLCBNb25hY28sIG1vbm9zcGFjZSc7CiAgICBzdGF0aWMgdGV4dENvbG9yRXJyb3JIZXggPSAnI2I3MWMxYyc7Cn0KY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0UgPSAnaHR0cHM6Ly9wb2RjYXN0aW5kZXgub3JnL25hbWVzcGFjZS8xLjAnOwpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9BTFQgPSAnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcgPSAnaHR0cHM6Ly9wb2RjYXN0aW5kZXgub3JnL25hbWVzcGFjZS8xLjAvJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VTID0gWwogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0UsCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9BTFQsCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9LTk9XTl9NSVNTUEVMTElORwpdOwpjb25zdCBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTID0gbmV3IFNldCgpOwpmdW5jdGlvbiBfcG9kY2FzdEluZGV4KG5hbWUsIGtub3duID0gdHJ1ZSkgewogICAgaWYgKGtub3duKSBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTLmFkZChuYW1lKTsKICAgIHJldHVybiBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMubWFwKCh2KT0+KHsKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICk7Cn0KY29uc3QgTUVESUFfUlNTX05BTUVTUEFDRSA9ICdodHRwOi8vc2VhcmNoLnlhaG9vLmNvbS9tcnNzLyc7CmZ1bmN0aW9uIF9tZWRpYVJzcyhuYW1lKSB7CiAgICByZXR1cm4gewogICAgICAgIG5hbWUsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBNRURJQV9SU1NfTkFNRVNQQUNFCiAgICB9Owp9CmNsYXNzIFFuYW1lcyB7CiAgICBzdGF0aWMgUG9kY2FzdEluZGV4ID0gewogICAgICAgIE5BTUVTUEFDRVM6IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUywKICAgICAgICBLTk9XTl9NSVNTUEVMTEVEX05BTUVTUEFDRVM6IFsKICAgICAgICAgICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcKICAgICAgICBdLAogICAgICAgIGdldCBLTk9XTl9OQU1FUyAoKSB7CiAgICAgICAgICAgIHJldHVybiBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTOwogICAgICAgIH0sCiAgICAgICAgb2Y6IChuYW1lKT0+X3BvZGNhc3RJbmRleChuYW1lLCBmYWxzZSkKICAgICAgICAsCiAgICAgICAgYWx0ZXJuYXRlRW5jbG9zdXJlOiBfcG9kY2FzdEluZGV4KCdhbHRlcm5hdGVFbmNsb3N1cmUnKSwKICAgICAgICBibG9jazogX3BvZGNhc3RJbmRleCgnYmxvY2snKSwKICAgICAgICBjaGFwdGVyczogX3BvZGNhc3RJbmRleCgnY2hhcHRlcnMnKSwKICAgICAgICBjb21wbGV0ZTogX3BvZGNhc3RJbmRleCgnY29tcGxldGUnKSwKICAgICAgICBjb250ZW50TGluazogX3BvZGNhc3RJbmRleCgnY29udGVudExpbmsnKSwKICAgICAgICBlcGlzb2RlOiBfcG9kY2FzdEluZGV4KCdlcGlzb2RlJyksCiAgICAgICAgZnVuZGluZzogX3BvZGNhc3RJbmRleCgnZnVuZGluZycpLAogICAgICAgIGd1aWQ6IF9wb2RjYXN0SW5kZXgoJ2d1aWQnKSwKICAgICAgICBoaXZlQWNjb3VudDogX3BvZGNhc3RJbmRleCgnaGl2ZUFjY291bnQnKSwKICAgICAgICBpbWFnZXM6IF9wb2RjYXN0SW5kZXgoJ2ltYWdlcycpLAogICAgICAgIGludGVncml0eTogX3BvZGNhc3RJbmRleCgnaW50ZWdyaXR5JyksCiAgICAgICAgbGljZW5zZTogX3BvZGNhc3RJbmRleCgnbGljZW5zZScpLAogICAgICAgIGxpdmVJdGVtOiBfcG9kY2FzdEluZGV4KCdsaXZlSXRlbScpLAogICAgICAgIGxvY2F0aW9uOiBfcG9kY2FzdEluZGV4KCdsb2NhdGlvbicpLAogICAgICAgIGxvY2tlZDogX3BvZGNhc3RJbmRleCgnbG9ja2VkJyksCiAgICAgICAgbWVkaXVtOiBfcG9kY2FzdEluZGV4KCdtZWRpdW0nKSwKICAgICAgICBwZXJzb246IF9wb2RjYXN0SW5kZXgoJ3BlcnNvbicpLAogICAgICAgIHBvZHBpbmc6IF9wb2RjYXN0SW5kZXgoJ3BvZHBpbmcnKSwKICAgICAgICBzZWFzb246IF9wb2RjYXN0SW5kZXgoJ3NlYXNvbicpLAogICAgICAgIHNvY2lhbDogX3BvZGNhc3RJbmRleCgnc29jaWFsJyksCiAgICAgICAgc29jaWFsSW50ZXJhY3Q6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbEludGVyYWN0JyksCiAgICAgICAgc29jaWFsU2lnblVwOiBfcG9kY2FzdEluZGV4KCdzb2NpYWxTaWduVXAnKSwKICAgICAgICBzb3VuZGJpdGU6IF9wb2RjYXN0SW5kZXgoJ3NvdW5kYml0ZScpLAogICAgICAgIHNvdXJjZTogX3BvZGNhc3RJbmRleCgnc291cmNlJyksCiAgICAgICAgdHJhaWxlcjogX3BvZGNhc3RJbmRleCgndHJhaWxlcicpLAogICAgICAgIHRyYW5zY3JpcHQ6IF9wb2RjYXN0SW5kZXgoJ3RyYW5zY3JpcHQnKSwKICAgICAgICB2YWx1ZTogX3BvZGNhc3RJbmRleCgndmFsdWUnKSwKICAgICAgICB2YWx1ZVJlY2lwaWVudDogX3BvZGNhc3RJbmRleCgndmFsdWVSZWNpcGllbnQnKQogICAgfTsKICAgIHN0YXRpYyBNZWRpYVJzcyA9IHsKICAgICAgICBOQU1FU1BBQ0U6IE1FRElBX1JTU19OQU1FU1BBQ0UsCiAgICAgICAgb2Y6IChuYW1lKT0+X21lZGlhUnNzKG5hbWUpCiAgICAgICAgLAogICAgICAgIGNvbnRlbnQ6IF9tZWRpYVJzcygnY29udGVudCcpCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrTWF0Y2hlcyhuYW1lLCB2YWx1ZSwgcGF0dGVybikgewogICAgaWYgKCFwYXR0ZXJuLnRlc3QodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwogICAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGNoZWNrRXF1YWwobmFtZSwgdmFsdWUsIGV4cGVjdGVkKSB7CiAgICBpZiAodmFsdWUgIT09IGV4cGVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfSwgZXhwZWN0ZWQgJHtleHBlY3RlZH1gKTsKfQpmdW5jdGlvbiBjaGVja1RydWUobmFtZSwgdmFsdWUsIHRlc3QpIHsKICAgIGlmICghdGVzdCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKfQpmdW5jdGlvbiBpc1N0cmluZ1JlY29yZChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiBvYmogIT09IG51bGwgJiYgIUFycmF5LmlzQXJyYXkob2JqKSAmJiBvYmouY29uc3RydWN0b3IgPT09IE9iamVjdDsKfQpjb25zdCBoZXhSZWdleCA9IC9eWy0rXT8weFthLWZBLUYwLTldKyQvOwpjb25zdCBudW1SZWdleCA9IC9eKFtcLVwrXSk/KDAqKShcLlswLTldKyhbZUVdXC0/WzAtOV0rKT98WzAtOV0rKFwuWzAtOV0rKFtlRV1cLT9bMC05XSspPyk/KSQvOwpjb25zdCBjb25zaWRlciA9IHsKICAgIGhleDogdHJ1ZSwKICAgIGxlYWRpbmdaZXJvczogdHJ1ZSwKICAgIGRlY2ltYWxQb2ludDogIi4iCn07CmZ1bmN0aW9uIHRvTnVtYmVyKHN0ciwgb3B0aW9ucyA9IHt9KSB7CiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7fSwgY29uc2lkZXIsIG9wdGlvbnMpOwogICAgaWYgKCFzdHIgfHwgdHlwZW9mIHN0ciAhPT0gInN0cmluZyIpIHJldHVybiBzdHI7CiAgICBsZXQgdHJpbW1lZFN0ciA9IHN0ci50cmltKCk7CiAgICBpZiAob3B0aW9ucy5za2lwTGlrZSAhPT0gdm9pZCAwICYmIG9wdGlvbnMuc2tpcExpa2UudGVzdCh0cmltbWVkU3RyKSkgcmV0dXJuIHN0cjsKICAgIGVsc2UgaWYgKG9wdGlvbnMuaGV4ICYmIGhleFJlZ2V4LnRlc3QodHJpbW1lZFN0cikpIHsKICAgICAgICByZXR1cm4gTnVtYmVyLnBhcnNlSW50KHRyaW1tZWRTdHIsIDE2KTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSBudW1SZWdleC5leGVjKHRyaW1tZWRTdHIpOwogICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBtYXRjaFsxXTsKICAgICAgICAgICAgY29uc3QgbGVhZGluZ1plcm9zID0gbWF0Y2hbMl07CiAgICAgICAgICAgIGNvbnN0IG51bSA9IG1hdGNoWzNdOwogICAgICAgICAgICBtYXRjaFs0XSB8fCBtYXRjaFs2XTsKICAgICAgICAgICAgaWYgKGxlYWRpbmdaZXJvcy5sZW5ndGggPT09IDEgJiYgbnVtWzBdID09PSAiLiIpIHJldHVybiBOdW1iZXIoc3RyKTsKICAgICAgICAgICAgZWxzZSBpZiAoIW9wdGlvbnMubGVhZGluZ1plcm9zICYmIGxlYWRpbmdaZXJvcy5sZW5ndGggPiAwKSByZXR1cm4gc3RyOwogICAgICAgICAgICBlbHNlIHJldHVybiBOdW1iZXIodHJpbW1lZFN0cik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9CiAgICB9Cn0KdmFyIHN0cm51bSA9IHRvTnVtYmVyOwpmdW5jdGlvbiBjcmVhdGVDb21tb25qc01vZHVsZShmbiwgYmFzZWRpciwgbW9kdWxlKSB7CiAgICByZXR1cm4gbW9kdWxlID0gewogICAgICAgIHBhdGg6IGJhc2VkaXIsCiAgICAgICAgZXhwb3J0czoge30sCiAgICAgICAgcmVxdWlyZTogZnVuY3Rpb24ocGF0aCwgYmFzZSkgewogICAgICAgICAgICByZXR1cm4gY29tbW9uanNSZXF1aXJlKHBhdGgsIGJhc2UgPT09IHZvaWQgMCB8fCBiYXNlID09PSBudWxsID8gbW9kdWxlLnBhdGggOiBiYXNlKTsKICAgICAgICB9CiAgICB9LCBmbihtb2R1bGUsIG1vZHVsZS5leHBvcnRzKSwgbW9kdWxlLmV4cG9ydHM7Cn0KZnVuY3Rpb24gY29tbW9uanNSZXF1aXJlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJEeW5hbWljIHJlcXVpcmVzIGFyZSBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBieSBAcm9sbHVwL3BsdWdpbi1jb21tb25qcyIpOwp9CnZhciB1dGlsID0gY3JlYXRlQ29tbW9uanNNb2R1bGUoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CiAgICBjb25zdCBuYW1lU3RhcnRDaGFyID0gIjpBLVphLXpfXFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgIGNvbnN0IG5hbWVDaGFyID0gbmFtZVN0YXJ0Q2hhciArICJcXC0uXFxkXFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICBjb25zdCBuYW1lUmVnZXhwID0gIlsiICsgbmFtZVN0YXJ0Q2hhciArICJdWyIgKyBuYW1lQ2hhciArICJdKiI7CiAgICBjb25zdCByZWdleE5hbWUgPSBuZXcgUmVnRXhwKCJeIiArIG5hbWVSZWdleHAgKyAiJCIpOwogICAgY29uc3QgZ2V0QWxsTWF0Y2hlcyA9IGZ1bmN0aW9uKHN0cmluZywgcmVnZXgpIHsKICAgICAgICBjb25zdCBtYXRjaGVzID0gW107CiAgICAgICAgbGV0IG1hdGNoID0gcmVnZXguZXhlYyhzdHJpbmcpOwogICAgICAgIHdoaWxlKG1hdGNoKXsKICAgICAgICAgICAgY29uc3QgYWxsbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBhbGxtYXRjaGVzLnN0YXJ0SW5kZXggPSByZWdleC5sYXN0SW5kZXggLSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbGVuOyBpbmRleCsrKXsKICAgICAgICAgICAgICAgIGFsbG1hdGNoZXMucHVzaChtYXRjaFtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoZXMucHVzaChhbGxtYXRjaGVzKTsKICAgICAgICAgICAgbWF0Y2ggPSByZWdleC5leGVjKHN0cmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgfTsKICAgIGNvbnN0IGlzTmFtZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIGNvbnN0IG1hdGNoID0gcmVnZXhOYW1lLmV4ZWMoc3RyaW5nKTsKICAgICAgICByZXR1cm4gIShtYXRjaCA9PT0gbnVsbCB8fCB0eXBlb2YgbWF0Y2ggPT09ICJ1bmRlZmluZWQiKTsKICAgIH07CiAgICBleHBvcnRzLmlzRXhpc3QgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ICE9PSAidW5kZWZpbmVkIjsKICAgIH07CiAgICBleHBvcnRzLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDA7CiAgICB9OwogICAgZXhwb3J0cy5tZXJnZSA9IGZ1bmN0aW9uKHRhcmdldCwgYSwgYXJyYXlNb2RlKSB7CiAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGEpOwogICAgICAgICAgICBjb25zdCBsZW4gPSBrZXlzLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGlmIChhcnJheU1vZGUgPT09ICJzdHJpY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gWwogICAgICAgICAgICAgICAgICAgICAgICBhW2tleXNbaV1dCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gYVtrZXlzW2ldXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmdldFZhbHVlID0gZnVuY3Rpb24odikgewogICAgICAgIGlmIChleHBvcnRzLmlzRXhpc3QodikpIHsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmJ1aWxkT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zMiwgcHJvcHMyKSB7CiAgICAgICAgbGV0IG5ld09wdGlvbnMgPSB7fTsKICAgICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRPcHRpb25zMjsKICAgICAgICB9CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHByb3BzMi5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmIChvcHRpb25zW3Byb3BzMltpXV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gb3B0aW9uc1twcm9wczJbaV1dOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gZGVmYXVsdE9wdGlvbnMyW3Byb3BzMltpXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld09wdGlvbnM7CiAgICB9OwogICAgZXhwb3J0cy5pc1RhZ05hbWVJbkFycmF5TW9kZSA9IGZ1bmN0aW9uKHRhZ05hbWUsIGFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSkgewogICAgICAgIGlmIChhcnJheU1vZGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKGFycmF5TW9kZSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gYXJyYXlNb2RlLnRlc3QodGFnTmFtZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJyYXlNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiAhIWFycmF5TW9kZSh0YWdOYW1lLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycmF5TW9kZSA9PT0gInN0cmljdCI7CiAgICB9OwogICAgZXhwb3J0cy5pc05hbWUgPSBpc05hbWU7CiAgICBleHBvcnRzLmdldEFsbE1hdGNoZXMgPSBnZXRBbGxNYXRjaGVzOwogICAgZXhwb3J0cy5uYW1lUmVnZXhwID0gbmFtZVJlZ2V4cDsKfSk7CmNvbnN0IGNvbnZlcnRUb0pzb24gPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBwYXJlbnRUYWdOYW1lKSB7CiAgICBjb25zdCBqT2JqID0ge307CiAgICBpZiAoIW9wdGlvbnMuYWx3YXlzQ3JlYXRlVGV4dE5vZGUgJiYgKCFub2RlLmNoaWxkIHx8IHV0aWwuaXNFbXB0eU9iamVjdChub2RlLmNoaWxkKSkgJiYgKCFub2RlLmF0dHJzTWFwIHx8IHV0aWwuaXNFbXB0eU9iamVjdChub2RlLmF0dHJzTWFwKSkpIHsKICAgICAgICByZXR1cm4gdXRpbC5pc0V4aXN0KG5vZGUudmFsKSA/IG5vZGUudmFsIDogIiI7CiAgICB9CiAgICBpZiAodXRpbC5pc0V4aXN0KG5vZGUudmFsKSAmJiAhKHR5cGVvZiBub2RlLnZhbCA9PT0gInN0cmluZyIgJiYgKG5vZGUudmFsID09PSAiIiB8fCBub2RlLnZhbCA9PT0gb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcikpKSB7CiAgICAgICAgY29uc3QgYXNBcnJheSA9IHV0aWwuaXNUYWdOYW1lSW5BcnJheU1vZGUobm9kZS50YWduYW1lLCBvcHRpb25zLmFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgak9ialtvcHRpb25zLnRleHROb2RlTmFtZV0gPSBhc0FycmF5ID8gWwogICAgICAgICAgICBub2RlLnZhbAogICAgICAgIF0gOiBub2RlLnZhbDsKICAgIH0KICAgIHV0aWwubWVyZ2Uoak9iaiwgbm9kZS5hdHRyc01hcCwgb3B0aW9ucy5hcnJheU1vZGUpOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUuY2hpbGQpOwogICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwga2V5cy5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGNvbnN0IHRhZ05hbWUgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWdOYW1lXSAmJiBub2RlLmNoaWxkW3RhZ05hbWVdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgak9ialt0YWdOYW1lXSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHRhZyBpbiBub2RlLmNoaWxkW3RhZ05hbWVdKXsKICAgICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ05hbWVdLmhhc093blByb3BlcnR5KHRhZykpIHsKICAgICAgICAgICAgICAgICAgICBqT2JqW3RhZ05hbWVdLnB1c2goY29udmVydFRvSnNvbihub2RlLmNoaWxkW3RhZ05hbWVdW3RhZ10sIG9wdGlvbnMsIHRhZ05hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNvbnZlcnRUb0pzb24obm9kZS5jaGlsZFt0YWdOYW1lXVswXSwgb3B0aW9ucywgdGFnTmFtZSk7CiAgICAgICAgICAgIGNvbnN0IGFzQXJyYXkgPSBvcHRpb25zLmFycmF5TW9kZSA9PT0gdHJ1ZSAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiB8fCB1dGlsLmlzVGFnTmFtZUluQXJyYXlNb2RlKHRhZ05hbWUsIG9wdGlvbnMuYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICAgICAgak9ialt0YWdOYW1lXSA9IGFzQXJyYXkgPyBbCiAgICAgICAgICAgICAgICByZXN1bHQKICAgICAgICAgICAgXSA6IHJlc3VsdDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gak9iajsKfTsKdmFyIGNvbnZlcnRUb0pzb25fMSA9IGNvbnZlcnRUb0pzb247CnZhciBub2RlMmpzb24gPSB7CiAgICBjb252ZXJ0VG9Kc29uOiBjb252ZXJ0VG9Kc29uXzEKfTsKdmFyIHhtbE5vZGUgPSBmdW5jdGlvbih0YWduYW1lLCBwYXJlbnQsIHZhbCkgewogICAgdGhpcy50YWduYW1lID0gdGFnbmFtZTsKICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgdGhpcy5jaGlsZCA9IHt9OwogICAgdGhpcy5hdHRyc01hcCA9IHt9OwogICAgdGhpcy52YWwgPSB2YWw7CiAgICB0aGlzLmFkZENoaWxkID0gZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdKSkgewogICAgICAgICAgICB0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdLnB1c2goY2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0gPSBbCiAgICAgICAgICAgICAgICBjaGlsZAogICAgICAgICAgICBdOwogICAgICAgIH0KICAgIH07Cn07CmNvbnN0IGJ1aWxkT3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zOwoiPCgoIVxcW0NEQVRBXFxbKFtcXHNcXFNdKj8pKF1dPikpfCgoTkFNRTopPyhOQU1FKSkoW14+XSopPnwoKFxcLykoTkFNRSlcXHMqPikpKFtePF0qKSIucmVwbGFjZSgvTkFNRS9nLCB1dGlsLm5hbWVSZWdleHApOwppZiAoIU51bWJlci5wYXJzZUludCAmJiB3aW5kb3cucGFyc2VJbnQpIHsKICAgIE51bWJlci5wYXJzZUludCA9IHdpbmRvdy5wYXJzZUludDsKfQppZiAoIU51bWJlci5wYXJzZUZsb2F0ICYmIHdpbmRvdy5wYXJzZUZsb2F0KSB7CiAgICBOdW1iZXIucGFyc2VGbG9hdCA9IHdpbmRvdy5wYXJzZUZsb2F0Owp9CmNvbnN0IGRlZmF1bHRPcHRpb25zID0gewogICAgYXR0cmlidXRlTmFtZVByZWZpeDogIkBfIiwKICAgIGF0dHJOb2RlTmFtZTogZmFsc2UsCiAgICB0ZXh0Tm9kZU5hbWU6ICIjdGV4dCIsCiAgICBpZ25vcmVBdHRyaWJ1dGVzOiB0cnVlLAogICAgaWdub3JlTmFtZVNwYWNlOiBmYWxzZSwKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlLAogICAgcGFyc2VOb2RlVmFsdWU6IHRydWUsCiAgICBwYXJzZUF0dHJpYnV0ZVZhbHVlOiBmYWxzZSwKICAgIGFycmF5TW9kZTogZmFsc2UsCiAgICB0cmltVmFsdWVzOiB0cnVlLAogICAgY2RhdGFUYWdOYW1lOiBmYWxzZSwKICAgIGNkYXRhUG9zaXRpb25DaGFyOiAiXFxjIiwKICAgIG51bVBhcnNlT3B0aW9uczogewogICAgICAgIGhleDogdHJ1ZSwKICAgICAgICBsZWFkaW5nWmVyb3M6IHRydWUKICAgIH0sCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgdGFnTmFtZSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgYXR0ck5hbWUpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBzdG9wTm9kZXM6IFtdLAogICAgYWx3YXlzQ3JlYXRlVGV4dE5vZGU6IGZhbHNlCn07CnZhciBkZWZhdWx0T3B0aW9uc18xID0gZGVmYXVsdE9wdGlvbnM7CmNvbnN0IHByb3BzID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJpZ25vcmVOYW1lU3BhY2UiLAogICAgImFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMiLAogICAgInBhcnNlTm9kZVZhbHVlIiwKICAgICJwYXJzZUF0dHJpYnV0ZVZhbHVlIiwKICAgICJhcnJheU1vZGUiLAogICAgInRyaW1WYWx1ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInBhcnNlVHJ1ZU51bWJlck9ubHkiLAogICAgIm51bVBhcnNlT3B0aW9ucyIsCiAgICAic3RvcE5vZGVzIiwKICAgICJhbHdheXNDcmVhdGVUZXh0Tm9kZSIKXTsKdmFyIHByb3BzXzEgPSBwcm9wczsKZnVuY3Rpb24gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHZhbCwgb3B0aW9ucykgewogICAgaWYgKHZhbCkgewogICAgICAgIGlmIChvcHRpb25zLnRyaW1WYWx1ZXMpIHsKICAgICAgICAgICAgdmFsID0gdmFsLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFsID0gb3B0aW9ucy50YWdWYWx1ZVByb2Nlc3Nvcih2YWwsIHRhZ05hbWUpOwogICAgICAgIHZhbCA9IHBhcnNlVmFsdWUodmFsLCBvcHRpb25zLnBhcnNlTm9kZVZhbHVlLCBvcHRpb25zLm51bVBhcnNlT3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gdmFsOwp9CmZ1bmN0aW9uIHJlc29sdmVOYW1lU3BhY2UodGFnbmFtZSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgY29uc3QgdGFncyA9IHRhZ25hbWUuc3BsaXQoIjoiKTsKICAgICAgICBjb25zdCBwcmVmaXggPSB0YWduYW1lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgaWYgKHRhZ3NbMF0gPT09ICJ4bWxucyIpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBpZiAodGFncy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgdGFnbmFtZSA9IHByZWZpeCArIHRhZ3NbMV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhZ25hbWU7Cn0KZnVuY3Rpb24gcGFyc2VWYWx1ZSh2YWwsIHNob3VsZFBhcnNlLCBvcHRpb25zKSB7CiAgICBpZiAoc2hvdWxkUGFyc2UgJiYgdHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBuZXd2YWwgPSB2YWwudHJpbSgpOwogICAgICAgIGlmIChuZXd2YWwgPT09ICJ0cnVlIikgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZSBpZiAobmV3dmFsID09PSAiZmFsc2UiKSByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSByZXR1cm4gc3RybnVtKHZhbCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3QodmFsKSkgewogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgYXR0cnNSZWd4ID0gbmV3IFJlZ0V4cChgKFteXFxzPV0rKVxccyooPVxccyooWyciXSkoLio/KVxcMyk/YCwgImciKTsKZnVuY3Rpb24gYnVpbGRBdHRyaWJ1dGVzTWFwKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIHR5cGVvZiBhdHRyU3RyID09PSAic3RyaW5nIikgewogICAgICAgIGF0dHJTdHIgPSBhdHRyU3RyLnJlcGxhY2UoL1xyP1xuL2csICIgIik7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHV0aWwuZ2V0QWxsTWF0Y2hlcyhhdHRyU3RyLCBhdHRyc1JlZ3gpOwogICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGF0dHJzID0ge307CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgYXR0ck5hbWUgPSByZXNvbHZlTmFtZVNwYWNlKG1hdGNoZXNbaV1bMV0sIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0ck5hbWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlc1tpXVs0XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudHJpbVZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzW2ldWzRdID0gbWF0Y2hlc1tpXVs0XS50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXNbaV1bNF0gPSBvcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcihtYXRjaGVzW2ldWzRdLCBhdHRyTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gcGFyc2VWYWx1ZShtYXRjaGVzW2ldWzRdLCBvcHRpb25zLnBhcnNlQXR0cmlidXRlVmFsdWUsIG9wdGlvbnMubnVtUGFyc2VPcHRpb25zKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5rZXlzKGF0dHJzKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgY29uc3QgYXR0ckNvbGxlY3Rpb24gPSB7fTsKICAgICAgICAgICAgYXR0ckNvbGxlY3Rpb25bb3B0aW9ucy5hdHRyTm9kZU5hbWVdID0gYXR0cnM7CiAgICAgICAgICAgIHJldHVybiBhdHRyQ29sbGVjdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQp9CmNvbnN0IGdldFRyYXZlcnNhbE9iaiA9IGZ1bmN0aW9uKHhtbERhdGEsIG9wdGlvbnMpIHsKICAgIHhtbERhdGEgPSB4bWxEYXRhLnJlcGxhY2UoL1xyXG4/L2csICJcbiIpOwogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucywgcHJvcHMpOwogICAgY29uc3QgeG1sT2JqID0gbmV3IHhtbE5vZGUoIiF4bWwiKTsKICAgIGxldCBjdXJyZW50Tm9kZSA9IHhtbE9iajsKICAgIGxldCB0ZXh0RGF0YSA9ICIiOwogICAgZm9yKGxldCBpID0gMDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGNvbnN0IGNoID0geG1sRGF0YVtpXTsKICAgICAgICBpZiAoY2ggPT09ICI8IikgewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiQ2xvc2luZyBUYWcgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0geG1sRGF0YS5zdWJzdHJpbmcoaSArIDIsIGNsb3NlSW5kZXgpLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BOb2Rlcy5sZW5ndGggJiYgb3B0aW9ucy5zdG9wTm9kZXMuaW5jbHVkZXMoY3VycmVudE5vZGUudGFnbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5jaGlsZCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5hdHRyc01hcCA9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYXR0cnNNYXAgPSB7fTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0geG1sRGF0YS5zdWJzdHIoY3VycmVudE5vZGUuc3RhcnRJbmRleCArIDEsIGkgLSBjdXJyZW50Tm9kZS5zdGFydEluZGV4IC0gMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLnBhcmVudDsKICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICBpID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiPz4iLCBpLCAiUGkgVGFnIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDMpID09PSAiIS0tIikgewogICAgICAgICAgICAgICAgaSA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIi0tPiIsIGksICJDb21tZW50IGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDIpID09PSAiIUQiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiPiIsIGksICJET0NUWVBFIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgICAgICBjb25zdCB0YWdFeHAgPSB4bWxEYXRhLnN1YnN0cmluZyhpLCBjbG9zZUluZGV4KTsKICAgICAgICAgICAgICAgIGlmICh0YWdFeHAuaW5kZXhPZigiWyIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBpID0geG1sRGF0YS5pbmRleE9mKCJdPiIsIGkpICsgMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDIpID09PSAiIVsiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiXV0+IiwgaSwgIkNEQVRBIGlzIG5vdCBjbG9zZWQuIikgLSAyOwogICAgICAgICAgICAgICAgY29uc3QgdGFnRXhwID0geG1sRGF0YS5zdWJzdHJpbmcoaSArIDksIGNsb3NlSW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKHRleHREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgIiIgKyBwcm9jZXNzVGFnVmFsdWUoY3VycmVudE5vZGUudGFnbmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jZGF0YVRhZ05hbWUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZShvcHRpb25zLmNkYXRhVGFnTmFtZSwgY3VycmVudE5vZGUsIHRhZ0V4cCk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLnZhbCA9IHRhZ0V4cDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IChjdXJyZW50Tm9kZS52YWwgfHwgIiIpICsgKHRhZ0V4cCB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleCArIDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBjbG9zaW5nSW5kZXhGb3JPcGVuaW5nVGFnKHhtbERhdGEsIGkgKyAxKTsKICAgICAgICAgICAgICAgIGxldCB0YWdFeHAgPSByZXN1bHQuZGF0YTsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSByZXN1bHQuaW5kZXg7CiAgICAgICAgICAgICAgICBjb25zdCBzZXBhcmF0b3JJbmRleCA9IHRhZ0V4cC5pbmRleE9mKCIgIik7CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9IHRhZ0V4cDsKICAgICAgICAgICAgICAgIGxldCBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXAgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNlcGFyYXRvckluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdFeHAuc3Vic3RyKDAsIHNlcGFyYXRvckluZGV4KS5yZXBsYWNlKC9cc1xzKiQvLCAiIik7CiAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnRXhwLnN1YnN0cihzZXBhcmF0b3JJbmRleCArIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb25JbmRleCA9IHRhZ05hbWUuaW5kZXhPZigiOiIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb2xvbkluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHIoY29sb25JbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXAgPSB0YWdOYW1lICE9PSByZXN1bHQuZGF0YS5zdWJzdHIoY29sb25JbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZSAmJiB0ZXh0RGF0YSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS50YWduYW1lICE9PSAiIXhtbCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgIiIgKyBwcm9jZXNzVGFnVmFsdWUoY3VycmVudE5vZGUudGFnbmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0YWdFeHAubGVuZ3RoID4gMCAmJiB0YWdFeHAubGFzdEluZGV4T2YoIi8iKSA9PT0gdGFnRXhwLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZVt0YWdOYW1lLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKDAsIHRhZ05hbWUubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ05hbWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnRXhwLnN1YnN0cigwLCB0YWdFeHAubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKHRhZ05hbWUsIGN1cnJlbnROb2RlLCAiIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IHRhZ0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuYXR0cnNNYXAgPSBidWlsZEF0dHJpYnV0ZXNNYXAodGFnRXhwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUodGFnTmFtZSwgY3VycmVudE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BOb2Rlcy5sZW5ndGggJiYgb3B0aW9ucy5zdG9wTm9kZXMuaW5jbHVkZXMoY2hpbGROb2RlLnRhZ25hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5zdGFydEluZGV4ID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IHRhZ0V4cCAmJiBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLmF0dHJzTWFwID0gYnVpbGRBdHRyaWJ1dGVzTWFwKHRhZ0V4cCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjaGlsZE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ZXh0RGF0YSArPSB4bWxEYXRhW2ldOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB4bWxPYmo7Cn07CmZ1bmN0aW9uIGNsb3NpbmdJbmRleEZvck9wZW5pbmdUYWcoZGF0YSwgaSkgewogICAgbGV0IGF0dHJCb3VuZGFyeTsKICAgIGxldCB0YWdFeHAgPSAiIjsKICAgIGZvcihsZXQgaW5kZXggPSBpOyBpbmRleCA8IGRhdGEubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBsZXQgY2ggPSBkYXRhW2luZGV4XTsKICAgICAgICBpZiAoYXR0ckJvdW5kYXJ5KSB7CiAgICAgICAgICAgIGlmIChjaCA9PT0gYXR0ckJvdW5kYXJ5KSBhdHRyQm91bmRhcnkgPSAiIjsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAnIicgfHwgY2ggPT09ICInIikgewogICAgICAgICAgICBhdHRyQm91bmRhcnkgPSBjaDsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiPiIpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGRhdGE6IHRhZ0V4cCwKICAgICAgICAgICAgICAgIGluZGV4CiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIgkiKSB7CiAgICAgICAgICAgIGNoID0gIiAiOwogICAgICAgIH0KICAgICAgICB0YWdFeHAgKz0gY2g7CiAgICB9Cn0KZnVuY3Rpb24gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCBzdHIsIGksIGVyck1zZykgewogICAgY29uc3QgY2xvc2luZ0luZGV4ID0geG1sRGF0YS5pbmRleE9mKHN0ciwgaSk7CiAgICBpZiAoY2xvc2luZ0luZGV4ID09PSAtMSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2xvc2luZ0luZGV4ICsgc3RyLmxlbmd0aCAtIDE7CiAgICB9Cn0KdmFyIGdldFRyYXZlcnNhbE9ial8xID0gZ2V0VHJhdmVyc2FsT2JqOwp2YXIgeG1sc3RyMnhtbG5vZGUgPSB7CiAgICBkZWZhdWx0T3B0aW9uczogZGVmYXVsdE9wdGlvbnNfMSwKICAgIHByb3BzOiBwcm9wc18xLAogICAgZ2V0VHJhdmVyc2FsT2JqOiBnZXRUcmF2ZXJzYWxPYmpfMQp9Owpjb25zdCBkZWZhdWx0T3B0aW9ucyQxID0gewogICAgYWxsb3dCb29sZWFuQXR0cmlidXRlczogZmFsc2UKfTsKY29uc3QgcHJvcHMkMSA9IFsKICAgICJhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzIgpdOwp2YXIgdmFsaWRhdGUgPSBmdW5jdGlvbih4bWxEYXRhLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gdXRpbC5idWlsZE9wdGlvbnMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMkMSwgcHJvcHMkMSk7CiAgICBjb25zdCB0YWdzID0gW107CiAgICBsZXQgdGFnRm91bmQgPSBmYWxzZTsKICAgIGxldCByZWFjaGVkUm9vdCA9IGZhbHNlOwogICAgaWYgKHhtbERhdGFbMF0gPT09ICJcdUZFRkYiKSB7CiAgICAgICAgeG1sRGF0YSA9IHhtbERhdGEuc3Vic3RyKDEpOwogICAgfQogICAgZm9yKGxldCBpID0gMDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgIGkgPSByZWFkUEkoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgIGlmIChpLmVycikgcmV0dXJuIGk7CiAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgbGV0IHRhZ1N0YXJ0UG9zID0gaTsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICBpID0gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGV0IGNsb3NpbmdUYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICBjbG9zaW5nVGFnID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9ICIiOwogICAgICAgICAgICAgICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoICYmIHhtbERhdGFbaV0gIT09ICI+IiAmJiB4bWxEYXRhW2ldICE9PSAiICIgJiYgeG1sRGF0YVtpXSAhPT0gIgkiICYmIHhtbERhdGFbaV0gIT09ICJcbiIgJiYgeG1sRGF0YVtpXSAhPT0gIlxyIjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lICs9IHhtbERhdGFbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAodGFnTmFtZVt0YWdOYW1lLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHJpbmcoMCwgdGFnTmFtZS5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlVGFnTmFtZSh0YWdOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGxldCBtc2c7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUudHJpbSgpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAiSW52YWxpZCBzcGFjZSBhZnRlciAnPCcuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAiVGFnICciICsgdGFnTmFtZSArICInIGlzIGFuIGludmFsaWQgbmFtZS4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCBtc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSByZWFkQXR0cmlidXRlU3RyKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZXMgZm9yICciICsgdGFnTmFtZSArICInIGhhdmUgb3BlbiBxdW90ZS4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGF0dHJTdHIgPSByZXN1bHQudmFsdWU7CiAgICAgICAgICAgICAgICBpID0gcmVzdWx0LmluZGV4OwogICAgICAgICAgICAgICAgaWYgKGF0dHJTdHJbYXR0clN0ci5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0clN0clN0YXJ0ID0gaSAtIGF0dHJTdHIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGF0dHJTdHIgPSBhdHRyU3RyLnN1YnN0cmluZygwLCBhdHRyU3RyLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KGlzVmFsaWQuZXJyLmNvZGUsIGlzVmFsaWQuZXJyLm1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGF0dHJTdHJTdGFydCArIGlzVmFsaWQuZXJyLmxpbmUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNsb3NpbmdUYWcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdC50YWdDbG9zZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInIGRvZXNuJ3QgaGF2ZSBwcm9wZXIgY2xvc2luZy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0clN0ci50cmltKCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiQ2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicgY2FuJ3QgaGF2ZSBhdHRyaWJ1dGVzIG9yIGludmFsaWQgc3RhcnRpbmcuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ1N0YXJ0UG9zKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RnID0gdGFncy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IG90Zy50YWdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3BlblBvcyA9IGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBvdGcudGFnU3RhcnRQb3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkV4cGVjdGVkIGNsb3NpbmcgdGFnICciICsgb3RnLnRhZ05hbWUgKyAiJyAob3BlbmVkIGluIGxpbmUgIiArIG9wZW5Qb3MubGluZSArICIsIGNvbCAiICsgb3BlblBvcy5jb2wgKyAiKSBpbnN0ZWFkIG9mIGNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdTdGFydFBvcykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFjaGVkUm9vdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoaXNWYWxpZC5lcnIuY29kZSwgaXNWYWxpZC5lcnIubXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSAtIGF0dHJTdHIubGVuZ3RoICsgaXNWYWxpZC5lcnIubGluZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAocmVhY2hlZFJvb3QgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIk11bHRpcGxlIHBvc3NpYmxlIHJvb3Qgbm9kZXMgZm91bmQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ1N0YXJ0UG9zCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0YWdGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IoaSsrOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gcmVhZFBJKHhtbERhdGEsICsraSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaS5lcnIpIHJldHVybiBpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhZnRlckFtcCA9IHZhbGlkYXRlQW1wZXJzYW5kKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWZ0ZXJBbXAgPT0gLTEpIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZENoYXIiLCAiY2hhciAnJicgaXMgbm90IGV4cGVjdGVkLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBhZnRlckFtcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIgIiB8fCB4bWxEYXRhW2ldID09PSAiCSIgfHwgeG1sRGF0YVtpXSA9PT0gIlxuIiB8fCB4bWxEYXRhW2ldID09PSAiXHIiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRDaGFyIiwgImNoYXIgJyIgKyB4bWxEYXRhW2ldICsgIicgaXMgbm90IGV4cGVjdGVkLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgfQogICAgfQogICAgaWYgKCF0YWdGb3VuZCkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJTdGFydCB0YWcgZXhwZWN0ZWQuIiwgMSk7CiAgICB9IGVsc2UgaWYgKHRhZ3MubGVuZ3RoID09IDEpIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiVW5jbG9zZWQgdGFnICciICsgdGFnc1swXS50YWdOYW1lICsgIicuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ3NbMF0udGFnU3RhcnRQb3MpKTsKICAgIH0gZWxzZSBpZiAodGFncy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIkludmFsaWQgJyIgKyBKU09OLnN0cmluZ2lmeSh0YWdzLm1hcCgodCk9PnQudGFnTmFtZQogICAgICAgICksIG51bGwsIDQpLnJlcGxhY2UoL1xyP1xuL2csICIiKSArICInIGZvdW5kLiIsIHsKICAgICAgICAgICAgbGluZTogMSwKICAgICAgICAgICAgY29sOiAxCiAgICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfTsKZnVuY3Rpb24gcmVhZFBJKHhtbERhdGEsIGkpIHsKICAgIGNvbnN0IHN0YXJ0ID0gaTsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PSAiPyIgfHwgeG1sRGF0YVtpXSA9PSAiICIpIHsKICAgICAgICAgICAgY29uc3QgdGFnbmFtZSA9IHhtbERhdGEuc3Vic3RyKHN0YXJ0LCBpIC0gc3RhcnQpOwogICAgICAgICAgICBpZiAoaSA+IDUgJiYgdGFnbmFtZSA9PT0gInhtbCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJYTUwgZGVjbGFyYXRpb24gYWxsb3dlZCBvbmx5IGF0IHRoZSBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09ICI/IiAmJiB4bWxEYXRhW2kgKyAxXSA9PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gaTsKfQpmdW5jdGlvbiByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpIHsKICAgIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA1ICYmIHhtbERhdGFbaSArIDFdID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICItIikgewogICAgICAgIGZvcihpICs9IDM7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDJdID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA4ICYmIHhtbERhdGFbaSArIDFdID09PSAiRCIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICJPIiAmJiB4bWxEYXRhW2kgKyAzXSA9PT0gIkMiICYmIHhtbERhdGFbaSArIDRdID09PSAiVCIgJiYgeG1sRGF0YVtpICsgNV0gPT09ICJZIiAmJiB4bWxEYXRhW2kgKyA2XSA9PT0gIlAiICYmIHhtbERhdGFbaSArIDddID09PSAiRSIpIHsKICAgICAgICBsZXQgYW5nbGVCcmFja2V0c0NvdW50ID0gMTsKICAgICAgICBmb3IoaSArPSA4OyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgIGFuZ2xlQnJhY2tldHNDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI+IikgewogICAgICAgICAgICAgICAgYW5nbGVCcmFja2V0c0NvdW50LS07CiAgICAgICAgICAgICAgICBpZiAoYW5nbGVCcmFja2V0c0NvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDkgJiYgeG1sRGF0YVtpICsgMV0gPT09ICJbIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIkMiICYmIHhtbERhdGFbaSArIDNdID09PSAiRCIgJiYgeG1sRGF0YVtpICsgNF0gPT09ICJBIiAmJiB4bWxEYXRhW2kgKyA1XSA9PT0gIlQiICYmIHhtbERhdGFbaSArIDZdID09PSAiQSIgJiYgeG1sRGF0YVtpICsgN10gPT09ICJbIikgewogICAgICAgIGZvcihpICs9IDg7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICJdIiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIl0iICYmIHhtbERhdGFbaSArIDJdID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7Cn0KY29uc3QgZG91YmxlUXVvdGUgPSAnIic7CmNvbnN0IHNpbmdsZVF1b3RlID0gIiciOwpmdW5jdGlvbiByZWFkQXR0cmlidXRlU3RyKHhtbERhdGEsIGkpIHsKICAgIGxldCBhdHRyU3RyID0gIiI7CiAgICBsZXQgc3RhcnRDaGFyID0gIiI7CiAgICBsZXQgdGFnQ2xvc2VkID0gZmFsc2U7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09IGRvdWJsZVF1b3RlIHx8IHhtbERhdGFbaV0gPT09IHNpbmdsZVF1b3RlKSB7CiAgICAgICAgICAgIGlmIChzdGFydENoYXIgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBzdGFydENoYXIgPSB4bWxEYXRhW2ldOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0Q2hhciAhPT0geG1sRGF0YVtpXSkgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0Q2hhciA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPiIpIHsKICAgICAgICAgICAgaWYgKHN0YXJ0Q2hhciA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRhZ0Nsb3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhdHRyU3RyICs9IHhtbERhdGFbaV07CiAgICB9CiAgICBpZiAoc3RhcnRDaGFyICE9PSAiIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IGF0dHJTdHIsCiAgICAgICAgaW5kZXg6IGksCiAgICAgICAgdGFnQ2xvc2VkCiAgICB9Owp9CmNvbnN0IHZhbGlkQXR0clN0clJlZ3hwID0gbmV3IFJlZ0V4cChgKFxccyopKFteXFxzPV0rKShcXHMqPSk/KFxccyooWyciXSkoKFtcXHNcXFNdKSo/KVxcNSk/YCwgImciKTsKZnVuY3Rpb24gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucykgewogICAgY29uc3QgbWF0Y2hlcyA9IHV0aWwuZ2V0QWxsTWF0Y2hlcyhhdHRyU3RyLCB2YWxpZEF0dHJTdHJSZWd4cCk7CiAgICBjb25zdCBhdHRyTmFtZXMgPSB7fTsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCBtYXRjaGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAobWF0Y2hlc1tpXVsxXS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaGFzIG5vIHNwYWNlIGluIHN0YXJ0aW5nLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoZXNbaV1bM10gPT09IHZvaWQgMCAmJiAhb3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiYm9vbGVhbiBhdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaXMgbm90IGFsbG93ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyTmFtZSA9IG1hdGNoZXNbaV1bMl07CiAgICAgICAgaWYgKCF2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgYW4gaW52YWxpZCBuYW1lLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhdHRyTmFtZXMuaGFzT3duUHJvcGVydHkoYXR0ck5hbWUpKSB7CiAgICAgICAgICAgIGF0dHJOYW1lc1thdHRyTmFtZV0gPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgYXR0ck5hbWUgKyAiJyBpcyByZXBlYXRlZC4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgbGV0IHJlID0gL1xkLzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAieCIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmUgPSAvW1xkYS1mQS1GXS87CiAgICB9CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIGk7CiAgICAgICAgaWYgKCF4bWxEYXRhW2ldLm1hdGNoKHJlKSkgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gLTE7Cn0KZnVuY3Rpb24gdmFsaWRhdGVBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgaSsrOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIC0xOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICIjIikgewogICAgICAgIGkrKzsKICAgICAgICByZXR1cm4gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSk7CiAgICB9CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyssIGNvdW50KyspewogICAgICAgIGlmICh4bWxEYXRhW2ldLm1hdGNoKC9cdy8pICYmIGNvdW50IDwgMjApIGNvbnRpbnVlOwogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIGJyZWFrOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHJldHVybiBpOwp9CmZ1bmN0aW9uIGdldEVycm9yT2JqZWN0KGNvZGUsIG1lc3NhZ2UsIGxpbmVOdW1iZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZXJyOiB7CiAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgIG1zZzogbWVzc2FnZSwKICAgICAgICAgICAgbGluZTogbGluZU51bWJlci5saW5lIHx8IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbDogbGluZU51bWJlci5jb2wKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIHZhbGlkYXRlQXR0ck5hbWUoYXR0ck5hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZShhdHRyTmFtZSk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVUYWdOYW1lKHRhZ25hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZSh0YWduYW1lKTsKfQpmdW5jdGlvbiBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaW5kZXgpIHsKICAgIGNvbnN0IGxpbmVzID0geG1sRGF0YS5zdWJzdHJpbmcoMCwgaW5kZXgpLnNwbGl0KC9ccj9cbi8pOwogICAgcmV0dXJuIHsKICAgICAgICBsaW5lOiBsaW5lcy5sZW5ndGgsCiAgICAgICAgY29sOiBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXS5sZW5ndGggKyAxCiAgICB9Owp9CmZ1bmN0aW9uIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoKSB7CiAgICByZXR1cm4gbWF0Y2guc3RhcnRJbmRleCArIG1hdGNoWzFdLmxlbmd0aDsKfQp2YXIgdmFsaWRhdG9yID0gewogICAgdmFsaWRhdGUKfTsKY29uc3QgX19jaGFyID0gZnVuY3Rpb24oYSkgewogICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoYSk7Cn07CmNvbnN0IGNoYXJzID0gewogICAgbmlsQ2hhcjogX19jaGFyKDE3NiksCiAgICBtaXNzaW5nQ2hhcjogX19jaGFyKDIwMSksCiAgICBuaWxQcmVtaXRpdmU6IF9fY2hhcigxNzUpLAogICAgbWlzc2luZ1ByZW1pdGl2ZTogX19jaGFyKDIwMCksCiAgICBlbXB0eUNoYXI6IF9fY2hhcigxNzgpLAogICAgZW1wdHlWYWx1ZTogX19jaGFyKDE3NyksCiAgICBib3VuZHJ5Q2hhcjogX19jaGFyKDE3OSksCiAgICBvYmpTdGFydDogX19jaGFyKDE5OCksCiAgICBhcnJTdGFydDogX19jaGFyKDIwNCksCiAgICBhcnJheUVuZDogX19jaGFyKDE4NSkKfTsKY29uc3QgY2hhcnNBcnIgPSBbCiAgICBjaGFycy5uaWxDaGFyLAogICAgY2hhcnMubmlsUHJlbWl0aXZlLAogICAgY2hhcnMubWlzc2luZ0NoYXIsCiAgICBjaGFycy5taXNzaW5nUHJlbWl0aXZlLAogICAgY2hhcnMuYm91bmRyeUNoYXIsCiAgICBjaGFycy5lbXB0eUNoYXIsCiAgICBjaGFycy5lbXB0eVZhbHVlLAogICAgY2hhcnMuYXJyYXlFbmQsCiAgICBjaGFycy5vYmpTdGFydCwKICAgIGNoYXJzLmFyclN0YXJ0Cl07CmNvbnN0IF9lID0gZnVuY3Rpb24obm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgZV9zY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZVswXSAmJiBub2RlWzBdLnZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlWzBdLnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldFZhbHVlKG5vZGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaGFzVmFsaWREYXRhID0gaGFzRGF0YShub2RlKTsKICAgICAgICBpZiAoaGFzVmFsaWREYXRhID09PSB0cnVlKSB7CiAgICAgICAgICAgIGxldCBzdHIgPSAiIjsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZV9zY2hlbWEpKSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBpdGVtU2NoZW1hID0gZV9zY2hlbWFbMF07CiAgICAgICAgICAgICAgICBjb25zdCBhcnJfbGVuID0gbm9kZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW1TY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBhcnJfaSA9IDA7IGFycl9pIDwgYXJyX2xlbjsgYXJyX2krKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBnZXRWYWx1ZShub2RlW2Fycl9pXS52YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gX2Uobm9kZVthcnJfaV0sIGl0ZW1TY2hlbWEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyYXlFbmQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMub2JqU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZV9zY2hlbWEpOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihsZXQgaSBpbiBrZXlzKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgICAgICAgIGxldCByOwogICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIG5vZGUuYXR0cnNNYXAgJiYgbm9kZS5hdHRyc01hcFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmF0dHJzTWFwW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSBvcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS52YWwsIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmNoaWxkW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBoYXNWYWxpZERhdGE7CiAgICAgICAgfQogICAgfQp9Owpjb25zdCBnZXRWYWx1ZSA9IGZ1bmN0aW9uKGEpIHsKICAgIHN3aXRjaChhKXsKICAgICAgICBjYXNlIHZvaWQgMDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm1pc3NpbmdQcmVtaXRpdmU7CiAgICAgICAgY2FzZSBudWxsOgogICAgICAgICAgICByZXR1cm4gY2hhcnMubmlsUHJlbWl0aXZlOwogICAgICAgIGNhc2UgIiI6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5lbXB0eVZhbHVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9jZXNzVmFsdWUgPSBmdW5jdGlvbihzdHIsIHIpIHsKICAgIGlmICghaXNBcHBDaGFyKHJbMF0pICYmICFpc0FwcENoYXIoc3RyW3N0ci5sZW5ndGggLSAxXSkpIHsKICAgICAgICBzdHIgKz0gY2hhcnMuYm91bmRyeUNoYXI7CiAgICB9CiAgICByZXR1cm4gc3RyICsgcjsKfTsKY29uc3QgaXNBcHBDaGFyID0gZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiBjaGFyc0Fyci5pbmRleE9mKGNoKSAhPT0gLTE7Cn07CmZ1bmN0aW9uIGhhc0RhdGEoak9iaikgewogICAgaWYgKGpPYmogPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iaiA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBjaGFycy5uaWxDaGFyOwogICAgfSBlbHNlIGlmIChqT2JqLmNoaWxkICYmIE9iamVjdC5rZXlzKGpPYmouY2hpbGQpLmxlbmd0aCA9PT0gMCAmJiAoIWpPYmouYXR0cnNNYXAgfHwgT2JqZWN0LmtleXMoak9iai5hdHRyc01hcCkubGVuZ3RoID09PSAwKSkgewogICAgICAgIHJldHVybiBjaGFycy5lbXB0eUNoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9CmNvbnN0IGJ1aWxkT3B0aW9ucyQxID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGNvbnZlcnQybmltbiA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gYnVpbGRPcHRpb25zJDEob3B0aW9ucywgeG1sc3RyMnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLnByb3BzKTsKICAgIHJldHVybiBfZShub2RlLCBlX3NjaGVtYSwgb3B0aW9ucyk7Cn07CnZhciBjb252ZXJ0Mm5pbW5fMSA9IGNvbnZlcnQybmltbjsKdmFyIG5pbW5kYXRhID0gewogICAgY29udmVydDJuaW1uOiBjb252ZXJ0Mm5pbW5fMQp9Owpjb25zdCBidWlsZE9wdGlvbnMkMiA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0VG9Kc29uU3RyaW5nID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQyKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICBvcHRpb25zLmluZGVudEJ5ID0gb3B0aW9ucy5pbmRlbnRCeSB8fCAiIjsKICAgIHJldHVybiBfY1RvSnNvblN0cihub2RlLCBvcHRpb25zKTsKfTsKY29uc3QgX2NUb0pzb25TdHIgPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBsZXZlbCkgewogICAgbGV0IGpPYmogPSAieyI7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5jaGlsZCk7CiAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgY29uc3QgdGFnbmFtZSA9IGtleXNbaW5kZXhdOwogICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ25hbWVdICYmIG5vZGUuY2hpbGRbdGFnbmFtZV0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6IFsgJzsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWduYW1lXSl7CiAgICAgICAgICAgICAgICBqT2JqICs9IF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bdGFnXSwgb3B0aW9ucykgKyAiICwgIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBqT2JqID0gak9iai5zdWJzdHIoMCwgak9iai5sZW5ndGggLSAxKSArICIgXSAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGpPYmogKz0gJyInICsgdGFnbmFtZSArICciIDogJyArIF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bMF0sIG9wdGlvbnMpICsgIiAsIjsKICAgICAgICB9CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXApOwogICAgaWYgKHV0aWwuaXNFbXB0eU9iamVjdChqT2JqKSkgewogICAgICAgIHJldHVybiB1dGlsLmlzRXhpc3Qobm9kZS52YWwpID8gbm9kZS52YWwgOiAiIjsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkpIHsKICAgICAgICAgICAgaWYgKCEodHlwZW9mIG5vZGUudmFsID09PSAic3RyaW5nIiAmJiAobm9kZS52YWwgPT09ICIiIHx8IG5vZGUudmFsID09PSBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyKSkpIHsKICAgICAgICAgICAgICAgIGpPYmogKz0gJyInICsgb3B0aW9ucy50ZXh0Tm9kZU5hbWUgKyAnIiA6ICcgKyBzdHJpbmd2YWwobm9kZS52YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgaWYgKGpPYmpbak9iai5sZW5ndGggLSAxXSA9PT0gIiwiKSB7CiAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMik7CiAgICB9CiAgICByZXR1cm4gak9iaiArICJ9IjsKfTsKZnVuY3Rpb24gc3RyaW5ndmFsKHYpIHsKICAgIGlmICh2ID09PSB0cnVlIHx8IHYgPT09IGZhbHNlIHx8ICFpc05hTih2KSkgewogICAgICAgIHJldHVybiB2OwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJyInICsgdiArICciJzsKICAgIH0KfQp2YXIgY29udmVydFRvSnNvblN0cmluZ18xID0gY29udmVydFRvSnNvblN0cmluZzsKdmFyIG5vZGUyanNvbl9zdHIgPSB7CiAgICBjb252ZXJ0VG9Kc29uU3RyaW5nOiBjb252ZXJ0VG9Kc29uU3RyaW5nXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDMgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMiA9IHsKICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICJAXyIsCiAgICBhdHRyTm9kZU5hbWU6IGZhbHNlLAogICAgdGV4dE5vZGVOYW1lOiAiI3RleHQiLAogICAgaWdub3JlQXR0cmlidXRlczogdHJ1ZSwKICAgIGNkYXRhVGFnTmFtZTogZmFsc2UsCiAgICBjZGF0YVBvc2l0aW9uQ2hhcjogIlxcYyIsCiAgICBmb3JtYXQ6IGZhbHNlLAogICAgaW5kZW50Qnk6ICIgICIsCiAgICBzdXByZXNzRW1wdHlOb2RlOiBmYWxzZSwKICAgIHRhZ1ZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgYXR0clZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn07CmNvbnN0IHByb3BzJDIgPSBbCiAgICAiYXR0cmlidXRlTmFtZVByZWZpeCIsCiAgICAiYXR0ck5vZGVOYW1lIiwKICAgICJ0ZXh0Tm9kZU5hbWUiLAogICAgImlnbm9yZUF0dHJpYnV0ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgImZvcm1hdCIsCiAgICAiaW5kZW50QnkiLAogICAgInN1cHJlc3NFbXB0eU5vZGUiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInJvb3ROb2RlTmFtZSIKXTsKZnVuY3Rpb24gUGFyc2VyKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQzKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDIsIHByb3BzJDIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzIHx8IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICB0aGlzLmlzQXR0cmlidXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmF0dHJQcmVmaXhMZW4gPSB0aGlzLm9wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeC5sZW5ndGg7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGlzQXR0cmlidXRlOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWUpIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBpc0NEQVRBOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICB9CiAgICB0aGlzLnJlcGxhY2VDREFUQXN0ciA9IHJlcGxhY2VDREFUQXN0cjsKICAgIHRoaXMucmVwbGFjZUNEQVRBYXJyID0gcmVwbGFjZUNEQVRBYXJyOwogICAgdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZSA9IHByb2Nlc3NUZXh0T3JPYmpOb2RlOwogICAgaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGluZGVudGF0ZTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPlxuIjsKICAgICAgICB0aGlzLm5ld0xpbmUgPSAiXG4iOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIiI7CiAgICB9CiAgICBpZiAodGhpcy5vcHRpb25zLnN1cHJlc3NFbXB0eU5vZGUpIHsKICAgICAgICB0aGlzLmJ1aWxkVGV4dE5vZGUgPSBidWlsZEVtcHR5VGV4dE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZEVtcHR5T2JqTm9kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRUZXh0VmFsTm9kZTsKICAgICAgICB0aGlzLmJ1aWxkT2JqTm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKICAgIH0KICAgIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKfQpQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oak9iaikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoak9iaikgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZSAmJiB0aGlzLm9wdGlvbnMucm9vdE5vZGVOYW1lLmxlbmd0aCA+IDEpIHsKICAgICAgICBqT2JqID0gewogICAgICAgICAgICBbdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZV06IGpPYmoKICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHRoaXMuajJ4KGpPYmosIDApLnZhbDsKfTsKUGFyc2VyLnByb3RvdHlwZS5qMnggPSBmdW5jdGlvbihqT2JqLCBsZXZlbCkgewogICAgbGV0IGF0dHJTdHIgPSAiIjsKICAgIGxldCB2YWwgPSAiIjsKICAgIGZvcihsZXQga2V5IGluIGpPYmopewogICAgICAgIGlmICh0eXBlb2Ygak9ialtrZXldID09PSAidW5kZWZpbmVkIikgOwogICAgICAgIGVsc2UgaWYgKGpPYmpba2V5XSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgICAgIH0gZWxzZSBpZiAoak9ialtrZXldIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGpPYmpba2V5XSwga2V5LCAiIiwgbGV2ZWwpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGpPYmpba2V5XSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuaXNBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgICAgIGF0dHJTdHIgKz0gIiAiICsgYXR0ciArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKSArICciJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgaWYgKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFzdHIoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKCIiLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWVdKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShqT2JqW2tleV0pKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKTsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBYXJyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFyckxlbiA9IGpPYmpba2V5XS5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgYXJyTGVuOyBqKyspewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBqT2JqW2tleV1bal07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAidW5kZWZpbmVkIikgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGl0ZW0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpdGVtID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShpdGVtLCBrZXksIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGl0ZW0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmF0dHJOb2RlTmFtZSAmJiBrZXkgPT09IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IEtzID0gT2JqZWN0LmtleXMoak9ialtrZXldKTsKICAgICAgICAgICAgICAgIGNvbnN0IEwgPSBLcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgTDsgaisrKXsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIEtzW2pdICsgJz0iJyArIHRoaXMub3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV1bS3Nbal1dKSArICciJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnByb2Nlc3NUZXh0T3JPYmpOb2RlKGpPYmpba2V5XSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGF0dHJTdHIsCiAgICAgICAgdmFsCiAgICB9Owp9OwpmdW5jdGlvbiBwcm9jZXNzVGV4dE9yT2JqTm9kZShvYmplY3QsIGtleSwgbGV2ZWwpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuajJ4KG9iamVjdCwgbGV2ZWwgKyAxKTsKICAgIGlmIChvYmplY3RbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0gIT09IHZvaWQgMCAmJiBPYmplY3Qua2V5cyhvYmplY3QpLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkVGV4dE5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iak5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQXN0cihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXIpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQWFycihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhLmpvaW4oIl1dPjwhW0NEQVRBWyIpICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgZm9yKGxldCB2IGluIGNkYXRhKXsKICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyLCAiPCFbQ0RBVEFbIiArIGNkYXRhW3ZdICsgIl1dPiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyICsgdGhpcy5uZXdMaW5lOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmIChhdHRyU3RyICYmIHZhbC5pbmRleE9mKCI8IikgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB2YWwgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArIHRoaXMudGFnRW5kQ2hhciArIHZhbCArIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eU9iak5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAodmFsICE9PSAiIikgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBidWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IodmFsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eVRleHROb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGluZGVudGF0ZShsZXZlbCkgewogICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pbmRlbnRCeS5yZXBlYXQobGV2ZWwpOwp9CmZ1bmN0aW9uIGlzQXR0cmlidXRlKG5hbWUpIHsKICAgIGlmIChuYW1lLnN0YXJ0c1dpdGgodGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgpKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuc3Vic3RyKHRoaXMuYXR0clByZWZpeExlbik7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc0NEQVRBKG5hbWUpIHsKICAgIHJldHVybiBuYW1lID09PSB0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lOwp9CnZhciBqc29uMnhtbCA9IFBhcnNlcjsKdmFyIHBhcnNlciA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewogICAgY29uc3QgeDJ4bWxub2RlID0geG1sc3RyMnhtbG5vZGU7CiAgICBjb25zdCBidWlsZE9wdGlvbnMyID0gdXRpbC5idWlsZE9wdGlvbnM7CiAgICBleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24oeG1sRGF0YSwgZ2l2ZW5PcHRpb25zID0ge30sIHZhbGlkYXRpb25PcHRpb24pIHsKICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbikgewogICAgICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbiA9PT0gdHJ1ZSkgdmFsaWRhdGlvbk9wdGlvbiA9IHt9OwogICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoeG1sRGF0YSwgdmFsaWRhdGlvbk9wdGlvbik7CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKHJlc3VsdC5lcnIubXNnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2l2ZW5PcHRpb25zLnBhcnNlVHJ1ZU51bWJlck9ubHkgJiYgZ2l2ZW5PcHRpb25zLnBhcnNlTm9kZVZhbHVlICE9PSBmYWxzZSAmJiAhZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucykgewogICAgICAgICAgICBnaXZlbk9wdGlvbnMubnVtUGFyc2VPcHRpb25zID0gewogICAgICAgICAgICAgICAgbGVhZGluZ1plcm9zOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBsZXQgb3B0aW9ucyA9IGJ1aWxkT3B0aW9uczIoZ2l2ZW5PcHRpb25zLCB4MnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHgyeG1sbm9kZS5wcm9wcyk7CiAgICAgICAgY29uc3QgdHJhdmVyc2FibGVPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uKHRyYXZlcnNhYmxlT2JqLCBvcHRpb25zKTsKICAgIH07CiAgICBleHBvcnRzLmNvbnZlcnRUb25pbW4gPSBuaW1uZGF0YS5jb252ZXJ0Mm5pbW47CiAgICBleHBvcnRzLmdldFRyYXZlcnNhbE9iaiA9IHhtbHN0cjJ4bWxub2RlLmdldFRyYXZlcnNhbE9iajsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvbiA9IG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uOwogICAgZXhwb3J0cy5jb252ZXJ0VG9Kc29uU3RyaW5nID0gbm9kZTJqc29uX3N0ci5jb252ZXJ0VG9Kc29uU3RyaW5nOwogICAgZXhwb3J0cy52YWxpZGF0ZSA9IHZhbGlkYXRvci52YWxpZGF0ZTsKICAgIGV4cG9ydHMuajJ4UGFyc2VyID0ganNvbjJ4bWw7CiAgICBleHBvcnRzLnBhcnNlVG9OaW1uID0gZnVuY3Rpb24oeG1sRGF0YSwgc2NoZW1hLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuY29udmVydFRvbmltbihleHBvcnRzLmdldFRyYXZlcnNhbE9iaih4bWxEYXRhLCBvcHRpb25zKSwgc2NoZW1hLCBvcHRpb25zKTsKICAgIH07Cn0pOwpwYXJzZXIuY29udmVydFRvSnNvbjsKcGFyc2VyLmNvbnZlcnRUb0pzb25TdHJpbmc7CnBhcnNlci5jb252ZXJ0VG9uaW1uOwp2YXIgZ2V0VHJhdmVyc2FsT2JqJDEgPSBwYXJzZXIuZ2V0VHJhdmVyc2FsT2JqOwpwYXJzZXIuajJ4UGFyc2VyOwpwYXJzZXIucGFyc2U7CnBhcnNlci5wYXJzZVRvTmltbjsKcGFyc2VyLnZhbGlkYXRlOwpmdW5jdGlvbiBwYXJzZVhtbCh4bWwpIHsKICAgIGNvbnN0IHJ0ID0gZ2V0VHJhdmVyc2FsT2JqJDEoeG1sLCB7CiAgICAgICAgaWdub3JlQXR0cmlidXRlczogZmFsc2UsCiAgICAgICAgcGFyc2VBdHRyaWJ1dGVWYWx1ZTogZmFsc2UsCiAgICAgICAgcGFyc2VOb2RlVmFsdWU6IGZhbHNlCiAgICB9KTsKICAgIGNvbnN0IG5hbWVzcGFjZXMgPSBuZXcgWG1sTmFtZXNwYWNlcygpOwogICAgYXBwbHlRbmFtZXMocnQsIG5hbWVzcGFjZXMpOwogICAgY2hlY2tFcXVhbCgnbmFtZXNwYWNlcy5zdGFja1NpemUnLCBuYW1lc3BhY2VzLnN0YWNrU2l6ZSwgMCk7CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCkgewogICAgbGV0IG1hcDsKICAgIGlmIChhdHRyc01hcCkgewogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhdHRyc01hcCkpewogICAgICAgICAgICBpZiAoIW5hbWUuc3RhcnRzV2l0aCgnQF8nKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgYXR0cnNNYXAgbmFtZTogJHtuYW1lfSwgJHthdHRyc01hcH1gKTsKICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgbWFwLnNldChuYW1lLnN1YnN0cmluZygyKSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXAgfHwgRU1QVFlfU1RSSU5HX01BUDsKfQpmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5xbmFtZXMpIHsKICAgIGxldCBydDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBxbmFtZSBvZiBxbmFtZXMpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAocW5hbWUubmFtZSA9PT0gJyonID8gcW5hbWUubmFtZXNwYWNlVXJpID09PSBleHRDaGlsZC5xbmFtZS5uYW1lc3BhY2VVcmkgOiBxbmFtZUVxKHFuYW1lLCBleHRDaGlsZC5xbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBydCA9IHJ0IHx8IFtdOwogICAgICAgICAgICAgICAgICAgIHJ0LnB1c2goZXh0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJ0IHx8IEVNUFRZX1hNTF9OT0RFX0FSUkFZOwp9CmZ1bmN0aW9uIGZpbmRFbGVtZW50UmVjdXJzaXZlKHJvb3QsIHRlc3QpIHsKICAgIGlmICh0ZXN0KHJvb3QpKSByZXR1cm4gcm9vdDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhyb290LmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gZmluZEVsZW1lbnRSZWN1cnNpdmUoZXh0Q2hpbGQsIHRlc3QpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHFuYW1lRXEobGhzLCByaHMpIHsKICAgIHJldHVybiBsaHMubmFtZSA9PT0gcmhzLm5hbWUgJiYgbGhzLm5hbWVzcGFjZVVyaSA9PT0gcmhzLm5hbWVzcGFjZVVyaTsKfQpmdW5jdGlvbiBxbmFtZXNJbmNsdWRlKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLnNvbWUoKHYpPT5xbmFtZUVxKHYsIHJocykKICAgICk7Cn0KY29uc3QgRU1QVFlfU1RSSU5HX01BUCA9IG5ldyBNYXAoKTsKY29uc3QgRU1QVFlfWE1MX05PREVfQVJSQVkgPSBbXTsKZnVuY3Rpb24gYXBwbHlRbmFtZXMobm9kZSwgbmFtZXNwYWNlcykgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBhdHRzID0gbmFtZXNwYWNlcy5wdXNoKG5vZGUuYXR0cnNNYXApOwogICAgICAgIGNvbnN0IG5vZGVBc0FueSA9IG5vZGU7CiAgICAgICAgbm9kZUFzQW55LmF0dHMgPSBhdHRzOwogICAgICAgIG5vZGVBc0FueS5xbmFtZSA9IGNvbXB1dGVRbmFtZShub2RlLnRhZ25hbWUsIG5hbWVzcGFjZXMpOwogICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgICAgIGZvciAoY29uc3QgY2hpbGROb2RlIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGFwcGx5UW5hbWVzKGNoaWxkTm9kZSwgbmFtZXNwYWNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGZpbmFsbHl7CiAgICAgICAgbmFtZXNwYWNlcy5wb3AoKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlUW5hbWUobmFtZVdpdGhPcHRpb25hbFByZWZpeCwgbmFtZXNwYWNlcykgewogICAgY29uc3QgaSA9IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXguaW5kZXhPZignOicpOwogICAgaWYgKGkgPCAwKSByZXR1cm4gewogICAgICAgIG5hbWU6IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmZpbmROYW1lc3BhY2VVcmkoJycpCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZyhpICsgMSksCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmdldE5hbWVzcGFjZVVyaShuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZygwLCBpKSkKICAgIH07Cn0KY2xhc3MgWG1sTmFtZXNwYWNlcyB7CiAgICBzdGFjayA9IFtdOwogICAgZ2V0IHN0YWNrU2l6ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5sZW5ndGg7CiAgICB9CiAgICBwdXNoKGF0dHJzTWFwKSB7CiAgICAgICAgY29uc3QgYXR0cnMgPSBjb21wdXRlQXR0cmlidXRlTWFwKGF0dHJzTWFwKTsKICAgICAgICBsZXQgbWFwOwogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBhdHRycy5lbnRyaWVzKCkpewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3htbG5zJykgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIG1hcC5zZXQoJycsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoJ3htbG5zOicpKSB7CiAgICAgICAgICAgICAgICBtYXAgPSBtYXAgfHwgbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoNik7CiAgICAgICAgICAgICAgICBtYXAuc2V0KHByZWZpeCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucHVzaChtYXAgfHwgRU1QVFlfU1RSSU5HX01BUCk7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQogICAgcG9wKCkgewogICAgICAgIHRoaXMuc3RhY2sucG9wKCk7CiAgICB9CiAgICBmaW5kTmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0TmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGdldE5hbWVzcGFjZVVyaTogcHJlZml4IG5vdCBmb3VuZDogJHtwcmVmaXh9YCk7CiAgICB9Cn0KZnVuY3Rpb24gaXNSZWFkb25seUFycmF5KGFyZykgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJnKTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RJbWFnZXNTcmNTZXQodHJpbW1lZFRleHQpIHsKICAgIGNvbnN0IHdpZHRocyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IGRlbnNpdGllcyA9IG5ldyBTZXQoKTsKICAgIGxldCB3aXRoV2lkdGhDb3VudCA9IDA7CiAgICBjb25zdCBwaWVjZXMgPSB0cmltbWVkVGV4dC5zcGxpdCgvLFxzKy8pOwogICAgZm9yIChjb25zdCBwaWVjZSBvZiBwaWVjZXMpewogICAgICAgIGNvbnN0IG0gPSAvXihbXlxzXSspKFxzKyhcZCt3fFxkKyhcLlxkKyk/eCkpPyQvLmV4ZWMocGllY2UpOwogICAgICAgIGlmICghbSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGNvbnN0IHVybCA9IG1bMV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IG1bM10gfHwgJyc7CiAgICAgICAgaWYgKCFpc1VybCh1cmwpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IuZW5kc1dpdGgoJ3cnKSkgewogICAgICAgICAgICB3aXRoV2lkdGhDb3VudCsrOwogICAgICAgICAgICBjb25zdCB3aWR0aCA9IHBhcnNlSW50KGRlc2NyaXB0b3Iuc3Vic3RyaW5nKDAsIGRlc2NyaXB0b3IubGVuZ3RoIC0gMSkpOwogICAgICAgICAgICBpZiAod2lkdGggPD0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAod2lkdGhzLmhhcyh3aWR0aCkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgd2lkdGhzLmFkZCh3aWR0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgZGVuc2l0eSA9IGRlc2NyaXB0b3IuZW5kc1dpdGgoJ3gnKSA/IHBhcnNlRmxvYXQoZGVzY3JpcHRvci5zdWJzdHJpbmcoMCwgZGVzY3JpcHRvci5sZW5ndGggLSAxKSkgOiAxOwogICAgICAgICAgICBpZiAoZGVuc2l0eSA8PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZW5zaXRpZXMuaGFzKGRlbnNpdHkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlbnNpdGllcy5hZGQoZGVuc2l0eSk7CiAgICAgICAgfQogICAgfQogICAgaWYgKHdpdGhXaWR0aENvdW50ID4gMCAmJiB3aXRoV2lkdGhDb3VudCAhPT0gcGllY2VzLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gaXNOb3RFbXB0eSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIHRyaW1tZWRUZXh0Lmxlbmd0aCA+IDA7Cn0KZnVuY3Rpb24gaXNVcmwodHJpbW1lZFRleHQpIHsKICAgIGNvbnN0IHUgPSB0cnlQYXJzZVVybCh0cmltbWVkVGV4dCk7CiAgICByZXR1cm4gdSAmJiB1LnByb3RvY29sID09PSAnaHR0cHM6JyB8fCB1Py5wcm90b2NvbCA9PT0gJ2h0dHA6JzsKfQpmdW5jdGlvbiBpc1VyaSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIHRyeVBhcnNlVXJsKHRyaW1tZWRUZXh0KSAhPT0gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGlzTWltZVR5cGUodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlx3K1wvWy0rLlx3XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1V1aWQodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzRW1haWxBZGRyZXNzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bXkBcc10rQFteQFxzXSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0F0TW9zdENoYXJhY3RlcnMobWF4Q2hhcmFjdGVycykgewogICAgcmV0dXJuICh0cmltbWVkVGV4dCk9PnRyaW1tZWRUZXh0Lmxlbmd0aCA8PSBtYXhDaGFyYWN0ZXJzCiAgICA7Cn0KZnVuY3Rpb24gaXNTZWNvbmRzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZCsoXC5cZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzR2VvTGF0TG9uKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15nZW86LT9cZHsxLDJ9KFwuXGQrKT8sLT9cZHsxLDN9KFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc09wZW5TdHJlZXRNYXBJZGVudGlmaWVyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bTldSXVxkKygjXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc05vbk5lZ2F0aXZlSW50ZWdlcih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrJC8udGVzdCh0cmltbWVkVGV4dCkgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpID49IDAgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpLnRvU3RyaW5nKCkgPT09IHRyaW1tZWRUZXh0Owp9CmZ1bmN0aW9uIGlzRGVjaW1hbCh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrKFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1JmYzI4MjIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlBLVphLXosIF0rIFxkezJ9OlxkezJ9KDpcZHsyfSk/ICgtP1swLTldK3xbQS1aXXszLH0pJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNJc284NjAxKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzQm9vbGVhbih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eKHRydWV8ZmFsc2UpJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNZZXNObyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eKHllc3xubykkLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bYS16XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RNZWRpdW0odHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlthLXpdKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzUG9kY2FzdFNvY2lhbEludGVyYWN0UHJvdG9jb2wodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXihkaXNhYmxlZHxhY3Rpdml0eXB1Ynx0d2l0dGVyfGxpZ2h0bmluZykkLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RCbG9ja0V4Y2x1ZGVMaXN0KHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bYS16XXsyLH0oLFthLXpdezIsfSkqJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0TGl2ZUl0ZW1TdGF0dXModHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXihwZW5kaW5nfGxpdmV8ZW5kZWQpJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwoc3RyLCBiYXNlKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHN0ciwgYmFzZSk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpmdW5jdGlvbiB2YWxpZGF0ZUZlZWRYbWwoeG1sLCBjYWxsYmFja3MpIHsKICAgIGlmICh4bWwudGFnbmFtZSAhPT0gJyF4bWwnKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC50YWduYW1lOiAke3htbC50YWduYW1lfWApOwogICAgaWYgKE9iamVjdC5rZXlzKHhtbC5hdHRyc01hcCkubGVuZ3RoID4gMCkgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHhtbCwgYEJhZCB4bWwuYXR0cnNNYXA6ICR7eG1sLmF0dHJzTWFwfWApOwogICAgY29uc3QgZG9jRWxlbWVudCA9IE9iamVjdC52YWx1ZXMoeG1sLmNoaWxkKS5mbGF0TWFwKCh2KT0+dgogICAgKVswXTsKICAgIGlmICghZG9jRWxlbWVudCkgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHhtbCwgYE5vIHhtbCByb290IGVsZW1lbnRgKTsKICAgIHZhbGlkYXRlUnNzKGRvY0VsZW1lbnQsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gcG9kY2FzdEluZGV4UmVmZXJlbmNlKGhyZWYpIHsKICAgIHJldHVybiB7CiAgICAgICAgcnVsZXNldDogJ3BvZGNhc3RpbmRleCcsCiAgICAgICAgaHJlZgogICAgfTsKfQpmdW5jdGlvbiBnZXRTaW5nbGVDaGlsZChub2RlLCBuYW1lLCBjYWxsYmFja3MsIG9wdHMgPSB7fSkgewogICAgY29uc3QgY2hpbGRyZW4gPSBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCB7CiAgICAgICAgbmFtZQogICAgfSk7CiAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgRXhwZWN0ZWQgc2luZ2xlIDwke25hbWV9PiBjaGlsZCBlbGVtZW50IHVuZGVyIDwke25vZGUudGFnbmFtZX0+LCBmb3VuZCAke2NoaWxkcmVuLmxlbmd0aCA9PT0gMCA/ICdub25lJyA6IGNoaWxkcmVuLmxlbmd0aH1gLCBvcHRzKTsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuWzBdOwp9CmZ1bmN0aW9uIHZhbGlkYXRlUnNzKHJzcywgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBvcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI3doYXRJc1JzcycKICAgICAgICB9CiAgICB9OwogICAgaWYgKHJzcy50YWduYW1lICE9PSAncnNzJykgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHJzcywgYEJhZCB4bWwgcm9vdCB0YWc6ICR7cnNzLnRhZ25hbWV9LCBleHBlY3RlZCByc3NgLCBvcHRzKTsKICAgIGNvbnN0IHZlcnNpb24gPSByc3MuYXR0cy5nZXQoJ3ZlcnNpb24nKTsKICAgIGlmICh2ZXJzaW9uICE9PSAnMi4wJykgY2FsbGJhY2tzLm9uV2FybmluZyhyc3MsIGBCYWQgcnNzLnZlcnNpb246ICR7dmVyc2lvbn0sIGV4cGVjdGVkIDIuMGAsIG9wdHMpOwogICAgY29uc3QgaXR1bmVzT3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL3BvZGNhc3RlcnMuYXBwbGUuY29tL3N1cHBvcnQvODIzLXBvZGNhc3QtcmVxdWlyZW1lbnRzIzp+OnRleHQ9UG9kY2FzdCUyMFJTUyUyMGZlZWQlMjB0ZWNobmljYWwlMjByZXF1aXJlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IGhhc0l0dW5lc1ByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnaXR1bmVzOicpCiAgICApICE9PSB1bmRlZmluZWQ7CiAgICBpZiAoaGFzSXR1bmVzUHJlZml4KSBjaGVja0F0dHJpYnV0ZUVxdWFsKHJzcywgJ3htbG5zOml0dW5lcycsICdodHRwOi8vd3d3Lml0dW5lcy5jb20vZHRkcy9wb2RjYXN0LTEuMC5kdGQnLCBjYWxsYmFja3MsIGl0dW5lc09wdHMpOwogICAgY29uc3QgaGFzQ29udGVudFByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnY29udGVudDonKQogICAgKSAhPT0gdW5kZWZpbmVkOwogICAgaWYgKGhhc0NvbnRlbnRQcmVmaXgpIGNoZWNrQXR0cmlidXRlRXF1YWwocnNzLCAneG1sbnM6Y29udGVudCcsICdodHRwOi8vcHVybC5vcmcvcnNzLzEuMC9tb2R1bGVzL2NvbnRlbnQvJywgY2FsbGJhY2tzLCBpdHVuZXNPcHRzKTsKICAgIGNvbnN0IGNoYW5uZWwgPSBnZXRTaW5nbGVDaGlsZChyc3MsICdjaGFubmVsJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGlmICghY2hhbm5lbCkgcmV0dXJuOwogICAgdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcykgewogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNyZXF1aXJlZENoYW5uZWxFbGVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAndGl0bGUnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIG9wdHMpOwogICAgY29uc3QgbGluayA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICdsaW5rJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChsaW5rLCBpc1VybCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ2Rlc2NyaXB0aW9uJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChkZXNjcmlwdGlvbiwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNndWlkJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZ3VpZCkuY2hlY2tWYWx1ZShpc1V1aWQsIChndWlkVGV4dCk9PnsKICAgICAgICBjb25zdCB2ZXJzaW9uID0gZ3VpZFRleHQuY2hhckF0KDE0KTsKICAgICAgICBpZiAodmVyc2lvbiAhPT0gJzUnKSB7CiAgICAgICAgICAgIHJldHVybiBgZXhwZWN0ZWQgYSBVVUlEdjUsIGZvdW5kIGEgVVVJRHYke3ZlcnNpb259YDsKICAgICAgICB9CiAgICB9KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NrZWQnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5sb2NrZWQpLmNoZWNrVmFsdWUoKHYpPT4vXih5ZXN8bm8pJC8udGVzdCh2KQogICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdvd25lcicsIGlzRW1haWxBZGRyZXNzKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGZvciAoY29uc3QgZnVuZGluZyBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmZ1bmRpbmcpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgZnVuZGluZywgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNmdW5kaW5nJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGZvciAoY29uc3QgdHJhaWxlciBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYWlsZXIpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgdHJhaWxlciwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFpbGVyJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3B1YmRhdGUnLCBpc1JmYzI4MjIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnc2Vhc29uJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0TGljZW5zZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RWYWx1ZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbWVkaXVtJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubWVkaXVtKS5jaGVja1ZhbHVlKGlzUG9kY2FzdE1lZGl1bSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RJbWFnZXMoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3QgbGl2ZUl0ZW1zID0gZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5saXZlSXRlbSk7CiAgICBsZXQgbGl2ZUl0ZW1zVmFsaWRhdGVkID0gMDsKICAgIGZvciAoY29uc3QgbGl2ZUl0ZW0gb2YgbGl2ZUl0ZW1zKXsKICAgICAgICBpZiAobGl2ZUl0ZW1zVmFsaWRhdGVkIDwgMSkgewogICAgICAgICAgICB2YWxpZGF0ZUl0ZW0obGl2ZUl0ZW0sIGNhbGxiYWNrcywgJ2xpdmVJdGVtJyk7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2NoYW5uZWwnLCBsaXZlSXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsaXZlLWl0ZW0nKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3RhdHVzJywgaXNQb2RjYXN0TGl2ZUl0ZW1TdGF0dXMpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3N0YXJ0JywgaXNJc284NjAxKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdlbmQnLCBpc0lzbzg2MDEpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgICAgICBsaXZlSXRlbXNWYWxpZGF0ZWQrKzsKICAgICAgICB9CiAgICB9CiAgICBjYWxsYmFja3Mub25Qb2RjYXN0SW5kZXhMaXZlSXRlbXNGb3VuZChsaXZlSXRlbXMubGVuZ3RoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlI3BvZGNhc3RibG9jay0tLWRpc2N1c3MnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5ibG9jaykuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZXhjbHVkZScsIGlzUG9kY2FzdEJsb2NrRXhjbHVkZUxpc3QpLmNoZWNrVmFsdWUoaXNZZXNObykuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZSNwb2RjYXN0Y29tcGxldGUtLS1kaXNjdXNzJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguY29tcGxldGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2FyY2hpdmUnLCBpc1VybCkuY2hlY2tWYWx1ZShpc1llc05vKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGNvbnN0IHNvY2lhbHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbCk7CiAgICBjb25zdCBzb2NpYWxSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9wcm9wb3NhbC1kb2NzL3NvY2lhbC9zb2NpYWwubWQjc29jaWFsLWVsZW1lbnQnKTsKICAgIGNvbnN0IHNvY2lhbFNpZ25VcFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWxzaWdudXAtZWxlbWVudCcpOwogICAgZm9yIChjb25zdCBzb2NpYWwgb2Ygc29jaWFscyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnY2hhbm5lbCcsIHNvY2lhbCwgY2FsbGJhY2tzLCBzb2NpYWxSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3BsYXRmb3JtJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncHJvdG9jb2wnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50SWQnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50VXJsJywgaXNVcmwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNvbnN0IHNvY2lhbFNpZ25VcHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbFNpZ25VcCk7CiAgICAgICAgZm9yIChjb25zdCBzb2NpYWxTaWduVXAgb2Ygc29jaWFsU2lnblVwcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3NvY2lhbCcsIHNvY2lhbFNpZ25VcCwgY2FsbGJhY2tzLCBzb2NpYWxTaWduVXBSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2hvbWVVcmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc2lnblVwVXJsJywgaXNVcmwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJhZFNvY2lhbFNpZ251cHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbFNpZ25VcCk7CiAgICBpZiAoYmFkU29jaWFsU2lnbnVwcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhiYWRTb2NpYWxTaWdudXBzWzBdLCBgQmFkIDwke2JhZFNvY2lhbFNpZ251cHNbMF0udGFnbmFtZX0+OiBzaG91bGQgYmUgYSBjaGlsZCBvZiA8cG9kY2FzdDpzb2NpYWw+LCBub3QgY2hhbm5lbGApOwogICAgfQogICAgY29uc3QgcG9kcGluZ1JlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3MvcG9kcGluZy9wb2RwaW5nLm1kI3NwZWNpZmljYXRpb24nKTsKICAgIGNvbnN0IHBvZHBpbmcgPSBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kcGluZ1JlZmVyZW5jZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5wb2RwaW5nKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1c2VzUG9kcGluZycsIGlzQm9vbGVhbikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkubm9kZTsKICAgIGlmIChwb2RwaW5nKSB7CiAgICAgICAgZm9yIChjb25zdCBoaXZlQWNjb3VudCBvZiBmaW5kQ2hpbGRFbGVtZW50cyhwb2RwaW5nLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmhpdmVBY2NvdW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3BvZHBpbmcnLCBoaXZlQWNjb3VudCwgY2FsbGJhY2tzLCBwb2RwaW5nUmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50JywgaXNOb3RFbXB0eSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY2hlY2tQb2RjYXN0VGFnVXNhZ2UoY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGl0ZW1zID0gY2hhbm5lbC5jaGlsZC5pdGVtIHx8IFtdOwogICAgbGV0IGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCA9IDA7CiAgICBsZXQgaXRlbXNWYWxpZGF0ZWQgPSAwOwogICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXsKICAgICAgICBpZiAoaXRlbXNWYWxpZGF0ZWQgPCAxKSB7CiAgICAgICAgICAgIHZhbGlkYXRlSXRlbShpdGVtLCBjYWxsYmFja3MsICdpdGVtJyk7CiAgICAgICAgICAgIGl0ZW1zVmFsaWRhdGVkKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgewogICAgICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgICAgIH0pOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQrKzsKICAgIH0KICAgIGNhbGxiYWNrcy5vblJzc0l0ZW1zRm91bmQoaXRlbXMubGVuZ3RoLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFBlcnNvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBmb3IgKGNvbnN0IHBlcnNvbiBvZiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBlcnNvbikpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQobGV2ZWwsIHBlcnNvbiwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNwZXJzb24nKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyb2xlJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZ3JvdXAnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdpbWcnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaHJlZicsIGlzVXJsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMb2NhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NhdGlvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxvY2F0aW9uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdnZW8nLCBpc0dlb0xhdExvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnb3NtJywgaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcikuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMaWNlbnNlKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xpY2Vuc2UnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5saWNlbnNlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RWYWx1ZShsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCB2YWx1ZSA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3ZhbHVlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudmFsdWUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdtZXRob2QnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdzdWdnZXN0ZWQnLCBpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpLm5vZGU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlUmVjaXBpZW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHZhbHVlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnZhbHVlUmVjaXBpZW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3ZhbHVlJywgdmFsdWVSZWNpcGllbnQsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdmFsdWUtcmVjaXBpZW50JykpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21LZXknLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21WYWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhZGRyZXNzJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3BsaXQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZmVlJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0SW1hZ2VzKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ltYWdlcycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmltYWdlcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3Jjc2V0JywgaXNQb2RjYXN0SW1hZ2VzU3JjU2V0KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RUYWdVc2FnZShub2RlLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IGtub3duID0gbmV3IFNldCgpOwogICAgY29uc3QgdW5rbm93biA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IG5hbWVzcGFjZVVyaXMgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWU6ICcqJywKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICkpKXsKICAgICAgICBjb25zdCBpc0tub3duID0gUW5hbWVzLlBvZGNhc3RJbmRleC5LTk9XTl9OQU1FUy5oYXMoZWxlbWVudC5xbmFtZS5uYW1lKTsKICAgICAgICAoaXNLbm93biA/IGtub3duIDogdW5rbm93bikuYWRkKGVsZW1lbnQucW5hbWUubmFtZSk7CiAgICAgICAgaWYgKGVsZW1lbnQucW5hbWUubmFtZXNwYWNlVXJpKSBuYW1lc3BhY2VVcmlzLmFkZChlbGVtZW50LnFuYW1lLm5hbWVzcGFjZVVyaSk7CiAgICB9CiAgICBpZiAoa25vd24uc2l6ZSArIHVua25vd24uc2l6ZSA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kKGtub3duLCB1bmtub3duLCBuYW1lc3BhY2VVcmlzKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZUVxdWFsKG5vZGUsIGF0dE5hbWUsIGF0dEV4cGVjdGVkVmFsdWUsIGNhbGxiYWNrcywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBhdHRWYWx1ZSA9IG5vZGUuYXR0cy5nZXQoYXR0TmFtZSk7CiAgICBpZiAoIWF0dFZhbHVlKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgTWlzc2luZyA8JHtub2RlLnRhZ25hbWV9PiAke2F0dE5hbWV9IGF0dHJpYnV0ZSwgZXhwZWN0ZWQgJHthdHRFeHBlY3RlZFZhbHVlfWAsIG9wdHMpOwogICAgfSBlbHNlIGlmIChhdHRWYWx1ZSAhPT0gYXR0RXhwZWN0ZWRWYWx1ZSkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiAke2F0dE5hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHthdHRWYWx1ZX0sIGV4cGVjdGVkICR7YXR0RXhwZWN0ZWRWYWx1ZX1gLCBvcHRzKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja1RleHQobm9kZSwgdGVzdCwgY2FsbGJhY2tzLCBvcHRzID0ge30pIHsKICAgIGlmIChub2RlKSB7CiAgICAgICAgY29uc3QgdHJpbW1lZFRleHQgPSAobm9kZS52YWwgfHwgJycpLnRyaW0oKTsKICAgICAgICBpZiAoIXRlc3QodHJpbW1lZFRleHQpKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiB2YWx1ZTogJHt0cmltbWVkVGV4dCA9PT0gJycgPyAnPGVtcHR5PicgOiB0cmltbWVkVGV4dH1gLCBvcHRzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRyaW1tZWRUZXh0OwogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBmaW5kRmlyc3RDaGlsZEVsZW1lbnQobm9kZSwgcW5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIHFuYW1lKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBJdGVtIGlzIG1pc3NpbmcgYW4gPCR7cW5hbWUubmFtZX0+IGVsZW1lbnRgLCBvcHRzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEl0ZW0gaGFzIG11bHRpcGxlIDwke3FuYW1lLm5hbWV9PiBlbGVtZW50c2AsIG9wdHMpOwogICAgICAgIHJldHVybiBlbGVtZW50c1swXTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcywgaXRlbVRhZ05hbWUpIHsKICAgIGNvbnN0IGl0dW5lc09wdHMxID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAnaXR1bmVzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vcG9kY2FzdGVycy5hcHBsZS5jb20vc3VwcG9ydC84MjMtcG9kY2FzdC1yZXF1aXJlbWVudHMjOn46dGV4dD1Qb2RjYXN0JTIwUlNTJTIwZmVlZCUyMHRlY2huaWNhbCUyMHJlcXVpcmVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgaXR1bmVzT3B0czIgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9oZWxwLmFwcGxlLmNvbS9pdGMvcG9kY2FzdHNfY29ubmVjdC8jL2l0Y2I1NDM1MzM5MCcKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBmaW5kRmlyc3RDaGlsZEVsZW1lbnQoaXRlbSwgewogICAgICAgIG5hbWU6ICd0aXRsZScKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgaWYgKHRpdGxlKSB7CiAgICAgICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIGl0dW5lc09wdHMyKTsKICAgIH0KICAgIGNvbnN0IGVuY2xvc3VyZSA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ2VuY2xvc3VyZScKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgaWYgKGVuY2xvc3VyZSkgewogICAgICAgIGNvbnN0IHJzc0VuY2xvc3VyZU9wdHMgPSB7CiAgICAgICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9jeWJlci5oYXJ2YXJkLmVkdS9yc3MvcnNzLmh0bWwjbHRlbmNsb3N1cmVndFN1YmVsZW1lbnRPZkx0aXRlbWd0JwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCB1cmwgPSBlbmNsb3N1cmUuYXR0cy5nZXQoJ3VybCcpOwogICAgICAgIGlmICghdXJsKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgJHtpdGVtVGFnTmFtZX0gPGVuY2xvc3VyZT4gdXJsIGF0dHJpYnV0ZWAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGlmICh1cmwgJiYgIWlzVXJsKHVybCkpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgQmFkICR7aXRlbVRhZ05hbWV9IDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGUgdmFsdWU6ICR7dXJsfSwgZXhwZWN0ZWQgdXJsYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCdsZW5ndGgnKTsKICAgICAgICBpZiAoIWxlbmd0aCkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nICR7aXRlbVRhZ05hbWV9IDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAobGVuZ3RoICYmICFpc05vbk5lZ2F0aXZlSW50ZWdlcihsZW5ndGgpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCAke2l0ZW1UYWdOYW1lfSA8ZW5jbG9zdXJlPiBsZW5ndGggYXR0cmlidXRlIHZhbHVlOiAke2xlbmd0aH0sIGV4cGVjdGVkIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgdHlwZSA9IGVuY2xvc3VyZS5hdHRzLmdldCgndHlwZScpOwogICAgICAgIGlmICghdHlwZSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nICR7aXRlbVRhZ05hbWV9IDxlbmNsb3N1cmU+IHR5cGUgYXR0cmlidXRlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgaWYgKHR5cGUgJiYgIWlzTWltZVR5cGUodHlwZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgQmFkICR7aXRlbVRhZ05hbWV9IDxlbmNsb3N1cmU+IHR5cGUgYXR0cmlidXRlIHZhbHVlOiAke3R5cGV9LCBleHBlY3RlZCBNSU1FIHR5cGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgIH0KICAgIGNvbnN0IGd1aWQgPSBmaW5kRmlyc3RDaGlsZEVsZW1lbnQoaXRlbSwgewogICAgICAgIG5hbWU6ICdndWlkJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMSk7CiAgICBpZiAoZ3VpZCkgewogICAgICAgIGNvbnN0IGd1aWRUZXh0ID0gY2hlY2tUZXh0KGd1aWQsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgaXR1bmVzT3B0czEpOwogICAgICAgIGNvbnN0IHJzc0d1aWRPcHRzID0gewogICAgICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgICAgIHJ1bGVzZXQ6ICdyc3MnLAogICAgICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI2x0Z3VpZGd0U3ViZWxlbWVudE9mTHRpdGVtZ3QnCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IG1pc3NwZWxsaW5ncyA9IFsKICAgICAgICAgICAgLi4uZ3VpZC5hdHRzLmtleXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+diAhPT0gJ2lzUGVybWFMaW5rJyAmJiB2LnRvTG93ZXJDYXNlKCkgPT09ICdpc3Blcm1hbGluaycKICAgICAgICApOwogICAgICAgIGZvciAoY29uc3QgbWlzc3BlbGxpbmcgb2YgbWlzc3BlbGxpbmdzKXsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkICR7aXRlbVRhZ05hbWV9IDxndWlkPiBpc1Blcm1hTGluayBhdHRyaWJ1dGUgc3BlbGxpbmc6ICR7bWlzc3BlbGxpbmd9YCwgcnNzR3VpZE9wdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1Blcm1hTGluayA9IGd1aWQuYXR0cy5nZXQoJ2lzUGVybWFMaW5rJykgfHwgJ3RydWUnOwogICAgICAgIGlmIChpc1Blcm1hTGluayA9PT0gJ3RydWUnICYmIGd1aWRUZXh0ICYmICFpc1VybChndWlkVGV4dCkgJiYgbWlzc3BlbGxpbmdzLmxlbmd0aCA9PT0gMCkgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkICR7aXRlbVRhZ05hbWV9IDxndWlkPiB2YWx1ZTogJHtndWlkVGV4dH0sIGV4cGVjdGVkIHVybCB3aGVuIGlzUGVybWFMaW5rPSJ0cnVlIiBvciB1bnNwZWNpZmllZGAsIHJzc0d1aWRPcHRzKTsKICAgIH0KICAgIGNvbnN0IHRyYW5zY3JpcHRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC50cmFuc2NyaXB0KTsKICAgIGZvciAoY29uc3QgdHJhbnNjcmlwdCBvZiB0cmFuc2NyaXB0cyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudChpdGVtVGFnTmFtZSwgdHJhbnNjcmlwdCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFuc2NyaXB0JykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZ3VhZ2UnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyZWwnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGl0ZW1UYWdOYW1lLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2NoYXB0ZXJzJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguY2hhcHRlcnMpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjb25zdCBzb3VuZGJpdGVzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VuZGJpdGUpOwogICAgZm9yIChjb25zdCBzb3VuZGJpdGUgb2Ygc291bmRiaXRlcyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIHNvdW5kYml0ZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNzb3VuZGJpdGUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3RhcnRUaW1lJywgaXNTZWNvbmRzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdkdXJhdGlvbicsIGlzU2Vjb25kcykuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RQZXJzb24oaXRlbVRhZ05hbWUsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RMb2NhdGlvbihpdGVtVGFnTmFtZSwgaXRlbSwgY2FsbGJhY2tzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGl0ZW1UYWdOYW1lLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3NlYXNvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNlYXNvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbmFtZScsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSh2KQogICAgKS5jaGVja1ZhbHVlKGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGl0ZW1UYWdOYW1lLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2VwaXNvZGUnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5lcGlzb2RlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdkaXNwbGF5JywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICkuY2hlY2tWYWx1ZShpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY2hlY2tQb2RjYXN0TGljZW5zZShpdGVtVGFnTmFtZSwgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmFsdGVybmF0ZUVuY2xvc3VyZSk7CiAgICBmb3IgKGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZSBvZiBhbHRlcm5hdGVFbmNsb3N1cmVzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KGl0ZW1UYWdOYW1lLCBhbHRlcm5hdGVFbmNsb3N1cmUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjYWx0ZXJuYXRlLWVuY2xvc3VyZScpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnbGVuZ3RoJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2JpdHJhdGUnLCBpc0RlY2ltYWwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2hlaWdodCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdsYW5nJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgndGl0bGUnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgICAgICkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncmVsJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICAgICApLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2NvZGVjcycsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2RlZmF1bHQnLCBpc0Jvb2xlYW4pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdhbHRlcm5hdGVFbmNsb3N1cmUnLCBhbHRlcm5hdGVFbmNsb3N1cmUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjaW50ZWdyaXR5JyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguaW50ZWdyaXR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgKHYpPT4vXihzcml8cGdwLXNpZ25hdHVyZSkkLy50ZXN0KHYpCiAgICAgICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd2YWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNvbnN0IHNvdXJjZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhhbHRlcm5hdGVFbmNsb3N1cmUsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc291cmNlKTsKICAgICAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnYWx0ZXJuYXRlRW5jbG9zdXJlJywgc291cmNlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2FsdGVybmF0ZS1lbmNsb3N1cmUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJpJywgaXNVcmkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2NvbnRlbnRUeXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY2hlY2tQb2RjYXN0VmFsdWUoaXRlbVRhZ05hbWUsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RJbWFnZXMoaXRlbVRhZ05hbWUsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBpZiAoaXRlbVRhZ05hbWUgPT09ICdsaXZlSXRlbScpIHsKICAgICAgICBjb25zdCBjb250ZW50TGlua3MgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmNvbnRlbnRMaW5rKTsKICAgICAgICBmb3IgKGNvbnN0IGNvbnRlbnRMaW5rIG9mIGNvbnRlbnRMaW5rcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoaXRlbVRhZ05hbWUsIGNvbnRlbnRMaW5rLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2NvbnRlbnQtbGluaycpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdocmVmJywgaXNVcmwpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc3Qgc29jaWFsSW50ZXJhY3RzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb2NpYWxJbnRlcmFjdCk7CiAgICBjb25zdCBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UjcG9kY2FzdHNvY2lhbGludGVyYWN0LS0tZGlzY3VzcycpOwogICAgZm9yIChjb25zdCBzb2NpYWxJbnRlcmFjdCBvZiBzb2NpYWxJbnRlcmFjdHMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoaXRlbVRhZ05hbWUsIHNvY2lhbEludGVyYWN0LCBjYWxsYmFja3MsIHNvY2lhbEludGVyYWN0UmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmknLCBpc1VyaSwgc29jaWFsSW50ZXJhY3QuYXR0cy5nZXQoJ3Byb3RvY29sJykgIT09ICdkaXNhYmxlZCcpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3Byb3RvY29sJywgaXNQb2RjYXN0U29jaWFsSW50ZXJhY3RQcm90b2NvbCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnYWNjb3VudElkJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnYWNjb3VudFVybCcsIGlzVXJsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwcmlvcml0eScsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjYWxsYmFja3Mub25Hb29kKHNvY2lhbEludGVyYWN0LCBgRm91bmQgJHtpdGVtVGFnTmFtZX0gPHBvZGNhc3Q6c29jaWFsSW50ZXJhY3Q+LCBuaWNlIWAsIHsKICAgICAgICAgICAgdGFnOiAnc29jaWFsLWludGVyYWN0JywKICAgICAgICAgICAgcmVmZXJlbmNlOiBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgY2hlY2tQb2RjYXN0VGFnVXNhZ2UoaXRlbSwgY2FsbGJhY2tzKTsKfQpjbGFzcyBFbGVtZW50VmFsaWRhdGlvbiB7CiAgICBzdGF0aWMgRU1QVFlfU1RSSU5HX1NFVCA9IG5ldyBTZXQoKTsKICAgIG5vZGU7CiAgICBsZXZlbDsKICAgIGNhbGxiYWNrczsKICAgIG9wdHM7CiAgICByZW1haW5pbmdBdHROYW1lczsKICAgIGNvbnN0cnVjdG9yKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIG9wdHMpewogICAgICAgIHRoaXMubGV2ZWwgPSBsZXZlbDsKICAgICAgICB0aGlzLm5vZGUgPSBub2RlOwogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMub3B0cyA9IG9wdHM7CiAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcyA9IG5vZGUgPyBuZXcgU2V0KG5vZGUuYXR0cy5rZXlzKCkpIDogRWxlbWVudFZhbGlkYXRpb24uRU1QVFlfU1RSSU5HX1NFVDsKICAgIH0KICAgIHN0YXRpYyBmb3JFbGVtZW50KGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHJlZmVyZW5jZSkgewogICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgewogICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBmb3JTaW5nbGVDaGlsZChsZXZlbCwgcGFyZW50LCBjYWxsYmFja3MsIHJlZmVyZW5jZSwgLi4ucW5hbWVzKSB7CiAgICAgICAgY2hlY2tUcnVlKCdxbmFtZXMubGVuZ3RoJywgcW5hbWVzLmxlbmd0aCwgcW5hbWVzLmxlbmd0aCA+IDApOwogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMocGFyZW50LCAuLi5xbmFtZXMpOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAxKSBjYWxsYmFja3Mub25XYXJuaW5nKGVsZW1lbnRzWzFdLCBgTXVsdGlwbGUgJHtsZXZlbH0gPCR7ZWxlbWVudHNbMV0udGFnbmFtZX0+IGVsZW1lbnRzIGFyZSBub3QgYWxsb3dlZGAsIHsKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCBlbGVtZW50LCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgdW5kZWZpbmVkLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgfSk7CiAgICB9CiAgICBjaGVja1ZhbHVlKHRlc3QsIGFkZGl0aW9uYWxUZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdHJpbW1lZFRleHQgPSBjaGVja1RleHQobm9kZSwgdGVzdCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgICAgICAgICAgaWYgKHRyaW1tZWRUZXh0ICYmIGFkZGl0aW9uYWxUZXN0KSB7CiAgICAgICAgICAgICAgICBjb25zdCB3YXJuaW5nU3VmZml4ID0gYWRkaXRpb25hbFRlc3QodHJpbW1lZFRleHQpOwogICAgICAgICAgICAgICAgaWYgKHdhcm5pbmdTdWZmaXgpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgPCR7bm9kZS50YWduYW1lfT4gdmFsdWU6ICR7dHJpbW1lZFRleHQgPT09ICcnID8gJzxlbXB0eT4nIDogdHJpbW1lZFRleHR9LCAke3dhcm5pbmdTdWZmaXh9YCwgb3B0cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjaGVja1JlcXVpcmVkQXR0cmlidXRlKG5hbWUsIHRlc3QsIGlmQ29uZGl0aW9uID0gdHJ1ZSkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKGlmQ29uZGl0aW9uKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgICAgICBpZiAoIXZhbHVlKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlYCwgb3B0cyk7CiAgICAgICAgICAgICAgICBpZiAodmFsdWUgJiYgIXRlc3QodmFsdWUpKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgJHtsZXZlbH0gPCR7bm9kZS50YWduYW1lfT4gJHtuYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7dmFsdWV9YCwgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tPcHRpb25hbEF0dHJpYnV0ZShuYW1lLCB0ZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkgewogICAgICAgIGNvbnN0IHsgcmVtYWluaW5nQXR0TmFtZXMgLCBjYWxsYmFja3MgLCBub2RlICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBpZiAocmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiBhdHRyaWJ1dGUgbmFtZSR7cmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDEgPyAncycgOiAnJ306ICR7WwogICAgICAgICAgICAgICAgICAgIC4uLnJlbWFpbmluZ0F0dE5hbWVzCiAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0KZnVuY3Rpb24gc2V0SW50ZXJzZWN0KGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaHMpewogICAgICAgIGlmIChyaHMuaGFzKGl0ZW0pKSBydC5hZGQoaXRlbSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGl0ZW0xIG9mIHJocyl7CiAgICAgICAgaWYgKGxocy5oYXMoaXRlbTEpKSBydC5hZGQoaXRlbTEpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGlzTm9uRW1wdHkodmFsdWUpIHsKICAgIHJldHVybiB2YWx1ZS50cmltKCkubGVuZ3RoID4gMDsKfQpmdW5jdGlvbiBpc1N0cmluZ1JlY29yZDEob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3Q7Cn0KZnVuY3Rpb24gaXNSZWFkb25seUFycmF5MShhcmcpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyZyk7Cn0KZnVuY3Rpb24gaXNWYWxpZElzbzg2MDEodGV4dCkgewogICAgcmV0dXJuIC9eXGR7NH0tXGR7Mn0tXGR7Mn1UXGR7Mn06XGR7Mn06XGR7Mn0oXC5cZCspP1okLy50ZXN0KHRleHQpOwp9CmZ1bmN0aW9uIGlzTm9uTmVnYXRpdmVJbnRlZ2VyMSh2YWx1ZSkgewogICAgcmV0dXJuIE51bWJlci5pc0ludGVnZXIodmFsdWUpICYmIHZhbHVlID49IDA7Cn0KYXN5bmMgZnVuY3Rpb24gZmluZE9yRmV0Y2hKc29uKHVybCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCBvcHRzKSB7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZpbmRPckZldGNoVGV4dFJlc3BvbnNlKHVybCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCBvcHRzKTsKICAgIGNvbnN0IHsgc3RhdHVzICwgaGVhZGVycyAsIGJvZHlUZXh0ICB9ID0gcmVzcG9uc2U7CiAgICBpZiAoc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgMjAwIHJlc3BvbnNlIGZvciAke3VybH0sIGZvdW5kICR7c3RhdHVzfSBib2R5PSR7Ym9keVRleHR9YCk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IGhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddIHx8ICc8bm9uZT4nOwogICAgaWYgKCFjb250ZW50VHlwZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKCdqc29uJykpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQganNvbiByZXNwb25zZSBmb3IgJHt1cmx9LCBmb3VuZCAke2NvbnRlbnRUeXBlfSBib2R5PSR7Ym9keVRleHR9YCk7CiAgICByZXR1cm4gSlNPTi5wYXJzZShib2R5VGV4dCk7Cn0KYXN5bmMgZnVuY3Rpb24gZmluZE9yRmV0Y2hUZXh0UmVzcG9uc2UodXJsLCBhZnRlciwgZmV0Y2hlciwgY2FjaGUsIG9wdHMpIHsKICAgIGNvbnN0IGV4aXN0aW5nID0gYXdhaXQgY2FjaGUuZ2V0KHVybCwgYWZ0ZXIpOwogICAgaWYgKGV4aXN0aW5nKSByZXR1cm4gZXhpc3Rpbmc7CiAgICBjb25zdCB7IGFjY2VwdCAsIGF1dGhvcml6YXRpb24gIH0gPSBvcHRzOwogICAgY29uc3QgaGVhZGVycyA9IHsKICAgICAgICBhY2NlcHQKICAgIH07CiAgICBpZiAoYXV0aG9yaXphdGlvbikgaGVhZGVycy5hdXRob3JpemF0aW9uID0gYXV0aG9yaXphdGlvbjsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoZXIodXJsLCB7CiAgICAgICAgaGVhZGVycwogICAgfSk7CiAgICBjb25zdCByZXNwb25zZSA9IHsKICAgICAgICBzdGF0dXM6IHJlcy5zdGF0dXMsCiAgICAgICAgaGVhZGVyczogT2JqZWN0LmZyb21FbnRyaWVzKFsKICAgICAgICAgICAgLi4ucmVzLmhlYWRlcnMKICAgICAgICBdKSwKICAgICAgICBib2R5VGV4dDogYXdhaXQgcmVzLnRleHQoKQogICAgfTsKICAgIGF3YWl0IGNhY2hlLnB1dCh1cmwsIG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSwgcmVzcG9uc2UpOwogICAgcmV0dXJuIHJlc3BvbnNlOwp9CmNvbnN0IEFjdGl2aXR5UHViUHJvdG9jb2xJbXBsZW1lbnRhdGlvbiA9IHsKICAgIGluaXRUaHJlYWRjYXA6IGluaXRBY3Rpdml0eVB1YlRocmVhZGNhcCwKICAgIGZldGNoQ29tbWVudDogZmV0Y2hBY3Rpdml0eVB1YkNvbW1lbnQsCiAgICBmZXRjaENvbW1lbnRlcjogZmV0Y2hBY3Rpdml0eVB1YkNvbW1lbnRlciwKICAgIGZldGNoUmVwbGllczogZmV0Y2hBY3Rpdml0eVB1YlJlcGxpZXMKfTsKYXN5bmMgZnVuY3Rpb24gbWFzdG9kb25GaW5kUmVwbGllcyhpZCwgb3B0cykgewogICAgY29uc3QgeyBhZnRlciAsIGZldGNoZXIgLCBjYWNoZSAsIGRlYnVnICB9ID0gb3B0czsKICAgIGNvbnN0IHN0YXR1c0lkID0gYXdhaXQgbWFzdG9kb25GaW5kU3RhdHVzSWRGb3JBY3Rpdml0eVB1YklkKGlkLCBhZnRlciwgZmV0Y2hlciwgY2FjaGUsIGRlYnVnKTsKICAgIGlmICghc3RhdHVzSWQpIHJldHVybiBbXTsKICAgIGNvbnN0IHsgb3JpZ2luICB9ID0gbmV3IFVSTChpZCk7CiAgICBjb25zdCB1cmwgPSBuZXcgVVJMKG9yaWdpbik7CiAgICB1cmwucGF0aG5hbWUgPSBgL2FwaS92MS9zdGF0dXNlcy8ke3N0YXR1c0lkfS9jb250ZXh0YDsKICAgIGNvbnN0IG9iaiA9IGF3YWl0IGZpbmRPckZldGNoSnNvbih1cmwudG9TdHJpbmcoKSwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCB7CiAgICAgICAgYWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicKICAgIH0pOwogICAgaWYgKGRlYnVnKSBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgY29uc3QgcnQgPSBbXTsKICAgIGlmIChpc1N0cmluZ1JlY29yZDEob2JqKSAmJiBBcnJheS5pc0FycmF5KG9iai5kZXNjZW5kYW50cykpIHsKICAgICAgICBmb3IgKGNvbnN0IGRlc2NlbmRhbnQgb2Ygb2JqLmRlc2NlbmRhbnRzKXsKICAgICAgICAgICAgaWYgKGlzU3RyaW5nUmVjb3JkMShkZXNjZW5kYW50KSAmJiB0eXBlb2YgZGVzY2VuZGFudC51cmkgPT09ICdzdHJpbmcnICYmIGRlc2NlbmRhbnQuaW5fcmVwbHlfdG9faWQgPT09IHN0YXR1c0lkKSB7CiAgICAgICAgICAgICAgICBydC5wdXNoKGRlc2NlbmRhbnQudXJpKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydDsKfQphc3luYyBmdW5jdGlvbiBmaW5kT3JGZXRjaEFjdGl2aXR5UHViT2JqZWN0KHVybCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlKSB7CiAgICByZXR1cm4gYXdhaXQgZmluZE9yRmV0Y2hKc29uKHVybCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCB7CiAgICAgICAgYWNjZXB0OiAnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicKICAgIH0pOwp9CmFzeW5jIGZ1bmN0aW9uIGluaXRBY3Rpdml0eVB1YlRocmVhZGNhcCh1cmwsIG9wdHMpIHsKICAgIGNvbnN0IHsgZmV0Y2hlciAsIGNhY2hlICB9ID0gb3B0czsKICAgIGNvbnN0IG9iamVjdCA9IGF3YWl0IGZpbmRPckZldGNoQWN0aXZpdHlQdWJPYmplY3QodXJsLCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIGZldGNoZXIsIGNhY2hlKTsKICAgIGNvbnN0IHsgaWQgLCB0eXBlICB9ID0gb2JqZWN0OwogICAgaWYgKHR5cGVvZiB0eXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGUgZm9yIG9iamVjdDogJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKCEvXihOb3RlfEFydGljbGV8VmlkZW98UG9kY2FzdEVwaXNvZGUpJC8udGVzdCh0eXBlKSkgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR5cGU6ICR7dHlwZX1gKTsKICAgIGlmICh0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaWQgZm9yIG9iamVjdDogJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBwcm90b2NvbDogJ2FjdGl2aXR5cHViJywKICAgICAgICByb290czogWwogICAgICAgICAgICBpZAogICAgICAgIF0sCiAgICAgICAgbm9kZXM6IHt9LAogICAgICAgIGNvbW1lbnRlcnM6IHt9CiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoQWN0aXZpdHlQdWJDb21tZW50KGlkLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoZXIgLCBjYWNoZSAsIHVwZGF0ZVRpbWUgLCBjYWxsYmFja3MgIH0gPSBvcHRzOwogICAgY29uc3Qgb2JqZWN0ID0gYXdhaXQgZmluZE9yRmV0Y2hBY3Rpdml0eVB1Yk9iamVjdChpZCwgdXBkYXRlVGltZSwgZmV0Y2hlciwgY2FjaGUpOwogICAgcmV0dXJuIGNvbXB1dGVDb21tZW50KG9iamVjdCwgaWQsIGNhbGxiYWNrcyk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hBY3Rpdml0eVB1YkNvbW1lbnRlcihhdHRyaWJ1dGVkVG8sIG9wdHMpIHsKICAgIGNvbnN0IHsgZmV0Y2hlciAsIGNhY2hlICwgdXBkYXRlVGltZSAgfSA9IG9wdHM7CiAgICBjb25zdCBvYmplY3QgPSBhd2FpdCBmaW5kT3JGZXRjaEFjdGl2aXR5UHViT2JqZWN0KGF0dHJpYnV0ZWRUbywgdXBkYXRlVGltZSwgZmV0Y2hlciwgY2FjaGUpOwogICAgcmV0dXJuIGNvbXB1dGVDb21tZW50ZXIob2JqZWN0LCB1cGRhdGVUaW1lKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaEFjdGl2aXR5UHViUmVwbGllcyhpZCwgb3B0cykgewogICAgY29uc3QgeyBmZXRjaGVyICwgY2FjaGUgLCB1cGRhdGVUaW1lICwgY2FsbGJhY2tzICwgZGVidWcgIH0gPSBvcHRzOwogICAgY29uc3QgZmV0Y2hlZE9iamVjdCA9IGF3YWl0IGZpbmRPckZldGNoQWN0aXZpdHlQdWJPYmplY3QoaWQsIHVwZGF0ZVRpbWUsIGZldGNoZXIsIGNhY2hlKTsKICAgIGNvbnN0IG9iamVjdCA9IHVud3JhcEFjdGl2aXR5SWZOZWNlc3NhcnkoZmV0Y2hlZE9iamVjdCwgaWQsIGNhbGxiYWNrcyk7CiAgICBjb25zdCByZXBsaWVzID0gb2JqZWN0LnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScgPyBvYmplY3QuY29tbWVudHMgOiBvYmplY3QucmVwbGllczsKICAgIGlmIChyZXBsaWVzID09PSB1bmRlZmluZWQpIHsKICAgICAgICBsZXQgbWVzc2FnZSA9IG9iamVjdC50eXBlID09PSAnUG9kY2FzdEVwaXNvZGUnID8gYE5vICdjb21tZW50cycgZm91bmQgb24gUG9kY2FzdEVwaXNvZGUgb2JqZWN0YCA6IGBObyAncmVwbGllcycgZm91bmQgb24gb2JqZWN0YDsKICAgICAgICBjb25zdCB0cnlQbGVyb21hV29ya2Fyb3VuZCA9IGlkLmluY2x1ZGVzKCcvb2JqZWN0cy8nKTsKICAgICAgICBpZiAodHJ5UGxlcm9tYVdvcmthcm91bmQpIHsKICAgICAgICAgICAgbWVzc2FnZSArPSAnLCB0cnlpbmcgUGxlcm9tYSB3b3JrYXJvdW5kJzsKICAgICAgICB9CiAgICAgICAgY2FsbGJhY2tzPy5vbkV2ZW50KHsKICAgICAgICAgICAga2luZDogJ3dhcm5pbmcnLAogICAgICAgICAgICB1cmw6IGlkLAogICAgICAgICAgICBub2RlSWQ6IGlkLAogICAgICAgICAgICBtZXNzYWdlLAogICAgICAgICAgICBvYmplY3QKICAgICAgICB9KTsKICAgICAgICBpZiAodHJ5UGxlcm9tYVdvcmthcm91bmQpIHsKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IG1hc3RvZG9uRmluZFJlcGxpZXMoaWQsIHsKICAgICAgICAgICAgICAgIGFmdGVyOiB1cGRhdGVUaW1lLAogICAgICAgICAgICAgICAgZmV0Y2hlciwKICAgICAgICAgICAgICAgIGNhY2hlLAogICAgICAgICAgICAgICAgZGVidWcKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBbXTsKICAgIH0KICAgIGNvbnN0IHJ0ID0gW107CiAgICBjb25zdCBmZXRjaGVkID0gbmV3IFNldCgpOwogICAgaWYgKHR5cGVvZiByZXBsaWVzID09PSAnc3RyaW5nJykgewogICAgICAgIGNvbnN0IG9iaiA9IGF3YWl0IGZpbmRPckZldGNoQWN0aXZpdHlQdWJPYmplY3QocmVwbGllcywgdXBkYXRlVGltZSwgZmV0Y2hlciwgY2FjaGUpOwogICAgICAgIGlmIChvYmoudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uJykgewogICAgICAgICAgICByZXR1cm4gYXdhaXQgY29sbGVjdFJlcGxpZXNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob2JqLCB1cGRhdGVUaW1lLCBpZCwgZmV0Y2hlciwgY2FjaGUsIGNhbGxiYWNrcywgZmV0Y2hlZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAncmVwbGllcycgdG8gcG9pbnQgdG8gYW4gT3JkZXJlZENvbGxlY3Rpb24sIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHJlcGxpZXMuZmlyc3QpIHsKICAgICAgICBpZiAodHlwZW9mIHJlcGxpZXMuZmlyc3QgPT09ICdvYmplY3QnICYmIHJlcGxpZXMuZmlyc3QudHlwZSA9PT0gJ0NvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICBpZiAoIXJlcGxpZXMuZmlyc3QuaXRlbXMgJiYgIXJlcGxpZXMuZmlyc3QubmV4dCkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAncmVwbGllcy5maXJzdC5pdGVtcycgb3IgJ3JlcGxpZXMuZmlyc3QubmV4dCcgdG8gYmUgcHJlc2VudCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShyZXBsaWVzLmZpcnN0KX1gKTsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkocmVwbGllcy5maXJzdC5pdGVtcykgJiYgcmVwbGllcy5maXJzdC5pdGVtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBjb2xsZWN0UmVwbGllc0Zyb21JdGVtcyhyZXBsaWVzLmZpcnN0Lml0ZW1zLCBydCwgaWQsIGlkLCBjYWxsYmFja3MpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChyZXBsaWVzLmZpcnN0Lm5leHQpIHsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcmVwbGllcy5maXJzdC5uZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHJ0LnB1c2goLi4uYXdhaXQgY29sbGVjdFJlcGxpZXNGcm9tUGFnZXMocmVwbGllcy5maXJzdC5uZXh0LCB1cGRhdGVUaW1lLCBpZCwgZmV0Y2hlciwgY2FjaGUsIGNhbGxiYWNrcywgZmV0Y2hlZCkpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkICdyZXBsaWVzLmZpcnN0Lm5leHQnIHRvIGJlIGEgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHJlcGxpZXMuZmlyc3QubmV4dCl9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHJ0OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgJ3JlcGxpZXMuZmlyc3QuaXRlbXMnIGFycmF5LCBvciAncmVwbGllcy5maXJzdC5uZXh0JyBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocmVwbGllcy5maXJzdCl9YCk7CiAgICAgICAgfQogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlcGxpZXMpKSB7CiAgICAgICAgaWYgKHJlcGxpZXMubGVuZ3RoID4gMCkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAncmVwbGllcycgYXJyYXkgdG8gYmUgZW1wdHksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocmVwbGllcyl9YCk7CiAgICAgICAgcmV0dXJuIFtdOwogICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHJlcGxpZXMuaXRlbXMpKSB7CiAgICAgICAgY29sbGVjdFJlcGxpZXNGcm9tSXRlbXMocmVwbGllcy5pdGVtcywgcnQsIGlkLCBpZCwgY2FsbGJhY2tzKTsKICAgICAgICByZXR1cm4gcnQ7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgJ3JlcGxpZXMnIHRvIGJlIGEgc3RyaW5nLCBhcnJheSBvciBvYmplY3Qgd2l0aCAnZmlyc3QnIG9yICdpdGVtcycsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocmVwbGllcyl9YCk7CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdFJlcGxpZXNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGFmdGVyLCBub2RlSWQsIGZldGNoZXIsIGNhY2hlLCBjYWxsYmFja3MsIGZldGNoZWQpIHsKICAgIGlmICgob3JkZXJlZENvbGxlY3Rpb24uaXRlbXM/Lmxlbmd0aCB8fCAwKSA+IDAgfHwgKG9yZGVyZWRDb2xsZWN0aW9uLm9yZGVyZWRJdGVtcz8ubGVuZ3RoIHx8IDApID4gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgT3JkZXJlZENvbGxlY3Rpb24gJ2l0ZW1zJy8nb3JkZXJlZEl0ZW1zJyB0byBiZSBlbXB0eSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShvcmRlcmVkQ29sbGVjdGlvbil9YCk7CiAgICB9CiAgICBpZiAob3JkZXJlZENvbGxlY3Rpb24uZmlyc3QgPT09IHVuZGVmaW5lZCAmJiBvcmRlcmVkQ29sbGVjdGlvbi50b3RhbEl0ZW1zID09PSAwKSB7CiAgICAgICAgcmV0dXJuIFtdOwogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3JkZXJlZENvbGxlY3Rpb24uZmlyc3QgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgcmV0dXJuIGF3YWl0IGNvbGxlY3RSZXBsaWVzRnJvbVBhZ2VzKG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0LCBhZnRlciwgbm9kZUlkLCBmZXRjaGVyLCBjYWNoZSwgY2FsbGJhY2tzLCBmZXRjaGVkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBPcmRlcmVkQ29sbGVjdGlvbiAnZmlyc3QnIHRvIGJlIGEgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9yZGVyZWRDb2xsZWN0aW9uKX1gKTsKICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0UmVwbGllc0Zyb21QYWdlcyh1cmwsIGFmdGVyLCBub2RlSWQsIGZldGNoZXIsIGNhY2hlLCBjYWxsYmFja3MsIGZldGNoZWQpIHsKICAgIGNvbnN0IHJlcGxpZXMgPSBbXTsKICAgIGxldCBwYWdlID0gYXdhaXQgZmluZE9yRmV0Y2hBY3Rpdml0eVB1Yk9iamVjdCh1cmwsIGFmdGVyLCBmZXRjaGVyLCBjYWNoZSk7CiAgICB3aGlsZSh0cnVlKXsKICAgICAgICBpZiAocGFnZS50eXBlICE9PSAnQ29sbGVjdGlvblBhZ2UnICYmIHBhZ2UudHlwZSAhPT0gJ09yZGVyZWRDb2xsZWN0aW9uUGFnZScpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwYWdlICd0eXBlJyBvZiBDb2xsZWN0aW9uUGFnZSBvciBPcmRlcmVkQ29sbGVjdGlvblBhZ2UsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocGFnZSl9YCk7CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlLml0ZW1zKSB7CiAgICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShwYWdlLml0ZW1zKSkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwYWdlICdpdGVtcycgdG8gYmUgYW4gYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocGFnZSl9YCk7CiAgICAgICAgICAgIGNvbGxlY3RSZXBsaWVzRnJvbUl0ZW1zKHBhZ2UuaXRlbXMsIHJlcGxpZXMsIG5vZGVJZCwgdXJsLCBjYWxsYmFja3MpOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZS50eXBlID09PSAnT3JkZXJlZENvbGxlY3Rpb25QYWdlJyAmJiBwYWdlLm9yZGVyZWRJdGVtcykgewogICAgICAgICAgICBpZiAoIUFycmF5LmlzQXJyYXkocGFnZS5vcmRlcmVkSXRlbXMpKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBhZ2UgJ29yZGVyZWRJdGVtcycgdG8gYmUgYW4gYXJyYXksIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocGFnZSl9YCk7CiAgICAgICAgICAgIGNvbGxlY3RSZXBsaWVzRnJvbUl0ZW1zKHBhZ2Uub3JkZXJlZEl0ZW1zLCByZXBsaWVzLCBub2RlSWQsIHVybCwgY2FsbGJhY2tzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHBhZ2UubmV4dCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHBhZ2UubmV4dCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcGFnZSAnbmV4dCcgdG8gYmUgYSBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkocGFnZSl9YCk7CiAgICAgICAgICAgIGlmIChmZXRjaGVkLmhhcyhwYWdlLm5leHQpKSByZXR1cm4gcmVwbGllczsKICAgICAgICAgICAgcGFnZSA9IGF3YWl0IGZpbmRPckZldGNoQWN0aXZpdHlQdWJPYmplY3QocGFnZS5uZXh0LCBhZnRlciwgZmV0Y2hlciwgY2FjaGUpOwogICAgICAgICAgICBmZXRjaGVkLmFkZChwYWdlLm5leHQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiByZXBsaWVzOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiB1bndyYXBBY3Rpdml0eUlmTmVjZXNzYXJ5KG9iamVjdCwgaWQsIGNhbGxiYWNrcykgewogICAgaWYgKG9iamVjdC50eXBlID09PSAnQ3JlYXRlJyAmJiBpc1N0cmluZ1JlY29yZDEob2JqZWN0Lm9iamVjdCkpIHsKICAgICAgICBjYWxsYmFja3M/Lm9uRXZlbnQoewogICAgICAgICAgICBraW5kOiAnd2FybmluZycsCiAgICAgICAgICAgIHVybDogaWQsCiAgICAgICAgICAgIG5vZGVJZDogaWQsCiAgICAgICAgICAgIG1lc3NhZ2U6ICdVbndyYXBwaW5nIGEgQ3JlYXRlIGFjdGl2aXR5IHdoZXJlIGFuIG9iamVjdCB3YXMgZXhwZWN0ZWQnLAogICAgICAgICAgICBvYmplY3QKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gb2JqZWN0Lm9iamVjdDsKICAgIH0KICAgIHJldHVybiBvYmplY3Q7Cn0KZnVuY3Rpb24gY29sbGVjdFJlcGxpZXNGcm9tSXRlbXMoaXRlbXMsIG91dFJlcGxpZXMsIG5vZGVJZCwgdXJsLCBjYWxsYmFja3MpIHsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcyl7CiAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJyAmJiAhaXRlbS5zdGFydHNXaXRoKCd7JykpIHsKICAgICAgICAgICAgb3V0UmVwbGllcy5wdXNoKGl0ZW0pOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW1PYmogPSB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKGl0ZW0pIDogaXRlbTsKICAgICAgICAgICAgY29uc3QgeyBpZCAgfSA9IGl0ZW1PYmo7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGl0ZW0gJ2lkJyB0byBiZSBhIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShpdGVtT2JqKX1gKTsKICAgICAgICAgICAgb3V0UmVwbGllcy5wdXNoKGlkKTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzPy5vbkV2ZW50KHsKICAgICAgICAgICAgICAgICAgICBraW5kOiAnd2FybmluZycsCiAgICAgICAgICAgICAgICAgICAgbm9kZUlkLAogICAgICAgICAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgICAgICAgICBtZXNzYWdlOiAnRm91bmQgaXRlbSBpbmNvcnJlY3RseSBkb3VibGUgZW5jb2RlZCBhcyBhIGpzb24gc3RyaW5nJywKICAgICAgICAgICAgICAgICAgICBvYmplY3Q6IGl0ZW1PYmoKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVDb21tZW50KG9iamVjdCwgaWQsIGNhbGxiYWNrcykgewogICAgb2JqZWN0ID0gdW53cmFwQWN0aXZpdHlJZk5lY2Vzc2FyeShvYmplY3QsIGlkLCBjYWxsYmFja3MpOwogICAgY29uc3QgY29udGVudCA9IGNvbXB1dGVDb250ZW50KG9iamVjdCk7CiAgICBjb25zdCBhdHRhY2htZW50cyA9IGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpOwogICAgY29uc3QgdXJsID0gY29tcHV0ZVVybChvYmplY3QudXJsKSB8fCBpZDsKICAgIGNvbnN0IHsgcHVibGlzaGVkICB9ID0gb2JqZWN0OwogICAgY29uc3QgYXR0cmlidXRlZFRvID0gY29tcHV0ZUF0dHJpYnV0ZWRUbyhvYmplY3QuYXR0cmlidXRlZFRvKTsKICAgIGlmICh0eXBlb2YgcHVibGlzaGVkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAncHVibGlzaGVkJyB0byBiZSBhIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShwdWJsaXNoZWQpfWApOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgcHVibGlzaGVkLAogICAgICAgIGF0dGFjaG1lbnRzLAogICAgICAgIGNvbnRlbnQsCiAgICAgICAgYXR0cmlidXRlZFRvCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVVcmwodXJsKSB7CiAgICBpZiAodXJsID09PSB1bmRlZmluZWQgfHwgdXJsID09PSBudWxsKSByZXR1cm4gdW5kZWZpbmVkOwogICAgaWYgKHR5cGVvZiB1cmwgPT09ICdzdHJpbmcnKSByZXR1cm4gdXJsOwogICAgaWYgKEFycmF5LmlzQXJyYXkodXJsKSkgewogICAgICAgIGNvbnN0IHYxID0gdXJsLmZpbmQoKHYpPT52LnR5cGUgPT09ICdMaW5rJyAmJiB2Lm1lZGlhVHlwZSA9PT0gJ3RleHQvaHRtbCcgJiYgdHlwZW9mIHYuaHJlZiA9PT0gJ3N0cmluZycKICAgICAgICApOwogICAgICAgIGlmICh2MSkgcmV0dXJuIHYxLmhyZWY7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkICd1cmwnIHRvIGJlIGEgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZWRUbyhhdHRyaWJ1dGVkVG8pIHsKICAgIGlmICh0eXBlb2YgYXR0cmlidXRlZFRvID09PSAnc3RyaW5nJykgcmV0dXJuIGF0dHJpYnV0ZWRUbzsKICAgIGlmIChBcnJheS5pc0FycmF5KGF0dHJpYnV0ZWRUbykgJiYgYXR0cmlidXRlZFRvLmxlbmd0aCA+IDApIHsKICAgICAgICBpZiAoYXR0cmlidXRlZFRvLmV2ZXJ5KCh2KT0+dHlwZW9mIHYgPT09ICdzdHJpbmcnCiAgICAgICAgKSkgcmV0dXJuIGF0dHJpYnV0ZWRUb1swXTsKICAgICAgICBpZiAoYXR0cmlidXRlZFRvLmV2ZXJ5KCh2KT0+aXNTdHJpbmdSZWNvcmQxKHYpCiAgICAgICAgKSkgewogICAgICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgYXR0cmlidXRlZFRvKXsKICAgICAgICAgICAgICAgIGlmIChpdGVtLnR5cGUgPT09ICdQZXJzb24nICYmIHR5cGVvZiBpdGVtLmlkID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBpdGVtLmlkOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgJ2F0dHJpYnV0ZWRUbycgb2JqZWN0IGFycmF5IHRvIGhhdmUgYSBQZXJzb24gd2l0aCBhbiAnaWQnLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KGF0dHJpYnV0ZWRUbyl9YCk7CiAgICAgICAgfQogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAnYXR0cmlidXRlZFRvJyB0byBiZSBhIHN0cmluZyBvciBub24tZW1wdHkgc3RyaW5nL29iamVjdCBhcnJheSwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShhdHRyaWJ1dGVkVG8pfWApOwp9CmZ1bmN0aW9uIGNvbXB1dGVDb250ZW50KG9iaikgewogICAgaWYgKG9iai50eXBlID09PSAnUG9kY2FzdEVwaXNvZGUnICYmIGlzU3RyaW5nUmVjb3JkMShvYmouZGVzY3JpcHRpb24pICYmIG9iai5kZXNjcmlwdGlvbi50eXBlID09PSAnTm90ZScpIG9iaiA9IG9iai5kZXNjcmlwdGlvbjsKICAgIGNvbnN0IHsgY29udGVudCAsIGNvbnRlbnRNYXAgIH0gPSBvYmo7CiAgICBpZiAoY29udGVudCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBjb250ZW50ICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCAnY29udGVudCcgdG8gYmUgYSBzdHJpbmcsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoY29udGVudCl9YCk7CiAgICBpZiAoY29udGVudE1hcCAhPT0gdW5kZWZpbmVkICYmICFpc1N0cmluZ1JlY29yZDEoY29udGVudE1hcCkpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgJ2NvbnRlbnRNYXAnIHRvIGJlIGEgc3RyaW5nIHJlY29yZCwgZm91bmQgJHtKU09OLnN0cmluZ2lmeShjb250ZW50TWFwKX1gKTsKICAgIGlmIChjb250ZW50TWFwICE9PSB1bmRlZmluZWQpIHJldHVybiBjb250ZW50TWFwOwogICAgaWYgKGNvbnRlbnQgIT09IHVuZGVmaW5lZCkgcmV0dXJuIHsKICAgICAgICB1bmQ6IGNvbnRlbnQKICAgIH07CiAgICB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGVpdGhlciAnY29udGVudE1hcCcgb3IgJ2NvbnRlbnQnIHRvIGJlIHByZXNlbnQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpIHsKICAgIGNvbnN0IHJ0ID0gW107CiAgICBpZiAoIW9iamVjdC5hdHRhY2htZW50KSByZXR1cm4gcnQ7CiAgICBjb25zdCBhdHRhY2htZW50cyA9IGlzUmVhZG9ubHlBcnJheTEob2JqZWN0LmF0dGFjaG1lbnQpID8gb2JqZWN0LmF0dGFjaG1lbnQgOiBbCiAgICAgICAgb2JqZWN0LmF0dGFjaG1lbnQKICAgIF07CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgYXR0YWNobWVudHMpewogICAgICAgIHJ0LnB1c2goY29tcHV0ZUF0dGFjaG1lbnQoYXR0YWNobWVudCkpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50KG9iamVjdCkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdC50eXBlICE9PSAnRG9jdW1lbnQnICYmIG9iamVjdC50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGF0dGFjaG1lbnQgJ3R5cGUnIG9mIERvY3VtZW50IG9yIEltYWdlLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdC50eXBlKX1gKTsKICAgIGNvbnN0IHsgbWVkaWFUeXBlICwgd2lkdGggLCBoZWlnaHQgLCB1cmwgIH0gPSBvYmplY3Q7CiAgICBpZiAodHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgYXR0YWNobWVudCAnbWVkaWFUeXBlJyB0byBiZSBhIHN0cmluZywgZm91bmQgJHtKU09OLnN0cmluZ2lmeShtZWRpYVR5cGUpfWApOwogICAgaWYgKHdpZHRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHdpZHRoICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBhdHRhY2htZW50ICd3aWR0aCcgdG8gYmUgYSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkod2lkdGgpfWApOwogICAgaWYgKGhlaWdodCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBoZWlnaHQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGF0dGFjaG1lbnQgJ2hlaWdodCcgdG8gYmUgYSBudW1iZXIsIGZvdW5kICR7SlNPTi5zdHJpbmdpZnkoaGVpZ2h0KX1gKTsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBhdHRhY2htZW50ICd1cmwnIHRvIGJlIGEgc3RyaW5nLCBmb3VuZCAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICByZXR1cm4gewogICAgICAgIG1lZGlhVHlwZSwKICAgICAgICB3aWR0aCwKICAgICAgICBoZWlnaHQsCiAgICAgICAgdXJsCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVDb21tZW50ZXIocGVyc29uLCBhc29mKSB7CiAgICBsZXQgaWNvbjE7CiAgICBpZiAocGVyc29uLmljb24pIHsKICAgICAgICBpZiAodHlwZW9mIHBlcnNvbi5pY29uICE9PSAnb2JqZWN0JyB8fCBpc1JlYWRvbmx5QXJyYXkxKHBlcnNvbi5pY29uKSB8fCBwZXJzb24uaWNvbi50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBlcnNvbiAnaWNvbicgdG8gYmUgYW4gb2JqZWN0LCBmb3VuZDogJHtKU09OLnN0cmluZ2lmeShwZXJzb24uaWNvbil9YCk7CiAgICAgICAgaWNvbjEgPSBjb21wdXRlSWNvbihwZXJzb24uaWNvbik7CiAgICB9CiAgICBjb25zdCB7IG5hbWUgLCBwcmVmZXJyZWRVc2VybmFtZSAsIHVybDogYXBVcmwgLCBpZCAgfSA9IHBlcnNvbjsKICAgIGlmIChuYW1lICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBlcnNvbiAnbmFtZScgdG8gYmUgYSBzdHJpbmcsIGZvdW5kOiAke0pTT04uc3RyaW5naWZ5KHBlcnNvbil9YCk7CiAgICBpZiAocHJlZmVycmVkVXNlcm5hbWUgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgcHJlZmVycmVkVXNlcm5hbWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBlcnNvbiAncHJlZmVycmVkVXNlcm5hbWUnIHRvIGJlIGEgc3RyaW5nLCBmb3VuZDogJHtKU09OLnN0cmluZ2lmeShwZXJzb24pfWApOwogICAgY29uc3QgbmFtZU9yUHJlZmVycmVkVXNlcm5hbWUgPSBuYW1lIHx8IHByZWZlcnJlZFVzZXJuYW1lOwogICAgaWYgKCFuYW1lT3JQcmVmZXJyZWRVc2VybmFtZSkgdGhyb3cgbmV3IEVycm9yKGBFeHBlY3RlZCBwZXJzb24gJ25hbWUnIG9yICdwcmVmZXJyZWRVc2VybmFtZScsIGZvdW5kOiAke0pTT04uc3RyaW5naWZ5KHBlcnNvbil9YCk7CiAgICBpZiAoYXBVcmwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXBVcmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIHBlcnNvbiAndXJsJyB0byBiZSBhIHN0cmluZywgZm91bmQ6ICR7SlNPTi5zdHJpbmdpZnkoYXBVcmwpfWApOwogICAgY29uc3QgdXJsID0gYXBVcmwgfHwgaWQ7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgcGVyc29uICd1cmwnIG9yICdpZCcgdG8gYmUgYSBzdHJpbmcsIGZvdW5kOiAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBjb25zdCBmcVVzZXJuYW1lID0gY29tcHV0ZUZxVXNlcm5hbWUodXJsLCBwZXJzb24ucHJlZmVycmVkVXNlcm5hbWUpOwogICAgcmV0dXJuIHsKICAgICAgICBpY29uOiBpY29uMSwKICAgICAgICBuYW1lOiBuYW1lT3JQcmVmZXJyZWRVc2VybmFtZSwKICAgICAgICB1cmwsCiAgICAgICAgZnFVc2VybmFtZSwKICAgICAgICBhc29mCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGltYWdlKSB7CiAgICBjb25zdCB7IHVybCAsIG1lZGlhVHlwZSAgfSA9IGltYWdlOwogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIGljb24gJ3VybCcgdG8gYmUgYSBzdHJpbmcsIGZvdW5kOiAke0pTT04uc3RyaW5naWZ5KHVybCl9YCk7CiAgICBpZiAobWVkaWFUeXBlICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgRXhwZWN0ZWQgaWNvbiAnbWVkaWFUeXBlJyB0byBiZSBhIHN0cmluZywgZm91bmQ6ICR7SlNPTi5zdHJpbmdpZnkobWVkaWFUeXBlKX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1lZGlhVHlwZQogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlRnFVc2VybmFtZSh1cmwsIHByZWZlcnJlZFVzZXJuYW1lKSB7CiAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwpOwogICAgY29uc3QgbSA9IC9eXC8oQFteXC9dKykkLy5leGVjKHUucGF0aG5hbWUpOwogICAgY29uc3QgdXNlcm5hbWUgPSBtID8gbVsxXSA6IHByZWZlcnJlZFVzZXJuYW1lOwogICAgaWYgKCF1c2VybmFtZSkgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gY29tcHV0ZSB1c2VybmFtZSBmcm9tIHVybDogJHt1cmx9YCk7CiAgICByZXR1cm4gYCR7dXNlcm5hbWV9QCR7dS5ob3N0bmFtZX1gOwp9CmFzeW5jIGZ1bmN0aW9uIG1hc3RvZG9uRmluZFN0YXR1c0lkRm9yQWN0aXZpdHlQdWJJZChpZCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCBkZWJ1ZykgewogICAgY29uc3QgeyBvcmlnaW4gIH0gPSBuZXcgVVJMKGlkKTsKICAgIGNvbnN0IHVybCA9IG5ldyBVUkwob3JpZ2luKTsKICAgIHVybC5wYXRobmFtZSA9ICcvYXBpL3YyL3NlYXJjaCc7CiAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgncScsIGlkKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCd0eXBlJywgJ3N0YXR1c2VzJyk7CiAgICBjb25zdCBvYmogPSBhd2FpdCBmaW5kT3JGZXRjaEpzb24odXJsLnRvU3RyaW5nKCksIGFmdGVyLCBmZXRjaGVyLCBjYWNoZSwgewogICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICB9KTsKICAgIGlmIChkZWJ1ZykgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgIGlmIChpc1N0cmluZ1JlY29yZDEob2JqKSAmJiBBcnJheS5pc0FycmF5KG9iai5zdGF0dXNlcykgJiYgb2JqLnN0YXR1c2VzLmxlbmd0aCA9PT0gMSkgewogICAgICAgIGNvbnN0IHN0YXR1cyA9IG9iai5zdGF0dXNlc1swXTsKICAgICAgICBpZiAoaXNTdHJpbmdSZWNvcmQxKHN0YXR1cykgJiYgdHlwZW9mIHN0YXR1cy5pZCA9PT0gJ3N0cmluZycgJiYgc3RhdHVzLmlkICE9PSAnJykgewogICAgICAgICAgICByZXR1cm4gc3RhdHVzLmlkOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KY29uc3QgTGlnaHRuaW5nQ29tbWVudHNQcm90b2NvbEltcGxlbWVudGF0aW9uID0gewogICAgYXN5bmMgaW5pdFRocmVhZGNhcCAodXJsLCBvcHRzKSB7CiAgICAgICAgY29uc3QgeyBmZXRjaGVyICwgY2FjaGUgIH0gPSBvcHRzOwogICAgICAgIGNvbnN0IHRpbWUgPSBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCk7CiAgICAgICAgY29uc3QgY29tbWVudHMgPSBhd2FpdCBmaW5kT3JGZXRjaExpZ2h0bmluZ0NvbW1lbnRzKHVybCwgdGltZSwgZmV0Y2hlciwgY2FjaGUpOwogICAgICAgIGNvbnN0IHJvb3RzID0gY29tbWVudHMuZmlsdGVyKCh2KT0+di5kZXB0aCA9PT0gMAogICAgICAgICkubWFwKCh2KT0+Y29tcHV0ZVVybFdpdGhIYXNoKHVybCwgYGNvbW1lbnQtJHt2LmlkfWApCiAgICAgICAgKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcm90b2NvbDogJ2xpZ2h0bmluZycsCiAgICAgICAgICAgIHJvb3RzLAogICAgICAgICAgICBub2Rlczoge30sCiAgICAgICAgICAgIGNvbW1lbnRlcnM6IHt9CiAgICAgICAgfTsKICAgIH0sCiAgICBhc3luYyBmZXRjaENvbW1lbnQgKGlkLCBvcHRzKSB7CiAgICAgICAgY29uc3QgeyBmZXRjaGVyICwgY2FjaGUgLCB1cGRhdGVUaW1lICB9ID0gb3B0czsKICAgICAgICBjb25zdCBtID0gL14jY29tbWVudC0oLio/KSQvLmV4ZWMobmV3IFVSTChpZCkuaGFzaCk7CiAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgY29uc3QgW18sIGNvbW1lbnRJZF0gPSBtOwogICAgICAgICAgICBjb25zdCBjb21tZW50cyA9IGF3YWl0IGZpbmRPckZldGNoTGlnaHRuaW5nQ29tbWVudHMoY29tcHV0ZVVybFdpdGhIYXNoKGlkLCAnJyksIHVwZGF0ZVRpbWUsIGZldGNoZXIsIGNhY2hlKTsKICAgICAgICAgICAgY29uc3QgY29tbWVudCA9IGNvbW1lbnRzLmZpbmQoKHYpPT52LmlkID09PSBjb21tZW50SWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFjb21tZW50KSB0aHJvdyBuZXcgRXJyb3IoYENvbW1lbnQgbm90IGZvdW5kOiAke2NvbW1lbnRJZH1gKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGF0dGFjaG1lbnRzOiBbXSwKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZWRUbzogY29tcHV0ZVVybFdpdGhIYXNoKGlkLCBgY29tbWVudGVyLSR7Y29tcHV0ZUNvbW1lbnRlcklkKGNvbW1lbnQuc2VuZGVyKX1gKSwKICAgICAgICAgICAgICAgIGNvbnRlbnQ6IHsKICAgICAgICAgICAgICAgICAgICB1bmQ6IGNvbW1lbnQubWVzc2FnZQogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIHB1Ymxpc2hlZDogY29tbWVudC5jcmVhdGVkCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIHRocm93IG5ldyBFcnJvcihgZmV0Y2hDb21tZW50OiB1bmV4cGVjdGVkIGlkPSR7aWR9YCk7CiAgICB9LAogICAgYXN5bmMgZmV0Y2hDb21tZW50ZXIgKGF0dHJpYnV0ZWRUbywgb3B0cykgewogICAgICAgIGNvbnN0IHsgZmV0Y2hlciAsIGNhY2hlICwgdXBkYXRlVGltZSAgfSA9IG9wdHM7CiAgICAgICAgY29uc3QgbSA9IC9eI2NvbW1lbnRlci0oLio/KSQvLmV4ZWMobmV3IFVSTChhdHRyaWJ1dGVkVG8pLmhhc2gpOwogICAgICAgIGlmIChtKSB7CiAgICAgICAgICAgIGNvbnN0IFtfLCBjb21tZW50ZXJJZF0gPSBtOwogICAgICAgICAgICBjb25zdCBjb21tZW50cyA9IGF3YWl0IGZpbmRPckZldGNoTGlnaHRuaW5nQ29tbWVudHMoY29tcHV0ZVVybFdpdGhIYXNoKGF0dHJpYnV0ZWRUbywgJycpLCB1cGRhdGVUaW1lLCBmZXRjaGVyLCBjYWNoZSk7CiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRlciA9IGNvbW1lbnRzLm1hcCgodik9PnYuc2VuZGVyCiAgICAgICAgICAgICkuZmluZCgodik9PmNvbXB1dGVDb21tZW50ZXJJZCh2KSA9PT0gY29tbWVudGVySWQKICAgICAgICAgICAgKTsKICAgICAgICAgICAgaWYgKCFjb21tZW50ZXIpIHRocm93IG5ldyBFcnJvcihgQ29tbWVudGVyIG5vdCBmb3VuZDogJHtjb21tZW50ZXJJZH1gKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGFzb2Y6IHVwZGF0ZVRpbWUsCiAgICAgICAgICAgICAgICBuYW1lOiBgJHtjb21tZW50ZXIubmFtZX0gZnJvbSAke2NvbW1lbnRlci5hcHB9YAogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGZldGNoQ29tbWVudGVyOiB1bmV4cGVjdGVkIGF0dHJpYnV0ZWRUbz0ke2F0dHJpYnV0ZWRUb31gKTsKICAgIH0sCiAgICBhc3luYyBmZXRjaFJlcGxpZXMgKGlkLCBvcHRzKSB7CiAgICAgICAgY29uc3QgeyBmZXRjaGVyICwgY2FjaGUgLCB1cGRhdGVUaW1lICB9ID0gb3B0czsKICAgICAgICBjb25zdCBtID0gL14jY29tbWVudC0oLio/KSQvLmV4ZWMobmV3IFVSTChpZCkuaGFzaCk7CiAgICAgICAgaWYgKG0pIHsKICAgICAgICAgICAgY29uc3QgW18sIGNvbW1lbnRJZF0gPSBtOwogICAgICAgICAgICBjb25zdCB1cmwgPSBjb21wdXRlVXJsV2l0aEhhc2goaWQsICcnKTsKICAgICAgICAgICAgY29uc3QgY29tbWVudHMgPSBhd2FpdCBmaW5kT3JGZXRjaExpZ2h0bmluZ0NvbW1lbnRzKHVybCwgdXBkYXRlVGltZSwgZmV0Y2hlciwgY2FjaGUpOwogICAgICAgICAgICBjb25zdCBjb21tZW50ID0gY29tbWVudHMuZmluZCgodik9PnYuaWQgPT09IGNvbW1lbnRJZAogICAgICAgICAgICApOwogICAgICAgICAgICBpZiAoIWNvbW1lbnQpIHRocm93IG5ldyBFcnJvcihgQ29tbWVudCBub3QgZm91bmQ6ICR7Y29tbWVudElkfWApOwogICAgICAgICAgICByZXR1cm4gY29tbWVudC5jaGlsZHJlbi5tYXAoKHYpPT5jb21wdXRlVXJsV2l0aEhhc2godXJsLCBgY29tbWVudC0ke3Z9YCkKICAgICAgICAgICAgKTsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBmZXRjaFJlcGxpZXM6IHVuZXhwZWN0ZWQgaWQ9JHtpZH1gKTsKICAgIH0KfTsKYXN5bmMgZnVuY3Rpb24gZmluZE9yRmV0Y2hMaWdodG5pbmdDb21tZW50cyh1cmwsIGFmdGVyLCBmZXRjaGVyLCBjYWNoZSkgewogICAgY29uc3Qgb2JqID0gYXdhaXQgZmluZE9yRmV0Y2hKc29uKHVybCwgYWZ0ZXIsIGZldGNoZXIsIGNhY2hlLCB7CiAgICAgICAgYWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicKICAgIH0pOwogICAgaWYgKCFpc1N0cmluZ1JlY29yZDEob2JqKSB8fCAhaXNTdHJpbmdSZWNvcmQxKG9iai5kYXRhKSB8fCAhQXJyYXkuaXNBcnJheShvYmouZGF0YS5jb21tZW50cykpIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGZpbmQgb2JqLmRhdGEuY29tbWVudHMgYXJyYXk6ICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgIHJldHVybiBvYmouZGF0YS5jb21tZW50cy5tYXAoKHYsIGkpPT57CiAgICAgICAgaWYgKCFpc1ZhbGlkTGlnaHRuaW5nQ29tbWVudCh2KSkgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGxpZ2h0bmluZyBjb21tZW50IGF0IGluZGV4ICR7aX06ICR7SlNPTi5zdHJpbmdpZnkodil9YCk7CiAgICAgICAgcmV0dXJuIHY7CiAgICB9KTsKfQpmdW5jdGlvbiBjb21wdXRlVXJsV2l0aEhhc2godXJsLCBoYXNoKSB7CiAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwpOwogICAgdS5oYXNoID0gaGFzaDsKICAgIHJldHVybiB1LnRvU3RyaW5nKCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcklkKHNlbmRlcikgewogICAgcmV0dXJuIHNlbmRlci5pZCA9PT0gbnVsbCA/IGBudWxsLSR7c2VuZGVyLm5hbWV9YCA6IHNlbmRlci5pZDsKfQpmdW5jdGlvbiBpc1ZhbGlkTGlnaHRuaW5nQ29tbWVudChvYmopIHsKICAgIHJldHVybiBpc1N0cmluZ1JlY29yZDEob2JqKSAmJiB0eXBlb2Ygb2JqLmlkID09PSAnc3RyaW5nJyAmJiBpc05vbkVtcHR5KG9iai5pZCkgJiYgdHlwZW9mIG9iai5tZXNzYWdlID09PSAnc3RyaW5nJyAmJiBpc05vbkVtcHR5KG9iai5tZXNzYWdlKSAmJiAodHlwZW9mIG9iai5wYXJlbnQgPT09ICdzdHJpbmcnICYmIGlzTm9uRW1wdHkob2JqLnBhcmVudCkgfHwgb2JqLnBhcmVudCA9PT0gbnVsbCkgJiYgQXJyYXkuaXNBcnJheShvYmouY2hpbGRyZW4pICYmIG9iai5jaGlsZHJlbi5ldmVyeSgodik9PnR5cGVvZiB2ID09PSAnc3RyaW5nJyAmJiBpc05vbkVtcHR5KHYpCiAgICApICYmIHR5cGVvZiBvYmouZGVwdGggPT09ICdudW1iZXInICYmIGlzTm9uTmVnYXRpdmVJbnRlZ2VyMShvYmouZGVwdGgpICYmIHR5cGVvZiBvYmouY3JlYXRlZCA9PT0gJ3N0cmluZycgJiYgaXNWYWxpZElzbzg2MDEob2JqLmNyZWF0ZWQpICYmIGlzVmFsaWRMaWdodG5pbmdTZW5kZXIob2JqLnNlbmRlcik7Cn0KZnVuY3Rpb24gaXNWYWxpZExpZ2h0bmluZ1NlbmRlcihvYmopIHsKICAgIHJldHVybiBpc1N0cmluZ1JlY29yZDEob2JqKSAmJiB0eXBlb2Ygb2JqLmFwcCA9PT0gJ3N0cmluZycgJiYgaXNOb25FbXB0eShvYmouYXBwKSAmJiAob2JqLmlkID09PSBudWxsIHx8IHR5cGVvZiBvYmouaWQgPT09ICdzdHJpbmcnICYmIGlzTm9uRW1wdHkob2JqLmlkKSkgJiYgdHlwZW9mIG9iai5uYW1lID09PSAnc3RyaW5nJyAmJiBpc05vbkVtcHR5KG9iai5uYW1lKTsKfQpjb25zdCBUd2l0dGVyUHJvdG9jb2xJbXBsZW1lbnRhdGlvbiA9IHsKICAgIGFzeW5jIGluaXRUaHJlYWRjYXAgKHVybCwgb3B0cykgewogICAgICAgIGNvbnN0IHsgZGVidWcgIH0gPSBvcHRzOwogICAgICAgIGNvbnN0IHsgaG9zdG5hbWUgLCBwYXRobmFtZSAgfSA9IG5ldyBVUkwodXJsKTsKICAgICAgICBjb25zdCBtID0gL15cLy4qP1wvc3RhdHVzXC8oXGQrKSQvLmV4ZWMocGF0aG5hbWUpOwogICAgICAgIGlmICghL14obW9iaWxlXC4pP3R3aXR0ZXJcLmNvbSQvLnRlc3QoaG9zdG5hbWUpIHx8ICFtKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgdHdlZXQgdXJsOiAke3VybH1gKTsKICAgICAgICBjb25zdCBbXywgaWRdID0gbTsKICAgICAgICBjb25zdCB0d2VldEFwaVVybCA9IGBodHRwczovL2FwaS50d2l0dGVyLmNvbS8yL3R3ZWV0cy8ke2lkfWA7CiAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgZmluZE9yRmV0Y2hUd2l0dGVyKHR3ZWV0QXBpVXJsLCBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksIG9wdHMpOwogICAgICAgIGlmIChkZWJ1ZykgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBwcm90b2NvbDogJ3R3aXR0ZXInLAogICAgICAgICAgICByb290czogWwogICAgICAgICAgICAgICAgdHdlZXRBcGlVcmwKICAgICAgICAgICAgXSwKICAgICAgICAgICAgbm9kZXM6IHt9LAogICAgICAgICAgICBjb21tZW50ZXJzOiB7fQogICAgICAgIH07CiAgICB9LAogICAgYXN5bmMgZmV0Y2hDb21tZW50IChpZCwgb3B0cykgewogICAgICAgIGNvbnN0IHsgdXBkYXRlVGltZSAsIGRlYnVnICwgc3RhdGUgIH0gPSBvcHRzOwogICAgICAgIGlmICh0eXBlb2Ygc3RhdGUuY29udmVyc2F0aW9uSWQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbnZlcnNhdGlvbiA9IGF3YWl0IGZpbmRPckZldGNoQ29udmVyc2F0aW9uKHN0YXRlLmNvbnZlcnNhdGlvbklkLCBvcHRzKTsKICAgICAgICAgICAgY29uc3QgdHdlZXRJZCA9IGlkLnNwbGl0KCcvJykucG9wKCk7CiAgICAgICAgICAgIGNvbnN0IHR3ZWV0ID0gY29udmVyc2F0aW9uLnR3ZWV0c1t0d2VldElkXTsKICAgICAgICAgICAgaWYgKCF0d2VldCkgdGhyb3cgbmV3IEVycm9yKGBmZXRjaENvbW1lbnQ6IHR3ZWV0ICR7dHdlZXRJZH0gbm90IGZvdW5kIGluIGNvbnZlcnNhdGlvbmApOwogICAgICAgICAgICByZXR1cm4gY29tcHV0ZUNvbW1lbnRGcm9tVHdlZXRPYmoodHdlZXQpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGlkKTsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgndHdlZXQuZmllbGRzJywgJ2F1dGhvcl9pZCxsYW5nLGNyZWF0ZWRfYXQnKTsKICAgICAgICBjb25zdCBvYmogPSBhd2FpdCBmaW5kT3JGZXRjaFR3aXR0ZXIodXJsLnRvU3RyaW5nKCksIHVwZGF0ZVRpbWUsIG9wdHMpOwogICAgICAgIGlmIChkZWJ1ZykgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICByZXR1cm4gY29tcHV0ZUNvbW1lbnRGcm9tVHdlZXRPYmoob2JqLmRhdGEpOwogICAgfSwKICAgIGFzeW5jIGZldGNoQ29tbWVudGVyIChhdHRyaWJ1dGVkVG8sIG9wdHMpIHsKICAgICAgICBjb25zdCB7IHVwZGF0ZVRpbWUgLCBkZWJ1ZyAsIHN0YXRlICB9ID0gb3B0czsKICAgICAgICBpZiAodHlwZW9mIHN0YXRlLmNvbnZlcnNhdGlvbklkID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zdCBjb252ZXJzYXRpb24gPSBhd2FpdCBmaW5kT3JGZXRjaENvbnZlcnNhdGlvbihzdGF0ZS5jb252ZXJzYXRpb25JZCwgb3B0cyk7CiAgICAgICAgICAgIGNvbnN0IHVzZXJJZCA9IGF0dHJpYnV0ZWRUby5zcGxpdCgnLycpLnBvcCgpOwogICAgICAgICAgICBjb25zdCB1c2VyID0gY29udmVyc2F0aW9uLnVzZXJzW3VzZXJJZF07CiAgICAgICAgICAgIGlmICghdXNlcikgdGhyb3cgbmV3IEVycm9yKGBmZXRjaENvbW1lbnRlcjogdXNlciAke3VzZXJJZH0gbm90IGZvdW5kIGluIGNvbnZlcnNhdGlvbmApOwogICAgICAgICAgICByZXR1cm4gY29tcHV0ZUNvbW1lbnRlckZyb21Vc2VyT2JqKHVzZXIsIHVwZGF0ZVRpbWUpOwogICAgICAgIH0KICAgICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGF0dHJpYnV0ZWRUbyk7CiAgICAgICAgdXJsLnNlYXJjaFBhcmFtcy5zZXQoJ3VzZXIuZmllbGRzJywgJ3Byb2ZpbGVfaW1hZ2VfdXJsJyk7CiAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgZmluZE9yRmV0Y2hUd2l0dGVyKHVybC50b1N0cmluZygpLCB1cGRhdGVUaW1lLCBvcHRzKTsKICAgICAgICBpZiAoZGVidWcpIGNvbnNvbGUubG9nKCdmZXRjaENvbW1lbnRlcicsIEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgcmV0dXJuIGNvbXB1dGVDb21tZW50ZXJGcm9tVXNlck9iaihvYmouZGF0YSwgdXBkYXRlVGltZSk7CiAgICB9LAogICAgYXN5bmMgZmV0Y2hSZXBsaWVzIChpZCwgb3B0cykgewogICAgICAgIGNvbnN0IG0gPSAvXmh0dHBzOlwvXC9hcGlcLnR3aXR0ZXJcLmNvbVwvMlwvdHdlZXRzXC8oLio/KSQvLmV4ZWMoaWQpOwogICAgICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIHR3ZWV0IGlkOiAke2lkfWApOwogICAgICAgIGNvbnN0IFtfLCB0d2VldElkXSA9IG07CiAgICAgICAgY29uc3QgY29udm8gPSBhd2FpdCBmaW5kT3JGZXRjaENvbnZlcnNhdGlvbih0d2VldElkLCBvcHRzKTsKICAgICAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhjb252by50d2VldHMpLmZpbHRlcigodik9PnYucmVmZXJlbmNlZF90d2VldHMuc29tZSgodyk9PncudHlwZSA9PT0gJ3JlcGxpZWRfdG8nICYmIHcuaWQgPT09IHR3ZWV0SWQKICAgICAgICAgICAgKQogICAgICAgICkubWFwKCh2KT0+YGh0dHBzOi8vYXBpLnR3aXR0ZXIuY29tLzIvdHdlZXRzLyR7di5pZH1gCiAgICAgICAgKTsKICAgIH0KfTsKZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlckZyb21Vc2VyT2JqKG9iaiwgYXNvZikgewogICAgY29uc3QgbmFtZSA9IG9iai5uYW1lOwogICAgY29uc3QgZnFVc2VybmFtZSA9ICdAJyArIG9iai51c2VybmFtZTsKICAgIGNvbnN0IHVzZXJVcmwgPSBgaHR0cHM6Ly90d2l0dGVyLmNvbS8ke29iai51c2VybmFtZX1gOwogICAgY29uc3QgaWNvblVybCA9IG9iai5wcm9maWxlX2ltYWdlX3VybDsKICAgIGNvbnN0IGljb25VcmxMb3dlciA9IChpY29uVXJsIHx8ICcnKS50b0xvd2VyQ2FzZSgpOwogICAgY29uc3QgaWNvbk1lZGlhVHlwZSA9IGljb25VcmxMb3dlci5lbmRzV2l0aCgnLmpwZycpID8gJ2ltYWdlL2pwZWcnIDogaWNvblVybExvd2VyLmVuZHNXaXRoKCcucG5nJykgPyAnaW1hZ2UvcG5nJyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGljb24yID0gaWNvblVybCA/IHsKICAgICAgICB1cmw6IGljb25VcmwsCiAgICAgICAgbWVkaWFUeXBlOiBpY29uTWVkaWFUeXBlCiAgICB9IDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICBhc29mLAogICAgICAgIG5hbWUsCiAgICAgICAgZnFVc2VybmFtZSwKICAgICAgICB1cmw6IHVzZXJVcmwsCiAgICAgICAgaWNvbjogaWNvbjIKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRGcm9tVHdlZXRPYmoob2JqKSB7CiAgICBjb25zdCB0d2VldElkID0gb2JqLmlkOwogICAgY29uc3QgdGV4dCA9IG9iai50ZXh0OwogICAgY29uc3QgYXV0aG9ySWQgPSBvYmouYXV0aG9yX2lkOwogICAgY29uc3QgbGFuZyA9IG9iai5sYW5nOwogICAgY29uc3QgY3JlYXRlZEF0ID0gb2JqLmNyZWF0ZWRfYXQ7CiAgICBjb25zdCBjb250ZW50ID0ge307CiAgICBjb250ZW50W2xhbmddID0gdGV4dDsKICAgIGNvbnN0IHR3ZWV0VXJsID0gYGh0dHBzOi8vdHdpdHRlci5jb20vaS93ZWIvc3RhdHVzLyR7dHdlZXRJZH1gOwogICAgcmV0dXJuIHsKICAgICAgICBhdHRhY2htZW50czogW10sCiAgICAgICAgYXR0cmlidXRlZFRvOiBgaHR0cHM6Ly9hcGkudHdpdHRlci5jb20vMi91c2Vycy8ke2F1dGhvcklkfWAsCiAgICAgICAgY29udGVudCwKICAgICAgICBwdWJsaXNoZWQ6IGNyZWF0ZWRBdCwKICAgICAgICB1cmw6IHR3ZWV0VXJsCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIGZpbmRPckZldGNoVHdpdHRlcih1cmwsIGFmdGVyLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoZXIgLCBjYWNoZSAsIGJlYXJlclRva2VuICB9ID0gb3B0czsKICAgIGNvbnN0IG9iaiA9IGF3YWl0IGZpbmRPckZldGNoSnNvbih1cmwsIGFmdGVyLCBmZXRjaGVyLCBjYWNoZSwgewogICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24nLAogICAgICAgIGF1dGhvcml6YXRpb246IGBCZWFyZXIgJHtiZWFyZXJUb2tlbn1gCiAgICB9KTsKICAgIHJldHVybiBvYmo7Cn0KYXN5bmMgZnVuY3Rpb24gZmluZE9yRmV0Y2hDb252ZXJzYXRpb24odHdlZXRJZCwgb3B0cykgewogICAgY29uc3QgeyB1cGRhdGVUaW1lICwgc3RhdGUgLCBkZWJ1ZyAgfSA9IG9wdHM7CiAgICBsZXQgeyBjb252ZXJzYXRpb24gIH0gPSBzdGF0ZTsKICAgIGlmICghY29udmVyc2F0aW9uKSB7CiAgICAgICAgY29uc3QgY29udmVyc2F0aW9uSWQgPSBhd2FpdCBmaW5kT3JGZXRjaENvbnZlcnNhdGlvbklkKHR3ZWV0SWQsIG9wdHMpOwogICAgICAgIHN0YXRlLmNvbnZlcnNhdGlvbklkID0gY29udmVyc2F0aW9uSWQ7CiAgICAgICAgY29uc3QgdXJsID0gbmV3IFVSTCgnaHR0cHM6Ly9hcGkudHdpdHRlci5jb20vMi90d2VldHMvc2VhcmNoL3JlY2VudCcpOwogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdxdWVyeScsIGBjb252ZXJzYXRpb25faWQ6JHtjb252ZXJzYXRpb25JZH1gKTsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgnZXhwYW5zaW9ucycsIGByZWZlcmVuY2VkX3R3ZWV0cy5pZCxhdXRob3JfaWRgKTsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgndHdlZXQuZmllbGRzJywgYGF1dGhvcl9pZCxsYW5nLGNyZWF0ZWRfYXRgKTsKICAgICAgICB1cmwuc2VhcmNoUGFyYW1zLnNldCgndXNlci5maWVsZHMnLCBgaWQsbmFtZSx1c2VybmFtZSxwcm9maWxlX2ltYWdlX3VybGApOwogICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCdtYXhfcmVzdWx0cycsIGAxMDBgKTsKICAgICAgICBjb25zdCB0d2VldHMgPSB7fTsKICAgICAgICBjb25zdCB1c2VycyA9IHt9OwogICAgICAgIGxldCBuZXh0VG9rZW47CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIHdoaWxlKCsraSl7CiAgICAgICAgICAgIGlmIChuZXh0VG9rZW4pIHsKICAgICAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCduZXh0X3Rva2VuJywgbmV4dFRva2VuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHVybC5zZWFyY2hQYXJhbXMuZGVsZXRlKCduZXh0X3Rva2VuJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgZmluZE9yRmV0Y2hUd2l0dGVyKHVybC50b1N0cmluZygpLCB1cGRhdGVUaW1lLCBvcHRzKTsKICAgICAgICAgICAgaWYgKGRlYnVnKSBjb25zb2xlLmxvZyhgZmluZE9yRmV0Y2hDb252ZXJzYXRpb24gbmV4dFRva2VuPSR7bmV4dFRva2VufWAsIEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgIGZvciAoY29uc3QgdHdlZXRPYmogb2Ygb2JqLmRhdGEpewogICAgICAgICAgICAgICAgY29uc3QgdHdlZXQgPSB0d2VldE9iajsKICAgICAgICAgICAgICAgIHR3ZWV0c1t0d2VldC5pZF0gPSB0d2VldDsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAob2JqLmluY2x1ZGVzICYmIEFycmF5LmlzQXJyYXkob2JqLmluY2x1ZGVzLnVzZXJzKSkgewogICAgICAgICAgICAgICAgZm9yIChjb25zdCB1c2VyT2JqIG9mIG9iai5pbmNsdWRlcy51c2Vycyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlciA9IHVzZXJPYmo7CiAgICAgICAgICAgICAgICAgICAgdXNlcnNbdXNlci5pZF0gPSB1c2VyOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChvYmoubWV0YSAmJiB0eXBlb2Ygb2JqLm1ldGEubmV4dF90b2tlbiA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIG5leHRUb2tlbiA9IG9iai5tZXRhLm5leHRfdG9rZW47CiAgICAgICAgICAgICAgICBpZiAoaSA9PT0gNTApIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29udmVyc2F0aW9uID0gewogICAgICAgICAgICB0d2VldHMsCiAgICAgICAgICAgIHVzZXJzCiAgICAgICAgfTsKICAgICAgICBzdGF0ZS5jb252ZXJzYXRpb24gPSBjb252ZXJzYXRpb247CiAgICB9CiAgICByZXR1cm4gY29udmVyc2F0aW9uOwp9CmFzeW5jIGZ1bmN0aW9uIGZpbmRPckZldGNoQ29udmVyc2F0aW9uSWQodHdlZXRJZCwgb3B0cykgewogICAgY29uc3QgeyB1cGRhdGVUaW1lICwgc3RhdGUgLCBkZWJ1ZyAgfSA9IG9wdHM7CiAgICBsZXQgeyBjb252ZXJzYXRpb25JZCAgfSA9IHN0YXRlOwogICAgaWYgKHR5cGVvZiBjb252ZXJzYXRpb25JZCA9PT0gJ3N0cmluZycpIHJldHVybiBjb252ZXJzYXRpb25JZDsKICAgIGNvbnN0IHVybCA9IG5ldyBVUkwoYGh0dHBzOi8vYXBpLnR3aXR0ZXIuY29tLzIvdHdlZXRzLyR7dHdlZXRJZH1gKTsKICAgIHVybC5zZWFyY2hQYXJhbXMuc2V0KCd0d2VldC5maWVsZHMnLCAnY29udmVyc2F0aW9uX2lkJyk7CiAgICBjb25zdCBvYmogPSBhd2FpdCBmaW5kT3JGZXRjaFR3aXR0ZXIodXJsLnRvU3RyaW5nKCksIHVwZGF0ZVRpbWUsIG9wdHMpOwogICAgaWYgKGRlYnVnKSBjb25zb2xlLmxvZygnZmluZE9yRmV0Y2hDb252ZXJzYXRpb24nLCBKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgY29udmVyc2F0aW9uSWQgPSBvYmouZGF0YS5jb252ZXJzYXRpb25faWQ7CiAgICBpZiAodHlwZW9mIGNvbnZlcnNhdGlvbklkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGNvbnZlcnNhdGlvbklkIGluIHBheWxvYWQ6ICR7SlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpfWApOwogICAgc3RhdGUuY29udmVyc2F0aW9uSWQgPSBjb252ZXJzYXRpb25JZDsKICAgIHJldHVybiBjb252ZXJzYXRpb25JZDsKfQphc3luYyBmdW5jdGlvbiBtYWtlVGhyZWFkY2FwKHVybCwgb3B0cykgewogICAgY29uc3QgeyBjYWNoZSAsIHVzZXJBZ2VudCAsIHByb3RvY29sICwgYmVhcmVyVG9rZW4gLCBkZWJ1ZyAgfSA9IG9wdHM7CiAgICBjb25zdCBmZXRjaGVyID0gbWFrZUZldGNoZXJXaXRoVXNlckFnZW50KG9wdHMuZmV0Y2hlciwgdXNlckFnZW50KTsKICAgIGNvbnN0IGltcGxlbWVudGF0aW9uID0gY29tcHV0ZVByb3RvY29sSW1wbGVtZW50YXRpb24ocHJvdG9jb2wpOwogICAgcmV0dXJuIGF3YWl0IGltcGxlbWVudGF0aW9uLmluaXRUaHJlYWRjYXAodXJsLCB7CiAgICAgICAgZmV0Y2hlciwKICAgICAgICBjYWNoZSwKICAgICAgICBiZWFyZXJUb2tlbiwKICAgICAgICBkZWJ1ZwogICAgfSk7Cn0KYXN5bmMgZnVuY3Rpb24gdXBkYXRlVGhyZWFkY2FwKHRocmVhZGNhcCwgb3B0cykgewogICAgY29uc3QgeyB1c2VyQWdlbnQgLCBjYWNoZSAsIHVwZGF0ZVRpbWUgLCBjYWxsYmFja3MgLCBtYXhMZXZlbHMgLCBtYXhOb2RlczogbWF4Tm9kZXNJbnB1dCAsIHN0YXJ0Tm9kZSAsIGtlZXBHb2luZyAsIGJlYXJlclRva2VuICwgZGVidWcgIH0gPSBvcHRzOwogICAgY29uc3QgZmV0Y2hlciA9IG1ha2VGZXRjaGVyV2l0aFVzZXJBZ2VudChvcHRzLmZldGNoZXIsIHVzZXJBZ2VudCk7CiAgICBjb25zdCBtYXhMZXZlbCA9IE1hdGgubWluKE1hdGgubWF4KG1heExldmVscyA9PT0gdW5kZWZpbmVkID8gMTAwMCA6IE1hdGgucm91bmQobWF4TGV2ZWxzKSwgMCksIDEwMDApOwogICAgY29uc3QgbWF4Tm9kZXMgPSBtYXhOb2Rlc0lucHV0ID09PSB1bmRlZmluZWQgPyB1bmRlZmluZWQgOiBNYXRoLm1heChNYXRoLnJvdW5kKG1heE5vZGVzSW5wdXQpLCAwKTsKICAgIGlmIChzdGFydE5vZGUgJiYgIXRocmVhZGNhcC5ub2Rlc1tzdGFydE5vZGVdKSB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3RhcnQgbm9kZTogJHtzdGFydE5vZGV9YCk7CiAgICBpZiAobWF4TGV2ZWwgPT09IDApIHJldHVybjsKICAgIGlmIChtYXhOb2RlcyA9PT0gMCkgcmV0dXJuOwogICAgY29uc3QgaW1wbGVtZW50YXRpb24gPSBjb21wdXRlUHJvdG9jb2xJbXBsZW1lbnRhdGlvbih0aHJlYWRjYXAucHJvdG9jb2wpOwogICAgY29uc3Qgc3RhdGUgPSB7fTsKICAgIGNvbnN0IGlkc0J5bGV2ZWwgPSBbCiAgICAgICAgc3RhcnROb2RlID8gWwogICAgICAgICAgICBzdGFydE5vZGUKICAgICAgICBdIDogWwogICAgICAgICAgICAuLi50aHJlYWRjYXAucm9vdHMKICAgICAgICBdCiAgICBdOwogICAgbGV0IHJlbWFpbmluZyA9IDE7CiAgICBsZXQgcHJvY2Vzc2VkID0gMDsKICAgIGNvbnN0IHByb2Nlc3NMZXZlbCA9IGFzeW5jIChsZXZlbCk9PnsKICAgICAgICBjYWxsYmFja3M/Lm9uRXZlbnQoewogICAgICAgICAgICBraW5kOiAncHJvY2Vzcy1sZXZlbCcsCiAgICAgICAgICAgIHBoYXNlOiAnYmVmb3JlJywKICAgICAgICAgICAgbGV2ZWw6IGxldmVsICsgMQogICAgICAgIH0pOwogICAgICAgIGNvbnN0IG5leHRMZXZlbCA9IGxldmVsICsgMTsKICAgICAgICBmb3IgKGNvbnN0IGlkIG9mIGlkc0J5bGV2ZWxbbGV2ZWxdIHx8IFtdKXsKICAgICAgICAgICAgY29uc3QgcHJvY2Vzc1JlcGxpZXMgPSBuZXh0TGV2ZWwgPCBtYXhMZXZlbDsKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IGF3YWl0IHByb2Nlc3NOb2RlKGlkLCBwcm9jZXNzUmVwbGllcywgdGhyZWFkY2FwLCBpbXBsZW1lbnRhdGlvbiwgewogICAgICAgICAgICAgICAgdXBkYXRlVGltZSwKICAgICAgICAgICAgICAgIGNhbGxiYWNrcywKICAgICAgICAgICAgICAgIHN0YXRlLAogICAgICAgICAgICAgICAgZmV0Y2hlciwKICAgICAgICAgICAgICAgIGNhY2hlLAogICAgICAgICAgICAgICAgYmVhcmVyVG9rZW4sCiAgICAgICAgICAgICAgICBkZWJ1ZwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmVtYWluaW5nLS07CiAgICAgICAgICAgIHByb2Nlc3NlZCsrOwogICAgICAgICAgICBpZiAobWF4Tm9kZXMgJiYgcHJvY2Vzc2VkID49IG1heE5vZGVzKSByZXR1cm47CiAgICAgICAgICAgIGlmIChrZWVwR29pbmcgJiYgIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgIGlmIChub2RlLnJlcGxpZXMgJiYgbmV4dExldmVsIDwgbWF4TGV2ZWwpIHsKICAgICAgICAgICAgICAgIGlmICghaWRzQnlsZXZlbFtuZXh0TGV2ZWxdKSBpZHNCeWxldmVsW25leHRMZXZlbF0gPSBbXTsKICAgICAgICAgICAgICAgIGlkc0J5bGV2ZWxbbmV4dExldmVsXS5wdXNoKC4uLm5vZGUucmVwbGllcyk7CiAgICAgICAgICAgICAgICByZW1haW5pbmcgKz0gbm9kZS5yZXBsaWVzLmxlbmd0aDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjYWxsYmFja3M/Lm9uRXZlbnQoewogICAgICAgICAgICAgICAga2luZDogJ25vZGVzLXJlbWFpbmluZycsCiAgICAgICAgICAgICAgICByZW1haW5pbmcKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrcz8ub25FdmVudCh7CiAgICAgICAgICAgIGtpbmQ6ICdwcm9jZXNzLWxldmVsJywKICAgICAgICAgICAgcGhhc2U6ICdhZnRlcicsCiAgICAgICAgICAgIGxldmVsOiBsZXZlbCArIDEKICAgICAgICB9KTsKICAgICAgICBpZiAoaWRzQnlsZXZlbFtuZXh0TGV2ZWxdKSBhd2FpdCBwcm9jZXNzTGV2ZWwobmV4dExldmVsKTsKICAgIH07CiAgICBhd2FpdCBwcm9jZXNzTGV2ZWwoMCk7Cn0KY2xhc3MgSW5NZW1vcnlDYWNoZSB7CiAgICBtYXAgPSBuZXcgTWFwKCk7CiAgICBvblJldHVybmluZ0NhY2hlZFJlc3BvbnNlOwogICAgZ2V0KGlkLCBhZnRlcikgewogICAgICAgIGNvbnN0IHsgcmVzcG9uc2UgLCBmZXRjaGVkICB9ID0gdGhpcy5tYXAuZ2V0KGlkKSB8fCB7fTsKICAgICAgICBpZiAocmVzcG9uc2UgJiYgZmV0Y2hlZCAmJiBmZXRjaGVkID4gYWZ0ZXIpIHsKICAgICAgICAgICAgaWYgKHRoaXMub25SZXR1cm5pbmdDYWNoZWRSZXNwb25zZSkgdGhpcy5vblJldHVybmluZ0NhY2hlZFJlc3BvbnNlKGlkLCBhZnRlciwgZmV0Y2hlZCwgcmVzcG9uc2UpOwogICAgICAgICAgICByZXR1cm4gUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpOwogICAgfQogICAgcHV0KGlkLCBmZXRjaGVkLCByZXNwb25zZSkgewogICAgICAgIHRoaXMubWFwLnNldChpZCwgewogICAgICAgICAgICByZXNwb25zZSwKICAgICAgICAgICAgZmV0Y2hlZAogICAgICAgIH0pOwogICAgICAgIHJldHVybiBQcm9taXNlLnJlc29sdmUoKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRGVmYXVsdE1pbGxpc1RvV2FpdChpbnB1dCkgewogICAgY29uc3QgeyByZW1haW5pbmcgLCBtaWxsaXNUaWxsUmVzZXQgIH0gPSBpbnB1dDsKICAgIGlmIChyZW1haW5pbmcgPj0gMTAwKSByZXR1cm4gMDsKICAgIHJldHVybiByZW1haW5pbmcgPiAwID8gTWF0aC5yb3VuZChtaWxsaXNUaWxsUmVzZXQgLyByZW1haW5pbmcpIDogbWlsbGlzVGlsbFJlc2V0Owp9CmZ1bmN0aW9uIG1ha2VSYXRlTGltaXRlZEZldGNoZXIoZmV0Y2hlciwgb3B0czEgPSB7fSkgewogICAgY29uc3QgeyBjYWxsYmFja3MgIH0gPSBvcHRzMTsKICAgIGNvbnN0IGNvbXB1dGVNaWxsaXNUb1dhaXQgPSBvcHRzMS5jb21wdXRlTWlsbGlzVG9XYWl0IHx8IGNvbXB1dGVEZWZhdWx0TWlsbGlzVG9XYWl0OwogICAgY29uc3QgZW5kcG9pbnRMaW1pdHMgPSBuZXcgTWFwKCk7CiAgICByZXR1cm4gYXN5bmMgKHVybCwgb3B0cyk9PnsKICAgICAgICBjb25zdCB7IGhvc3RuYW1lICwgcGF0aG5hbWUgIH0gPSBuZXcgVVJMKHVybCk7CiAgICAgICAgY29uc3QgdHdpdHRlckVuZHBvaW50ID0gY29tcHV0ZVR3aXR0ZXJFbmRwb2ludChob3N0bmFtZSwgcGF0aG5hbWUpOwogICAgICAgIGNvbnN0IGVuZHBvaW50ID0gdHdpdHRlckVuZHBvaW50IHx8IGhvc3RuYW1lOwogICAgICAgIGNvbnN0IGxpbWl0cyA9IGVuZHBvaW50TGltaXRzLmdldChlbmRwb2ludCk7CiAgICAgICAgaWYgKGxpbWl0cykgewogICAgICAgICAgICBjb25zdCB7IGxpbWl0ICwgcmVtYWluaW5nICwgcmVzZXQgIH0gPSBsaW1pdHM7CiAgICAgICAgICAgIGNvbnN0IG1pbGxpc1RpbGxSZXNldCA9IG5ldyBEYXRlKHJlc2V0KS5nZXRUaW1lKCkgLSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCBtaWxsaXNUb1dhaXQgPSBjb21wdXRlTWlsbGlzVG9XYWl0KHsKICAgICAgICAgICAgICAgIGVuZHBvaW50LAogICAgICAgICAgICAgICAgbGltaXQsCiAgICAgICAgICAgICAgICByZW1haW5pbmcsCiAgICAgICAgICAgICAgICByZXNldCwKICAgICAgICAgICAgICAgIG1pbGxpc1RpbGxSZXNldAogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKG1pbGxpc1RvV2FpdCA+IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcz8ub25FdmVudCh7CiAgICAgICAgICAgICAgICAgICAga2luZDogJ3dhaXRpbmctZm9yLXJhdGUtbGltaXQnLAogICAgICAgICAgICAgICAgICAgIGVuZHBvaW50LAogICAgICAgICAgICAgICAgICAgIG1pbGxpc1RvV2FpdCwKICAgICAgICAgICAgICAgICAgICBtaWxsaXNUaWxsUmVzZXQsCiAgICAgICAgICAgICAgICAgICAgbGltaXQsCiAgICAgICAgICAgICAgICAgICAgcmVtYWluaW5nLAogICAgICAgICAgICAgICAgICAgIHJlc2V0CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGF3YWl0IHNsZWVwKG1pbGxpc1RvV2FpdCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hlcih1cmwsIG9wdHMpOwogICAgICAgIGNvbnN0IGxpbWl0SGVhZGVyID0gdHdpdHRlckVuZHBvaW50ID8gJ3gtcmF0ZS1saW1pdC1saW1pdCcgOiAneC1yYXRlbGltaXQtbGltaXQnOwogICAgICAgIGNvbnN0IHJlbWFpbmluZ0hlYWRlciA9IHR3aXR0ZXJFbmRwb2ludCA/ICd4LXJhdGUtbGltaXQtcmVtYWluaW5nJyA6ICd4LXJhdGVsaW1pdC1yZW1haW5pbmcnOwogICAgICAgIGNvbnN0IHJlc2V0SGVhZGVyID0gdHdpdHRlckVuZHBvaW50ID8gJ3gtcmF0ZS1saW1pdC1yZXNldCcgOiAneC1yYXRlbGltaXQtcmVzZXQnOwogICAgICAgIGNvbnN0IGxpbWl0ID0gdHJ5UGFyc2VJbnQocmVzLmhlYWRlcnMuZ2V0KGxpbWl0SGVhZGVyKSB8fCAnJyk7CiAgICAgICAgY29uc3QgcmVtYWluaW5nID0gdHJ5UGFyc2VJbnQocmVzLmhlYWRlcnMuZ2V0KHJlbWFpbmluZ0hlYWRlcikgfHwgJycpOwogICAgICAgIGNvbnN0IHJlc2V0U3RyID0gcmVzLmhlYWRlcnMuZ2V0KHJlc2V0SGVhZGVyKSB8fCAnJzsKICAgICAgICBjb25zdCByZXNldCA9IHR3aXR0ZXJFbmRwb2ludCA/IHRyeVBhcnNlRXBvY2hTZWNvbmRzQXNJc284NjAxKHJlc2V0U3RyKSA6IHRyeVBhcnNlSXNvODYwMShyZXNldFN0cik7CiAgICAgICAgaWYgKGxpbWl0ICE9PSB1bmRlZmluZWQgJiYgcmVtYWluaW5nICE9PSB1bmRlZmluZWQgJiYgcmVzZXQgIT09IHVuZGVmaW5lZCkgewogICAgICAgICAgICBlbmRwb2ludExpbWl0cy5zZXQoZW5kcG9pbnQsIHsKICAgICAgICAgICAgICAgIGxpbWl0LAogICAgICAgICAgICAgICAgcmVtYWluaW5nLAogICAgICAgICAgICAgICAgcmVzZXQKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiByZXM7CiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVUd2l0dGVyRW5kcG9pbnQoaG9zdG5hbWUsIHBhdGhuYW1lKSB7CiAgICBpZiAoaG9zdG5hbWUgPT09ICdhcGkudHdpdHRlci5jb20nKSB7CiAgICAgICAgcmV0dXJuIHBhdGhuYW1lLnJlcGxhY2VBbGwoL1xkezQsfS9nLCAnOmlkJyk7CiAgICB9Cn0KZnVuY3Rpb24gbWFrZUZldGNoZXJXaXRoVXNlckFnZW50KGZldGNoZXIsIHVzZXJBZ2VudCkgewogICAgdXNlckFnZW50ID0gdXNlckFnZW50LnRyaW0oKTsKICAgIGlmICh1c2VyQWdlbnQubGVuZ3RoID09PSAwKSB0aHJvdyBuZXcgRXJyb3IoYEV4cGVjdGVkIG5vbi1ibGFuayB1c2VyLWFnZW50YCk7CiAgICByZXR1cm4gYXN5bmMgKHVybCwgb3B0cyk9PnsKICAgICAgICBjb25zdCBoZWFkZXJzID0gewogICAgICAgICAgICAuLi5vcHRzPy5oZWFkZXJzIHx8IHt9LAogICAgICAgICAgICAndXNlci1hZ2VudCc6IHVzZXJBZ2VudAogICAgICAgIH07CiAgICAgICAgcmV0dXJuIGF3YWl0IGZldGNoZXIodXJsLCB7CiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KTsKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZVByb3RvY29sSW1wbGVtZW50YXRpb24ocHJvdG9jb2wpIHsKICAgIGlmIChwcm90b2NvbCA9PT0gdW5kZWZpbmVkIHx8IHByb3RvY29sID09PSAnYWN0aXZpdHlwdWInKSByZXR1cm4gQWN0aXZpdHlQdWJQcm90b2NvbEltcGxlbWVudGF0aW9uOwogICAgaWYgKHByb3RvY29sID09PSAnbGlnaHRuaW5nJyB8fCBwcm90b2NvbCA9PT0gJ2xpZ2h0bmluZ2NvbW1lbnRzJykgcmV0dXJuIExpZ2h0bmluZ0NvbW1lbnRzUHJvdG9jb2xJbXBsZW1lbnRhdGlvbjsKICAgIGlmIChwcm90b2NvbCA9PT0gJ3R3aXR0ZXInKSByZXR1cm4gVHdpdHRlclByb3RvY29sSW1wbGVtZW50YXRpb247CiAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIHByb3RvY29sOiAke3Byb3RvY29sfWApOwp9CmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NOb2RlKGlkLCBwcm9jZXNzUmVwbGllcywgdGhyZWFkY2FwLCBpbXBsZW1lbnRhdGlvbiwgb3B0cykgewogICAgY29uc3QgeyB1cGRhdGVUaW1lICwgY2FsbGJhY2tzICB9ID0gb3B0czsKICAgIGxldCBub2RlID0gdGhyZWFkY2FwLm5vZGVzW2lkXTsKICAgIGlmICghbm9kZSkgewogICAgICAgIG5vZGUgPSB7fTsKICAgICAgICB0aHJlYWRjYXAubm9kZXNbaWRdID0gbm9kZTsKICAgIH0KICAgIGNvbnN0IHVwZGF0ZUNvbW1lbnQgPSAhbm9kZS5jb21tZW50QXNvZiB8fCBub2RlLmNvbW1lbnRBc29mIDwgdXBkYXRlVGltZTsKICAgIGlmICh1cGRhdGVDb21tZW50KSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgbm9kZS5jb21tZW50ID0gYXdhaXQgaW1wbGVtZW50YXRpb24uZmV0Y2hDb21tZW50KGlkLCBvcHRzKTsKICAgICAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gIH0gPSBub2RlLmNvbW1lbnQ7CiAgICAgICAgICAgIGNvbnN0IGV4aXN0aW5nQ29tbWVudGVyID0gdGhyZWFkY2FwLmNvbW1lbnRlcnNbYXR0cmlidXRlZFRvXTsKICAgICAgICAgICAgaWYgKCFleGlzdGluZ0NvbW1lbnRlciB8fCBleGlzdGluZ0NvbW1lbnRlci5hc29mIDwgdXBkYXRlVGltZSkgewogICAgICAgICAgICAgICAgdGhyZWFkY2FwLmNvbW1lbnRlcnNbYXR0cmlidXRlZFRvXSA9IGF3YWl0IGltcGxlbWVudGF0aW9uLmZldGNoQ29tbWVudGVyKGF0dHJpYnV0ZWRUbywgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5jb21tZW50RXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBub2RlLmNvbW1lbnQgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIG5vZGUuY29tbWVudEVycm9yID0gYCR7ZS5zdGFjayB8fCBlfWA7CiAgICAgICAgfQogICAgICAgIG5vZGUuY29tbWVudEFzb2YgPSB1cGRhdGVUaW1lOwogICAgfQogICAgY2FsbGJhY2tzPy5vbkV2ZW50KHsKICAgICAgICBraW5kOiAnbm9kZS1wcm9jZXNzZWQnLAogICAgICAgIG5vZGVJZDogaWQsCiAgICAgICAgcGFydDogJ2NvbW1lbnQnLAogICAgICAgIHVwZGF0ZWQ6IHVwZGF0ZUNvbW1lbnQKICAgIH0pOwogICAgaWYgKHByb2Nlc3NSZXBsaWVzKSB7CiAgICAgICAgY29uc3QgdXBkYXRlUmVwbGllcyA9ICFub2RlLnJlcGxpZXNBc29mIHx8IG5vZGUucmVwbGllc0Fzb2YgPCB1cGRhdGVUaW1lOwogICAgICAgIGlmICh1cGRhdGVSZXBsaWVzKSB7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICBub2RlLnJlcGxpZXMgPSBhd2FpdCBpbXBsZW1lbnRhdGlvbi5mZXRjaFJlcGxpZXMoaWQsIG9wdHMpOwogICAgICAgICAgICAgICAgbm9kZS5yZXBsaWVzRXJyb3IgPSB1bmRlZmluZWQ7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIG5vZGUucmVwbGllcyA9IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgIG5vZGUucmVwbGllc0Vycm9yID0gYCR7ZS5zdGFjayB8fCBlfWA7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbm9kZS5yZXBsaWVzQXNvZiA9IHVwZGF0ZVRpbWU7CiAgICAgICAgfQogICAgICAgIGNhbGxiYWNrcz8ub25FdmVudCh7CiAgICAgICAgICAgIGtpbmQ6ICdub2RlLXByb2Nlc3NlZCcsCiAgICAgICAgICAgIG5vZGVJZDogaWQsCiAgICAgICAgICAgIHBhcnQ6ICdyZXBsaWVzJywKICAgICAgICAgICAgdXBkYXRlZDogdXBkYXRlUmVwbGllcwogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIG5vZGU7Cn0KZnVuY3Rpb24gc2xlZXAobXMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSk9PnNldFRpbWVvdXQocmVzb2x2ZSwgbXMpCiAgICApOwp9CmZ1bmN0aW9uIHRyeVBhcnNlSW50KHZhbHVlKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBwYXJzZUludCh2YWx1ZSk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpmdW5jdGlvbiB0cnlQYXJzZUlzbzg2MDEodmFsdWUpIHsKICAgIHJldHVybiBpc1ZhbGlkSXNvODYwMSh2YWx1ZSkgPyB2YWx1ZSA6IHVuZGVmaW5lZDsKfQpmdW5jdGlvbiB0cnlQYXJzZUVwb2NoU2Vjb25kc0FzSXNvODYwMSh2YWx1ZSkgewogICAgY29uc3Qgc2Vjb25kcyA9IHRyeVBhcnNlSW50KHZhbHVlKTsKICAgIHJldHVybiBzZWNvbmRzICYmIHNlY29uZHMgPiAwID8gbmV3IERhdGUoc2Vjb25kcyAqIDEwMDApLnRvSVNPU3RyaW5nKCkgOiB1bmRlZmluZWQ7Cn0KY2xhc3MgVmFsaWRhdGlvbkpvYlZNIHsKICAgIGZldGNoZXJzOwogICAgcGlTZWFyY2hGZXRjaGVyOwogICAgdGhyZWFkY2FwVXNlckFnZW50OwogICAgbmV4dEpvYklkID0gMTsKICAgIGN1cnJlbnRKb2I7CiAgICBnZXQgdmFsaWRhdGluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuY3VycmVudEpvYi5kb25lOwogICAgfQogICAgZ2V0IGRvbmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY3VycmVudEpvYi5kb25lOwogICAgfQogICAgZ2V0IG1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2IubWVzc2FnZXMgOiBbXTsKICAgIH0KICAgIGdldCBpc1NlYXJjaCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jdXJyZW50Sm9iLnNlYXJjaDsKICAgIH0KICAgIGdldCBzZWFyY2hSZXN1bHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cyA6IFtdOwogICAgfQogICAgZ2V0IHhtbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy54bWw7CiAgICB9CiAgICBnZXQgeG1sU3VtbWFyeVRleHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8ueG1sU3VtbWFyeVRleHQ7CiAgICB9CiAgICBnZXQgY29tbWVudHNSZXN1bHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2I/LmNvbW1lbnRzUmVzdWx0czsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9wdHMpewogICAgICAgIGNvbnN0IHsgbG9jYWxGZXRjaGVyOiBsb2NhbEZldGNoZXIxICwgcmVtb3RlRmV0Y2hlcjogcmVtb3RlRmV0Y2hlcjEgLCBwaVNlYXJjaEZldGNoZXI6IHBpU2VhcmNoRmV0Y2hlcjEgLCB0aHJlYWRjYXBVc2VyQWdlbnQ6IHRocmVhZGNhcFVzZXJBZ2VudDEgIH0gPSBvcHRzOwogICAgICAgIHRoaXMuZmV0Y2hlcnMgPSB7CiAgICAgICAgICAgIGxvY2FsRmV0Y2hlcjogbG9jYWxGZXRjaGVyMSwKICAgICAgICAgICAgcmVtb3RlRmV0Y2hlcjogcmVtb3RlRmV0Y2hlcjEKICAgICAgICB9OwogICAgICAgIHRoaXMucGlTZWFyY2hGZXRjaGVyID0gcGlTZWFyY2hGZXRjaGVyMTsKICAgICAgICB0aGlzLnRocmVhZGNhcFVzZXJBZ2VudCA9IHRocmVhZGNhcFVzZXJBZ2VudDE7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57fTsKICAgIGNvbnRpbnVlV2l0aCh1cmwpIHsKICAgICAgICBjb25zdCB7IGN1cnJlbnRKb2IgIH0gPSB0aGlzOwogICAgICAgIGlmIChjdXJyZW50Sm9iKSB7CiAgICAgICAgICAgIGN1cnJlbnRKb2IuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICBjdXJyZW50Sm9iLnNlYXJjaCA9IGZhbHNlOwogICAgICAgICAgICBjdXJyZW50Sm9iLnNlYXJjaFJlc3VsdHMuc3BsaWNlKDApOwogICAgICAgICAgICBjdXJyZW50Sm9iLm1lc3NhZ2VzWzBdID0gewogICAgICAgICAgICAgICAgdHlwZTogJ3J1bm5pbmcnLAogICAgICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAnaW5mbycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ29udGludWluZyB3aXRoIGZlZWQgZnJvbSBzZWFyY2gnLAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyh1cmwsIGN1cnJlbnRKb2IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGpvYiA9IHsKICAgICAgICAgICAgaWQ6IHRoaXMubmV4dEpvYklkKyssCiAgICAgICAgICAgIG1lc3NhZ2VzOiBbXSwKICAgICAgICAgICAgc2VhcmNoUmVzdWx0czogW10sCiAgICAgICAgICAgIHRpbWVzOiB7fSwKICAgICAgICAgICAgb3B0aW9ucywKICAgICAgICAgICAgc2VhcmNoOiBmYWxzZSwKICAgICAgICAgICAgZG9uZTogZmFsc2UsCiAgICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2UKICAgICAgICB9OwogICAgICAgIHRoaXMuY3VycmVudEpvYiA9IGpvYjsKICAgICAgICBqb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICdydW5uaW5nJywKICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyhpbnB1dCwgam9iKTsKICAgIH0KICAgIGNhbmNlbFZhbGlkYXRpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudEpvYiAmJiAhdGhpcy5jdXJyZW50Sm9iLmRvbmUpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEpvYi5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZldGNoKHVybCwgb3B0cykgewogICAgICAgIGNvbnN0IHsgaGVhZGVycyAgfSA9IG9wdHM7CiAgICAgICAgY29uc3QgeyBmZXRjaGVycyAgfSA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KTsKICAgIH0KICAgIGFzeW5jIHZhbGlkYXRlQXN5bmMoaW5wdXQsIGpvYikgewogICAgICAgIGlucHV0ID0gbm9ybWFsaXplSW5wdXQoaW5wdXQpOwogICAgICAgIGNvbnN0IHsgbWVzc2FnZXMgIH0gPSBqb2I7CiAgICAgICAgY29uc3Qgc2V0U3RhdHVzID0gKHRleHQsIG9wdHMgPSB7fSk9PnsKICAgICAgICAgICAgY29uc3QgeyB1cmwgLCB0eXBlICB9ID0gb3B0czsKICAgICAgICAgICAgbWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlIHx8IG1lc3NhZ2VzWzBdLnR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGFkZE1lc3NhZ2UgPSAodHlwZSwgdGV4dCwgb3B0cyA9IHt9KT0+ewogICAgICAgICAgICBjb25zdCB7IHVybCAsIHRhZyAsIGNvbW1lbnQgLCByZWZlcmVuY2UgIH0gPSBvcHRzOwogICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdGFnLAogICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH07CiAgICAgICAgbGV0IGFjdGl2aXR5UHViOwogICAgICAgIGxldCBsaWdodG5pbmdDb21tZW50czsKICAgICAgICBsZXQgdHdpdHRlcjsKICAgICAgICBjb25zdCBoZWFkZXJzMSA9IHsKICAgICAgICAgICAgJ0FjY2VwdC1FbmNvZGluZyc6ICdnemlwJywKICAgICAgICAgICAgJ1VzZXItQWdlbnQnOiBqb2Iub3B0aW9ucy51c2VyQWdlbnQsCiAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzogJ25vLXN0b3JlJwogICAgICAgIH07CiAgICAgICAgbGV0IGNvbnRpbnVlV2l0aFVybDsKICAgICAgICBjb25zdCBqb2JTdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgY29uc3QgeyBmZXRjaGVycyAsIHBpU2VhcmNoRmV0Y2hlcjogcGlTZWFyY2hGZXRjaGVyMiAgfSA9IHRoaXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5wdXQgPSBpbnB1dC50cmltKCk7CiAgICAgICAgICAgIGlmIChpbnB1dCA9PT0gJycpIHRocm93IG5ldyBFcnJvcihgTm8gaW5wdXRgKTsKICAgICAgICAgICAgaWYgKC9eaHR0cHM/OlwvXC8uKy9pLnRlc3QoaW5wdXQpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFVybCA9IHRyeVBhcnNlVXJsMShpbnB1dCk7CiAgICAgICAgICAgICAgICBpZiAoIWlucHV0VXJsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB1cmw6ICR7aW5wdXR9YCk7CiAgICAgICAgICAgICAgICBjaGVja01hdGNoZXMoJ2lucHV0VXJsLnByb3RvY29sJywgaW5wdXRVcmwucHJvdG9jb2wsIC9eaHR0cHM/OiQvKTsKICAgICAgICAgICAgICAgIGlmIChpbnB1dFVybC5ob3N0bmFtZSAhPT0gJ2ZlZWQucG9kYmVhbi5jb20nKSB7CiAgICAgICAgICAgICAgICAgICAgaW5wdXRVcmwuc2VhcmNoUGFyYW1zLnNldCgnX3QnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgeyByZXNwb25zZTogcmVzcG9uc2UxICwgc2lkZTogc2lkZTEgLCBmZXRjaFRpbWUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2goaW5wdXRVcmwudG9TdHJpbmcoKSwgewogICAgICAgICAgICAgICAgICAgIGZldGNoZXJzLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnM6IGhlYWRlcnMxCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChqb2IuZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgam9iLnRpbWVzLmZldGNoVGltZSA9IGZldGNoVGltZTsKICAgICAgICAgICAgICAgIGlmIChzaWRlMSA9PT0gJ2xvY2FsJykgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgTG9jYWwgZmV0Y2ggc3VjY2VlZGVkIChDT1JTIGVuYWJsZWQpYCwgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGVja0VxdWFsKGAke2lucHV0VXJsLmhvc3R9IHJlc3BvbnNlIHN0YXR1c2AsIHJlc3BvbnNlMS5zdGF0dXMsIDIwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlMS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICAgICAgICAgICAgICBsZXQgdmFsaWRhdGVGZWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChjb250ZW50VHlwZSAmJiBjb250ZW50VHlwZS5pbmNsdWRlcygnL2h0bWwnKSkgewogICAgICAgICAgICAgICAgICAgIGlmIChpbnB1dFVybC5ob3N0bmFtZS5lbmRzV2l0aCgndHdpdHRlci5jb20nKSkgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIGh0bWwsIHdpbGwgdHJ5IGFnYWluIGFzIFR3aXR0ZXInKTsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIHR3aXR0ZXIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogJ2lucHV0IHVybCcKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIGh0bWwsIHdpbGwgdHJ5IGFnYWluIGFzIEFjdGl2aXR5UHViJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjb250ZW50VHlwZSAmJiBjb250ZW50VHlwZS5zdGFydHNXaXRoKCdhcHBsaWNhdGlvbi9hY3Rpdml0eStqc29uJykpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIEFjdGl2aXR5UHViIGpzb24nKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBhd2FpdCByZXNwb25zZTEuanNvbigpOwogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJywKICAgICAgICAgICAgICAgICAgICAgICAgb2JqCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0ZUZlZWQpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXNwb25zZTEudGV4dCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChqb2IuZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy5yZWFkVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHhtbDsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB4bWwgPSBwYXJzZVhtbCh0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coeG1sKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0eXBlb2YgZS5tZXNzYWdlID09PSAnc3RyaW5nJyA/IGUubWVzc2FnZSA6ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93bkludmFsaWQgPSBtZXNzYWdlID09PSBgQ2Fubm90IHJlYWQgcHJvcGVydGllcyBvZiB1bmRlZmluZWQgKHJlYWRpbmcgJ3BhcmVudCcpYDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBgWG1sIHBhcnNlIGZhaWxlZDogJHtrbm93bkludmFsaWQgPyAnSW52YWxpZCB4bWwnIDogZS5tZXNzYWdlfWApOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnBhcnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9uTWVzc2FnZSA9ICh0eXBlLCBub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSh0eXBlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzPy50YWcgPT09ICdzb2NpYWwtaW50ZXJhY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IGNvbXB1dGVBdHRyaWJ1dGVNYXAobm9kZS5hdHRyc01hcCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXJpID0gYXR0cmlidXRlcy5nZXQoJ3VyaScpIHx8IG5vZGUudmFsOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuZ2V0KCdwbGF0Zm9ybScpPy50b0xvd2VyQ2FzZSgpID09PSAnYWN0aXZpdHlwdWInIHx8IGF0dHJpYnV0ZXMuZ2V0KCdwcm90b2NvbCcpPy50b0xvd2VyQ2FzZSgpID09PSAnYWN0aXZpdHlwdWInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcGlzb2RlVGl0bGUgPSBmaW5kRXBpc29kZVRpdGxlKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogZXBpc29kZVRpdGxlID8gYOKAnCR7ZXBpc29kZVRpdGxlfeKAnWAgOiAnZXBpc29kZScKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuZ2V0KCdwcm90b2NvbCcpPy50b0xvd2VyQ2FzZSgpID09PSAnbGlnaHRuaW5nY29tbWVudHMnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcGlzb2RlVGl0bGUgPSBmaW5kRXBpc29kZVRpdGxlKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGlnaHRuaW5nQ29tbWVudHMgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB1cmksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogZXBpc29kZVRpdGxlID8gYOKAnCR7ZXBpc29kZVRpdGxlfeKAnWAgOiAnZXBpc29kZScKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuZ2V0KCdwcm90b2NvbCcpPy50b0xvd2VyQ2FzZSgpID09PSAndHdpdHRlcicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVwaXNvZGVUaXRsZSA9IGZpbmRFcGlzb2RlVGl0bGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0d2l0dGVyID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogdXJpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6IGVwaXNvZGVUaXRsZSA/IGDigJwke2VwaXNvZGVUaXRsZX3igJ1gIDogJ2VwaXNvZGUnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5rbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGlOYW1lc3BhY2VVcmlzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcnNzSXRlbUluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBwaUxpdmVJdGVtc0NvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Hb29kOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdnb29kJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25FcnJvcjogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2Vycm9yJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25XYXJuaW5nOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCd3YXJuaW5nJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25JbmZvOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdpbmZvJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kOiAoa25vd24sIHVua25vd24sIG5hbWVzcGFjZVVyaXMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga25vd24uZm9yRWFjaCgodik9Pmtub3duUGlUYWdzLmFkZCh2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5rbm93bi5mb3JFYWNoKCh2KT0+dW5rbm93blBpVGFncy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZVVyaXMuZm9yRWFjaCgodik9PnBpTmFtZXNwYWNlVXJpcy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUnNzSXRlbXNGb3VuZDogKGl0ZW1zQ291bnQsIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByc3NJdGVtSW5mbyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNDb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBvZGNhc3RJbmRleExpdmVJdGVtc0ZvdW5kOiAobGl2ZUl0ZW1zQ291bnQpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGlMaXZlSXRlbXNDb3VudCA9IGxpdmVJdGVtc0NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeG1sU3VtbWFyeVRleHQgPSAnWG1sIHN0cnVjdHVyZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy52YWxpZGF0ZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyc3NJdGVtSW5mbykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBpdGVtc0NvdW50ICwgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ICB9ID0gcnNzSXRlbUluZm87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQgPSBpdGVtc0NvdW50IC0gaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGllY2VzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBGb3VuZCAke3VuaXRTdHJpbmcoaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50LCAnZXBpc29kZScpfWAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50ID4gMCkgcGllY2VzLnB1c2goYGFuZCAke3VuaXRTdHJpbmcoaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50LCAnaXRlbScpfSB3aXRob3V0IGVuY2xvc3VyZXNgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwaUxpdmVJdGVtc0NvdW50ID4gMCkgcGllY2VzLnB1c2goYGFuZCAke3VuaXRTdHJpbmcocGlMaXZlSXRlbXNDb3VudCwgJ2xpdmVJdGVtJyl9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMucHVzaChgaW4gYSAke2Zvcm1hdEJ5dGVzKHRleHQubGVuZ3RoKX0gZmVlZGApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIHBpZWNlcy5qb2luKCcgJykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sU3VtbWFyeVRleHQgPSBgJHtpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQgPiAxID8gJ1BvZGNhc3QgZmVlZCcgOiAnRmVlZCd9IHN0cnVjdHVyZWA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGlSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdTdHJpbmcgPSAoc2V0KT0+WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5tYXAoKHYpPT5gPHBvZGNhc3Q6JHt2fT5gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmpvaW4oJywgJykKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgRm91bmQgJHt1bml0U3RyaW5nKGtub3duUGlUYWdzLnNpemUsICdwb2RjYXN0IG5hbWVzcGFjZSB0YWcnKX06ICR7dGFnU3RyaW5nKGtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgRm91bmQgJHt1bml0U3RyaW5nKHVua25vd25QaVRhZ3Muc2l6ZSwgJ3Vua25vd24gcG9kY2FzdCBuYW1lc3BhY2UgdGFnJyl9OiAke3RhZ1N0cmluZyh1bmtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlzc3BlbGxlZE5hbWVzcGFjZXMgPSBzZXRJbnRlcnNlY3QocGlOYW1lc3BhY2VVcmlzLCBuZXcgU2V0KFFuYW1lcy5Qb2RjYXN0SW5kZXguS05PV05fTUlTU1BFTExFRF9OQU1FU1BBQ0VTKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaXNzcGVsbGVkTmFtZXNwYWNlcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjcnNzLW5hbWVzcGFjZS1leHRlbnNpb24tZm9yLXBvZGNhc3RpbmctdGFnLXNwZWNpZmljYXRpb24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgRm91bmQgJHt1bml0U3RyaW5nKG1pc3NwZWxsZWROYW1lc3BhY2VzLnNpemUsICdtaXNzcGVsbGVkIHBvZGNhc3QgbmFtZXNwYWNlIHVyaScpfTogJHtbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ubWlzc3BlbGxlZE5hbWVzcGFjZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbignLCAnKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeG1sICYmIE9iamVjdC5rZXlzKHhtbCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgam9iLnhtbCA9IHhtbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi54bWxTdW1tYXJ5VGV4dCA9IHhtbFN1bW1hcnlUZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgaGFzQ29tbWVudHMgPSBhY3Rpdml0eVB1YiB8fCBsaWdodG5pbmdDb21tZW50cyB8fCB0d2l0dGVyOwogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVDb21tZW50cyA9IGpvYi5vcHRpb25zLnZhbGlkYXRlQ29tbWVudHMgIT09IHVuZGVmaW5lZCA/IGpvYi5vcHRpb25zLnZhbGlkYXRlQ29tbWVudHMgOiB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGhhc0NvbW1lbnRzICYmICF2YWxpZGF0ZUNvbW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdDb21tZW50cyB2YWxpZGF0aW9uIGRpc2FibGVkLCBub3QgZmV0Y2hpbmcgY29tbWVudHMnKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoaGFzQ29tbWVudHMpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZXN1bHRzID0gW107CiAgICAgICAgICAgICAgICAgICAgaWYgKGFjdGl2aXR5UHViKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHNldFN0YXR1cyhgVmFsaWRhdGluZyBBY3Rpdml0eVB1YiBmb3IgJHthY3Rpdml0eVB1Yi5zdWJqZWN0fWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYWN0aXZpdHlQdWIudXJsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZldGNoaW5nIEFjdGl2aXR5UHViIGNvbW1lbnRzJywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBhY3Rpdml0eVB1Yi51cmwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtlZXBHb2luZyA9ICgpPT4ham9iLmRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdGVPbmx5T3JpZ2lucyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZVVzZVNpZGUgPSAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZU9ubHlPcmlnaW5zLmhhcyhuZXcgVVJMKHVybCkub3JpZ2luKSA/ICdyZW1vdGUnIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHlQdWJDYWxscyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoQWN0aXZpdHlQdWJPck1hc3RvZG9uID0gYXN5bmMgKHVybCwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgaGVhZGVycyAgfSA9IG9wdHMgfHwge307CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBsb2NhbE9yUmVtb3RlRmV0Y2hGdW5jdGlvbiA9IGhlYWRlcnMgJiYgaGVhZGVycy5hY2NlcHQgPT09ICdhcHBsaWNhdGlvbi9qc29uJyA/IGxvY2FsT3JSZW1vdGVGZXRjaEpzb24gOiBsb2NhbE9yUmVtb3RlRmV0Y2hBY3Rpdml0eVB1YjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCB7IHJlc3BvbnNlICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaEZ1bmN0aW9uKHVybCwgZmV0Y2hlcnMsIGNvbXB1dGVVc2VTaWRlKHVybCksIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9iaiA9IGF3YWl0IHJlc3BvbnNlLmNsb25lKCkuanNvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoJy9hcGkvdjEvc3RhdHVzZXMnKSAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBvYmoudXJpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcmVzcG9uc2U6IHJlc3BvbnNlMiAsIHNpZGU6IHNpZGUyICB9ID0gYXdhaXQgbG9jYWxPclJlbW90ZUZldGNoRnVuY3Rpb24odXJsLCBmZXRjaGVycywgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVzcG9uc2UgPSByZXNwb25zZTIuY2xvbmUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmogPSBhd2FpdCByZXNwb25zZTIuanNvbigpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGUgPSBzaWRlMjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gbmV3IFVSTCh1cmwpLm9yaWdpbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbW90ZU9ubHlPcmlnaW5zLmhhcyhvcmlnaW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgTG9jYWwgZmV0Y2ggZmFpbGVkIChDT1JTIGRpc2FibGVkPylgLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWc6ICdjb3JzJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlT25seU9yaWdpbnMuYWRkKG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWJDYWxscysrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uRXZlbnQ6IChldmVudCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoZXZlbnQua2luZCA9PT0gJ3dhcm5pbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbWVzc2FnZSAsIHVybCAgfSA9IGV2ZW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgbWVzc2FnZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZXZlbnQua2luZCA9PT0gJ25vZGUtcHJvY2Vzc2VkJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2IuY29tbWVudHNSZXN1bHRzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucmVzdWx0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRjYXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogYWN0aXZpdHlQdWIuc3ViamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ2NhbGxiYWNrcy5ldmVudCcsIGV2ZW50KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoZXIgPSBtYWtlUmF0ZUxpbWl0ZWRGZXRjaGVyKGZldGNoQWN0aXZpdHlQdWJPck1hc3RvZG9uLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3MKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhY2hlID0gbmV3IEluTWVtb3J5Q2FjaGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXNlckFnZW50ID0gdGhpcy50aHJlYWRjYXBVc2VyQWdlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRocmVhZGNhcCA9IGF3YWl0IG1ha2VUaHJlYWRjYXAoYWN0aXZpdHlQdWIudXJsLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyQWdlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZXRjaGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBhY3Rpdml0eVB1Yi5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlVGltZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdXBkYXRlVGhyZWFkY2FwKHRocmVhZGNhcCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlVGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBHb2luZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJBZ2VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGBGb3VuZCAke3VuaXRTdHJpbmcoT2JqZWN0LnZhbHVlcyh0aHJlYWRjYXAubm9kZXMpLmZpbHRlcigodik9PnYuY29tbWVudAogICAgICAgICAgICAgICAgICAgICAgICApLmxlbmd0aCwgJ2NvbW1lbnQnKX0gYW5kICR7dW5pdFN0cmluZyhPYmplY3Qua2V5cyh0aHJlYWRjYXAuY29tbWVudGVycykubGVuZ3RoLCAncGFydGljaXBhbnQnKX0sIG1hZGUgJHt1bml0U3RyaW5nKGFjdGl2aXR5UHViQ2FsbHMsICdBY3Rpdml0eVB1YiBjYWxsJyl9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBhY3Rpdml0eVB1Yi5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgcmVzdWx0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6IGFjdGl2aXR5UHViLnN1YmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChsaWdodG5pbmdDb21tZW50cykgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoYFZhbGlkYXRpbmcgTGlnaHRuaW5nIENvbW1lbnRzIGZvciAke2xpZ2h0bmluZ0NvbW1lbnRzLnN1YmplY3R9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBsaWdodG5pbmdDb21tZW50cy51cmwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnRmV0Y2hpbmcgTGlnaHRuaW5nIGNvbW1lbnRzJywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBsaWdodG5pbmdDb21tZW50cy51cmwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtlZXBHb2luZyA9ICgpPT4ham9iLmRvbmUKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdGVPbmx5T3JpZ2lucyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZVVzZVNpZGUgPSAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZU9ubHlPcmlnaW5zLmhhcyhuZXcgVVJMKHVybCkub3JpZ2luKSA/ICdyZW1vdGUnIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbGlnaHRuaW5nQ29tbWVudHNDYWxscyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoTGlnaHRuaW5nQ29tbWVudHMgPSBhc3luYyAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hKc29uKHVybCwgZmV0Y2hlcnMsIGNvbXB1dGVVc2VTaWRlKHVybCksIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgcmVzcG9uc2UuY2xvbmUoKS5qc29uKCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gbmV3IFVSTCh1cmwpLm9yaWdpbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbW90ZU9ubHlPcmlnaW5zLmhhcyhvcmlnaW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgTG9jYWwganNvbiBmZXRjaCBmYWlsZWQgKENPUlMgZGlzYWJsZWQ/KWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZzogJ2NvcnMnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVPbmx5T3JpZ2lucy5hZGQob3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaWdodG5pbmdDb21tZW50c0NhbGxzKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25FdmVudDogKGV2ZW50KT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5raW5kID09PSAnd2FybmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBtZXNzYWdlICwgdXJsICB9ID0gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBtZXNzYWdlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5raW5kID09PSAnbm9kZS1wcm9jZXNzZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBsaWdodG5pbmdDb21tZW50cy5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY2FsbGJhY2tzLmV2ZW50JywgZXZlbnQpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hlciA9IG1ha2VSYXRlTGltaXRlZEZldGNoZXIoZmV0Y2hMaWdodG5pbmdDb21tZW50cywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWNoZSA9IG5ldyBJbk1lbW9yeUNhY2hlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IHRoaXMudGhyZWFkY2FwVXNlckFnZW50OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJlYWRjYXAgPSBhd2FpdCBtYWtlVGhyZWFkY2FwKGxpZ2h0bmluZ0NvbW1lbnRzLnVybCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlckFnZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmV0Y2hlciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhY2hlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgcHJvdG9jb2w6ICdsaWdodG5pbmdjb21tZW50cycKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBsaWdodG5pbmdDb21tZW50cy5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlVGltZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdXBkYXRlVGhyZWFkY2FwKHRocmVhZGNhcCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlVGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBHb2luZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJBZ2VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGBGb3VuZCAke3VuaXRTdHJpbmcoT2JqZWN0LnZhbHVlcyh0aHJlYWRjYXAubm9kZXMpLmZpbHRlcigodik9PnYuY29tbWVudAogICAgICAgICAgICAgICAgICAgICAgICApLmxlbmd0aCwgJ2NvbW1lbnQnKX0gYW5kICR7dW5pdFN0cmluZyhPYmplY3Qua2V5cyh0aHJlYWRjYXAuY29tbWVudGVycykubGVuZ3RoLCAncGFydGljaXBhbnQnKX0sIG1hZGUgJHt1bml0U3RyaW5nKGxpZ2h0bmluZ0NvbW1lbnRzQ2FsbHMsICdMaWdodG5pbmcgQ29tbWVudHMgY2FsbCcpfWApOwogICAgICAgICAgICAgICAgICAgICAgICBqb2IuY29tbWVudHNSZXN1bHRzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucmVzdWx0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRjYXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogbGlnaHRuaW5nQ29tbWVudHMuc3ViamVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHJlc3VsdHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRjYXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBsaWdodG5pbmdDb21tZW50cy5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodHdpdHRlcikgewogICAgICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoYFZhbGlkYXRpbmcgVHdpdHRlciBDb21tZW50cyBmb3IgJHt0d2l0dGVyLnN1YmplY3R9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB0d2l0dGVyLnVybAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGZXRjaGluZyBUd2l0dGVyIGNvbW1lbnRzJywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiB0d2l0dGVyLnVybAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qga2VlcEdvaW5nID0gKCk9PiFqb2IuZG9uZQogICAgICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB0d2l0dGVyQ29tbWVudHNDYWxscyA9IDA7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoVHdpdHRlckNvbW1lbnRzID0gYXN5bmMgKHVybCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgcmVzcG9uc2UgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hKc29uKHVybCwgZmV0Y2hlcnMsICdyZW1vdGUnLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR3aXR0ZXJDb21tZW50c0NhbGxzKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25FdmVudDogKGV2ZW50KT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChldmVudC5raW5kID09PSAnd2FybmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBtZXNzYWdlICwgdXJsICB9ID0gZXZlbnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBtZXNzYWdlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChldmVudC5raW5kID09PSAnbm9kZS1wcm9jZXNzZWQnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiB0d2l0dGVyLnN1YmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdjYWxsYmFja3MuZXZlbnQnLCBldmVudCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBmZXRjaGVyID0gbWFrZVJhdGVMaW1pdGVkRmV0Y2hlcihmZXRjaFR3aXR0ZXJDb21tZW50cywgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWNoZSA9IG5ldyBJbk1lbW9yeUNhY2hlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVzZXJBZ2VudCA9IHRoaXMudGhyZWFkY2FwVXNlckFnZW50OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aHJlYWRjYXAgPSBhd2FpdCBtYWtlVGhyZWFkY2FwKHR3aXR0ZXIudXJsLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1c2VyQWdlbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZXRjaGVyLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FjaGUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwcm90b2NvbDogJ3R3aXR0ZXInCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBqb2IuY29tbWVudHNSZXN1bHRzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ucmVzdWx0cywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aHJlYWRjYXAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogdHdpdHRlci5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdXBkYXRlVGltZSA9IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKTsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgdXBkYXRlVGhyZWFkY2FwKHRocmVhZGNhcCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlVGltZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBHb2luZywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVzZXJBZ2VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYWNoZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGBGb3VuZCAke3VuaXRTdHJpbmcoT2JqZWN0LnZhbHVlcyh0aHJlYWRjYXAubm9kZXMpLmZpbHRlcigodik9PnYuY29tbWVudAogICAgICAgICAgICAgICAgICAgICAgICApLmxlbmd0aCwgJ2NvbW1lbnQnKX0gYW5kICR7dW5pdFN0cmluZyhPYmplY3Qua2V5cyh0aHJlYWRjYXAuY29tbWVudGVycykubGVuZ3RoLCAncGFydGljaXBhbnQnKX0sIG1hZGUgJHt1bml0U3RyaW5nKHR3aXR0ZXJDb21tZW50c0NhbGxzLCAnVHdpdHRlciBDb21tZW50cyBjYWxsJyl9YCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5jb21tZW50c1Jlc3VsdHMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5yZXN1bHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRocmVhZGNhcCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiB0d2l0dGVyLnN1YmplY3QKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICByZXN1bHRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyZWFkY2FwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogdHdpdHRlci5zdWJqZWN0CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpvYi5zZWFyY2ggPSB0cnVlOwogICAgICAgICAgICAgICAgc2V0U3RhdHVzKCdTZWFyY2hpbmcnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFJlc3BvbnNlID0gYXdhaXQgcGlTZWFyY2hGZXRjaGVyMihpbnB1dCwgaGVhZGVyczEpOwogICAgICAgICAgICAgICAgY2hlY2tFcXVhbCgnc2VhcmNoUmVzcG9uc2Uuc3RhdHVzJywgc2VhcmNoUmVzcG9uc2Uuc3RhdHVzLCAyMDApOwogICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gYXdhaXQgc2VhcmNoUmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgaWYgKHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnNlYXJjaFJlc3VsdHMucHVzaCguLi5zZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQuZmVlZHMuc2xpY2UoMCwgMjApKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1JlYWRvbmx5QXJyYXkoc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQuZmVlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlV2l0aFVybCA9IHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0LmZlZWQudXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIGUubWVzc2FnZSk7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgYCR7am9iLnNlYXJjaCA/ICdTZWFyY2ggdG9vaycgOiAnVG9vayd9ICR7Zm9ybWF0VGltZShEYXRlLm5vdygpIC0gam9iU3RhcnQpfSR7Y29tcHV0ZUpvYlRpbWVzU3RyaW5nU3VmZml4KGpvYi50aW1lcyl9YCk7CiAgICAgICAgICAgIGlmIChjb250aW51ZVdpdGhVcmwpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGludWVXaXRoKGNvbnRpbnVlV2l0aFVybCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqb2IuZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBqb2IuY2FuY2VsbGVkID8gJ0NhbmNlbGxlZCcgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMCA/ICdGb3VuZCBubyBwb2RjYXN0cycgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMSA/ICdGb3VuZCBvbmUgcG9kY2FzdCwgc2VsZWN0IHRvIGNvbnRpbnVlJyA6IGpvYi5zZWFyY2ggPyBgRm91bmQgJHtqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGh9IHBvZGNhc3RzLCBzZWxlY3Qgb25lIHRvIGNvbnRpbnVlYCA6ICdEb25lJzsKICAgICAgICAgICAgICAgIHNldFN0YXR1cyhzdGF0dXMsIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZG9uZScKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGZvcm1hdFRpbWUobWlsbGlzKSB7CiAgICBpZiAobWlsbGlzIDwgMTAwMCkgcmV0dXJuIGAke21pbGxpc31tc2A7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChtaWxsaXMgLyAxMDAwICogMTAwKSAvIDEwMH1zYDsKfQpmdW5jdGlvbiBjb21wdXRlSm9iVGltZXNTdHJpbmdTdWZmaXgodGltZXMpIHsKICAgIGNvbnN0IHJ0ID0gWwogICAgICAgIFsKICAgICAgICAgICAgJ2ZldGNoJywKICAgICAgICAgICAgdGltZXMuZmV0Y2hUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdyZWFkJywKICAgICAgICAgICAgdGltZXMucmVhZFRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ3BhcnNlJywKICAgICAgICAgICAgdGltZXMucGFyc2VUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICd2YWxpZGF0ZScsCiAgICAgICAgICAgIHRpbWVzLnZhbGlkYXRlVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAnY29tbWVudHMnLAogICAgICAgICAgICB0aW1lcy5jb21tZW50c1RpbWUKICAgICAgICBdCiAgICBdLmZpbHRlcigodik9PnZbMV0gIT09IHVuZGVmaW5lZAogICAgKS5tYXAoKHYpPT5gJHt2WzBdfT0ke2Zvcm1hdFRpbWUodlsxXSl9YAogICAgKS5qb2luKCcsICcpOwogICAgcmV0dXJuIHJ0ID09PSAnJyA/ICcnIDogYCAoJHtydH0pYDsKfQpmdW5jdGlvbiBmb3JtYXRCeXRlcyhieXRlcykgewogICAgbGV0IGFtb3VudCA9IGJ5dGVzOwogICAgaWYgKGFtb3VudCA8IDEwMjQpIHJldHVybiBgJHthbW91bnR9LWJ5dGVgOwogICAgYW1vdW50ID0gYW1vdW50IC8gMTAyNDsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfWtiYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfW1iYDsKfQpmdW5jdGlvbiB1bml0U3RyaW5nKGFtb3VudCwgdW5pdCkgewogICAgcmV0dXJuIGAke2Ftb3VudCA9PT0gMCA/ICdubycgOiBhbW91bnQgPT09IDEgPyAnb25lJyA6IG5ldyBJbnRsLk51bWJlckZvcm1hdCgpLmZvcm1hdChhbW91bnQpfSAke3VuaXR9JHthbW91bnQgPT09IDEgPyAnJyA6ICdzJ31gOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZUlucHV0KGlucHV0KSB7CiAgICBpbnB1dCA9IGlucHV0LnRyaW0oKTsKICAgIGNvbnN0IG0gPSAvXmh0dHBzOlwvXC9wb2RjYXN0c1wuYXBwbGVcLmNvbVwvLio/KGlkXGQrKSQvLmV4ZWMoaW5wdXQpOwogICAgaWYgKG0pIHJldHVybiBtWzFdOwogICAgcmV0dXJuIGlucHV0Owp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsMSh1cmwpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwodXJsKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIHNsZWVwMShtcykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKT0+c2V0VGltZW91dChyZXNvbHZlLCBtcykKICAgICk7Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoQWN0aXZpdHlQdWIodXJsLCBmZXRjaGVycywgdXNlU2lkZSwgc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMpIHsKICAgIGlmIChzbGVlcE1pbGxpc0JldHdlZW5DYWxscyA+IDApIGF3YWl0IHNsZWVwMShzbGVlcE1pbGxpc0JldHdlZW5DYWxscyk7CiAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICBmZXRjaGVycywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicKICAgICAgICB9LAogICAgICAgIHVzZVNpZGUKICAgIH0pOwogICAgY2hlY2tFcXVhbCgncmVzLnN0YXR1cycsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5yZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKSk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgIGlmICghKGNvbnRlbnRUeXBlIHx8ICcnKS5pbmNsdWRlcygnanNvbicpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCBodG1sLCBub3QgQWN0aXZpdHlQdWInKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgc2lkZQogICAgfTsKfQphc3luYyBmdW5jdGlvbiBsb2NhbE9yUmVtb3RlRmV0Y2hKc29uKHVybCwgZmV0Y2hlcnMsIHVzZVNpZGUsIHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzKSB7CiAgICBpZiAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMgPiAwKSBhd2FpdCBzbGVlcDEoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMpOwogICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCB7CiAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2pzb24nCiAgICAgICAgfSwKICAgICAgICB1c2VTaWRlCiAgICB9KTsKICAgIGNoZWNrRXF1YWwoJ3Jlcy5zdGF0dXMnLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4ucmVzcG9uc2UuaGVhZGVycwogICAgXS5tYXAoKHYpPT52LmpvaW4oJzogJykKICAgICkpOwogICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICBpZiAoIShjb250ZW50VHlwZSB8fCAnJykuaW5jbHVkZXMoJ2pzb24nKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRm91bmQgaHRtbCwgbm90IGpzb24nKTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgcmVzcG9uc2UsCiAgICAgICAgc2lkZQogICAgfTsKfQphc3luYyBmdW5jdGlvbiBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoZXJzICwgaGVhZGVycyAsIHVzZVNpZGUgIH0gPSBvcHRzOwogICAgaWYgKHVzZVNpZGUgIT09ICdyZW1vdGUnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc29sZS5sb2coYGxvY2FsIGZldGNoOiAke3VybH1gKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoZXJzLmxvY2FsRmV0Y2hlcih1cmwsIGhlYWRlcnMpOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZmV0Y2hUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnQsCiAgICAgICAgICAgICAgICBzaWRlOiAnbG9jYWwnLAogICAgICAgICAgICAgICAgcmVzcG9uc2UKICAgICAgICAgICAgfTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gbG9jYWwgZmV0Y2gsIHRyeWluZyByZW1vdGUnLCBlKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zb2xlLmxvZyhgcmVtb3RlIGZldGNoOiAke3VybH1gKTsKICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2hlcnMucmVtb3RlRmV0Y2hlcih1cmwsIGhlYWRlcnMpOwogICAgcmV0dXJuIHsKICAgICAgICBmZXRjaFRpbWU6IERhdGUubm93KCkgLSBzdGFydCwKICAgICAgICBzaWRlOiAncmVtb3RlJywKICAgICAgICByZXNwb25zZQogICAgfTsKfQpmdW5jdGlvbiBmaW5kRXBpc29kZVRpdGxlKHNvY2lhbEludGVyYWN0KSB7CiAgICBjb25zdCBpdGVtID0gc29jaWFsSW50ZXJhY3QucGFyZW50OwogICAgaWYgKGl0ZW0pIHsKICAgICAgICBjb25zdCB0aXRsZSA9IGl0ZW0uY2hpbGRbJ3RpdGxlJ107CiAgICAgICAgaWYgKHRpdGxlLmxlbmd0aCA+IDAgJiYgdGl0bGVbMF0udmFsKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRpdGxlWzBdLnZhbC50cmltKCk7CiAgICAgICAgICAgIGlmICh2YWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gaXNPYXV0aE9idGFpblRva2VuUmVzcG9uc2Uob2JqKSB7CiAgICByZXR1cm4gaXNTdHJpbmdSZWNvcmQob2JqKSAmJiB0eXBlb2Ygb2JqLmFjY2Vzc190b2tlbiA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai50b2tlbl90eXBlID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLnNjb3BlID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLmNyZWF0ZWRfYXQgPT09ICdudW1iZXInOwp9CmNvbnN0IEFQUExJQ0FUSU9OX0pTT05fQ0hBUlNFVF9VVEY4ID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnOwphc3luYyBmdW5jdGlvbiB2ZXJpZnlKc29uUmVzcG9uc2UocmVzLCBib2R5VmVyaWZpZXIpIHsKICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBodHRwIHJlc3BvbnNlIHN0YXR1czogJHtyZXMuc3RhdHVzfSwgZXhwZWN0ZWQgMjAwLCBib2R5PSR7YXdhaXQgcmVzLnRleHQoKX1gKTsKICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzLmhlYWRlcnMuZ2V0KCdjb250ZW50LXR5cGUnKTsKICAgIGlmIChjb250ZW50VHlwZSAhPT0gQVBQTElDQVRJT05fSlNPTl9DSEFSU0VUX1VURjgpIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBodHRwIHJlc3BvbnNlIHN0YXR1czogJHtjb250ZW50VHlwZX0sIGV4cGVjdGVkICR7QVBQTElDQVRJT05fSlNPTl9DSEFSU0VUX1VURjh9LCBib2R5PSR7YXdhaXQgcmVzLnRleHQoKX1gKTsKICAgIGNvbnN0IGJvZHkgPSBhd2FpdCByZXMuanNvbigpOwogICAgaWYgKCFib2R5VmVyaWZpZXIoYm9keSkpIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBib2R5OiAke0pTT04uc3RyaW5naWZ5KGJvZHksIHVuZGVmaW5lZCwgMil9YCk7CiAgICByZXR1cm4gYm9keTsKfQphc3luYyBmdW5jdGlvbiBzdGF0dXNlc1B1Ymxpc2goYXBpQmFzZSwgYWNjZXNzVG9rZW4sIG9wdHMpIHsKICAgIGNvbnN0IHsgaWRlbXBvdGVuY3lLZXkgLCBzdGF0dXMgLCBpbl9yZXBseV90b19pZCAsIHZpc2liaWxpdHkgIH0gPSBvcHRzOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CiAgICBoZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gKTsKICAgIGlmIChpZGVtcG90ZW5jeUtleSkgaGVhZGVycy5zZXQoJ0lkZW1wb3RlbmN5LUtleScsIGlkZW1wb3RlbmN5S2V5KTsKICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTsKICAgIGRhdGEuc2V0KCdzdGF0dXMnLCBzdGF0dXMpOwogICAgaWYgKGluX3JlcGx5X3RvX2lkKSBkYXRhLnNldCgnaW5fcmVwbHlfdG9faWQnLCBpbl9yZXBseV90b19pZCk7CiAgICBpZiAodmlzaWJpbGl0eSkgZGF0YS5zZXQoJ3Zpc2liaWxpdHknLCB2aXNpYmlsaXR5KTsKICAgIGNvbnN0IHJlcyA9IGF3YWl0IGZldGNoKGAke2FwaUJhc2V9L2FwaS92MS9zdGF0dXNlc2AsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBib2R5OiBkYXRhLAogICAgICAgIGhlYWRlcnMKICAgIH0pOwogICAgcmV0dXJuIHZlcmlmeUpzb25SZXNwb25zZShyZXMsIGlzU3RhdHVzKTsKfQpmdW5jdGlvbiBpc1N0YXR1cyhvYmopIHsKICAgIHJldHVybiBpc1N0cmluZ1JlY29yZChvYmopICYmIHR5cGVvZiBvYmouaWQgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmoudXJpID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLmNyZWF0ZWRfYXQgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmouY29udGVudCA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai52aXNpYmlsaXR5ID09PSAnc3RyaW5nJyAmJiAob2JqLnVybCA9PT0gdW5kZWZpbmVkIHx8IHR5cGVvZiBvYmoudXJsID09PSAnc3RyaW5nJykgJiYgKG9iai5pbl9yZXBseV90b19pZCA9PT0gdW5kZWZpbmVkIHx8IG9iai5pbl9yZXBseV90b19pZCA9PT0gbnVsbCB8fCB0eXBlb2Ygb2JqLmluX3JlcGx5X3RvX2lkID09PSAnc3RyaW5nJyk7Cn0KY2xhc3MgVmFsaWRhdG9yQXBwVk0gewogICAgam9iOwogICAgZ2V0IHZhbGlkYXRpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLnZhbGlkYXRpbmc7CiAgICB9CiAgICBnZXQgbWVzc2FnZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLm1lc3NhZ2VzOwogICAgfQogICAgZ2V0IGlzU2VhcmNoKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi5pc1NlYXJjaDsKICAgIH0KICAgIGdldCBzZWFyY2hSZXN1bHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi5zZWFyY2hSZXN1bHRzOwogICAgfQogICAgZ2V0IHhtbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IueG1sOwogICAgfQogICAgZ2V0IHhtbFN1bW1hcnlUZXh0KCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi54bWxTdW1tYXJ5VGV4dDsKICAgIH0KICAgIGdldCBjb21tZW50c1Jlc3VsdHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLmNvbW1lbnRzUmVzdWx0czsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9wdHMpewogICAgICAgIHRoaXMuam9iID0gbmV3IFZhbGlkYXRpb25Kb2JWTShvcHRzKTsKICAgICAgICB0aGlzLmpvYi5vbkNoYW5nZSA9ICgpPT50aGlzLm9uQ2hhbmdlKCkKICAgICAgICA7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57fTsKICAgIHN0YXJ0KCkge30KICAgIGNvbnRpbnVlV2l0aCh1cmwpIHsKICAgICAgICB0aGlzLmpvYi5jb250aW51ZVdpdGgodXJsKTsKICAgIH0KICAgIHN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgIHRoaXMuam9iLnN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucyk7CiAgICB9CiAgICBjYW5jZWxWYWxpZGF0aW9uKCkgewogICAgICAgIHRoaXMuam9iLmNhbmNlbFZhbGlkYXRpb24oKTsKICAgIH0KICAgIGlzTG9nZ2VkSW4ob3JpZ2luKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IGxvYWRMb2dpbkluZm8ob3JpZ2luKTsKICAgICAgICByZXR1cm4gaW5mbyAhPT0gdW5kZWZpbmVkICYmICFjb21wdXRlRXhwaXJlZChpbmZvLnRva2VuUmVzcG9uc2UpOwogICAgfQogICAgYWNjZXB0TG9naW4ob3JpZ2luLCB0b2tlblJlc3BvbnNlKSB7CiAgICAgICAgY2hlY2tFcXVhbCgndG9rZW5fdHlwZScsIHRva2VuUmVzcG9uc2UudG9rZW5fdHlwZS50b0xvd2VyQ2FzZSgpLCAnYmVhcmVyJyk7CiAgICAgICAgY2hlY2tUcnVlKCdjcmVhdGVkX2F0LCBleHBpcmVzX2luJywgWwogICAgICAgICAgICB0b2tlblJlc3BvbnNlLmNyZWF0ZWRfYXQsCiAgICAgICAgICAgIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbgogICAgICAgIF0uam9pbignLCAnKSwgIWNvbXB1dGVFeHBpcmVkKHRva2VuUmVzcG9uc2UpKTsKICAgICAgICBzYXZlTG9naW5JbmZvKHsKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICB0b2tlblJlc3BvbnNlCiAgICAgICAgfSk7CiAgICB9CiAgICBleHBpcmVMb2dpbihvcmlnaW4pIHsKICAgICAgICBkZWxldGVMb2dpbkluZm8ob3JpZ2luKTsKICAgIH0KICAgIGFzeW5jIHNlbmRSZXBseShyZXBseSwgcmVwbHlUb1VybCkgewogICAgICAgIHJlcGx5ID0gcmVwbHkudHJpbSgpOwogICAgICAgIGlmIChyZXBseSA9PT0gJycpIHRocm93IG5ldyBFcnJvcignQmFkIHJlcGx5OiA8ZW1wdHk+Jyk7CiAgICAgICAgY29uc3QgeyBvcmlnaW4gIH0gPSBuZXcgVVJMKHJlcGx5VG9VcmwpOwogICAgICAgIGNvbnN0IGluZm8gPSBsb2FkTG9naW5JbmZvKG9yaWdpbik7CiAgICAgICAgaWYgKCFpbmZvKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGxvZ2luIGZvciAke29yaWdpbn1gKTsKICAgICAgICBpZiAoY29tcHV0ZUV4cGlyZWQoaW5mby50b2tlblJlc3BvbnNlKSkgdGhyb3cgbmV3IEVycm9yKGBMb2dpbiBleHBpcmVkIGZvciAke29yaWdpbn1gKTsKICAgICAgICBjb25zb2xlLmxvZyhgcmVwbHlUb1VybGAsIHJlcGx5VG9VcmwpOwogICAgICAgIGNvbnN0IG1hc3RvZG9uSWQgPSBhd2FpdCBjb21wdXRlTWFzdG9kb25JZEZvclVybChyZXBseVRvVXJsLCBhc3luYyAodXJsLCBoZWFkZXJzKT0+ewogICAgICAgICAgICBjb25zdCB7IHJlc3BvbnNlICB9ID0gYXdhaXQgdGhpcy5qb2IuZmV0Y2godXJsLCB7CiAgICAgICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgfSk7CiAgICAgICAgY29uc29sZS5sb2coYG1hc3RvZG9uSWRgLCBtYXN0b2RvbklkKTsKICAgICAgICBjb25zdCB7IHVybDogdXJsMSAgfSA9IGF3YWl0IHN0YXR1c2VzUHVibGlzaChvcmlnaW4sIGluZm8udG9rZW5SZXNwb25zZS5hY2Nlc3NfdG9rZW4sIHsKICAgICAgICAgICAgc3RhdHVzOiByZXBseSwKICAgICAgICAgICAgaW5fcmVwbHlfdG9faWQ6IG1hc3RvZG9uSWQKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdXJsMTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRXhwaXJlZCh0b2tlblJlc3BvbnNlKSB7CiAgICByZXR1cm4gdHlwZW9mIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbiA9PT0gJ251bWJlcicgJiYgKHRva2VuUmVzcG9uc2UuY3JlYXRlZF9hdCArIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbikgKiAxMDAwIDw9IERhdGUubm93KCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pIHsKICAgIHJldHVybiBgbG9naW46JHtvcmlnaW59YDsKfQpmdW5jdGlvbiBsb2FkTG9naW5JbmZvKG9yaWdpbikgewogICAgY29uc3Qgc3RyID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pKTsKICAgIGNvbnN0IG9iaiA9IHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShzdHIpIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIGlzTG9naW5JbmZvKG9iaikgPyBvYmogOiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gc2F2ZUxvZ2luSW5mbyhpbmZvKSB7CiAgICBjb25zdCB7IG9yaWdpbiAgfSA9IGluZm87CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShjb21wdXRlTG9naW5JbmZvTG9jYWxTdG9yYWdlS2V5KG9yaWdpbiksIEpTT04uc3RyaW5naWZ5KGluZm8pKTsKfQpmdW5jdGlvbiBkZWxldGVMb2dpbkluZm8ob3JpZ2luKSB7CiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShjb21wdXRlTG9naW5JbmZvTG9jYWxTdG9yYWdlS2V5KG9yaWdpbikpOwp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVNYXN0b2RvbklkRm9yVXJsKHJlcGx5VG9VcmwsIGZldGNoZXIpIHsKICAgIGNvbnN0IHsgcGF0aG5hbWUgIH0gPSBuZXcgVVJMKHJlcGx5VG9VcmwpOwogICAgY29uc3QgbSA9IC9eXC8uKj9cLyhcZCspJC8uZXhlYyhwYXRobmFtZSk7CiAgICBpZiAobSkgcmV0dXJuIG1bMV07CiAgICBpZiAoL14uKj9cL29iamVjdHNcL1swLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvLnRlc3QobmV3IFVSTChyZXBseVRvVXJsKS5wYXRobmFtZSkpIHsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaGVyKHJlcGx5VG9VcmwsIHsKICAgICAgICAgICAgYWNjZXB0OiAndGV4dC9odG1sJwogICAgICAgIH0pOwogICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgQmFkIHN0YXR1cyAke3Jlcy5zdGF0dXN9LCBleHBlY3RlZCAyMDAgZm9yICR7cmVwbHlUb1VybH1gKTsKICAgICAgICBjb25zdCBtMiA9IC9eXC8uKj9cLyhbYS16QS1aMC05XSspJC8uZXhlYyhuZXcgVVJMKHJlcy51cmwpLnBhdGhuYW1lKTsKICAgICAgICBpZiAobTIpIHJldHVybiBtMlsxXTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgY29tcHV0ZU1hc3RvZG9uSWRGb3JVcmw6IHVuYWJsZSB0byBjb21wdXRlIGZvciAke3JlcGx5VG9Vcmx9YCk7Cn0KZnVuY3Rpb24gaXNMb2dpbkluZm8ob2JqKSB7CiAgICByZXR1cm4gaXNTdHJpbmdSZWNvcmQob2JqKSAmJiB0eXBlb2Ygb2JqLm9yaWdpbiA9PT0gJ3N0cmluZycgJiYgaXNPYXV0aE9idGFpblRva2VuUmVzcG9uc2Uob2JqLnRva2VuUmVzcG9uc2UpOwp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKY29uc3QgSU5GT19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnptMS05QzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHoiLz48L3N2Zz5gOwpjb25zdCBXQVJOSU5HX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PHBhdGggZD0iTTEyIDUuOTlMMTkuNTMgMTlINC40N0wxMiA1Ljk5TTIuNzQgMThjLS43NyAxLjMzLjE5IDMgMS43MyAzaDE1LjA2YzEuNTQgMCAyLjUtMS42NyAxLjczLTNMMTMuNzMgNC45OWMtLjc3LTEuMzMtMi42OS0xLjMzLTMuNDYgMEwyLjc0IDE4ek0xMSAxMXYyYzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMXYtMmMwLS41NS0uNDUtMS0xLTFzLTEgLjQ1LTEgMXptMCA1aDJ2MmgtMnoiLz48L3N2Zz5gOwpjb25zdCBFUlJPUl9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0yMC43MSA3Ljk4TDE2LjAzIDMuM2MtLjE5LS4xOS0uNDUtLjMtLjcxLS4zSDguNjhjLS4yNiAwLS41Mi4xMS0uNy4yOUwzLjI5IDcuOThjLS4xOC4xOC0uMjkuNDQtLjI5Ljd2Ni42M2MwIC4yNy4xMS41Mi4yOS43MWw0LjY4IDQuNjhjLjE5LjE5LjQ1LjMuNzEuM2g2LjYzYy4yNyAwIC41Mi0uMTEuNzEtLjI5bDQuNjgtNC42OGMuMTktLjE5LjI5LS40NC4yOS0uNzFWOC42OGMuMDEtLjI2LS4xLS41Mi0uMjgtLjd6TTE5IDE0LjlMMTQuOSAxOUg5LjFMNSAxNC45VjkuMUw5LjEgNWg1LjhMMTkgOS4xdjUuOHoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjE2IiByPSIxIi8+PHBhdGggZD0iTTEyIDdjLS41NSAwLTEgLjQ1LTEgMXY1YzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMVY4YzAtLjU1LS40NS0xLTEtMXoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHptMy44OC0xMS43MUwxMCAxNC4xN2wtMS44OC0xLjg4Yy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMC0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDIuNTkgMi41OWMuMzkuMzkgMS4wMi4zOSAxLjQxIDBMMTcuMyA5LjdjLjM5LS4zOS4zOS0xLjAyIDAtMS40MS0uMzktLjM5LTEuMDMtLjM5LTEuNDIgMHoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS0xJU1RfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik01LDVoMnYxYzAsMS4xLDAuOSwyLDIsMmg2YzEuMSwwLDItMC45LDItMlY1aDJ2NWgyVjVjMC0xLjEtMC45LTItMi0yaC00LjE4QzE0LjQsMS44NCwxMy4zLDEsMTIsMVM5LjYsMS44NCw5LjE4LDNINSBDMy45LDMsMywzLjksMyw1djE0YzAsMS4xLDAuOSwyLDIsMmg2di0ySDVWNXogTTEyLDNjMC41NSwwLDEsMC40NSwxLDFzLTAuNDUsMS0xLDFzLTEtMC40NS0xLTFTMTEuNDUsMywxMiwzeiIvPjxwYXRoIGQ9Ik0yMS43NSwxMi4yNWMtMC40MS0wLjQxLTEuMDktMC40MS0xLjUsMEwxNS41MSwxN2wtMi4yNi0yLjI1Yy0wLjQxLTAuNDEtMS4wOC0wLjQxLTEuNSwwbDAsMGMtMC40MSwwLjQxLTAuNDEsMS4wOSwwLDEuNSBsMy4wNSwzLjA0YzAuMzksMC4zOSwxLjAyLDAuMzksMS40MSwwbDUuNTMtNS41NEMyMi4xNiwxMy4zNCwyMi4xNiwxMi42NiwyMS43NSwxMi4yNXoiLz48L2c+PC9nPjwvc3ZnPmA7CmNvbnN0IFNRVUFSRV9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNCAyNCIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48Zz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjI0IiB3aWR0aD0iMjQiLz48L2c+PGc+PGc+PHBhdGggZD0iTTMsM3YxOGgxOFYzSDN6IE0xOSwxOUg1VjVoMTRWMTl6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBQRVJTT05fSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTIgMTJjMi4yMSAwIDQtMS43OSA0LTRzLTEuNzktNC00LTQtNCAxLjc5LTQgNCAxLjc5IDQgNCA0em0wIDJjLTIuNjcgMC04IDEuMzQtOCA0djFjMCAuNTUuNDUgMSAxIDFoMTRjLjU1IDAgMS0uNDUgMS0xdi0xYzAtMi42Ni01LjMzLTQtOC00eiIvPjwvc3ZnPmA7CmNvbnN0IEJPTFRfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxwYXRoIGQ9Ik0xMC42NywyMUwxMC42NywyMWMtMC4zNSwwLTAuNjItMC4zMS0wLjU3LTAuNjZMMTEsMTRINy41Yy0wLjg4LDAtMC4zMy0wLjc1LTAuMzEtMC43OGMxLjI2LTIuMjMsMy4xNS01LjUzLDUuNjUtOS45MyBjMC4xLTAuMTgsMC4zLTAuMjksMC41LTAuMjloMGMwLjM1LDAsMC42MiwwLjMxLDAuNTcsMC42NkwxMy4wMSwxMGgzLjUxYzAuNCwwLDAuNjIsMC4xOSwwLjQsMC42NmMtMy4yOSw1Ljc0LTUuMiw5LjA5LTUuNzUsMTAuMDUgQzExLjA3LDIwLjg5LDEwLjg4LDIxLDEwLjY3LDIxeiIvPjwvZz48L3N2Zz5gOwpmdW5jdGlvbiBleHRlcm5hbGl6ZUFuY2hvcihhbmNob3IpIHsKICAgIGFuY2hvci50YXJnZXQgPSAnX2JsYW5rJzsKICAgIGFuY2hvci5yZWwgPSAnbm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyc7Cn0KY29uc3QgQ09NTUVOVFNfSFRNTCA9IGh0bWxgCjxkZXRhaWxzIGlkPSJjb21tZW50cy1kZXRhaWxzIiBvcGVuPgogICAgPHN1bW1hcnk+Q29tbWVudHMgZm9yIDxzcGFuIGlkPSJjb21tZW50cy1zdWJqZWN0Ij5zdWJqZWN0PC9zcGFuPjwvc3VtbWFyeT4KICAgIDxvdXRwdXQgaWQ9ImNvbW1lbnRzIj48L291dHB1dD4KPC9kZXRhaWxzPgpgOwpjb25zdCBDT01NRU5UU19DU1MgPSBjc3NgCgojY29tbWVudHMtZGV0YWlscyB7CiAgICBkaXNwbGF5OiBub25lOwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIG1heC13aWR0aDogMTAwJTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5jb21tZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICBsaW5lLWhlaWdodDogMS41Owp9CgouY29tbWVudCAuaWNvbiB7CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBib3JkZXItcmFkaXVzOiAwLjVlbTsKICAgIG1hcmdpbjogMC43NWVtIDFlbSAxZW0gMDsKfQoKLmNvbW1lbnQgZGl2Lmljb24gewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKfQoKLmNvbW1lbnQgZGl2Lmljb24gc3ZnIHsKICAgIHdpZHRoOiAyNHB4OwogICAgaGVpZ2h0OiAyNHB4Owp9CgouY29tbWVudCBkaXYuZXJyb3IuaWNvbiBzdmcgewogICAgZmlsbDogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yRXJyb3JIZXgpfTsKfQoKLmNvbW1lbnQgZGl2LmRlZmF1bHQuaWNvbiBzdmcgewogICAgZmlsbDogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0KCi5jb21tZW50IC5yaHMgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMCAwOwogICAgZmxleC1ncm93OiAxOwp9CgouY29tbWVudCAuaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNWVtOwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAuaGVhZGVyIC51cmwgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAucmhzIHAgewogICAgbWFyZ2luLWJsb2NrLXN0YXJ0OiAwZW07CiAgICBtYXJnaW4tYmxvY2stZW5kOiAwZW07Cn0KCi5jb21tZW50IGltZyB7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICB3aWR0aDogYXV0bzsKICAgIGhlaWdodDogYXV0bzsKfQoKZGV0YWlscy5lcnJvciB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yRXJyb3JIZXgpfTsKfQoKLnJlcGx5IGZpZWxkc2V0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYm9yZGVyOiBzb2xpZCAxcHggJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0gCgoucmVwbHkgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS5iYWNrZ3JvdW5kQ29sb3JIZXgpfTsKICAgIG1hcmdpbi10b3A6IDAuNXJlbTsKfQoKLnJlcGx5IGJ1dHRvbiB7CiAgICBwYWRkaW5nOiAwLjI1cmVtIDJyZW07CiAgICBhbGlnbi1zZWxmOiBmbGV4LWVuZDsKICAgIG1hcmdpbjogMC41cmVtIDA7Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb21tZW50cyhkb2N1bWVudCwgdm0xKSB7CiAgICBjb25zdCBjb21tZW50c0RldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtZGV0YWlscycpOwogICAgY29uc3QgY29tbWVudHNTdWJqZWN0U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cy1zdWJqZWN0Jyk7CiAgICBjb25zdCBjb21tZW50c091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3QgcmVzdWx0cyA9IHZtMS5jb21tZW50c1Jlc3VsdHM7CiAgICAgICAgY29tbWVudHNEZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSByZXN1bHRzID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb21tZW50c1N1YmplY3RTcGFuLnRleHRDb250ZW50ID0gcmVzdWx0cyAmJiByZXN1bHRzWzBdID8gcmVzdWx0cyAmJiByZXN1bHRzWzBdLnN1YmplY3QgOiAnc3ViamVjdCc7CiAgICAgICAgaWYgKHJlc3VsdHMgIT09IF9yZW5kZXJlZFJlc3VsdHMpIHsKICAgICAgICAgICAgcmVuZGVyQ29tbWVudHMocmVzdWx0cywgY29tbWVudHNPdXRwdXQsIHZtMSk7CiAgICAgICAgICAgIF9yZW5kZXJlZFJlc3VsdHMgPSByZXN1bHRzOwogICAgICAgIH0KICAgIH07Cn0KbGV0IF9yZW5kZXJlZFJlc3VsdHM7CmZ1bmN0aW9uIHJlbmRlckNvbW1lbnRzKHJlc3VsdHMsIGNvbW1lbnRzT3V0cHV0LCB2bTIpIHsKICAgIHdoaWxlKGNvbW1lbnRzT3V0cHV0LmZpcnN0Q2hpbGQpY29tbWVudHNPdXRwdXQucmVtb3ZlQ2hpbGQoY29tbWVudHNPdXRwdXQuZmlyc3RDaGlsZCk7CiAgICBpZiAocmVzdWx0cykgewogICAgICAgIGZvciAoY29uc3QgcmVzdWx0IG9mIHJlc3VsdHMpewogICAgICAgICAgICBmb3IgKGNvbnN0IHJvb3Qgb2YgcmVzdWx0LnRocmVhZGNhcC5yb290cyl7CiAgICAgICAgICAgICAgICByZW5kZXJOb2RlKHJvb3QsIHJlc3VsdC50aHJlYWRjYXAsIGNvbW1lbnRzT3V0cHV0LCAwLCB2bTIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIHJlbmRlck5vZGUobm9kZUlkLCB0aHJlYWRjYXAsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCB2bTMpIHsKICAgIGNvbnN0IG5vZGUgPSB0aHJlYWRjYXAubm9kZXNbbm9kZUlkXTsKICAgIGlmICghbm9kZSkgcmV0dXJuOwogICAgY29uc3QgeyBjb21tZW50ICwgY29tbWVudEVycm9yICB9ID0gbm9kZTsKICAgIGNvbnN0IGNvbW1lbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbW1lbnREaXYuY2xhc3NMaXN0LmFkZCgnY29tbWVudCcpOwogICAgaWYgKGxldmVsID4gMCkgY29tbWVudERpdi5zdHlsZS5tYXJnaW5MZWZ0ID0gYCR7bGV2ZWwgKiA0fWVtYDsKICAgIGNvbnN0IGNvbW1lbnRlciA9IGNvbW1lbnQgPyB0aHJlYWRjYXAuY29tbWVudGVyc1tjb21tZW50LmF0dHJpYnV0ZWRUb10gOiB1bmRlZmluZWQ7CiAgICBpZiAoY29tbWVudCAmJiBjb21tZW50ZXI/Lmljb24/LnVybCkgewogICAgICAgIGNvbnN0IGljb25JbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgICBpY29uSW1nLmNsYXNzTGlzdC5hZGQoJ2ljb24nKTsKICAgICAgICBpY29uSW1nLnNyYyA9IGNvbW1lbnRlci5pY29uLnVybDsKICAgICAgICBjb21tZW50RGl2LmFwcGVuZENoaWxkKGljb25JbWcpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBpY29uRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgaWNvbkRpdi5jbGFzc0xpc3QuYWRkKCdpY29uJywgY29tbWVudEVycm9yID8gJ2Vycm9yJyA6ICdkZWZhdWx0Jyk7CiAgICAgICAgaWNvbkRpdi5pbm5lckhUTUwgPSAoY29tbWVudEVycm9yID8gRVJST1JfSUNPTiA6IHRocmVhZGNhcC5wcm90b2NvbCA9PT0gJ2xpZ2h0bmluZ2NvbW1lbnRzJyA/IEJPTFRfSUNPTiA6IFBFUlNPTl9JQ09OKS5nZXRIVE1MKCk7CiAgICAgICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChpY29uRGl2KTsKICAgIH0KICAgIGNvbnN0IHJoc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgcmhzRGl2LmNsYXNzTGlzdC5hZGQoJ3JocycpOwogICAgY29uc3QgaGVhZGVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBoZWFkZXJEaXYuY2xhc3NMaXN0LmFkZCgnaGVhZGVyJyk7CiAgICBpZiAoY29tbWVudCkgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZWRUb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGF0dHJpYnV0ZWRUb0Rpdi5jbGFzc0xpc3QuYWRkKCdhdHRyaWJ1dGVkLXRvJyk7CiAgICAgICAgaWYgKGNvbW1lbnRlcikgewogICAgICAgICAgICBsZXQgbmFtZSA9IGNvbW1lbnRlci5uYW1lOwogICAgICAgICAgICBpZiAoY29tbWVudGVyLmZxVXNlcm5hbWUpIG5hbWUgKz0gJyAnICsgY29tbWVudGVyLmZxVXNlcm5hbWU7CiAgICAgICAgICAgIGlmIChjb21tZW50ZXIudXJsKSB7CiAgICAgICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICAgICAgYS5ocmVmID0gY29tbWVudGVyLnVybCB8fCAnIyc7CiAgICAgICAgICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgICAgICAgICAgYS50ZXh0Q29udGVudCA9IG5hbWU7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUobmFtZSkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgYXR0cmlidXRlZFRvRGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbW1lbnQuYXR0cmlidXRlZFRvIHx8ICc8dW5rbm93bj4nKSk7CiAgICAgICAgfQogICAgICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhdHRyaWJ1dGVkVG9EaXYpOwogICAgICAgIGNvbnN0IGFnZVRleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb21tZW50LnB1Ymxpc2hlZCA/IGNvbXB1dGVBZ2UobmV3IERhdGUoY29tbWVudC5wdWJsaXNoZWQpKSA6ICcnKTsKICAgICAgICBpZiAoY29tbWVudC51cmwpIHsKICAgICAgICAgICAgY29uc3QgYWdlQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhZ2VBbmNob3IuY2xhc3NMaXN0LmFkZCgndXJsJyk7CiAgICAgICAgICAgIGFnZUFuY2hvci5ocmVmID0gY29tbWVudC51cmw7CiAgICAgICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGFnZUFuY2hvcik7CiAgICAgICAgICAgIGFnZUFuY2hvci5hcHBlbmRDaGlsZChhZ2VUZXh0KTsKICAgICAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGFnZUFuY2hvcik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGFnZVRleHQpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29tbWVudEVycm9yKSB7CiAgICAgICAgY29uc3Qgbm9kZUFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBub2RlQW5jaG9yLmhyZWYgPSBub2RlSWQ7CiAgICAgICAgbm9kZUFuY2hvci5pbm5lclRleHQgPSBub2RlSWQ7CiAgICAgICAgZXh0ZXJuYWxpemVBbmNob3Iobm9kZUFuY2hvcik7CiAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKG5vZGVBbmNob3IpOwogICAgfQogICAgcmhzRGl2LmFwcGVuZENoaWxkKGhlYWRlckRpdik7CiAgICBpZiAoY29tbWVudCkgewogICAgICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IE9iamVjdC52YWx1ZXMoY29tbWVudC5jb250ZW50KVswXTsKICAgICAgICBjb250ZW50RGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ2EnKS5mb3JFYWNoKGV4dGVybmFsaXplQW5jaG9yKTsKICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQoY29udGVudERpdik7CiAgICAgICAgZm9yIChjb25zdCBhdHRhY2htZW50IG9mIGNvbW1lbnQuYXR0YWNobWVudHMpewogICAgICAgICAgICBjb25zdCBhdHRhY2htZW50RGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RldGFpbHMnKTsKICAgICAgICAgICAgY29uc3Qgc3VtbWFyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1bW1hcnknKTsKICAgICAgICAgICAgc3VtbWFyeS50ZXh0Q29udGVudCA9IGBBdHRhY2htZW50ICgke2F0dGFjaG1lbnQubWVkaWFUeXBlfSlgOwogICAgICAgICAgICBhdHRhY2htZW50RGV0YWlscy5hcHBlbmRDaGlsZChzdW1tYXJ5KTsKICAgICAgICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgICAgICAgIGltZy5zcmMgPSBhdHRhY2htZW50LnVybDsKICAgICAgICAgICAgaWYgKGF0dGFjaG1lbnQud2lkdGggJiYgYXR0YWNobWVudC5oZWlnaHQpIHsKICAgICAgICAgICAgICAgIGltZy53aWR0aCA9IGF0dGFjaG1lbnQud2lkdGg7CiAgICAgICAgICAgICAgICBpbWcuaGVpZ2h0ID0gYXR0YWNobWVudC5oZWlnaHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXR0YWNobWVudERldGFpbHMuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICAgICAgcmhzRGl2LmFwcGVuZENoaWxkKGF0dGFjaG1lbnREZXRhaWxzKTsKICAgICAgICB9CiAgICAgICAgaWYgKGNvbW1lbnQudXJsICYmIHRocmVhZGNhcC5wcm90b2NvbCA9PT0gJ2FjdGl2aXR5cHViJykgewogICAgICAgICAgICBjb25zdCByZXBseVRvVXJsID0gY29tbWVudC51cmw7CiAgICAgICAgICAgIGNvbnN0IHJlcGx5RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgICAgIHJlcGx5RGl2LmNsYXNzTmFtZSA9ICdyZXBseSc7CiAgICAgICAgICAgIGNvbnN0IHJlcGx5QW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICByZXBseUFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgICAgICAgICByZXBseUFuY2hvci5ocmVmID0gJyMnOwogICAgICAgICAgICByZXBseURpdi5hcHBlbmRDaGlsZChyZXBseUFuY2hvcik7CiAgICAgICAgICAgIGNvbnN0IHJlcGx5RmllbGRzZXRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICAgICAgcmVwbHlEaXYuYXBwZW5kQ2hpbGQocmVwbHlGaWVsZHNldENvbnRhaW5lcik7CiAgICAgICAgICAgIHJlcGx5QW5jaG9yLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgICAgIHRvZ2dsZVJlcGx5Qm94KHJlcGx5QW5jaG9yLCByZXBseUZpZWxkc2V0Q29udGFpbmVyLCByZXBseVRvVXJsLCB2bTMpOwogICAgICAgICAgICB9OwogICAgICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQocmVwbHlEaXYpOwogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoY29tbWVudEVycm9yKSB7CiAgICAgICAgY29uc3QgbGluZXMgPSBjb21tZW50RXJyb3Iuc3BsaXQoJ1xuJyk7CiAgICAgICAgY29uc3Qgc3VtbWFyeSA9IGxpbmVzWzBdOwogICAgICAgIGNvbnN0IGVycm9yRGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RldGFpbHMnKTsKICAgICAgICBlcnJvckRldGFpbHMuY2xhc3NMaXN0LmFkZCgnZXJyb3InKTsKICAgICAgICBjb25zdCBlcnJvclN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICAgICAgZXJyb3JTdW1tYXJ5LnRleHRDb250ZW50ID0gc3VtbWFyeTsKICAgICAgICBlcnJvckRldGFpbHMuYXBwZW5kQ2hpbGQoZXJyb3JTdW1tYXJ5KTsKICAgICAgICBlcnJvckRldGFpbHMuYXBwZW5kKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGxpbmVzLnNsaWNlKDEpLmpvaW4oJ1xuJykpKTsKICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQoZXJyb3JEZXRhaWxzKTsKICAgIH0KICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQocmhzRGl2KTsKICAgIGNvbnRhaW5lckVsZW1lbnQuYXBwZW5kQ2hpbGQoY29tbWVudERpdik7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIG5vZGUucmVwbGllcyB8fCBbXSl7CiAgICAgICAgcmVuZGVyTm9kZShyZXBseSwgdGhyZWFkY2FwLCBjb250YWluZXJFbGVtZW50LCBsZXZlbCArIDEsIHZtMyk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFnZShkYXRlKSB7CiAgICBjb25zdCBtaWxsaXMgPSBEYXRlLm5vdygpIC0gZGF0ZS5nZXRUaW1lKCk7CiAgICBjb25zdCBzZWNvbmRzID0gbWlsbGlzIC8gMTAwMDsKICAgIGNvbnN0IG1pbnV0ZXMgPSBzZWNvbmRzIC8gNjA7CiAgICBpZiAobWludXRlcyA8IDYwKSByZXR1cm4gYCR7TWF0aC5tYXgoTWF0aC5mbG9vcihtaW51dGVzKSwgMSl9bWA7CiAgICBjb25zdCBob3VycyA9IG1pbnV0ZXMgLyA2MDsKICAgIGlmIChob3VycyA8IDI0KSByZXR1cm4gYCR7TWF0aC5mbG9vcihob3Vycyl9aGA7CiAgICBjb25zdCBkYXlzID0gaG91cnMgLyAyNDsKICAgIHJldHVybiBgJHtNYXRoLmZsb29yKGRheXMpfWRgOwp9CmZ1bmN0aW9uIHRvZ2dsZVJlcGx5Qm94KGFuY2hvciwgZmllbGRzZXRDb250YWluZXIsIHJlcGx5VG9VcmwsIHZtNCkgewogICAgaWYgKGFuY2hvci50ZXh0Q29udGVudD8uc3RhcnRzV2l0aCgnUmVwbHknKSkgewogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICdDYW5jZWwg4oW5JzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihSRVBMWV9CT1gsIGZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICBjb25zdCBsb2dpbkFuY2hvciA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhJylbMF07CiAgICAgICAgY29uc3QgdGV4dGFyZWEgPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGV4dGFyZWEnKVswXTsKICAgICAgICBjb25zdCBidXR0b24gPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYnV0dG9uJylbMF07CiAgICAgICAgY29uc3Qgb3V0cHV0ID0gZmllbGRzZXRDb250YWluZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ291dHB1dCcpWzBdOwogICAgICAgIGNvbnN0IG91dHB1dEFuY2hvciA9IG91dHB1dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYScpWzBdOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBVUkwocmVwbHlUb1VybCkub3JpZ2luOwogICAgICAgIG91dHB1dEFuY2hvci50ZXh0Q29udGVudCA9IG9yaWdpbjsKICAgICAgICBsZXQgc2VudCA9IGZhbHNlOwogICAgICAgIGxldCBuZXdSZXBseVVybDsKICAgICAgICBjb25zdCB1cGRhdGUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBsb2dnZWRJbiA9IHZtNC5pc0xvZ2dlZEluKG9yaWdpbik7CiAgICAgICAgICAgIGxvZ2luQW5jaG9yLnRleHRDb250ZW50ID0gbG9nZ2VkSW4gPyBgU2lnbiBvdXQgb2YgJHtvcmlnaW59YCA6IGBTaWduIGluIGF0ICR7b3JpZ2lufS4uLmA7CiAgICAgICAgICAgIGxvZ2luQW5jaG9yLnN0eWxlLmRpc3BsYXkgPSAhc2VudCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIHRleHRhcmVhLnN0eWxlLmRpc3BsYXkgPSBidXR0b24uc3R5bGUuZGlzcGxheSA9IGxvZ2dlZEluICYmICFzZW50ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgb3V0cHV0LnN0eWxlLmRpc3BsYXkgPSBzZW50ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgb3V0cHV0QW5jaG9yLmhyZWYgPSBuZXdSZXBseVVybCB8fCBvcmlnaW47CiAgICAgICAgfTsKICAgICAgICBsb2dpbkFuY2hvci5vbmNsaWNrID0gKGUxKT0+ewogICAgICAgICAgICBlMS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBsb2dnZWRJbiA9IHZtNC5pc0xvZ2dlZEluKG9yaWdpbik7CiAgICAgICAgICAgIGlmIChsb2dnZWRJbikgewogICAgICAgICAgICAgICAgdm00LmV4cGlyZUxvZ2luKG9yaWdpbik7CiAgICAgICAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cub3BlbihgL2xvZ2luP29yaWdpbj0ke2VuY29kZVVSSUNvbXBvbmVudChvcmlnaW4pfWAsICdsb2dpbicpOwogICAgICAgICAgICAgICAgaWYgKHcpIHsKICAgICAgICAgICAgICAgICAgICBnbG9iYWxUaGlzLm9ubWVzc2FnZSA9IChlKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRhdGEgIH0gPSBlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25tZXNzYWdlJywgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5vcmlnaW4gPT09ICdzdHJpbmcnICYmIGlzT2F1dGhPYnRhaW5Ub2tlblJlc3BvbnNlKGRhdGEudG9rZW5SZXNwb25zZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtNC5hY2NlcHRMb2dpbihkYXRhLm9yaWdpbiwgZGF0YS50b2tlblJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgYnV0dG9uLm9uY2xpY2sgPSBhc3luYyAoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBuZXdSZXBseVVybCA9IGF3YWl0IHZtNC5zZW5kUmVwbHkodGV4dGFyZWEudmFsdWUudHJpbSgpLCByZXBseVRvVXJsKTsKICAgICAgICAgICAgc2VudCA9IHRydWU7CiAgICAgICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICdDbG9zZSDihbknOwogICAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICB9OwogICAgICAgIHVwZGF0ZSgpOwogICAgICAgIHRleHRhcmVhLmZvY3VzKCk7CiAgICB9IGVsc2UgewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgZmllbGRzZXRDb250YWluZXIpOwogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgfQp9CmNvbnN0IFJFUExZX0JPWCA9IGh0bWxgCjxmaWVsZHNldD4KICAgIDxsZWdlbmQ+UmVwbHk8L2xlZ2VuZD4KICAgIDxhIGhyZWY9IiMiPkxvZ2luIHRvIC4uLjwvYT4KICAgIDx0ZXh0YXJlYSB0eXBlPSJ0ZXh0IiBuYW1lPSJjb250ZW50IiByb3dzPSI0IiBwbGFjZWhvbGRlcj0iWW91ciByZXBseS4uLiI+PC90ZXh0YXJlYT4KICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij5TZW5kPC9idXR0b24+CiAgICA8b3V0cHV0PlJlcGx5IHNlbnQhIEl0IG1heSB0YWtlIGEgd2hpbGUgdG8gYXBwZWFyIGhlcmUsIGJ1dCB5b3UgY2FuIHZpZXcgaXQgb3ZlciBhdCA8YSBocmVmPSIjIiB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93Ij4ob3JpZ2luKTwvYT48L291dHB1dD4KPC9maWVsZHNldD4KYDsKY29uc3QgRk9STV9IVE1MID0gaHRtbGAKPGhlYWRlcj4ke0NIRUNLTElTVF9JQ09OfTxoMT5MaXZld2lyZSBQb2RjYXN0IFZhbGlkYXRvciA8c3BhbiBpZD0idmVyc2lvbiI+djAuMjwvc3Bhbj48L2gxPjwvaGVhZGVyPgo8Zm9ybSBpZD0iZm9ybSI+CiAgICA8aW5wdXQgaWQ9InRleHQtaW5wdXQiIHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSJQb2RjYXN0IGZlZWQgdXJsLCBBY3Rpdml0eVB1YiB1cmwsIEFwcGxlIFBvZGNhc3RzIHVybCwgb3Igc2VhcmNoIHRleHQiIGF1dG9jb21wbGV0ZT0idXJsIiByZXF1aXJlZD4KICAgIDxidXR0b24gaWQ9InN1Ym1pdCIgdHlwZT0ic3VibWl0Ij5WYWxpZGF0ZTwvYnV0dG9uPgo8L2Zvcm0+CmA7CmNvbnN0IEZPUk1fQ1NTID0gY3NzYAoKaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZ2FwOiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIG9wYWNpdHk6IDAuNzU7Cn0KCmhlYWRlciBoMSB7CiAgICBtYXJnaW46IDA7Cn0KCmhlYWRlciBzdmcgewogICAgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOwogICAgZmlsbDogY3VycmVudENvbG9yOwp9CgojdmVyc2lvbiB7CiAgICBvcGFjaXR5OiAwLjI1Owp9CgojZm9ybSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAxcmVtOwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKfQoKLyoqIGlvcyByZXNldHMgKi8KQHN1cHBvcnRzICgtd2Via2l0LXRvdWNoLWNhbGxvdXQ6IG5vbmUpIHsKICAgIGlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uIHsKICAgICAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CiAgICAgICAgYm9yZGVyLXJhZGl1czogMDsKICAgIH0KCiAgICBidXR0b24gewogICAgICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA2NTBweCkgewoKICAgIGhlYWRlciB7CiAgICAgICAgZm9udC1zaXplOiA2NiU7CiAgICAgICAgZ2FwOiAwLjVyZW07CiAgICB9CgogICAgaGVhZGVyIHN2ZyB7CiAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjApOwogICAgfQoKICAgICNmb3JtIHsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA1MDBweCkgewoKICAgICN2ZXJzaW9uIHsKICAgICAgICBkaXNwbGF5OiBub25lOwogICAgfQoKfQoKI3RleHQtaW5wdXQgewogICAgZm9udC1zaXplOiAxcmVtOwogICAgZmxleC1ncm93OiAxOwogICAgcGFkZGluZzogMC41cmVtIDAuNXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgICBib3JkZXI6IHNvbGlkIDFweCB3aGl0ZTsKICAgIG91dGxpbmU6IG5vbmU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiN0ZXh0LWlucHV0OnJlYWQtb25seSB7CiAgICBvcGFjaXR5OiAwLjU7IAp9CgppbnB1dDotd2Via2l0LWF1dG9maWxsLCBpbnB1dDotd2Via2l0LWF1dG9maWxsOmZvY3VzIHsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgNjAwMDAwcyAwcywgY29sb3IgNjAwMDAwcyAwczsKfQoKI2Zvcm0gYnV0dG9uIHsKICAgIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwogICAgbWluLXdpZHRoOiA4cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0Rm9ybShkb2N1bWVudCwgdm01LCBzdGF0aWNEYXRhMSkgewogICAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtJyk7CiAgICBjb25zdCB0ZXh0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dC1pbnB1dCcpOwogICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Ym1pdCcpOwogICAgY29uc3QgdmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyc2lvbicpOwogICAgY29uc3QgdmVyc2lvbiA9IFsKICAgICAgICBzdGF0aWNEYXRhMS52ZXJzaW9uLAogICAgICAgIHN0YXRpY0RhdGExLnB1c2hJZAogICAgXS5tYXAoKHYpPT4odiB8fCAnJykudHJpbSgpCiAgICApLmZpbHRlcigodik9PnYubGVuZ3RoID4gMAogICAgKS5qb2luKCcuJyk7CiAgICB2ZXJzaW9uU3Bhbi50ZXh0Q29udGVudCA9IHN0YXRpY0RhdGExLnZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyAgfSA9IG5ldyBVUkwoZG9jdW1lbnQuVVJMKTsKICAgIGNvbnN0IHZhbGlkYXRlMSA9IHNlYXJjaFBhcmFtcy5nZXQoJ3ZhbGlkYXRlJykgfHwgdW5kZWZpbmVkOwogICAgY29uc3QgaW5wdXQgPSBzZWFyY2hQYXJhbXMuZ2V0KCdpbnB1dCcpIHx8IHVuZGVmaW5lZDsKICAgIGNvbnN0IG5vY29tbWVudHMgPSBzZWFyY2hQYXJhbXMuaGFzKCdub2NvbW1lbnRzJyk7CiAgICBjb25zdCBzdGFydFZhbGlkYXRpb24gPSAoKT0+dm01LnN0YXJ0VmFsaWRhdGlvbih0ZXh0SW5wdXQudmFsdWUsIHsKICAgICAgICAgICAgdmFsaWRhdGVDb21tZW50czogIW5vY29tbWVudHMsCiAgICAgICAgICAgIHVzZXJBZ2VudDogbmF2aWdhdG9yLnVzZXJBZ2VudAogICAgICAgIH0pCiAgICA7CiAgICBmb3JtLm9uc3VibWl0ID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGlmICh2bTUudmFsaWRhdGluZykgewogICAgICAgICAgICB2bTUuY2FuY2VsVmFsaWRhdGlvbigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0VmFsaWRhdGlvbigpOwogICAgICAgIH0KICAgIH07CiAgICBpZiAodmFsaWRhdGUxKSB7CiAgICAgICAgdGV4dElucHV0LnZhbHVlID0gdmFsaWRhdGUxOwogICAgICAgIHNldFRpbWVvdXQoc3RhcnRWYWxpZGF0aW9uLCAwKTsKICAgIH0gZWxzZSBpZiAoaW5wdXQpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSBpbnB1dDsKICAgIH0KICAgIHRleHRJbnB1dC5mb2N1cygpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSB0ZXh0SW5wdXQuZGlzYWJsZWQ7CiAgICAgICAgdGV4dElucHV0LmRpc2FibGVkID0gdm01LnZhbGlkYXRpbmc7CiAgICAgICAgdGV4dElucHV0LnJlYWRPbmx5ID0gdm01LnZhbGlkYXRpbmc7CiAgICAgICAgc3VibWl0QnV0dG9uLnRleHRDb250ZW50ID0gdm01LnZhbGlkYXRpbmcgPyAnQ2FuY2VsJyA6ICdWYWxpZGF0ZSc7CiAgICAgICAgaWYgKHdhc0Rpc2FibGVkICYmICF0ZXh0SW5wdXQuZGlzYWJsZWQpIHsKICAgICAgICAgICAgdGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNRVNTQUdFU19IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ibWVzc2FnZXMiPjwvb3V0cHV0PgpgOwpjb25zdCBNRVNTQUdFU19DU1MgPSBjc3NgCgojbWVzc2FnZXMgewogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDJyZW0gYXV0bzsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07Cn0KCiNtZXNzYWdlcyA+IGRpdiwgI21lc3NhZ2VzID4gYSB7CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwp9CgojbWVzc2FnZXMgc3ZnIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC43NSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiNtZXNzYWdlcyA+IGRpdi5pbmZvIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKI21lc3NhZ2VzID4gZGl2Lmdvb2QgewogICAgY29sb3I6ICM0M2EwNDc7Cn0KI21lc3NhZ2VzID4gZGl2Lndhcm5pbmcgewogICAgY29sb3I6ICNlNjUxMDA7Cn0KCiNtZXNzYWdlcyA+IGRpdi5lcnJvciB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yRXJyb3JIZXgpfTsKfQoKI21lc3NhZ2VzID4gZGl2LnJ1bm5pbmcsICNtZXNzYWdlcyA+IGRpdi5kb25lIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI21lc3NhZ2VzIC5pY29uIHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgd2lkdGg6IDI0cHg7CiAgICBoZWlnaHQ6IDI0cHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgojbWVzc2FnZXMgLm1lc3NhZ2UgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCiNtZXNzYWdlcyAudXJsIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKfQoKI21lc3NhZ2VzIHByb2dyZXNzIHsKICAgIGZvbnQtc2l6ZTogMC4zNXJlbTsKfQoKI21lc3NhZ2VzIC5yZWZlcmVuY2UgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgbWFyZ2luLWxlZnQ6IDAuMjVyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRNZXNzYWdlcyhkb2N1bWVudCwgdm02KSB7CiAgICBjb25zdCBtZXNzYWdlc091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZXNzYWdlcycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoTUVTU0FHRV9IVE1MKHZtNiksIG1lc3NhZ2VzT3V0cHV0KTsKICAgIH07Cn0KY29uc3QgTUVTU0FHRV9IVE1MID0gKHZtNyk9Pmh0bWxgCiAgICAke3ZtNy5tZXNzYWdlcy5maWx0ZXIoZmlsdGVyRHVwbGljYXRlcygpKS5tYXAoKG1lc3NhZ2UpPT5odG1sYAogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBpY29uIj4ke2ljb24obWVzc2FnZS50eXBlKX08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSIke21lc3NhZ2UudHlwZX0gbWVzc2FnZSI+JHttZXNzYWdlLnRleHR9JHtSRUZFUkVOQ0VfSFRNTChtZXNzYWdlLnJlZmVyZW5jZSl9PC9kaXY+CiAgICAgICAgJHtBTkNIT1JfSFRNTChtZXNzYWdlLnVybCl9YAogICAgKX1gCjsKY29uc3QgUkVGRVJFTkNFX0hUTUwgPSAocmVmZXJlbmNlKT0+cmVmZXJlbmNlID8gaHRtbGA8YSBjbGFzcz0icmVmZXJlbmNlIiBocmVmPSR7cmVmZXJlbmNlLmhyZWZ9IHRhcmdldD0iX2JsYW5rIiByZWw9Im5vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3ciPlske3JlZmVyZW5jZS5ydWxlc2V0fV08L2E+YCA6IHVuZGVmaW5lZAo7CmNvbnN0IEFOQ0hPUl9IVE1MID0gKHVybCk9PnVybCA/IGh0bWxgPGEgaHJlZj0ke3VybH0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyIgY2xhc3M9InVybCI+JHt1cmx9PC9hPmAgOiB1bmRlZmluZWQKOwpmdW5jdGlvbiBpY29uKHR5cGUpIHsKICAgIHJldHVybiB0eXBlID09PSAncnVubmluZycgPyBodG1sYDxwcm9ncmVzcyBjbGFzcz0icHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciI+PC9wcm9ncmVzcz5gIDogdHlwZSA9PT0gJ2RvbmUnID8gQ0hFQ0tfSUNPTiA6IHR5cGUgPT09ICdlcnJvcicgPyBFUlJPUl9JQ09OIDogdHlwZSA9PT0gJ3dhcm5pbmcnID8gV0FSTklOR19JQ09OIDogdHlwZSA9PT0gJ2dvb2QnID8gQ0hFQ0tfSUNPTiA6IElORk9fSUNPTjsKfQpmdW5jdGlvbiBmaWx0ZXJEdXBsaWNhdGVzKCkgewogICAgY29uc3QgdGFnVXJscyA9IG5ldyBTZXQoKTsKICAgIHJldHVybiAobWVzc2FnZSk9PnsKICAgICAgICBjb25zdCB7IHRhZyAsIHVybCAgfSA9IG1lc3NhZ2U7CiAgICAgICAgaWYgKHRhZyAmJiB1cmwpIHsKICAgICAgICAgICAgY29uc3QgdGFnVXJsID0gYCR7dGFnfXwke3VybH1gOwogICAgICAgICAgICBpZiAodGFnVXJscy5oYXModGFnVXJsKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0YWdVcmxzLmFkZCh0YWdVcmwpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Owp9CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJzZWFyY2gtcmVzdWx0cyI+PC9vdXRwdXQ+CmA7CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0NTUyA9IGNzc2AKCiNzZWFyY2gtcmVzdWx0cyB7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgZGlzcGxheTogbm9uZTsKfQoKI3NlYXJjaC1yZXN1bHRzID4gZGl2IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNXJlbTsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwogICAgbWFyZ2luLWJvdHRvbTogMC43NXJlbTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKI3NlYXJjaC1yZXN1bHRzIC5pY29uLCAjc2VhcmNoLXJlc3VsdHMgaW1nIHsKICAgIHdpZHRoOiAxLjVyZW07CiAgICBoZWlnaHQ6IDEuNXJlbTsKfQoKI3NlYXJjaC1yZXN1bHRzIC50aXRsZSB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiNzZWFyY2gtcmVzdWx0cyAuYXV0aG9yIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNlYXJjaFJlc3VsdHMoZG9jdW1lbnQsIHZtOCkgewogICAgY29uc3Qgc2VhcmNoUmVzdWx0c091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWFyY2gtcmVzdWx0cycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUkVTVUxUU19IVE1MKHZtOCksIHNlYXJjaFJlc3VsdHNPdXRwdXQpOwogICAgICAgIHNlYXJjaFJlc3VsdHNPdXRwdXQuc3R5bGUuZGlzcGxheSA9IHZtOC5pc1NlYXJjaCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IFJFU1VMVFNfSFRNTCA9ICh2bTkpPT5odG1sYAogICAgJHt2bTkuc2VhcmNoUmVzdWx0cy5tYXAoKHJlc3VsdCk9Pmh0bWxgPGRpdiBjbGFzcz0ic2VhcmNoLXJlc3VsdCIgQGNsaWNrPSIke3NlbGVjdFJlc3VsdCh2bTksIHJlc3VsdC51cmwpfSI+PGRpdiBjbGFzcz0iaWNvbiI+JHtJTUFHRV9IVE1MKHJlc3VsdC5hcnR3b3JrKX08L2Rpdj48ZGl2IGNsYXNzPSJ0aXRsZSI+JHtyZXN1bHQudGl0bGV9PC9kaXY+PGRpdiBjbGFzcz0iYXV0aG9yIj4ke3Jlc3VsdC5hdXRob3J9PC9kaXY+PC9kaXY+YAogICAgKX1gCjsKY29uc3QgSU1BR0VfSFRNTCA9IChhcnR3b3JrKT0+YXJ0d29yayA/IGh0bWxgPGltZyBzcmM9JHthcnR3b3JrfT5gIDogU1FVQVJFX0lDT04KOwpmdW5jdGlvbiBzZWxlY3RSZXN1bHQodm0xMCwgdXJsKSB7CiAgICByZXR1cm4gKCk9PnZtMTAuY29udGludWVXaXRoKHVybCkKICAgIDsKfQpjb25zdCBYTUxfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InhtbCI+PC9vdXRwdXQ+CmA7CmNvbnN0IFhNTF9DU1MgPSBjc3NgCiN4bWwgewogICAgZm9udC1mYW1pbHk6ICR7dW5zYWZlQ1NTKFRoZW1lLm1vbm9zcGFjZUZvbnRGYW1pbHkpfTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGxpbmUtaGVpZ2h0OiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9OwogICAgb3ZlcmZsb3ctd3JhcDogYnJlYWstd29yZDsKICAgIGxpbmUtaGVpZ2h0OiAxLjQ7Cn0KCiN4bWwgLnJvb3QgewogICAgZm9udC1mYW1pbHk6ICR7dW5zYWZlQ1NTKFRoZW1lLnNhbnNTZXJpZkZvbnRGYW1pbHkpfTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIGxpbmUtaGVpZ2h0OiAyOwp9CgojeG1sIC5jb250ZW50IHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3htbCAucG9kY2FzdCB7CiAgICBjb2xvcjogI2FiNDdiYzsKfQoKI3htbCAuaW5kZW50IHsKICAgIG1hcmdpbi1sZWZ0OiAwLjc1cmVtOwp9CgojeG1sIC5pbmRlbnQyIHsKICAgIG1hcmdpbi1sZWZ0OiAxLjVyZW07Cn0KCnN1bW1hcnkuZW1wdHkgeyBsaXN0LXN0eWxlOiBub25lOyBjdXJzb3I6IHRleHQ7IH0Kc3VtbWFyeS5lbXB0eTo6LXdlYmtpdC1kZXRhaWxzLW1hcmtlciB7IGRpc3BsYXk6IG5vbmU7IH0KCiN4bWwgYXVkaW8gewogICAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKfQpgOwpmdW5jdGlvbiBpbml0WG1sKGRvY3VtZW50LCB2bTExKSB7CiAgICBjb25zdCB4bWxPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneG1sJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB4bWwgPSB2bTExLnhtbDsKICAgICAgICBpZiAoeG1sICE9PSBfcmVuZGVyZWRYbWwpIHsKICAgICAgICAgICAgcmVuZGVyWG1sKHhtbCwgeG1sT3V0cHV0LCB2bTExLnhtbFN1bW1hcnlUZXh0KTsKICAgICAgICAgICAgX3JlbmRlcmVkWG1sID0geG1sOwogICAgICAgIH0KICAgIH07Cn0KbGV0IF9yZW5kZXJlZFhtbDsKZnVuY3Rpb24gcmVuZGVyWG1sKHhtbCwgeG1sT3V0cHV0LCB4bWxTdW1tYXJ5VGV4dCkgewogICAgd2hpbGUoeG1sT3V0cHV0LmZpcnN0Q2hpbGQpeG1sT3V0cHV0LnJlbW92ZUNoaWxkKHhtbE91dHB1dC5maXJzdENoaWxkKTsKICAgIGlmICh4bWwpIHJlbmRlck5vZGUxKHhtbCwgeG1sT3V0cHV0LCAwLCBuZXcgU2V0KCksIHVuZGVmaW5lZCwgeG1sU3VtbWFyeVRleHQpOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUxKG5vZGUsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCBjb250ZXh0LCBpdGVtTnVtYmVyLCB4bWxTdW1tYXJ5VGV4dCkgewogICAgY29uc3QgeyBhdHRzICB9ID0gbm9kZTsKICAgIGNvbnN0IGRldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkZXRhaWxzJyk7CiAgICBjb25zdCB0ZXh0ID0gbm9kZS52YWwgfHwgJyc7CiAgICBkZXRhaWxzLm9wZW4gPSAhY29udGV4dC5oYXMoJ2ZvdW5kLWl0ZW0nKSB8fCB0ZXh0Lmxlbmd0aCA+IDA7CiAgICBpZiAobGV2ZWwgPiAwKSBkZXRhaWxzLmNsYXNzTGlzdC5hZGQoJ2luZGVudCcpOwogICAgY29uc3Qgc3VtbWFyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1bW1hcnknKTsKICAgIGlmIChsZXZlbCA9PT0gMCkgewogICAgICAgIHJlbmRlclRleHRQaWVjZXMoc3VtbWFyeSwgeG1sU3VtbWFyeVRleHQgfHwgJ1htbCcpOwogICAgICAgIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgncm9vdCcpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzcGFuQ2xhc3MgPSBRbmFtZXMuUG9kY2FzdEluZGV4Lk5BTUVTUEFDRVMuaW5jbHVkZXMobm9kZS5xbmFtZS5uYW1lc3BhY2VVcmkgfHwgJycpID8gJ3BvZGNhc3QnIDogdW5kZWZpbmVkOwogICAgICAgIHJlbmRlclRleHRQaWVjZXMoc3VtbWFyeSwgJzwnLCB7CiAgICAgICAgICAgIHRleHQ6IG5vZGUudGFnbmFtZSwKICAgICAgICAgICAgc3BhbkNsYXNzCiAgICAgICAgfSwgLi4uWwogICAgICAgICAgICAuLi5hdHRzLmVudHJpZXMoKQogICAgICAgIF0uZmxhdE1hcCgodik9PlsKICAgICAgICAgICAgICAgIGAgJHt2WzBdfT0iYCwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB2WzFdLAogICAgICAgICAgICAgICAgICAgIHNwYW5DbGFzczogJ2NvbnRlbnQnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgJyInCiAgICAgICAgICAgIF0KICAgICAgICApLCAnPicsIGl0ZW1OdW1iZXIgPyBgICMke2l0ZW1OdW1iZXJ9YCA6ICcnKTsKICAgIH0KICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoc3VtbWFyeSk7CiAgICBsZXQgY2hpbGRDb3VudCA9IDA7CiAgICBpZiAodGV4dC5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2NvbnRlbnQnKTsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKGRpdiwgdGV4dCk7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2luZGVudDInKTsKICAgICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG5vZGUuY2hpbGQpKXsKICAgICAgICBsZXQgaXRlbU51bWJlciA9IDE7CiAgICAgICAgbGV0IGl0ZW1zTm90U2hvd24gPSAwOwogICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdmFsdWUpewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2l0ZW0nICYmIGl0ZW1OdW1iZXIgPiAyMCkgewogICAgICAgICAgICAgICAgaXRlbXNOb3RTaG93bisrOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVuZGVyTm9kZTEoY2hpbGQsIGRldGFpbHMsIGxldmVsICsgMSwgY29udGV4dCwgdmFsdWUubGVuZ3RoID4gMSA/IGl0ZW1OdW1iZXIgOiB1bmRlZmluZWQpOwogICAgICAgICAgICBjaGlsZENvdW50Kys7CiAgICAgICAgICAgIGl0ZW1OdW1iZXIrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGl0ZW1zTm90U2hvd24gPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGZha2VOb2RlID0gewogICAgICAgICAgICAgICAgdGFnbmFtZTogYC4uLmFuZCAke25ldyBJbnRsLk51bWJlckZvcm1hdCgpLmZvcm1hdChpdGVtc05vdFNob3duKX0gbW9yZSBpdGVtc2AsCiAgICAgICAgICAgICAgICBhdHRzOiBuZXcgTWFwKCksCiAgICAgICAgICAgICAgICBxbmFtZTogewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXR0cnNNYXA6IHt9LAogICAgICAgICAgICAgICAgY2hpbGQ6IHt9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlbmRlck5vZGUxKGZha2VOb2RlLCBkZXRhaWxzLCBsZXZlbCAtIDEsIGNvbnRleHQsIHVuZGVmaW5lZCk7CiAgICAgICAgfQogICAgfQogICAgY29uc3QgYXVkaW9VcmwgPSBub2RlLnRhZ25hbWUgPT09ICdlbmNsb3N1cmUnICYmIGF0dHMuZ2V0KCd1cmwnKSB8fCBub2RlLnFuYW1lLm5hbWVzcGFjZVVyaSAmJiBxbmFtZXNJbmNsdWRlKFFuYW1lcy5Qb2RjYXN0SW5kZXguc291cmNlLCBub2RlLnFuYW1lKSAmJiBhdHRzLmdldCgndXJpJykgfHwgcW5hbWVFcShub2RlLnFuYW1lLCBRbmFtZXMuTWVkaWFSc3MuY29udGVudCkgJiYgKGF0dHMuZ2V0KCd0eXBlJykgfHwgJycpLnN0YXJ0c1dpdGgoJ2F1ZGlvJykgJiYgYXR0cy5nZXQoJ3VybCcpOwogICAgaWYgKGF1ZGlvVXJsKSB7CiAgICAgICAgY29uc3QgYXVkaW8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpOwogICAgICAgIGF1ZGlvLmNvbnRyb2xzID0gdHJ1ZTsKICAgICAgICBhdWRpby5wcmVsb2FkID0gJ25vbmUnOwogICAgICAgIGF1ZGlvLnNyYyA9IGF1ZGlvVXJsOwogICAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoYXVkaW8pOwogICAgICAgIGNoaWxkQ291bnQrKzsKICAgIH0KICAgIGlmIChjaGlsZENvdW50ID09PSAwKSBzdW1tYXJ5LmNsYXNzTGlzdC5hZGQoJ2VtcHR5JywgJ2luZGVudCcpOwogICAgY29udGFpbmVyRWxlbWVudC5hcHBlbmRDaGlsZChkZXRhaWxzKTsKICAgIGlmIChub2RlLnRhZ25hbWUgPT09ICdpdGVtJykgY29udGV4dC5hZGQoJ2ZvdW5kLWl0ZW0nKTsKfQpmdW5jdGlvbiByZW5kZXJUZXh0UGllY2VzKGVsZW1lbnQsIC4uLnBpZWNlcykgewogICAgZm9yIChjb25zdCBwaWVjZSBvZiBwaWVjZXMpewogICAgICAgIGNvbnN0IHRleHQgPSB0eXBlb2YgcGllY2UgPT09ICdzdHJpbmcnID8gcGllY2UgOiBwaWVjZS50ZXh0OwogICAgICAgIGNvbnN0IHNwYW5DbGFzcyA9IHR5cGVvZiBwaWVjZSA9PT0gJ29iamVjdCcgPyBwaWVjZS5zcGFuQ2xhc3MgOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKC9eaHR0cHM/OlwvXC9bXlxzKV0rJC8udGVzdCh0ZXh0KSkgewogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB0ZXh0OwogICAgICAgICAgICBleHRlcm5hbGl6ZUFuY2hvcihhKTsKICAgICAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICAgICAgaWYgKHNwYW5DbGFzcykgewogICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NMaXN0LmFkZChzcGFuQ2xhc3MpOwogICAgICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KY29uc3QgYXBwTW9kdWxlU2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcC1tb2R1bGUtc2NyaXB0Jyk7CmZ1bmN0aW9uIHNldEFwcFN0YXRlKGFwcFN0YXRlKSB7CiAgICBhcHBNb2R1bGVTY3JpcHQuZGF0YXNldC5zdGF0ZSA9IGFwcFN0YXRlOwp9CnNldEFwcFN0YXRlKCdzdGFydGluZycpOwpjb25zdCBhcHBDc3MgPSBjc3NgCgphIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS5wcmltYXJ5Q29sb3IzMDBIZXgpfTsKICAgIHRleHQtdW5kZXJsaW5lLW9mZnNldDogMC4ycmVtOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgICB9Cn0KCm1haW4gewogICAgbWFyZ2luOiAycmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCkBrZXlmcmFtZXMgZmFkZUluQW5pbWF0aW9uIHsKICAgIDAlIHsKICAgICAgICBvcGFjaXR5OiAwOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgb3BhY2l0eTogMTsKICAgIH0KfQoKc3VtbWFyeSB7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCmA7CmNvbnN0IGFwcEh0bWwgPSBodG1sYAo8bWFpbj4KJHtGT1JNX0hUTUx9CiR7TUVTU0FHRVNfSFRNTH0KJHtTRUFSQ0hfUkVTVUxUU19IVE1MfQoke0NPTU1FTlRTX0hUTUx9CiR7WE1MX0hUTUx9CjwvbWFpbj4KYDsKZnVuY3Rpb24gYXBwZW5kU3R5bGVzaGVldHMoY3NzVGV4dHMpIHsKICAgIGNvbnN0IHN0eWxlU2hlZXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgc3R5bGVTaGVldC50eXBlID0gJ3RleHQvY3NzJzsKICAgIHN0eWxlU2hlZXQudGV4dENvbnRlbnQgPSBjc3NUZXh0cy5qb2luKCdcblxuJyk7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlU2hlZXQpOwp9CmFwcGVuZFN0eWxlc2hlZXRzKFsKICAgIGFwcENzcy5jc3NUZXh0LAogICAgRk9STV9DU1MuY3NzVGV4dCwKICAgIE1FU1NBR0VTX0NTUy5jc3NUZXh0LAogICAgU0VBUkNIX1JFU1VMVFNfQ1NTLmNzc1RleHQsCiAgICBDT01NRU5UU19DU1MuY3NzVGV4dCwKICAgIFhNTF9DU1MuY3NzVGV4dCwKICAgIENJUkNVTEFSX1BST0dSRVNTX0NTUy5jc3NUZXh0LCAKXSk7CkxpdEVsZW1lbnQucmVuZGVyKGFwcEh0bWwsIGRvY3VtZW50LmJvZHkpOwpmdW5jdGlvbiBwYXJzZVN0YXRpY0RhdGEoKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdGljLWRhdGEtc2NyaXB0Jyk7CiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShzY3JpcHQudGV4dCk7CiAgICBjb25zdCB2ZXJzaW9uID0gdHlwZW9mIGRhdGEudmVyc2lvbiA9PT0gJ3N0cmluZycgPyBkYXRhLnZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICBjb25zdCBmbGFncyA9IHR5cGVvZiBkYXRhLmZsYWdzID09PSAnc3RyaW5nJyA/IGRhdGEuZmxhZ3MgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBkZWJ1ZyA9IHR5cGVvZiBkYXRhLmRlYnVnID09PSAnb2JqZWN0JyA/IGRhdGEuZGVidWcgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBwdXNoSWQgPSB0eXBlb2YgZGF0YS5wdXNoSWQgPT09ICdzdHJpbmcnID8gZGF0YS5wdXNoSWQgOiB1bmRlZmluZWQ7CiAgICByZXR1cm4gewogICAgICAgIHZlcnNpb24sCiAgICAgICAgZmxhZ3MsCiAgICAgICAgZGVidWcsCiAgICAgICAgcHVzaElkCiAgICB9Owp9CmNvbnN0IHN0YXRpY0RhdGEgPSBwYXJzZVN0YXRpY0RhdGEoKTsKY29uc3QgbG9jYWxGZXRjaGVyID0gKHVybCwgaGVhZGVycyk9PmZldGNoKHVybCwgewogICAgICAgIGhlYWRlcnMKICAgIH0pCjsKY29uc3QgcmVtb3RlRmV0Y2hlciA9ICh1cmwsIGhlYWRlcnMpPT5mZXRjaChgL2YvJHt1cmwucmVwbGFjZUFsbCgvW15hLXpBLVowLTkuXSsvZywgJ18nKX1gLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KQogICAgfSkKOwpjb25zdCBwaVNlYXJjaEZldGNoZXIgPSAoaW5wdXQsIGhlYWRlcnMpPT5mZXRjaChgL3NgLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgaGVhZGVycwogICAgICAgIH0pCiAgICB9KQo7CmNvbnN0IHRocmVhZGNhcFVzZXJBZ2VudCA9IG5hdmlnYXRvci51c2VyQWdlbnQ7CmNvbnN0IHZtID0gbmV3IFZhbGlkYXRvckFwcFZNKHsKICAgIHRocmVhZGNhcFVzZXJBZ2VudCwKICAgIGxvY2FsRmV0Y2hlciwKICAgIHJlbW90ZUZldGNoZXIsCiAgICBwaVNlYXJjaEZldGNoZXIKfSk7CmNvbnN0IHVwZGF0ZUZvcm0gPSBpbml0Rm9ybShkb2N1bWVudCwgdm0sIHN0YXRpY0RhdGEpOwpjb25zdCB1cGRhdGVNZXNzYWdlcyA9IGluaXRNZXNzYWdlcyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVTZWFyY2hSZXN1bHRzID0gaW5pdFNlYXJjaFJlc3VsdHMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlQ29tbWVudHMgPSBpbml0Q29tbWVudHMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlWG1sID0gaW5pdFhtbChkb2N1bWVudCwgdm0pOwp2bS5vbkNoYW5nZSA9ICgpPT57CiAgICB1cGRhdGVGb3JtKCk7CiAgICB1cGRhdGVNZXNzYWdlcygpOwogICAgdXBkYXRlU2VhcmNoUmVzdWx0cygpOwogICAgdXBkYXRlQ29tbWVudHMoKTsKICAgIHVwZGF0ZVhtbCgpOwp9Owp2bS5zdGFydCgpOwpzZXRBcHBTdGF0ZSgnc3RhcnRlZCcpOwo=';
