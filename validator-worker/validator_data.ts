export const VALIDATOR_APP_HASH = '6d68a23300e7a05619649af6d1ce32b9145eb520';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHsKfTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKY2xhc3MgVGhlbWUgewogICAgc3RhdGljIHByaW1hcnlDb2xvcjIwMEhleCA9ICcjNjliN2ZmJzsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IzMDBIZXggPSAnIzAwODhGRic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yOTAwSGV4ID0gJyMwMDVjY2InOwogICAgc3RhdGljIGJhY2tncm91bmRDb2xvckhleCA9ICcjMTIxMjEyJzsKICAgIHN0YXRpYyB0ZXh0Q29sb3JIZXggPSAnI2ViZWJlYic7CiAgICBzdGF0aWMgdGV4dENvbG9yU2Vjb25kYXJ5SGV4ID0gJyM4ODg4ODgnOwogICAgc3RhdGljIHNhbnNTZXJpZkZvbnRGYW1pbHkgPSAnLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCwgYXZlbmlyLCBoZWx2ZXRpY2EgbmV1ZSwgaGVsdmV0aWNhLCBVYnVudHUsIHJvYm90bywgbm90bywgc2Vnb2UgdWksIGFyaWFsLCBzYW5zLXNlcmlmJzsKICAgIHN0YXRpYyBtb25vc3BhY2VGb250RmFtaWx5ID0gJ01lbmxvLCAiU0YgTW9ubyIsICJBbmRhbGUgTW9ubyIsICJSb2JvdG8gTW9ubyIsIE1vbmFjbywgbW9ub3NwYWNlJzsKfQpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRSA9ICdodHRwczovL3BvZGNhc3RpbmRleC5vcmcvbmFtZXNwYWNlLzEuMCc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0FMVCA9ICdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQnOwpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9LTk9XTl9NSVNTUEVMTElORyA9ICdodHRwczovL3BvZGNhc3RpbmRleC5vcmcvbmFtZXNwYWNlLzEuMC8nOwpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMgPSBbCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRSwKICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0FMVCwKICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0tOT1dOX01JU1NQRUxMSU5HCl07CmNvbnN0IFBPRENBU1RfSU5ERVhfS05PV05fTkFNRVMgPSBuZXcgU2V0KCk7CmZ1bmN0aW9uIF9wb2RjYXN0SW5kZXgobmFtZSwga25vd24gPSB0cnVlKSB7CiAgICBpZiAoa25vd24pIFBPRENBU1RfSU5ERVhfS05PV05fTkFNRVMuYWRkKG5hbWUpOwogICAgcmV0dXJuIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUy5tYXAoKHYpPT4oewogICAgICAgICAgICBuYW1lLAogICAgICAgICAgICBuYW1lc3BhY2VVcmk6IHYKICAgICAgICB9KQogICAgKTsKfQpjb25zdCBNRURJQV9SU1NfTkFNRVNQQUNFID0gJ2h0dHA6Ly9zZWFyY2gueWFob28uY29tL21yc3MvJzsKZnVuY3Rpb24gX21lZGlhUnNzKG5hbWUpIHsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZSwKICAgICAgICBuYW1lc3BhY2VVcmk6IE1FRElBX1JTU19OQU1FU1BBQ0UKICAgIH07Cn0KY2xhc3MgUW5hbWVzIHsKICAgIHN0YXRpYyBQb2RjYXN0SW5kZXggPSB7CiAgICAgICAgTkFNRVNQQUNFUzogUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VTLAogICAgICAgIEtOT1dOX01JU1NQRUxMRURfTkFNRVNQQUNFUzogWwogICAgICAgICAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9LTk9XTl9NSVNTUEVMTElORwogICAgICAgIF0sCiAgICAgICAgZ2V0IEtOT1dOX05BTUVTICgpIHsKICAgICAgICAgICAgcmV0dXJuIFBPRENBU1RfSU5ERVhfS05PV05fTkFNRVM7CiAgICAgICAgfSwKICAgICAgICBvZjogKG5hbWUpPT5fcG9kY2FzdEluZGV4KG5hbWUsIGZhbHNlKQogICAgICAgICwKICAgICAgICBhbHRlcm5hdGVFbmNsb3N1cmU6IF9wb2RjYXN0SW5kZXgoJ2FsdGVybmF0ZUVuY2xvc3VyZScpLAogICAgICAgIGNoYXB0ZXJzOiBfcG9kY2FzdEluZGV4KCdjaGFwdGVycycpLAogICAgICAgIGVwaXNvZGU6IF9wb2RjYXN0SW5kZXgoJ2VwaXNvZGUnKSwKICAgICAgICBmdW5kaW5nOiBfcG9kY2FzdEluZGV4KCdmdW5kaW5nJyksCiAgICAgICAgZ3VpZDogX3BvZGNhc3RJbmRleCgnZ3VpZCcpLAogICAgICAgIGhpdmVBY2NvdW50OiBfcG9kY2FzdEluZGV4KCdoaXZlQWNjb3VudCcpLAogICAgICAgIGltYWdlczogX3BvZGNhc3RJbmRleCgnaW1hZ2VzJyksCiAgICAgICAgaW50ZWdyaXR5OiBfcG9kY2FzdEluZGV4KCdpbnRlZ3JpdHknKSwKICAgICAgICBsaWNlbnNlOiBfcG9kY2FzdEluZGV4KCdsaWNlbnNlJyksCiAgICAgICAgbG9jYXRpb246IF9wb2RjYXN0SW5kZXgoJ2xvY2F0aW9uJyksCiAgICAgICAgbG9ja2VkOiBfcG9kY2FzdEluZGV4KCdsb2NrZWQnKSwKICAgICAgICBtZWRpdW06IF9wb2RjYXN0SW5kZXgoJ21lZGl1bScpLAogICAgICAgIHBlcnNvbjogX3BvZGNhc3RJbmRleCgncGVyc29uJyksCiAgICAgICAgcG9kcGluZzogX3BvZGNhc3RJbmRleCgncG9kcGluZycpLAogICAgICAgIHNlYXNvbjogX3BvZGNhc3RJbmRleCgnc2Vhc29uJyksCiAgICAgICAgc29jaWFsOiBfcG9kY2FzdEluZGV4KCdzb2NpYWwnKSwKICAgICAgICBzb2NpYWxJbnRlcmFjdDogX3BvZGNhc3RJbmRleCgnc29jaWFsSW50ZXJhY3QnKSwKICAgICAgICBzb2NpYWxTaWduVXA6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbFNpZ25VcCcpLAogICAgICAgIHNvdW5kYml0ZTogX3BvZGNhc3RJbmRleCgnc291bmRiaXRlJyksCiAgICAgICAgc291cmNlOiBfcG9kY2FzdEluZGV4KCdzb3VyY2UnKSwKICAgICAgICB0cmFpbGVyOiBfcG9kY2FzdEluZGV4KCd0cmFpbGVyJyksCiAgICAgICAgdHJhbnNjcmlwdDogX3BvZGNhc3RJbmRleCgndHJhbnNjcmlwdCcpLAogICAgICAgIHZhbHVlOiBfcG9kY2FzdEluZGV4KCd2YWx1ZScpLAogICAgICAgIHZhbHVlUmVjaXBpZW50OiBfcG9kY2FzdEluZGV4KCd2YWx1ZVJlY2lwaWVudCcpCiAgICB9OwogICAgc3RhdGljIE1lZGlhUnNzID0gewogICAgICAgIE5BTUVTUEFDRTogTUVESUFfUlNTX05BTUVTUEFDRSwKICAgICAgICBvZjogKG5hbWUpPT5fbWVkaWFSc3MobmFtZSkKICAgICAgICAsCiAgICAgICAgY29udGVudDogX21lZGlhUnNzKCdjb250ZW50JykKICAgIH07Cn0KZnVuY3Rpb24gY2hlY2tNYXRjaGVzKG5hbWUsIHZhbHVlLCBwYXR0ZXJuKSB7CiAgICBpZiAoIXBhdHRlcm4udGVzdCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9YCk7CiAgICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gY2hlY2tFcXVhbChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWQpIHsKICAgIGlmICh2YWx1ZSAhPT0gZXhwZWN0ZWQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9LCBleHBlY3RlZCAke2V4cGVjdGVkfWApOwp9CmZ1bmN0aW9uIGNoZWNrVHJ1ZShuYW1lLCB2YWx1ZSwgdGVzdCkgewogICAgaWYgKCF0ZXN0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwp9CmNvbnN0IGhleFJlZ2V4ID0gL15bLStdPzB4W2EtZkEtRjAtOV0rJC87CmNvbnN0IG51bVJlZ2V4ID0gL14oW1wtXCtdKT8oMCopKFwuWzAtOV0rKFtlRV1cLT9bMC05XSspP3xbMC05XSsoXC5bMC05XSsoW2VFXVwtP1swLTldKyk/KT8pJC87CmNvbnN0IGNvbnNpZGVyID0gewogICAgaGV4OiB0cnVlLAogICAgbGVhZGluZ1plcm9zOiB0cnVlLAogICAgZGVjaW1hbFBvaW50OiAiLiIKfTsKZnVuY3Rpb24gdG9OdW1iZXIoc3RyLCBvcHRpb25zID0gewp9KSB7CiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7CiAgICB9LCBjb25zaWRlciwgb3B0aW9ucyk7CiAgICBpZiAoIXN0ciB8fCB0eXBlb2Ygc3RyICE9PSAic3RyaW5nIikgcmV0dXJuIHN0cjsKICAgIGxldCB0cmltbWVkU3RyID0gc3RyLnRyaW0oKTsKICAgIGlmIChvcHRpb25zLnNraXBMaWtlICE9PSB2b2lkIDAgJiYgb3B0aW9ucy5za2lwTGlrZS50ZXN0KHRyaW1tZWRTdHIpKSByZXR1cm4gc3RyOwogICAgZWxzZSBpZiAob3B0aW9ucy5oZXggJiYgaGV4UmVnZXgudGVzdCh0cmltbWVkU3RyKSkgewogICAgICAgIHJldHVybiBOdW1iZXIucGFyc2VJbnQodHJpbW1lZFN0ciwgMTYpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBtYXRjaCA9IG51bVJlZ2V4LmV4ZWModHJpbW1lZFN0cik7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIG1hdGNoWzFdOwogICAgICAgICAgICBjb25zdCBsZWFkaW5nWmVyb3MgPSBtYXRjaFsyXTsKICAgICAgICAgICAgY29uc3QgbnVtID0gbWF0Y2hbM107CiAgICAgICAgICAgIG1hdGNoWzRdIHx8IG1hdGNoWzZdOwogICAgICAgICAgICBpZiAobGVhZGluZ1plcm9zLmxlbmd0aCA9PT0gMSAmJiBudW1bMF0gPT09ICIuIikgcmV0dXJuIE51bWJlcihzdHIpOwogICAgICAgICAgICBlbHNlIGlmICghb3B0aW9ucy5sZWFkaW5nWmVyb3MgJiYgbGVhZGluZ1plcm9zLmxlbmd0aCA+IDApIHJldHVybiBzdHI7CiAgICAgICAgICAgIGVsc2UgcmV0dXJuIE51bWJlcih0cmltbWVkU3RyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0KICAgIH0KfQp2YXIgc3RybnVtID0gdG9OdW1iZXI7CmZ1bmN0aW9uIGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZuLCBiYXNlZGlyLCBtb2R1bGUpIHsKICAgIHJldHVybiBtb2R1bGUgPSB7CiAgICAgICAgcGF0aDogYmFzZWRpciwKICAgICAgICBleHBvcnRzOiB7CiAgICAgICAgfSwKICAgICAgICByZXF1aXJlOiBmdW5jdGlvbihwYXRoLCBiYXNlKSB7CiAgICAgICAgICAgIHJldHVybiBjb21tb25qc1JlcXVpcmUocGF0aCwgYmFzZSA9PT0gdm9pZCAwIHx8IGJhc2UgPT09IG51bGwgPyBtb2R1bGUucGF0aCA6IGJhc2UpOwogICAgICAgIH0KICAgIH0sIGZuKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMpLCBtb2R1bGUuZXhwb3J0czsKfQpmdW5jdGlvbiBjb21tb25qc1JlcXVpcmUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkR5bmFtaWMgcmVxdWlyZXMgYXJlIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkIGJ5IEByb2xsdXAvcGx1Z2luLWNvbW1vbmpzIik7Cn0KdmFyIHV0aWwgPSBjcmVhdGVDb21tb25qc01vZHVsZShmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IG5hbWVTdGFydENoYXIgPSAiOkEtWmEtel9cXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgY29uc3QgbmFtZUNoYXIgPSBuYW1lU3RhcnRDaGFyICsgIlxcLS5cXGRcXHUwMEI3XFx1MDMwMC1cXHUwMzZGXFx1MjAzRi1cXHUyMDQwIjsKICAgIGNvbnN0IG5hbWVSZWdleHAgPSAiWyIgKyBuYW1lU3RhcnRDaGFyICsgIl1bIiArIG5hbWVDaGFyICsgIl0qIjsKICAgIGNvbnN0IHJlZ2V4TmFtZSA9IG5ldyBSZWdFeHAoIl4iICsgbmFtZVJlZ2V4cCArICIkIik7CiAgICBjb25zdCBnZXRBbGxNYXRjaGVzID0gZnVuY3Rpb24oc3RyaW5nLCByZWdleCkgewogICAgICAgIGNvbnN0IG1hdGNoZXMgPSBbXTsKICAgICAgICBsZXQgbWF0Y2ggPSByZWdleC5leGVjKHN0cmluZyk7CiAgICAgICAgd2hpbGUobWF0Y2gpewogICAgICAgICAgICBjb25zdCBhbGxtYXRjaGVzID0gW107CiAgICAgICAgICAgIGFsbG1hdGNoZXMuc3RhcnRJbmRleCA9IHJlZ2V4Lmxhc3RJbmRleCAtIG1hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgY29uc3QgbGVuID0gbWF0Y2gubGVuZ3RoOwogICAgICAgICAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsZW47IGluZGV4KyspewogICAgICAgICAgICAgICAgYWxsbWF0Y2hlcy5wdXNoKG1hdGNoW2luZGV4XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGFsbG1hdGNoZXMpOwogICAgICAgICAgICBtYXRjaCA9IHJlZ2V4LmV4ZWMoc3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9OwogICAgY29uc3QgaXNOYW1lID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSByZWdleE5hbWUuZXhlYyhzdHJpbmcpOwogICAgICAgIHJldHVybiAhKG1hdGNoID09PSBudWxsIHx8IHR5cGVvZiBtYXRjaCA9PT0gInVuZGVmaW5lZCIpOwogICAgfTsKICAgIGV4cG9ydHMuaXNFeGlzdCA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHYgIT09ICJ1bmRlZmluZWQiOwogICAgfTsKICAgIGV4cG9ydHMuaXNFbXB0eU9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLmxlbmd0aCA9PT0gMDsKICAgIH07CiAgICBleHBvcnRzLm1lcmdlID0gZnVuY3Rpb24odGFyZ2V0LCBhLCBhcnJheU1vZGUpIHsKICAgICAgICBpZiAoYSkgewogICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IGtleXMubGVuZ3RoOwogICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgaWYgKGFycmF5TW9kZSA9PT0gInN0cmljdCIpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5c1tpXV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIGFba2V5c1tpXV0KICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5c1tpXV0gPSBhW2tleXNbaV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZ2V0VmFsdWUgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgaWYgKGV4cG9ydHMuaXNFeGlzdCh2KSkgewogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYnVpbGRPcHRpb25zID0gZnVuY3Rpb24ob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMyLCBwcm9wczIpIHsKICAgICAgICBsZXQgbmV3T3B0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIGlmICghb3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdE9wdGlvbnMyOwogICAgICAgIH0KICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgcHJvcHMyLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKG9wdGlvbnNbcHJvcHMyW2ldXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBuZXdPcHRpb25zW3Byb3BzMltpXV0gPSBvcHRpb25zW3Byb3BzMltpXV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdPcHRpb25zW3Byb3BzMltpXV0gPSBkZWZhdWx0T3B0aW9uczJbcHJvcHMyW2ldXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3T3B0aW9uczsKICAgIH07CiAgICBleHBvcnRzLmlzVGFnTmFtZUluQXJyYXlNb2RlID0gZnVuY3Rpb24odGFnTmFtZSwgYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKSB7CiAgICAgICAgaWYgKGFycmF5TW9kZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoYXJyYXlNb2RlIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJheU1vZGUudGVzdCh0YWdOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcnJheU1vZGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuICEhYXJyYXlNb2RlKHRhZ05hbWUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJyYXlNb2RlID09PSAic3RyaWN0IjsKICAgIH07CiAgICBleHBvcnRzLmlzTmFtZSA9IGlzTmFtZTsKICAgIGV4cG9ydHMuZ2V0QWxsTWF0Y2hlcyA9IGdldEFsbE1hdGNoZXM7CiAgICBleHBvcnRzLm5hbWVSZWdleHAgPSBuYW1lUmVnZXhwOwp9KTsKY29uc3QgY29udmVydFRvSnNvbiA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMsIHBhcmVudFRhZ05hbWUpIHsKICAgIGNvbnN0IGpPYmogPSB7CiAgICB9OwogICAgaWYgKCFvcHRpb25zLmFsd2F5c0NyZWF0ZVRleHROb2RlICYmICghbm9kZS5jaGlsZCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5jaGlsZCkpICYmICghbm9kZS5hdHRyc01hcCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5hdHRyc01hcCkpKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuaXNFeGlzdChub2RlLnZhbCkgPyBub2RlLnZhbCA6ICIiOwogICAgfQogICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkgJiYgISh0eXBlb2Ygbm9kZS52YWwgPT09ICJzdHJpbmciICYmIChub2RlLnZhbCA9PT0gIiIgfHwgbm9kZS52YWwgPT09IG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIpKSkgewogICAgICAgIGNvbnN0IGFzQXJyYXkgPSB1dGlsLmlzVGFnTmFtZUluQXJyYXlNb2RlKG5vZGUudGFnbmFtZSwgb3B0aW9ucy5hcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgIGpPYmpbb3B0aW9ucy50ZXh0Tm9kZU5hbWVdID0gYXNBcnJheSA/IFsKICAgICAgICAgICAgbm9kZS52YWwKICAgICAgICBdIDogbm9kZS52YWw7CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXAsIG9wdGlvbnMuYXJyYXlNb2RlKTsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhub2RlLmNoaWxkKTsKICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGtleXMubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBjb25zdCB0YWdOYW1lID0ga2V5c1tpbmRleF07CiAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnTmFtZV0gJiYgbm9kZS5jaGlsZFt0YWdOYW1lXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBbXTsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWdOYW1lXSl7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWdOYW1lXS5oYXNPd25Qcm9wZXJ0eSh0YWcpKSB7CiAgICAgICAgICAgICAgICAgICAgak9ialt0YWdOYW1lXS5wdXNoKGNvbnZlcnRUb0pzb24obm9kZS5jaGlsZFt0YWdOYW1lXVt0YWddLCBvcHRpb25zLCB0YWdOYW1lKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBjb252ZXJ0VG9Kc29uKG5vZGUuY2hpbGRbdGFnTmFtZV1bMF0sIG9wdGlvbnMsIHRhZ05hbWUpOwogICAgICAgICAgICBjb25zdCBhc0FycmF5ID0gb3B0aW9ucy5hcnJheU1vZGUgPT09IHRydWUgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgfHwgdXRpbC5pc1RhZ05hbWVJbkFycmF5TW9kZSh0YWdOYW1lLCBvcHRpb25zLmFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBhc0FycmF5ID8gWwogICAgICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICAgIF0gOiByZXN1bHQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGpPYmo7Cn07CnZhciBjb252ZXJ0VG9Kc29uXzEgPSBjb252ZXJ0VG9Kc29uOwp2YXIgbm9kZTJqc29uID0gewogICAgY29udmVydFRvSnNvbjogY29udmVydFRvSnNvbl8xCn07CnZhciB4bWxOb2RlID0gZnVuY3Rpb24odGFnbmFtZSwgcGFyZW50LCB2YWwpIHsKICAgIHRoaXMudGFnbmFtZSA9IHRhZ25hbWU7CiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgIHRoaXMuY2hpbGQgPSB7CiAgICB9OwogICAgdGhpcy5hdHRyc01hcCA9IHsKICAgIH07CiAgICB0aGlzLnZhbCA9IHZhbDsKICAgIHRoaXMuYWRkQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0pKSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0ucHVzaChjaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXSA9IFsKICAgICAgICAgICAgICAgIGNoaWxkCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgfTsKfTsKY29uc3QgYnVpbGRPcHRpb25zID0gdXRpbC5idWlsZE9wdGlvbnM7CiI8KCghXFxbQ0RBVEFcXFsoW1xcc1xcU10qPykoXV0+KSl8KChOQU1FOik/KE5BTUUpKShbXj5dKik+fCgoXFwvKShOQU1FKVxccyo+KSkoW148XSopIi5yZXBsYWNlKC9OQU1FL2csIHV0aWwubmFtZVJlZ2V4cCk7CmlmICghTnVtYmVyLnBhcnNlSW50ICYmIHdpbmRvdy5wYXJzZUludCkgewogICAgTnVtYmVyLnBhcnNlSW50ID0gd2luZG93LnBhcnNlSW50Owp9CmlmICghTnVtYmVyLnBhcnNlRmxvYXQgJiYgd2luZG93LnBhcnNlRmxvYXQpIHsKICAgIE51bWJlci5wYXJzZUZsb2F0ID0gd2luZG93LnBhcnNlRmxvYXQ7Cn0KY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7CiAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAiQF8iLAogICAgYXR0ck5vZGVOYW1lOiBmYWxzZSwKICAgIHRleHROb2RlTmFtZTogIiN0ZXh0IiwKICAgIGlnbm9yZUF0dHJpYnV0ZXM6IHRydWUsCiAgICBpZ25vcmVOYW1lU3BhY2U6IGZhbHNlLAogICAgYWxsb3dCb29sZWFuQXR0cmlidXRlczogZmFsc2UsCiAgICBwYXJzZU5vZGVWYWx1ZTogdHJ1ZSwKICAgIHBhcnNlQXR0cmlidXRlVmFsdWU6IGZhbHNlLAogICAgYXJyYXlNb2RlOiBmYWxzZSwKICAgIHRyaW1WYWx1ZXM6IHRydWUsCiAgICBjZGF0YVRhZ05hbWU6IGZhbHNlLAogICAgY2RhdGFQb3NpdGlvbkNoYXI6ICJcXGMiLAogICAgbnVtUGFyc2VPcHRpb25zOiB7CiAgICAgICAgaGV4OiB0cnVlLAogICAgICAgIGxlYWRpbmdaZXJvczogdHJ1ZQogICAgfSwKICAgIHRhZ1ZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhLCB0YWdOYW1lKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgYXR0clZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhLCBhdHRyTmFtZSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIHN0b3BOb2RlczogW10sCiAgICBhbHdheXNDcmVhdGVUZXh0Tm9kZTogZmFsc2UKfTsKdmFyIGRlZmF1bHRPcHRpb25zXzEgPSBkZWZhdWx0T3B0aW9uczsKY29uc3QgcHJvcHMgPSBbCiAgICAiYXR0cmlidXRlTmFtZVByZWZpeCIsCiAgICAiYXR0ck5vZGVOYW1lIiwKICAgICJ0ZXh0Tm9kZU5hbWUiLAogICAgImlnbm9yZUF0dHJpYnV0ZXMiLAogICAgImlnbm9yZU5hbWVTcGFjZSIsCiAgICAiYWxsb3dCb29sZWFuQXR0cmlidXRlcyIsCiAgICAicGFyc2VOb2RlVmFsdWUiLAogICAgInBhcnNlQXR0cmlidXRlVmFsdWUiLAogICAgImFycmF5TW9kZSIsCiAgICAidHJpbVZhbHVlcyIsCiAgICAiY2RhdGFUYWdOYW1lIiwKICAgICJjZGF0YVBvc2l0aW9uQ2hhciIsCiAgICAidGFnVmFsdWVQcm9jZXNzb3IiLAogICAgImF0dHJWYWx1ZVByb2Nlc3NvciIsCiAgICAicGFyc2VUcnVlTnVtYmVyT25seSIsCiAgICAibnVtUGFyc2VPcHRpb25zIiwKICAgICJzdG9wTm9kZXMiLAogICAgImFsd2F5c0NyZWF0ZVRleHROb2RlIgpdOwp2YXIgcHJvcHNfMSA9IHByb3BzOwpmdW5jdGlvbiBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdmFsLCBvcHRpb25zKSB7CiAgICBpZiAodmFsKSB7CiAgICAgICAgaWYgKG9wdGlvbnMudHJpbVZhbHVlcykgewogICAgICAgICAgICB2YWwgPSB2YWwudHJpbSgpOwogICAgICAgIH0KICAgICAgICB2YWwgPSBvcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKHZhbCwgdGFnTmFtZSk7CiAgICAgICAgdmFsID0gcGFyc2VWYWx1ZSh2YWwsIG9wdGlvbnMucGFyc2VOb2RlVmFsdWUsIG9wdGlvbnMubnVtUGFyc2VPcHRpb25zKTsKICAgIH0KICAgIHJldHVybiB2YWw7Cn0KZnVuY3Rpb24gcmVzb2x2ZU5hbWVTcGFjZSh0YWduYW1lLCBvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICBjb25zdCB0YWdzID0gdGFnbmFtZS5zcGxpdCgiOiIpOwogICAgICAgIGNvbnN0IHByZWZpeCA9IHRhZ25hbWUuY2hhckF0KDApID09PSAiLyIgPyAiLyIgOiAiIjsKICAgICAgICBpZiAodGFnc1swXSA9PT0gInhtbG5zIikgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGlmICh0YWdzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICB0YWduYW1lID0gcHJlZml4ICsgdGFnc1sxXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFnbmFtZTsKfQpmdW5jdGlvbiBwYXJzZVZhbHVlKHZhbCwgc2hvdWxkUGFyc2UsIG9wdGlvbnMpIHsKICAgIGlmIChzaG91bGRQYXJzZSAmJiB0eXBlb2YgdmFsID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IG5ld3ZhbCA9IHZhbC50cmltKCk7CiAgICAgICAgaWYgKG5ld3ZhbCA9PT0gInRydWUiKSByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlIGlmIChuZXd2YWwgPT09ICJmYWxzZSIpIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIHJldHVybiBzdHJudW0odmFsLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNFeGlzdCh2YWwpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBhdHRyc1JlZ3ggPSBuZXcgUmVnRXhwKGAoW15cXHM9XSspXFxzKig9XFxzKihbJyJdKSguKj8pXFwzKT9gLCAiZyIpOwpmdW5jdGlvbiBidWlsZEF0dHJpYnV0ZXNNYXAoYXR0clN0ciwgb3B0aW9ucykgewogICAgaWYgKCFvcHRpb25zLmlnbm9yZUF0dHJpYnV0ZXMgJiYgdHlwZW9mIGF0dHJTdHIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgYXR0clN0ciA9IGF0dHJTdHIucmVwbGFjZSgvXHI/XG4vZywgIiAiKTsKICAgICAgICBjb25zdCBtYXRjaGVzID0gdXRpbC5nZXRBbGxNYXRjaGVzKGF0dHJTdHIsIGF0dHJzUmVneCk7CiAgICAgICAgY29uc3QgbGVuID0gbWF0Y2hlcy5sZW5ndGg7CiAgICAgICAgY29uc3QgYXR0cnMgPSB7CiAgICAgICAgfTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBjb25zdCBhdHRyTmFtZSA9IHJlc29sdmVOYW1lU3BhY2UobWF0Y2hlc1tpXVsxXSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChhdHRyTmFtZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVzW2ldWzRdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy50cmltVmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXNbaV1bNF0gPSBtYXRjaGVzW2ldWzRdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlc1tpXVs0XSA9IG9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKG1hdGNoZXNbaV1bNF0sIGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tvcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXggKyBhdHRyTmFtZV0gPSBwYXJzZVZhbHVlKG1hdGNoZXNbaV1bNF0sIG9wdGlvbnMucGFyc2VBdHRyaWJ1dGVWYWx1ZSwgb3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tvcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXggKyBhdHRyTmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghT2JqZWN0LmtleXMoYXR0cnMpLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLmF0dHJOb2RlTmFtZSkgewogICAgICAgICAgICBjb25zdCBhdHRyQ29sbGVjdGlvbiA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYXR0ckNvbGxlY3Rpb25bb3B0aW9ucy5hdHRyTm9kZU5hbWVdID0gYXR0cnM7CiAgICAgICAgICAgIHJldHVybiBhdHRyQ29sbGVjdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQp9CmNvbnN0IGdldFRyYXZlcnNhbE9iaiA9IGZ1bmN0aW9uKHhtbERhdGEsIG9wdGlvbnMpIHsKICAgIHhtbERhdGEgPSB4bWxEYXRhLnJlcGxhY2UoL1xyXG4/L2csICJcbiIpOwogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucywgcHJvcHMpOwogICAgY29uc3QgeG1sT2JqID0gbmV3IHhtbE5vZGUoIiF4bWwiKTsKICAgIGxldCBjdXJyZW50Tm9kZSA9IHhtbE9iajsKICAgIGxldCB0ZXh0RGF0YSA9ICIiOwogICAgZm9yKGxldCBpID0gMDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGNvbnN0IGNoID0geG1sRGF0YVtpXTsKICAgICAgICBpZiAoY2ggPT09ICI8IikgewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiQ2xvc2luZyBUYWcgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0geG1sRGF0YS5zdWJzdHJpbmcoaSArIDIsIGNsb3NlSW5kZXgpLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BOb2Rlcy5sZW5ndGggJiYgb3B0aW9ucy5zdG9wTm9kZXMuaW5jbHVkZXMoY3VycmVudE5vZGUudGFnbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5jaGlsZCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5hdHRyc01hcCA9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYXR0cnNNYXAgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHhtbERhdGEuc3Vic3RyKGN1cnJlbnROb2RlLnN0YXJ0SW5kZXggKyAxLCBpIC0gY3VycmVudE5vZGUuc3RhcnRJbmRleCAtIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5wYXJlbnQ7CiAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgaSA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj8+IiwgaSwgIlBpIFRhZyBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAzKSA9PT0gIiEtLSIpIHsKICAgICAgICAgICAgICAgIGkgPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICItLT4iLCBpLCAiQ29tbWVudCBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFEIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiRE9DVFlQRSBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICAgICAgY29uc3QgdGFnRXhwID0geG1sRGF0YS5zdWJzdHJpbmcoaSwgY2xvc2VJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmluZGV4T2YoIlsiKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHhtbERhdGEuaW5kZXhPZigiXT4iLCBpKSArIDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFbIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIl1dPiIsIGksICJDREFUQSBpcyBub3QgY2xvc2VkLiIpIC0gMjsKICAgICAgICAgICAgICAgIGNvbnN0IHRhZ0V4cCA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyA5LCBjbG9zZUluZGV4KTsKICAgICAgICAgICAgICAgIGlmICh0ZXh0RGF0YSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUob3B0aW9ucy5jZGF0YVRhZ05hbWUsIGN1cnJlbnROb2RlLCB0YWdFeHApOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcjsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS52YWwgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSAoY3VycmVudE5vZGUudmFsIHx8ICIiKSArICh0YWdFeHAgfHwgIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXggKyAyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2xvc2luZ0luZGV4Rm9yT3BlbmluZ1RhZyh4bWxEYXRhLCBpICsgMSk7CiAgICAgICAgICAgICAgICBsZXQgdGFnRXhwID0gcmVzdWx0LmRhdGE7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gcmVzdWx0LmluZGV4OwogICAgICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9ySW5kZXggPSB0YWdFeHAuaW5kZXhPZigiICIpOwogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICBsZXQgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChzZXBhcmF0b3JJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnRXhwLnN1YnN0cigwLCBzZXBhcmF0b3JJbmRleCkucmVwbGFjZSgvXHNccyokLywgIiIpOwogICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoc2VwYXJhdG9ySW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdGFnTmFtZSAhPT0gcmVzdWx0LmRhdGEuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUgJiYgdGV4dERhdGEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudGFnbmFtZSAhPT0gIiF4bWwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmxlbmd0aCA+IDAgJiYgdGFnRXhwLmxhc3RJbmRleE9mKCIvIikgPT09IHRhZ0V4cC5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cigwLCB0YWdOYW1lLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdOYW1lOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoMCwgdGFnRXhwLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZSh0YWdOYW1lLCBjdXJyZW50Tm9kZSwgIiIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLmF0dHJzTWFwID0gYnVpbGRBdHRyaWJ1dGVzTWFwKHRhZ0V4cCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKHRhZ05hbWUsIGN1cnJlbnROb2RlKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGNoaWxkTm9kZS50YWduYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuc3RhcnRJbmRleCA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHAgJiYgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5hdHRyc01hcCA9IGJ1aWxkQXR0cmlidXRlc01hcCh0YWdFeHAsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY2hpbGROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGV4dERhdGEgKz0geG1sRGF0YVtpXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4geG1sT2JqOwp9OwpmdW5jdGlvbiBjbG9zaW5nSW5kZXhGb3JPcGVuaW5nVGFnKGRhdGEsIGkpIHsKICAgIGxldCBhdHRyQm91bmRhcnk7CiAgICBsZXQgdGFnRXhwID0gIiI7CiAgICBmb3IobGV0IGluZGV4ID0gaTsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgbGV0IGNoID0gZGF0YVtpbmRleF07CiAgICAgICAgaWYgKGF0dHJCb3VuZGFyeSkgewogICAgICAgICAgICBpZiAoY2ggPT09IGF0dHJCb3VuZGFyeSkgYXR0ckJvdW5kYXJ5ID0gIiI7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJyInIHx8IGNoID09PSAiJyIpIHsKICAgICAgICAgICAgYXR0ckJvdW5kYXJ5ID0gY2g7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIj4iKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkYXRhOiB0YWdFeHAsCiAgICAgICAgICAgICAgICBpbmRleAogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICIJIikgewogICAgICAgICAgICBjaCA9ICIgIjsKICAgICAgICB9CiAgICAgICAgdGFnRXhwICs9IGNoOwogICAgfQp9CmZ1bmN0aW9uIGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgc3RyLCBpLCBlcnJNc2cpIHsKICAgIGNvbnN0IGNsb3NpbmdJbmRleCA9IHhtbERhdGEuaW5kZXhPZihzdHIsIGkpOwogICAgaWYgKGNsb3NpbmdJbmRleCA9PT0gLTEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNsb3NpbmdJbmRleCArIHN0ci5sZW5ndGggLSAxOwogICAgfQp9CnZhciBnZXRUcmF2ZXJzYWxPYmpfMSA9IGdldFRyYXZlcnNhbE9iajsKdmFyIHhtbHN0cjJ4bWxub2RlID0gewogICAgZGVmYXVsdE9wdGlvbnM6IGRlZmF1bHRPcHRpb25zXzEsCiAgICBwcm9wczogcHJvcHNfMSwKICAgIGdldFRyYXZlcnNhbE9iajogZ2V0VHJhdmVyc2FsT2JqXzEKfTsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMSA9IHsKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlCn07CmNvbnN0IHByb3BzJDEgPSBbCiAgICAiYWxsb3dCb29sZWFuQXR0cmlidXRlcyIKXTsKdmFyIHZhbGlkYXRlID0gZnVuY3Rpb24oeG1sRGF0YSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDEsIHByb3BzJDEpOwogICAgY29uc3QgdGFncyA9IFtdOwogICAgbGV0IHRhZ0ZvdW5kID0gZmFsc2U7CiAgICBsZXQgcmVhY2hlZFJvb3QgPSBmYWxzZTsKICAgIGlmICh4bWxEYXRhWzBdID09PSAiXHVGRUZGIikgewogICAgICAgIHhtbERhdGEgPSB4bWxEYXRhLnN1YnN0cigxKTsKICAgIH0KICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiICYmIHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICBpID0gcmVhZFBJKHhtbERhdGEsIGkpOwogICAgICAgICAgICBpZiAoaS5lcnIpIHJldHVybiBpOwogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgIGxldCB0YWdTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgaSA9IHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxldCBjbG9zaW5nVGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgY2xvc2luZ1RhZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSAiIjsKICAgICAgICAgICAgICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aCAmJiB4bWxEYXRhW2ldICE9PSAiPiIgJiYgeG1sRGF0YVtpXSAhPT0gIiAiICYmIHhtbERhdGFbaV0gIT09ICIJIiAmJiB4bWxEYXRhW2ldICE9PSAiXG4iICYmIHhtbERhdGFbaV0gIT09ICJcciI7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSArPSB4bWxEYXRhW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUudHJpbSgpOwogICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyaW5nKDAsIHRhZ05hbWUubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVRhZ05hbWUodGFnTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgbXNnOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIkludmFsaWQgc3BhY2UgYWZ0ZXIgJzwnLiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIlRhZyAnIiArIHRhZ05hbWUgKyAiJyBpcyBhbiBpbnZhbGlkIG5hbWUuIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgbXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGVzIGZvciAnIiArIHRhZ05hbWUgKyAiJyBoYXZlIG9wZW4gcXVvdGUuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBhdHRyU3RyID0gcmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgaSA9IHJlc3VsdC5pbmRleDsKICAgICAgICAgICAgICAgIGlmIChhdHRyU3RyW2F0dHJTdHIubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJTdHJTdGFydCA9IGkgLSBhdHRyU3RyLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyID0gYXR0clN0ci5zdWJzdHJpbmcoMCwgYXR0clN0ci5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdChpc1ZhbGlkLmVyci5jb2RlLCBpc1ZhbGlkLmVyci5tc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBhdHRyU3RyU3RhcnQgKyBpc1ZhbGlkLmVyci5saW5lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zaW5nVGFnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQudGFnQ2xvc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJDbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJyBkb2Vzbid0IGhhdmUgcHJvcGVyIGNsb3NpbmcuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJTdHIudHJpbSgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInIGNhbid0IGhhdmUgYXR0cmlidXRlcyBvciBpbnZhbGlkIHN0YXJ0aW5nLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdTdGFydFBvcykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG90ZyA9IHRhZ3MucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSBvdGcudGFnTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9wZW5Qb3MgPSBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgb3RnLnRhZ1N0YXJ0UG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJFeHBlY3RlZCBjbG9zaW5nIHRhZyAnIiArIG90Zy50YWdOYW1lICsgIicgKG9wZW5lZCBpbiBsaW5lICIgKyBvcGVuUG9zLmxpbmUgKyAiLCBjb2wgIiArIG9wZW5Qb3MuY29sICsgIikgaW5zdGVhZCBvZiBjbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnU3RhcnRQb3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhY2hlZFJvb3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KGlzVmFsaWQuZXJyLmNvZGUsIGlzVmFsaWQuZXJyLm1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkgLSBhdHRyU3RyLmxlbmd0aCArIGlzVmFsaWQuZXJyLmxpbmUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWNoZWRSb290ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJNdWx0aXBsZSBwb3NzaWJsZSByb290IG5vZGVzIGZvdW5kLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFncy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdTdGFydFBvcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yKGkrKzsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiISIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHJlYWRQSSh4bWxEYXRhLCArK2kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkuZXJyKSByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWZ0ZXJBbXAgPSB2YWxpZGF0ZUFtcGVyc2FuZCh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFmdGVyQW1wID09IC0xKSByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRDaGFyIiwgImNoYXIgJyYnIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgICAgICBpID0gYWZ0ZXJBbXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiICIgfHwgeG1sRGF0YVtpXSA9PT0gIgkiIHx8IHhtbERhdGFbaV0gPT09ICJcbiIgfHwgeG1sRGF0YVtpXSA9PT0gIlxyIikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQ2hhciIsICJjaGFyICciICsgeG1sRGF0YVtpXSArICInIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgIH0KICAgIH0KICAgIGlmICghdGFnRm91bmQpIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiU3RhcnQgdGFnIGV4cGVjdGVkLiIsIDEpOwogICAgfSBlbHNlIGlmICh0YWdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIlVuY2xvc2VkIHRhZyAnIiArIHRhZ3NbMF0udGFnTmFtZSArICInLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdzWzBdLnRhZ1N0YXJ0UG9zKSk7CiAgICB9IGVsc2UgaWYgKHRhZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJJbnZhbGlkICciICsgSlNPTi5zdHJpbmdpZnkodGFncy5tYXAoKHQpPT50LnRhZ05hbWUKICAgICAgICApLCBudWxsLCA0KS5yZXBsYWNlKC9ccj9cbi9nLCAiIikgKyAiJyBmb3VuZC4iLCB7CiAgICAgICAgICAgIGxpbmU6IDEsCiAgICAgICAgICAgIGNvbDogMQogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn07CmZ1bmN0aW9uIHJlYWRQSSh4bWxEYXRhLCBpKSB7CiAgICBjb25zdCBzdGFydCA9IGk7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT0gIj8iIHx8IHhtbERhdGFbaV0gPT0gIiAiKSB7CiAgICAgICAgICAgIGNvbnN0IHRhZ25hbWUgPSB4bWxEYXRhLnN1YnN0cihzdGFydCwgaSAtIHN0YXJ0KTsKICAgICAgICAgICAgaWYgKGkgPiA1ICYmIHRhZ25hbWUgPT09ICJ4bWwiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiWE1MIGRlY2xhcmF0aW9uIGFsbG93ZWQgb25seSBhdCB0aGUgc3RhcnQgb2YgdGhlIGRvY3VtZW50LiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PSAiPyIgJiYgeG1sRGF0YVtpICsgMV0gPT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKSB7CiAgICBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgNSAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDJdID09PSAiLSIpIHsKICAgICAgICBmb3IoaSArPSAzOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgOCAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDJdID09PSAiTyIgJiYgeG1sRGF0YVtpICsgM10gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyA0XSA9PT0gIlQiICYmIHhtbERhdGFbaSArIDVdID09PSAiWSIgJiYgeG1sRGF0YVtpICsgNl0gPT09ICJQIiAmJiB4bWxEYXRhW2kgKyA3XSA9PT0gIkUiKSB7CiAgICAgICAgbGV0IGFuZ2xlQnJhY2tldHNDb3VudCA9IDE7CiAgICAgICAgZm9yKGkgKz0gODsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBhbmdsZUJyYWNrZXRzQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGFuZ2xlQnJhY2tldHNDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKGFuZ2xlQnJhY2tldHNDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA5ICYmIHhtbERhdGFbaSArIDFdID09PSAiWyIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyAzXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDRdID09PSAiQSIgJiYgeG1sRGF0YVtpICsgNV0gPT09ICJUIiAmJiB4bWxEYXRhW2kgKyA2XSA9PT0gIkEiICYmIHhtbERhdGFbaSArIDddID09PSAiWyIpIHsKICAgICAgICBmb3IoaSArPSA4OyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiXSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICJdIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwp9CmNvbnN0IGRvdWJsZVF1b3RlID0gJyInOwpjb25zdCBzaW5nbGVRdW90ZSA9ICInIjsKZnVuY3Rpb24gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKSB7CiAgICBsZXQgYXR0clN0ciA9ICIiOwogICAgbGV0IHN0YXJ0Q2hhciA9ICIiOwogICAgbGV0IHRhZ0Nsb3NlZCA9IGZhbHNlOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSBkb3VibGVRdW90ZSB8fCB4bWxEYXRhW2ldID09PSBzaW5nbGVRdW90ZSkgewogICAgICAgICAgICBpZiAoc3RhcnRDaGFyID09PSAiIikgewogICAgICAgICAgICAgICAgc3RhcnRDaGFyID0geG1sRGF0YVtpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydENoYXIgIT09IHhtbERhdGFbaV0pIDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydENoYXIgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIj4iKSB7CiAgICAgICAgICAgIGlmIChzdGFydENoYXIgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0YWdDbG9zZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXR0clN0ciArPSB4bWxEYXRhW2ldOwogICAgfQogICAgaWYgKHN0YXJ0Q2hhciAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBhdHRyU3RyLAogICAgICAgIGluZGV4OiBpLAogICAgICAgIHRhZ0Nsb3NlZAogICAgfTsKfQpjb25zdCB2YWxpZEF0dHJTdHJSZWd4cCA9IG5ldyBSZWdFeHAoYChcXHMqKShbXlxccz1dKykoXFxzKj0pPyhcXHMqKFsnIl0pKChbXFxzXFxTXSkqPylcXDUpP2AsICJnIik7CmZ1bmN0aW9uIHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGNvbnN0IG1hdGNoZXMgPSB1dGlsLmdldEFsbE1hdGNoZXMoYXR0clN0ciwgdmFsaWRBdHRyU3RyUmVneHApOwogICAgY29uc3QgYXR0ck5hbWVzID0gewogICAgfTsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCBtYXRjaGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAobWF0Y2hlc1tpXVsxXS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaGFzIG5vIHNwYWNlIGluIHN0YXJ0aW5nLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoZXNbaV1bM10gPT09IHZvaWQgMCAmJiAhb3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiYm9vbGVhbiBhdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaXMgbm90IGFsbG93ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyTmFtZSA9IG1hdGNoZXNbaV1bMl07CiAgICAgICAgaWYgKCF2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgYW4gaW52YWxpZCBuYW1lLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhdHRyTmFtZXMuaGFzT3duUHJvcGVydHkoYXR0ck5hbWUpKSB7CiAgICAgICAgICAgIGF0dHJOYW1lc1thdHRyTmFtZV0gPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgYXR0ck5hbWUgKyAiJyBpcyByZXBlYXRlZC4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgbGV0IHJlID0gL1xkLzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAieCIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmUgPSAvW1xkYS1mQS1GXS87CiAgICB9CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIGk7CiAgICAgICAgaWYgKCF4bWxEYXRhW2ldLm1hdGNoKHJlKSkgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gLTE7Cn0KZnVuY3Rpb24gdmFsaWRhdGVBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgaSsrOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIC0xOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICIjIikgewogICAgICAgIGkrKzsKICAgICAgICByZXR1cm4gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSk7CiAgICB9CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyssIGNvdW50KyspewogICAgICAgIGlmICh4bWxEYXRhW2ldLm1hdGNoKC9cdy8pICYmIGNvdW50IDwgMjApIGNvbnRpbnVlOwogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIGJyZWFrOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHJldHVybiBpOwp9CmZ1bmN0aW9uIGdldEVycm9yT2JqZWN0KGNvZGUsIG1lc3NhZ2UsIGxpbmVOdW1iZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZXJyOiB7CiAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgIG1zZzogbWVzc2FnZSwKICAgICAgICAgICAgbGluZTogbGluZU51bWJlci5saW5lIHx8IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbDogbGluZU51bWJlci5jb2wKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIHZhbGlkYXRlQXR0ck5hbWUoYXR0ck5hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZShhdHRyTmFtZSk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVUYWdOYW1lKHRhZ25hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZSh0YWduYW1lKTsKfQpmdW5jdGlvbiBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaW5kZXgpIHsKICAgIGNvbnN0IGxpbmVzID0geG1sRGF0YS5zdWJzdHJpbmcoMCwgaW5kZXgpLnNwbGl0KC9ccj9cbi8pOwogICAgcmV0dXJuIHsKICAgICAgICBsaW5lOiBsaW5lcy5sZW5ndGgsCiAgICAgICAgY29sOiBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXS5sZW5ndGggKyAxCiAgICB9Owp9CmZ1bmN0aW9uIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoKSB7CiAgICByZXR1cm4gbWF0Y2guc3RhcnRJbmRleCArIG1hdGNoWzFdLmxlbmd0aDsKfQp2YXIgdmFsaWRhdG9yID0gewogICAgdmFsaWRhdGUKfTsKY29uc3QgX19jaGFyID0gZnVuY3Rpb24oYSkgewogICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoYSk7Cn07CmNvbnN0IGNoYXJzID0gewogICAgbmlsQ2hhcjogX19jaGFyKDE3NiksCiAgICBtaXNzaW5nQ2hhcjogX19jaGFyKDIwMSksCiAgICBuaWxQcmVtaXRpdmU6IF9fY2hhcigxNzUpLAogICAgbWlzc2luZ1ByZW1pdGl2ZTogX19jaGFyKDIwMCksCiAgICBlbXB0eUNoYXI6IF9fY2hhcigxNzgpLAogICAgZW1wdHlWYWx1ZTogX19jaGFyKDE3NyksCiAgICBib3VuZHJ5Q2hhcjogX19jaGFyKDE3OSksCiAgICBvYmpTdGFydDogX19jaGFyKDE5OCksCiAgICBhcnJTdGFydDogX19jaGFyKDIwNCksCiAgICBhcnJheUVuZDogX19jaGFyKDE4NSkKfTsKY29uc3QgY2hhcnNBcnIgPSBbCiAgICBjaGFycy5uaWxDaGFyLAogICAgY2hhcnMubmlsUHJlbWl0aXZlLAogICAgY2hhcnMubWlzc2luZ0NoYXIsCiAgICBjaGFycy5taXNzaW5nUHJlbWl0aXZlLAogICAgY2hhcnMuYm91bmRyeUNoYXIsCiAgICBjaGFycy5lbXB0eUNoYXIsCiAgICBjaGFycy5lbXB0eVZhbHVlLAogICAgY2hhcnMuYXJyYXlFbmQsCiAgICBjaGFycy5vYmpTdGFydCwKICAgIGNoYXJzLmFyclN0YXJ0Cl07CmNvbnN0IF9lID0gZnVuY3Rpb24obm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgZV9zY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZVswXSAmJiBub2RlWzBdLnZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlWzBdLnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldFZhbHVlKG5vZGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaGFzVmFsaWREYXRhID0gaGFzRGF0YShub2RlKTsKICAgICAgICBpZiAoaGFzVmFsaWREYXRhID09PSB0cnVlKSB7CiAgICAgICAgICAgIGxldCBzdHIgPSAiIjsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZV9zY2hlbWEpKSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBpdGVtU2NoZW1hID0gZV9zY2hlbWFbMF07CiAgICAgICAgICAgICAgICBjb25zdCBhcnJfbGVuID0gbm9kZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW1TY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBhcnJfaSA9IDA7IGFycl9pIDwgYXJyX2xlbjsgYXJyX2krKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBnZXRWYWx1ZShub2RlW2Fycl9pXS52YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gX2Uobm9kZVthcnJfaV0sIGl0ZW1TY2hlbWEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyYXlFbmQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMub2JqU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZV9zY2hlbWEpOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihsZXQgaSBpbiBrZXlzKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgICAgICAgIGxldCByOwogICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIG5vZGUuYXR0cnNNYXAgJiYgbm9kZS5hdHRyc01hcFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmF0dHJzTWFwW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSBvcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS52YWwsIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmNoaWxkW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBoYXNWYWxpZERhdGE7CiAgICAgICAgfQogICAgfQp9Owpjb25zdCBnZXRWYWx1ZSA9IGZ1bmN0aW9uKGEpIHsKICAgIHN3aXRjaChhKXsKICAgICAgICBjYXNlIHZvaWQgMDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm1pc3NpbmdQcmVtaXRpdmU7CiAgICAgICAgY2FzZSBudWxsOgogICAgICAgICAgICByZXR1cm4gY2hhcnMubmlsUHJlbWl0aXZlOwogICAgICAgIGNhc2UgIiI6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5lbXB0eVZhbHVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9jZXNzVmFsdWUgPSBmdW5jdGlvbihzdHIsIHIpIHsKICAgIGlmICghaXNBcHBDaGFyKHJbMF0pICYmICFpc0FwcENoYXIoc3RyW3N0ci5sZW5ndGggLSAxXSkpIHsKICAgICAgICBzdHIgKz0gY2hhcnMuYm91bmRyeUNoYXI7CiAgICB9CiAgICByZXR1cm4gc3RyICsgcjsKfTsKY29uc3QgaXNBcHBDaGFyID0gZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiBjaGFyc0Fyci5pbmRleE9mKGNoKSAhPT0gLTE7Cn07CmZ1bmN0aW9uIGhhc0RhdGEoak9iaikgewogICAgaWYgKGpPYmogPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iaiA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBjaGFycy5uaWxDaGFyOwogICAgfSBlbHNlIGlmIChqT2JqLmNoaWxkICYmIE9iamVjdC5rZXlzKGpPYmouY2hpbGQpLmxlbmd0aCA9PT0gMCAmJiAoIWpPYmouYXR0cnNNYXAgfHwgT2JqZWN0LmtleXMoak9iai5hdHRyc01hcCkubGVuZ3RoID09PSAwKSkgewogICAgICAgIHJldHVybiBjaGFycy5lbXB0eUNoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9CmNvbnN0IGJ1aWxkT3B0aW9ucyQxID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGNvbnZlcnQybmltbiA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gYnVpbGRPcHRpb25zJDEob3B0aW9ucywgeG1sc3RyMnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLnByb3BzKTsKICAgIHJldHVybiBfZShub2RlLCBlX3NjaGVtYSwgb3B0aW9ucyk7Cn07CnZhciBjb252ZXJ0Mm5pbW5fMSA9IGNvbnZlcnQybmltbjsKdmFyIG5pbW5kYXRhID0gewogICAgY29udmVydDJuaW1uOiBjb252ZXJ0Mm5pbW5fMQp9Owpjb25zdCBidWlsZE9wdGlvbnMkMiA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0VG9Kc29uU3RyaW5nID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQyKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICBvcHRpb25zLmluZGVudEJ5ID0gb3B0aW9ucy5pbmRlbnRCeSB8fCAiIjsKICAgIHJldHVybiBfY1RvSnNvblN0cihub2RlLCBvcHRpb25zKTsKfTsKY29uc3QgX2NUb0pzb25TdHIgPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBsZXZlbCkgewogICAgbGV0IGpPYmogPSAieyI7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5jaGlsZCk7CiAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgY29uc3QgdGFnbmFtZSA9IGtleXNbaW5kZXhdOwogICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ25hbWVdICYmIG5vZGUuY2hpbGRbdGFnbmFtZV0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6IFsgJzsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWduYW1lXSl7CiAgICAgICAgICAgICAgICBqT2JqICs9IF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bdGFnXSwgb3B0aW9ucykgKyAiICwgIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBqT2JqID0gak9iai5zdWJzdHIoMCwgak9iai5sZW5ndGggLSAxKSArICIgXSAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGpPYmogKz0gJyInICsgdGFnbmFtZSArICciIDogJyArIF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bMF0sIG9wdGlvbnMpICsgIiAsIjsKICAgICAgICB9CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXApOwogICAgaWYgKHV0aWwuaXNFbXB0eU9iamVjdChqT2JqKSkgewogICAgICAgIHJldHVybiB1dGlsLmlzRXhpc3Qobm9kZS52YWwpID8gbm9kZS52YWwgOiAiIjsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkpIHsKICAgICAgICAgICAgaWYgKCEodHlwZW9mIG5vZGUudmFsID09PSAic3RyaW5nIiAmJiAobm9kZS52YWwgPT09ICIiIHx8IG5vZGUudmFsID09PSBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyKSkpIHsKICAgICAgICAgICAgICAgIGpPYmogKz0gJyInICsgb3B0aW9ucy50ZXh0Tm9kZU5hbWUgKyAnIiA6ICcgKyBzdHJpbmd2YWwobm9kZS52YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgaWYgKGpPYmpbak9iai5sZW5ndGggLSAxXSA9PT0gIiwiKSB7CiAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMik7CiAgICB9CiAgICByZXR1cm4gak9iaiArICJ9IjsKfTsKZnVuY3Rpb24gc3RyaW5ndmFsKHYpIHsKICAgIGlmICh2ID09PSB0cnVlIHx8IHYgPT09IGZhbHNlIHx8ICFpc05hTih2KSkgewogICAgICAgIHJldHVybiB2OwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJyInICsgdiArICciJzsKICAgIH0KfQp2YXIgY29udmVydFRvSnNvblN0cmluZ18xID0gY29udmVydFRvSnNvblN0cmluZzsKdmFyIG5vZGUyanNvbl9zdHIgPSB7CiAgICBjb252ZXJ0VG9Kc29uU3RyaW5nOiBjb252ZXJ0VG9Kc29uU3RyaW5nXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDMgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMiA9IHsKICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICJAXyIsCiAgICBhdHRyTm9kZU5hbWU6IGZhbHNlLAogICAgdGV4dE5vZGVOYW1lOiAiI3RleHQiLAogICAgaWdub3JlQXR0cmlidXRlczogdHJ1ZSwKICAgIGNkYXRhVGFnTmFtZTogZmFsc2UsCiAgICBjZGF0YVBvc2l0aW9uQ2hhcjogIlxcYyIsCiAgICBmb3JtYXQ6IGZhbHNlLAogICAgaW5kZW50Qnk6ICIgICIsCiAgICBzdXByZXNzRW1wdHlOb2RlOiBmYWxzZSwKICAgIHRhZ1ZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgYXR0clZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn07CmNvbnN0IHByb3BzJDIgPSBbCiAgICAiYXR0cmlidXRlTmFtZVByZWZpeCIsCiAgICAiYXR0ck5vZGVOYW1lIiwKICAgICJ0ZXh0Tm9kZU5hbWUiLAogICAgImlnbm9yZUF0dHJpYnV0ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgImZvcm1hdCIsCiAgICAiaW5kZW50QnkiLAogICAgInN1cHJlc3NFbXB0eU5vZGUiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInJvb3ROb2RlTmFtZSIKXTsKZnVuY3Rpb24gUGFyc2VyKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQzKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDIsIHByb3BzJDIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzIHx8IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICB0aGlzLmlzQXR0cmlidXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmF0dHJQcmVmaXhMZW4gPSB0aGlzLm9wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeC5sZW5ndGg7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGlzQXR0cmlidXRlOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWUpIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBpc0NEQVRBOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICB9CiAgICB0aGlzLnJlcGxhY2VDREFUQXN0ciA9IHJlcGxhY2VDREFUQXN0cjsKICAgIHRoaXMucmVwbGFjZUNEQVRBYXJyID0gcmVwbGFjZUNEQVRBYXJyOwogICAgdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZSA9IHByb2Nlc3NUZXh0T3JPYmpOb2RlOwogICAgaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGluZGVudGF0ZTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPlxuIjsKICAgICAgICB0aGlzLm5ld0xpbmUgPSAiXG4iOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIiI7CiAgICB9CiAgICBpZiAodGhpcy5vcHRpb25zLnN1cHJlc3NFbXB0eU5vZGUpIHsKICAgICAgICB0aGlzLmJ1aWxkVGV4dE5vZGUgPSBidWlsZEVtcHR5VGV4dE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZEVtcHR5T2JqTm9kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRUZXh0VmFsTm9kZTsKICAgICAgICB0aGlzLmJ1aWxkT2JqTm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKICAgIH0KICAgIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKfQpQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oak9iaikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoak9iaikgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZSAmJiB0aGlzLm9wdGlvbnMucm9vdE5vZGVOYW1lLmxlbmd0aCA+IDEpIHsKICAgICAgICBqT2JqID0gewogICAgICAgICAgICBbdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZV06IGpPYmoKICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHRoaXMuajJ4KGpPYmosIDApLnZhbDsKfTsKUGFyc2VyLnByb3RvdHlwZS5qMnggPSBmdW5jdGlvbihqT2JqLCBsZXZlbCkgewogICAgbGV0IGF0dHJTdHIgPSAiIjsKICAgIGxldCB2YWwgPSAiIjsKICAgIGZvcihsZXQga2V5IGluIGpPYmopewogICAgICAgIGlmICh0eXBlb2Ygak9ialtrZXldID09PSAidW5kZWZpbmVkIikgOwogICAgICAgIGVsc2UgaWYgKGpPYmpba2V5XSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgICAgIH0gZWxzZSBpZiAoak9ialtrZXldIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGpPYmpba2V5XSwga2V5LCAiIiwgbGV2ZWwpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGpPYmpba2V5XSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuaXNBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgICAgIGF0dHJTdHIgKz0gIiAiICsgYXR0ciArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKSArICciJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgaWYgKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFzdHIoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKCIiLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWVdKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShqT2JqW2tleV0pKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKTsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBYXJyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFyckxlbiA9IGpPYmpba2V5XS5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgYXJyTGVuOyBqKyspewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBqT2JqW2tleV1bal07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAidW5kZWZpbmVkIikgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGl0ZW0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpdGVtID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShpdGVtLCBrZXksIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGl0ZW0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmF0dHJOb2RlTmFtZSAmJiBrZXkgPT09IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IEtzID0gT2JqZWN0LmtleXMoak9ialtrZXldKTsKICAgICAgICAgICAgICAgIGNvbnN0IEwgPSBLcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgTDsgaisrKXsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIEtzW2pdICsgJz0iJyArIHRoaXMub3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV1bS3Nbal1dKSArICciJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnByb2Nlc3NUZXh0T3JPYmpOb2RlKGpPYmpba2V5XSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGF0dHJTdHIsCiAgICAgICAgdmFsCiAgICB9Owp9OwpmdW5jdGlvbiBwcm9jZXNzVGV4dE9yT2JqTm9kZShvYmplY3QsIGtleSwgbGV2ZWwpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuajJ4KG9iamVjdCwgbGV2ZWwgKyAxKTsKICAgIGlmIChvYmplY3RbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0gIT09IHZvaWQgMCAmJiBPYmplY3Qua2V5cyhvYmplY3QpLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkVGV4dE5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iak5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQXN0cihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXIpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQWFycihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhLmpvaW4oIl1dPjwhW0NEQVRBWyIpICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgZm9yKGxldCB2IGluIGNkYXRhKXsKICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyLCAiPCFbQ0RBVEFbIiArIGNkYXRhW3ZdICsgIl1dPiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyICsgdGhpcy5uZXdMaW5lOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmIChhdHRyU3RyICYmIHZhbC5pbmRleE9mKCI8IikgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB2YWwgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArIHRoaXMudGFnRW5kQ2hhciArIHZhbCArIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eU9iak5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAodmFsICE9PSAiIikgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBidWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IodmFsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eVRleHROb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGluZGVudGF0ZShsZXZlbCkgewogICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pbmRlbnRCeS5yZXBlYXQobGV2ZWwpOwp9CmZ1bmN0aW9uIGlzQXR0cmlidXRlKG5hbWUpIHsKICAgIGlmIChuYW1lLnN0YXJ0c1dpdGgodGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgpKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuc3Vic3RyKHRoaXMuYXR0clByZWZpeExlbik7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc0NEQVRBKG5hbWUpIHsKICAgIHJldHVybiBuYW1lID09PSB0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lOwp9CnZhciBqc29uMnhtbCA9IFBhcnNlcjsKdmFyIHBhcnNlciA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewogICAgY29uc3QgeDJ4bWxub2RlID0geG1sc3RyMnhtbG5vZGU7CiAgICBjb25zdCBidWlsZE9wdGlvbnMyID0gdXRpbC5idWlsZE9wdGlvbnM7CiAgICBleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24oeG1sRGF0YSwgZ2l2ZW5PcHRpb25zID0gewogICAgfSwgdmFsaWRhdGlvbk9wdGlvbikgewogICAgICAgIGlmICh2YWxpZGF0aW9uT3B0aW9uKSB7CiAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uT3B0aW9uID09PSB0cnVlKSB2YWxpZGF0aW9uT3B0aW9uID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoeG1sRGF0YSwgdmFsaWRhdGlvbk9wdGlvbik7CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKHJlc3VsdC5lcnIubXNnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2l2ZW5PcHRpb25zLnBhcnNlVHJ1ZU51bWJlck9ubHkgJiYgZ2l2ZW5PcHRpb25zLnBhcnNlTm9kZVZhbHVlICE9PSBmYWxzZSAmJiAhZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucykgewogICAgICAgICAgICBnaXZlbk9wdGlvbnMubnVtUGFyc2VPcHRpb25zID0gewogICAgICAgICAgICAgICAgbGVhZGluZ1plcm9zOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBsZXQgb3B0aW9ucyA9IGJ1aWxkT3B0aW9uczIoZ2l2ZW5PcHRpb25zLCB4MnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHgyeG1sbm9kZS5wcm9wcyk7CiAgICAgICAgY29uc3QgdHJhdmVyc2FibGVPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uKHRyYXZlcnNhYmxlT2JqLCBvcHRpb25zKTsKICAgIH07CiAgICBleHBvcnRzLmNvbnZlcnRUb25pbW4gPSBuaW1uZGF0YS5jb252ZXJ0Mm5pbW47CiAgICBleHBvcnRzLmdldFRyYXZlcnNhbE9iaiA9IHhtbHN0cjJ4bWxub2RlLmdldFRyYXZlcnNhbE9iajsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvbiA9IG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uOwogICAgZXhwb3J0cy5jb252ZXJ0VG9Kc29uU3RyaW5nID0gbm9kZTJqc29uX3N0ci5jb252ZXJ0VG9Kc29uU3RyaW5nOwogICAgZXhwb3J0cy52YWxpZGF0ZSA9IHZhbGlkYXRvci52YWxpZGF0ZTsKICAgIGV4cG9ydHMuajJ4UGFyc2VyID0ganNvbjJ4bWw7CiAgICBleHBvcnRzLnBhcnNlVG9OaW1uID0gZnVuY3Rpb24oeG1sRGF0YSwgc2NoZW1hLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuY29udmVydFRvbmltbihleHBvcnRzLmdldFRyYXZlcnNhbE9iaih4bWxEYXRhLCBvcHRpb25zKSwgc2NoZW1hLCBvcHRpb25zKTsKICAgIH07Cn0pOwpwYXJzZXIuY29udmVydFRvSnNvbjsKcGFyc2VyLmNvbnZlcnRUb0pzb25TdHJpbmc7CnBhcnNlci5jb252ZXJ0VG9uaW1uOwp2YXIgZ2V0VHJhdmVyc2FsT2JqJDEgPSBwYXJzZXIuZ2V0VHJhdmVyc2FsT2JqOwpwYXJzZXIuajJ4UGFyc2VyOwpwYXJzZXIucGFyc2U7CnBhcnNlci5wYXJzZVRvTmltbjsKcGFyc2VyLnZhbGlkYXRlOwpmdW5jdGlvbiBwYXJzZVhtbCh4bWwpIHsKICAgIGNvbnN0IHJ0ID0gZ2V0VHJhdmVyc2FsT2JqJDEoeG1sLCB7CiAgICAgICAgaWdub3JlQXR0cmlidXRlczogZmFsc2UsCiAgICAgICAgcGFyc2VBdHRyaWJ1dGVWYWx1ZTogZmFsc2UsCiAgICAgICAgcGFyc2VOb2RlVmFsdWU6IGZhbHNlCiAgICB9KTsKICAgIGNvbnN0IG5hbWVzcGFjZXMgPSBuZXcgWG1sTmFtZXNwYWNlcygpOwogICAgYXBwbHlRbmFtZXMocnQsIG5hbWVzcGFjZXMpOwogICAgY2hlY2tFcXVhbCgnbmFtZXNwYWNlcy5zdGFja1NpemUnLCBuYW1lc3BhY2VzLnN0YWNrU2l6ZSwgMCk7CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCkgewogICAgbGV0IG1hcDsKICAgIGlmIChhdHRyc01hcCkgewogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhdHRyc01hcCkpewogICAgICAgICAgICBpZiAoIW5hbWUuc3RhcnRzV2l0aCgnQF8nKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgYXR0cnNNYXAgbmFtZTogJHtuYW1lfSwgJHthdHRyc01hcH1gKTsKICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgbWFwLnNldChuYW1lLnN1YnN0cmluZygyKSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXAgfHwgRU1QVFlfU1RSSU5HX01BUDsKfQpmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5xbmFtZXMpIHsKICAgIGxldCBydDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBxbmFtZSBvZiBxbmFtZXMpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAocW5hbWUubmFtZSA9PT0gJyonID8gcW5hbWUubmFtZXNwYWNlVXJpID09PSBleHRDaGlsZC5xbmFtZS5uYW1lc3BhY2VVcmkgOiBxbmFtZUVxKHFuYW1lLCBleHRDaGlsZC5xbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBydCA9IHJ0IHx8IFtdOwogICAgICAgICAgICAgICAgICAgIHJ0LnB1c2goZXh0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJ0IHx8IEVNUFRZX1hNTF9OT0RFX0FSUkFZOwp9CmZ1bmN0aW9uIGZpbmRFbGVtZW50UmVjdXJzaXZlKHJvb3QsIHRlc3QpIHsKICAgIGlmICh0ZXN0KHJvb3QpKSByZXR1cm4gcm9vdDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhyb290LmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gZmluZEVsZW1lbnRSZWN1cnNpdmUoZXh0Q2hpbGQsIHRlc3QpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHFuYW1lRXEobGhzLCByaHMpIHsKICAgIHJldHVybiBsaHMubmFtZSA9PT0gcmhzLm5hbWUgJiYgbGhzLm5hbWVzcGFjZVVyaSA9PT0gcmhzLm5hbWVzcGFjZVVyaTsKfQpmdW5jdGlvbiBxbmFtZXNJbmNsdWRlKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLnNvbWUoKHYpPT5xbmFtZUVxKHYsIHJocykKICAgICk7Cn0KY29uc3QgRU1QVFlfU1RSSU5HX01BUCA9IG5ldyBNYXAoKTsKY29uc3QgRU1QVFlfWE1MX05PREVfQVJSQVkgPSBbXTsKZnVuY3Rpb24gYXBwbHlRbmFtZXMobm9kZSwgbmFtZXNwYWNlcykgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBhdHRzID0gbmFtZXNwYWNlcy5wdXNoKG5vZGUuYXR0cnNNYXApOwogICAgICAgIGNvbnN0IG5vZGVBc0FueSA9IG5vZGU7CiAgICAgICAgbm9kZUFzQW55LmF0dHMgPSBhdHRzOwogICAgICAgIG5vZGVBc0FueS5xbmFtZSA9IGNvbXB1dGVRbmFtZShub2RlLnRhZ25hbWUsIG5hbWVzcGFjZXMpOwogICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgICAgIGZvciAoY29uc3QgY2hpbGROb2RlIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGFwcGx5UW5hbWVzKGNoaWxkTm9kZSwgbmFtZXNwYWNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGZpbmFsbHl7CiAgICAgICAgbmFtZXNwYWNlcy5wb3AoKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlUW5hbWUobmFtZVdpdGhPcHRpb25hbFByZWZpeCwgbmFtZXNwYWNlcykgewogICAgY29uc3QgaSA9IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXguaW5kZXhPZignOicpOwogICAgaWYgKGkgPCAwKSByZXR1cm4gewogICAgICAgIG5hbWU6IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmZpbmROYW1lc3BhY2VVcmkoJycpCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZyhpICsgMSksCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmdldE5hbWVzcGFjZVVyaShuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZygwLCBpKSkKICAgIH07Cn0KY2xhc3MgWG1sTmFtZXNwYWNlcyB7CiAgICBzdGFjayA9IFtdOwogICAgZ2V0IHN0YWNrU2l6ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5sZW5ndGg7CiAgICB9CiAgICBwdXNoKGF0dHJzTWFwKSB7CiAgICAgICAgY29uc3QgYXR0cnMgPSBjb21wdXRlQXR0cmlidXRlTWFwKGF0dHJzTWFwKTsKICAgICAgICBsZXQgbWFwOwogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBhdHRycy5lbnRyaWVzKCkpewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3htbG5zJykgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIG1hcC5zZXQoJycsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoJ3htbG5zOicpKSB7CiAgICAgICAgICAgICAgICBtYXAgPSBtYXAgfHwgbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoNik7CiAgICAgICAgICAgICAgICBtYXAuc2V0KHByZWZpeCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucHVzaChtYXAgfHwgRU1QVFlfU1RSSU5HX01BUCk7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQogICAgcG9wKCkgewogICAgICAgIHRoaXMuc3RhY2sucG9wKCk7CiAgICB9CiAgICBmaW5kTmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0TmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGdldE5hbWVzcGFjZVVyaTogcHJlZml4IG5vdCBmb3VuZDogJHtwcmVmaXh9YCk7CiAgICB9Cn0KZnVuY3Rpb24gaXNSZWFkb25seUFycmF5KGFyZykgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJnKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRzRm9yVXJsKHVybCwgc3ViamVjdCwgb3B0cykgewogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBhd2FpdCBmZXRjaENvbW1lbnRzRm9yVXJsXyh1cmwsIG9wdHMpOwogICAgaWYgKCFyb290Q29tbWVudCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IGNvbW1lbnRlcnMgPSBhd2FpdCBjb2xsZWN0Q29tbWVudGVycyhyb290Q29tbWVudCwgb3B0cyk7CiAgICByZXR1cm4gewogICAgICAgIHN1YmplY3QsCiAgICAgICAgcm9vdENvbW1lbnQsCiAgICAgICAgY29tbWVudGVycwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlQ29tbWVudENvdW50KGNvbW1lbnQpIHsKICAgIHJldHVybiAxICsgY29tbWVudC5yZXBsaWVzLm1hcChjb21wdXRlQ29tbWVudENvdW50KS5yZWR1Y2UoKGEsIGIpPT5hICsgYgogICAgLCAwKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRzRm9yVXJsXyh1cmwsIG9wdHMpIHsKICAgIGNvbnN0IHsgZmV0Y2hBY3Rpdml0eVB1YiAgfSA9IG9wdHM7CiAgICBjb25zdCBvYmogPSBvcHRzLm9iaiB8fCBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGlmIChvYmoudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uJykgewogICAgICAgIGNvbnN0IGVtcHR5Q29tbWVudCA9IHsKICAgICAgICAgICAgY29udGVudDogJyhPcmRlcmVkQ29sbGVjdGlvbiknLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHM6IFtdCiAgICAgICAgfTsKICAgICAgICBjb25zdCBvcmRlcmVkQ29sbGVjdGlvbiA9IG9iajsKICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGVtcHR5Q29tbWVudCwgb3B0cywgbmV3IFNldCgpKTsKICAgICAgICByZXR1cm4gZW1wdHlDb21tZW50OwogICAgfQogICAgY29uc3Qgbm90ZU9yUG9kY2FzdEVwaXNvZGUgPSBvYmo7CiAgICBjb25zdCByb290Q29tbWVudCA9IGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhub3RlT3JQb2RjYXN0RXBpc29kZSk7CiAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMobm90ZU9yUG9kY2FzdEVwaXNvZGUsIHJvb3RDb21tZW50LCBvcHRzLCB1cmwpOwogICAgcmV0dXJuIHJvb3RDb21tZW50Owp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RDb21tZW50c0Zyb21PcmRlcmVkQ29sbGVjdGlvbihvcmRlcmVkQ29sbGVjdGlvbiwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCkgewogICAgaWYgKChvcmRlcmVkQ29sbGVjdGlvbi5pdGVtcz8ubGVuZ3RoIHx8IDApID4gMCB8fCAob3JkZXJlZENvbGxlY3Rpb24ub3JkZXJlZEl0ZW1zPy5sZW5ndGggfHwgMCkgPiAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvcmRlcmVkQ29sbGVjdGlvbi5pdGVtcy9vcmRlcmVkSXRlbXMgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob3JkZXJlZENvbGxlY3Rpb24pfWApOwogICAgfQogICAgaWYgKG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0ID09PSB1bmRlZmluZWQgJiYgb3JkZXJlZENvbGxlY3Rpb24udG90YWxJdGVtcyA9PT0gMCkgewogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3JkZXJlZENvbGxlY3Rpb24uZmlyc3QgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgYXdhaXQgZmV0Y2hQYWdlcyhvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCk7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb3JkZXJlZENvbGxlY3Rpb24uZmlyc3Qgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob3JkZXJlZENvbGxlY3Rpb24pfWApOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RDb21tZW50cyhub3RlLCBjb21tZW50LCBvcHRzLCB1cmwpIHsKICAgIGNvbnN0IHsga2VlcEdvaW5nICwgZmV0Y2hBY3Rpdml0eVB1YiAgfSA9IG9wdHM7CiAgICBjb25zdCBmZXRjaGVkID0gbmV3IFNldCgpOwogICAgY29uc3QgcG9kY2FzdEVwaXNvZGVDb21tZW50cyA9IG5vdGUudHlwZSA9PT0gJ1BvZGNhc3RFcGlzb2RlJyA/IG5vdGUuY29tbWVudHMgOiBub3RlLnJlcGxpZXM7CiAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cykgewogICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc3QgdXJsID0gcG9kY2FzdEVwaXNvZGVDb21tZW50czsKICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgIGlmICghb2JqKSByZXR1cm47CiAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgIGlmIChvYmoudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc3Qgb3JkZXJlZENvbGxlY3Rpb24gPSBvYmo7CiAgICAgICAgICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvYmoudHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdCA9PT0gJ29iamVjdCcgJiYgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnKSB7CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcyAmJiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lml0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZldGNoUGFnZXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0LCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0Lm5leHQgbm90IGltcGxlbWVudGVkICR7cG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0fWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3QgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0fWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHBvZGNhc3RFcGlzb2RlQ29tbWVudHMpKSB7CiAgICAgICAgICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogbm9uLXN0YW5kYXJkIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMgYXJyYXkgbm90IGVtcHR5YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0IG5vdCBmb3VuZCwgaW1wbGVtZW50IGl0ZW1zYCk7CiAgICAgICAgfQogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoUGFnZXModXJsLCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgLCBrZWVwR29pbmcgIH0gPSBvcHRzOwogICAgbGV0IG9iaiA9IGF3YWl0IGZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgIGlmICghb2JqKSByZXR1cm47CiAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgIGxldCBrZWVwQ29sbGVjdGluZyA9IHRydWU7CiAgICB3aGlsZShrZWVwQ29sbGVjdGluZyl7CiAgICAgICAgaWYgKG9iai50eXBlICE9PSAnQ29sbGVjdGlvblBhZ2UnICYmIG9iai50eXBlICE9PSAnT3JkZXJlZENvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2Ugb2JqLnR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFnZSA9IG9iai50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnID8gb2JqIDogb2JqOwogICAgICAgIGlmIChwYWdlLml0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLml0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvblBhZ2UnICYmIHBhZ2Uub3JkZXJlZEl0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLm9yZGVyZWRJdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZS5uZXh0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFnZS5uZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgaWYgKGZldGNoZWQuaGFzKHBhZ2UubmV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1cmwgPSBwYWdlLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9iaikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2UubmV4dCBub3QgaW1wbGVtZW50ZWQgJHtwYWdlLm5leHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0SXRlbXMoaXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCkgewogICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXsKICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmICFpdGVtLnN0YXJ0c1dpdGgoJ3snKSkgewogICAgICAgICAgICBjb25zdCByZXBseSA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmxfKGl0ZW0sIG9wdHMpOwogICAgICAgICAgICBpZiAocmVwbHkpIHsKICAgICAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW1PYmogPSB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKGl0ZW0pIDogaXRlbTsKICAgICAgICAgICAgY29uc3QgcmVwbHkgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsoaXRlbU9iaik7CiAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgb3B0cy53YXJuKHJlcGx5LCB1cmwsICdGb3VuZCBpdGVtIGluY29ycmVjdGx5IGRvdWJsZSBlbmNvZGVkIGFzIGEganNvbiBzdHJpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMoaXRlbSwgcmVwbHksIG9wdHMsIHVybCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhvYmplY3QpIHsKICAgIGlmIChvYmplY3QudHlwZSA9PT0gJ05vdGUnKSB7CiAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gLCBjb250ZW50ICwgcHVibGlzaGVkICB9ID0gb2JqZWN0OwogICAgICAgIGNvbnN0IHVybCA9IG9iamVjdC51cmwgPT09IG51bGwgPyB1bmRlZmluZWQgOiBvYmplY3QudXJsOwogICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlZFRvICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50ICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmNvbnRlbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHt0eXBlb2YgY29udGVudH0gJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGlmICh0eXBlb2YgcHVibGlzaGVkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLnB1Ymxpc2hlZCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHVybCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUudXJsIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYXR0cmlidXRlZFRvLAogICAgICAgICAgICBjb250ZW50LAogICAgICAgICAgICBwdWJsaXNoZWQsCiAgICAgICAgICAgIHJlcGxpZXM6IFtdLAogICAgICAgICAgICBhdHRhY2htZW50cwogICAgICAgIH07CiAgICB9CiAgICBpZiAob2JqZWN0LnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScpIHsKICAgICAgICBjb25zdCBwb2RjYXN0RXBpc29kZSA9IG9iamVjdDsKICAgICAgICBjb25zdCB7IGF0dHJpYnV0ZWRUbyAsIHB1Ymxpc2hlZCAsIGRlc2NyaXB0aW9uICwgaW1hZ2UgIH0gPSBwb2RjYXN0RXBpc29kZTsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZWRUbyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuYXR0cmlidXRlZFRvIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIHB1Ymxpc2hlZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUucHVibGlzaGVkIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIGRlc2NyaXB0aW9uICE9PSAnb2JqZWN0JyB8fCBkZXNjcmlwdGlvbi50eXBlICE9PSAnTm90ZScpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuZGVzY3JpcHRpb24gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IHsgY29udGVudCAgfSA9IGRlc2NyaXB0aW9uOwogICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3R5cGVvZiBjb250ZW50fSAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgY29uc3QgdXJsID0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gaW1hZ2UgPyBbCiAgICAgICAgICAgIGNvbXB1dGVBdHRhY2htZW50KGltYWdlKQogICAgICAgIF0gOiBbXTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGF0dHJpYnV0ZWRUbywKICAgICAgICAgICAgY29udGVudCwKICAgICAgICAgICAgcHVibGlzaGVkLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHMKICAgICAgICB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBpdGVtIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKfQpmdW5jdGlvbiBjb21wdXRlQXR0YWNobWVudHMob2JqZWN0KSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgaWYgKCFvYmplY3QuYXR0YWNobWVudCkgcmV0dXJuIHJ0OwogICAgY29uc3QgYXR0YWNobWVudHMgPSBpc1JlYWRvbmx5QXJyYXkob2JqZWN0LmF0dGFjaG1lbnQpID8gb2JqZWN0LmF0dGFjaG1lbnQgOiBbCiAgICAgICAgb2JqZWN0LmF0dGFjaG1lbnQKICAgIF07CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgYXR0YWNobWVudHMpewogICAgICAgIHJ0LnB1c2goY29tcHV0ZUF0dGFjaG1lbnQoYXR0YWNobWVudCkpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50KG9iamVjdCkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdC50eXBlICE9PSAnRG9jdW1lbnQnICYmIG9iamVjdC50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGF0dGFjaG1lbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgY29uc3QgeyBtZWRpYVR5cGUgLCB3aWR0aCAsIGhlaWdodCAsIHVybCAgfSA9IG9iamVjdDsKICAgIGlmICh0eXBlb2YgbWVkaWFUeXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBtZWRpYVR5cGUgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKHdpZHRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHdpZHRoICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB3aWR0aCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICBpZiAoaGVpZ2h0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGhlaWdodCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcihgVE9ETzogaGVpZ2h0IHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB1cmwgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZWRpYVR5cGUsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHVybAogICAgfTsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudGVycyhjb21tZW50LCBvcHRzKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9zID0gbmV3IFNldCgpOwogICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcyk7CiAgICBjb25zdCBydCA9IG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlZFRvIG9mIGF0dHJpYnV0ZWRUb3MpewogICAgICAgIGNvbnN0IGNvbW1lbnRlciA9IGF3YWl0IGZldGNoQ29tbWVudGVyKGF0dHJpYnV0ZWRUbywgb3B0cyk7CiAgICAgICAgaWYgKCFjb21tZW50ZXIpIHJldHVybiBydDsKICAgICAgICBydC5zZXQoYXR0cmlidXRlZFRvLCBjb21tZW50ZXIpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoQ29tbWVudGVyKHVybCwgb3B0cykgewogICAgY29uc3Qgb2JqID0gYXdhaXQgb3B0cy5mZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHBlcnNvbiA9IG9iajsKICAgIHJldHVybiBjb21wdXRlQ29tbWVudGVyKHBlcnNvbik7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pIHsKICAgIGxldCBpY29uOwogICAgaWYgKHBlcnNvbi5pY29uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwZXJzb24uaWNvbiAhPT0gJ29iamVjdCcgfHwgaXNSZWFkb25seUFycmF5KHBlcnNvbi5pY29uKSB8fCBwZXJzb24uaWNvbi50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLmljb24gbm90IGltcGxlbWVudGVkOiAke0pTT04uc3RyaW5naWZ5KHBlcnNvbi5pY29uKX1gKTsKICAgICAgICBpY29uID0gY29tcHV0ZUljb24ocGVyc29uLmljb24pOwogICAgfQogICAgY29uc3QgeyBuYW1lICwgdXJsICB9ID0gcGVyc29uOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5uYW1lIG5vdCBpbXBsZW1lbnRlZDogJHtuYW1lfWApOwogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLnVybCBub3QgaW1wbGVtZW50ZWQ6ICR7dXJsfWApOwogICAgY29uc3QgZnFVc2VybmFtZSA9IGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcGVyc29uLnByZWZlcnJlZFVzZXJuYW1lKTsKICAgIHJldHVybiB7CiAgICAgICAgaWNvbiwKICAgICAgICBuYW1lLAogICAgICAgIHVybCwKICAgICAgICBmcVVzZXJuYW1lCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGljb24pIHsKICAgIGNvbnN0IHsgdXJsICwgbWVkaWFUeXBlICB9ID0gaWNvbjsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIGljb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBpZiAobWVkaWFUeXBlICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBpY29uLm1lZGlhVHlwZSBub3QgaW1wbGVtZW50ZWQ6ICR7bWVkaWFUeXBlfWApOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWVkaWFUeXBlCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcHJlZmVycmVkVXNlcm5hbWUpIHsKICAgIGNvbnN0IHUgPSBuZXcgVVJMKHVybCk7CiAgICBjb25zdCBtID0gL15cLyhAW15cL10rKSQvLmV4ZWModS5wYXRobmFtZSk7CiAgICBjb25zdCB1c2VybmFtZSA9IG0gPyBtWzFdIDogcHJlZmVycmVkVXNlcm5hbWU7CiAgICBpZiAoIXVzZXJuYW1lKSB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBjb21wdXRlIHVzZXJuYW1lIGZyb20gdXJsOiAke3VybH1gKTsKICAgIHJldHVybiBgJHt1c2VybmFtZX1AJHt1Lmhvc3RuYW1lfWA7Cn0KZnVuY3Rpb24gY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcykgewogICAgaWYgKGNvbW1lbnQuYXR0cmlidXRlZFRvKSBhdHRyaWJ1dGVkVG9zLmFkZChjb21tZW50LmF0dHJpYnV0ZWRUbyk7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIGNvbW1lbnQucmVwbGllcyl7CiAgICAgICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MocmVwbHksIGF0dHJpYnV0ZWRUb3MpOwogICAgfQp9CmZ1bmN0aW9uIGlzUG9kY2FzdEltYWdlc1NyY1NldCh0cmltbWVkVGV4dCkgewogICAgY29uc3Qgd2lkdGhzID0gbmV3IFNldCgpOwogICAgY29uc3QgZGVuc2l0aWVzID0gbmV3IFNldCgpOwogICAgbGV0IHdpdGhXaWR0aENvdW50ID0gMDsKICAgIGNvbnN0IHBpZWNlcyA9IHRyaW1tZWRUZXh0LnNwbGl0KC8sXHMrLyk7CiAgICBmb3IgKGNvbnN0IHBpZWNlIG9mIHBpZWNlcyl7CiAgICAgICAgY29uc3QgbSA9IC9eKFteXHNdKykoXHMrKFxkK3d8XGQrKFwuXGQrKT94KSk/JC8uZXhlYyhwaWVjZSk7CiAgICAgICAgaWYgKCFtKSByZXR1cm4gZmFsc2U7CiAgICAgICAgY29uc3QgdXJsID0gbVsxXTsKICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gbVszXSB8fCAnJzsKICAgICAgICBpZiAoIWlzVXJsKHVybCkpIHJldHVybiBmYWxzZTsKICAgICAgICBpZiAoZGVzY3JpcHRvci5lbmRzV2l0aCgndycpKSB7CiAgICAgICAgICAgIHdpdGhXaWR0aENvdW50Kys7CiAgICAgICAgICAgIGNvbnN0IHdpZHRoID0gcGFyc2VJbnQoZGVzY3JpcHRvci5zdWJzdHJpbmcoMCwgZGVzY3JpcHRvci5sZW5ndGggLSAxKSk7CiAgICAgICAgICAgIGlmICh3aWR0aCA8PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmICh3aWR0aHMuaGFzKHdpZHRoKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB3aWR0aHMuYWRkKHdpZHRoKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBkZW5zaXR5ID0gZGVzY3JpcHRvci5lbmRzV2l0aCgneCcpID8gcGFyc2VGbG9hdChkZXNjcmlwdG9yLnN1YnN0cmluZygwLCBkZXNjcmlwdG9yLmxlbmd0aCAtIDEpKSA6IDE7CiAgICAgICAgICAgIGlmIChkZW5zaXR5IDw9IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKGRlbnNpdGllcy5oYXMoZGVuc2l0eSkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgZGVuc2l0aWVzLmFkZChkZW5zaXR5KTsKICAgICAgICB9CiAgICB9CiAgICBpZiAod2l0aFdpZHRoQ291bnQgPiAwICYmIHdpdGhXaWR0aENvdW50ICE9PSBwaWVjZXMubGVuZ3RoKSByZXR1cm4gZmFsc2U7CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiBpc05vdEVtcHR5KHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gdHJpbW1lZFRleHQubGVuZ3RoID4gMDsKfQpmdW5jdGlvbiBpc1VybCh0cmltbWVkVGV4dCkgewogICAgY29uc3QgdSA9IHRyeVBhcnNlVXJsKHRyaW1tZWRUZXh0KTsKICAgIHJldHVybiB1ICYmIHUucHJvdG9jb2wgPT09ICdodHRwczonIHx8IHU/LnByb3RvY29sID09PSAnaHR0cDonOwp9CmZ1bmN0aW9uIGlzVXJpKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gdHJ5UGFyc2VVcmwodHJpbW1lZFRleHQpICE9PSB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gaXNNaW1lVHlwZSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXHcrXC9bLSsuXHddKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzVXVpZCh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eWzAtOWEtZl17OH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17NH0tWzAtOWEtZl17MTJ9JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNFbWFpbEFkZHJlc3ModHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlteQFxzXStAW15AXHNdKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzQXRNb3N0Q2hhcmFjdGVycyhtYXhDaGFyYWN0ZXJzKSB7CiAgICByZXR1cm4gKHRyaW1tZWRUZXh0KT0+dHJpbW1lZFRleHQubGVuZ3RoIDw9IG1heENoYXJhY3RlcnMKICAgIDsKfQpmdW5jdGlvbiBpc1NlY29uZHModHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkKyhcLlxkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNHZW9MYXRMb24odHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXmdlbzotP1xkezEsMn0oXC5cZCspPywtP1xkezEsM30oXC5cZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzT3BlblN0cmVldE1hcElkZW50aWZpZXIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXltOV1JdXGQrKCNcZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZCskLy50ZXN0KHRyaW1tZWRUZXh0KSAmJiBwYXJzZUludCh0cmltbWVkVGV4dCkgPj0gMCAmJiBwYXJzZUludCh0cmltbWVkVGV4dCkudG9TdHJpbmcoKSA9PT0gdHJpbW1lZFRleHQ7Cn0KZnVuY3Rpb24gaXNEZWNpbWFsKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZCsoXC5cZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzUmZjMjgyMih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eWzAtOUEtWmEtejogLV0rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNJc284NjAxKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzQm9vbGVhbih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eKHRydWV8ZmFsc2UpJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0VmFsdWVUeXBlU2x1Zyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW2Etel0rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0TWVkaXVtKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bYS16XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybChzdHIsIGJhc2UpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwoc3RyLCBiYXNlKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcykgewogICAgaWYgKHhtbC50YWduYW1lICE9PSAnIXhtbCcpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBCYWQgeG1sLnRhZ25hbWU6ICR7eG1sLnRhZ25hbWV9YCk7CiAgICBpZiAoT2JqZWN0LmtleXMoeG1sLmF0dHJzTWFwKS5sZW5ndGggPiAwKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC5hdHRyc01hcDogJHt4bWwuYXR0cnNNYXB9YCk7CiAgICBjb25zdCBkb2NFbGVtZW50ID0gT2JqZWN0LnZhbHVlcyh4bWwuY2hpbGQpLmZsYXRNYXAoKHYpPT52CiAgICApWzBdOwogICAgaWYgKCFkb2NFbGVtZW50KSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgTm8geG1sIHJvb3QgZWxlbWVudGApOwogICAgdmFsaWRhdGVSc3MoZG9jRWxlbWVudCwgY2FsbGJhY2tzKTsKfQpmdW5jdGlvbiBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoaHJlZikgewogICAgcmV0dXJuIHsKICAgICAgICBydWxlc2V0OiAncG9kY2FzdGluZGV4JywKICAgICAgICBocmVmCiAgICB9Owp9CmZ1bmN0aW9uIGdldFNpbmdsZUNoaWxkKG5vZGUsIG5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgY2hpbGRyZW4gPSBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCB7CiAgICAgICAgbmFtZQogICAgfSk7CiAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgRXhwZWN0ZWQgc2luZ2xlIDwke25hbWV9PiBjaGlsZCBlbGVtZW50IHVuZGVyIDwke25vZGUudGFnbmFtZX0+LCBmb3VuZCAke2NoaWxkcmVuLmxlbmd0aCA9PT0gMCA/ICdub25lJyA6IGNoaWxkcmVuLmxlbmd0aH1gLCBvcHRzKTsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuWzBdOwp9CmZ1bmN0aW9uIHZhbGlkYXRlUnNzKHJzcywgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBvcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI3doYXRJc1JzcycKICAgICAgICB9CiAgICB9OwogICAgaWYgKHJzcy50YWduYW1lICE9PSAncnNzJykgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHJzcywgYEJhZCB4bWwgcm9vdCB0YWc6ICR7cnNzLnRhZ25hbWV9LCBleHBlY3RlZCByc3NgLCBvcHRzKTsKICAgIGNvbnN0IHZlcnNpb24gPSByc3MuYXR0cy5nZXQoJ3ZlcnNpb24nKTsKICAgIGlmICh2ZXJzaW9uICE9PSAnMi4wJykgY2FsbGJhY2tzLm9uV2FybmluZyhyc3MsIGBCYWQgcnNzLnZlcnNpb246ICR7dmVyc2lvbn0sIGV4cGVjdGVkIDIuMGAsIG9wdHMpOwogICAgY29uc3QgaXR1bmVzT3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL3BvZGNhc3RlcnMuYXBwbGUuY29tL3N1cHBvcnQvODIzLXBvZGNhc3QtcmVxdWlyZW1lbnRzIzp+OnRleHQ9UG9kY2FzdCUyMFJTUyUyMGZlZWQlMjB0ZWNobmljYWwlMjByZXF1aXJlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IGhhc0l0dW5lc1ByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnaXR1bmVzOicpCiAgICApICE9PSB1bmRlZmluZWQ7CiAgICBpZiAoaGFzSXR1bmVzUHJlZml4KSBjaGVja0F0dHJpYnV0ZUVxdWFsKHJzcywgJ3htbG5zOml0dW5lcycsICdodHRwOi8vd3d3Lml0dW5lcy5jb20vZHRkcy9wb2RjYXN0LTEuMC5kdGQnLCBjYWxsYmFja3MsIGl0dW5lc09wdHMpOwogICAgY29uc3QgaGFzQ29udGVudFByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnY29udGVudDonKQogICAgKSAhPT0gdW5kZWZpbmVkOwogICAgaWYgKGhhc0NvbnRlbnRQcmVmaXgpIGNoZWNrQXR0cmlidXRlRXF1YWwocnNzLCAneG1sbnM6Y29udGVudCcsICdodHRwOi8vcHVybC5vcmcvcnNzLzEuMC9tb2R1bGVzL2NvbnRlbnQvJywgY2FsbGJhY2tzLCBpdHVuZXNPcHRzKTsKICAgIGNvbnN0IGNoYW5uZWwgPSBnZXRTaW5nbGVDaGlsZChyc3MsICdjaGFubmVsJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGlmICghY2hhbm5lbCkgcmV0dXJuOwogICAgdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcykgewogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNyZXF1aXJlZENoYW5uZWxFbGVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAndGl0bGUnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIG9wdHMpOwogICAgY29uc3QgbGluayA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICdsaW5rJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChsaW5rLCBpc1VybCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ2Rlc2NyaXB0aW9uJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChkZXNjcmlwdGlvbiwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNndWlkJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZ3VpZCkuY2hlY2tWYWx1ZShpc1V1aWQsIChndWlkVGV4dCk9PnsKICAgICAgICBjb25zdCB2ZXJzaW9uID0gZ3VpZFRleHQuY2hhckF0KDE0KTsKICAgICAgICBpZiAodmVyc2lvbiAhPT0gJzUnKSB7CiAgICAgICAgICAgIHJldHVybiBgZXhwZWN0ZWQgYSBVVUlEdjUsIGZvdW5kIGEgVVVJRHYke3ZlcnNpb259YDsKICAgICAgICB9CiAgICB9KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NrZWQnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5sb2NrZWQpLmNoZWNrVmFsdWUoKHYpPT4vXih5ZXN8bm8pJC8udGVzdCh2KQogICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdvd25lcicsIGlzRW1haWxBZGRyZXNzKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGZvciAoY29uc3QgZnVuZGluZyBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmZ1bmRpbmcpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgZnVuZGluZywgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNmdW5kaW5nJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGZvciAoY29uc3QgdHJhaWxlciBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYWlsZXIpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgdHJhaWxlciwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFpbGVyJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3B1YmRhdGUnLCBpc1JmYzI4MjIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnc2Vhc29uJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0TGljZW5zZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RWYWx1ZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbWVkaXVtJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubWVkaXVtKS5jaGVja1ZhbHVlKGlzUG9kY2FzdE1lZGl1bSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RJbWFnZXMoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3Qgc29jaWFscyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsKTsKICAgIGNvbnN0IHNvY2lhbFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWwtZWxlbWVudCcpOwogICAgY29uc3Qgc29jaWFsU2lnblVwUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9zb2NpYWwvc29jaWFsLm1kI3NvY2lhbHNpZ251cC1lbGVtZW50Jyk7CiAgICBmb3IgKGNvbnN0IHNvY2lhbCBvZiBzb2NpYWxzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgc29jaWFsLCBjYWxsYmFja3MsIHNvY2lhbFJlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncGxhdGZvcm0nLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwcm90b2NvbCcsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FjY291bnRJZCcsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FjY291bnRVcmwnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHJpb3JpdHknLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgY29uc3Qgc29jaWFsU2lnblVwcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsU2lnblVwKTsKICAgICAgICBmb3IgKGNvbnN0IHNvY2lhbFNpZ25VcCBvZiBzb2NpYWxTaWduVXBzKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnc29jaWFsJywgc29jaWFsU2lnblVwLCBjYWxsYmFja3MsIHNvY2lhbFNpZ25VcFJlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnaG9tZVVybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdzaWduVXBVcmwnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHJpb3JpdHknLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc3QgYmFkU29jaWFsU2lnbnVwcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsU2lnblVwKTsKICAgIGlmIChiYWRTb2NpYWxTaWdudXBzLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKGJhZFNvY2lhbFNpZ251cHNbMF0sIGBCYWQgPCR7YmFkU29jaWFsU2lnbnVwc1swXS50YWduYW1lfT46IHNob3VsZCBiZSBhIGNoaWxkIG9mIDxwb2RjYXN0OnNvY2lhbD4sIG5vdCBjaGFubmVsYCk7CiAgICB9CiAgICBjb25zdCBwb2RwaW5nUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9wb2RwaW5nL3BvZHBpbmcubWQjc3BlY2lmaWNhdGlvbicpOwogICAgY29uc3QgcG9kcGluZyA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RwaW5nUmVmZXJlbmNlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBvZHBpbmcpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3VzZXNQb2RwaW5nJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKS5ub2RlOwogICAgaWYgKHBvZHBpbmcpIHsKICAgICAgICBmb3IgKGNvbnN0IGhpdmVBY2NvdW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHBvZHBpbmcsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguaGl2ZUFjY291bnQpKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgncG9kcGluZycsIGhpdmVBY2NvdW50LCBjYWxsYmFja3MsIHBvZHBpbmdSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FjY291bnQnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjaGVja1BvZGNhc3RUYWdVc2FnZShjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3QgaXRlbXMgPSBjaGFubmVsLmNoaWxkLml0ZW0gfHwgW107CiAgICBsZXQgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ID0gMDsKICAgIGxldCBpdGVtc1ZhbGlkYXRlZCA9IDA7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpewogICAgICAgIGlmIChpdGVtc1ZhbGlkYXRlZCA8IDEpIHsKICAgICAgICAgICAgdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcyk7CiAgICAgICAgICAgIGl0ZW1zVmFsaWRhdGVkKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgewogICAgICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgICAgIH0pOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQrKzsKICAgIH0KICAgIGNhbGxiYWNrcy5vblJzc0l0ZW1zRm91bmQoaXRlbXMubGVuZ3RoLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFBlcnNvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBmb3IgKGNvbnN0IHBlcnNvbiBvZiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBlcnNvbikpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQobGV2ZWwsIHBlcnNvbiwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNwZXJzb24nKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyb2xlJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZ3JvdXAnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdpbWcnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaHJlZicsIGlzVXJsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMb2NhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NhdGlvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxvY2F0aW9uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdnZW8nLCBpc0dlb0xhdExvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnb3NtJywgaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcikuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMaWNlbnNlKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xpY2Vuc2UnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5saWNlbnNlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RWYWx1ZShsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCB2YWx1ZSA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3ZhbHVlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudmFsdWUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdtZXRob2QnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdzdWdnZXN0ZWQnLCBpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpLm5vZGU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlUmVjaXBpZW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHZhbHVlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnZhbHVlUmVjaXBpZW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3ZhbHVlJywgdmFsdWVSZWNpcGllbnQsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdmFsdWUtcmVjaXBpZW50JykpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21LZXknLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21WYWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhZGRyZXNzJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3BsaXQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZmVlJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0SW1hZ2VzKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ltYWdlcycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmltYWdlcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3Jjc2V0JywgaXNQb2RjYXN0SW1hZ2VzU3JjU2V0KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RUYWdVc2FnZShub2RlLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IGtub3duID0gbmV3IFNldCgpOwogICAgY29uc3QgdW5rbm93biA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IG5hbWVzcGFjZVVyaXMgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWU6ICcqJywKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICkpKXsKICAgICAgICBjb25zdCBpc0tub3duID0gUW5hbWVzLlBvZGNhc3RJbmRleC5LTk9XTl9OQU1FUy5oYXMoZWxlbWVudC5xbmFtZS5uYW1lKTsKICAgICAgICAoaXNLbm93biA/IGtub3duIDogdW5rbm93bikuYWRkKGVsZW1lbnQucW5hbWUubmFtZSk7CiAgICAgICAgaWYgKGVsZW1lbnQucW5hbWUubmFtZXNwYWNlVXJpKSBuYW1lc3BhY2VVcmlzLmFkZChlbGVtZW50LnFuYW1lLm5hbWVzcGFjZVVyaSk7CiAgICB9CiAgICBpZiAoa25vd24uc2l6ZSArIHVua25vd24uc2l6ZSA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kKGtub3duLCB1bmtub3duLCBuYW1lc3BhY2VVcmlzKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZUVxdWFsKG5vZGUsIGF0dE5hbWUsIGF0dEV4cGVjdGVkVmFsdWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgYXR0VmFsdWUgPSBub2RlLmF0dHMuZ2V0KGF0dE5hbWUpOwogICAgaWYgKCFhdHRWYWx1ZSkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYE1pc3NpbmcgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUsIGV4cGVjdGVkICR7YXR0RXhwZWN0ZWRWYWx1ZX1gLCBvcHRzKTsKICAgIH0gZWxzZSBpZiAoYXR0VmFsdWUgIT09IGF0dEV4cGVjdGVkVmFsdWUpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7YXR0VmFsdWV9LCBleHBlY3RlZCAke2F0dEV4cGVjdGVkVmFsdWV9YCwgb3B0cyk7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tUZXh0KG5vZGUsIHRlc3QsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgaWYgKG5vZGUpIHsKICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IChub2RlLnZhbCB8fCAnJykudHJpbSgpOwogICAgICAgIGlmICghdGVzdCh0cmltbWVkVGV4dCkpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+IHZhbHVlOiAke3RyaW1tZWRUZXh0ID09PSAnJyA/ICc8ZW1wdHk+JyA6IHRyaW1tZWRUZXh0fWAsIG9wdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpbW1lZFRleHQ7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZpbmRGaXJzdENoaWxkRWxlbWVudChub2RlLCBxbmFtZSwgY2FsbGJhY2tzLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIHFuYW1lKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBJdGVtIGlzIG1pc3NpbmcgYW4gPCR7cW5hbWUubmFtZX0+IGVsZW1lbnRgLCBvcHRzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEl0ZW0gaGFzIG11bHRpcGxlIDwke3FuYW1lLm5hbWV9PiBlbGVtZW50c2AsIG9wdHMpOwogICAgICAgIHJldHVybiBlbGVtZW50c1swXTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcykgewogICAgY29uc3QgaXR1bmVzT3B0czEgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9wb2RjYXN0ZXJzLmFwcGxlLmNvbS9zdXBwb3J0LzgyMy1wb2RjYXN0LXJlcXVpcmVtZW50cyM6fjp0ZXh0PVBvZGNhc3QlMjBSU1MlMjBmZWVkJTIwdGVjaG5pY2FsJTIwcmVxdWlyZW1lbnRzJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCBpdHVuZXNPcHRzMiA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2hlbHAuYXBwbGUuY29tL2l0Yy9wb2RjYXN0c19jb25uZWN0LyMvaXRjYjU0MzUzMzkwJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCB0aXRsZSA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ3RpdGxlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAodGl0bGUpIHsKICAgICAgICBjaGVja1RleHQodGl0bGUsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgfQogICAgY29uc3QgZW5jbG9zdXJlID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAoZW5jbG9zdXJlKSB7CiAgICAgICAgY29uc3QgcnNzRW5jbG9zdXJlT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGVuY2xvc3VyZWd0U3ViZWxlbWVudE9mTHRpdGVtZ3QnCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHVybCA9IGVuY2xvc3VyZS5hdHRzLmdldCgndXJsJyk7CiAgICAgICAgaWYgKCF1cmwpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgTWlzc2luZyBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodXJsICYmICFpc1VybCh1cmwpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGUgdmFsdWU6ICR7dXJsfSwgZXhwZWN0ZWQgdXJsYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCdsZW5ndGgnKTsKICAgICAgICBpZiAoIWxlbmd0aCkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAobGVuZ3RoICYmICFpc05vbk5lZ2F0aXZlSW50ZWdlcihsZW5ndGgpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGUgdmFsdWU6ICR7bGVuZ3RofSwgZXhwZWN0ZWQgbm9uLW5lZ2F0aXZlIGludGVnZXJgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBjb25zdCB0eXBlID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCd0eXBlJyk7CiAgICAgICAgaWYgKCF0eXBlKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgPGVuY2xvc3VyZT4gdHlwZSBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodHlwZSAmJiAhaXNNaW1lVHlwZSh0eXBlKSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBCYWQgaXRlbSA8ZW5jbG9zdXJlPiB0eXBlIGF0dHJpYnV0ZSB2YWx1ZTogJHt0eXBlfSwgZXhwZWN0ZWQgTUlNRSB0eXBlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICB9CiAgICBjb25zdCBndWlkID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZ3VpZCcKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czEpOwogICAgaWYgKGd1aWQpIHsKICAgICAgICBjb25zdCBndWlkVGV4dCA9IGNoZWNrVGV4dChndWlkLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIGl0dW5lc09wdHMxKTsKICAgICAgICBjb25zdCByc3NHdWlkT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGd1aWRndFN1YmVsZW1lbnRPZkx0aXRlbWd0JwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCBtaXNzcGVsbGluZ3MgPSBbCiAgICAgICAgICAgIC4uLmd1aWQuYXR0cy5rZXlzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYgIT09ICdpc1Blcm1hTGluaycgJiYgdi50b0xvd2VyQ2FzZSgpID09PSAnaXNwZXJtYWxpbmsnCiAgICAgICAgKTsKICAgICAgICBmb3IgKGNvbnN0IG1pc3NwZWxsaW5nIG9mIG1pc3NwZWxsaW5ncyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcoZ3VpZCwgYEJhZCBpdGVtIDxndWlkPiBpc1Blcm1hTGluayBhdHRyaWJ1dGUgc3BlbGxpbmc6ICR7bWlzc3BlbGxpbmd9YCwgcnNzR3VpZE9wdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1Blcm1hTGluayA9IGd1aWQuYXR0cy5nZXQoJ2lzUGVybWFMaW5rJykgfHwgJ3RydWUnOwogICAgICAgIGlmIChpc1Blcm1hTGluayA9PT0gJ3RydWUnICYmIGd1aWRUZXh0ICYmICFpc1VybChndWlkVGV4dCkgJiYgbWlzc3BlbGxpbmdzLmxlbmd0aCA9PT0gMCkgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkIGl0ZW0gPGd1aWQ+IHZhbHVlOiAke2d1aWRUZXh0fSwgZXhwZWN0ZWQgdXJsIHdoZW4gaXNQZXJtYUxpbms9InRydWUiIG9yIHVuc3BlY2lmaWVkYCwgcnNzR3VpZE9wdHMpOwogICAgfQogICAgY29uc3QgdHJhbnNjcmlwdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYW5zY3JpcHQpOwogICAgZm9yIChjb25zdCB0cmFuc2NyaXB0IG9mIHRyYW5zY3JpcHRzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgdHJhbnNjcmlwdCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFuc2NyaXB0JykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZ3VhZ2UnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyZWwnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNjaGFwdGVycycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmNoYXB0ZXJzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY29uc3Qgc291bmRiaXRlcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc291bmRiaXRlKTsKICAgIGZvciAoY29uc3Qgc291bmRiaXRlIG9mIHNvdW5kYml0ZXMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCBzb3VuZGJpdGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjc291bmRiaXRlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3N0YXJ0VGltZScsIGlzU2Vjb25kcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnZHVyYXRpb24nLCBpc1NlY29uZHMpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNzZWFzb24nKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zZWFzb24pLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkodikKICAgICkuY2hlY2tWYWx1ZShpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjZXBpc29kZScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmVwaXNvZGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2Rpc3BsYXknLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgKS5jaGVja1ZhbHVlKGlzRGVjaW1hbCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RMaWNlbnNlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmFsdGVybmF0ZUVuY2xvc3VyZSk7CiAgICBmb3IgKGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZSBvZiBhbHRlcm5hdGVFbmNsb3N1cmVzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2FsdGVybmF0ZS1lbmNsb3N1cmUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdiaXRyYXRlJywgaXNEZWNpbWFsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdoZWlnaHQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZycsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3RpdGxlJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICAgICApLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3JlbCcsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMzIpKHYpCiAgICAgICAgKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb2RlY3MnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdkZWZhdWx0JywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnYWx0ZXJuYXRlRW5jbG9zdXJlJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ludGVncml0eScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmludGVncml0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsICh2KT0+L14oc3JpfHBncC1zaWduYXR1cmUpJC8udGVzdCh2KQogICAgICAgICkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndmFsdWUnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjb25zdCBzb3VyY2VzID0gZmluZENoaWxkRWxlbWVudHMoYWx0ZXJuYXRlRW5jbG9zdXJlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvdXJjZSk7CiAgICAgICAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2FsdGVybmF0ZUVuY2xvc3VyZScsIHNvdXJjZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNhbHRlcm5hdGUtZW5jbG9zdXJlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VyaScsIGlzVXJpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb250ZW50VHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNoZWNrUG9kY2FzdFZhbHVlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdEltYWdlcygnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjb25zdCBzb2NpYWxJbnRlcmFjdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbEludGVyYWN0KTsKICAgIGNvbnN0IHNvY2lhbEludGVyYWN0UmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9zb2NpYWwvc29jaWFsLm1kI3NvY2lhbGludGVyYWN0LWVsZW1lbnQnKTsKICAgIGZvciAoY29uc3Qgc29jaWFsSW50ZXJhY3Qgb2Ygc29jaWFsSW50ZXJhY3RzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgc29jaWFsSW50ZXJhY3QsIGNhbGxiYWNrcywgc29jaWFsSW50ZXJhY3RSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3BsYXRmb3JtJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncHJvdG9jb2wnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50SWQnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwdWJEYXRlJywgaXNJc284NjAxKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwcmlvcml0eScsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1ZhbHVlKGlzVXJpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjYWxsYmFja3Mub25Hb29kKHNvY2lhbEludGVyYWN0LCAnRm91bmQgPHBvZGNhc3Q6c29jaWFsSW50ZXJhY3Q+LCBuaWNlIScsIHsKICAgICAgICAgICAgdGFnOiAnc29jaWFsLWludGVyYWN0JywKICAgICAgICAgICAgcmVmZXJlbmNlOiBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgY2hlY2tQb2RjYXN0VGFnVXNhZ2UoaXRlbSwgY2FsbGJhY2tzKTsKfQpjbGFzcyBFbGVtZW50VmFsaWRhdGlvbiB7CiAgICBzdGF0aWMgRU1QVFlfU1RSSU5HX1NFVCA9IG5ldyBTZXQoKTsKICAgIG5vZGU7CiAgICBsZXZlbDsKICAgIGNhbGxiYWNrczsKICAgIG9wdHM7CiAgICByZW1haW5pbmdBdHROYW1lczsKICAgIGNvbnN0cnVjdG9yKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIG9wdHMpewogICAgICAgIHRoaXMubGV2ZWwgPSBsZXZlbDsKICAgICAgICB0aGlzLm5vZGUgPSBub2RlOwogICAgICAgIHRoaXMuY2FsbGJhY2tzID0gY2FsbGJhY2tzOwogICAgICAgIHRoaXMub3B0cyA9IG9wdHM7CiAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcyA9IG5vZGUgPyBuZXcgU2V0KG5vZGUuYXR0cy5rZXlzKCkpIDogRWxlbWVudFZhbGlkYXRpb24uRU1QVFlfU1RSSU5HX1NFVDsKICAgIH0KICAgIHN0YXRpYyBmb3JFbGVtZW50KGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHJlZmVyZW5jZSkgewogICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgewogICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIHN0YXRpYyBmb3JTaW5nbGVDaGlsZChsZXZlbCwgcGFyZW50LCBjYWxsYmFja3MsIHJlZmVyZW5jZSwgLi4ucW5hbWVzKSB7CiAgICAgICAgY2hlY2tUcnVlKCdxbmFtZXMubGVuZ3RoJywgcW5hbWVzLmxlbmd0aCwgcW5hbWVzLmxlbmd0aCA+IDApOwogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMocGFyZW50LCAuLi5xbmFtZXMpOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAxKSBjYWxsYmFja3Mub25XYXJuaW5nKGVsZW1lbnRzWzFdLCBgTXVsdGlwbGUgJHtsZXZlbH0gPCR7ZWxlbWVudHNbMV0udGFnbmFtZX0+IGVsZW1lbnRzIGFyZSBub3QgYWxsb3dlZGAsIHsKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgY29uc3QgZWxlbWVudCA9IGVsZW1lbnRzWzBdOwogICAgICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCBlbGVtZW50LCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgdW5kZWZpbmVkLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgfSk7CiAgICB9CiAgICBjaGVja1ZhbHVlKHRlc3QsIGFkZGl0aW9uYWxUZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdHJpbW1lZFRleHQgPSBjaGVja1RleHQobm9kZSwgdGVzdCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgICAgICAgICAgaWYgKHRyaW1tZWRUZXh0ICYmIGFkZGl0aW9uYWxUZXN0KSB7CiAgICAgICAgICAgICAgICBjb25zdCB3YXJuaW5nU3VmZml4ID0gYWRkaXRpb25hbFRlc3QodHJpbW1lZFRleHQpOwogICAgICAgICAgICAgICAgaWYgKHdhcm5pbmdTdWZmaXgpIHsKICAgICAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgPCR7bm9kZS50YWduYW1lfT4gdmFsdWU6ICR7dHJpbW1lZFRleHQgPT09ICcnID8gJzxlbXB0eT4nIDogdHJpbW1lZFRleHR9LCAke3dhcm5pbmdTdWZmaXh9YCwgb3B0cyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjaGVja1JlcXVpcmVkQXR0cmlidXRlKG5hbWUsIHRlc3QpIHsKICAgICAgICBjb25zdCB7IG5vZGUgLCBjYWxsYmFja3MgLCBvcHRzICwgbGV2ZWwgIH0gPSB0aGlzOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbm9kZS5hdHRzLmdldChuYW1lKTsKICAgICAgICAgICAgaWYgKCF2YWx1ZSkgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgTWlzc2luZyAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZWAsIG9wdHMpOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgIXRlc3QodmFsdWUpKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgJHtsZXZlbH0gPCR7bm9kZS50YWduYW1lfT4gJHtuYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7dmFsdWV9YCwgb3B0cyk7CiAgICAgICAgICAgIHRoaXMucmVtYWluaW5nQXR0TmFtZXMuZGVsZXRlKG5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUobmFtZSwgdGVzdCkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBub2RlLmF0dHMuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZiAodmFsdWUgJiYgIXRlc3QodmFsdWUpKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgJHtsZXZlbH0gPCR7bm9kZS50YWduYW1lfT4gJHtuYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7dmFsdWV9YCwgb3B0cyk7CiAgICAgICAgICAgIHRoaXMucmVtYWluaW5nQXR0TmFtZXMuZGVsZXRlKG5hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpIHsKICAgICAgICBjb25zdCB7IHJlbWFpbmluZ0F0dE5hbWVzICwgY2FsbGJhY2tzICwgbm9kZSAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgaWYgKHJlbWFpbmluZ0F0dE5hbWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgJHtsZXZlbH0gPCR7bm9kZS50YWduYW1lfT4gYXR0cmlidXRlIG5hbWUke3JlbWFpbmluZ0F0dE5hbWVzLnNpemUgPiAxID8gJ3MnIDogJyd9OiAke1sKICAgICAgICAgICAgICAgICAgICAuLi5yZW1haW5pbmdBdHROYW1lcwogICAgICAgICAgICAgICAgXS5qb2luKCcsICcpfWAsIG9wdHMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQp9CmZ1bmN0aW9uIHNldEludGVyc2VjdChsaHMsIHJocykgewogICAgY29uc3QgcnQgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgbGhzKXsKICAgICAgICBpZiAocmhzLmhhcyhpdGVtKSkgcnQuYWRkKGl0ZW0pOwogICAgfQogICAgZm9yIChjb25zdCBpdGVtMSBvZiByaHMpewogICAgICAgIGlmIChsaHMuaGFzKGl0ZW0xKSkgcnQuYWRkKGl0ZW0xKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpjbGFzcyBWYWxpZGF0aW9uSm9iVk0gewogICAgZmV0Y2hlcnM7CiAgICBwaVNlYXJjaEZldGNoZXI7CiAgICBuZXh0Sm9iSWQgPSAxOwogICAgY3VycmVudEpvYjsKICAgIGdldCB2YWxpZGF0aW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgIT09IHVuZGVmaW5lZCAmJiAhdGhpcy5jdXJyZW50Sm9iLmRvbmU7CiAgICB9CiAgICBnZXQgZG9uZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jdXJyZW50Sm9iLmRvbmU7CiAgICB9CiAgICBnZXQgbWVzc2FnZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiA/IHRoaXMuY3VycmVudEpvYi5tZXNzYWdlcyA6IFtdOwogICAgfQogICAgZ2V0IGlzU2VhcmNoKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmN1cnJlbnRKb2Iuc2VhcmNoOwogICAgfQogICAgZ2V0IHNlYXJjaFJlc3VsdHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiA/IHRoaXMuY3VycmVudEpvYi5zZWFyY2hSZXN1bHRzIDogW107CiAgICB9CiAgICBnZXQgeG1sKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2I/LnhtbDsKICAgIH0KICAgIGdldCB4bWxTdW1tYXJ5VGV4dCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy54bWxTdW1tYXJ5VGV4dDsKICAgIH0KICAgIGdldCBmZXRjaENvbW1lbnRzUmVzdWx0KCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2I/LmZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihvcHRzKXsKICAgICAgICBjb25zdCB7IGxvY2FsRmV0Y2hlciAsIHJlbW90ZUZldGNoZXIgLCBwaVNlYXJjaEZldGNoZXIgIH0gPSBvcHRzOwogICAgICAgIHRoaXMuZmV0Y2hlcnMgPSB7CiAgICAgICAgICAgIGxvY2FsRmV0Y2hlciwKICAgICAgICAgICAgcmVtb3RlRmV0Y2hlcgogICAgICAgIH07CiAgICAgICAgdGhpcy5waVNlYXJjaEZldGNoZXIgPSBwaVNlYXJjaEZldGNoZXI7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57CiAgICB9OwogICAgY29udGludWVXaXRoKHVybCkgewogICAgICAgIGNvbnN0IHsgY3VycmVudEpvYiAgfSA9IHRoaXM7CiAgICAgICAgaWYgKGN1cnJlbnRKb2IpIHsKICAgICAgICAgICAgY3VycmVudEpvYi5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiAncnVubmluZycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnVmFsaWRhdGluZycKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY3VycmVudEpvYi5tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRleHQ6ICdDb250aW51aW5nIHdpdGggZmVlZCBmcm9tIHNlYXJjaCcsCiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgdGhpcy52YWxpZGF0ZUFzeW5jKHVybCwgY3VycmVudEpvYik7CiAgICAgICAgfQogICAgfQogICAgc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgY29uc3Qgam9iID0gewogICAgICAgICAgICBpZDogdGhpcy5uZXh0Sm9iSWQrKywKICAgICAgICAgICAgbWVzc2FnZXM6IFtdLAogICAgICAgICAgICBzZWFyY2hSZXN1bHRzOiBbXSwKICAgICAgICAgICAgdGltZXM6IHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3B0aW9ucywKICAgICAgICAgICAgc2VhcmNoOiBmYWxzZSwKICAgICAgICAgICAgZG9uZTogZmFsc2UsCiAgICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2UKICAgICAgICB9OwogICAgICAgIHRoaXMuY3VycmVudEpvYiA9IGpvYjsKICAgICAgICBqb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICdydW5uaW5nJywKICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyhpbnB1dCwgam9iKTsKICAgIH0KICAgIGNhbmNlbFZhbGlkYXRpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudEpvYiAmJiAhdGhpcy5jdXJyZW50Sm9iLmRvbmUpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEpvYi5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHZhbGlkYXRlQXN5bmMoaW5wdXQsIGpvYikgewogICAgICAgIGlucHV0ID0gbm9ybWFsaXplSW5wdXQoaW5wdXQpOwogICAgICAgIGNvbnN0IHsgbWVzc2FnZXMgIH0gPSBqb2I7CiAgICAgICAgY29uc3Qgc2V0U3RhdHVzID0gKHRleHQsIG9wdHMgPSB7CiAgICAgICAgfSk9PnsKICAgICAgICAgICAgY29uc3QgeyB1cmwgLCB0eXBlICB9ID0gb3B0czsKICAgICAgICAgICAgbWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlIHx8IG1lc3NhZ2VzWzBdLnR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGFkZE1lc3NhZ2UgPSAodHlwZSwgdGV4dCwgb3B0cyA9IHsKICAgICAgICB9KT0+ewogICAgICAgICAgICBjb25zdCB7IHVybCAsIHRhZyAsIGNvbW1lbnQgLCByZWZlcmVuY2UgIH0gPSBvcHRzOwogICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdGFnLAogICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH07CiAgICAgICAgbGV0IGFjdGl2aXR5UHViOwogICAgICAgIGNvbnN0IGhlYWRlcnMgPSB7CiAgICAgICAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiAnZ3ppcCcsCiAgICAgICAgICAgICdVc2VyLUFnZW50Jzogam9iLm9wdGlvbnMudXNlckFnZW50LAogICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZScKICAgICAgICB9OwogICAgICAgIGxldCBjb250aW51ZVdpdGhVcmw7CiAgICAgICAgY29uc3Qgam9iU3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgIGNvbnN0IHsgZmV0Y2hlcnMgLCBwaVNlYXJjaEZldGNoZXIgIH0gPSB0aGlzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQudHJpbSgpOwogICAgICAgICAgICBpZiAoaW5wdXQgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGlucHV0YCk7CiAgICAgICAgICAgIGlmICgvXmh0dHBzPzpcL1wvLisvaS50ZXN0KGlucHV0KSkgewogICAgICAgICAgICAgICAgY29uc3QgaW5wdXRVcmwgPSB0cnlQYXJzZVVybDEoaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKCFpbnB1dFVybCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiAke2lucHV0fWApOwogICAgICAgICAgICAgICAgY2hlY2tNYXRjaGVzKCdpbnB1dFVybC5wcm90b2NvbCcsIGlucHV0VXJsLnByb3RvY29sLCAvXmh0dHBzPzokLyk7CiAgICAgICAgICAgICAgICBpbnB1dFVybC5zZWFyY2hQYXJhbXMuc2V0KCdfdCcsIERhdGUubm93KCkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAsIGZldGNoVGltZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaChpbnB1dFVybC50b1N0cmluZygpLCB7CiAgICAgICAgICAgICAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoam9iLmRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgIGpvYi50aW1lcy5mZXRjaFRpbWUgPSBmZXRjaFRpbWU7CiAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xvY2FsJykgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgTG9jYWwgZmV0Y2ggc3VjY2VlZGVkIChDT1JTIGVuYWJsZWQpYCwgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGVja0VxdWFsKGAke2lucHV0VXJsLmhvc3R9IHJlc3BvbnNlIHN0YXR1c2AsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkYXRlRmVlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoY29udGVudFR5cGUgJiYgY29udGVudFR5cGUuaW5jbHVkZXMoJy9odG1sJykpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIGh0bWwsIHdpbGwgdHJ5IGFnYWluIGFzIEFjdGl2aXR5UHViJyk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6ICdpbnB1dCB1cmwnCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjb250ZW50VHlwZSAmJiBjb250ZW50VHlwZS5zdGFydHNXaXRoKCdhcHBsaWNhdGlvbi9hY3Rpdml0eStqc29uJykpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIEFjdGl2aXR5UHViIGpzb24nKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBvYmogPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6ICdpbnB1dCB1cmwnLAogICAgICAgICAgICAgICAgICAgICAgICBvYmoKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHZhbGlkYXRlRmVlZCkgewogICAgICAgICAgICAgICAgICAgIGxldCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgdGV4dCA9IGF3YWl0IHJlc3BvbnNlLnRleHQoKTsKICAgICAgICAgICAgICAgICAgICBpZiAoam9iLmRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMucmVhZFRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGxldCB4bWw7CiAgICAgICAgICAgICAgICAgICAgdHJ5IHsKICAgICAgICAgICAgICAgICAgICAgICAgeG1sID0gcGFyc2VYbWwodGV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKHhtbCk7CiAgICAgICAgICAgICAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIGBYbWwgcGFyc2UgZmFpbGVkOiAke2UubWVzc2FnZX1gKTsKICAgICAgICAgICAgICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy5wYXJzZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh4bWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvbk1lc3NhZ2UgPSAodHlwZSwgbm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UodHlwZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAob3B0cz8udGFnID09PSAnc29jaWFsLWludGVyYWN0JykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnZhbCAmJiBub2RlLnZhbCAhPT0gJycgJiYgY29tcHV0ZUF0dHJpYnV0ZU1hcChub2RlLmF0dHJzTWFwKS5nZXQoJ3BsYXRmb3JtJykgPT09ICdhY3Rpdml0eXB1YicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgZXBpc29kZVRpdGxlID0gZmluZEVwaXNvZGVUaXRsZShub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IG5vZGUudmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogZXBpc29kZVRpdGxlID8gYOKAnCR7ZXBpc29kZVRpdGxlfeKAnWAgOiAnZXBpc29kZScKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtub3duUGlUYWdzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1bmtub3duUGlUYWdzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaU5hbWVzcGFjZVVyaXMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCByc3NJdGVtSW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgY2FsbGJhY2tzID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Hb29kOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdnb29kJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25FcnJvcjogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2Vycm9yJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25XYXJuaW5nOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCd3YXJuaW5nJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25JbmZvOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmluZm8obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdpbmZvJywgbm9kZSwgbWVzc2FnZSwgb3B0cyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kOiAoa25vd24sIHVua25vd24sIG5hbWVzcGFjZVVyaXMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga25vd24uZm9yRWFjaCgodik9Pmtub3duUGlUYWdzLmFkZCh2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdW5rbm93bi5mb3JFYWNoKCh2KT0+dW5rbm93blBpVGFncy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWVzcGFjZVVyaXMuZm9yRWFjaCgodik9PnBpTmFtZXNwYWNlVXJpcy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUnNzSXRlbXNGb3VuZDogKGl0ZW1zQ291bnQsIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByc3NJdGVtSW5mbyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNDb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHhtbFN1bW1hcnlUZXh0ID0gJ1htbCBzdHJ1Y3R1cmUnOwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUZlZWRYbWwoeG1sLCBjYWxsYmFja3MpOwogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMudmFsaWRhdGVUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocnNzSXRlbUluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgaXRlbXNDb3VudCAsIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCAgfSA9IHJzc0l0ZW1JbmZvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50ID0gaXRlbXNDb3VudCAtIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpZWNlcyA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgRm91bmQgJHt1bml0U3RyaW5nKGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCwgJ2VwaXNvZGUnKX1gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCA+IDApIHBpZWNlcy5wdXNoKGBhbmQgJHt1bml0U3RyaW5nKGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCwgJ2l0ZW0nKX0gd2l0aG91dCBlbmNsb3N1cmVzYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMucHVzaChgaW4gYSAke2Zvcm1hdEJ5dGVzKHRleHQubGVuZ3RoKX0gZmVlZGApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIHBpZWNlcy5qb2luKCcgJykpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgeG1sU3VtbWFyeVRleHQgPSBgJHtpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQgPiAxID8gJ1BvZGNhc3QgZmVlZCcgOiAnRmVlZCd9IHN0cnVjdHVyZWA7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGlSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCcpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdTdHJpbmcgPSAoc2V0KT0+WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5tYXAoKHYpPT5gPHBvZGNhc3Q6JHt2fT5gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmpvaW4oJywgJykKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgRm91bmQgJHt1bml0U3RyaW5nKGtub3duUGlUYWdzLnNpemUsICdwb2RjYXN0IG5hbWVzcGFjZSB0YWcnKX06ICR7dGFnU3RyaW5nKGtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgRm91bmQgJHt1bml0U3RyaW5nKHVua25vd25QaVRhZ3Muc2l6ZSwgJ3Vua25vd24gcG9kY2FzdCBuYW1lc3BhY2UgdGFnJyl9OiAke3RhZ1N0cmluZyh1bmtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWlzc3BlbGxlZE5hbWVzcGFjZXMgPSBzZXRJbnRlcnNlY3QocGlOYW1lc3BhY2VVcmlzLCBuZXcgU2V0KFFuYW1lcy5Qb2RjYXN0SW5kZXguS05PV05fTUlTU1BFTExFRF9OQU1FU1BBQ0VTKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtaXNzcGVsbGVkTmFtZXNwYWNlcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjcnNzLW5hbWVzcGFjZS1leHRlbnNpb24tZm9yLXBvZGNhc3RpbmctdGFnLXNwZWNpZmljYXRpb24nKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgRm91bmQgJHt1bml0U3RyaW5nKG1pc3NwZWxsZWROYW1lc3BhY2VzLnNpemUsICdtaXNzcGVsbGVkIHBvZGNhc3QgbmFtZXNwYWNlIHVyaScpfTogJHtbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4ubWlzc3BlbGxlZE5hbWVzcGFjZXMKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0uam9pbignLCAnKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeG1sICYmIE9iamVjdC5rZXlzKHhtbCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgam9iLnhtbCA9IHhtbDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi54bWxTdW1tYXJ5VGV4dCA9IHhtbFN1bW1hcnlUZXh0OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgdmFsaWRhdGVDb21tZW50cyA9IGpvYi5vcHRpb25zLnZhbGlkYXRlQ29tbWVudHMgIT09IHVuZGVmaW5lZCA/IGpvYi5vcHRpb25zLnZhbGlkYXRlQ29tbWVudHMgOiB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGFjdGl2aXR5UHViICYmICF2YWxpZGF0ZUNvbW1lbnRzKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdDb21tZW50cyB2YWxpZGF0aW9uIGRpc2FibGVkLCBub3QgZmV0Y2hpbmcgQWN0aXZpdHlQdWInKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYWN0aXZpdHlQdWIpIHsKICAgICAgICAgICAgICAgICAgICBzZXRTdGF0dXMoYFZhbGlkYXRpbmcgQWN0aXZpdHlQdWIgZm9yICR7YWN0aXZpdHlQdWIuc3ViamVjdH1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYWN0aXZpdHlQdWIudXJsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGZXRjaGluZyBBY3Rpdml0eVB1YiBjb21tZW50cycsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBhY3Rpdml0eVB1Yi51cmwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZWVwR29pbmcgPSAoKT0+IWpvYi5kb25lCiAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlbW90ZU9ubHlPcmlnaW5zID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbXB1dGVVc2VTaWRlID0gKHVybCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlbW90ZU9ubHlPcmlnaW5zLmhhcyhuZXcgVVJMKHVybCkub3JpZ2luKSA/ICdyZW1vdGUnIDogdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgbGV0IGFjdGl2aXR5UHViQ2FsbHMgPSAwOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoQWN0aXZpdHlQdWIgPSBhc3luYyAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeyBvYmogLCBzaWRlICB9ID0gYXdhaXQgbG9jYWxPclJlbW90ZUZldGNoRmV0Y2hBY3Rpdml0eVB1Yih1cmwsIGZldGNoZXJzLCBjb21wdXRlVXNlU2lkZSh1cmwpLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVybC5pbmNsdWRlcygnL2FwaS92MS9zdGF0dXNlcycpICYmIHR5cGVvZiBvYmoudXJpID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gb2JqLnVyaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCBmZXRjaGVycywgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gcmVzLm9iajsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGUgPSByZXMuc2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBuZXcgVVJMKHVybCkub3JpZ2luOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW1vdGVPbmx5T3JpZ2lucy5oYXMob3JpZ2luKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgTG9jYWwgQWN0aXZpdHlQdWIgZmV0Y2ggZmFpbGVkIChDT1JTIGRpc2FibGVkPylgLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnOiAnY29ycycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVPbmx5T3JpZ2lucy5hZGQob3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YkNhbGxzKys7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXJuID0gKGNvbW1lbnQsIHVybCwgbWVzc2FnZSk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIG1lc3NhZ2UsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmwoYWN0aXZpdHlQdWIudXJsLCBhY3Rpdml0eVB1Yi5zdWJqZWN0LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBHb2luZywKICAgICAgICAgICAgICAgICAgICAgICAgZmV0Y2hBY3Rpdml0eVB1YiwKICAgICAgICAgICAgICAgICAgICAgICAgd2FybgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmIChmZXRjaENvbW1lbnRzUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy5jb21tZW50c1RpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCBgRm91bmQgJHt1bml0U3RyaW5nKGNvbXB1dGVDb21tZW50Q291bnQoZmV0Y2hDb21tZW50c1Jlc3VsdC5yb290Q29tbWVudCksICdjb21tZW50Jyl9IGFuZCAke3VuaXRTdHJpbmcoZmV0Y2hDb21tZW50c1Jlc3VsdC5jb21tZW50ZXJzLnNpemUsICdwYXJ0aWNpcGFudCcpfSwgbWFkZSAke3VuaXRTdHJpbmcoYWN0aXZpdHlQdWJDYWxscywgJ0FjdGl2aXR5UHViIGNhbGwnKX1gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgam9iLmZldGNoQ29tbWVudHNSZXN1bHQgPSBmZXRjaENvbW1lbnRzUmVzdWx0OwogICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpvYi5zZWFyY2ggPSB0cnVlOwogICAgICAgICAgICAgICAgc2V0U3RhdHVzKCdTZWFyY2hpbmcnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFJlc3BvbnNlID0gYXdhaXQgcGlTZWFyY2hGZXRjaGVyKGlucHV0LCBoZWFkZXJzKTsKICAgICAgICAgICAgICAgIGNoZWNrRXF1YWwoJ3NlYXJjaFJlc3BvbnNlLnN0YXR1cycsIHNlYXJjaFJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFJlc3VsdCA9IGF3YWl0IHNlYXJjaFJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIGlmIChzZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBzZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5zZWFyY2hSZXN1bHRzLnB1c2goLi4uc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0LmZlZWRzLnNsaWNlKDAsIDIwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2Vycm9yJywgc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNSZWFkb25seUFycmF5KHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0LmZlZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZVdpdGhVcmwgPSBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdC5mZWVkLnVybDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBlLm1lc3NhZ2UpOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGAke2pvYi5zZWFyY2ggPyAnU2VhcmNoIHRvb2snIDogJ1Rvb2snfSAke2Zvcm1hdFRpbWUoRGF0ZS5ub3coKSAtIGpvYlN0YXJ0KX0ke2NvbXB1dGVKb2JUaW1lc1N0cmluZ1N1ZmZpeChqb2IudGltZXMpfWApOwogICAgICAgICAgICBpZiAoY29udGludWVXaXRoVXJsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRpbnVlV2l0aChjb250aW51ZVdpdGhVcmwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgam9iLmRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gam9iLmNhbmNlbGxlZCA/ICdDYW5jZWxsZWQnIDogam9iLnNlYXJjaCAmJiBqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGggPT09IDAgPyAnRm91bmQgbm8gcG9kY2FzdHMnIDogam9iLnNlYXJjaCAmJiBqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGggPT09IDEgPyAnRm91bmQgb25lIHBvZGNhc3QsIHNlbGVjdCB0byBjb250aW51ZScgOiBqb2Iuc2VhcmNoID8gYEZvdW5kICR7am9iLnNlYXJjaFJlc3VsdHMubGVuZ3RofSBwb2RjYXN0cywgc2VsZWN0IG9uZSB0byBjb250aW51ZWAgOiAnRG9uZSc7CiAgICAgICAgICAgICAgICBzZXRTdGF0dXMoc3RhdHVzLCB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2RvbmUnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRUaW1lKG1pbGxpcykgewogICAgaWYgKG1pbGxpcyA8IDEwMDApIHJldHVybiBgJHttaWxsaXN9bXNgOwogICAgcmV0dXJuIGAke01hdGgucm91bmQobWlsbGlzIC8gMTAwMCAqIDEwMCkgLyAxMDB9c2A7Cn0KZnVuY3Rpb24gY29tcHV0ZUpvYlRpbWVzU3RyaW5nU3VmZml4KHRpbWVzKSB7CiAgICBjb25zdCBydCA9IFsKICAgICAgICBbCiAgICAgICAgICAgICdmZXRjaCcsCiAgICAgICAgICAgIHRpbWVzLmZldGNoVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAncmVhZCcsCiAgICAgICAgICAgIHRpbWVzLnJlYWRUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdwYXJzZScsCiAgICAgICAgICAgIHRpbWVzLnBhcnNlVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAndmFsaWRhdGUnLAogICAgICAgICAgICB0aW1lcy52YWxpZGF0ZVRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ2NvbW1lbnRzJywKICAgICAgICAgICAgdGltZXMuY29tbWVudHNUaW1lCiAgICAgICAgXQogICAgXS5maWx0ZXIoKHYpPT52WzFdICE9PSB1bmRlZmluZWQKICAgICkubWFwKCh2KT0+YCR7dlswXX09JHtmb3JtYXRUaW1lKHZbMV0pfWAKICAgICkuam9pbignLCAnKTsKICAgIHJldHVybiBydCA9PT0gJycgPyAnJyA6IGAgKCR7cnR9KWA7Cn0KZnVuY3Rpb24gZm9ybWF0Qnl0ZXMoYnl0ZXMpIHsKICAgIGxldCBhbW91bnQgPSBieXRlczsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7YW1vdW50fS1ieXRlYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICBpZiAoYW1vdW50IDwgMTAyNCkgcmV0dXJuIGAke01hdGgucm91bmQoYW1vdW50ICogMTAwKSAvIDEwMH1rYmA7CiAgICBhbW91bnQgPSBhbW91bnQgLyAxMDI0OwogICAgcmV0dXJuIGAke01hdGgucm91bmQoYW1vdW50ICogMTAwKSAvIDEwMH1tYmA7Cn0KZnVuY3Rpb24gdW5pdFN0cmluZyhhbW91bnQsIHVuaXQpIHsKICAgIHJldHVybiBgJHthbW91bnQgPT09IDAgPyAnbm8nIDogYW1vdW50ID09PSAxID8gJ29uZScgOiBuZXcgSW50bC5OdW1iZXJGb3JtYXQoKS5mb3JtYXQoYW1vdW50KX0gJHt1bml0fSR7YW1vdW50ID09PSAxID8gJycgOiAncyd9YDsKfQpmdW5jdGlvbiBub3JtYWxpemVJbnB1dChpbnB1dCkgewogICAgaW5wdXQgPSBpbnB1dC50cmltKCk7CiAgICBjb25zdCBtID0gL15odHRwczpcL1wvcG9kY2FzdHNcLmFwcGxlXC5jb21cLy4qPyhpZFxkKykkLy5leGVjKGlucHV0KTsKICAgIGlmIChtKSByZXR1cm4gbVsxXTsKICAgIHJldHVybiBpbnB1dDsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybDEodXJsKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHVybCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpmdW5jdGlvbiBzbGVlcChtcykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKT0+c2V0VGltZW91dChyZXNvbHZlLCBtcykKICAgICk7Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoRmV0Y2hBY3Rpdml0eVB1Yih1cmwsIGZldGNoZXJzLCB1c2VTaWRlLCBzbGVlcE1pbGxpc0JldHdlZW5DYWxscykgewogICAgaWYgKHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzID4gMCkgYXdhaXQgc2xlZXAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMpOwogICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCB7CiAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2FjdGl2aXR5K2pzb24nCiAgICAgICAgfSwKICAgICAgICB1c2VTaWRlCiAgICB9KTsKICAgIGNoZWNrRXF1YWwoJ3Jlcy5zdGF0dXMnLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4ucmVzcG9uc2UuaGVhZGVycwogICAgXS5tYXAoKHYpPT52LmpvaW4oJzogJykKICAgICkpOwogICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICBpZiAoIShjb250ZW50VHlwZSB8fCAnJykuaW5jbHVkZXMoJ2pzb24nKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRm91bmQgaHRtbCwgbm90IEFjdGl2aXR5UHViJyk7CiAgICB9CiAgICBjb25zdCBvYmogPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICByZXR1cm4gewogICAgICAgIG9iaiwKICAgICAgICBzaWRlCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIG9wdHMpIHsKICAgIGNvbnN0IHsgZmV0Y2hlcnMgLCBoZWFkZXJzICwgdXNlU2lkZSAgfSA9IG9wdHM7CiAgICBpZiAodXNlU2lkZSAhPT0gJ3JlbW90ZScpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9jYWwgZmV0Y2g6ICR7dXJsfWApOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2hlcnMubG9jYWxGZXRjaGVyKHVybCwgaGVhZGVycyk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBmZXRjaFRpbWU6IERhdGUubm93KCkgLSBzdGFydCwKICAgICAgICAgICAgICAgIHNpZGU6ICdsb2NhbCcsCiAgICAgICAgICAgICAgICByZXNwb25zZQogICAgICAgICAgICB9OwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBsb2NhbCBmZXRjaCwgdHJ5aW5nIHJlbW90ZScsIGUpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnNvbGUubG9nKGByZW1vdGUgZmV0Y2g6ICR7dXJsfWApOwogICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaGVycy5yZW1vdGVGZXRjaGVyKHVybCwgaGVhZGVycyk7CiAgICByZXR1cm4gewogICAgICAgIGZldGNoVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0LAogICAgICAgIHNpZGU6ICdyZW1vdGUnLAogICAgICAgIHJlc3BvbnNlCiAgICB9Owp9CmZ1bmN0aW9uIGZpbmRFcGlzb2RlVGl0bGUoc29jaWFsSW50ZXJhY3QpIHsKICAgIGNvbnN0IGl0ZW0gPSBzb2NpYWxJbnRlcmFjdC5wYXJlbnQ7CiAgICBpZiAoaXRlbSkgewogICAgICAgIGNvbnN0IHRpdGxlID0gaXRlbS5jaGlsZFsndGl0bGUnXTsKICAgICAgICBpZiAodGl0bGUubGVuZ3RoID4gMCAmJiB0aXRsZVswXS52YWwpIHsKICAgICAgICAgICAgY29uc3QgdmFsID0gdGl0bGVbMF0udmFsLnRyaW0oKTsKICAgICAgICAgICAgaWYgKHZhbC5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpjbGFzcyBWYWxpZGF0b3JBcHBWTSB7CiAgICBqb2I7CiAgICBnZXQgdmFsaWRhdGluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IudmFsaWRhdGluZzsKICAgIH0KICAgIGdldCBtZXNzYWdlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IubWVzc2FnZXM7CiAgICB9CiAgICBnZXQgaXNTZWFyY2goKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLmlzU2VhcmNoOwogICAgfQogICAgZ2V0IHNlYXJjaFJlc3VsdHMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLnNlYXJjaFJlc3VsdHM7CiAgICB9CiAgICBnZXQgeG1sKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi54bWw7CiAgICB9CiAgICBnZXQgeG1sU3VtbWFyeVRleHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLnhtbFN1bW1hcnlUZXh0OwogICAgfQogICAgZ2V0IGZldGNoQ29tbWVudHNSZXN1bHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLmZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICB9CiAgICBjb25zdHJ1Y3RvcihvcHRzKXsKICAgICAgICB0aGlzLmpvYiA9IG5ldyBWYWxpZGF0aW9uSm9iVk0ob3B0cyk7CiAgICAgICAgdGhpcy5qb2Iub25DaGFuZ2UgPSAoKT0+dGhpcy5vbkNoYW5nZSgpCiAgICAgICAgOwogICAgfQogICAgb25DaGFuZ2UgPSAoKT0+ewogICAgfTsKICAgIHN0YXJ0KCkgewogICAgfQogICAgY29udGludWVXaXRoKHVybCkgewogICAgICAgIHRoaXMuam9iLmNvbnRpbnVlV2l0aCh1cmwpOwogICAgfQogICAgc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgdGhpcy5qb2Iuc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKTsKICAgIH0KICAgIGNhbmNlbFZhbGlkYXRpb24oKSB7CiAgICAgICAgdGhpcy5qb2IuY2FuY2VsVmFsaWRhdGlvbigpOwogICAgfQp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKZnVuY3Rpb24gZXh0ZXJuYWxpemVBbmNob3IoYW5jaG9yKSB7CiAgICBhbmNob3IudGFyZ2V0ID0gJ19ibGFuayc7CiAgICBhbmNob3IucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwp9CmNvbnN0IENPTU1FTlRTX0hUTUwgPSBodG1sYAo8ZGV0YWlscyBpZD0iY29tbWVudHMtZGV0YWlscyIgb3Blbj4KICAgIDxzdW1tYXJ5PkNvbW1lbnRzIGZvciA8c3BhbiBpZD0iY29tbWVudHMtc3ViamVjdCI+c3ViamVjdDwvc3Bhbj48L3N1bW1hcnk+CiAgICA8b3V0cHV0IGlkPSJjb21tZW50cyI+PC9vdXRwdXQ+CjwvZGV0YWlscz4KYDsKY29uc3QgQ09NTUVOVFNfQ1NTID0gY3NzYAoKI2NvbW1lbnRzLWRldGFpbHMgewogICAgZGlzcGxheTogbm9uZTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBtYXgtd2lkdGg6IDEwMCU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouY29tbWVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgbWF4LXdpZHRoOiA4MGNoOwogICAgbGluZS1oZWlnaHQ6IDEuNTsKfQoKLmNvbW1lbnQgLmljb24gewogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgYm9yZGVyLXJhZGl1czogMC41ZW07CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMWVtIDA7Cn0KCi5jb21tZW50IC5yaHMgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMCAwOwogICAgZmxleC1ncm93OiAxOwp9CgouY29tbWVudCAuaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNWVtOwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAuaGVhZGVyIC51cmwgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAucmhzIHAgewogICAgbWFyZ2luLWJsb2NrLXN0YXJ0OiAwZW07CiAgICBtYXJnaW4tYmxvY2stZW5kOiAwZW07Cn0KCi5jb21tZW50IGltZyB7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICB3aWR0aDogYXV0bzsKICAgIGhlaWdodDogYXV0bzsKfQoKLnJlcGx5IGZpZWxkc2V0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYm9yZGVyOiBzb2xpZCAxcHggJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0gCgoucmVwbHkgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS5iYWNrZ3JvdW5kQ29sb3JIZXgpfTsKfQoKLnJlcGx5IGJ1dHRvbiB7CiAgICBwYWRkaW5nOiAwLjI1cmVtIDJyZW07CiAgICBhbGlnbi1zZWxmOiBmbGV4LWVuZDsKICAgIG1hcmdpbjogMC41cmVtIDA7Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb21tZW50cyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IGNvbW1lbnRzRGV0YWlscyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cy1kZXRhaWxzJyk7CiAgICBjb25zdCBjb21tZW50c1N1YmplY3RTcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzLXN1YmplY3QnKTsKICAgIGNvbnN0IGNvbW1lbnRzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCByZXN1bHQgPSB2bS5mZXRjaENvbW1lbnRzUmVzdWx0OwogICAgICAgIGNvbW1lbnRzRGV0YWlscy5zdHlsZS5kaXNwbGF5ID0gcmVzdWx0ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb21tZW50c1N1YmplY3RTcGFuLnRleHRDb250ZW50ID0gcmVzdWx0Py5zdWJqZWN0IHx8ICdzdWJqZWN0JzsKICAgICAgICBpZiAocmVzdWx0ICE9PSBfcmVuZGVyZWRSZXN1bHQpIHsKICAgICAgICAgICAgcmVuZGVyQ29tbWVudHMocmVzdWx0LCBjb21tZW50c091dHB1dCwgdm0pOwogICAgICAgICAgICBfcmVuZGVyZWRSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgfQogICAgfTsKfQpsZXQgX3JlbmRlcmVkUmVzdWx0OwpmdW5jdGlvbiByZW5kZXJDb21tZW50cyhyZXN1bHQsIGNvbW1lbnRzT3V0cHV0LCB2bSkgewogICAgd2hpbGUoY29tbWVudHNPdXRwdXQuZmlyc3RDaGlsZCljb21tZW50c091dHB1dC5yZW1vdmVDaGlsZChjb21tZW50c091dHB1dC5maXJzdENoaWxkKTsKICAgIGlmIChyZXN1bHQpIHJlbmRlck5vZGUocmVzdWx0LnJvb3RDb21tZW50LCByZXN1bHQuY29tbWVudGVycywgY29tbWVudHNPdXRwdXQsIDAsIHZtKTsKfQpmdW5jdGlvbiByZW5kZXJOb2RlKGNvbW1lbnQsIGNvbW1lbnRlcnMsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCB2bSkgewogICAgY29uc3QgY29tbWVudGVyID0gY29tbWVudC5hdHRyaWJ1dGVkVG8gPyBjb21tZW50ZXJzLmdldChjb21tZW50LmF0dHJpYnV0ZWRUbykgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBjb21tZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb21tZW50RGl2LmNsYXNzTGlzdC5hZGQoJ2NvbW1lbnQnKTsKICAgIGlmIChsZXZlbCA+IDApIGNvbW1lbnREaXYuc3R5bGUubWFyZ2luTGVmdCA9IGAke2xldmVsICogNH1lbWA7CiAgICBjb25zdCBpY29uSW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICBpY29uSW1nLmNsYXNzTGlzdC5hZGQoJ2ljb24nKTsKICAgIGljb25JbWcuc3JjID0gY29tbWVudGVyICYmIGNvbW1lbnRlci5pY29uID8gY29tbWVudGVyLmljb24udXJsIDogJyMnOwogICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChpY29uSW1nKTsKICAgIGNvbnN0IHJoc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgcmhzRGl2LmNsYXNzTGlzdC5hZGQoJ3JocycpOwogICAgY29uc3QgaGVhZGVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBoZWFkZXJEaXYuY2xhc3NMaXN0LmFkZCgnaGVhZGVyJyk7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGF0dHJpYnV0ZWRUb0Rpdi5jbGFzc0xpc3QuYWRkKCdhdHRyaWJ1dGVkLXRvJyk7CiAgICBpZiAoY29tbWVudGVyKSB7CiAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhLmhyZWYgPSBjb21tZW50ZXIudXJsOwogICAgICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgYS50ZXh0Q29udGVudCA9IGNvbW1lbnRlci5uYW1lICsgJyAnICsgY29tbWVudGVyLmZxVXNlcm5hbWU7CiAgICAgICAgYXR0cmlidXRlZFRvRGl2LmFwcGVuZENoaWxkKGEpOwogICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29tbWVudC5hdHRyaWJ1dGVkVG8gfHwgJzx1bmtub3duPicpKTsKICAgIH0KICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhdHRyaWJ1dGVkVG9EaXYpOwogICAgY29uc3QgYWdlVGV4dCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbW1lbnQucHVibGlzaGVkID8gY29tcHV0ZUFnZShuZXcgRGF0ZShjb21tZW50LnB1Ymxpc2hlZCkpIDogJycpOwogICAgaWYgKGNvbW1lbnQudXJsKSB7CiAgICAgICAgY29uc3QgYWdlQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGFnZUFuY2hvci5jbGFzc0xpc3QuYWRkKCd1cmwnKTsKICAgICAgICBhZ2VBbmNob3IuaHJlZiA9IGNvbW1lbnQudXJsOwogICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGFnZUFuY2hvcik7CiAgICAgICAgYWdlQW5jaG9yLmFwcGVuZENoaWxkKGFnZVRleHQpOwogICAgICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhZ2VBbmNob3IpOwogICAgfSBlbHNlIHsKICAgICAgICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQoYWdlVGV4dCk7CiAgICB9CiAgICByaHNEaXYuYXBwZW5kQ2hpbGQoaGVhZGVyRGl2KTsKICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gY29tbWVudC5jb250ZW50OwogICAgY29udGVudERpdi5xdWVyeVNlbGVjdG9yQWxsKCdhJykuZm9yRWFjaChleHRlcm5hbGl6ZUFuY2hvcik7CiAgICByaHNEaXYuYXBwZW5kQ2hpbGQoY29udGVudERpdik7CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgY29tbWVudC5hdHRhY2htZW50cyl7CiAgICAgICAgY29uc3QgYXR0YWNobWVudERldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkZXRhaWxzJyk7CiAgICAgICAgY29uc3Qgc3VtbWFyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1bW1hcnknKTsKICAgICAgICBzdW1tYXJ5LnRleHRDb250ZW50ID0gYEF0dGFjaG1lbnQgKCR7YXR0YWNobWVudC5tZWRpYVR5cGV9KWA7CiAgICAgICAgYXR0YWNobWVudERldGFpbHMuYXBwZW5kQ2hpbGQoc3VtbWFyeSk7CiAgICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgICAgaW1nLnNyYyA9IGF0dGFjaG1lbnQudXJsOwogICAgICAgIGlmIChhdHRhY2htZW50LndpZHRoICYmIGF0dGFjaG1lbnQuaGVpZ2h0KSB7CiAgICAgICAgICAgIGltZy53aWR0aCA9IGF0dGFjaG1lbnQud2lkdGg7CiAgICAgICAgICAgIGltZy5oZWlnaHQgPSBhdHRhY2htZW50LmhlaWdodDsKICAgICAgICB9CiAgICAgICAgYXR0YWNobWVudERldGFpbHMuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQoYXR0YWNobWVudERldGFpbHMpOwogICAgfQogICAgaWYgKGNvbW1lbnQudXJsKSB7CiAgICAgICAgY29uc3QgcmVwbHlUb1VybCA9IGNvbW1lbnQudXJsOwogICAgICAgIGNvbnN0IHJlcGx5RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmVwbHlEaXYuY2xhc3NOYW1lID0gJ3JlcGx5JzsKICAgICAgICBjb25zdCByZXBseUFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICByZXBseUFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgICAgIHJlcGx5QW5jaG9yLmhyZWYgPSAnIyc7CiAgICAgICAgcmVwbHlEaXYuYXBwZW5kQ2hpbGQocmVwbHlBbmNob3IpOwogICAgICAgIGNvbnN0IHJlcGx5RmllbGRzZXRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByZXBseURpdi5hcHBlbmRDaGlsZChyZXBseUZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICByZXBseUFuY2hvci5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdG9nZ2xlUmVwbHlCb3gocmVwbHlBbmNob3IsIHJlcGx5RmllbGRzZXRDb250YWluZXIsIHJlcGx5VG9VcmwsIHZtKTsKICAgICAgICB9OwogICAgICAgIHJoc0Rpdi5hcHBlbmRDaGlsZChyZXBseURpdik7CiAgICB9CiAgICBjb21tZW50RGl2LmFwcGVuZENoaWxkKHJoc0Rpdik7CiAgICBjb250YWluZXJFbGVtZW50LmFwcGVuZENoaWxkKGNvbW1lbnREaXYpOwogICAgZm9yIChjb25zdCByZXBseSBvZiBjb21tZW50LnJlcGxpZXMpewogICAgICAgIHJlbmRlck5vZGUocmVwbHksIGNvbW1lbnRlcnMsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsICsgMSwgdm0pOwogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVBZ2UoZGF0ZSkgewogICAgY29uc3QgbWlsbGlzID0gRGF0ZS5ub3coKSAtIGRhdGUuZ2V0VGltZSgpOwogICAgY29uc3Qgc2Vjb25kcyA9IG1pbGxpcyAvIDEwMDA7CiAgICBjb25zdCBtaW51dGVzID0gc2Vjb25kcyAvIDYwOwogICAgaWYgKG1pbnV0ZXMgPCA2MCkgcmV0dXJuIGAke01hdGgubWF4KE1hdGguZmxvb3IobWludXRlcyksIDEpfW1gOwogICAgY29uc3QgaG91cnMgPSBtaW51dGVzIC8gNjA7CiAgICBpZiAoaG91cnMgPCAyNCkgcmV0dXJuIGAke01hdGguZmxvb3IoaG91cnMpfWhgOwogICAgY29uc3QgZGF5cyA9IGhvdXJzIC8gMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5mbG9vcihkYXlzKX1kYDsKfQpmdW5jdGlvbiB0b2dnbGVSZXBseUJveChhbmNob3IsIGZpZWxkc2V0Q29udGFpbmVyLCByZXBseVRvVXJsLCBfdm0pIHsKICAgIGlmIChhbmNob3IudGV4dENvbnRlbnQ/LnN0YXJ0c1dpdGgoJ1JlcGx5JykpIHsKICAgICAgICBhbmNob3IudGV4dENvbnRlbnQgPSAnQ2FuY2VsIOKFuSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUkVQTFlfQk9YLCBmaWVsZHNldENvbnRhaW5lcik7CiAgICAgICAgY29uc3QgYSA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhJylbMF07CiAgICAgICAgY29uc3QgdGV4dGFyZWEgPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGV4dGFyZWEnKVswXTsKICAgICAgICBjb25zdCBidXR0b24gPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYnV0dG9uJylbMF07CiAgICAgICAgY29uc3Qgb3JpZ2luID0gbmV3IFVSTChyZXBseVRvVXJsKS5vcmlnaW47CiAgICAgICAgYS50ZXh0Q29udGVudCA9IGBMb2dpbiBhdCAke29yaWdpbn0uLi5gOwogICAgICAgIGEub25jbGljayA9IChlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cub3BlbihgL2xvZ2luP29yaWdpbj0ke2VuY29kZVVSSUNvbXBvbmVudChvcmlnaW4pfWAsICdsb2dpbicpOwogICAgICAgICAgICBpZiAodykgewogICAgICAgICAgICAgICAgZ2xvYmFsVGhpcy5vbm1lc3NhZ2UgPSAoZSk9PnsKICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRhdGEgIH0gPSBlOwogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdvbm1lc3NhZ2UnLCBkYXRhKTsKICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5vcmlnaW4gJiYgZGF0YS50b2tlblJlc3BvbnNlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHcuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCBsb2dnZWRJbiA9IGZhbHNlOwogICAgICAgIGNvbnN0IHVwZGF0ZSA9ICgpPT57CiAgICAgICAgICAgIGEuc3R5bGUuZGlzcGxheSA9IGxvZ2dlZEluID8gJ25vbmUnIDogJ2Jsb2NrJzsKICAgICAgICAgICAgdGV4dGFyZWEuc3R5bGUuZGlzcGxheSA9IGJ1dHRvbi5zdHlsZS5kaXNwbGF5ID0gbG9nZ2VkSW4gPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIH07CiAgICAgICAgdXBkYXRlKCk7CiAgICB9IGVsc2UgewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgZmllbGRzZXRDb250YWluZXIpOwogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgfQp9CmNvbnN0IFJFUExZX0JPWCA9IGh0bWxgCjxmaWVsZHNldD4KICAgIDxsZWdlbmQ+UmVwbHk8L2xlZ2VuZD4KICAgIDxhIGhyZWY9IiMiPkxvZ2luIHRvIC4uLjwvYT4KICAgIDx0ZXh0YXJlYSB0eXBlPSJ0ZXh0IiBuYW1lPSJjb250ZW50IiByb3dzPSI0IiBwbGFjZWhvbGRlcj0iWW91ciByZXBseS4uLiI+PC90ZXh0YXJlYT4KICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij5TZW5kPC9idXR0b24+CjwvZmllbGRzZXQ+CmA7CmNvbnN0IElORk9fSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTEgN2gydjJoLTJ6bTAgNGgydjZoLTJ6bTEtOUM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6Ii8+PC9zdmc+YDsKY29uc3QgV0FSTklOR19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0xMiA1Ljk5TDE5LjUzIDE5SDQuNDdMMTIgNS45OU0yLjc0IDE4Yy0uNzcgMS4zMy4xOSAzIDEuNzMgM2gxNS4wNmMxLjU0IDAgMi41LTEuNjcgMS43My0zTDEzLjczIDQuOTljLS43Ny0xLjMzLTIuNjktMS4zMy0zLjQ2IDBMMi43NCAxOHpNMTEgMTF2MmMwIC41NS40NSAxIDEgMXMxLS40NSAxLTF2LTJjMC0uNTUtLjQ1LTEtMS0xcy0xIC40NS0xIDF6bTAgNWgydjJoLTJ6Ii8+PC9zdmc+YDsKY29uc3QgRVJST1JfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMjAuNzEgNy45OEwxNi4wMyAzLjNjLS4xOS0uMTktLjQ1LS4zLS43MS0uM0g4LjY4Yy0uMjYgMC0uNTIuMTEtLjcuMjlMMy4yOSA3Ljk4Yy0uMTguMTgtLjI5LjQ0LS4yOS43djYuNjNjMCAuMjcuMTEuNTIuMjkuNzFsNC42OCA0LjY4Yy4xOS4xOS40NS4zLjcxLjNoNi42M2MuMjcgMCAuNTItLjExLjcxLS4yOWw0LjY4LTQuNjhjLjE5LS4xOS4yOS0uNDQuMjktLjcxVjguNjhjLjAxLS4yNi0uMS0uNTItLjI4LS43ek0xOSAxNC45TDE0LjkgMTlIOS4xTDUgMTQuOVY5LjFMOS4xIDVoNS44TDE5IDkuMXY1Ljh6Ii8+PGNpcmNsZSBjeD0iMTIiIGN5PSIxNiIgcj0iMSIvPjxwYXRoIGQ9Ik0xMiA3Yy0uNTUgMC0xIC40NS0xIDF2NWMwIC41NS40NSAxIDEgMXMxLS40NSAxLTFWOGMwLS41NS0uNDUtMS0xLTF6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6bTMuODgtMTEuNzFMMTAgMTQuMTdsLTEuODgtMS44OGMtLjM5LS4zOS0xLjAyLS4zOS0xLjQxIDAtLjM5LjM5LS4zOSAxLjAyIDAgMS40MWwyLjU5IDIuNTljLjM5LjM5IDEuMDIuMzkgMS40MSAwTDE3LjMgOS43Yy4zOS0uMzkuMzktMS4wMiAwLTEuNDEtLjM5LS4zOS0xLjAzLS4zOS0xLjQyIDB6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tMSVNUX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI0IDI0IiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxnPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMjQiIHdpZHRoPSIyNCIvPjwvZz48Zz48Zz48cGF0aCBkPSJNNSw1aDJ2MWMwLDEuMSwwLjksMiwyLDJoNmMxLjEsMCwyLTAuOSwyLTJWNWgydjVoMlY1YzAtMS4xLTAuOS0yLTItMmgtNC4xOEMxNC40LDEuODQsMTMuMywxLDEyLDFTOS42LDEuODQsOS4xOCwzSDUgQzMuOSwzLDMsMy45LDMsNXYxNGMwLDEuMSwwLjksMiwyLDJoNnYtMkg1VjV6IE0xMiwzYzAuNTUsMCwxLDAuNDUsMSwxcy0wLjQ1LDEtMSwxcy0xLTAuNDUtMS0xUzExLjQ1LDMsMTIsM3oiLz48cGF0aCBkPSJNMjEuNzUsMTIuMjVjLTAuNDEtMC40MS0xLjA5LTAuNDEtMS41LDBMMTUuNTEsMTdsLTIuMjYtMi4yNWMtMC40MS0wLjQxLTEuMDgtMC40MS0xLjUsMGwwLDBjLTAuNDEsMC40MS0wLjQxLDEuMDksMCwxLjUgbDMuMDUsMy4wNGMwLjM5LDAuMzksMS4wMiwwLjM5LDEuNDEsMGw1LjUzLTUuNTRDMjIuMTYsMTMuMzQsMjIuMTYsMTIuNjYsMjEuNzUsMTIuMjV6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBTUVVBUkVfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik0zLDN2MThoMThWM0gzeiBNMTksMTlINVY1aDE0VjE5eiIvPjwvZz48L2c+PC9zdmc+YDsKY29uc3QgRk9STV9IVE1MID0gaHRtbGAKPGhlYWRlcj4ke0NIRUNLTElTVF9JQ09OfTxoMT5MaXZld2lyZSBQb2RjYXN0IFZhbGlkYXRvciA8c3BhbiBpZD0idmVyc2lvbiI+djAuMjwvc3Bhbj48L2gxPjwvaGVhZGVyPgo8Zm9ybSBpZD0iZm9ybSI+CiAgICA8aW5wdXQgaWQ9InRleHQtaW5wdXQiIHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSJQb2RjYXN0IGZlZWQgdXJsLCBBY3Rpdml0eVB1YiB1cmwsIEFwcGxlIFBvZGNhc3RzIHVybCwgb3Igc2VhcmNoIHRleHQiIGF1dG9jb21wbGV0ZT0idXJsIiByZXF1aXJlZD4KICAgIDxidXR0b24gaWQ9InN1Ym1pdCIgdHlwZT0ic3VibWl0Ij5WYWxpZGF0ZTwvYnV0dG9uPgo8L2Zvcm0+CmA7CmNvbnN0IEZPUk1fQ1NTID0gY3NzYAoKaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZ2FwOiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIG9wYWNpdHk6IDAuNzU7Cn0KCmhlYWRlciBoMSB7CiAgICBtYXJnaW46IDA7Cn0KCmhlYWRlciBzdmcgewogICAgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOwogICAgZmlsbDogY3VycmVudENvbG9yOwp9CgojdmVyc2lvbiB7CiAgICBvcGFjaXR5OiAwLjI1Owp9CgojZm9ybSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAxcmVtOwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKfQoKLyoqIGlvcyByZXNldHMgKi8KQHN1cHBvcnRzICgtd2Via2l0LXRvdWNoLWNhbGxvdXQ6IG5vbmUpIHsKICAgIGlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uIHsKICAgICAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CiAgICAgICAgYm9yZGVyLXJhZGl1czogMDsKICAgIH0KCiAgICBidXR0b24gewogICAgICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA2NTBweCkgewoKICAgIGhlYWRlciB7CiAgICAgICAgZm9udC1zaXplOiA2NiU7CiAgICAgICAgZ2FwOiAwLjVyZW07CiAgICB9CgogICAgaGVhZGVyIHN2ZyB7CiAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjApOwogICAgfQoKICAgICNmb3JtIHsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA1MDBweCkgewoKICAgICN2ZXJzaW9uIHsKICAgICAgICBkaXNwbGF5OiBub25lOwogICAgfQoKfQoKI3RleHQtaW5wdXQgewogICAgZm9udC1zaXplOiAxcmVtOwogICAgZmxleC1ncm93OiAxOwogICAgcGFkZGluZzogMC41cmVtIDAuNXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgICBib3JkZXI6IHNvbGlkIDFweCB3aGl0ZTsKICAgIG91dGxpbmU6IG5vbmU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiN0ZXh0LWlucHV0OnJlYWQtb25seSB7CiAgICBvcGFjaXR5OiAwLjU7IAp9CgppbnB1dDotd2Via2l0LWF1dG9maWxsLCBpbnB1dDotd2Via2l0LWF1dG9maWxsOmZvY3VzIHsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgNjAwMDAwcyAwcywgY29sb3IgNjAwMDAwcyAwczsKfQoKI2Zvcm0gYnV0dG9uIHsKICAgIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwogICAgbWluLXdpZHRoOiA4cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0Rm9ybShkb2N1bWVudCwgdm0sIHN0YXRpY0RhdGEpIHsKICAgIGNvbnN0IGZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZm9ybScpOwogICAgY29uc3QgdGV4dElucHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3RleHQtaW5wdXQnKTsKICAgIGNvbnN0IHN1Ym1pdEJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdWJtaXQnKTsKICAgIGNvbnN0IHZlcnNpb25TcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZlcnNpb24nKTsKICAgIGNvbnN0IHZlcnNpb24gPSBbCiAgICAgICAgc3RhdGljRGF0YS52ZXJzaW9uLAogICAgICAgIHN0YXRpY0RhdGEucHVzaElkCiAgICBdLm1hcCgodik9Pih2IHx8ICcnKS50cmltKCkKICAgICkuZmlsdGVyKCh2KT0+di5sZW5ndGggPiAwCiAgICApLmpvaW4oJy4nKTsKICAgIHZlcnNpb25TcGFuLnRleHRDb250ZW50ID0gc3RhdGljRGF0YS52ZXJzaW9uID8gYHYke3ZlcnNpb259YCA6ICcnOwogICAgY29uc3QgeyBzZWFyY2hQYXJhbXMgIH0gPSBuZXcgVVJMKGRvY3VtZW50LlVSTCk7CiAgICBjb25zdCB2YWxpZGF0ZSA9IHNlYXJjaFBhcmFtcy5nZXQoJ3ZhbGlkYXRlJykgfHwgdW5kZWZpbmVkOwogICAgY29uc3QgaW5wdXQgPSBzZWFyY2hQYXJhbXMuZ2V0KCdpbnB1dCcpIHx8IHVuZGVmaW5lZDsKICAgIGNvbnN0IG5vY29tbWVudHMgPSBzZWFyY2hQYXJhbXMuaGFzKCdub2NvbW1lbnRzJyk7CiAgICBjb25zdCBzdGFydFZhbGlkYXRpb24gPSAoKT0+dm0uc3RhcnRWYWxpZGF0aW9uKHRleHRJbnB1dC52YWx1ZSwgewogICAgICAgICAgICB2YWxpZGF0ZUNvbW1lbnRzOiAhbm9jb21tZW50cywKICAgICAgICAgICAgdXNlckFnZW50OiBuYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgfSkKICAgIDsKICAgIGZvcm0ub25zdWJtaXQgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYgKHZtLnZhbGlkYXRpbmcpIHsKICAgICAgICAgICAgdm0uY2FuY2VsVmFsaWRhdGlvbigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0VmFsaWRhdGlvbigpOwogICAgICAgIH0KICAgIH07CiAgICBpZiAodmFsaWRhdGUpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSB2YWxpZGF0ZTsKICAgICAgICBzZXRUaW1lb3V0KHN0YXJ0VmFsaWRhdGlvbiwgMCk7CiAgICB9IGVsc2UgaWYgKGlucHV0KSB7CiAgICAgICAgdGV4dElucHV0LnZhbHVlID0gaW5wdXQ7CiAgICB9CiAgICB0ZXh0SW5wdXQuZm9jdXMoKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHdhc0Rpc2FibGVkID0gdGV4dElucHV0LmRpc2FibGVkOwogICAgICAgIHRleHRJbnB1dC5kaXNhYmxlZCA9IHZtLnZhbGlkYXRpbmc7CiAgICAgICAgdGV4dElucHV0LnJlYWRPbmx5ID0gdm0udmFsaWRhdGluZzsKICAgICAgICBzdWJtaXRCdXR0b24udGV4dENvbnRlbnQgPSB2bS52YWxpZGF0aW5nID8gJ0NhbmNlbCcgOiAnVmFsaWRhdGUnOwogICAgICAgIGlmICh3YXNEaXNhYmxlZCAmJiAhdGV4dElucHV0LmRpc2FibGVkKSB7CiAgICAgICAgICAgIHRleHRJbnB1dC5mb2N1cygpOwogICAgICAgIH0KICAgIH07Cn0KY29uc3QgTUVTU0FHRVNfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9Im1lc3NhZ2VzIj48L291dHB1dD4KYDsKY29uc3QgTUVTU0FHRVNfQ1NTID0gY3NzYAoKI21lc3NhZ2VzIHsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBkaXNwbGF5OiBncmlkOwogICAgZ3JpZC10ZW1wbGF0ZS1jb2x1bW5zOiAycmVtIGF1dG87CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZm9udC1zaXplOiAwLjc1cmVtOwp9CgojbWVzc2FnZXMgPiBkaXYsICNtZXNzYWdlcyA+IGEgewogICAgYW5pbWF0aW9uOiBmYWRlSW5BbmltYXRpb24gMC40czsKfQoKI21lc3NhZ2VzIHN2ZyB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDAuNzUpOwogICAgZmlsbDogY3VycmVudENvbG9yOwp9CgojbWVzc2FnZXMgPiBkaXYuaW5mbyB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0KCiNtZXNzYWdlcyA+IGRpdi5nb29kIHsKICAgIGNvbG9yOiAjNDNhMDQ3Owp9CiNtZXNzYWdlcyA+IGRpdi53YXJuaW5nIHsKICAgIGNvbG9yOiAjZTY1MTAwOwp9CgojbWVzc2FnZXMgPiBkaXYuZXJyb3IgewogICAgY29sb3I6ICNiNzFjMWM7Cn0KCiNtZXNzYWdlcyA+IGRpdi5ydW5uaW5nLCAjbWVzc2FnZXMgPiBkaXYuZG9uZSB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiNtZXNzYWdlcyAuaWNvbiB7CiAgICBncmlkLWNvbHVtbjogMTsKICAgIHdpZHRoOiAyNHB4OwogICAgaGVpZ2h0OiAyNHB4OwogICAgZGlzcGxheTogZmxleDsKICAgIGp1c3RpZnktY29udGVudDogY2VudGVyOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKfQoKI21lc3NhZ2VzIC5tZXNzYWdlIHsKICAgIGdyaWQtY29sdW1uOiAyOwp9CgojbWVzc2FnZXMgLnVybCB7CiAgICBncmlkLWNvbHVtbjogMjsKICAgIG1hcmdpbi1ib3R0b206IDAuMjVyZW07CiAgICBvdmVyZmxvdzogaGlkZGVuOwogICAgdGV4dC1vdmVyZmxvdzogZWxsaXBzaXM7Cn0KCiNtZXNzYWdlcyBwcm9ncmVzcyB7CiAgICBmb250LXNpemU6IDAuMzVyZW07Cn0KCiNtZXNzYWdlcyAucmVmZXJlbmNlIHsKICAgIGRpc3BsYXk6IGlubGluZS1ibG9jazsKICAgIG1hcmdpbi1sZWZ0OiAwLjI1cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0TWVzc2FnZXMoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBtZXNzYWdlc091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZXNzYWdlcycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoTUVTU0FHRV9IVE1MKHZtKSwgbWVzc2FnZXNPdXRwdXQpOwogICAgfTsKfQpjb25zdCBNRVNTQUdFX0hUTUwgPSAodm0pPT5odG1sYAogICAgJHt2bS5tZXNzYWdlcy5maWx0ZXIoZmlsdGVyRHVwbGljYXRlcygpKS5tYXAoKG1lc3NhZ2UpPT5odG1sYAogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBpY29uIj4ke2ljb24obWVzc2FnZS50eXBlKX08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSIke21lc3NhZ2UudHlwZX0gbWVzc2FnZSI+JHttZXNzYWdlLnRleHR9JHtSRUZFUkVOQ0VfSFRNTChtZXNzYWdlLnJlZmVyZW5jZSl9PC9kaXY+CiAgICAgICAgJHtBTkNIT1JfSFRNTChtZXNzYWdlLnVybCl9YAogICAgKX1gCjsKY29uc3QgUkVGRVJFTkNFX0hUTUwgPSAocmVmZXJlbmNlKT0+cmVmZXJlbmNlID8gaHRtbGA8YSBjbGFzcz0icmVmZXJlbmNlIiBocmVmPSR7cmVmZXJlbmNlLmhyZWZ9IHRhcmdldD0iX2JsYW5rIiByZWw9Im5vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3ciPlske3JlZmVyZW5jZS5ydWxlc2V0fV08L2E+YCA6IHVuZGVmaW5lZAo7CmNvbnN0IEFOQ0hPUl9IVE1MID0gKHVybCk9PnVybCA/IGh0bWxgPGEgaHJlZj0ke3VybH0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyIgY2xhc3M9InVybCI+JHt1cmx9PC9hPmAgOiB1bmRlZmluZWQKOwpmdW5jdGlvbiBpY29uKHR5cGUpIHsKICAgIHJldHVybiB0eXBlID09PSAncnVubmluZycgPyBodG1sYDxwcm9ncmVzcyBjbGFzcz0icHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciI+PC9wcm9ncmVzcz5gIDogdHlwZSA9PT0gJ2RvbmUnID8gQ0hFQ0tfSUNPTiA6IHR5cGUgPT09ICdlcnJvcicgPyBFUlJPUl9JQ09OIDogdHlwZSA9PT0gJ3dhcm5pbmcnID8gV0FSTklOR19JQ09OIDogdHlwZSA9PT0gJ2dvb2QnID8gQ0hFQ0tfSUNPTiA6IElORk9fSUNPTjsKfQpmdW5jdGlvbiBmaWx0ZXJEdXBsaWNhdGVzKCkgewogICAgY29uc3QgdGFnVXJscyA9IG5ldyBTZXQoKTsKICAgIHJldHVybiAobWVzc2FnZSk9PnsKICAgICAgICBjb25zdCB7IHRhZyAsIHVybCAgfSA9IG1lc3NhZ2U7CiAgICAgICAgaWYgKHRhZyAmJiB1cmwpIHsKICAgICAgICAgICAgY29uc3QgdGFnVXJsID0gYCR7dGFnfXwke3VybH1gOwogICAgICAgICAgICBpZiAodGFnVXJscy5oYXModGFnVXJsKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0YWdVcmxzLmFkZCh0YWdVcmwpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Owp9CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJzZWFyY2gtcmVzdWx0cyI+PC9vdXRwdXQ+CmA7CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0NTUyA9IGNzc2AKCiNzZWFyY2gtcmVzdWx0cyB7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgZGlzcGxheTogbm9uZTsKfQoKI3NlYXJjaC1yZXN1bHRzID4gZGl2IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNXJlbTsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwogICAgbWFyZ2luLWJvdHRvbTogMC43NXJlbTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKI3NlYXJjaC1yZXN1bHRzIC5pY29uLCAjc2VhcmNoLXJlc3VsdHMgaW1nIHsKICAgIHdpZHRoOiAxLjVyZW07CiAgICBoZWlnaHQ6IDEuNXJlbTsKfQoKI3NlYXJjaC1yZXN1bHRzIC50aXRsZSB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiNzZWFyY2gtcmVzdWx0cyAuYXV0aG9yIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNlYXJjaFJlc3VsdHMoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBzZWFyY2hSZXN1bHRzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlYXJjaC1yZXN1bHRzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihSRVNVTFRTX0hUTUwodm0pLCBzZWFyY2hSZXN1bHRzT3V0cHV0KTsKICAgICAgICBzZWFyY2hSZXN1bHRzT3V0cHV0LnN0eWxlLmRpc3BsYXkgPSB2bS5pc1NlYXJjaCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IFJFU1VMVFNfSFRNTCA9ICh2bSk9Pmh0bWxgCiAgICAke3ZtLnNlYXJjaFJlc3VsdHMubWFwKChyZXN1bHQpPT5odG1sYDxkaXYgY2xhc3M9InNlYXJjaC1yZXN1bHQiIEBjbGljaz0iJHtzZWxlY3RSZXN1bHQodm0sIHJlc3VsdC51cmwpfSI+PGRpdiBjbGFzcz0iaWNvbiI+JHtJTUFHRV9IVE1MKHJlc3VsdC5hcnR3b3JrKX08L2Rpdj48ZGl2IGNsYXNzPSJ0aXRsZSI+JHtyZXN1bHQudGl0bGV9PC9kaXY+PGRpdiBjbGFzcz0iYXV0aG9yIj4ke3Jlc3VsdC5hdXRob3J9PC9kaXY+PC9kaXY+YAogICAgKX1gCjsKY29uc3QgSU1BR0VfSFRNTCA9IChhcnR3b3JrKT0+YXJ0d29yayA/IGh0bWxgPGltZyBzcmM9JHthcnR3b3JrfT5gIDogU1FVQVJFX0lDT04KOwpmdW5jdGlvbiBzZWxlY3RSZXN1bHQodm0sIHVybCkgewogICAgcmV0dXJuICgpPT52bS5jb250aW51ZVdpdGgodXJsKQogICAgOwp9CmNvbnN0IFhNTF9IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ieG1sIj48L291dHB1dD4KYDsKY29uc3QgWE1MX0NTUyA9IGNzc2AKI3htbCB7CiAgICBmb250LWZhbWlseTogJHt1bnNhZmVDU1MoVGhlbWUubW9ub3NwYWNlRm9udEZhbWlseSl9OwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGluZS1oZWlnaHQ6IDFyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07CiAgICBvdmVyZmxvdy13cmFwOiBicmVhay13b3JkOwogICAgbGluZS1oZWlnaHQ6IDEuNDsKfQoKI3htbCAucm9vdCB7CiAgICBmb250LWZhbWlseTogJHt1bnNhZmVDU1MoVGhlbWUuc2Fuc1NlcmlmRm9udEZhbWlseSl9OwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbGluZS1oZWlnaHQ6IDI7Cn0KCiN4bWwgLmNvbnRlbnQgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9Owp9CgojeG1sIC5wb2RjYXN0IHsKICAgIGNvbG9yOiAjYWI0N2JjOwp9CgojeG1sIC5pbmRlbnQgewogICAgbWFyZ2luLWxlZnQ6IDAuNzVyZW07Cn0KCiN4bWwgLmluZGVudDIgewogICAgbWFyZ2luLWxlZnQ6IDEuNXJlbTsKfQoKc3VtbWFyeS5lbXB0eSB7IGxpc3Qtc3R5bGU6IG5vbmU7IGN1cnNvcjogdGV4dDsgfQpzdW1tYXJ5LmVtcHR5Ojotd2Via2l0LWRldGFpbHMtbWFya2VyIHsgZGlzcGxheTogbm9uZTsgfQoKI3htbCBhdWRpbyB7CiAgICBtYXJnaW46IDAuNXJlbSAxcmVtOwp9CmA7CmZ1bmN0aW9uIGluaXRYbWwoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCB4bWxPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneG1sJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB4bWwgPSB2bS54bWw7CiAgICAgICAgaWYgKHhtbCAhPT0gX3JlbmRlcmVkWG1sKSB7CiAgICAgICAgICAgIHJlbmRlclhtbCh4bWwsIHhtbE91dHB1dCwgdm0ueG1sU3VtbWFyeVRleHQpOwogICAgICAgICAgICBfcmVuZGVyZWRYbWwgPSB4bWw7CiAgICAgICAgfQogICAgfTsKfQpsZXQgX3JlbmRlcmVkWG1sOwpmdW5jdGlvbiByZW5kZXJYbWwoeG1sLCB4bWxPdXRwdXQsIHhtbFN1bW1hcnlUZXh0KSB7CiAgICB3aGlsZSh4bWxPdXRwdXQuZmlyc3RDaGlsZCl4bWxPdXRwdXQucmVtb3ZlQ2hpbGQoeG1sT3V0cHV0LmZpcnN0Q2hpbGQpOwogICAgaWYgKHhtbCkgcmVuZGVyTm9kZTEoeG1sLCB4bWxPdXRwdXQsIDAsIG5ldyBTZXQoKSwgdW5kZWZpbmVkLCB4bWxTdW1tYXJ5VGV4dCk7Cn0KZnVuY3Rpb24gcmVuZGVyTm9kZTEobm9kZSwgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwsIGNvbnRleHQsIGl0ZW1OdW1iZXIsIHhtbFN1bW1hcnlUZXh0KSB7CiAgICBjb25zdCB7IGF0dHMgIH0gPSBub2RlOwogICAgY29uc3QgZGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RldGFpbHMnKTsKICAgIGNvbnN0IHRleHQgPSBub2RlLnZhbCB8fCAnJzsKICAgIGRldGFpbHMub3BlbiA9ICFjb250ZXh0LmhhcygnZm91bmQtaXRlbScpIHx8IHRleHQubGVuZ3RoID4gMDsKICAgIGlmIChsZXZlbCA+IDApIGRldGFpbHMuY2xhc3NMaXN0LmFkZCgnaW5kZW50Jyk7CiAgICBjb25zdCBzdW1tYXJ5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3VtbWFyeScpOwogICAgaWYgKGxldmVsID09PSAwKSB7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhzdW1tYXJ5LCB4bWxTdW1tYXJ5VGV4dCB8fCAnWG1sJyk7CiAgICAgICAgc3VtbWFyeS5jbGFzc0xpc3QuYWRkKCdyb290Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNwYW5DbGFzcyA9IFFuYW1lcy5Qb2RjYXN0SW5kZXguTkFNRVNQQUNFUy5pbmNsdWRlcyhub2RlLnFuYW1lLm5hbWVzcGFjZVVyaSB8fCAnJykgPyAncG9kY2FzdCcgOiB1bmRlZmluZWQ7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhzdW1tYXJ5LCAnPCcsIHsKICAgICAgICAgICAgdGV4dDogbm9kZS50YWduYW1lLAogICAgICAgICAgICBzcGFuQ2xhc3MKICAgICAgICB9LCAuLi5bCiAgICAgICAgICAgIC4uLmF0dHMuZW50cmllcygpCiAgICAgICAgXS5mbGF0TWFwKCh2KT0+WwogICAgICAgICAgICAgICAgYCAke3ZbMF19PSJgLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRleHQ6IHZbMV0sCiAgICAgICAgICAgICAgICAgICAgc3BhbkNsYXNzOiAnY29udGVudCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAnIicKICAgICAgICAgICAgXQogICAgICAgICksICc+JywgaXRlbU51bWJlciA/IGAgIyR7aXRlbU51bWJlcn1gIDogJycpOwogICAgfQogICAgZGV0YWlscy5hcHBlbmRDaGlsZChzdW1tYXJ5KTsKICAgIGxldCBjaGlsZENvdW50ID0gMDsKICAgIGlmICh0ZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgnY29udGVudCcpOwogICAgICAgIHJlbmRlclRleHRQaWVjZXMoZGl2LCB0ZXh0KTsKICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgnaW5kZW50MicpOwogICAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICBjaGlsZENvdW50Kys7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobm9kZS5jaGlsZCkpewogICAgICAgIGxldCBpdGVtTnVtYmVyID0gMTsKICAgICAgICBsZXQgaXRlbXNOb3RTaG93biA9IDA7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIGlmIChuYW1lID09PSAnaXRlbScgJiYgaXRlbU51bWJlciA+IDIwKSB7CiAgICAgICAgICAgICAgICBpdGVtc05vdFNob3duKys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJOb2RlMShjaGlsZCwgZGV0YWlscywgbGV2ZWwgKyAxLCBjb250ZXh0LCB2YWx1ZS5sZW5ndGggPiAxID8gaXRlbU51bWJlciA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgIGNoaWxkQ291bnQrKzsKICAgICAgICAgICAgaXRlbU51bWJlcisrOwogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXNOb3RTaG93biA+IDApIHsKICAgICAgICAgICAgY29uc3QgZmFrZU5vZGUgPSB7CiAgICAgICAgICAgICAgICB0YWduYW1lOiBgLi4uYW5kICR7bmV3IEludGwuTnVtYmVyRm9ybWF0KCkuZm9ybWF0KGl0ZW1zTm90U2hvd24pfSBtb3JlIGl0ZW1zYCwKICAgICAgICAgICAgICAgIGF0dHM6IG5ldyBNYXAoKSwKICAgICAgICAgICAgICAgIHFuYW1lOiB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogJycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhdHRyc01hcDogewogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGNoaWxkOiB7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHJlbmRlck5vZGUxKGZha2VOb2RlLCBkZXRhaWxzLCBsZXZlbCAtIDEsIGNvbnRleHQsIHVuZGVmaW5lZCk7CiAgICAgICAgfQogICAgfQogICAgY29uc3QgYXVkaW9VcmwgPSBub2RlLnRhZ25hbWUgPT09ICdlbmNsb3N1cmUnICYmIGF0dHMuZ2V0KCd1cmwnKSB8fCBub2RlLnFuYW1lLm5hbWVzcGFjZVVyaSAmJiBxbmFtZXNJbmNsdWRlKFFuYW1lcy5Qb2RjYXN0SW5kZXguc291cmNlLCBub2RlLnFuYW1lKSAmJiBhdHRzLmdldCgndXJpJykgfHwgcW5hbWVFcShub2RlLnFuYW1lLCBRbmFtZXMuTWVkaWFSc3MuY29udGVudCkgJiYgKGF0dHMuZ2V0KCd0eXBlJykgfHwgJycpLnN0YXJ0c1dpdGgoJ2F1ZGlvJykgJiYgYXR0cy5nZXQoJ3VybCcpOwogICAgaWYgKGF1ZGlvVXJsKSB7CiAgICAgICAgY29uc3QgYXVkaW8gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhdWRpbycpOwogICAgICAgIGF1ZGlvLmNvbnRyb2xzID0gdHJ1ZTsKICAgICAgICBhdWRpby5wcmVsb2FkID0gJ25vbmUnOwogICAgICAgIGF1ZGlvLnNyYyA9IGF1ZGlvVXJsOwogICAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoYXVkaW8pOwogICAgICAgIGNoaWxkQ291bnQrKzsKICAgIH0KICAgIGlmIChjaGlsZENvdW50ID09PSAwKSBzdW1tYXJ5LmNsYXNzTGlzdC5hZGQoJ2VtcHR5JywgJ2luZGVudCcpOwogICAgY29udGFpbmVyRWxlbWVudC5hcHBlbmRDaGlsZChkZXRhaWxzKTsKICAgIGlmIChub2RlLnRhZ25hbWUgPT09ICdpdGVtJykgY29udGV4dC5hZGQoJ2ZvdW5kLWl0ZW0nKTsKfQpmdW5jdGlvbiByZW5kZXJUZXh0UGllY2VzKGVsZW1lbnQsIC4uLnBpZWNlcykgewogICAgZm9yIChjb25zdCBwaWVjZSBvZiBwaWVjZXMpewogICAgICAgIGNvbnN0IHRleHQgPSB0eXBlb2YgcGllY2UgPT09ICdzdHJpbmcnID8gcGllY2UgOiBwaWVjZS50ZXh0OwogICAgICAgIGNvbnN0IHNwYW5DbGFzcyA9IHR5cGVvZiBwaWVjZSA9PT0gJ29iamVjdCcgPyBwaWVjZS5zcGFuQ2xhc3MgOiB1bmRlZmluZWQ7CiAgICAgICAgaWYgKC9eaHR0cHM/OlwvXC9bXlxzKV0rJC8udGVzdCh0ZXh0KSkgewogICAgICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgICAgICBhLmhyZWYgPSB0ZXh0OwogICAgICAgICAgICBleHRlcm5hbGl6ZUFuY2hvcihhKTsKICAgICAgICAgICAgYS5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgdGV4dE5vZGUgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh0ZXh0KTsKICAgICAgICAgICAgaWYgKHNwYW5DbGFzcykgewogICAgICAgICAgICAgICAgY29uc3Qgc3BhbiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NwYW4nKTsKICAgICAgICAgICAgICAgIHNwYW4uY2xhc3NMaXN0LmFkZChzcGFuQ2xhc3MpOwogICAgICAgICAgICAgICAgc3Bhbi5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHNwYW4pOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZCh0ZXh0Tm9kZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KY29uc3QgYXBwTW9kdWxlU2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2FwcC1tb2R1bGUtc2NyaXB0Jyk7CmZ1bmN0aW9uIHNldEFwcFN0YXRlKGFwcFN0YXRlKSB7CiAgICBhcHBNb2R1bGVTY3JpcHQuZGF0YXNldC5zdGF0ZSA9IGFwcFN0YXRlOwp9CnNldEFwcFN0YXRlKCdzdGFydGluZycpOwpjb25zdCBhcHBDc3MgPSBjc3NgCgphIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS5wcmltYXJ5Q29sb3IzMDBIZXgpfTsKICAgIHRleHQtdW5kZXJsaW5lLW9mZnNldDogMC4ycmVtOwogICAgdGV4dC1kZWNvcmF0aW9uOiBub25lOwp9CgpAbWVkaWEgKGhvdmVyOiBob3ZlcikgewogICAgYTpob3ZlciB7CiAgICAgICAgdGV4dC1kZWNvcmF0aW9uOiB1bmRlcmxpbmU7CiAgICB9Cn0KCm1haW4gewogICAgbWFyZ2luOiAycmVtOwogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47Cn0KCkBrZXlmcmFtZXMgZmFkZUluQW5pbWF0aW9uIHsKICAgIDAlIHsKICAgICAgICBvcGFjaXR5OiAwOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgb3BhY2l0eTogMTsKICAgIH0KfQoKc3VtbWFyeSB7CiAgICBjdXJzb3I6IHBvaW50ZXI7Cn0KCmA7CmNvbnN0IGFwcEh0bWwgPSBodG1sYAo8bWFpbj4KJHtGT1JNX0hUTUx9CiR7TUVTU0FHRVNfSFRNTH0KJHtTRUFSQ0hfUkVTVUxUU19IVE1MfQoke0NPTU1FTlRTX0hUTUx9CiR7WE1MX0hUTUx9CjwvbWFpbj4KYDsKZnVuY3Rpb24gYXBwZW5kU3R5bGVzaGVldHMoY3NzVGV4dHMpIHsKICAgIGNvbnN0IHN0eWxlU2hlZXQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdHlsZScpOwogICAgc3R5bGVTaGVldC50eXBlID0gJ3RleHQvY3NzJzsKICAgIHN0eWxlU2hlZXQudGV4dENvbnRlbnQgPSBjc3NUZXh0cy5qb2luKCdcblxuJyk7CiAgICBkb2N1bWVudC5oZWFkLmFwcGVuZENoaWxkKHN0eWxlU2hlZXQpOwp9CmFwcGVuZFN0eWxlc2hlZXRzKFsKICAgIGFwcENzcy5jc3NUZXh0LAogICAgRk9STV9DU1MuY3NzVGV4dCwKICAgIE1FU1NBR0VTX0NTUy5jc3NUZXh0LAogICAgU0VBUkNIX1JFU1VMVFNfQ1NTLmNzc1RleHQsCiAgICBDT01NRU5UU19DU1MuY3NzVGV4dCwKICAgIFhNTF9DU1MuY3NzVGV4dCwKICAgIENJUkNVTEFSX1BST0dSRVNTX0NTUy5jc3NUZXh0LCAKXSk7CkxpdEVsZW1lbnQucmVuZGVyKGFwcEh0bWwsIGRvY3VtZW50LmJvZHkpOwpmdW5jdGlvbiBwYXJzZVN0YXRpY0RhdGEoKSB7CiAgICBjb25zdCBzY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3RhdGljLWRhdGEtc2NyaXB0Jyk7CiAgICBjb25zdCBkYXRhID0gSlNPTi5wYXJzZShzY3JpcHQudGV4dCk7CiAgICBjb25zdCB2ZXJzaW9uID0gdHlwZW9mIGRhdGEudmVyc2lvbiA9PT0gJ3N0cmluZycgPyBkYXRhLnZlcnNpb24gOiB1bmRlZmluZWQ7CiAgICBjb25zdCBmbGFncyA9IHR5cGVvZiBkYXRhLmZsYWdzID09PSAnc3RyaW5nJyA/IGRhdGEuZmxhZ3MgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBkZWJ1ZyA9IHR5cGVvZiBkYXRhLmRlYnVnID09PSAnb2JqZWN0JyA/IGRhdGEuZGVidWcgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBwdXNoSWQgPSB0eXBlb2YgZGF0YS5wdXNoSWQgPT09ICdzdHJpbmcnID8gZGF0YS5wdXNoSWQgOiB1bmRlZmluZWQ7CiAgICByZXR1cm4gewogICAgICAgIHZlcnNpb24sCiAgICAgICAgZmxhZ3MsCiAgICAgICAgZGVidWcsCiAgICAgICAgcHVzaElkCiAgICB9Owp9CmNvbnN0IHN0YXRpY0RhdGEgPSBwYXJzZVN0YXRpY0RhdGEoKTsKY29uc3QgbG9jYWxGZXRjaGVyID0gKHVybCwgaGVhZGVycyk9PmZldGNoKHVybCwgewogICAgICAgIGhlYWRlcnMKICAgIH0pCjsKY29uc3QgcmVtb3RlRmV0Y2hlciA9ICh1cmwsIGhlYWRlcnMpPT5mZXRjaChgL2YvJHt1cmwucmVwbGFjZUFsbCgvW15hLXpBLVowLTkuXSsvZywgJ18nKX1gLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KQogICAgfSkKOwpjb25zdCBwaVNlYXJjaEZldGNoZXIxID0gKGlucHV0LCBoZWFkZXJzKT0+ZmV0Y2goYC9zYCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgaW5wdXQsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KQogICAgfSkKOwpjb25zdCB2bSA9IG5ldyBWYWxpZGF0b3JBcHBWTSh7CiAgICBsb2NhbEZldGNoZXIsCiAgICByZW1vdGVGZXRjaGVyLAogICAgcGlTZWFyY2hGZXRjaGVyOiBwaVNlYXJjaEZldGNoZXIxCn0pOwpjb25zdCB1cGRhdGVGb3JtID0gaW5pdEZvcm0oZG9jdW1lbnQsIHZtLCBzdGF0aWNEYXRhKTsKY29uc3QgdXBkYXRlTWVzc2FnZXMgPSBpbml0TWVzc2FnZXMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlU2VhcmNoUmVzdWx0cyA9IGluaXRTZWFyY2hSZXN1bHRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZUNvbW1lbnRzID0gaW5pdENvbW1lbnRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZVhtbCA9IGluaXRYbWwoZG9jdW1lbnQsIHZtKTsKdm0ub25DaGFuZ2UgPSAoKT0+ewogICAgdXBkYXRlRm9ybSgpOwogICAgdXBkYXRlTWVzc2FnZXMoKTsKICAgIHVwZGF0ZVNlYXJjaFJlc3VsdHMoKTsKICAgIHVwZGF0ZUNvbW1lbnRzKCk7CiAgICB1cGRhdGVYbWwoKTsKfTsKdm0uc3RhcnQoKTsKc2V0QXBwU3RhdGUoJ3N0YXJ0ZWQnKTsK';
