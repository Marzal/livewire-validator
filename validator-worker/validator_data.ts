export const VALIDATOR_APP_HASH = '2508332657482af341fd2dc29dbd0f8b3475afdd';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7fTsKY29uc3Qgbm90aGluZyA9IHt9Owpjb25zdCBtYXJrZXIgPSBge3tsaXQtJHtTdHJpbmcoTWF0aC5yYW5kb20oKSkuc2xpY2UoMil9fX1gOwpjb25zdCBub2RlTWFya2VyID0gYDwhLS0ke21hcmtlcn0tLT5gOwpjb25zdCBtYXJrZXJSZWdleCA9IG5ldyBSZWdFeHAoYCR7bWFya2VyfXwke25vZGVNYXJrZXJ9YCk7CmNvbnN0IGJvdW5kQXR0cmlidXRlU3VmZml4ID0gIiRsaXQkIjsKY2xhc3MgVGVtcGxhdGUgewogICAgY29uc3RydWN0b3IocmVzdWx0LCBlbGVtZW50KXsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICBjb25zdCBub2Rlc1RvUmVtb3ZlID0gW107CiAgICAgICAgY29uc3Qgc3RhY2sgPSBbXTsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGVsZW1lbnQuY29udGVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IGxhc3RQYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHsgc3RyaW5ncyAsIHZhbHVlczogeyBsZW5ndGggIH0gIH0gPSByZXN1bHQ7CiAgICAgICAgd2hpbGUocGFydEluZGV4IDwgbGVuZ3RoKXsKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlcygpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5vZGUuYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGxlbmd0aDogbGVuZ3RoMiAgfSA9IGF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuZ3RoMjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZHNXaXRoKGF0dHJpYnV0ZXNbaV0ubmFtZSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHdoaWxlKGNvdW50LS0gPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nRm9yUGFydCA9IHN0cmluZ3NbcGFydEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzdHJpbmdGb3JQYXJ0KVsyXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTG9va3VwTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKSArIGJvdW5kQXR0cmlidXRlU3VmZml4OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVMb29rdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdGljcyA9IGF0dHJpYnV0ZVZhbHVlLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJhdHRyaWJ1dGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nczogc3RhdGljcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydEluZGV4ICs9IHN0YXRpY3MubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZS50YWdOYW1lID09PSAiVEVNUExBVEUiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBub2RlLmNvbnRlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhLmluZGV4T2YobWFya2VyKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ3MyID0gZGF0YS5zcGxpdChtYXJrZXJSZWdleCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdEluZGV4ID0gc3RyaW5nczIubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGFzdEluZGV4OyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5zZXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcyA9IHN0cmluZ3MyW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocyA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGNyZWF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwgJiYgZW5kc1dpdGgobWF0Y2hbMl0sIGJvdW5kQXR0cmlidXRlU3VmZml4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBzLnNsaWNlKDAsIG1hdGNoLmluZGV4KSArIG1hdGNoWzFdICsgbWF0Y2hbMl0uc2xpY2UoMCwgLWJvdW5kQXR0cmlidXRlU3VmZml4Lmxlbmd0aCkgKyBtYXRjaFszXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoaW5zZXJ0LCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiArK2luZGV4CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoc3RyaW5nczJbbGFzdEluZGV4XSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjcmVhdGVNYXJrZXIoKSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzVG9SZW1vdmUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSBzdHJpbmdzMltsYXN0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gbGFzdEluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDgpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmRhdGEgPT09IG1hcmtlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5wcmV2aW91c1NpYmxpbmcgPT09IG51bGwgfHwgaW5kZXggPT09IGxhc3RQYXJ0SW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjcmVhdGVNYXJrZXIoKSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxhc3RQYXJ0SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5kYXRhID0gIiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGkgPSAtMTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSgoaSA9IG5vZGUuZGF0YS5pbmRleE9mKG1hcmtlciwgaSArIDEpKSAhPT0gLTEpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IC0xCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBuIG9mIG5vZGVzVG9SZW1vdmUpewogICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGVuZHNXaXRoID0gKHN0ciwgc3VmZml4KT0+ewogICAgY29uc3QgaW5kZXggPSBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aDsKICAgIHJldHVybiBpbmRleCA+PSAwICYmIHN0ci5zbGljZShpbmRleCkgPT09IHN1ZmZpeDsKfTsKY29uc3QgaXNUZW1wbGF0ZVBhcnRBY3RpdmUgPSAocGFydCk9PnBhcnQuaW5kZXggIT09IC0xCjsKY29uc3QgY3JlYXRlTWFya2VyID0gKCk9PmRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpCjsKY29uc3QgbGFzdEF0dHJpYnV0ZU5hbWVSZWdleCA9IC8oWyBceDA5XHgwYVx4MGNceDBkXSkoW15cMC1ceDFGXHg3Ri1ceDlGICInPj0vXSspKFsgXHgwOVx4MGFceDBjXHgwZF0qPVsgXHgwOVx4MGFceDBjXHgwZF0qKD86W14gXHgwOVx4MGFceDBjXHgwZCInYDw+PV0qfCJbXiJdKnwnW14nXSopKSQvOwpjbGFzcyBUZW1wbGF0ZUluc3RhbmNlIHsKICAgIGNvbnN0cnVjdG9yKHRlbXBsYXRlLCBwcm9jZXNzb3IsIG9wdGlvbnMpewogICAgICAgIHRoaXMuX19wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfQogICAgdXBkYXRlKHZhbHVlcykgewogICAgICAgIGxldCBpID0gMDsKICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgdGhpcy5fX3BhcnRzKXsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydC5zZXRWYWx1ZSh2YWx1ZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBwYXJ0MSBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydDEgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydDEuY29tbWl0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBfY2xvbmUoKSB7CiAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBpc0NFUG9seWZpbGwgPyB0aGlzLnRlbXBsYXRlLmVsZW1lbnQuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkgOiBkb2N1bWVudC5pbXBvcnROb2RlKHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LCB0cnVlKTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMudGVtcGxhdGUucGFydHM7CiAgICAgICAgY29uc3Qgd2Fsa2VyID0gZG9jdW1lbnQuY3JlYXRlVHJlZVdhbGtlcihmcmFnbWVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IG5vZGVJbmRleCA9IDA7CiAgICAgICAgbGV0IHBhcnQ7CiAgICAgICAgbGV0IG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBwYXJ0czIubGVuZ3RoKXsKICAgICAgICAgICAgcGFydCA9IHBhcnRzMltwYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoIWlzVGVtcGxhdGVQYXJ0QWN0aXZlKHBhcnQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaCh2b2lkIDApOwogICAgICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZShub2RlSW5kZXggPCBwYXJ0LmluZGV4KXsKICAgICAgICAgICAgICAgIG5vZGVJbmRleCsrOwogICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgobm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFydC50eXBlID09PSAibm9kZSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhcnQyID0gdGhpcy5wcm9jZXNzb3IuaGFuZGxlVGV4dEV4cHJlc3Npb24odGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIHBhcnQyLmluc2VydEFmdGVyTm9kZShub2RlLnByZXZpb3VzU2libGluZyk7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaChwYXJ0Mik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaCguLi50aGlzLnByb2Nlc3Nvci5oYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhub2RlLCBwYXJ0Lm5hbWUsIHBhcnQuc3RyaW5ncywgdGhpcy5vcHRpb25zKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgfQogICAgICAgIGlmIChpc0NFUG9seWZpbGwpIHsKICAgICAgICAgICAgZG9jdW1lbnQuYWRvcHROb2RlKGZyYWdtZW50KTsKICAgICAgICAgICAgY3VzdG9tRWxlbWVudHMudXBncmFkZShmcmFnbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0KfQpjb25zdCBwb2xpY3kgPSB3aW5kb3cudHJ1c3RlZFR5cGVzICYmIHRydXN0ZWRUeXBlcy5jcmVhdGVQb2xpY3koImxpdC1odG1sIiwgewogICAgY3JlYXRlSFRNTDogKHMpPT5zCn0pOwpjb25zdCBjb21tZW50TWFya2VyID0gYCAke21hcmtlcn0gYDsKY2xhc3MgVGVtcGxhdGVSZXN1bHQgewogICAgY29uc3RydWN0b3Ioc3RyaW5ncywgdmFsdWVzLCB0eXBlLCBwcm9jZXNzb3IpewogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3M7CiAgICAgICAgdGhpcy52YWx1ZXMgPSB2YWx1ZXM7CiAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgIH0KICAgIGdldEhUTUwoKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGxldCBodG1sMiA9ICIiOwogICAgICAgIGxldCBpc0NvbW1lbnRCaW5kaW5nID0gZmFsc2U7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IHMgPSB0aGlzLnN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRPcGVuID0gcy5sYXN0SW5kZXhPZigiPCEtLSIpOwogICAgICAgICAgICBpc0NvbW1lbnRCaW5kaW5nID0gKGNvbW1lbnRPcGVuID4gLTEgfHwgaXNDb21tZW50QmluZGluZykgJiYgcy5pbmRleE9mKCItLT4iLCBjb21tZW50T3BlbiArIDEpID09PSAtMTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVNYXRjaCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcyArIChpc0NvbW1lbnRCaW5kaW5nID8gY29tbWVudE1hcmtlciA6IG5vZGVNYXJrZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcy5zdWJzdHIoMCwgYXR0cmlidXRlTWF0Y2guaW5kZXgpICsgYXR0cmlidXRlTWF0Y2hbMV0gKyBhdHRyaWJ1dGVNYXRjaFsyXSArIGJvdW5kQXR0cmlidXRlU3VmZml4ICsgYXR0cmlidXRlTWF0Y2hbM10gKyBtYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaHRtbDIgKz0gdGhpcy5zdHJpbmdzW2xdOwogICAgICAgIHJldHVybiBodG1sMjsKICAgIH0KICAgIGdldFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRlbXBsYXRlIik7CiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRIVE1MKCk7CiAgICAgICAgaWYgKHBvbGljeSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhbHVlID0gcG9saWN5LmNyZWF0ZUhUTUwodmFsdWUpOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZS5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9Cn0KY2xhc3MgU1ZHVGVtcGxhdGVSZXN1bHQgZXh0ZW5kcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBnZXRIVE1MKCkgewogICAgICAgIHJldHVybiBgPHN2Zz4ke3N1cGVyLmdldEhUTUwoKX08L3N2Zz5gOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gc3VwZXIuZ2V0VGVtcGxhdGVFbGVtZW50KCk7CiAgICAgICAgY29uc3QgY29udGVudCA9IHRlbXBsYXRlLmNvbnRlbnQ7CiAgICAgICAgY29uc3Qgc3ZnRWxlbWVudCA9IGNvbnRlbnQuZmlyc3RDaGlsZDsKICAgICAgICBjb250ZW50LnJlbW92ZUNoaWxkKHN2Z0VsZW1lbnQpOwogICAgICAgIHJlcGFyZW50Tm9kZXMoY29udGVudCwgc3ZnRWxlbWVudC5maXJzdENoaWxkKTsKICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9Cn0KY29uc3QgaXNQcmltaXRpdmUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgISh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIik7Cn07CmNvbnN0IGlzSXRlcmFibGUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISEodmFsdWUgJiYgdmFsdWVbU3ltYm9sLml0ZXJhdG9yXSk7Cn07CmNsYXNzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoIC0gMTsgaSsrKXsKICAgICAgICAgICAgdGhpcy5wYXJ0c1tpXSA9IHRoaXMuX2NyZWF0ZVBhcnQoKTsKICAgICAgICB9CiAgICB9CiAgICBfY3JlYXRlUGFydCgpIHsKICAgICAgICByZXR1cm4gbmV3IEF0dHJpYnV0ZVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgY29uc3Qgc3RyaW5ncyA9IHRoaXMuc3RyaW5nczsKICAgICAgICBjb25zdCBsID0gc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMucGFydHM7CiAgICAgICAgaWYgKGwgPT09IDEgJiYgc3RyaW5nc1swXSA9PT0gIiIgJiYgc3RyaW5nc1sxXSA9PT0gIiIpIHsKICAgICAgICAgICAgY29uc3QgdiA9IHBhcnRzMlswXS52YWx1ZTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAic3ltYm9sIikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciIHx8ICFpc0l0ZXJhYmxlKHYpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgdGV4dCA9ICIiOwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsOyBpKyspewogICAgICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IHBhcnQgPSBwYXJ0czJbaV07CiAgICAgICAgICAgIGlmIChwYXJ0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHYgPSBwYXJ0LnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGlzUHJpbWl0aXZlKHYpIHx8ICFpc0l0ZXJhYmxlKHYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdiA9PT0gInN0cmluZyIgPyB2IDogU3RyaW5nKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHQgb2Ygdil7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgKz0gdHlwZW9mIHQgPT09ICJzdHJpbmciID8gdCA6IFN0cmluZyh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGV4dCArPSBzdHJpbmdzW2xdOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsIHRoaXMuX2dldFZhbHVlKCkpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBBdHRyaWJ1dGVQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGNvbW1pdHRlcil7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmNvbW1pdHRlciA9IGNvbW1pdHRlcjsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBub0NoYW5nZSAmJiAoIWlzUHJpbWl0aXZlKHZhbHVlKSB8fCB2YWx1ZSAhPT0gdGhpcy52YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIWlzRGlyZWN0aXZlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5jb21taXR0ZXIuZGlydHkgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMudmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMudmFsdWU7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb21taXR0ZXIuY29tbWl0KCk7CiAgICB9Cn0KY2xhc3MgTm9kZVBhcnQgewogICAgY29uc3RydWN0b3Iob3B0aW9ucyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICBhcHBlbmRJbnRvKGNvbnRhaW5lcikgewogICAgICAgIHRoaXMuc3RhcnROb2RlID0gY29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZU1hcmtlcigpKTsKICAgICAgICB0aGlzLmVuZE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgfQogICAgaW5zZXJ0QWZ0ZXJOb2RlKHJlZikgewogICAgICAgIHRoaXMuc3RhcnROb2RlID0gcmVmOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5uZXh0U2libGluZzsKICAgIH0KICAgIGFwcGVuZEludG9QYXJ0KHBhcnQpIHsKICAgICAgICBwYXJ0Ll9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5lbmROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgfQogICAgaW5zZXJ0QWZ0ZXJQYXJ0KHJlZikgewogICAgICAgIHJlZi5fX2luc2VydCh0aGlzLnN0YXJ0Tm9kZSA9IGNyZWF0ZU1hcmtlcigpKTsKICAgICAgICB0aGlzLmVuZE5vZGUgPSByZWYuZW5kTm9kZTsKICAgICAgICByZWYuZW5kTm9kZSA9IHRoaXMuc3RhcnROb2RlOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBpZiAodmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUHJpbWl0aXZlKHZhbHVlKSkgewogICAgICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMudmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19jb21taXRUZXh0KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlc3VsdCkgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0VGVtcGxhdGVSZXN1bHQodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBOb2RlKSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXROb2RlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRJdGVyYWJsZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbm90aGluZykgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gbm90aGluZzsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZXh0KHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBfX2luc2VydChub2RlKSB7CiAgICAgICAgdGhpcy5lbmROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIHRoaXMuZW5kTm9kZSk7CiAgICB9CiAgICBfX2NvbW1pdE5vZGUodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgdGhpcy5fX2luc2VydCh2YWx1ZSk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgX19jb21taXRUZXh0KHZhbHVlKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuc3RhcnROb2RlLm5leHRTaWJsaW5nOwogICAgICAgIHZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7CiAgICAgICAgY29uc3QgdmFsdWVBc1N0cmluZyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZSA6IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgaWYgKG5vZGUgPT09IHRoaXMuZW5kTm9kZS5wcmV2aW91c1NpYmxpbmcgJiYgbm9kZS5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICBub2RlLmRhdGEgPSB2YWx1ZUFzU3RyaW5nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXROb2RlKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlQXNTdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5vcHRpb25zLnRlbXBsYXRlRmFjdG9yeSh2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZUluc3RhbmNlICYmIHRoaXMudmFsdWUudGVtcGxhdGUgPT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUudXBkYXRlKHZhbHVlLnZhbHVlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgVGVtcGxhdGVJbnN0YW5jZSh0ZW1wbGF0ZSwgdmFsdWUucHJvY2Vzc29yLCB0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICBjb25zdCBmcmFnbWVudCA9IGluc3RhbmNlLl9jbG9uZSgpOwogICAgICAgICAgICBpbnN0YW5jZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICB0aGlzLnZhbHVlID0gaW5zdGFuY2U7CiAgICAgICAgfQogICAgfQogICAgX19jb21taXRJdGVyYWJsZSh2YWx1ZSkgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gW107CiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXRlbVBhcnRzID0gdGhpcy52YWx1ZTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgaXRlbVBhcnQ7CiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKXsKICAgICAgICAgICAgaXRlbVBhcnQgPSBpdGVtUGFydHNbcGFydEluZGV4XTsKICAgICAgICAgICAgaWYgKGl0ZW1QYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0ID0gbmV3IE5vZGVQYXJ0KHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpdGVtUGFydHMucHVzaChpdGVtUGFydCk7CiAgICAgICAgICAgICAgICBpZiAocGFydEluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuYXBwZW5kSW50b1BhcnQodGhpcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGl0ZW1QYXJ0Lmluc2VydEFmdGVyUGFydChpdGVtUGFydHNbcGFydEluZGV4IC0gMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZW1QYXJ0LnNldFZhbHVlKGl0ZW0pOwogICAgICAgICAgICBpdGVtUGFydC5jb21taXQoKTsKICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0SW5kZXggPCBpdGVtUGFydHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGl0ZW1QYXJ0cy5sZW5ndGggPSBwYXJ0SW5kZXg7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoaXRlbVBhcnQgJiYgaXRlbVBhcnQuZW5kTm9kZSk7CiAgICAgICAgfQogICAgfQogICAgY2xlYXIoc3RhcnROb2RlID0gdGhpcy5zdGFydE5vZGUpIHsKICAgICAgICByZW1vdmVOb2Rlcyh0aGlzLnN0YXJ0Tm9kZS5wYXJlbnROb2RlLCBzdGFydE5vZGUubmV4dFNpYmxpbmcsIHRoaXMuZW5kTm9kZSk7CiAgICB9Cn0KY2xhc3MgQm9vbGVhbkF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIGlmIChzdHJpbmdzLmxlbmd0aCAhPT0gMiB8fCBzdHJpbmdzWzBdICE9PSAiIiB8fCBzdHJpbmdzWzFdICE9PSAiIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvb2xlYW4gYXR0cmlidXRlcyBjYW4gb25seSBjb250YWluIGEgc2luZ2xlIGV4cHJlc3Npb24iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3M7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gISF0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUodGhpcy5uYW1lLCAiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9Cn0KY2xhc3MgUHJvcGVydHlDb21taXR0ZXIgZXh0ZW5kcyBBdHRyaWJ1dGVDb21taXR0ZXIgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyl7CiAgICAgICAgc3VwZXIoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyk7CiAgICAgICAgdGhpcy5zaW5nbGUgPSBzdHJpbmdzLmxlbmd0aCA9PT0gMiAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIjsKICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgUHJvcGVydHlQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGlmICh0aGlzLnNpbmdsZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJ0c1swXS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRWYWx1ZSgpOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50W3RoaXMubmFtZV0gPSB0aGlzLl9nZXRWYWx1ZSgpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBQcm9wZXJ0eVBhcnQgZXh0ZW5kcyBBdHRyaWJ1dGVQYXJ0IHsKfQpsZXQgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gZmFsc2U7CigoKT0+ewogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgICAgICBnZXQgY2FwdHVyZSAoKSB7CiAgICAgICAgICAgICAgICBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICB9IGNhdGNoIChfZSkge30KfSkoKTsKY2xhc3MgRXZlbnRQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIGV2ZW50TmFtZSwgZXZlbnRDb250ZXh0KXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICB0aGlzLmV2ZW50TmFtZSA9IGV2ZW50TmFtZTsKICAgICAgICB0aGlzLmV2ZW50Q29udGV4dCA9IGV2ZW50Q29udGV4dDsKICAgICAgICB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCA9IChlKT0+dGhpcy5oYW5kbGVFdmVudChlKQogICAgICAgIDsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgbmV3TGlzdGVuZXIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGNvbnN0IG9sZExpc3RlbmVyID0gdGhpcy52YWx1ZTsKICAgICAgICBjb25zdCBzaG91bGRSZW1vdmVMaXN0ZW5lciA9IG5ld0xpc3RlbmVyID09IG51bGwgfHwgb2xkTGlzdGVuZXIgIT0gbnVsbCAmJiAobmV3TGlzdGVuZXIuY2FwdHVyZSAhPT0gb2xkTGlzdGVuZXIuY2FwdHVyZSB8fCBuZXdMaXN0ZW5lci5vbmNlICE9PSBvbGRMaXN0ZW5lci5vbmNlIHx8IG5ld0xpc3RlbmVyLnBhc3NpdmUgIT09IG9sZExpc3RlbmVyLnBhc3NpdmUpOwogICAgICAgIGNvbnN0IHNob3VsZEFkZExpc3RlbmVyID0gbmV3TGlzdGVuZXIgIT0gbnVsbCAmJiAob2xkTGlzdGVuZXIgPT0gbnVsbCB8fCBzaG91bGRSZW1vdmVMaXN0ZW5lcik7CiAgICAgICAgaWYgKHNob3VsZFJlbW92ZUxpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkQWRkTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5fX29wdGlvbnMgPSBnZXRPcHRpb25zKG5ld0xpc3RlbmVyKTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIHRoaXMudmFsdWUgPSBuZXdMaXN0ZW5lcjsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9CiAgICBoYW5kbGVFdmVudChldmVudCkgewogICAgICAgIGlmICh0eXBlb2YgdGhpcy52YWx1ZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICB0aGlzLnZhbHVlLmNhbGwodGhpcy5ldmVudENvbnRleHQgfHwgdGhpcy5lbGVtZW50LCBldmVudCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5oYW5kbGVFdmVudChldmVudCk7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGdldE9wdGlvbnMgPSAobyk9Pm8gJiYgKGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA/IHsKICAgICAgICBjYXB0dXJlOiBvLmNhcHR1cmUsCiAgICAgICAgcGFzc2l2ZTogby5wYXNzaXZlLAogICAgICAgIG9uY2U6IG8ub25jZQogICAgfSA6IG8uY2FwdHVyZSkKOwpjbGFzcyBEZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgewogICAgaGFuZGxlQXR0cmlidXRlRXhwcmVzc2lvbnMoZWxlbWVudCwgbmFtZSwgc3RyaW5ncywgb3B0aW9ucykgewogICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWVbMF07CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIi4iKSB7CiAgICAgICAgICAgIGNvbnN0IGNvbW1pdHRlcjIgPSBuZXcgUHJvcGVydHlDb21taXR0ZXIoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncyk7CiAgICAgICAgICAgIHJldHVybiBjb21taXR0ZXIyLnBhcnRzOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiQCIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBFdmVudFBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgb3B0aW9ucy5ldmVudENvbnRleHQpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICI/IikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEJvb2xlYW5BdHRyaWJ1dGVQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIGNvbnN0IGNvbW1pdHRlciA9IG5ldyBBdHRyaWJ1dGVDb21taXR0ZXIoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyk7CiAgICAgICAgcmV0dXJuIGNvbW1pdHRlci5wYXJ0czsKICAgIH0KICAgIGhhbmRsZVRleHRFeHByZXNzaW9uKG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gbmV3IE5vZGVQYXJ0KG9wdGlvbnMpOwogICAgfQp9CmNvbnN0IGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciA9IG5ldyBEZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IoKTsKZnVuY3Rpb24gdGVtcGxhdGVGYWN0b3J5KHJlc3VsdCkgewogICAgbGV0IHRlbXBsYXRlQ2FjaGUgPSB0ZW1wbGF0ZUNhY2hlcy5nZXQocmVzdWx0LnR5cGUpOwogICAgaWYgKHRlbXBsYXRlQ2FjaGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlQ2FjaGUgPSB7CiAgICAgICAgICAgIHN0cmluZ3NBcnJheTogbmV3IFdlYWtNYXAoKSwKICAgICAgICAgICAga2V5U3RyaW5nOiBuZXcgTWFwKCkKICAgICAgICB9OwogICAgICAgIHRlbXBsYXRlQ2FjaGVzLnNldChyZXN1bHQudHlwZSwgdGVtcGxhdGVDYWNoZSk7CiAgICB9CiAgICBsZXQgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5nZXQocmVzdWx0LnN0cmluZ3MpOwogICAgaWYgKHRlbXBsYXRlICE9PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9CiAgICBjb25zdCBrZXkgPSByZXN1bHQuc3RyaW5ncy5qb2luKG1hcmtlcik7CiAgICB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLmdldChrZXkpOwogICAgaWYgKHRlbXBsYXRlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZSA9IG5ldyBUZW1wbGF0ZShyZXN1bHQsIHJlc3VsdC5nZXRUZW1wbGF0ZUVsZW1lbnQoKSk7CiAgICAgICAgdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuc2V0KGtleSwgdGVtcGxhdGUpOwogICAgfQogICAgdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuc2V0KHJlc3VsdC5zdHJpbmdzLCB0ZW1wbGF0ZSk7CiAgICByZXR1cm4gdGVtcGxhdGU7Cn0KY29uc3QgdGVtcGxhdGVDYWNoZXMgPSBuZXcgTWFwKCk7CmNvbnN0IHBhcnRzID0gbmV3IFdlYWtNYXAoKTsKY29uc3QgcmVuZGVyID0gKHJlc3VsdCwgY29udGFpbmVyLCBvcHRpb25zKT0+ewogICAgbGV0IHBhcnQgPSBwYXJ0cy5nZXQoY29udGFpbmVyKTsKICAgIGlmIChwYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICByZW1vdmVOb2Rlcyhjb250YWluZXIsIGNvbnRhaW5lci5maXJzdENoaWxkKTsKICAgICAgICBwYXJ0cy5zZXQoY29udGFpbmVyLCBwYXJ0ID0gbmV3IE5vZGVQYXJ0KE9iamVjdC5hc3NpZ24oewogICAgICAgICAgICB0ZW1wbGF0ZUZhY3RvcnkKICAgICAgICB9LCBvcHRpb25zKSkpOwogICAgICAgIHBhcnQuYXBwZW5kSW50byhjb250YWluZXIpOwogICAgfQogICAgcGFydC5zZXRWYWx1ZShyZXN1bHQpOwogICAgcGFydC5jb21taXQoKTsKfTsKaWYgKHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiKSB7CiAgICAod2luZG93WyJsaXRIdG1sVmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRIdG1sVmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMS40LjEiKTsKfQpjb25zdCBodG1sID0gKHN0cmluZ3MsIC4uLnZhbHVlcyk9Pm5ldyBUZW1wbGF0ZVJlc3VsdChzdHJpbmdzLCB2YWx1ZXMsICJodG1sIiwgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKQo7CmNvbnN0IHN2ZyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgU1ZHVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAic3ZnIiwgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKQo7CnZhciBfYTsKd2luZG93LkpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkgPSAocHJvcCwgX29iaik9PnByb3AKOwpjb25zdCBkZWZhdWx0Q29udmVydGVyID0gewogICAgdG9BdHRyaWJ1dGUgKHZhbHVlLCB0eXBlKSB7CiAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICBjYXNlIEJvb2xlYW46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPyAiIiA6IG51bGw7CiAgICAgICAgICAgIGNhc2UgT2JqZWN0OgogICAgICAgICAgICBjYXNlIEFycmF5OgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09IG51bGwgPyB2YWx1ZSA6IEpTT04uc3RyaW5naWZ5KHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSwKICAgIGZyb21BdHRyaWJ1dGUgKHZhbHVlLCB0eXBlKSB7CiAgICAgICAgc3dpdGNoKHR5cGUpewogICAgICAgICAgICBjYXNlIEJvb2xlYW46CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgIT09IG51bGw7CiAgICAgICAgICAgIGNhc2UgTnVtYmVyOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID09PSBudWxsID8gbnVsbCA6IE51bWJlcih2YWx1ZSk7CiAgICAgICAgICAgIGNhc2UgT2JqZWN0OgogICAgICAgICAgICBjYXNlIEFycmF5OgogICAgICAgICAgICAgICAgcmV0dXJuIEpTT04ucGFyc2UodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9Cn07CmNvbnN0IG5vdEVxdWFsID0gKHZhbHVlLCBvbGQpPT57CiAgICByZXR1cm4gb2xkICE9PSB2YWx1ZSAmJiAob2xkID09PSBvbGQgfHwgdmFsdWUgPT09IHZhbHVlKTsKfTsKY29uc3QgZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24gPSB7CiAgICBhdHRyaWJ1dGU6IHRydWUsCiAgICB0eXBlOiBTdHJpbmcsCiAgICBjb252ZXJ0ZXI6IGRlZmF1bHRDb252ZXJ0ZXIsCiAgICByZWZsZWN0OiBmYWxzZSwKICAgIGhhc0NoYW5nZWQ6IG5vdEVxdWFsCn07CmNvbnN0IFNUQVRFX0hBU19VUERBVEVEID0gMTsKY29uc3QgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRCA9IDEgPDwgMjsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUgPSAxIDw8IDM7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFkgPSAxIDw8IDQ7CmNvbnN0IGZpbmFsaXplZCA9ICJmaW5hbGl6ZWQiOwpjbGFzcyBVcGRhdGluZ0VsZW1lbnQgZXh0ZW5kcyBIVE1MRWxlbWVudCB7CiAgICBjb25zdHJ1Y3RvcigpewogICAgICAgIHN1cGVyKCk7CiAgICAgICAgdGhpcy5pbml0aWFsaXplKCk7CiAgICB9CiAgICBzdGF0aWMgZ2V0IG9ic2VydmVkQXR0cmlidXRlcygpIHsKICAgICAgICB0aGlzLmZpbmFsaXplKCk7CiAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IFtdOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5mb3JFYWNoKCh2LCBwKT0+ewogICAgICAgICAgICBjb25zdCBhdHRyID0gdGhpcy5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KHAsIHYpOwogICAgICAgICAgICBpZiAoYXR0ciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwLnNldChhdHRyLCBwKTsKICAgICAgICAgICAgICAgIGF0dHJpYnV0ZXMucHVzaChhdHRyKTsKICAgICAgICAgICAgfQogICAgICAgIH0pOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGVzOwogICAgfQogICAgc3RhdGljIF9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKSB7CiAgICAgICAgaWYgKCF0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9jbGFzc1Byb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICBjb25zdCBzdXBlclByb3BlcnRpZXMgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcykuX2NsYXNzUHJvcGVydGllczsKICAgICAgICAgICAgaWYgKHN1cGVyUHJvcGVydGllcyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBzdXBlclByb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQoaywgdikKICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgY3JlYXRlUHJvcGVydHkobmFtZSwgb3B0aW9ucyA9IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uKSB7CiAgICAgICAgdGhpcy5fZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCk7CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChuYW1lLCBvcHRpb25zKTsKICAgICAgICBpZiAob3B0aW9ucy5ub0FjY2Vzc29yIHx8IHRoaXMucHJvdG90eXBlLmhhc093blByb3BlcnR5KG5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3Qga2V5ID0gdHlwZW9mIG5hbWUgPT09ICJzeW1ib2wiID8gU3ltYm9sKCkgOiBgX18ke25hbWV9YDsKICAgICAgICBjb25zdCBkZXNjcmlwdG9yID0gdGhpcy5nZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKTsKICAgICAgICBpZiAoZGVzY3JpcHRvciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0aGlzLnByb3RvdHlwZSwgbmFtZSwgZGVzY3JpcHRvcik7CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICBnZXQgKCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHRoaXNba2V5XTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgc2V0ICh2YWx1ZSkgewogICAgICAgICAgICAgICAgY29uc3Qgb2xkVmFsdWUgPSB0aGlzW25hbWVdOwogICAgICAgICAgICAgICAgdGhpc1trZXldID0gdmFsdWU7CiAgICAgICAgICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSwgb3B0aW9ucyk7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGNvbmZpZ3VyYWJsZTogdHJ1ZSwKICAgICAgICAgICAgZW51bWVyYWJsZTogdHJ1ZQogICAgICAgIH07CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpIHsKICAgICAgICByZXR1cm4gdGhpcy5fY2xhc3NQcm9wZXJ0aWVzICYmIHRoaXMuX2NsYXNzUHJvcGVydGllcy5nZXQobmFtZSkgfHwgZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb247CiAgICB9CiAgICBzdGF0aWMgZmluYWxpemUoKSB7CiAgICAgICAgY29uc3Qgc3VwZXJDdG9yID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpOwogICAgICAgIGlmICghc3VwZXJDdG9yLmhhc093blByb3BlcnR5KGZpbmFsaXplZCkpIHsKICAgICAgICAgICAgc3VwZXJDdG9yLmZpbmFsaXplKCk7CiAgICAgICAgfQogICAgICAgIHRoaXNbZmluYWxpemVkXSA9IHRydWU7CiAgICAgICAgdGhpcy5fZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCk7CiAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcCA9IG5ldyBNYXAoKTsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJwcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIGNvbnN0IHByb3BzMSA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wczEpLAogICAgICAgICAgICAgICAgLi4udHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHByb3BzMSkgOiBbXQogICAgICAgICAgICBdOwogICAgICAgICAgICBmb3IgKGNvbnN0IHAgb2YgcHJvcEtleXMpewogICAgICAgICAgICAgICAgdGhpcy5jcmVhdGVQcm9wZXJ0eShwLCBwcm9wczFbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHt9CiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkLCB2YWx1ZSkgewogICAgICAgIGlmIChvbGQgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9wcm9wZXJ0eVRvQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBhdHRyID0gY3Rvci5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgYXR0clZhbHVlID0gY3Rvci5fcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0clZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgIH0KICAgIH0KICAgIF9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IGN0b3IuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuZ2V0KG5hbWUpOwogICAgICAgIGlmIChwcm9wTmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhwcm9wTmFtZSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSwgb3B0aW9ucykgewogICAgICAgIGxldCBzaG91bGRSZXF1ZXN0VXBkYXRlID0gdHJ1ZTsKICAgICAgICBpZiAobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhuYW1lKTsKICAgICAgICAgICAgaWYgKGN0b3IuX3ZhbHVlSGFzQ2hhbmdlZCh0aGlzW25hbWVdLCBvbGRWYWx1ZSwgb3B0aW9ucy5oYXNDaGFuZ2VkKSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5oYXMobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5zZXQobmFtZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdHJ1ZSAmJiAhKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlICYmIHNob3VsZFJlcXVlc3RVcGRhdGUpIHsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUHJvbWlzZSA9IHRoaXMuX2VucXVldWVVcGRhdGUoKTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlKG5hbWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUpOwogICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUNvbXBsZXRlOwogICAgfQogICAgYXN5bmMgX2VucXVldWVVcGRhdGUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucGVyZm9ybVVwZGF0ZSgpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlOwogICAgfQogICAgZ2V0IF9oYXNSZXF1ZXN0ZWRVcGRhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCBoYXNVcGRhdGVkKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIDE7CiAgICB9CiAgICBwZXJmb3JtVXBkYXRlKCkgewogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICB0aGlzLl9hcHBseUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIH0KICAgICAgICBsZXQgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgY29uc3QgY2hhbmdlZFByb3BlcnRpZXMgPSB0aGlzLl9jaGFuZ2VkUHJvcGVydGllczsKICAgICAgICB0cnkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0aGlzLnNob3VsZFVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghKHRoaXMuX3VwZGF0ZVN0YXRlICYgMSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9IQVNfVVBEQVRFRDsKICAgICAgICAgICAgICAgIHRoaXMuZmlyc3RVcGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgIH0KICAgIH0KICAgIF9tYXJrVXBkYXRlZCgpIHsKICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgdXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBfZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIGdldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgfQogICAgc2hvdWxkVXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgdXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyAhPT0gdm9pZCAwICYmIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9wcm9wZXJ0eVRvQXR0cmlidXRlKGssIHRoaXNba10sIHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgfQogICAgdXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHt9CiAgICBmaXJzdFVwZGF0ZWQoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7fQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHt9OwpjbGFzcyBMaXRFbGVtZW50IGV4dGVuZHMgVXBkYXRpbmdFbGVtZW50IHsKICAgIHN0YXRpYyBnZXRTdHlsZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3R5bGVzOwogICAgfQogICAgc3RhdGljIF9nZXRVbmlxdWVTdHlsZXMoKSB7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX3N0eWxlcyIsIHRoaXMpKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHVzZXJTdHlsZXMgPSB0aGlzLmdldFN0eWxlcygpOwogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHVzZXJTdHlsZXMpKSB7CiAgICAgICAgICAgIGNvbnN0IGFkZFN0eWxlcyA9IChzdHlsZXMyLCBzZXQyKT0+c3R5bGVzMi5yZWR1Y2VSaWdodCgoc2V0Mywgcyk9PkFycmF5LmlzQXJyYXkocykgPyBhZGRTdHlsZXMocywgc2V0MykgOiAoc2V0My5hZGQocyksIHNldDMpCiAgICAgICAgICAgICAgICAsIHNldDIpCiAgICAgICAgICAgIDsKICAgICAgICAgICAgY29uc3Qgc2V0ID0gYWRkU3R5bGVzKHVzZXJTdHlsZXMsIG5ldyBTZXQoKSk7CiAgICAgICAgICAgIGNvbnN0IHN0eWxlcyA9IFtdOwogICAgICAgICAgICBzZXQuZm9yRWFjaCgodik9PnN0eWxlcy51bnNoaWZ0KHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHN0eWxlczsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSB1c2VyU3R5bGVzID09PSB2b2lkIDAgPyBbXSA6IFsKICAgICAgICAgICAgICAgIHVzZXJTdHlsZXMKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgdGhpcy5fc3R5bGVzID0gdGhpcy5fc3R5bGVzLm1hcCgocyk9PnsKICAgICAgICAgICAgaWYgKHMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ICYmICFzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNzc1RleHQgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChzLmNzc1J1bGVzKS5yZWR1Y2UoKGNzczIsIHJ1bGUpPT5jc3MyICsgcnVsZS5jc3NUZXh0CiAgICAgICAgICAgICAgICAsICIiKTsKICAgICAgICAgICAgICAgIHJldHVybiB1bnNhZmVDU1MoY3NzVGV4dCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHM7CiAgICAgICAgfSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHN1cGVyLmluaXRpYWxpemUoKTsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9nZXRVbmlxdWVTdHlsZXMoKTsKICAgICAgICB0aGlzLnJlbmRlclJvb3QgPSB0aGlzLmNyZWF0ZVJlbmRlclJvb3QoKTsKICAgICAgICBpZiAod2luZG93LlNoYWRvd1Jvb3QgJiYgdGhpcy5yZW5kZXJSb290IGluc3RhbmNlb2Ygd2luZG93LlNoYWRvd1Jvb3QpIHsKICAgICAgICAgICAgdGhpcy5hZG9wdFN0eWxlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNyZWF0ZVJlbmRlclJvb3QoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYXR0YWNoU2hhZG93KHRoaXMuY29uc3RydWN0b3Iuc2hhZG93Um9vdE9wdGlvbnMpOwogICAgfQogICAgYWRvcHRTdHlsZXMoKSB7CiAgICAgICAgY29uc3Qgc3R5bGVzID0gdGhpcy5jb25zdHJ1Y3Rvci5fc3R5bGVzOwogICAgICAgIGlmIChzdHlsZXMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwICYmICF3aW5kb3cuU2hhZHlDU1MubmF0aXZlU2hhZG93KSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5TY29waW5nU2hpbS5wcmVwYXJlQWRvcHRlZENzc1RleHQoc3R5bGVzLm1hcCgocyk9PnMuY3NzVGV4dAogICAgICAgICAgICApLCB0aGlzLmxvY2FsTmFtZSk7CiAgICAgICAgfSBlbHNlIGlmIChzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFkb3B0ZWRTdHlsZVNoZWV0cyA9IHN0eWxlcy5tYXAoKHMpPT5zIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCA/IHMgOiBzLnN0eWxlU2hlZXQKICAgICAgICAgICAgKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMgPSB0cnVlOwogICAgICAgIH0KICAgIH0KICAgIGNvbm5lY3RlZENhbGxiYWNrKCkgewogICAgICAgIHN1cGVyLmNvbm5lY3RlZENhbGxiYWNrKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzVXBkYXRlZCAmJiB3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCkgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1Muc3R5bGVFbGVtZW50KHRoaXMpOwogICAgICAgIH0KICAgIH0KICAgIHVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIGNvbnN0IHRlbXBsYXRlUmVzdWx0ID0gdGhpcy5yZW5kZXIoKTsKICAgICAgICBzdXBlci51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgIGlmICh0ZW1wbGF0ZVJlc3VsdCAhPT0gcmVuZGVyTm90SW1wbGVtZW50ZWQpIHsKICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5yZW5kZXIodGVtcGxhdGVSZXN1bHQsIHRoaXMucmVuZGVyUm9vdCwgewogICAgICAgICAgICAgICAgc2NvcGVOYW1lOiB0aGlzLmxvY2FsTmFtZSwKICAgICAgICAgICAgICAgIGV2ZW50Q29udGV4dDogdGhpcwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fc3R5bGVzLmZvckVhY2goKHMpPT57CiAgICAgICAgICAgICAgICBjb25zdCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInN0eWxlIik7CiAgICAgICAgICAgICAgICBzdHlsZS50ZXh0Q29udGVudCA9IHMuY3NzVGV4dDsKICAgICAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hcHBlbmRDaGlsZChzdHlsZSk7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gcmVuZGVyTm90SW1wbGVtZW50ZWQ7CiAgICB9Cn0KTGl0RWxlbWVudFsiZmluYWxpemVkIl0gPSB0cnVlOwpMaXRFbGVtZW50LnJlbmRlciA9IHJlbmRlcjsKTGl0RWxlbWVudC5zaGFkb3dSb290T3B0aW9ucyA9IHsKICAgIG1vZGU6ICJvcGVuIgp9OwpjbGFzcyBUaGVtZSB7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMjAwSGV4ID0gJyM2OWI3ZmYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjMwMEhleCA9ICcjMDA4OEZGJzsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3I5MDBIZXggPSAnIzAwNWNjYic7CiAgICBzdGF0aWMgYmFja2dyb3VuZENvbG9ySGV4ID0gJyMxMjEyMTInOwogICAgc3RhdGljIHRleHRDb2xvckhleCA9ICcjZWJlYmViJzsKICAgIHN0YXRpYyB0ZXh0Q29sb3JTZWNvbmRhcnlIZXggPSAnIzg4ODg4OCc7CiAgICBzdGF0aWMgc2Fuc1NlcmlmRm9udEZhbWlseSA9ICctYXBwbGUtc3lzdGVtLCBCbGlua01hY1N5c3RlbUZvbnQsIGF2ZW5pciBuZXh0LCBhdmVuaXIsIGhlbHZldGljYSBuZXVlLCBoZWx2ZXRpY2EsIFVidW50dSwgcm9ib3RvLCBub3RvLCBzZWdvZSB1aSwgYXJpYWwsIHNhbnMtc2VyaWYnOwogICAgc3RhdGljIG1vbm9zcGFjZUZvbnRGYW1pbHkgPSAnTWVubG8sICJTRiBNb25vIiwgIkFuZGFsZSBNb25vIiwgIlJvYm90byBNb25vIiwgTW9uYWNvLCBtb25vc3BhY2UnOwp9CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFID0gJ2h0dHBzOi8vcG9kY2FzdGluZGV4Lm9yZy9uYW1lc3BhY2UvMS4wJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfQUxUID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0tOT1dOX01JU1NQRUxMSU5HID0gJ2h0dHBzOi8vcG9kY2FzdGluZGV4Lm9yZy9uYW1lc3BhY2UvMS4wLyc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUyA9IFsKICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFLAogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfQUxULAogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcKXTsKY29uc3QgUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUyA9IG5ldyBTZXQoKTsKZnVuY3Rpb24gX3BvZGNhc3RJbmRleChuYW1lLCBrbm93biA9IHRydWUpIHsKICAgIGlmIChrbm93bikgUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUy5hZGQobmFtZSk7CiAgICByZXR1cm4gUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIG5hbWVzcGFjZVVyaTogdgogICAgICAgIH0pCiAgICApOwp9CmNvbnN0IE1FRElBX1JTU19OQU1FU1BBQ0UgPSAnaHR0cDovL3NlYXJjaC55YWhvby5jb20vbXJzcy8nOwpmdW5jdGlvbiBfbWVkaWFSc3MobmFtZSkgewogICAgcmV0dXJuIHsKICAgICAgICBuYW1lLAogICAgICAgIG5hbWVzcGFjZVVyaTogTUVESUFfUlNTX05BTUVTUEFDRQogICAgfTsKfQpjbGFzcyBRbmFtZXMgewogICAgc3RhdGljIFBvZGNhc3RJbmRleCA9IHsKICAgICAgICBOQU1FU1BBQ0VTOiBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMsCiAgICAgICAgS05PV05fTUlTU1BFTExFRF9OQU1FU1BBQ0VTOiBbCiAgICAgICAgICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0tOT1dOX01JU1NQRUxMSU5HCiAgICAgICAgXSwKICAgICAgICBnZXQgS05PV05fTkFNRVMgKCkgewogICAgICAgICAgICByZXR1cm4gUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUzsKICAgICAgICB9LAogICAgICAgIG9mOiAobmFtZSk9Pl9wb2RjYXN0SW5kZXgobmFtZSwgZmFsc2UpCiAgICAgICAgLAogICAgICAgIGFsdGVybmF0ZUVuY2xvc3VyZTogX3BvZGNhc3RJbmRleCgnYWx0ZXJuYXRlRW5jbG9zdXJlJyksCiAgICAgICAgY2hhcHRlcnM6IF9wb2RjYXN0SW5kZXgoJ2NoYXB0ZXJzJyksCiAgICAgICAgZXBpc29kZTogX3BvZGNhc3RJbmRleCgnZXBpc29kZScpLAogICAgICAgIGZ1bmRpbmc6IF9wb2RjYXN0SW5kZXgoJ2Z1bmRpbmcnKSwKICAgICAgICBndWlkOiBfcG9kY2FzdEluZGV4KCdndWlkJyksCiAgICAgICAgaGl2ZUFjY291bnQ6IF9wb2RjYXN0SW5kZXgoJ2hpdmVBY2NvdW50JyksCiAgICAgICAgaW1hZ2VzOiBfcG9kY2FzdEluZGV4KCdpbWFnZXMnKSwKICAgICAgICBpbnRlZ3JpdHk6IF9wb2RjYXN0SW5kZXgoJ2ludGVncml0eScpLAogICAgICAgIGxpY2Vuc2U6IF9wb2RjYXN0SW5kZXgoJ2xpY2Vuc2UnKSwKICAgICAgICBsb2NhdGlvbjogX3BvZGNhc3RJbmRleCgnbG9jYXRpb24nKSwKICAgICAgICBsb2NrZWQ6IF9wb2RjYXN0SW5kZXgoJ2xvY2tlZCcpLAogICAgICAgIG1lZGl1bTogX3BvZGNhc3RJbmRleCgnbWVkaXVtJyksCiAgICAgICAgcGVyc29uOiBfcG9kY2FzdEluZGV4KCdwZXJzb24nKSwKICAgICAgICBwb2RwaW5nOiBfcG9kY2FzdEluZGV4KCdwb2RwaW5nJyksCiAgICAgICAgc2Vhc29uOiBfcG9kY2FzdEluZGV4KCdzZWFzb24nKSwKICAgICAgICBzb2NpYWw6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbCcpLAogICAgICAgIHNvY2lhbEludGVyYWN0OiBfcG9kY2FzdEluZGV4KCdzb2NpYWxJbnRlcmFjdCcpLAogICAgICAgIHNvY2lhbFNpZ25VcDogX3BvZGNhc3RJbmRleCgnc29jaWFsU2lnblVwJyksCiAgICAgICAgc291bmRiaXRlOiBfcG9kY2FzdEluZGV4KCdzb3VuZGJpdGUnKSwKICAgICAgICBzb3VyY2U6IF9wb2RjYXN0SW5kZXgoJ3NvdXJjZScpLAogICAgICAgIHRyYWlsZXI6IF9wb2RjYXN0SW5kZXgoJ3RyYWlsZXInKSwKICAgICAgICB0cmFuc2NyaXB0OiBfcG9kY2FzdEluZGV4KCd0cmFuc2NyaXB0JyksCiAgICAgICAgdmFsdWU6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlJyksCiAgICAgICAgdmFsdWVSZWNpcGllbnQ6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlUmVjaXBpZW50JykKICAgIH07CiAgICBzdGF0aWMgTWVkaWFSc3MgPSB7CiAgICAgICAgTkFNRVNQQUNFOiBNRURJQV9SU1NfTkFNRVNQQUNFLAogICAgICAgIG9mOiAobmFtZSk9Pl9tZWRpYVJzcyhuYW1lKQogICAgICAgICwKICAgICAgICBjb250ZW50OiBfbWVkaWFSc3MoJ2NvbnRlbnQnKQogICAgfTsKfQpmdW5jdGlvbiBjaGVja01hdGNoZXMobmFtZSwgdmFsdWUsIHBhdHRlcm4pIHsKICAgIGlmICghcGF0dGVybi50ZXN0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKICAgIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBjaGVja0VxdWFsKG5hbWUsIHZhbHVlLCBleHBlY3RlZCkgewogICAgaWYgKHZhbHVlICE9PSBleHBlY3RlZCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX0sIGV4cGVjdGVkICR7ZXhwZWN0ZWR9YCk7Cn0KZnVuY3Rpb24gY2hlY2tUcnVlKG5hbWUsIHZhbHVlLCB0ZXN0KSB7CiAgICBpZiAoIXRlc3QpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9YCk7Cn0KZnVuY3Rpb24gaXNTdHJpbmdSZWNvcmQob2JqKSB7CiAgICByZXR1cm4gdHlwZW9mIG9iaiA9PT0gJ29iamVjdCcgJiYgb2JqICE9PSBudWxsICYmICFBcnJheS5pc0FycmF5KG9iaikgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBPYmplY3Q7Cn0KY29uc3QgaGV4UmVnZXggPSAvXlstK10/MHhbYS1mQS1GMC05XSskLzsKY29uc3QgbnVtUmVnZXggPSAvXihbXC1cK10pPygwKikoXC5bMC05XSsoW2VFXVwtP1swLTldKyk/fFswLTldKyhcLlswLTldKyhbZUVdXC0/WzAtOV0rKT8pPykkLzsKY29uc3QgY29uc2lkZXIgPSB7CiAgICBoZXg6IHRydWUsCiAgICBsZWFkaW5nWmVyb3M6IHRydWUsCiAgICBkZWNpbWFsUG9pbnQ6ICIuIgp9OwpmdW5jdGlvbiB0b051bWJlcihzdHIsIG9wdGlvbnMgPSB7fSkgewogICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oe30sIGNvbnNpZGVyLCBvcHRpb25zKTsKICAgIGlmICghc3RyIHx8IHR5cGVvZiBzdHIgIT09ICJzdHJpbmciKSByZXR1cm4gc3RyOwogICAgbGV0IHRyaW1tZWRTdHIgPSBzdHIudHJpbSgpOwogICAgaWYgKG9wdGlvbnMuc2tpcExpa2UgIT09IHZvaWQgMCAmJiBvcHRpb25zLnNraXBMaWtlLnRlc3QodHJpbW1lZFN0cikpIHJldHVybiBzdHI7CiAgICBlbHNlIGlmIChvcHRpb25zLmhleCAmJiBoZXhSZWdleC50ZXN0KHRyaW1tZWRTdHIpKSB7CiAgICAgICAgcmV0dXJuIE51bWJlci5wYXJzZUludCh0cmltbWVkU3RyLCAxNik7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG1hdGNoID0gbnVtUmVnZXguZXhlYyh0cmltbWVkU3RyKTsKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbWF0Y2hbMV07CiAgICAgICAgICAgIGNvbnN0IGxlYWRpbmdaZXJvcyA9IG1hdGNoWzJdOwogICAgICAgICAgICBjb25zdCBudW0gPSBtYXRjaFszXTsKICAgICAgICAgICAgbWF0Y2hbNF0gfHwgbWF0Y2hbNl07CiAgICAgICAgICAgIGlmIChsZWFkaW5nWmVyb3MubGVuZ3RoID09PSAxICYmIG51bVswXSA9PT0gIi4iKSByZXR1cm4gTnVtYmVyKHN0cik7CiAgICAgICAgICAgIGVsc2UgaWYgKCFvcHRpb25zLmxlYWRpbmdaZXJvcyAmJiBsZWFkaW5nWmVyb3MubGVuZ3RoID4gMCkgcmV0dXJuIHN0cjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gTnVtYmVyKHRyaW1tZWRTdHIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgfQogICAgfQp9CnZhciBzdHJudW0gPSB0b051bWJlcjsKZnVuY3Rpb24gY3JlYXRlQ29tbW9uanNNb2R1bGUoZm4sIGJhc2VkaXIsIG1vZHVsZSkgewogICAgcmV0dXJuIG1vZHVsZSA9IHsKICAgICAgICBwYXRoOiBiYXNlZGlyLAogICAgICAgIGV4cG9ydHM6IHt9LAogICAgICAgIHJlcXVpcmU6IGZ1bmN0aW9uKHBhdGgsIGJhc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbW1vbmpzUmVxdWlyZShwYXRoLCBiYXNlID09PSB2b2lkIDAgfHwgYmFzZSA9PT0gbnVsbCA/IG1vZHVsZS5wYXRoIDogYmFzZSk7CiAgICAgICAgfQogICAgfSwgZm4obW9kdWxlLCBtb2R1bGUuZXhwb3J0cyksIG1vZHVsZS5leHBvcnRzOwp9CmZ1bmN0aW9uIGNvbW1vbmpzUmVxdWlyZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiRHluYW1pYyByZXF1aXJlcyBhcmUgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgYnkgQHJvbGx1cC9wbHVnaW4tY29tbW9uanMiKTsKfQp2YXIgdXRpbCA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewogICAgY29uc3QgbmFtZVN0YXJ0Q2hhciA9ICI6QS1aYS16X1xcdTAwQzAtXFx1MDBENlxcdTAwRDgtXFx1MDBGNlxcdTAwRjgtXFx1MDJGRlxcdTAzNzAtXFx1MDM3RFxcdTAzN0YtXFx1MUZGRlxcdTIwMEMtXFx1MjAwRFxcdTIwNzAtXFx1MjE4RlxcdTJDMDAtXFx1MkZFRlxcdTMwMDEtXFx1RDdGRlxcdUY5MDAtXFx1RkRDRlxcdUZERjAtXFx1RkZGRCI7CiAgICBjb25zdCBuYW1lQ2hhciA9IG5hbWVTdGFydENoYXIgKyAiXFwtLlxcZFxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgY29uc3QgbmFtZVJlZ2V4cCA9ICJbIiArIG5hbWVTdGFydENoYXIgKyAiXVsiICsgbmFtZUNoYXIgKyAiXSoiOwogICAgY29uc3QgcmVnZXhOYW1lID0gbmV3IFJlZ0V4cCgiXiIgKyBuYW1lUmVnZXhwICsgIiQiKTsKICAgIGNvbnN0IGdldEFsbE1hdGNoZXMgPSBmdW5jdGlvbihzdHJpbmcsIHJlZ2V4KSB7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IFtdOwogICAgICAgIGxldCBtYXRjaCA9IHJlZ2V4LmV4ZWMoc3RyaW5nKTsKICAgICAgICB3aGlsZShtYXRjaCl7CiAgICAgICAgICAgIGNvbnN0IGFsbG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgYWxsbWF0Y2hlcy5zdGFydEluZGV4ID0gcmVnZXgubGFzdEluZGV4IC0gbWF0Y2hbMF0ubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBsZW4gPSBtYXRjaC5sZW5ndGg7CiAgICAgICAgICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxlbjsgaW5kZXgrKyl7CiAgICAgICAgICAgICAgICBhbGxtYXRjaGVzLnB1c2gobWF0Y2hbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaGVzLnB1c2goYWxsbWF0Y2hlcyk7CiAgICAgICAgICAgIG1hdGNoID0gcmVnZXguZXhlYyhzdHJpbmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH07CiAgICBjb25zdCBpc05hbWUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICBjb25zdCBtYXRjaCA9IHJlZ2V4TmFtZS5leGVjKHN0cmluZyk7CiAgICAgICAgcmV0dXJuICEobWF0Y2ggPT09IG51bGwgfHwgdHlwZW9mIG1hdGNoID09PSAidW5kZWZpbmVkIik7CiAgICB9OwogICAgZXhwb3J0cy5pc0V4aXN0ID0gZnVuY3Rpb24odikgewogICAgICAgIHJldHVybiB0eXBlb2YgdiAhPT0gInVuZGVmaW5lZCI7CiAgICB9OwogICAgZXhwb3J0cy5pc0VtcHR5T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubGVuZ3RoID09PSAwOwogICAgfTsKICAgIGV4cG9ydHMubWVyZ2UgPSBmdW5jdGlvbih0YXJnZXQsIGEsIGFycmF5TW9kZSkgewogICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhKTsKICAgICAgICAgICAgY29uc3QgbGVuID0ga2V5cy5sZW5ndGg7CiAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlNb2RlID09PSAic3RyaWN0IikgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXlzW2ldXSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgYVtrZXlzW2ldXQogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXlzW2ldXSA9IGFba2V5c1tpXV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5nZXRWYWx1ZSA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICBpZiAoZXhwb3J0cy5pc0V4aXN0KHYpKSB7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5idWlsZE9wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zLCBkZWZhdWx0T3B0aW9uczIsIHByb3BzMikgewogICAgICAgIGxldCBuZXdPcHRpb25zID0ge307CiAgICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0T3B0aW9uczI7CiAgICAgICAgfQogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBwcm9wczIubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAob3B0aW9uc1twcm9wczJbaV1dICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG5ld09wdGlvbnNbcHJvcHMyW2ldXSA9IG9wdGlvbnNbcHJvcHMyW2ldXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld09wdGlvbnNbcHJvcHMyW2ldXSA9IGRlZmF1bHRPcHRpb25zMltwcm9wczJbaV1dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdPcHRpb25zOwogICAgfTsKICAgIGV4cG9ydHMuaXNUYWdOYW1lSW5BcnJheU1vZGUgPSBmdW5jdGlvbih0YWdOYW1lLCBhcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpIHsKICAgICAgICBpZiAoYXJyYXlNb2RlID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChhcnJheU1vZGUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuIGFycmF5TW9kZS50ZXN0KHRhZ05hbWUpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFycmF5TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gISFhcnJheU1vZGUodGFnTmFtZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcnJheU1vZGUgPT09ICJzdHJpY3QiOwogICAgfTsKICAgIGV4cG9ydHMuaXNOYW1lID0gaXNOYW1lOwogICAgZXhwb3J0cy5nZXRBbGxNYXRjaGVzID0gZ2V0QWxsTWF0Y2hlczsKICAgIGV4cG9ydHMubmFtZVJlZ2V4cCA9IG5hbWVSZWdleHA7Cn0pOwpjb25zdCBjb252ZXJ0VG9Kc29uID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucywgcGFyZW50VGFnTmFtZSkgewogICAgY29uc3Qgak9iaiA9IHt9OwogICAgaWYgKCFvcHRpb25zLmFsd2F5c0NyZWF0ZVRleHROb2RlICYmICghbm9kZS5jaGlsZCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5jaGlsZCkpICYmICghbm9kZS5hdHRyc01hcCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5hdHRyc01hcCkpKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuaXNFeGlzdChub2RlLnZhbCkgPyBub2RlLnZhbCA6ICIiOwogICAgfQogICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkgJiYgISh0eXBlb2Ygbm9kZS52YWwgPT09ICJzdHJpbmciICYmIChub2RlLnZhbCA9PT0gIiIgfHwgbm9kZS52YWwgPT09IG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIpKSkgewogICAgICAgIGNvbnN0IGFzQXJyYXkgPSB1dGlsLmlzVGFnTmFtZUluQXJyYXlNb2RlKG5vZGUudGFnbmFtZSwgb3B0aW9ucy5hcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgIGpPYmpbb3B0aW9ucy50ZXh0Tm9kZU5hbWVdID0gYXNBcnJheSA/IFsKICAgICAgICAgICAgbm9kZS52YWwKICAgICAgICBdIDogbm9kZS52YWw7CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXAsIG9wdGlvbnMuYXJyYXlNb2RlKTsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhub2RlLmNoaWxkKTsKICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGtleXMubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBjb25zdCB0YWdOYW1lID0ga2V5c1tpbmRleF07CiAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnTmFtZV0gJiYgbm9kZS5jaGlsZFt0YWdOYW1lXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBbXTsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWdOYW1lXSl7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWdOYW1lXS5oYXNPd25Qcm9wZXJ0eSh0YWcpKSB7CiAgICAgICAgICAgICAgICAgICAgak9ialt0YWdOYW1lXS5wdXNoKGNvbnZlcnRUb0pzb24obm9kZS5jaGlsZFt0YWdOYW1lXVt0YWddLCBvcHRpb25zLCB0YWdOYW1lKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBjb252ZXJ0VG9Kc29uKG5vZGUuY2hpbGRbdGFnTmFtZV1bMF0sIG9wdGlvbnMsIHRhZ05hbWUpOwogICAgICAgICAgICBjb25zdCBhc0FycmF5ID0gb3B0aW9ucy5hcnJheU1vZGUgPT09IHRydWUgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgfHwgdXRpbC5pc1RhZ05hbWVJbkFycmF5TW9kZSh0YWdOYW1lLCBvcHRpb25zLmFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBhc0FycmF5ID8gWwogICAgICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICAgIF0gOiByZXN1bHQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGpPYmo7Cn07CnZhciBjb252ZXJ0VG9Kc29uXzEgPSBjb252ZXJ0VG9Kc29uOwp2YXIgbm9kZTJqc29uID0gewogICAgY29udmVydFRvSnNvbjogY29udmVydFRvSnNvbl8xCn07CnZhciB4bWxOb2RlID0gZnVuY3Rpb24odGFnbmFtZSwgcGFyZW50LCB2YWwpIHsKICAgIHRoaXMudGFnbmFtZSA9IHRhZ25hbWU7CiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgIHRoaXMuY2hpbGQgPSB7fTsKICAgIHRoaXMuYXR0cnNNYXAgPSB7fTsKICAgIHRoaXMudmFsID0gdmFsOwogICAgdGhpcy5hZGRDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXSkpIHsKICAgICAgICAgICAgdGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXS5wdXNoKGNoaWxkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdID0gWwogICAgICAgICAgICAgICAgY2hpbGQKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICB9Owp9Owpjb25zdCBidWlsZE9wdGlvbnMgPSB1dGlsLmJ1aWxkT3B0aW9uczsKIjwoKCFcXFtDREFUQVxcWyhbXFxzXFxTXSo/KShdXT4pKXwoKE5BTUU6KT8oTkFNRSkpKFtePl0qKT58KChcXC8pKE5BTUUpXFxzKj4pKShbXjxdKikiLnJlcGxhY2UoL05BTUUvZywgdXRpbC5uYW1lUmVnZXhwKTsKaWYgKCFOdW1iZXIucGFyc2VJbnQgJiYgd2luZG93LnBhcnNlSW50KSB7CiAgICBOdW1iZXIucGFyc2VJbnQgPSB3aW5kb3cucGFyc2VJbnQ7Cn0KaWYgKCFOdW1iZXIucGFyc2VGbG9hdCAmJiB3aW5kb3cucGFyc2VGbG9hdCkgewogICAgTnVtYmVyLnBhcnNlRmxvYXQgPSB3aW5kb3cucGFyc2VGbG9hdDsKfQpjb25zdCBkZWZhdWx0T3B0aW9ucyA9IHsKICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICJAXyIsCiAgICBhdHRyTm9kZU5hbWU6IGZhbHNlLAogICAgdGV4dE5vZGVOYW1lOiAiI3RleHQiLAogICAgaWdub3JlQXR0cmlidXRlczogdHJ1ZSwKICAgIGlnbm9yZU5hbWVTcGFjZTogZmFsc2UsCiAgICBhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzOiBmYWxzZSwKICAgIHBhcnNlTm9kZVZhbHVlOiB0cnVlLAogICAgcGFyc2VBdHRyaWJ1dGVWYWx1ZTogZmFsc2UsCiAgICBhcnJheU1vZGU6IGZhbHNlLAogICAgdHJpbVZhbHVlczogdHJ1ZSwKICAgIGNkYXRhVGFnTmFtZTogZmFsc2UsCiAgICBjZGF0YVBvc2l0aW9uQ2hhcjogIlxcYyIsCiAgICBudW1QYXJzZU9wdGlvbnM6IHsKICAgICAgICBoZXg6IHRydWUsCiAgICAgICAgbGVhZGluZ1plcm9zOiB0cnVlCiAgICB9LAogICAgdGFnVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEsIHRhZ05hbWUpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBhdHRyVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEsIGF0dHJOYW1lKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgc3RvcE5vZGVzOiBbXSwKICAgIGFsd2F5c0NyZWF0ZVRleHROb2RlOiBmYWxzZQp9Owp2YXIgZGVmYXVsdE9wdGlvbnNfMSA9IGRlZmF1bHRPcHRpb25zOwpjb25zdCBwcm9wcyA9IFsKICAgICJhdHRyaWJ1dGVOYW1lUHJlZml4IiwKICAgICJhdHRyTm9kZU5hbWUiLAogICAgInRleHROb2RlTmFtZSIsCiAgICAiaWdub3JlQXR0cmlidXRlcyIsCiAgICAiaWdub3JlTmFtZVNwYWNlIiwKICAgICJhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzIiwKICAgICJwYXJzZU5vZGVWYWx1ZSIsCiAgICAicGFyc2VBdHRyaWJ1dGVWYWx1ZSIsCiAgICAiYXJyYXlNb2RlIiwKICAgICJ0cmltVmFsdWVzIiwKICAgICJjZGF0YVRhZ05hbWUiLAogICAgImNkYXRhUG9zaXRpb25DaGFyIiwKICAgICJ0YWdWYWx1ZVByb2Nlc3NvciIsCiAgICAiYXR0clZhbHVlUHJvY2Vzc29yIiwKICAgICJwYXJzZVRydWVOdW1iZXJPbmx5IiwKICAgICJudW1QYXJzZU9wdGlvbnMiLAogICAgInN0b3BOb2RlcyIsCiAgICAiYWx3YXlzQ3JlYXRlVGV4dE5vZGUiCl07CnZhciBwcm9wc18xID0gcHJvcHM7CmZ1bmN0aW9uIHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB2YWwsIG9wdGlvbnMpIHsKICAgIGlmICh2YWwpIHsKICAgICAgICBpZiAob3B0aW9ucy50cmltVmFsdWVzKSB7CiAgICAgICAgICAgIHZhbCA9IHZhbC50cmltKCk7CiAgICAgICAgfQogICAgICAgIHZhbCA9IG9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IodmFsLCB0YWdOYW1lKTsKICAgICAgICB2YWwgPSBwYXJzZVZhbHVlKHZhbCwgb3B0aW9ucy5wYXJzZU5vZGVWYWx1ZSwgb3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHZhbDsKfQpmdW5jdGlvbiByZXNvbHZlTmFtZVNwYWNlKHRhZ25hbWUsIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgIGNvbnN0IHRhZ3MgPSB0YWduYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgY29uc3QgcHJlZml4ID0gdGFnbmFtZS5jaGFyQXQoMCkgPT09ICIvIiA/ICIvIiA6ICIiOwogICAgICAgIGlmICh0YWdzWzBdID09PSAieG1sbnMiKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIHRhZ25hbWUgPSBwcmVmaXggKyB0YWdzWzFdOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YWduYW1lOwp9CmZ1bmN0aW9uIHBhcnNlVmFsdWUodmFsLCBzaG91bGRQYXJzZSwgb3B0aW9ucykgewogICAgaWYgKHNob3VsZFBhcnNlICYmIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3QgbmV3dmFsID0gdmFsLnRyaW0oKTsKICAgICAgICBpZiAobmV3dmFsID09PSAidHJ1ZSIpIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgaWYgKG5ld3ZhbCA9PT0gImZhbHNlIikgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgcmV0dXJuIHN0cm51bSh2YWwsIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodXRpbC5pc0V4aXN0KHZhbCkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGF0dHJzUmVneCA9IG5ldyBSZWdFeHAoYChbXlxccz1dKylcXHMqKD1cXHMqKFsnIl0pKC4qPylcXDMpP2AsICJnIik7CmZ1bmN0aW9uIGJ1aWxkQXR0cmlidXRlc01hcChhdHRyU3RyLCBvcHRpb25zKSB7CiAgICBpZiAoIW9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyAmJiB0eXBlb2YgYXR0clN0ciA9PT0gInN0cmluZyIpIHsKICAgICAgICBhdHRyU3RyID0gYXR0clN0ci5yZXBsYWNlKC9ccj9cbi9nLCAiICIpOwogICAgICAgIGNvbnN0IG1hdGNoZXMgPSB1dGlsLmdldEFsbE1hdGNoZXMoYXR0clN0ciwgYXR0cnNSZWd4KTsKICAgICAgICBjb25zdCBsZW4gPSBtYXRjaGVzLmxlbmd0aDsKICAgICAgICBjb25zdCBhdHRycyA9IHt9OwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IGF0dHJOYW1lID0gcmVzb2x2ZU5hbWVTcGFjZShtYXRjaGVzW2ldWzFdLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJOYW1lLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbaV1bNF0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnRyaW1WYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlc1tpXVs0XSA9IG1hdGNoZXNbaV1bNF0udHJpbSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBtYXRjaGVzW2ldWzRdID0gb3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IobWF0Y2hlc1tpXVs0XSwgYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgIGF0dHJzW29wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeCArIGF0dHJOYW1lXSA9IHBhcnNlVmFsdWUobWF0Y2hlc1tpXVs0XSwgb3B0aW9ucy5wYXJzZUF0dHJpYnV0ZVZhbHVlLCBvcHRpb25zLm51bVBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWxsb3dCb29sZWFuQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgICAgIGF0dHJzW29wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeCArIGF0dHJOYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFPYmplY3Qua2V5cyhhdHRycykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJDb2xsZWN0aW9uID0ge307CiAgICAgICAgICAgIGF0dHJDb2xsZWN0aW9uW29wdGlvbnMuYXR0ck5vZGVOYW1lXSA9IGF0dHJzOwogICAgICAgICAgICByZXR1cm4gYXR0ckNvbGxlY3Rpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KfQpjb25zdCBnZXRUcmF2ZXJzYWxPYmogPSBmdW5jdGlvbih4bWxEYXRhLCBvcHRpb25zKSB7CiAgICB4bWxEYXRhID0geG1sRGF0YS5yZXBsYWNlKC9cclxuPy9nLCAiXG4iKTsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMsIHByb3BzKTsKICAgIGNvbnN0IHhtbE9iaiA9IG5ldyB4bWxOb2RlKCIheG1sIik7CiAgICBsZXQgY3VycmVudE5vZGUgPSB4bWxPYmo7CiAgICBsZXQgdGV4dERhdGEgPSAiIjsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBjb25zdCBjaCA9IHhtbERhdGFbaV07CiAgICAgICAgaWYgKGNoID09PSAiPCIpIHsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI+IiwgaSwgIkNsb3NpbmcgVGFnIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyAyLCBjbG9zZUluZGV4KS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gdGFnTmFtZS5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGN1cnJlbnROb2RlLnRhZ25hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuY2hpbGQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuYXR0cnNNYXAgPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmF0dHJzTWFwID0ge307CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHhtbERhdGEuc3Vic3RyKGN1cnJlbnROb2RlLnN0YXJ0SW5kZXggKyAxLCBpIC0gY3VycmVudE5vZGUuc3RhcnRJbmRleCAtIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5wYXJlbnQ7CiAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgaSA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj8+IiwgaSwgIlBpIFRhZyBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAzKSA9PT0gIiEtLSIpIHsKICAgICAgICAgICAgICAgIGkgPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICItLT4iLCBpLCAiQ29tbWVudCBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFEIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiRE9DVFlQRSBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICAgICAgY29uc3QgdGFnRXhwID0geG1sRGF0YS5zdWJzdHJpbmcoaSwgY2xvc2VJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmluZGV4T2YoIlsiKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHhtbERhdGEuaW5kZXhPZigiXT4iLCBpKSArIDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFbIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIl1dPiIsIGksICJDREFUQSBpcyBub3QgY2xvc2VkLiIpIC0gMjsKICAgICAgICAgICAgICAgIGNvbnN0IHRhZ0V4cCA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyA5LCBjbG9zZUluZGV4KTsKICAgICAgICAgICAgICAgIGlmICh0ZXh0RGF0YSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUob3B0aW9ucy5jZGF0YVRhZ05hbWUsIGN1cnJlbnROb2RlLCB0YWdFeHApOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcjsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS52YWwgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSAoY3VycmVudE5vZGUudmFsIHx8ICIiKSArICh0YWdFeHAgfHwgIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXggKyAyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2xvc2luZ0luZGV4Rm9yT3BlbmluZ1RhZyh4bWxEYXRhLCBpICsgMSk7CiAgICAgICAgICAgICAgICBsZXQgdGFnRXhwID0gcmVzdWx0LmRhdGE7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gcmVzdWx0LmluZGV4OwogICAgICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9ySW5kZXggPSB0YWdFeHAuaW5kZXhPZigiICIpOwogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICBsZXQgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChzZXBhcmF0b3JJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnRXhwLnN1YnN0cigwLCBzZXBhcmF0b3JJbmRleCkucmVwbGFjZSgvXHNccyokLywgIiIpOwogICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoc2VwYXJhdG9ySW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdGFnTmFtZSAhPT0gcmVzdWx0LmRhdGEuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUgJiYgdGV4dERhdGEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudGFnbmFtZSAhPT0gIiF4bWwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmxlbmd0aCA+IDAgJiYgdGFnRXhwLmxhc3RJbmRleE9mKCIvIikgPT09IHRhZ0V4cC5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cigwLCB0YWdOYW1lLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdOYW1lOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoMCwgdGFnRXhwLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZSh0YWdOYW1lLCBjdXJyZW50Tm9kZSwgIiIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLmF0dHJzTWFwID0gYnVpbGRBdHRyaWJ1dGVzTWFwKHRhZ0V4cCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKHRhZ05hbWUsIGN1cnJlbnROb2RlKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGNoaWxkTm9kZS50YWduYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuc3RhcnRJbmRleCA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHAgJiYgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5hdHRyc01hcCA9IGJ1aWxkQXR0cmlidXRlc01hcCh0YWdFeHAsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY2hpbGROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGV4dERhdGEgKz0geG1sRGF0YVtpXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4geG1sT2JqOwp9OwpmdW5jdGlvbiBjbG9zaW5nSW5kZXhGb3JPcGVuaW5nVGFnKGRhdGEsIGkpIHsKICAgIGxldCBhdHRyQm91bmRhcnk7CiAgICBsZXQgdGFnRXhwID0gIiI7CiAgICBmb3IobGV0IGluZGV4ID0gaTsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgbGV0IGNoID0gZGF0YVtpbmRleF07CiAgICAgICAgaWYgKGF0dHJCb3VuZGFyeSkgewogICAgICAgICAgICBpZiAoY2ggPT09IGF0dHJCb3VuZGFyeSkgYXR0ckJvdW5kYXJ5ID0gIiI7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJyInIHx8IGNoID09PSAiJyIpIHsKICAgICAgICAgICAgYXR0ckJvdW5kYXJ5ID0gY2g7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIj4iKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkYXRhOiB0YWdFeHAsCiAgICAgICAgICAgICAgICBpbmRleAogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICIJIikgewogICAgICAgICAgICBjaCA9ICIgIjsKICAgICAgICB9CiAgICAgICAgdGFnRXhwICs9IGNoOwogICAgfQp9CmZ1bmN0aW9uIGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgc3RyLCBpLCBlcnJNc2cpIHsKICAgIGNvbnN0IGNsb3NpbmdJbmRleCA9IHhtbERhdGEuaW5kZXhPZihzdHIsIGkpOwogICAgaWYgKGNsb3NpbmdJbmRleCA9PT0gLTEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNsb3NpbmdJbmRleCArIHN0ci5sZW5ndGggLSAxOwogICAgfQp9CnZhciBnZXRUcmF2ZXJzYWxPYmpfMSA9IGdldFRyYXZlcnNhbE9iajsKdmFyIHhtbHN0cjJ4bWxub2RlID0gewogICAgZGVmYXVsdE9wdGlvbnM6IGRlZmF1bHRPcHRpb25zXzEsCiAgICBwcm9wczogcHJvcHNfMSwKICAgIGdldFRyYXZlcnNhbE9iajogZ2V0VHJhdmVyc2FsT2JqXzEKfTsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMSA9IHsKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlCn07CmNvbnN0IHByb3BzJDEgPSBbCiAgICAiYWxsb3dCb29sZWFuQXR0cmlidXRlcyIKXTsKdmFyIHZhbGlkYXRlID0gZnVuY3Rpb24oeG1sRGF0YSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDEsIHByb3BzJDEpOwogICAgY29uc3QgdGFncyA9IFtdOwogICAgbGV0IHRhZ0ZvdW5kID0gZmFsc2U7CiAgICBsZXQgcmVhY2hlZFJvb3QgPSBmYWxzZTsKICAgIGlmICh4bWxEYXRhWzBdID09PSAiXHVGRUZGIikgewogICAgICAgIHhtbERhdGEgPSB4bWxEYXRhLnN1YnN0cigxKTsKICAgIH0KICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiICYmIHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICBpID0gcmVhZFBJKHhtbERhdGEsIGkpOwogICAgICAgICAgICBpZiAoaS5lcnIpIHJldHVybiBpOwogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgIGxldCB0YWdTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgaSA9IHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxldCBjbG9zaW5nVGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgY2xvc2luZ1RhZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSAiIjsKICAgICAgICAgICAgICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aCAmJiB4bWxEYXRhW2ldICE9PSAiPiIgJiYgeG1sRGF0YVtpXSAhPT0gIiAiICYmIHhtbERhdGFbaV0gIT09ICIJIiAmJiB4bWxEYXRhW2ldICE9PSAiXG4iICYmIHhtbERhdGFbaV0gIT09ICJcciI7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSArPSB4bWxEYXRhW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUudHJpbSgpOwogICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyaW5nKDAsIHRhZ05hbWUubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVRhZ05hbWUodGFnTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgbXNnOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIkludmFsaWQgc3BhY2UgYWZ0ZXIgJzwnLiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIlRhZyAnIiArIHRhZ05hbWUgKyAiJyBpcyBhbiBpbnZhbGlkIG5hbWUuIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgbXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGVzIGZvciAnIiArIHRhZ05hbWUgKyAiJyBoYXZlIG9wZW4gcXVvdGUuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBhdHRyU3RyID0gcmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgaSA9IHJlc3VsdC5pbmRleDsKICAgICAgICAgICAgICAgIGlmIChhdHRyU3RyW2F0dHJTdHIubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJTdHJTdGFydCA9IGkgLSBhdHRyU3RyLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyID0gYXR0clN0ci5zdWJzdHJpbmcoMCwgYXR0clN0ci5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdChpc1ZhbGlkLmVyci5jb2RlLCBpc1ZhbGlkLmVyci5tc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBhdHRyU3RyU3RhcnQgKyBpc1ZhbGlkLmVyci5saW5lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zaW5nVGFnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQudGFnQ2xvc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJDbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJyBkb2Vzbid0IGhhdmUgcHJvcGVyIGNsb3NpbmcuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJTdHIudHJpbSgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInIGNhbid0IGhhdmUgYXR0cmlidXRlcyBvciBpbnZhbGlkIHN0YXJ0aW5nLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdTdGFydFBvcykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG90ZyA9IHRhZ3MucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSBvdGcudGFnTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9wZW5Qb3MgPSBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgb3RnLnRhZ1N0YXJ0UG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJFeHBlY3RlZCBjbG9zaW5nIHRhZyAnIiArIG90Zy50YWdOYW1lICsgIicgKG9wZW5lZCBpbiBsaW5lICIgKyBvcGVuUG9zLmxpbmUgKyAiLCBjb2wgIiArIG9wZW5Qb3MuY29sICsgIikgaW5zdGVhZCBvZiBjbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnU3RhcnRQb3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhY2hlZFJvb3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KGlzVmFsaWQuZXJyLmNvZGUsIGlzVmFsaWQuZXJyLm1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkgLSBhdHRyU3RyLmxlbmd0aCArIGlzVmFsaWQuZXJyLmxpbmUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWNoZWRSb290ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJNdWx0aXBsZSBwb3NzaWJsZSByb290IG5vZGVzIGZvdW5kLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFncy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdTdGFydFBvcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yKGkrKzsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiISIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHJlYWRQSSh4bWxEYXRhLCArK2kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkuZXJyKSByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWZ0ZXJBbXAgPSB2YWxpZGF0ZUFtcGVyc2FuZCh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFmdGVyQW1wID09IC0xKSByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRDaGFyIiwgImNoYXIgJyYnIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgICAgICBpID0gYWZ0ZXJBbXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiICIgfHwgeG1sRGF0YVtpXSA9PT0gIgkiIHx8IHhtbERhdGFbaV0gPT09ICJcbiIgfHwgeG1sRGF0YVtpXSA9PT0gIlxyIikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQ2hhciIsICJjaGFyICciICsgeG1sRGF0YVtpXSArICInIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgIH0KICAgIH0KICAgIGlmICghdGFnRm91bmQpIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiU3RhcnQgdGFnIGV4cGVjdGVkLiIsIDEpOwogICAgfSBlbHNlIGlmICh0YWdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIlVuY2xvc2VkIHRhZyAnIiArIHRhZ3NbMF0udGFnTmFtZSArICInLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdzWzBdLnRhZ1N0YXJ0UG9zKSk7CiAgICB9IGVsc2UgaWYgKHRhZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJJbnZhbGlkICciICsgSlNPTi5zdHJpbmdpZnkodGFncy5tYXAoKHQpPT50LnRhZ05hbWUKICAgICAgICApLCBudWxsLCA0KS5yZXBsYWNlKC9ccj9cbi9nLCAiIikgKyAiJyBmb3VuZC4iLCB7CiAgICAgICAgICAgIGxpbmU6IDEsCiAgICAgICAgICAgIGNvbDogMQogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn07CmZ1bmN0aW9uIHJlYWRQSSh4bWxEYXRhLCBpKSB7CiAgICBjb25zdCBzdGFydCA9IGk7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT0gIj8iIHx8IHhtbERhdGFbaV0gPT0gIiAiKSB7CiAgICAgICAgICAgIGNvbnN0IHRhZ25hbWUgPSB4bWxEYXRhLnN1YnN0cihzdGFydCwgaSAtIHN0YXJ0KTsKICAgICAgICAgICAgaWYgKGkgPiA1ICYmIHRhZ25hbWUgPT09ICJ4bWwiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiWE1MIGRlY2xhcmF0aW9uIGFsbG93ZWQgb25seSBhdCB0aGUgc3RhcnQgb2YgdGhlIGRvY3VtZW50LiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PSAiPyIgJiYgeG1sRGF0YVtpICsgMV0gPT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKSB7CiAgICBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgNSAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDJdID09PSAiLSIpIHsKICAgICAgICBmb3IoaSArPSAzOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgOCAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDJdID09PSAiTyIgJiYgeG1sRGF0YVtpICsgM10gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyA0XSA9PT0gIlQiICYmIHhtbERhdGFbaSArIDVdID09PSAiWSIgJiYgeG1sRGF0YVtpICsgNl0gPT09ICJQIiAmJiB4bWxEYXRhW2kgKyA3XSA9PT0gIkUiKSB7CiAgICAgICAgbGV0IGFuZ2xlQnJhY2tldHNDb3VudCA9IDE7CiAgICAgICAgZm9yKGkgKz0gODsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBhbmdsZUJyYWNrZXRzQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGFuZ2xlQnJhY2tldHNDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKGFuZ2xlQnJhY2tldHNDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA5ICYmIHhtbERhdGFbaSArIDFdID09PSAiWyIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyAzXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDRdID09PSAiQSIgJiYgeG1sRGF0YVtpICsgNV0gPT09ICJUIiAmJiB4bWxEYXRhW2kgKyA2XSA9PT0gIkEiICYmIHhtbERhdGFbaSArIDddID09PSAiWyIpIHsKICAgICAgICBmb3IoaSArPSA4OyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiXSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICJdIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwp9CmNvbnN0IGRvdWJsZVF1b3RlID0gJyInOwpjb25zdCBzaW5nbGVRdW90ZSA9ICInIjsKZnVuY3Rpb24gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKSB7CiAgICBsZXQgYXR0clN0ciA9ICIiOwogICAgbGV0IHN0YXJ0Q2hhciA9ICIiOwogICAgbGV0IHRhZ0Nsb3NlZCA9IGZhbHNlOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSBkb3VibGVRdW90ZSB8fCB4bWxEYXRhW2ldID09PSBzaW5nbGVRdW90ZSkgewogICAgICAgICAgICBpZiAoc3RhcnRDaGFyID09PSAiIikgewogICAgICAgICAgICAgICAgc3RhcnRDaGFyID0geG1sRGF0YVtpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydENoYXIgIT09IHhtbERhdGFbaV0pIDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydENoYXIgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIj4iKSB7CiAgICAgICAgICAgIGlmIChzdGFydENoYXIgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0YWdDbG9zZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXR0clN0ciArPSB4bWxEYXRhW2ldOwogICAgfQogICAgaWYgKHN0YXJ0Q2hhciAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBhdHRyU3RyLAogICAgICAgIGluZGV4OiBpLAogICAgICAgIHRhZ0Nsb3NlZAogICAgfTsKfQpjb25zdCB2YWxpZEF0dHJTdHJSZWd4cCA9IG5ldyBSZWdFeHAoYChcXHMqKShbXlxccz1dKykoXFxzKj0pPyhcXHMqKFsnIl0pKChbXFxzXFxTXSkqPylcXDUpP2AsICJnIik7CmZ1bmN0aW9uIHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGNvbnN0IG1hdGNoZXMgPSB1dGlsLmdldEFsbE1hdGNoZXMoYXR0clN0ciwgdmFsaWRBdHRyU3RyUmVneHApOwogICAgY29uc3QgYXR0ck5hbWVzID0ge307CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgbWF0Y2hlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKG1hdGNoZXNbaV1bMV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGhhcyBubyBzcGFjZSBpbiBzdGFydGluZy4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaGVzW2ldWzNdID09PSB2b2lkIDAgJiYgIW9wdGlvbnMuYWxsb3dCb29sZWFuQXR0cmlidXRlcykgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgImJvb2xlYW4gYXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGlzIG5vdCBhbGxvd2VkLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0ck5hbWUgPSBtYXRjaGVzW2ldWzJdOwogICAgICAgIGlmICghdmFsaWRhdGVBdHRyTmFtZShhdHRyTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBhdHRyTmFtZSArICInIGlzIGFuIGludmFsaWQgbmFtZS4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgICAgIGlmICghYXR0ck5hbWVzLmhhc093blByb3BlcnR5KGF0dHJOYW1lKSkgewogICAgICAgICAgICBhdHRyTmFtZXNbYXR0ck5hbWVdID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgcmVwZWF0ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGxldCByZSA9IC9cZC87CiAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIngiKSB7CiAgICAgICAgaSsrOwogICAgICAgIHJlID0gL1tcZGEtZkEtRl0vOwogICAgfQogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiBpOwogICAgICAgIGlmICgheG1sRGF0YVtpXS5tYXRjaChyZSkpIGJyZWFrOwogICAgfQogICAgcmV0dXJuIC0xOwp9CmZ1bmN0aW9uIHZhbGlkYXRlQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGkrKzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiAtMTsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiIyIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpOwogICAgfQogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrLCBjb3VudCsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXS5tYXRjaCgvXHcvKSAmJiBjb3VudCA8IDIwKSBjb250aW51ZTsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjsiKSBicmVhazsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICByZXR1cm4gaTsKfQpmdW5jdGlvbiBnZXRFcnJvck9iamVjdChjb2RlLCBtZXNzYWdlLCBsaW5lTnVtYmVyKSB7CiAgICByZXR1cm4gewogICAgICAgIGVycjogewogICAgICAgICAgICBjb2RlLAogICAgICAgICAgICBtc2c6IG1lc3NhZ2UsCiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIubGluZSB8fCBsaW5lTnVtYmVyLAogICAgICAgICAgICBjb2w6IGxpbmVOdW1iZXIuY29sCiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiB2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUoYXR0ck5hbWUpOwp9CmZ1bmN0aW9uIHZhbGlkYXRlVGFnTmFtZSh0YWduYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUodGFnbmFtZSk7Cn0KZnVuY3Rpb24gZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGluZGV4KSB7CiAgICBjb25zdCBsaW5lcyA9IHhtbERhdGEuc3Vic3RyaW5nKDAsIGluZGV4KS5zcGxpdCgvXHI/XG4vKTsKICAgIHJldHVybiB7CiAgICAgICAgbGluZTogbGluZXMubGVuZ3RoLAogICAgICAgIGNvbDogbGluZXNbbGluZXMubGVuZ3RoIC0gMV0ubGVuZ3RoICsgMQogICAgfTsKfQpmdW5jdGlvbiBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaCkgewogICAgcmV0dXJuIG1hdGNoLnN0YXJ0SW5kZXggKyBtYXRjaFsxXS5sZW5ndGg7Cn0KdmFyIHZhbGlkYXRvciA9IHsKICAgIHZhbGlkYXRlCn07CmNvbnN0IF9fY2hhciA9IGZ1bmN0aW9uKGEpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGEpOwp9Owpjb25zdCBjaGFycyA9IHsKICAgIG5pbENoYXI6IF9fY2hhcigxNzYpLAogICAgbWlzc2luZ0NoYXI6IF9fY2hhcigyMDEpLAogICAgbmlsUHJlbWl0aXZlOiBfX2NoYXIoMTc1KSwKICAgIG1pc3NpbmdQcmVtaXRpdmU6IF9fY2hhcigyMDApLAogICAgZW1wdHlDaGFyOiBfX2NoYXIoMTc4KSwKICAgIGVtcHR5VmFsdWU6IF9fY2hhcigxNzcpLAogICAgYm91bmRyeUNoYXI6IF9fY2hhcigxNzkpLAogICAgb2JqU3RhcnQ6IF9fY2hhcigxOTgpLAogICAgYXJyU3RhcnQ6IF9fY2hhcigyMDQpLAogICAgYXJyYXlFbmQ6IF9fY2hhcigxODUpCn07CmNvbnN0IGNoYXJzQXJyID0gWwogICAgY2hhcnMubmlsQ2hhciwKICAgIGNoYXJzLm5pbFByZW1pdGl2ZSwKICAgIGNoYXJzLm1pc3NpbmdDaGFyLAogICAgY2hhcnMubWlzc2luZ1ByZW1pdGl2ZSwKICAgIGNoYXJzLmJvdW5kcnlDaGFyLAogICAgY2hhcnMuZW1wdHlDaGFyLAogICAgY2hhcnMuZW1wdHlWYWx1ZSwKICAgIGNoYXJzLmFycmF5RW5kLAogICAgY2hhcnMub2JqU3RhcnQsCiAgICBjaGFycy5hcnJTdGFydApdOwpjb25zdCBfZSA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIGVfc2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgIGlmIChub2RlICYmIG5vZGVbMF0gJiYgbm9kZVswXS52YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWUobm9kZVswXS52YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGhhc1ZhbGlkRGF0YSA9IGhhc0RhdGEobm9kZSk7CiAgICAgICAgaWYgKGhhc1ZhbGlkRGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICBsZXQgc3RyID0gIiI7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVfc2NoZW1hKSkgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFyclN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3QgaXRlbVNjaGVtYSA9IGVfc2NoZW1hWzBdOwogICAgICAgICAgICAgICAgY29uc3QgYXJyX2xlbiA9IG5vZGUubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtU2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gZ2V0VmFsdWUobm9kZVthcnJfaV0udmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGFycl9pID0gMDsgYXJyX2kgPCBhcnJfbGVuOyBhcnJfaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IF9lKG5vZGVbYXJyX2ldLCBpdGVtU2NoZW1hLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFycmF5RW5kOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLm9ialN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGVfc2NoZW1hKTsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgaW4ga2V5cyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyAmJiBub2RlLmF0dHJzTWFwICYmIG5vZGUuYXR0cnNNYXBba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5hdHRyc01hcFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gb3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IF9lKG5vZGUudmFsLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5jaGlsZFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gaGFzVmFsaWREYXRhOwogICAgICAgIH0KICAgIH0KfTsKY29uc3QgZ2V0VmFsdWUgPSBmdW5jdGlvbihhKSB7CiAgICBzd2l0Y2goYSl7CiAgICAgICAgY2FzZSB2b2lkIDA6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nUHJlbWl0aXZlOwogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm5pbFByZW1pdGl2ZTsKICAgICAgICBjYXNlICIiOgogICAgICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlWYWx1ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gYTsKICAgIH0KfTsKY29uc3QgcHJvY2Vzc1ZhbHVlID0gZnVuY3Rpb24oc3RyLCByKSB7CiAgICBpZiAoIWlzQXBwQ2hhcihyWzBdKSAmJiAhaXNBcHBDaGFyKHN0cltzdHIubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgc3RyICs9IGNoYXJzLmJvdW5kcnlDaGFyOwogICAgfQogICAgcmV0dXJuIHN0ciArIHI7Cn07CmNvbnN0IGlzQXBwQ2hhciA9IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gY2hhcnNBcnIuaW5kZXhPZihjaCkgIT09IC0xOwp9OwpmdW5jdGlvbiBoYXNEYXRhKGpPYmopIHsKICAgIGlmIChqT2JqID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gY2hhcnMubWlzc2luZ0NoYXI7CiAgICB9IGVsc2UgaWYgKGpPYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2hhcnMubmlsQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iai5jaGlsZCAmJiBPYmplY3Qua2V5cyhqT2JqLmNoaWxkKS5sZW5ndGggPT09IDAgJiYgKCFqT2JqLmF0dHJzTWFwIHx8IE9iamVjdC5rZXlzKGpPYmouYXR0cnNNYXApLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQpjb25zdCBidWlsZE9wdGlvbnMkMSA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0Mm5pbW4gPSBmdW5jdGlvbihub2RlLCBlX3NjaGVtYSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQxKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICByZXR1cm4gX2Uobm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpOwp9Owp2YXIgY29udmVydDJuaW1uXzEgPSBjb252ZXJ0Mm5pbW47CnZhciBuaW1uZGF0YSA9IHsKICAgIGNvbnZlcnQybmltbjogY29udmVydDJuaW1uXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDIgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgY29udmVydFRvSnNvblN0cmluZyA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMihvcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5kZWZhdWx0T3B0aW9ucywgeG1sc3RyMnhtbG5vZGUucHJvcHMpOwogICAgb3B0aW9ucy5pbmRlbnRCeSA9IG9wdGlvbnMuaW5kZW50QnkgfHwgIiI7CiAgICByZXR1cm4gX2NUb0pzb25TdHIobm9kZSwgb3B0aW9ucyk7Cn07CmNvbnN0IF9jVG9Kc29uU3RyID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucywgbGV2ZWwpIHsKICAgIGxldCBqT2JqID0gInsiOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUuY2hpbGQpOwogICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwga2V5cy5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGNvbnN0IHRhZ25hbWUgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWduYW1lXSAmJiBub2RlLmNoaWxkW3RhZ25hbWVdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgak9iaiArPSAnIicgKyB0YWduYW1lICsgJyIgOiBbICc7CiAgICAgICAgICAgIGZvcihsZXQgdGFnIGluIG5vZGUuY2hpbGRbdGFnbmFtZV0pewogICAgICAgICAgICAgICAgak9iaiArPSBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdW3RhZ10sIG9wdGlvbnMpICsgIiAsICI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMSkgKyAiIF0gIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6ICcgKyBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdWzBdLCBvcHRpb25zKSArICIgLCI7CiAgICAgICAgfQogICAgfQogICAgdXRpbC5tZXJnZShqT2JqLCBub2RlLmF0dHJzTWFwKTsKICAgIGlmICh1dGlsLmlzRW1wdHlPYmplY3Qoak9iaikpIHsKICAgICAgICByZXR1cm4gdXRpbC5pc0V4aXN0KG5vZGUudmFsKSA/IG5vZGUudmFsIDogIiI7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3Qobm9kZS52YWwpKSB7CiAgICAgICAgICAgIGlmICghKHR5cGVvZiBub2RlLnZhbCA9PT0gInN0cmluZyIgJiYgKG5vZGUudmFsID09PSAiIiB8fCBub2RlLnZhbCA9PT0gb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcikpKSB7CiAgICAgICAgICAgICAgICBqT2JqICs9ICciJyArIG9wdGlvbnMudGV4dE5vZGVOYW1lICsgJyIgOiAnICsgc3RyaW5ndmFsKG5vZGUudmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmIChqT2JqW2pPYmoubGVuZ3RoIC0gMV0gPT09ICIsIikgewogICAgICAgIGpPYmogPSBqT2JqLnN1YnN0cigwLCBqT2JqLmxlbmd0aCAtIDIpOwogICAgfQogICAgcmV0dXJuIGpPYmogKyAifSI7Cn07CmZ1bmN0aW9uIHN0cmluZ3ZhbCh2KSB7CiAgICBpZiAodiA9PT0gdHJ1ZSB8fCB2ID09PSBmYWxzZSB8fCAhaXNOYU4odikpIHsKICAgICAgICByZXR1cm4gdjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICciJyArIHYgKyAnIic7CiAgICB9Cn0KdmFyIGNvbnZlcnRUb0pzb25TdHJpbmdfMSA9IGNvbnZlcnRUb0pzb25TdHJpbmc7CnZhciBub2RlMmpzb25fc3RyID0gewogICAgY29udmVydFRvSnNvblN0cmluZzogY29udmVydFRvSnNvblN0cmluZ18xCn07CmNvbnN0IGJ1aWxkT3B0aW9ucyQzID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGRlZmF1bHRPcHRpb25zJDIgPSB7CiAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAiQF8iLAogICAgYXR0ck5vZGVOYW1lOiBmYWxzZSwKICAgIHRleHROb2RlTmFtZTogIiN0ZXh0IiwKICAgIGlnbm9yZUF0dHJpYnV0ZXM6IHRydWUsCiAgICBjZGF0YVRhZ05hbWU6IGZhbHNlLAogICAgY2RhdGFQb3NpdGlvbkNoYXI6ICJcXGMiLAogICAgZm9ybWF0OiBmYWxzZSwKICAgIGluZGVudEJ5OiAiICAiLAogICAgc3VwcmVzc0VtcHR5Tm9kZTogZmFsc2UsCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9wcyQyID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJjZGF0YVRhZ05hbWUiLAogICAgImNkYXRhUG9zaXRpb25DaGFyIiwKICAgICJmb3JtYXQiLAogICAgImluZGVudEJ5IiwKICAgICJzdXByZXNzRW1wdHlOb2RlIiwKICAgICJ0YWdWYWx1ZVByb2Nlc3NvciIsCiAgICAiYXR0clZhbHVlUHJvY2Vzc29yIiwKICAgICJyb290Tm9kZU5hbWUiCl07CmZ1bmN0aW9uIFBhcnNlcihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucyQyLCBwcm9wcyQyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyB8fCB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hdHRyUHJlZml4TGVuID0gdGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgubGVuZ3RoOwogICAgICAgIHRoaXMuaXNBdHRyaWJ1dGUgPSBpc0F0dHJpYnV0ZTsKICAgIH0KICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gaXNDREFUQTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQogICAgdGhpcy5yZXBsYWNlQ0RBVEFzdHIgPSByZXBsYWNlQ0RBVEFzdHI7CiAgICB0aGlzLnJlcGxhY2VDREFUQWFyciA9IHJlcGxhY2VDREFUQWFycjsKICAgIHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUgPSBwcm9jZXNzVGV4dE9yT2JqTm9kZTsKICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0KSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBpbmRlbnRhdGU7CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj5cbiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIlxuIjsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH07CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj4iOwogICAgICAgIHRoaXMubmV3TGluZSA9ICIiOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5zdXByZXNzRW1wdHlOb2RlKSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRFbXB0eVRleHROb2RlOwogICAgICAgIHRoaXMuYnVpbGRPYmpOb2RlID0gYnVpbGRFbXB0eU9iak5vZGU7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYnVpbGRUZXh0Tm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZE9iamVjdE5vZGU7CiAgICB9CiAgICB0aGlzLmJ1aWxkVGV4dFZhbE5vZGUgPSBidWlsZFRleHRWYWxOb2RlOwogICAgdGhpcy5idWlsZE9iamVjdE5vZGUgPSBidWlsZE9iamVjdE5vZGU7Cn0KUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGpPYmopIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGpPYmopICYmIHRoaXMub3B0aW9ucy5yb290Tm9kZU5hbWUgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZS5sZW5ndGggPiAxKSB7CiAgICAgICAgak9iaiA9IHsKICAgICAgICAgICAgW3RoaXMub3B0aW9ucy5yb290Tm9kZU5hbWVdOiBqT2JqCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiB0aGlzLmoyeChqT2JqLCAwKS52YWw7Cn07ClBhcnNlci5wcm90b3R5cGUuajJ4ID0gZnVuY3Rpb24oak9iaiwgbGV2ZWwpIHsKICAgIGxldCBhdHRyU3RyID0gIiI7CiAgICBsZXQgdmFsID0gIiI7CiAgICBmb3IobGV0IGtleSBpbiBqT2JqKXsKICAgICAgICBpZiAodHlwZW9mIGpPYmpba2V5XSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICBlbHNlIGlmIChqT2JqW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICB9IGVsc2UgaWYgKGpPYmpba2V5XSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBqT2JqW2tleV0gIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLmlzQXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIGF0dHIgKyAnPSInICsgdGhpcy5vcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcigiIiArIGpPYmpba2V5XSkgKyAnIic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQXN0cigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHRoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lXSkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmJ1aWxkVGV4dE5vZGUoak9ialtrZXldLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoak9ialtrZXldKSkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCk7CiAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycihqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFhcnIoIiIsIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJMZW4gPSBqT2JqW2tleV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IGFyckxlbjsgaisrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gak9ialtrZXldW2pdOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpdGVtID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUoaXRlbSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShpdGVtLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUgJiYga2V5ID09PSB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjb25zdCBLcyA9IE9iamVjdC5rZXlzKGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICBjb25zdCBMID0gS3MubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IEw7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0ciArPSAiICIgKyBLc1tqXSArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldW0tzW2pdXSkgKyAnIic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShqT2JqW2tleV0sIGtleSwgbGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBhdHRyU3RyLAogICAgICAgIHZhbAogICAgfTsKfTsKZnVuY3Rpb24gcHJvY2Vzc1RleHRPck9iak5vZGUob2JqZWN0LCBrZXksIGxldmVsKSB7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmoyeChvYmplY3QsIGxldmVsICsgMSk7CiAgICBpZiAob2JqZWN0W3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdICE9PSB2b2lkIDAgJiYgT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHROb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRPYmpOb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFzdHIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIsICI8IVtDREFUQVsiICsgY2RhdGEgKyAiXV0iICsgdGhpcy50YWdFbmRDaGFyKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFhcnIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YS5qb2luKCJdXT48IVtDREFUQVsiKSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIGZvcihsZXQgdiBpbiBjZGF0YSl7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YVt2XSArICJdXT4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0ciArIHRoaXMubmV3TGluZTsKICAgIH0KfQpmdW5jdGlvbiBidWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAoYXR0clN0ciAmJiB2YWwuaW5kZXhPZigiPCIpID09PSAtMSkgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdmFsICsgIjwvIiArIGtleSArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyB0aGlzLnRhZ0VuZENoYXIgKyB2YWwgKyB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlPYmpOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKHZhbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlUZXh0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmICh2YWwgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBpbmRlbnRhdGUobGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaW5kZW50QnkucmVwZWF0KGxldmVsKTsKfQpmdW5jdGlvbiBpc0F0dHJpYnV0ZShuYW1lKSB7CiAgICBpZiAobmFtZS5zdGFydHNXaXRoKHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4KSkgewogICAgICAgIHJldHVybiBuYW1lLnN1YnN0cih0aGlzLmF0dHJQcmVmaXhMZW4pOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KZnVuY3Rpb24gaXNDREFUQShuYW1lKSB7CiAgICByZXR1cm4gbmFtZSA9PT0gdGhpcy5vcHRpb25zLmNkYXRhVGFnTmFtZTsKfQp2YXIganNvbjJ4bWwgPSBQYXJzZXI7CnZhciBwYXJzZXIgPSBjcmVhdGVDb21tb25qc01vZHVsZShmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IHgyeG1sbm9kZSA9IHhtbHN0cjJ4bWxub2RlOwogICAgY29uc3QgYnVpbGRPcHRpb25zMiA9IHV0aWwuYnVpbGRPcHRpb25zOwogICAgZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uKHhtbERhdGEsIGdpdmVuT3B0aW9ucyA9IHt9LCB2YWxpZGF0aW9uT3B0aW9uKSB7CiAgICAgICAgaWYgKHZhbGlkYXRpb25PcHRpb24pIHsKICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25PcHRpb24gPT09IHRydWUpIHZhbGlkYXRpb25PcHRpb24gPSB7fTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKHhtbERhdGEsIHZhbGlkYXRpb25PcHRpb24pOwogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihyZXN1bHQuZXJyLm1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGdpdmVuT3B0aW9ucy5wYXJzZVRydWVOdW1iZXJPbmx5ICYmIGdpdmVuT3B0aW9ucy5wYXJzZU5vZGVWYWx1ZSAhPT0gZmFsc2UgJiYgIWdpdmVuT3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpIHsKICAgICAgICAgICAgZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgIGxlYWRpbmdaZXJvczogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgbGV0IG9wdGlvbnMgPSBidWlsZE9wdGlvbnMyKGdpdmVuT3B0aW9ucywgeDJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4MnhtbG5vZGUucHJvcHMpOwogICAgICAgIGNvbnN0IHRyYXZlcnNhYmxlT2JqID0geG1sc3RyMnhtbG5vZGUuZ2V0VHJhdmVyc2FsT2JqKHhtbERhdGEsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBub2RlMmpzb24uY29udmVydFRvSnNvbih0cmF2ZXJzYWJsZU9iaiwgb3B0aW9ucyk7CiAgICB9OwogICAgZXhwb3J0cy5jb252ZXJ0VG9uaW1uID0gbmltbmRhdGEuY29udmVydDJuaW1uOwogICAgZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmo7CiAgICBleHBvcnRzLmNvbnZlcnRUb0pzb24gPSBub2RlMmpzb24uY29udmVydFRvSnNvbjsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvblN0cmluZyA9IG5vZGUyanNvbl9zdHIuY29udmVydFRvSnNvblN0cmluZzsKICAgIGV4cG9ydHMudmFsaWRhdGUgPSB2YWxpZGF0b3IudmFsaWRhdGU7CiAgICBleHBvcnRzLmoyeFBhcnNlciA9IGpzb24yeG1sOwogICAgZXhwb3J0cy5wYXJzZVRvTmltbiA9IGZ1bmN0aW9uKHhtbERhdGEsIHNjaGVtYSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBleHBvcnRzLmNvbnZlcnRUb25pbW4oZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyksIHNjaGVtYSwgb3B0aW9ucyk7CiAgICB9Owp9KTsKcGFyc2VyLmNvbnZlcnRUb0pzb247CnBhcnNlci5jb252ZXJ0VG9Kc29uU3RyaW5nOwpwYXJzZXIuY29udmVydFRvbmltbjsKdmFyIGdldFRyYXZlcnNhbE9iaiQxID0gcGFyc2VyLmdldFRyYXZlcnNhbE9iajsKcGFyc2VyLmoyeFBhcnNlcjsKcGFyc2VyLnBhcnNlOwpwYXJzZXIucGFyc2VUb05pbW47CnBhcnNlci52YWxpZGF0ZTsKZnVuY3Rpb24gcGFyc2VYbWwoeG1sKSB7CiAgICBjb25zdCBydCA9IGdldFRyYXZlcnNhbE9iaiQxKHhtbCwgewogICAgICAgIGlnbm9yZUF0dHJpYnV0ZXM6IGZhbHNlLAogICAgICAgIHBhcnNlQXR0cmlidXRlVmFsdWU6IGZhbHNlLAogICAgICAgIHBhcnNlTm9kZVZhbHVlOiBmYWxzZQogICAgfSk7CiAgICBjb25zdCBuYW1lc3BhY2VzID0gbmV3IFhtbE5hbWVzcGFjZXMoKTsKICAgIGFwcGx5UW5hbWVzKHJ0LCBuYW1lc3BhY2VzKTsKICAgIGNoZWNrRXF1YWwoJ25hbWVzcGFjZXMuc3RhY2tTaXplJywgbmFtZXNwYWNlcy5zdGFja1NpemUsIDApOwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVNYXAoYXR0cnNNYXApIHsKICAgIGxldCBtYXA7CiAgICBpZiAoYXR0cnNNYXApIHsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXR0cnNNYXApKXsKICAgICAgICAgICAgaWYgKCFuYW1lLnN0YXJ0c1dpdGgoJ0BfJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGF0dHJzTWFwIG5hbWU6ICR7bmFtZX0sICR7YXR0cnNNYXB9YCk7CiAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgIG1hcC5zZXQobmFtZS5zdWJzdHJpbmcoMiksIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbWFwIHx8IEVNUFRZX1NUUklOR19NQVA7Cn0KZnVuY3Rpb24gZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4ucW5hbWVzKSB7CiAgICBsZXQgcnQ7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgcW5hbWUgb2YgcW5hbWVzKXsKICAgICAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgICAgaWYgKHFuYW1lLm5hbWUgPT09ICcqJyA/IHFuYW1lLm5hbWVzcGFjZVVyaSA9PT0gZXh0Q2hpbGQucW5hbWUubmFtZXNwYWNlVXJpIDogcW5hbWVFcShxbmFtZSwgZXh0Q2hpbGQucW5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcnQgPSBydCB8fCBbXTsKICAgICAgICAgICAgICAgICAgICBydC5wdXNoKGV4dENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydCB8fCBFTVBUWV9YTUxfTk9ERV9BUlJBWTsKfQpmdW5jdGlvbiBmaW5kRWxlbWVudFJlY3Vyc2l2ZShyb290LCB0ZXN0KSB7CiAgICBpZiAodGVzdChyb290KSkgcmV0dXJuIHJvb3Q7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMocm9vdC5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdmFsdWUpewogICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICBjb25zdCBydCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKGV4dENoaWxkLCB0ZXN0KTsKICAgICAgICAgICAgaWYgKHJ0KSByZXR1cm4gcnQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBxbmFtZUVxKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLm5hbWUgPT09IHJocy5uYW1lICYmIGxocy5uYW1lc3BhY2VVcmkgPT09IHJocy5uYW1lc3BhY2VVcmk7Cn0KZnVuY3Rpb24gcW5hbWVzSW5jbHVkZShsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zb21lKCh2KT0+cW5hbWVFcSh2LCByaHMpCiAgICApOwp9CmNvbnN0IEVNUFRZX1NUUklOR19NQVAgPSBuZXcgTWFwKCk7CmNvbnN0IEVNUFRZX1hNTF9OT0RFX0FSUkFZID0gW107CmZ1bmN0aW9uIGFwcGx5UW5hbWVzKG5vZGUsIG5hbWVzcGFjZXMpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgYXR0cyA9IG5hbWVzcGFjZXMucHVzaChub2RlLmF0dHJzTWFwKTsKICAgICAgICBjb25zdCBub2RlQXNBbnkgPSBub2RlOwogICAgICAgIG5vZGVBc0FueS5hdHRzID0gYXR0czsKICAgICAgICBub2RlQXNBbnkucW5hbWUgPSBjb21wdXRlUW5hbWUobm9kZS50YWduYW1lLCBuYW1lc3BhY2VzKTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkTm9kZSBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBhcHBseVFuYW1lcyhjaGlsZE5vZGUsIG5hbWVzcGFjZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBmaW5hbGx5ewogICAgICAgIG5hbWVzcGFjZXMucG9wKCk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVFuYW1lKG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsIG5hbWVzcGFjZXMpIHsKICAgIGNvbnN0IGkgPSBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5maW5kTmFtZXNwYWNlVXJpKCcnKQogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoaSArIDEpLAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5nZXROYW1lc3BhY2VVcmkobmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoMCwgaSkpCiAgICB9Owp9CmNsYXNzIFhtbE5hbWVzcGFjZXMgewogICAgc3RhY2sgPSBbXTsKICAgIGdldCBzdGFja1NpemUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2subGVuZ3RoOwogICAgfQogICAgcHVzaChhdHRyc01hcCkgewogICAgICAgIGNvbnN0IGF0dHJzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCk7CiAgICAgICAgbGV0IG1hcDsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgYXR0cnMuZW50cmllcygpKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICd4bWxucycpIHsKICAgICAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICBtYXAuc2V0KCcnLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5zdGFydHNXaXRoKCd4bWxuczonKSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWUuc3Vic3RyaW5nKDYpOwogICAgICAgICAgICAgICAgbWFwLnNldChwcmVmaXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnN0YWNrLnB1c2gobWFwIHx8IEVNUFRZX1NUUklOR19NQVApOwogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KICAgIHBvcCgpIHsKICAgICAgICB0aGlzLnN0YWNrLnBvcCgpOwogICAgfQogICAgZmluZE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGdldE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBnZXROYW1lc3BhY2VVcmk6IHByZWZpeCBub3QgZm91bmQ6ICR7cHJlZml4fWApOwogICAgfQp9CmZ1bmN0aW9uIGlzUmVhZG9ubHlBcnJheShhcmcpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyZyk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybCh1cmwsIHN1YmplY3QsIG9wdHMpIHsKICAgIGNvbnN0IHJvb3RDb21tZW50ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKTsKICAgIGlmICghcm9vdENvbW1lbnQpIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBjb21tZW50ZXJzID0gYXdhaXQgY29sbGVjdENvbW1lbnRlcnMocm9vdENvbW1lbnQsIG9wdHMpOwogICAgcmV0dXJuIHsKICAgICAgICBzdWJqZWN0LAogICAgICAgIHJvb3RDb21tZW50LAogICAgICAgIGNvbW1lbnRlcnMKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRDb3VudChjb21tZW50KSB7CiAgICByZXR1cm4gMSArIGNvbW1lbnQucmVwbGllcy5tYXAoY29tcHV0ZUNvbW1lbnRDb3VudCkucmVkdWNlKChhLCBiKT0+YSArIGIKICAgICwgMCk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3Qgb2JqID0gb3B0cy5vYmogfHwgYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFvYmopIHJldHVybiB1bmRlZmluZWQ7CiAgICBpZiAob2JqLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvbicpIHsKICAgICAgICBjb25zdCBlbXB0eUNvbW1lbnQgPSB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcoT3JkZXJlZENvbGxlY3Rpb24pJywKICAgICAgICAgICAgcmVwbGllczogW10sCiAgICAgICAgICAgIGF0dGFjaG1lbnRzOiBbXQogICAgICAgIH07CiAgICAgICAgY29uc3Qgb3JkZXJlZENvbGxlY3Rpb24gPSBvYmo7CiAgICAgICAgYXdhaXQgY29sbGVjdENvbW1lbnRzRnJvbU9yZGVyZWRDb2xsZWN0aW9uKG9yZGVyZWRDb2xsZWN0aW9uLCBlbXB0eUNvbW1lbnQsIG9wdHMsIG5ldyBTZXQoKSk7CiAgICAgICAgcmV0dXJuIGVtcHR5Q29tbWVudDsKICAgIH0KICAgIGNvbnN0IG5vdGVPclBvZGNhc3RFcGlzb2RlID0gb2JqOwogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsobm90ZU9yUG9kY2FzdEVwaXNvZGUpOwogICAgYXdhaXQgY29sbGVjdENvbW1lbnRzKG5vdGVPclBvZGNhc3RFcGlzb2RlLCByb290Q29tbWVudCwgb3B0cywgdXJsKTsKICAgIHJldHVybiByb290Q29tbWVudDsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpIHsKICAgIGlmICgob3JkZXJlZENvbGxlY3Rpb24uaXRlbXM/Lmxlbmd0aCB8fCAwKSA+IDAgfHwgKG9yZGVyZWRDb2xsZWN0aW9uLm9yZGVyZWRJdGVtcz8ubGVuZ3RoIHx8IDApID4gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb3JkZXJlZENvbGxlY3Rpb24uaXRlbXMvb3JkZXJlZEl0ZW1zIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9yZGVyZWRDb2xsZWN0aW9uKX1gKTsKICAgIH0KICAgIGlmIChvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCA9PT0gdW5kZWZpbmVkICYmIG9yZGVyZWRDb2xsZWN0aW9uLnRvdGFsSXRlbXMgPT09IDApIHt9IGVsc2UgaWYgKHR5cGVvZiBvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICBhd2FpdCBmZXRjaFBhZ2VzKG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0LCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvcmRlcmVkQ29sbGVjdGlvbil9YCk7CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdENvbW1lbnRzKG5vdGUsIGNvbW1lbnQsIG9wdHMsIHVybCkgewogICAgY29uc3QgeyBrZWVwR29pbmcgLCBmZXRjaEFjdGl2aXR5UHViICB9ID0gb3B0czsKICAgIGNvbnN0IGZldGNoZWQgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBwb2RjYXN0RXBpc29kZUNvbW1lbnRzID0gbm90ZS50eXBlID09PSAnUG9kY2FzdEVwaXNvZGUnID8gbm90ZS5jb21tZW50cyA6IG5vdGUucmVwbGllczsKICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zdCB1cmwgPSBwb2RjYXN0RXBpc29kZUNvbW1lbnRzOwogICAgICAgICAgICBjb25zdCBvYmogPSBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFvYmopIHJldHVybjsKICAgICAgICAgICAgZmV0Y2hlZC5hZGQodXJsKTsKICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgaWYgKG9iai50eXBlID09PSAnT3JkZXJlZENvbGxlY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcmRlcmVkQ29sbGVjdGlvbiA9IG9iajsKICAgICAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RDb21tZW50c0Zyb21PcmRlcmVkQ29sbGVjdGlvbihvcmRlcmVkQ29sbGVjdGlvbiwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IG9iai50eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0ID09PSAnb2JqZWN0JyAmJiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0LnR5cGUgPT09ICdDb2xsZWN0aW9uUGFnZScpIHsKICAgICAgICAgICAgICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lml0ZW1zICYmIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QuaXRlbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lml0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QubmV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYXdhaXQgZmV0Y2hQYWdlcyhwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHQsIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3QubmV4dCBub3QgaW1wbGVtZW50ZWQgJHtwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHR9YCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBmaXJzdCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3BvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3R9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkocG9kY2FzdEVwaXNvZGVDb21tZW50cykpIHsKICAgICAgICAgICAgaWYgKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBub24tc3RhbmRhcmQgcG9kY2FzdEVwaXNvZGVDb21tZW50cyBhcnJheSBub3QgZW1wdHlgKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShwb2RjYXN0RXBpc29kZUNvbW1lbnRzLml0ZW1zKSkgewogICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5pdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3Qgb3IgaXRlbXMgYXJyYXkgbm90IGZvdW5kYCk7CiAgICAgICAgfQogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoUGFnZXModXJsLCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgLCBrZWVwR29pbmcgIH0gPSBvcHRzOwogICAgbGV0IG9iaiA9IGF3YWl0IGZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgIGlmICghb2JqKSByZXR1cm47CiAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgIGxldCBrZWVwQ29sbGVjdGluZyA9IHRydWU7CiAgICB3aGlsZShrZWVwQ29sbGVjdGluZyl7CiAgICAgICAgaWYgKG9iai50eXBlICE9PSAnQ29sbGVjdGlvblBhZ2UnICYmIG9iai50eXBlICE9PSAnT3JkZXJlZENvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2Ugb2JqLnR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFnZSA9IG9iai50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnID8gb2JqIDogb2JqOwogICAgICAgIGlmIChwYWdlLml0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLml0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvblBhZ2UnICYmIHBhZ2Uub3JkZXJlZEl0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLm9yZGVyZWRJdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZS5uZXh0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFnZS5uZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgaWYgKGZldGNoZWQuaGFzKHBhZ2UubmV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1cmwgPSBwYWdlLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9iaikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2UubmV4dCBub3QgaW1wbGVtZW50ZWQgJHtwYWdlLm5leHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0SXRlbXMoaXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCkgewogICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXsKICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmICFpdGVtLnN0YXJ0c1dpdGgoJ3snKSkgewogICAgICAgICAgICBjb25zdCByZXBseSA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmxfKGl0ZW0sIG9wdHMpOwogICAgICAgICAgICBpZiAocmVwbHkpIHsKICAgICAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW1PYmogPSB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKGl0ZW0pIDogaXRlbTsKICAgICAgICAgICAgY29uc3QgcmVwbHkgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsoaXRlbU9iaik7CiAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgb3B0cy53YXJuKHJlcGx5LCB1cmwsICdGb3VuZCBpdGVtIGluY29ycmVjdGx5IGRvdWJsZSBlbmNvZGVkIGFzIGEganNvbiBzdHJpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMoaXRlbSwgcmVwbHksIG9wdHMsIHVybCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVOb3RlQ29udGVudChub3RlKSB7CiAgICBjb25zdCB7IGNvbnRlbnQgLCBjb250ZW50TWFwICB9ID0gbm90ZTsKICAgIGlmIChjb250ZW50ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGNvbnRlbnQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUuY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3R5cGVvZiBjb250ZW50fSAke0pTT04uc3RyaW5naWZ5KG5vdGUpfWApOwogICAgaWYgKGNvbnRlbnRNYXAgIT09IHVuZGVmaW5lZCAmJiAhaXNTdHJpbmdSZWNvcmQoY29udGVudE1hcCkpIHRocm93IG5ldyBFcnJvcihgVE9ETzogTm90ZS5jb250ZW50TWFwIHR5cGUgbm90IGltcGxlbWVudGVkICR7dHlwZW9mIGNvbnRlbnRNYXB9ICR7SlNPTi5zdHJpbmdpZnkobm90ZSl9YCk7CiAgICBpZiAoY29udGVudCA9PT0gdW5kZWZpbmVkICYmIGNvbnRlbnRNYXAgPT09IHVuZGVmaW5lZCkgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmNvbnRlbnQgYW5kIGNvbnRlbnRNYXAgdW5kZWZpbmVkICR7SlNPTi5zdHJpbmdpZnkobm90ZSl9YCk7CiAgICBpZiAoY29udGVudCkgcmV0dXJuIGNvbnRlbnQ7CiAgICBmb3IgKGNvbnN0IFtfbmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKGNvbnRlbnRNYXAgfHwge30pKXsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUuY29udGVudE1hcCBlbXB0eSAke0pTT04uc3RyaW5naWZ5KG5vdGUpfWApOwp9CmZ1bmN0aW9uIGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhvYmplY3QpIHsKICAgIGlmIChvYmplY3QudHlwZSA9PT0gJ05vdGUnKSB7CiAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gLCBwdWJsaXNoZWQgLCBpZCAgfSA9IG9iamVjdDsKICAgICAgICBjb25zdCB1cmwgPSAob2JqZWN0LnVybCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdC51cmwpIHx8IGlkOwogICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlZFRvICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBwdWJsaXNoZWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUucHVibGlzaGVkIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodXJsICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogTm90ZS51cmwgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IGNvbnRlbnQgPSBjb21wdXRlTm90ZUNvbnRlbnQob2JqZWN0KTsKICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYXR0cmlidXRlZFRvLAogICAgICAgICAgICBjb250ZW50LAogICAgICAgICAgICBwdWJsaXNoZWQsCiAgICAgICAgICAgIHJlcGxpZXM6IFtdLAogICAgICAgICAgICBhdHRhY2htZW50cwogICAgICAgIH07CiAgICB9CiAgICBpZiAob2JqZWN0LnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScpIHsKICAgICAgICBjb25zdCBwb2RjYXN0RXBpc29kZSA9IG9iamVjdDsKICAgICAgICBjb25zdCB7IGF0dHJpYnV0ZWRUbyAsIHB1Ymxpc2hlZCAsIGRlc2NyaXB0aW9uICwgaW1hZ2UgIH0gPSBwb2RjYXN0RXBpc29kZTsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZWRUbyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuYXR0cmlidXRlZFRvIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIHB1Ymxpc2hlZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUucHVibGlzaGVkIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIGRlc2NyaXB0aW9uICE9PSAnb2JqZWN0JyB8fCBkZXNjcmlwdGlvbi50eXBlICE9PSAnTm90ZScpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuZGVzY3JpcHRpb24gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IHsgY29udGVudCAgfSA9IGRlc2NyaXB0aW9uOwogICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3R5cGVvZiBjb250ZW50fSAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgY29uc3QgdXJsID0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gaW1hZ2UgPyBbCiAgICAgICAgICAgIGNvbXB1dGVBdHRhY2htZW50KGltYWdlKQogICAgICAgIF0gOiBbXTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGF0dHJpYnV0ZWRUbywKICAgICAgICAgICAgY29udGVudCwKICAgICAgICAgICAgcHVibGlzaGVkLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHMKICAgICAgICB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBpdGVtIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKfQpmdW5jdGlvbiBjb21wdXRlQXR0YWNobWVudHMob2JqZWN0KSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgaWYgKCFvYmplY3QuYXR0YWNobWVudCkgcmV0dXJuIHJ0OwogICAgY29uc3QgYXR0YWNobWVudHMgPSBpc1JlYWRvbmx5QXJyYXkob2JqZWN0LmF0dGFjaG1lbnQpID8gb2JqZWN0LmF0dGFjaG1lbnQgOiBbCiAgICAgICAgb2JqZWN0LmF0dGFjaG1lbnQKICAgIF07CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgYXR0YWNobWVudHMpewogICAgICAgIHJ0LnB1c2goY29tcHV0ZUF0dGFjaG1lbnQoYXR0YWNobWVudCkpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50KG9iamVjdCkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdC50eXBlICE9PSAnRG9jdW1lbnQnICYmIG9iamVjdC50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGF0dGFjaG1lbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgY29uc3QgeyBtZWRpYVR5cGUgLCB3aWR0aCAsIGhlaWdodCAsIHVybCAgfSA9IG9iamVjdDsKICAgIGlmICh0eXBlb2YgbWVkaWFUeXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBtZWRpYVR5cGUgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKHdpZHRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHdpZHRoICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB3aWR0aCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICBpZiAoaGVpZ2h0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGhlaWdodCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcihgVE9ETzogaGVpZ2h0IHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB1cmwgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZWRpYVR5cGUsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHVybAogICAgfTsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudGVycyhjb21tZW50LCBvcHRzKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9zID0gbmV3IFNldCgpOwogICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcyk7CiAgICBjb25zdCBydCA9IG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlZFRvIG9mIGF0dHJpYnV0ZWRUb3MpewogICAgICAgIGNvbnN0IGNvbW1lbnRlciA9IGF3YWl0IGZldGNoQ29tbWVudGVyKGF0dHJpYnV0ZWRUbywgb3B0cyk7CiAgICAgICAgaWYgKCFjb21tZW50ZXIpIHJldHVybiBydDsKICAgICAgICBydC5zZXQoYXR0cmlidXRlZFRvLCBjb21tZW50ZXIpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoQ29tbWVudGVyKHVybCwgb3B0cykgewogICAgY29uc3Qgb2JqID0gYXdhaXQgb3B0cy5mZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHBlcnNvbiA9IG9iajsKICAgIHJldHVybiBjb21wdXRlQ29tbWVudGVyKHBlcnNvbik7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pIHsKICAgIGxldCBpY29uMTsKICAgIGlmIChwZXJzb24uaWNvbikgewogICAgICAgIGlmICh0eXBlb2YgcGVyc29uLmljb24gIT09ICdvYmplY3QnIHx8IGlzUmVhZG9ubHlBcnJheShwZXJzb24uaWNvbikgfHwgcGVyc29uLmljb24udHlwZSAhPT0gJ0ltYWdlJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5pY29uIG5vdCBpbXBsZW1lbnRlZDogJHtKU09OLnN0cmluZ2lmeShwZXJzb24uaWNvbil9YCk7CiAgICAgICAgaWNvbjEgPSBjb21wdXRlSWNvbihwZXJzb24uaWNvbik7CiAgICB9CiAgICBjb25zdCB7IG5hbWUgLCB1cmw6IGFwVXJsICwgaWQgIH0gPSBwZXJzb247CiAgICBpZiAodHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLm5hbWUgbm90IGltcGxlbWVudGVkOiAke25hbWV9YCk7CiAgICBpZiAoYXBVcmwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgYXBVcmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLnVybCBub3QgaW1wbGVtZW50ZWQ6ICR7YXBVcmx9YCk7CiAgICBjb25zdCB1cmwgPSBhcFVybCB8fCBpZDsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi51cmwgbm90IGltcGxlbWVudGVkOiAke3VybH1gKTsKICAgIGNvbnN0IGZxVXNlcm5hbWUgPSBjb21wdXRlRnFVc2VybmFtZSh1cmwsIHBlcnNvbi5wcmVmZXJyZWRVc2VybmFtZSk7CiAgICByZXR1cm4gewogICAgICAgIGljb246IGljb24xLAogICAgICAgIG5hbWUsCiAgICAgICAgdXJsLAogICAgICAgIGZxVXNlcm5hbWUKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUljb24oaWNvbjIpIHsKICAgIGNvbnN0IHsgdXJsICwgbWVkaWFUeXBlICB9ID0gaWNvbjI7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBpY29uLnVybCBub3QgaW1wbGVtZW50ZWQ6ICR7dXJsfWApOwogICAgaWYgKG1lZGlhVHlwZSAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBtZWRpYVR5cGUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gaWNvbi5tZWRpYVR5cGUgbm90IGltcGxlbWVudGVkOiAke21lZGlhVHlwZX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgdXJsLAogICAgICAgIG1lZGlhVHlwZQogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlRnFVc2VybmFtZSh1cmwsIHByZWZlcnJlZFVzZXJuYW1lKSB7CiAgICBjb25zdCB1ID0gbmV3IFVSTCh1cmwpOwogICAgY29uc3QgbSA9IC9eXC8oQFteXC9dKykkLy5leGVjKHUucGF0aG5hbWUpOwogICAgY29uc3QgdXNlcm5hbWUgPSBtID8gbVsxXSA6IHByZWZlcnJlZFVzZXJuYW1lOwogICAgaWYgKCF1c2VybmFtZSkgdGhyb3cgbmV3IEVycm9yKGBVbmFibGUgdG8gY29tcHV0ZSB1c2VybmFtZSBmcm9tIHVybDogJHt1cmx9YCk7CiAgICByZXR1cm4gYCR7dXNlcm5hbWV9QCR7dS5ob3N0bmFtZX1gOwp9CmZ1bmN0aW9uIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKGNvbW1lbnQsIGF0dHJpYnV0ZWRUb3MpIHsKICAgIGlmIChjb21tZW50LmF0dHJpYnV0ZWRUbykgYXR0cmlidXRlZFRvcy5hZGQoY29tbWVudC5hdHRyaWJ1dGVkVG8pOwogICAgZm9yIChjb25zdCByZXBseSBvZiBjb21tZW50LnJlcGxpZXMpewogICAgICAgIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKHJlcGx5LCBhdHRyaWJ1dGVkVG9zKTsKICAgIH0KfQpmdW5jdGlvbiBpc1BvZGNhc3RJbWFnZXNTcmNTZXQodHJpbW1lZFRleHQpIHsKICAgIGNvbnN0IHdpZHRocyA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IGRlbnNpdGllcyA9IG5ldyBTZXQoKTsKICAgIGxldCB3aXRoV2lkdGhDb3VudCA9IDA7CiAgICBjb25zdCBwaWVjZXMgPSB0cmltbWVkVGV4dC5zcGxpdCgvLFxzKy8pOwogICAgZm9yIChjb25zdCBwaWVjZSBvZiBwaWVjZXMpewogICAgICAgIGNvbnN0IG0gPSAvXihbXlxzXSspKFxzKyhcZCt3fFxkKyhcLlxkKyk/eCkpPyQvLmV4ZWMocGllY2UpOwogICAgICAgIGlmICghbSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGNvbnN0IHVybCA9IG1bMV07CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IG1bM10gfHwgJyc7CiAgICAgICAgaWYgKCFpc1VybCh1cmwpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IuZW5kc1dpdGgoJ3cnKSkgewogICAgICAgICAgICB3aXRoV2lkdGhDb3VudCsrOwogICAgICAgICAgICBjb25zdCB3aWR0aCA9IHBhcnNlSW50KGRlc2NyaXB0b3Iuc3Vic3RyaW5nKDAsIGRlc2NyaXB0b3IubGVuZ3RoIC0gMSkpOwogICAgICAgICAgICBpZiAod2lkdGggPD0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAod2lkdGhzLmhhcyh3aWR0aCkpIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgd2lkdGhzLmFkZCh3aWR0aCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgZGVuc2l0eSA9IGRlc2NyaXB0b3IuZW5kc1dpdGgoJ3gnKSA/IHBhcnNlRmxvYXQoZGVzY3JpcHRvci5zdWJzdHJpbmcoMCwgZGVzY3JpcHRvci5sZW5ndGggLSAxKSkgOiAxOwogICAgICAgICAgICBpZiAoZGVuc2l0eSA8PSAwKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGlmIChkZW5zaXRpZXMuaGFzKGRlbnNpdHkpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIGRlbnNpdGllcy5hZGQoZGVuc2l0eSk7CiAgICAgICAgfQogICAgfQogICAgaWYgKHdpdGhXaWR0aENvdW50ID4gMCAmJiB3aXRoV2lkdGhDb3VudCAhPT0gcGllY2VzLmxlbmd0aCkgcmV0dXJuIGZhbHNlOwogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gaXNOb3RFbXB0eSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIHRyaW1tZWRUZXh0Lmxlbmd0aCA+IDA7Cn0KZnVuY3Rpb24gaXNVcmwodHJpbW1lZFRleHQpIHsKICAgIGNvbnN0IHUgPSB0cnlQYXJzZVVybCh0cmltbWVkVGV4dCk7CiAgICByZXR1cm4gdSAmJiB1LnByb3RvY29sID09PSAnaHR0cHM6JyB8fCB1Py5wcm90b2NvbCA9PT0gJ2h0dHA6JzsKfQpmdW5jdGlvbiBpc1VyaSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIHRyeVBhcnNlVXJsKHRyaW1tZWRUZXh0KSAhPT0gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGlzTWltZVR5cGUodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlx3K1wvWy0rLlx3XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1V1aWQodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzRW1haWxBZGRyZXNzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bXkBcc10rQFteQFxzXSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0F0TW9zdENoYXJhY3RlcnMobWF4Q2hhcmFjdGVycykgewogICAgcmV0dXJuICh0cmltbWVkVGV4dCk9PnRyaW1tZWRUZXh0Lmxlbmd0aCA8PSBtYXhDaGFyYWN0ZXJzCiAgICA7Cn0KZnVuY3Rpb24gaXNTZWNvbmRzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZCsoXC5cZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzR2VvTGF0TG9uKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15nZW86LT9cZHsxLDJ9KFwuXGQrKT8sLT9cZHsxLDN9KFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc09wZW5TdHJlZXRNYXBJZGVudGlmaWVyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bTldSXVxkKygjXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc05vbk5lZ2F0aXZlSW50ZWdlcih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrJC8udGVzdCh0cmltbWVkVGV4dCkgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpID49IDAgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpLnRvU3RyaW5nKCkgPT09IHRyaW1tZWRUZXh0Owp9CmZ1bmN0aW9uIGlzRGVjaW1hbCh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrKFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1JmYzI4MjIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlBLVphLXosIF0rIFxkezJ9OlxkezJ9KDpcZHsyfSk/ICgtP1swLTldK3xbQS1aXXszLH0pJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNJc284NjAxKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZHs0fS1cZHsyfS1cZHsyfVRcZHsyfTpcZHsyfTpcZHsyfShcLlxkKyk/WiQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzQm9vbGVhbih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eKHRydWV8ZmFsc2UpJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0VmFsdWVUeXBlU2x1Zyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW2Etel0rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0TWVkaXVtKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bYS16XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybChzdHIsIGJhc2UpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwoc3RyLCBiYXNlKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcykgewogICAgaWYgKHhtbC50YWduYW1lICE9PSAnIXhtbCcpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBCYWQgeG1sLnRhZ25hbWU6ICR7eG1sLnRhZ25hbWV9YCk7CiAgICBpZiAoT2JqZWN0LmtleXMoeG1sLmF0dHJzTWFwKS5sZW5ndGggPiAwKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC5hdHRyc01hcDogJHt4bWwuYXR0cnNNYXB9YCk7CiAgICBjb25zdCBkb2NFbGVtZW50ID0gT2JqZWN0LnZhbHVlcyh4bWwuY2hpbGQpLmZsYXRNYXAoKHYpPT52CiAgICApWzBdOwogICAgaWYgKCFkb2NFbGVtZW50KSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgTm8geG1sIHJvb3QgZWxlbWVudGApOwogICAgdmFsaWRhdGVSc3MoZG9jRWxlbWVudCwgY2FsbGJhY2tzKTsKfQpmdW5jdGlvbiBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoaHJlZikgewogICAgcmV0dXJuIHsKICAgICAgICBydWxlc2V0OiAncG9kY2FzdGluZGV4JywKICAgICAgICBocmVmCiAgICB9Owp9CmZ1bmN0aW9uIGdldFNpbmdsZUNoaWxkKG5vZGUsIG5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHt9KSB7CiAgICBjb25zdCBjaGlsZHJlbiA9IGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIHsKICAgICAgICBuYW1lCiAgICB9KTsKICAgIGlmIChjaGlsZHJlbi5sZW5ndGggIT09IDEpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBFeHBlY3RlZCBzaW5nbGUgPCR7bmFtZX0+IGNoaWxkIGVsZW1lbnQgdW5kZXIgPCR7bm9kZS50YWduYW1lfT4sIGZvdW5kICR7Y2hpbGRyZW4ubGVuZ3RoID09PSAwID8gJ25vbmUnIDogY2hpbGRyZW4ubGVuZ3RofWAsIG9wdHMpOwogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgICByZXR1cm4gY2hpbGRyZW5bMF07Cn0KZnVuY3Rpb24gdmFsaWRhdGVSc3MocnNzLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdyc3MnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9jeWJlci5oYXJ2YXJkLmVkdS9yc3MvcnNzLmh0bWwjd2hhdElzUnNzJwogICAgICAgIH0KICAgIH07CiAgICBpZiAocnNzLnRhZ25hbWUgIT09ICdyc3MnKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IocnNzLCBgQmFkIHhtbCByb290IHRhZzogJHtyc3MudGFnbmFtZX0sIGV4cGVjdGVkIHJzc2AsIG9wdHMpOwogICAgY29uc3QgdmVyc2lvbiA9IHJzcy5hdHRzLmdldCgndmVyc2lvbicpOwogICAgaWYgKHZlcnNpb24gIT09ICcyLjAnKSBjYWxsYmFja3Mub25XYXJuaW5nKHJzcywgYEJhZCByc3MudmVyc2lvbjogJHt2ZXJzaW9ufSwgZXhwZWN0ZWQgMi4wYCwgb3B0cyk7CiAgICBjb25zdCBpdHVuZXNPcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAnaXR1bmVzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vcG9kY2FzdGVycy5hcHBsZS5jb20vc3VwcG9ydC84MjMtcG9kY2FzdC1yZXF1aXJlbWVudHMjOn46dGV4dD1Qb2RjYXN0JTIwUlNTJTIwZmVlZCUyMHRlY2huaWNhbCUyMHJlcXVpcmVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgaGFzSXR1bmVzUHJlZml4ID0gZmluZEVsZW1lbnRSZWN1cnNpdmUocnNzLCAodik9PnYudGFnbmFtZS5zdGFydHNXaXRoKCdpdHVuZXM6JykKICAgICkgIT09IHVuZGVmaW5lZDsKICAgIGlmIChoYXNJdHVuZXNQcmVmaXgpIGNoZWNrQXR0cmlidXRlRXF1YWwocnNzLCAneG1sbnM6aXR1bmVzJywgJ2h0dHA6Ly93d3cuaXR1bmVzLmNvbS9kdGRzL3BvZGNhc3QtMS4wLmR0ZCcsIGNhbGxiYWNrcywgaXR1bmVzT3B0cyk7CiAgICBjb25zdCBoYXNDb250ZW50UHJlZml4ID0gZmluZEVsZW1lbnRSZWN1cnNpdmUocnNzLCAodik9PnYudGFnbmFtZS5zdGFydHNXaXRoKCdjb250ZW50OicpCiAgICApICE9PSB1bmRlZmluZWQ7CiAgICBpZiAoaGFzQ29udGVudFByZWZpeCkgY2hlY2tBdHRyaWJ1dGVFcXVhbChyc3MsICd4bWxuczpjb250ZW50JywgJ2h0dHA6Ly9wdXJsLm9yZy9yc3MvMS4wL21vZHVsZXMvY29udGVudC8nLCBjYWxsYmFja3MsIGl0dW5lc09wdHMpOwogICAgY29uc3QgY2hhbm5lbCA9IGdldFNpbmdsZUNoaWxkKHJzcywgJ2NoYW5uZWwnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgaWYgKCFjaGFubmVsKSByZXR1cm47CiAgICB2YWxpZGF0ZUNoYW5uZWwoY2hhbm5lbCwgY2FsbGJhY2tzKTsKfQpmdW5jdGlvbiB2YWxpZGF0ZUNoYW5uZWwoY2hhbm5lbCwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBvcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI3JlcXVpcmVkQ2hhbm5lbEVsZW1lbnRzJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCB0aXRsZSA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICd0aXRsZScsIGNhbGxiYWNrcywgb3B0cyk7CiAgICBjaGVja1RleHQodGl0bGUsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgb3B0cyk7CiAgICBjb25zdCBsaW5rID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ2xpbmsnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KGxpbmssIGlzVXJsLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY29uc3QgZGVzY3JpcHRpb24gPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAnZGVzY3JpcHRpb24nLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KGRlc2NyaXB0aW9uLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIG9wdHMpOwogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2d1aWQnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5ndWlkKS5jaGVja1ZhbHVlKGlzVXVpZCwgKGd1aWRUZXh0KT0+ewogICAgICAgIGNvbnN0IHZlcnNpb24gPSBndWlkVGV4dC5jaGFyQXQoMTQpOwogICAgICAgIGlmICh2ZXJzaW9uICE9PSAnNScpIHsKICAgICAgICAgICAgcmV0dXJuIGBleHBlY3RlZCBhIFVVSUR2NSwgZm91bmQgYSBVVUlEdiR7dmVyc2lvbn1gOwogICAgICAgIH0KICAgIH0pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xvY2tlZCcpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxvY2tlZCkuY2hlY2tWYWx1ZSgodik9Pi9eKHllc3xubykkLy50ZXN0KHYpCiAgICApLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ293bmVyJywgaXNFbWFpbEFkZHJlc3MpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgZm9yIChjb25zdCBmdW5kaW5nIG9mIGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZnVuZGluZykpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2NoYW5uZWwnLCBmdW5kaW5nLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2Z1bmRpbmcnKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RQZXJzb24oJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY2hlY2tQb2RjYXN0TG9jYXRpb24oJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgZm9yIChjb25zdCB0cmFpbGVyIG9mIGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudHJhaWxlcikpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2NoYW5uZWwnLCB0cmFpbGVyLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3RyYWlsZXInKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncHViZGF0ZScsIGlzUmZjMjgyMikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGVuZ3RoJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3R5cGUnLCBpc01pbWVUeXBlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdzZWFzb24nLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RMaWNlbnNlKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdFZhbHVlKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNtZWRpdW0nKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5tZWRpdW0pLmNoZWNrVmFsdWUoaXNQb2RjYXN0TWVkaXVtKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGNoZWNrUG9kY2FzdEltYWdlcygnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjb25zdCBzb2NpYWxzID0gZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb2NpYWwpOwogICAgY29uc3Qgc29jaWFsUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9zb2NpYWwvc29jaWFsLm1kI3NvY2lhbC1lbGVtZW50Jyk7CiAgICBjb25zdCBzb2NpYWxTaWduVXBSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9wcm9wb3NhbC1kb2NzL3NvY2lhbC9zb2NpYWwubWQjc29jaWFsc2lnbnVwLWVsZW1lbnQnKTsKICAgIGZvciAoY29uc3Qgc29jaWFsIG9mIHNvY2lhbHMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2NoYW5uZWwnLCBzb2NpYWwsIGNhbGxiYWNrcywgc29jaWFsUmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwbGF0Zm9ybScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3Byb3RvY29sJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnYWNjb3VudElkJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnYWNjb3VudFVybCcsIGlzVXJsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwcmlvcml0eScsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjb25zdCBzb2NpYWxTaWduVXBzID0gZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb2NpYWxTaWduVXApOwogICAgICAgIGZvciAoY29uc3Qgc29jaWFsU2lnblVwIG9mIHNvY2lhbFNpZ25VcHMpewogICAgICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdzb2NpYWwnLCBzb2NpYWxTaWduVXAsIGNhbGxiYWNrcywgc29jaWFsU2lnblVwUmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdob21lVXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3NpZ25VcFVybCcsIGlzVXJsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwcmlvcml0eScsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zdCBiYWRTb2NpYWxTaWdudXBzID0gZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb2NpYWxTaWduVXApOwogICAgaWYgKGJhZFNvY2lhbFNpZ251cHMubGVuZ3RoID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcoYmFkU29jaWFsU2lnbnVwc1swXSwgYEJhZCA8JHtiYWRTb2NpYWxTaWdudXBzWzBdLnRhZ25hbWV9Pjogc2hvdWxkIGJlIGEgY2hpbGQgb2YgPHBvZGNhc3Q6c29jaWFsPiwgbm90IGNoYW5uZWxgKTsKICAgIH0KICAgIGNvbnN0IHBvZHBpbmdSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9wcm9wb3NhbC1kb2NzL3BvZHBpbmcvcG9kcGluZy5tZCNzcGVjaWZpY2F0aW9uJyk7CiAgICBjb25zdCBwb2RwaW5nID0gRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MsIHBvZHBpbmdSZWZlcmVuY2UsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgucG9kcGluZykuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgndXNlc1BvZHBpbmcnLCBpc0Jvb2xlYW4pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpLm5vZGU7CiAgICBpZiAocG9kcGluZykgewogICAgICAgIGZvciAoY29uc3QgaGl2ZUFjY291bnQgb2YgZmluZENoaWxkRWxlbWVudHMocG9kcGluZywgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5oaXZlQWNjb3VudCkpewogICAgICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdwb2RwaW5nJywgaGl2ZUFjY291bnQsIGNhbGxiYWNrcywgcG9kcGluZ1JlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnYWNjb3VudCcsIGlzTm90RW1wdHkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNoZWNrUG9kY2FzdFRhZ1VzYWdlKGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjb25zdCBpdGVtcyA9IGNoYW5uZWwuY2hpbGQuaXRlbSB8fCBbXTsKICAgIGxldCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQgPSAwOwogICAgbGV0IGl0ZW1zVmFsaWRhdGVkID0gMDsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcyl7CiAgICAgICAgaWYgKGl0ZW1zVmFsaWRhdGVkIDwgMSkgewogICAgICAgICAgICB2YWxpZGF0ZUl0ZW0oaXRlbSwgY2FsbGJhY2tzKTsKICAgICAgICAgICAgaXRlbXNWYWxpZGF0ZWQrKzsKICAgICAgICB9CiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCB7CiAgICAgICAgICAgIG5hbWU6ICdlbmNsb3N1cmUnCiAgICAgICAgfSk7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDApIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCsrOwogICAgfQogICAgY2FsbGJhY2tzLm9uUnNzSXRlbXNGb3VuZChpdGVtcy5sZW5ndGgsIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCk7Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0UGVyc29uKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIGZvciAoY29uc3QgcGVyc29uIG9mIGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgucGVyc29uKSl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudChsZXZlbCwgcGVyc29uLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3BlcnNvbicpKS5jaGVja1ZhbHVlKGlzTm90RW1wdHkpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3JvbGUnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdncm91cCcsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2ltZycsIGlzVXJsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdocmVmJywgaXNVcmwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdExvY2F0aW9uKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xvY2F0aW9uJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubG9jYXRpb24pLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2dlbycsIGlzR2VvTGF0TG9uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdvc20nLCBpc09wZW5TdHJlZXRNYXBJZGVudGlmaWVyKS5jaGVja1ZhbHVlKGlzTm90RW1wdHkpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdExpY2Vuc2UobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcykgewogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbGljZW5zZScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxpY2Vuc2UpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1ZhbHVlKGlzTm90RW1wdHkpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFZhbHVlKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IHZhbHVlID0gRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdmFsdWUnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC52YWx1ZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzUG9kY2FzdFZhbHVlVHlwZVNsdWcpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ21ldGhvZCcsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3N1Z2dlc3RlZCcsIGlzRGVjaW1hbCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkubm9kZTsKICAgIGlmICh2YWx1ZSkgewogICAgICAgIGZvciAoY29uc3QgdmFsdWVSZWNpcGllbnQgb2YgZmluZENoaWxkRWxlbWVudHModmFsdWUsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudmFsdWVSZWNpcGllbnQpKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgndmFsdWUnLCB2YWx1ZVJlY2lwaWVudCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN2YWx1ZS1yZWNpcGllbnQnKSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbmFtZScsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2N1c3RvbUtleScsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2N1c3RvbVZhbHVlJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzUG9kY2FzdFZhbHVlVHlwZVNsdWcpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FkZHJlc3MnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdzcGxpdCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdmZWUnLCBpc0Jvb2xlYW4pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RJbWFnZXMobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcykgewogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjaW1hZ2VzJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguaW1hZ2VzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdzcmNzZXQnLCBpc1BvZGNhc3RJbWFnZXNTcmNTZXQpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFRhZ1VzYWdlKG5vZGUsIGNhbGxiYWNrcykgewogICAgY29uc3Qga25vd24gPSBuZXcgU2V0KCk7CiAgICBjb25zdCB1bmtub3duID0gbmV3IFNldCgpOwogICAgY29uc3QgbmFtZXNwYWNlVXJpcyA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgZWxlbWVudCBvZiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4Lk5BTUVTUEFDRVMubWFwKCh2KT0+KHsKICAgICAgICAgICAgbmFtZTogJyonLAogICAgICAgICAgICBuYW1lc3BhY2VVcmk6IHYKICAgICAgICB9KQogICAgKSkpewogICAgICAgIGNvbnN0IGlzS25vd24gPSBRbmFtZXMuUG9kY2FzdEluZGV4LktOT1dOX05BTUVTLmhhcyhlbGVtZW50LnFuYW1lLm5hbWUpOwogICAgICAgIChpc0tub3duID8ga25vd24gOiB1bmtub3duKS5hZGQoZWxlbWVudC5xbmFtZS5uYW1lKTsKICAgICAgICBpZiAoZWxlbWVudC5xbmFtZS5uYW1lc3BhY2VVcmkpIG5hbWVzcGFjZVVyaXMuYWRkKGVsZW1lbnQucW5hbWUubmFtZXNwYWNlVXJpKTsKICAgIH0KICAgIGlmIChrbm93bi5zaXplICsgdW5rbm93bi5zaXplID4gMCkgewogICAgICAgIGNhbGxiYWNrcy5vblBvZGNhc3RJbmRleFRhZ05hbWVzRm91bmQoa25vd24sIHVua25vd24sIG5hbWVzcGFjZVVyaXMpOwogICAgfQp9CmZ1bmN0aW9uIGNoZWNrQXR0cmlidXRlRXF1YWwobm9kZSwgYXR0TmFtZSwgYXR0RXhwZWN0ZWRWYWx1ZSwgY2FsbGJhY2tzLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IGF0dFZhbHVlID0gbm9kZS5hdHRzLmdldChhdHROYW1lKTsKICAgIGlmICghYXR0VmFsdWUpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nIDwke25vZGUudGFnbmFtZX0+ICR7YXR0TmFtZX0gYXR0cmlidXRlLCBleHBlY3RlZCAke2F0dEV4cGVjdGVkVmFsdWV9YCwgb3B0cyk7CiAgICB9IGVsc2UgaWYgKGF0dFZhbHVlICE9PSBhdHRFeHBlY3RlZFZhbHVlKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+ICR7YXR0TmFtZX0gYXR0cmlidXRlIHZhbHVlOiAke2F0dFZhbHVlfSwgZXhwZWN0ZWQgJHthdHRFeHBlY3RlZFZhbHVlfWAsIG9wdHMpOwogICAgfQp9CmZ1bmN0aW9uIGNoZWNrVGV4dChub2RlLCB0ZXN0LCBjYWxsYmFja3MsIG9wdHMgPSB7fSkgewogICAgaWYgKG5vZGUpIHsKICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IChub2RlLnZhbCB8fCAnJykudHJpbSgpOwogICAgICAgIGlmICghdGVzdCh0cmltbWVkVGV4dCkpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+IHZhbHVlOiAke3RyaW1tZWRUZXh0ID09PSAnJyA/ICc8ZW1wdHk+JyA6IHRyaW1tZWRUZXh0fWAsIG9wdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpbW1lZFRleHQ7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZpbmRGaXJzdENoaWxkRWxlbWVudChub2RlLCBxbmFtZSwgY2FsbGJhY2tzLCBvcHRzID0ge30pIHsKICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMobm9kZSwgcW5hbWUpOwogICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA9PT0gMCkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEl0ZW0gaXMgbWlzc2luZyBhbiA8JHtxbmFtZS5uYW1lfT4gZWxlbWVudGAsIG9wdHMpOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoID4gMSkgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgSXRlbSBoYXMgbXVsdGlwbGUgPCR7cW5hbWUubmFtZX0+IGVsZW1lbnRzYCwgb3B0cyk7CiAgICAgICAgcmV0dXJuIGVsZW1lbnRzWzBdOwogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiB2YWxpZGF0ZUl0ZW0oaXRlbSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBpdHVuZXNPcHRzMSA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL3BvZGNhc3RlcnMuYXBwbGUuY29tL3N1cHBvcnQvODIzLXBvZGNhc3QtcmVxdWlyZW1lbnRzIzp+OnRleHQ9UG9kY2FzdCUyMFJTUyUyMGZlZWQlMjB0ZWNobmljYWwlMjByZXF1aXJlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IGl0dW5lc09wdHMyID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAnaXR1bmVzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vaGVscC5hcHBsZS5jb20vaXRjL3BvZGNhc3RzX2Nvbm5lY3QvIy9pdGNiNTQzNTMzOTAnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IHRpdGxlID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAndGl0bGUnCiAgICB9LCBjYWxsYmFja3MsIGl0dW5lc09wdHMyKTsKICAgIGlmICh0aXRsZSkgewogICAgICAgIGNoZWNrVGV4dCh0aXRsZSwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICB9CiAgICBjb25zdCBlbmNsb3N1cmUgPSBmaW5kRmlyc3RDaGlsZEVsZW1lbnQoaXRlbSwgewogICAgICAgIG5hbWU6ICdlbmNsb3N1cmUnCiAgICB9LCBjYWxsYmFja3MsIGl0dW5lc09wdHMyKTsKICAgIGlmIChlbmNsb3N1cmUpIHsKICAgICAgICBjb25zdCByc3NFbmNsb3N1cmVPcHRzID0gewogICAgICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgICAgIHJ1bGVzZXQ6ICdyc3MnLAogICAgICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI2x0ZW5jbG9zdXJlZ3RTdWJlbGVtZW50T2ZMdGl0ZW1ndCcKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3QgdXJsID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCd1cmwnKTsKICAgICAgICBpZiAoIXVybCkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nIGl0ZW0gPGVuY2xvc3VyZT4gdXJsIGF0dHJpYnV0ZWAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGlmICh1cmwgJiYgIWlzVXJsKHVybCkpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgQmFkIGl0ZW0gPGVuY2xvc3VyZT4gdXJsIGF0dHJpYnV0ZSB2YWx1ZTogJHt1cmx9LCBleHBlY3RlZCB1cmxgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBjb25zdCBsZW5ndGggPSBlbmNsb3N1cmUuYXR0cy5nZXQoJ2xlbmd0aCcpOwogICAgICAgIGlmICghbGVuZ3RoKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgPGVuY2xvc3VyZT4gbGVuZ3RoIGF0dHJpYnV0ZWAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGlmIChsZW5ndGggJiYgIWlzTm9uTmVnYXRpdmVJbnRlZ2VyKGxlbmd0aCkpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgQmFkIGl0ZW0gPGVuY2xvc3VyZT4gbGVuZ3RoIGF0dHJpYnV0ZSB2YWx1ZTogJHtsZW5ndGh9LCBleHBlY3RlZCBub24tbmVnYXRpdmUgaW50ZWdlcmAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGNvbnN0IHR5cGUgPSBlbmNsb3N1cmUuYXR0cy5nZXQoJ3R5cGUnKTsKICAgICAgICBpZiAoIXR5cGUpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgTWlzc2luZyA8ZW5jbG9zdXJlPiB0eXBlIGF0dHJpYnV0ZWAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGlmICh0eXBlICYmICFpc01pbWVUeXBlKHR5cGUpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IHR5cGUgYXR0cmlidXRlIHZhbHVlOiAke3R5cGV9LCBleHBlY3RlZCBNSU1FIHR5cGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgIH0KICAgIGNvbnN0IGd1aWQgPSBmaW5kRmlyc3RDaGlsZEVsZW1lbnQoaXRlbSwgewogICAgICAgIG5hbWU6ICdndWlkJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMSk7CiAgICBpZiAoZ3VpZCkgewogICAgICAgIGNvbnN0IGd1aWRUZXh0ID0gY2hlY2tUZXh0KGd1aWQsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgaXR1bmVzT3B0czEpOwogICAgICAgIGNvbnN0IHJzc0d1aWRPcHRzID0gewogICAgICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgICAgIHJ1bGVzZXQ6ICdyc3MnLAogICAgICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI2x0Z3VpZGd0U3ViZWxlbWVudE9mTHRpdGVtZ3QnCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IG1pc3NwZWxsaW5ncyA9IFsKICAgICAgICAgICAgLi4uZ3VpZC5hdHRzLmtleXMoKQogICAgICAgIF0uZmlsdGVyKCh2KT0+diAhPT0gJ2lzUGVybWFMaW5rJyAmJiB2LnRvTG93ZXJDYXNlKCkgPT09ICdpc3Blcm1hbGluaycKICAgICAgICApOwogICAgICAgIGZvciAoY29uc3QgbWlzc3BlbGxpbmcgb2YgbWlzc3BlbGxpbmdzKXsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkIGl0ZW0gPGd1aWQ+IGlzUGVybWFMaW5rIGF0dHJpYnV0ZSBzcGVsbGluZzogJHttaXNzcGVsbGluZ31gLCByc3NHdWlkT3B0cyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGlzUGVybWFMaW5rID0gZ3VpZC5hdHRzLmdldCgnaXNQZXJtYUxpbmsnKSB8fCAndHJ1ZSc7CiAgICAgICAgaWYgKGlzUGVybWFMaW5rID09PSAndHJ1ZScgJiYgZ3VpZFRleHQgJiYgIWlzVXJsKGd1aWRUZXh0KSAmJiBtaXNzcGVsbGluZ3MubGVuZ3RoID09PSAwKSBjYWxsYmFja3Mub25XYXJuaW5nKGd1aWQsIGBCYWQgaXRlbSA8Z3VpZD4gdmFsdWU6ICR7Z3VpZFRleHR9LCBleHBlY3RlZCB1cmwgd2hlbiBpc1Blcm1hTGluaz0idHJ1ZSIgb3IgdW5zcGVjaWZpZWRgLCByc3NHdWlkT3B0cyk7CiAgICB9CiAgICBjb25zdCB0cmFuc2NyaXB0cyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudHJhbnNjcmlwdCk7CiAgICBmb3IgKGNvbnN0IHRyYW5zY3JpcHQgb2YgdHJhbnNjcmlwdHMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCB0cmFuc2NyaXB0LCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3RyYW5zY3JpcHQnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc01pbWVUeXBlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdsYW5ndWFnZScsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3JlbCcsIGlzTm90RW1wdHkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2NoYXB0ZXJzJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguY2hhcHRlcnMpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjb25zdCBzb3VuZGJpdGVzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VuZGJpdGUpOwogICAgZm9yIChjb25zdCBzb3VuZGJpdGUgb2Ygc291bmRiaXRlcyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIHNvdW5kYml0ZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNzb3VuZGJpdGUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3RhcnRUaW1lJywgaXNTZWNvbmRzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdkdXJhdGlvbicsIGlzU2Vjb25kcykuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RQZXJzb24oJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MpOwogICAgY2hlY2tQb2RjYXN0TG9jYXRpb24oJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MpOwogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3NlYXNvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNlYXNvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbmFtZScsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSh2KQogICAgKS5jaGVja1ZhbHVlKGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNlcGlzb2RlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZXBpc29kZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZGlzcGxheScsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMzIpKHYpCiAgICApLmNoZWNrVmFsdWUoaXNEZWNpbWFsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGNoZWNrUG9kY2FzdExpY2Vuc2UoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MpOwogICAgY29uc3QgYWx0ZXJuYXRlRW5jbG9zdXJlcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguYWx0ZXJuYXRlRW5jbG9zdXJlKTsKICAgIGZvciAoY29uc3QgYWx0ZXJuYXRlRW5jbG9zdXJlIG9mIGFsdGVybmF0ZUVuY2xvc3VyZXMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCBhbHRlcm5hdGVFbmNsb3N1cmUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjYWx0ZXJuYXRlLWVuY2xvc3VyZScpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnbGVuZ3RoJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2JpdHJhdGUnLCBpc0RlY2ltYWwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2hlaWdodCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdsYW5nJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgndGl0bGUnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgICAgICkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncmVsJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICAgICApLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2NvZGVjcycsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2RlZmF1bHQnLCBpc0Jvb2xlYW4pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdhbHRlcm5hdGVFbmNsb3N1cmUnLCBhbHRlcm5hdGVFbmNsb3N1cmUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjaW50ZWdyaXR5JyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguaW50ZWdyaXR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgKHYpPT4vXihzcml8cGdwLXNpZ25hdHVyZSkkLy50ZXN0KHYpCiAgICAgICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd2YWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNvbnN0IHNvdXJjZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhhbHRlcm5hdGVFbmNsb3N1cmUsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc291cmNlKTsKICAgICAgICBmb3IgKGNvbnN0IHNvdXJjZSBvZiBzb3VyY2VzKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnYWx0ZXJuYXRlRW5jbG9zdXJlJywgc291cmNlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2FsdGVybmF0ZS1lbmNsb3N1cmUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJpJywgaXNVcmkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2NvbnRlbnRUeXBlJywgaXNNaW1lVHlwZSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY2hlY2tQb2RjYXN0VmFsdWUoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MpOwogICAgY2hlY2tQb2RjYXN0SW1hZ2VzKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IHNvY2lhbEludGVyYWN0cyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsSW50ZXJhY3QpOwogICAgY29uc3Qgc29jaWFsSW50ZXJhY3RSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9wcm9wb3NhbC1kb2NzL3NvY2lhbC9zb2NpYWwubWQjc29jaWFsaW50ZXJhY3QtZWxlbWVudCcpOwogICAgZm9yIChjb25zdCBzb2NpYWxJbnRlcmFjdCBvZiBzb2NpYWxJbnRlcmFjdHMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCBzb2NpYWxJbnRlcmFjdCwgY2FsbGJhY2tzLCBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncGxhdGZvcm0nLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwcm90b2NvbCcsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FjY291bnRJZCcsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3B1YkRhdGUnLCBpc0lzbzg2MDEpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrVmFsdWUoaXNVcmkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNhbGxiYWNrcy5vbkdvb2Qoc29jaWFsSW50ZXJhY3QsICdGb3VuZCA8cG9kY2FzdDpzb2NpYWxJbnRlcmFjdD4sIG5pY2UhJywgewogICAgICAgICAgICB0YWc6ICdzb2NpYWwtaW50ZXJhY3QnLAogICAgICAgICAgICByZWZlcmVuY2U6IHNvY2lhbEludGVyYWN0UmVmZXJlbmNlCiAgICAgICAgfSk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RUYWdVc2FnZShpdGVtLCBjYWxsYmFja3MpOwp9CmNsYXNzIEVsZW1lbnRWYWxpZGF0aW9uIHsKICAgIHN0YXRpYyBFTVBUWV9TVFJJTkdfU0VUID0gbmV3IFNldCgpOwogICAgbm9kZTsKICAgIGxldmVsOwogICAgY2FsbGJhY2tzOwogICAgb3B0czsKICAgIHJlbWFpbmluZ0F0dE5hbWVzOwogICAgY29uc3RydWN0b3IobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5vcHRzID0gb3B0czsKICAgICAgICB0aGlzLnJlbWFpbmluZ0F0dE5hbWVzID0gbm9kZSA/IG5ldyBTZXQobm9kZS5hdHRzLmtleXMoKSkgOiBFbGVtZW50VmFsaWRhdGlvbi5FTVBUWV9TVFJJTkdfU0VUOwogICAgfQogICAgc3RhdGljIGZvckVsZW1lbnQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcmVmZXJlbmNlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGZvclNpbmdsZUNoaWxkKGxldmVsLCBwYXJlbnQsIGNhbGxiYWNrcywgcmVmZXJlbmNlLCAuLi5xbmFtZXMpIHsKICAgICAgICBjaGVja1RydWUoJ3FuYW1lcy5sZW5ndGgnLCBxbmFtZXMubGVuZ3RoLCBxbmFtZXMubGVuZ3RoID4gMCk7CiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhwYXJlbnQsIC4uLnFuYW1lcyk7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcoZWxlbWVudHNbMV0sIGBNdWx0aXBsZSAke2xldmVsfSA8JHtlbGVtZW50c1sxXS50YWduYW1lfT4gZWxlbWVudHMgYXJlIG5vdCBhbGxvd2VkYCwgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIGVsZW1lbnQsIGNhbGxiYWNrcywgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCB1bmRlZmluZWQsIGNhbGxiYWNrcywgewogICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIGNoZWNrVmFsdWUodGVzdCwgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICBjb25zdCB7IG5vZGUgLCBjYWxsYmFja3MgLCBvcHRzICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IGNoZWNrVGV4dChub2RlLCB0ZXN0LCBjYWxsYmFja3MsIG9wdHMpOwogICAgICAgICAgICBpZiAodHJpbW1lZFRleHQgJiYgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhcm5pbmdTdWZmaXggPSBhZGRpdGlvbmFsVGVzdCh0cmltbWVkVGV4dCk7CiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1N1ZmZpeCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiB2YWx1ZTogJHt0cmltbWVkVGV4dCA9PT0gJycgPyAnPGVtcHR5PicgOiB0cmltbWVkVGV4dH0sICR7d2FybmluZ1N1ZmZpeH1gLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUobmFtZSwgdGVzdCkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBub2RlLmF0dHMuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZiAoIXZhbHVlKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlYCwgb3B0cyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tPcHRpb25hbEF0dHJpYnV0ZShuYW1lLCB0ZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkgewogICAgICAgIGNvbnN0IHsgcmVtYWluaW5nQXR0TmFtZXMgLCBjYWxsYmFja3MgLCBub2RlICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBpZiAocmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiBhdHRyaWJ1dGUgbmFtZSR7cmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDEgPyAncycgOiAnJ306ICR7WwogICAgICAgICAgICAgICAgICAgIC4uLnJlbWFpbmluZ0F0dE5hbWVzCiAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0KZnVuY3Rpb24gc2V0SW50ZXJzZWN0KGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaHMpewogICAgICAgIGlmIChyaHMuaGFzKGl0ZW0pKSBydC5hZGQoaXRlbSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGl0ZW0xIG9mIHJocyl7CiAgICAgICAgaWYgKGxocy5oYXMoaXRlbTEpKSBydC5hZGQoaXRlbTEpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmNsYXNzIFZhbGlkYXRpb25Kb2JWTSB7CiAgICBmZXRjaGVyczsKICAgIHBpU2VhcmNoRmV0Y2hlcjsKICAgIG5leHRKb2JJZCA9IDE7CiAgICBjdXJyZW50Sm9iOwogICAgZ2V0IHZhbGlkYXRpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmN1cnJlbnRKb2IuZG9uZTsKICAgIH0KICAgIGdldCBkb25lKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgIT09IHVuZGVmaW5lZCAmJiB0aGlzLmN1cnJlbnRKb2IuZG9uZTsKICAgIH0KICAgIGdldCBtZXNzYWdlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iID8gdGhpcy5jdXJyZW50Sm9iLm1lc3NhZ2VzIDogW107CiAgICB9CiAgICBnZXQgaXNTZWFyY2goKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY3VycmVudEpvYi5zZWFyY2g7CiAgICB9CiAgICBnZXQgc2VhcmNoUmVzdWx0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iID8gdGhpcy5jdXJyZW50Sm9iLnNlYXJjaFJlc3VsdHMgOiBbXTsKICAgIH0KICAgIGdldCB4bWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8ueG1sOwogICAgfQogICAgZ2V0IHhtbFN1bW1hcnlUZXh0KCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2I/LnhtbFN1bW1hcnlUZXh0OwogICAgfQogICAgZ2V0IGZldGNoQ29tbWVudHNSZXN1bHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8uZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9wdHMpewogICAgICAgIGNvbnN0IHsgbG9jYWxGZXRjaGVyOiBsb2NhbEZldGNoZXIxICwgcmVtb3RlRmV0Y2hlcjogcmVtb3RlRmV0Y2hlcjEgLCBwaVNlYXJjaEZldGNoZXI6IHBpU2VhcmNoRmV0Y2hlcjEgIH0gPSBvcHRzOwogICAgICAgIHRoaXMuZmV0Y2hlcnMgPSB7CiAgICAgICAgICAgIGxvY2FsRmV0Y2hlcjogbG9jYWxGZXRjaGVyMSwKICAgICAgICAgICAgcmVtb3RlRmV0Y2hlcjogcmVtb3RlRmV0Y2hlcjEKICAgICAgICB9OwogICAgICAgIHRoaXMucGlTZWFyY2hGZXRjaGVyID0gcGlTZWFyY2hGZXRjaGVyMTsKICAgIH0KICAgIG9uQ2hhbmdlID0gKCk9Pnt9OwogICAgY29udGludWVXaXRoKHVybCkgewogICAgICAgIGNvbnN0IHsgY3VycmVudEpvYiAgfSA9IHRoaXM7CiAgICAgICAgaWYgKGN1cnJlbnRKb2IpIHsKICAgICAgICAgICAgY3VycmVudEpvYi5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiAncnVubmluZycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnVmFsaWRhdGluZycKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY3VycmVudEpvYi5tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRleHQ6ICdDb250aW51aW5nIHdpdGggZmVlZCBmcm9tIHNlYXJjaCcsCiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgdGhpcy52YWxpZGF0ZUFzeW5jKHVybCwgY3VycmVudEpvYik7CiAgICAgICAgfQogICAgfQogICAgc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgY29uc3Qgam9iID0gewogICAgICAgICAgICBpZDogdGhpcy5uZXh0Sm9iSWQrKywKICAgICAgICAgICAgbWVzc2FnZXM6IFtdLAogICAgICAgICAgICBzZWFyY2hSZXN1bHRzOiBbXSwKICAgICAgICAgICAgdGltZXM6IHt9LAogICAgICAgICAgICBvcHRpb25zLAogICAgICAgICAgICBzZWFyY2g6IGZhbHNlLAogICAgICAgICAgICBkb25lOiBmYWxzZSwKICAgICAgICAgICAgY2FuY2VsbGVkOiBmYWxzZQogICAgICAgIH07CiAgICAgICAgdGhpcy5jdXJyZW50Sm9iID0gam9iOwogICAgICAgIGpvYi5tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgdHlwZTogJ3J1bm5pbmcnLAogICAgICAgICAgICB0ZXh0OiAnVmFsaWRhdGluZycKICAgICAgICB9KTsKICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgdGhpcy52YWxpZGF0ZUFzeW5jKGlucHV0LCBqb2IpOwogICAgfQogICAgY2FuY2VsVmFsaWRhdGlvbigpIHsKICAgICAgICBpZiAodGhpcy5jdXJyZW50Sm9iICYmICF0aGlzLmN1cnJlbnRKb2IuZG9uZSkgewogICAgICAgICAgICB0aGlzLmN1cnJlbnRKb2IuY2FuY2VsbGVkID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLmRvbmUgPSB0cnVlOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZmV0Y2godXJsLCBvcHRzKSB7CiAgICAgICAgY29uc3QgeyBoZWFkZXJzICB9ID0gb3B0czsKICAgICAgICBjb25zdCB7IGZldGNoZXJzICB9ID0gdGhpczsKICAgICAgICByZXR1cm4gYXdhaXQgbG9jYWxPclJlbW90ZUZldGNoKHVybCwgewogICAgICAgICAgICBmZXRjaGVycywKICAgICAgICAgICAgaGVhZGVycwogICAgICAgIH0pOwogICAgfQogICAgYXN5bmMgdmFsaWRhdGVBc3luYyhpbnB1dCwgam9iKSB7CiAgICAgICAgaW5wdXQgPSBub3JtYWxpemVJbnB1dChpbnB1dCk7CiAgICAgICAgY29uc3QgeyBtZXNzYWdlcyAgfSA9IGpvYjsKICAgICAgICBjb25zdCBzZXRTdGF0dXMgPSAodGV4dCwgb3B0cyA9IHt9KT0+ewogICAgICAgICAgICBjb25zdCB7IHVybCAsIHR5cGUgIH0gPSBvcHRzOwogICAgICAgICAgICBtZXNzYWdlc1swXSA9IHsKICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUgfHwgbWVzc2FnZXNbMF0udHlwZSwKICAgICAgICAgICAgICAgIHRleHQsCiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH07CiAgICAgICAgY29uc3QgYWRkTWVzc2FnZSA9ICh0eXBlLCB0ZXh0LCBvcHRzID0ge30pPT57CiAgICAgICAgICAgIGNvbnN0IHsgdXJsICwgdGFnICwgY29tbWVudCAsIHJlZmVyZW5jZSAgfSA9IG9wdHM7CiAgICAgICAgICAgIG1lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZSwKICAgICAgICAgICAgICAgIHRleHQsCiAgICAgICAgICAgICAgICB0YWcsCiAgICAgICAgICAgICAgICB1cmwsCiAgICAgICAgICAgICAgICBjb21tZW50LAogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfTsKICAgICAgICBsZXQgYWN0aXZpdHlQdWI7CiAgICAgICAgY29uc3QgaGVhZGVycyA9IHsKICAgICAgICAgICAgJ0FjY2VwdC1FbmNvZGluZyc6ICdnemlwJywKICAgICAgICAgICAgJ1VzZXItQWdlbnQnOiBqb2Iub3B0aW9ucy51c2VyQWdlbnQsCiAgICAgICAgICAgICdDYWNoZS1Db250cm9sJzogJ25vLXN0b3JlJwogICAgICAgIH07CiAgICAgICAgbGV0IGNvbnRpbnVlV2l0aFVybDsKICAgICAgICBjb25zdCBqb2JTdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgY29uc3QgeyBmZXRjaGVycyAsIHBpU2VhcmNoRmV0Y2hlcjogcGlTZWFyY2hGZXRjaGVyMiAgfSA9IHRoaXM7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgaW5wdXQgPSBpbnB1dC50cmltKCk7CiAgICAgICAgICAgIGlmIChpbnB1dCA9PT0gJycpIHRocm93IG5ldyBFcnJvcihgTm8gaW5wdXRgKTsKICAgICAgICAgICAgaWYgKC9eaHR0cHM/OlwvXC8uKy9pLnRlc3QoaW5wdXQpKSB7CiAgICAgICAgICAgICAgICBjb25zdCBpbnB1dFVybCA9IHRyeVBhcnNlVXJsMShpbnB1dCk7CiAgICAgICAgICAgICAgICBpZiAoIWlucHV0VXJsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB1cmw6ICR7aW5wdXR9YCk7CiAgICAgICAgICAgICAgICBjaGVja01hdGNoZXMoJ2lucHV0VXJsLnByb3RvY29sJywgaW5wdXRVcmwucHJvdG9jb2wsIC9eaHR0cHM/OiQvKTsKICAgICAgICAgICAgICAgIGlucHV0VXJsLnNlYXJjaFBhcmFtcy5zZXQoJ190JywgRGF0ZS5ub3coKS50b1N0cmluZygpKTsKICAgICAgICAgICAgICAgIGNvbnN0IHsgcmVzcG9uc2UgLCBzaWRlOiBzaWRlMSAsIGZldGNoVGltZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaChpbnB1dFVybC50b1N0cmluZygpLCB7CiAgICAgICAgICAgICAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoam9iLmRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgIGpvYi50aW1lcy5mZXRjaFRpbWUgPSBmZXRjaFRpbWU7CiAgICAgICAgICAgICAgICBpZiAoc2lkZTEgPT09ICdsb2NhbCcpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdnb29kJywgYExvY2FsIGZldGNoIHN1Y2NlZWRlZCAoQ09SUyBlbmFibGVkKWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBpbnB1dAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hlY2tFcXVhbChgJHtpbnB1dFVybC5ob3N0fSByZXNwb25zZSBzdGF0dXNgLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgICAgICAgICAgICAgIGxldCB2YWxpZGF0ZUZlZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlICYmIGNvbnRlbnRUeXBlLmluY2x1ZGVzKCcvaHRtbCcpKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGb3VuZCBodG1sLCB3aWxsIHRyeSBhZ2FpbiBhcyBBY3Rpdml0eVB1YicpOwogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGVudFR5cGUgJiYgY29udGVudFR5cGUuc3RhcnRzV2l0aCgnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicpKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGb3VuZCBBY3Rpdml0eVB1YiBqc29uJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJywKICAgICAgICAgICAgICAgICAgICAgICAgb2JqCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0ZUZlZWQpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGpvYi5kb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnJlYWRUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBsZXQgeG1sOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHBhcnNlWG1sKHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh4bWwpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWVzc2FnZSA9IHR5cGVvZiBlLm1lc3NhZ2UgPT09ICdzdHJpbmcnID8gZS5tZXNzYWdlIDogJyc7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGtub3duSW52YWxpZCA9IG1lc3NhZ2UgPT09IGBDYW5ub3QgcmVhZCBwcm9wZXJ0aWVzIG9mIHVuZGVmaW5lZCAocmVhZGluZyAncGFyZW50JylgOwogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIGBYbWwgcGFyc2UgZmFpbGVkOiAke2tub3duSW52YWxpZCA/ICdJbnZhbGlkIHhtbCcgOiBlLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMucGFyc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb25NZXNzYWdlID0gKHR5cGUsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHM/LnRhZyA9PT0gJ3NvY2lhbC1pbnRlcmFjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS52YWwgJiYgbm9kZS52YWwgIT09ICcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBjb21wdXRlQXR0cmlidXRlTWFwKG5vZGUuYXR0cnNNYXApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoYXR0cmlidXRlcy5nZXQoJ3BsYXRmb3JtJykgPT09ICdhY3Rpdml0eXB1YicgfHwgYXR0cmlidXRlcy5nZXQoJ3Byb3RvY29sJykgPT09ICdhY3Rpdml0eXB1YicpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVwaXNvZGVUaXRsZSA9IGZpbmRFcGlzb2RlVGl0bGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmw6IG5vZGUudmFsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6IGVwaXNvZGVUaXRsZSA/IGDigJwke2VwaXNvZGVUaXRsZX3igJ1gIDogJ2VwaXNvZGUnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5rbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGlOYW1lc3BhY2VVcmlzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcnNzSXRlbUluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uR29vZDogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnZ29vZCcsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uRXJyb3I6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdlcnJvcicsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uV2FybmluZzogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnd2FybmluZycsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uSW5mbzogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnaW5mbycsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUG9kY2FzdEluZGV4VGFnTmFtZXNGb3VuZDogKGtub3duLCB1bmtub3duLCBuYW1lc3BhY2VVcmlzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtub3duLmZvckVhY2goKHYpPT5rbm93blBpVGFncy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVua25vd24uZm9yRWFjaCgodik9PnVua25vd25QaVRhZ3MuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2VVcmlzLmZvckVhY2goKHYpPT5waU5hbWVzcGFjZVVyaXMuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblJzc0l0ZW1zRm91bmQ6IChpdGVtc0NvdW50LCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnNzSXRlbUluZm8gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zQ291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB4bWxTdW1tYXJ5VGV4dCA9ICdYbWwgc3RydWN0dXJlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkWG1sKHhtbCwgY2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnZhbGlkYXRlVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJzc0l0ZW1JbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGl0ZW1zQ291bnQgLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQgIH0gPSByc3NJdGVtSW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCA9IGl0ZW1zQ291bnQgLSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaWVjZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYEZvdW5kICR7dW5pdFN0cmluZyhpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQsICdlcGlzb2RlJyl9YAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQgPiAwKSBwaWVjZXMucHVzaChgYW5kICR7dW5pdFN0cmluZyhpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQsICdpdGVtJyl9IHdpdGhvdXQgZW5jbG9zdXJlc2ApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLnB1c2goYGluIGEgJHtmb3JtYXRCeXRlcyh0ZXh0Lmxlbmd0aCl9IGZlZWRgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCBwaWVjZXMuam9pbignICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbFN1bW1hcnlUZXh0ID0gYCR7aXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ID4gMSA/ICdQb2RjYXN0IGZlZWQnIDogJ0ZlZWQnfSBzdHJ1Y3R1cmVgOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnU3RyaW5nID0gKHNldCk9PlsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5zZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0ubWFwKCh2KT0+YDxwb2RjYXN0OiR7dn0+YAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5qb2luKCcsICcpCiAgICAgICAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtub3duUGlUYWdzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdnb29kJywgYEZvdW5kICR7dW5pdFN0cmluZyhrbm93blBpVGFncy5zaXplLCAncG9kY2FzdCBuYW1lc3BhY2UgdGFnJyl9OiAke3RhZ1N0cmluZyhrbm93blBpVGFncyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZTogcGlSZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duUGlUYWdzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgYEZvdW5kICR7dW5pdFN0cmluZyh1bmtub3duUGlUYWdzLnNpemUsICd1bmtub3duIHBvZGNhc3QgbmFtZXNwYWNlIHRhZycpfTogJHt0YWdTdHJpbmcodW5rbm93blBpVGFncyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZTogcGlSZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pc3NwZWxsZWROYW1lc3BhY2VzID0gc2V0SW50ZXJzZWN0KHBpTmFtZXNwYWNlVXJpcywgbmV3IFNldChRbmFtZXMuUG9kY2FzdEluZGV4LktOT1dOX01JU1NQRUxMRURfTkFNRVNQQUNFUykpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWlzc3BlbGxlZE5hbWVzcGFjZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3Jzcy1uYW1lc3BhY2UtZXh0ZW5zaW9uLWZvci1wb2RjYXN0aW5nLXRhZy1zcGVjaWZpY2F0aW9uJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgYEZvdW5kICR7dW5pdFN0cmluZyhtaXNzcGVsbGVkTmFtZXNwYWNlcy5zaXplLCAnbWlzc3BlbGxlZCBwb2RjYXN0IG5hbWVzcGFjZSB1cmknKX06ICR7WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLm1pc3NwZWxsZWROYW1lc3BhY2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbCAmJiBPYmplY3Qua2V5cyh4bWwpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi54bWwgPSB4bWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2IueG1sU3VtbWFyeVRleHQgPSB4bWxTdW1tYXJ5VGV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRlQ29tbWVudHMgPSBqb2Iub3B0aW9ucy52YWxpZGF0ZUNvbW1lbnRzICE9PSB1bmRlZmluZWQgPyBqb2Iub3B0aW9ucy52YWxpZGF0ZUNvbW1lbnRzIDogdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eVB1YiAmJiAhdmFsaWRhdGVDb21tZW50cykgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnQ29tbWVudHMgdmFsaWRhdGlvbiBkaXNhYmxlZCwgbm90IGZldGNoaW5nIEFjdGl2aXR5UHViJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGl2aXR5UHViKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0U3RhdHVzKGBWYWxpZGF0aW5nIEFjdGl2aXR5UHViIGZvciAke2FjdGl2aXR5UHViLnN1YmplY3R9YCwgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGFjdGl2aXR5UHViLnVybAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnRmV0Y2hpbmcgQWN0aXZpdHlQdWIgY29tbWVudHMnLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYWN0aXZpdHlQdWIudXJsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2VlcEdvaW5nID0gKCk9PiFqb2IuZG9uZQogICAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdGVPbmx5T3JpZ2lucyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wdXRlVXNlU2lkZSA9ICh1cmwpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVPbmx5T3JpZ2lucy5oYXMobmV3IFVSTCh1cmwpLm9yaWdpbikgPyAncmVtb3RlJyA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGxldCBhY3Rpdml0eVB1YkNhbGxzID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmZXRjaEFjdGl2aXR5UHViID0gYXN5bmMgKHVybCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHsgb2JqICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCBmZXRjaGVycywgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoJy9hcGkvdjEvc3RhdHVzZXMnKSAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IG9iai51cmk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgZmV0Y2hlcnMsIGNvbXB1dGVVc2VTaWRlKHVybCksIDApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IHJlcy5vYmo7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaWRlID0gcmVzLnNpZGU7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzaWRlID09PSAncmVtb3RlJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gbmV3IFVSTCh1cmwpLm9yaWdpbjsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICghcmVtb3RlT25seU9yaWdpbnMuaGFzKG9yaWdpbikpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgYExvY2FsIEFjdGl2aXR5UHViIGZldGNoIGZhaWxlZCAoQ09SUyBkaXNhYmxlZD8pYCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZzogJ2NvcnMnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVtb3RlT25seU9yaWdpbnMuYWRkKG9yaWdpbik7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWJDYWxscysrOwogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgd2FybiA9IChjb21tZW50LCB1cmwsIG1lc3NhZ2UpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBtZXNzYWdlLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tZW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGZldGNoQ29tbWVudHNSZXN1bHQgPSBhd2FpdCBmZXRjaENvbW1lbnRzRm9yVXJsKGFjdGl2aXR5UHViLnVybCwgYWN0aXZpdHlQdWIuc3ViamVjdCwgewogICAgICAgICAgICAgICAgICAgICAgICBrZWVwR29pbmcsCiAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoQWN0aXZpdHlQdWIsCiAgICAgICAgICAgICAgICAgICAgICAgIHdhcm4KICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAoZmV0Y2hDb21tZW50c1Jlc3VsdCkgewogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMuY29tbWVudHNUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgYEZvdW5kICR7dW5pdFN0cmluZyhjb21wdXRlQ29tbWVudENvdW50KGZldGNoQ29tbWVudHNSZXN1bHQucm9vdENvbW1lbnQpLCAnY29tbWVudCcpfSBhbmQgJHt1bml0U3RyaW5nKGZldGNoQ29tbWVudHNSZXN1bHQuY29tbWVudGVycy5zaXplLCAncGFydGljaXBhbnQnKX0sIG1hZGUgJHt1bml0U3RyaW5nKGFjdGl2aXR5UHViQ2FsbHMsICdBY3Rpdml0eVB1YiBjYWxsJyl9YCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGpvYi5mZXRjaENvbW1lbnRzUmVzdWx0ID0gZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqb2Iuc2VhcmNoID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHNldFN0YXR1cygnU2VhcmNoaW5nJyk7CiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hSZXNwb25zZSA9IGF3YWl0IHBpU2VhcmNoRmV0Y2hlcjIoaW5wdXQsIGhlYWRlcnMpOwogICAgICAgICAgICAgICAgY2hlY2tFcXVhbCgnc2VhcmNoUmVzcG9uc2Uuc3RhdHVzJywgc2VhcmNoUmVzcG9uc2Uuc3RhdHVzLCAyMDApOwogICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gYXdhaXQgc2VhcmNoUmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgaWYgKHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnNlYXJjaFJlc3VsdHMucHVzaCguLi5zZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQuZmVlZHMuc2xpY2UoMCwgMjApKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1JlYWRvbmx5QXJyYXkoc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQuZmVlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlV2l0aFVybCA9IHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0LmZlZWQudXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIGUubWVzc2FnZSk7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgYCR7am9iLnNlYXJjaCA/ICdTZWFyY2ggdG9vaycgOiAnVG9vayd9ICR7Zm9ybWF0VGltZShEYXRlLm5vdygpIC0gam9iU3RhcnQpfSR7Y29tcHV0ZUpvYlRpbWVzU3RyaW5nU3VmZml4KGpvYi50aW1lcyl9YCk7CiAgICAgICAgICAgIGlmIChjb250aW51ZVdpdGhVcmwpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGludWVXaXRoKGNvbnRpbnVlV2l0aFVybCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqb2IuZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBqb2IuY2FuY2VsbGVkID8gJ0NhbmNlbGxlZCcgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMCA/ICdGb3VuZCBubyBwb2RjYXN0cycgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMSA/ICdGb3VuZCBvbmUgcG9kY2FzdCwgc2VsZWN0IHRvIGNvbnRpbnVlJyA6IGpvYi5zZWFyY2ggPyBgRm91bmQgJHtqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGh9IHBvZGNhc3RzLCBzZWxlY3Qgb25lIHRvIGNvbnRpbnVlYCA6ICdEb25lJzsKICAgICAgICAgICAgICAgIHNldFN0YXR1cyhzdGF0dXMsIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZG9uZScKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGZvcm1hdFRpbWUobWlsbGlzKSB7CiAgICBpZiAobWlsbGlzIDwgMTAwMCkgcmV0dXJuIGAke21pbGxpc31tc2A7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChtaWxsaXMgLyAxMDAwICogMTAwKSAvIDEwMH1zYDsKfQpmdW5jdGlvbiBjb21wdXRlSm9iVGltZXNTdHJpbmdTdWZmaXgodGltZXMpIHsKICAgIGNvbnN0IHJ0ID0gWwogICAgICAgIFsKICAgICAgICAgICAgJ2ZldGNoJywKICAgICAgICAgICAgdGltZXMuZmV0Y2hUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdyZWFkJywKICAgICAgICAgICAgdGltZXMucmVhZFRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ3BhcnNlJywKICAgICAgICAgICAgdGltZXMucGFyc2VUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICd2YWxpZGF0ZScsCiAgICAgICAgICAgIHRpbWVzLnZhbGlkYXRlVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAnY29tbWVudHMnLAogICAgICAgICAgICB0aW1lcy5jb21tZW50c1RpbWUKICAgICAgICBdCiAgICBdLmZpbHRlcigodik9PnZbMV0gIT09IHVuZGVmaW5lZAogICAgKS5tYXAoKHYpPT5gJHt2WzBdfT0ke2Zvcm1hdFRpbWUodlsxXSl9YAogICAgKS5qb2luKCcsICcpOwogICAgcmV0dXJuIHJ0ID09PSAnJyA/ICcnIDogYCAoJHtydH0pYDsKfQpmdW5jdGlvbiBmb3JtYXRCeXRlcyhieXRlcykgewogICAgbGV0IGFtb3VudCA9IGJ5dGVzOwogICAgaWYgKGFtb3VudCA8IDEwMjQpIHJldHVybiBgJHthbW91bnR9LWJ5dGVgOwogICAgYW1vdW50ID0gYW1vdW50IC8gMTAyNDsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfWtiYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfW1iYDsKfQpmdW5jdGlvbiB1bml0U3RyaW5nKGFtb3VudCwgdW5pdCkgewogICAgcmV0dXJuIGAke2Ftb3VudCA9PT0gMCA/ICdubycgOiBhbW91bnQgPT09IDEgPyAnb25lJyA6IG5ldyBJbnRsLk51bWJlckZvcm1hdCgpLmZvcm1hdChhbW91bnQpfSAke3VuaXR9JHthbW91bnQgPT09IDEgPyAnJyA6ICdzJ31gOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZUlucHV0KGlucHV0KSB7CiAgICBpbnB1dCA9IGlucHV0LnRyaW0oKTsKICAgIGNvbnN0IG0gPSAvXmh0dHBzOlwvXC9wb2RjYXN0c1wuYXBwbGVcLmNvbVwvLio/KGlkXGQrKSQvLmV4ZWMoaW5wdXQpOwogICAgaWYgKG0pIHJldHVybiBtWzFdOwogICAgcmV0dXJuIGlucHV0Owp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsMSh1cmwpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwodXJsKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIHNsZWVwKG1zKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT5zZXRUaW1lb3V0KHJlc29sdmUsIG1zKQogICAgKTsKfQphc3luYyBmdW5jdGlvbiBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgZmV0Y2hlcnMsIHVzZVNpZGUsIHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzKSB7CiAgICBpZiAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMgPiAwKSBhd2FpdCBzbGVlcChzbGVlcE1pbGxpc0JldHdlZW5DYWxscyk7CiAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICBmZXRjaGVycywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicKICAgICAgICB9LAogICAgICAgIHVzZVNpZGUKICAgIH0pOwogICAgY2hlY2tFcXVhbCgncmVzLnN0YXR1cycsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5yZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKSk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgIGlmICghKGNvbnRlbnRUeXBlIHx8ICcnKS5pbmNsdWRlcygnanNvbicpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCBodG1sLCBub3QgQWN0aXZpdHlQdWInKTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgIHJldHVybiB7CiAgICAgICAgb2JqLAogICAgICAgIHNpZGUKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoKHVybCwgb3B0cykgewogICAgY29uc3QgeyBmZXRjaGVycyAsIGhlYWRlcnMgLCB1c2VTaWRlICB9ID0gb3B0czsKICAgIGlmICh1c2VTaWRlICE9PSAncmVtb3RlJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBsb2NhbCBmZXRjaDogJHt1cmx9YCk7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaGVycy5sb2NhbEZldGNoZXIodXJsLCBoZWFkZXJzKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGZldGNoVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0LAogICAgICAgICAgICAgICAgc2lkZTogJ2xvY2FsJywKICAgICAgICAgICAgICAgIHJlc3BvbnNlCiAgICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGxvY2FsIGZldGNoLCB0cnlpbmcgcmVtb3RlJywgZSk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5sb2coYHJlbW90ZSBmZXRjaDogJHt1cmx9YCk7CiAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoZXJzLnJlbW90ZUZldGNoZXIodXJsLCBoZWFkZXJzKTsKICAgIHJldHVybiB7CiAgICAgICAgZmV0Y2hUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnQsCiAgICAgICAgc2lkZTogJ3JlbW90ZScsCiAgICAgICAgcmVzcG9uc2UKICAgIH07Cn0KZnVuY3Rpb24gZmluZEVwaXNvZGVUaXRsZShzb2NpYWxJbnRlcmFjdCkgewogICAgY29uc3QgaXRlbSA9IHNvY2lhbEludGVyYWN0LnBhcmVudDsKICAgIGlmIChpdGVtKSB7CiAgICAgICAgY29uc3QgdGl0bGUgPSBpdGVtLmNoaWxkWyd0aXRsZSddOwogICAgICAgIGlmICh0aXRsZS5sZW5ndGggPiAwICYmIHRpdGxlWzBdLnZhbCkgewogICAgICAgICAgICBjb25zdCB2YWwgPSB0aXRsZVswXS52YWwudHJpbSgpOwogICAgICAgICAgICBpZiAodmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGlzT2F1dGhPYnRhaW5Ub2tlblJlc3BvbnNlKG9iaikgewogICAgcmV0dXJuIGlzU3RyaW5nUmVjb3JkKG9iaikgJiYgdHlwZW9mIG9iai5hY2Nlc3NfdG9rZW4gPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmoudG9rZW5fdHlwZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5zY29wZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5jcmVhdGVkX2F0ID09PSAnbnVtYmVyJzsKfQpjb25zdCBBUFBMSUNBVElPTl9KU09OX0NIQVJTRVRfVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JzsKYXN5bmMgZnVuY3Rpb24gdmVyaWZ5SnNvblJlc3BvbnNlKHJlcywgYm9keVZlcmlmaWVyKSB7CiAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaHR0cCByZXNwb25zZSBzdGF0dXM6ICR7cmVzLnN0YXR1c30sIGV4cGVjdGVkIDIwMCwgYm9keT0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlcy5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7CiAgICBpZiAoY29udGVudFR5cGUgIT09IEFQUExJQ0FUSU9OX0pTT05fQ0hBUlNFVF9VVEY4KSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaHR0cCByZXNwb25zZSBzdGF0dXM6ICR7Y29udGVudFR5cGV9LCBleHBlY3RlZCAke0FQUExJQ0FUSU9OX0pTT05fQ0hBUlNFVF9VVEY4fSwgYm9keT0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGlmICghYm9keVZlcmlmaWVyKGJvZHkpKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgYm9keTogJHtKU09OLnN0cmluZ2lmeShib2R5LCB1bmRlZmluZWQsIDIpfWApOwogICAgcmV0dXJuIGJvZHk7Cn0KYXN5bmMgZnVuY3Rpb24gc3RhdHVzZXNQdWJsaXNoKGFwaUJhc2UsIGFjY2Vzc1Rva2VuLCBvcHRzKSB7CiAgICBjb25zdCB7IGlkZW1wb3RlbmN5S2V5ICwgc3RhdHVzICwgaW5fcmVwbHlfdG9faWQgIH0gPSBvcHRzOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CiAgICBoZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gKTsKICAgIGlmIChpZGVtcG90ZW5jeUtleSkgaGVhZGVycy5zZXQoJ0lkZW1wb3RlbmN5LUtleScsIGlkZW1wb3RlbmN5S2V5KTsKICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTsKICAgIGRhdGEuc2V0KCdzdGF0dXMnLCBzdGF0dXMpOwogICAgaWYgKGluX3JlcGx5X3RvX2lkKSBkYXRhLnNldCgnaW5fcmVwbHlfdG9faWQnLCBpbl9yZXBseV90b19pZCk7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHthcGlCYXNlfS9hcGkvdjEvc3RhdHVzZXNgLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogZGF0YSwKICAgICAgICBoZWFkZXJzCiAgICB9KTsKICAgIHJldHVybiB2ZXJpZnlKc29uUmVzcG9uc2UocmVzLCBpc1N0YXR1cyk7Cn0KZnVuY3Rpb24gaXNTdGF0dXMob2JqKSB7CiAgICByZXR1cm4gaXNTdHJpbmdSZWNvcmQob2JqKSAmJiB0eXBlb2Ygb2JqLmlkID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5jcmVhdGVkX2F0ID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLmNvbnRlbnQgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmoudmlzaWJpbGl0eSA9PT0gJ3N0cmluZycgJiYgKG9iai51cmwgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2Ygb2JqLnVybCA9PT0gJ3N0cmluZycpICYmIChvYmouaW5fcmVwbHlfdG9faWQgPT09IHVuZGVmaW5lZCB8fCBvYmouaW5fcmVwbHlfdG9faWQgPT09IG51bGwgfHwgdHlwZW9mIG9iai5pbl9yZXBseV90b19pZCA9PT0gJ3N0cmluZycpOwp9CmNsYXNzIFZhbGlkYXRvckFwcFZNIHsKICAgIGpvYjsKICAgIGdldCB2YWxpZGF0aW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi52YWxpZGF0aW5nOwogICAgfQogICAgZ2V0IG1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi5tZXNzYWdlczsKICAgIH0KICAgIGdldCBpc1NlYXJjaCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IuaXNTZWFyY2g7CiAgICB9CiAgICBnZXQgc2VhcmNoUmVzdWx0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2Iuc2VhcmNoUmVzdWx0czsKICAgIH0KICAgIGdldCB4bWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLnhtbDsKICAgIH0KICAgIGdldCB4bWxTdW1tYXJ5VGV4dCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IueG1sU3VtbWFyeVRleHQ7CiAgICB9CiAgICBnZXQgZmV0Y2hDb21tZW50c1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IuZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9wdHMpewogICAgICAgIHRoaXMuam9iID0gbmV3IFZhbGlkYXRpb25Kb2JWTShvcHRzKTsKICAgICAgICB0aGlzLmpvYi5vbkNoYW5nZSA9ICgpPT50aGlzLm9uQ2hhbmdlKCkKICAgICAgICA7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57fTsKICAgIHN0YXJ0KCkge30KICAgIGNvbnRpbnVlV2l0aCh1cmwpIHsKICAgICAgICB0aGlzLmpvYi5jb250aW51ZVdpdGgodXJsKTsKICAgIH0KICAgIHN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgIHRoaXMuam9iLnN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucyk7CiAgICB9CiAgICBjYW5jZWxWYWxpZGF0aW9uKCkgewogICAgICAgIHRoaXMuam9iLmNhbmNlbFZhbGlkYXRpb24oKTsKICAgIH0KICAgIGlzTG9nZ2VkSW4ob3JpZ2luKSB7CiAgICAgICAgY29uc3QgaW5mbyA9IGxvYWRMb2dpbkluZm8ob3JpZ2luKTsKICAgICAgICByZXR1cm4gaW5mbyAhPT0gdW5kZWZpbmVkICYmICFjb21wdXRlRXhwaXJlZChpbmZvLnRva2VuUmVzcG9uc2UpOwogICAgfQogICAgYWNjZXB0TG9naW4ob3JpZ2luLCB0b2tlblJlc3BvbnNlKSB7CiAgICAgICAgY2hlY2tFcXVhbCgndG9rZW5fdHlwZScsIHRva2VuUmVzcG9uc2UudG9rZW5fdHlwZS50b0xvd2VyQ2FzZSgpLCAnYmVhcmVyJyk7CiAgICAgICAgY2hlY2tUcnVlKCdjcmVhdGVkX2F0LCBleHBpcmVzX2luJywgWwogICAgICAgICAgICB0b2tlblJlc3BvbnNlLmNyZWF0ZWRfYXQsCiAgICAgICAgICAgIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbgogICAgICAgIF0uam9pbignLCAnKSwgIWNvbXB1dGVFeHBpcmVkKHRva2VuUmVzcG9uc2UpKTsKICAgICAgICBzYXZlTG9naW5JbmZvKHsKICAgICAgICAgICAgb3JpZ2luLAogICAgICAgICAgICB0b2tlblJlc3BvbnNlCiAgICAgICAgfSk7CiAgICB9CiAgICBleHBpcmVMb2dpbihvcmlnaW4pIHsKICAgICAgICBkZWxldGVMb2dpbkluZm8ob3JpZ2luKTsKICAgIH0KICAgIGFzeW5jIHNlbmRSZXBseShyZXBseSwgcmVwbHlUb1VybCkgewogICAgICAgIHJlcGx5ID0gcmVwbHkudHJpbSgpOwogICAgICAgIGlmIChyZXBseSA9PT0gJycpIHRocm93IG5ldyBFcnJvcignQmFkIHJlcGx5OiA8ZW1wdHk+Jyk7CiAgICAgICAgY29uc3QgeyBvcmlnaW4gIH0gPSBuZXcgVVJMKHJlcGx5VG9VcmwpOwogICAgICAgIGNvbnN0IGluZm8gPSBsb2FkTG9naW5JbmZvKG9yaWdpbik7CiAgICAgICAgaWYgKCFpbmZvKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGxvZ2luIGZvciAke29yaWdpbn1gKTsKICAgICAgICBpZiAoY29tcHV0ZUV4cGlyZWQoaW5mby50b2tlblJlc3BvbnNlKSkgdGhyb3cgbmV3IEVycm9yKGBMb2dpbiBleHBpcmVkIGZvciAke29yaWdpbn1gKTsKICAgICAgICBjb25zb2xlLmxvZyhgcmVwbHlUb1VybGAsIHJlcGx5VG9VcmwpOwogICAgICAgIGNvbnN0IG1hc3RvZG9uSWQgPSBhd2FpdCBjb21wdXRlTWFzdG9kb25JZEZvclVybChyZXBseVRvVXJsLCBhc3luYyAodXJsLCBoZWFkZXJzKT0+ewogICAgICAgICAgICBjb25zdCB7IHJlc3BvbnNlICB9ID0gYXdhaXQgdGhpcy5qb2IuZmV0Y2godXJsLCB7CiAgICAgICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gcmVzcG9uc2U7CiAgICAgICAgfSk7CiAgICAgICAgY29uc29sZS5sb2coYG1hc3RvZG9uSWRgLCBtYXN0b2RvbklkKTsKICAgICAgICBjb25zdCB7IHVybDogdXJsMSAgfSA9IGF3YWl0IHN0YXR1c2VzUHVibGlzaChvcmlnaW4sIGluZm8udG9rZW5SZXNwb25zZS5hY2Nlc3NfdG9rZW4sIHsKICAgICAgICAgICAgc3RhdHVzOiByZXBseSwKICAgICAgICAgICAgaW5fcmVwbHlfdG9faWQ6IG1hc3RvZG9uSWQKICAgICAgICB9KTsKICAgICAgICByZXR1cm4gdXJsMTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlRXhwaXJlZCh0b2tlblJlc3BvbnNlKSB7CiAgICByZXR1cm4gdHlwZW9mIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbiA9PT0gJ251bWJlcicgJiYgKHRva2VuUmVzcG9uc2UuY3JlYXRlZF9hdCArIHRva2VuUmVzcG9uc2UuZXhwaXJlc19pbikgKiAxMDAwIDw9IERhdGUubm93KCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pIHsKICAgIHJldHVybiBgbG9naW46JHtvcmlnaW59YDsKfQpmdW5jdGlvbiBsb2FkTG9naW5JbmZvKG9yaWdpbikgewogICAgY29uc3Qgc3RyID0gbG9jYWxTdG9yYWdlLmdldEl0ZW0oY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pKTsKICAgIGNvbnN0IG9iaiA9IHR5cGVvZiBzdHIgPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShzdHIpIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIGlzTG9naW5JbmZvKG9iaikgPyBvYmogOiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gc2F2ZUxvZ2luSW5mbyhpbmZvKSB7CiAgICBjb25zdCB7IG9yaWdpbiAgfSA9IGluZm87CiAgICBsb2NhbFN0b3JhZ2Uuc2V0SXRlbShjb21wdXRlTG9naW5JbmZvTG9jYWxTdG9yYWdlS2V5KG9yaWdpbiksIEpTT04uc3RyaW5naWZ5KGluZm8pKTsKfQpmdW5jdGlvbiBkZWxldGVMb2dpbkluZm8ob3JpZ2luKSB7CiAgICBsb2NhbFN0b3JhZ2UucmVtb3ZlSXRlbShjb21wdXRlTG9naW5JbmZvTG9jYWxTdG9yYWdlS2V5KG9yaWdpbikpOwp9CmFzeW5jIGZ1bmN0aW9uIGNvbXB1dGVNYXN0b2RvbklkRm9yVXJsKHJlcGx5VG9VcmwsIGZldGNoZXIpIHsKICAgIGNvbnN0IHsgcGF0aG5hbWUgIH0gPSBuZXcgVVJMKHJlcGx5VG9VcmwpOwogICAgY29uc3QgbSA9IC9eXC8uKj9cLyhcZCspJC8uZXhlYyhwYXRobmFtZSk7CiAgICBpZiAobSkgcmV0dXJuIG1bMV07CiAgICBpZiAoL14uKj9cL29iamVjdHNcL1swLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvLnRlc3QobmV3IFVSTChyZXBseVRvVXJsKS5wYXRobmFtZSkpIHsKICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaGVyKHJlcGx5VG9VcmwsIHsKICAgICAgICAgICAgYWNjZXB0OiAndGV4dC9odG1sJwogICAgICAgIH0pOwogICAgICAgIGlmIChyZXMuc3RhdHVzICE9PSAyMDApIHRocm93IG5ldyBFcnJvcihgQmFkIHN0YXR1cyAke3Jlcy5zdGF0dXN9LCBleHBlY3RlZCAyMDAgZm9yICR7cmVwbHlUb1VybH1gKTsKICAgICAgICBjb25zdCBtMiA9IC9eXC8uKj9cLyhbYS16QS1aMC05XSspJC8uZXhlYyhuZXcgVVJMKHJlcy51cmwpLnBhdGhuYW1lKTsKICAgICAgICBpZiAobTIpIHJldHVybiBtMlsxXTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgY29tcHV0ZU1hc3RvZG9uSWRGb3JVcmw6IHVuYWJsZSB0byBjb21wdXRlIGZvciAke3JlcGx5VG9Vcmx9YCk7Cn0KZnVuY3Rpb24gaXNMb2dpbkluZm8ob2JqKSB7CiAgICByZXR1cm4gaXNTdHJpbmdSZWNvcmQob2JqKSAmJiB0eXBlb2Ygb2JqLm9yaWdpbiA9PT0gJ3N0cmluZycgJiYgaXNPYXV0aE9idGFpblRva2VuUmVzcG9uc2Uob2JqLnRva2VuUmVzcG9uc2UpOwp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKZnVuY3Rpb24gZXh0ZXJuYWxpemVBbmNob3IoYW5jaG9yKSB7CiAgICBhbmNob3IudGFyZ2V0ID0gJ19ibGFuayc7CiAgICBhbmNob3IucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwp9CmNvbnN0IENPTU1FTlRTX0hUTUwgPSBodG1sYAo8ZGV0YWlscyBpZD0iY29tbWVudHMtZGV0YWlscyIgb3Blbj4KICAgIDxzdW1tYXJ5PkNvbW1lbnRzIGZvciA8c3BhbiBpZD0iY29tbWVudHMtc3ViamVjdCI+c3ViamVjdDwvc3Bhbj48L3N1bW1hcnk+CiAgICA8b3V0cHV0IGlkPSJjb21tZW50cyI+PC9vdXRwdXQ+CjwvZGV0YWlscz4KYDsKY29uc3QgQ09NTUVOVFNfQ1NTID0gY3NzYAoKI2NvbW1lbnRzLWRldGFpbHMgewogICAgZGlzcGxheTogbm9uZTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBtYXgtd2lkdGg6IDEwMCU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouY29tbWVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgbWF4LXdpZHRoOiA4MGNoOwogICAgbGluZS1oZWlnaHQ6IDEuNTsKfQoKLmNvbW1lbnQgLmljb24gewogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgYm9yZGVyLXJhZGl1czogMC41ZW07CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMWVtIDA7Cn0KCi5jb21tZW50IC5yaHMgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMCAwOwogICAgZmxleC1ncm93OiAxOwp9CgouY29tbWVudCAuaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNWVtOwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAuaGVhZGVyIC51cmwgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAucmhzIHAgewogICAgbWFyZ2luLWJsb2NrLXN0YXJ0OiAwZW07CiAgICBtYXJnaW4tYmxvY2stZW5kOiAwZW07Cn0KCi5jb21tZW50IGltZyB7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICB3aWR0aDogYXV0bzsKICAgIGhlaWdodDogYXV0bzsKfQoKLnJlcGx5IGZpZWxkc2V0IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgYm9yZGVyOiBzb2xpZCAxcHggJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0gCgoucmVwbHkgdGV4dGFyZWEgewogICAgd2lkdGg6IDEwMCU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS5iYWNrZ3JvdW5kQ29sb3JIZXgpfTsKICAgIG1hcmdpbi10b3A6IDAuNXJlbTsKfQoKLnJlcGx5IGJ1dHRvbiB7CiAgICBwYWRkaW5nOiAwLjI1cmVtIDJyZW07CiAgICBhbGlnbi1zZWxmOiBmbGV4LWVuZDsKICAgIG1hcmdpbjogMC41cmVtIDA7Cn0KCmA7CmZ1bmN0aW9uIGluaXRDb21tZW50cyhkb2N1bWVudCwgdm0xKSB7CiAgICBjb25zdCBjb21tZW50c0RldGFpbHMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtZGV0YWlscycpOwogICAgY29uc3QgY29tbWVudHNTdWJqZWN0U3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cy1zdWJqZWN0Jyk7CiAgICBjb25zdCBjb21tZW50c091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdm0xLmZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgY29tbWVudHNEZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSByZXN1bHQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGNvbW1lbnRzU3ViamVjdFNwYW4udGV4dENvbnRlbnQgPSByZXN1bHQ/LnN1YmplY3QgfHwgJ3N1YmplY3QnOwogICAgICAgIGlmIChyZXN1bHQgIT09IF9yZW5kZXJlZFJlc3VsdCkgewogICAgICAgICAgICByZW5kZXJDb21tZW50cyhyZXN1bHQsIGNvbW1lbnRzT3V0cHV0LCB2bTEpOwogICAgICAgICAgICBfcmVuZGVyZWRSZXN1bHQgPSByZXN1bHQ7CiAgICAgICAgfQogICAgfTsKfQpsZXQgX3JlbmRlcmVkUmVzdWx0OwpmdW5jdGlvbiByZW5kZXJDb21tZW50cyhyZXN1bHQsIGNvbW1lbnRzT3V0cHV0LCB2bTIpIHsKICAgIHdoaWxlKGNvbW1lbnRzT3V0cHV0LmZpcnN0Q2hpbGQpY29tbWVudHNPdXRwdXQucmVtb3ZlQ2hpbGQoY29tbWVudHNPdXRwdXQuZmlyc3RDaGlsZCk7CiAgICBpZiAocmVzdWx0KSByZW5kZXJOb2RlKHJlc3VsdC5yb290Q29tbWVudCwgcmVzdWx0LmNvbW1lbnRlcnMsIGNvbW1lbnRzT3V0cHV0LCAwLCB2bTIpOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUoY29tbWVudCwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwsIHZtMykgewogICAgY29uc3QgY29tbWVudGVyID0gY29tbWVudC5hdHRyaWJ1dGVkVG8gPyBjb21tZW50ZXJzLmdldChjb21tZW50LmF0dHJpYnV0ZWRUbykgOiB1bmRlZmluZWQ7CiAgICBjb25zdCBjb21tZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb21tZW50RGl2LmNsYXNzTGlzdC5hZGQoJ2NvbW1lbnQnKTsKICAgIGlmIChsZXZlbCA+IDApIGNvbW1lbnREaXYuc3R5bGUubWFyZ2luTGVmdCA9IGAke2xldmVsICogNH1lbWA7CiAgICBjb25zdCBpY29uSW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICBpY29uSW1nLmNsYXNzTGlzdC5hZGQoJ2ljb24nKTsKICAgIGljb25JbWcuc3JjID0gY29tbWVudGVyICYmIGNvbW1lbnRlci5pY29uID8gY29tbWVudGVyLmljb24udXJsIDogJyMnOwogICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChpY29uSW1nKTsKICAgIGNvbnN0IHJoc0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgcmhzRGl2LmNsYXNzTGlzdC5hZGQoJ3JocycpOwogICAgY29uc3QgaGVhZGVyRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBoZWFkZXJEaXYuY2xhc3NMaXN0LmFkZCgnaGVhZGVyJyk7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9EaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGF0dHJpYnV0ZWRUb0Rpdi5jbGFzc0xpc3QuYWRkKCdhdHRyaWJ1dGVkLXRvJyk7CiAgICBpZiAoY29tbWVudGVyKSB7CiAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhLmhyZWYgPSBjb21tZW50ZXIudXJsOwogICAgICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgYS50ZXh0Q29udGVudCA9IGNvbW1lbnRlci5uYW1lICsgJyAnICsgY29tbWVudGVyLmZxVXNlcm5hbWU7CiAgICAgICAgYXR0cmlidXRlZFRvRGl2LmFwcGVuZENoaWxkKGEpOwogICAgfSBlbHNlIHsKICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29tbWVudC5hdHRyaWJ1dGVkVG8gfHwgJzx1bmtub3duPicpKTsKICAgIH0KICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhdHRyaWJ1dGVkVG9EaXYpOwogICAgY29uc3QgYWdlVGV4dCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbW1lbnQucHVibGlzaGVkID8gY29tcHV0ZUFnZShuZXcgRGF0ZShjb21tZW50LnB1Ymxpc2hlZCkpIDogJycpOwogICAgaWYgKGNvbW1lbnQudXJsKSB7CiAgICAgICAgY29uc3QgYWdlQW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGFnZUFuY2hvci5jbGFzc0xpc3QuYWRkKCd1cmwnKTsKICAgICAgICBhZ2VBbmNob3IuaHJlZiA9IGNvbW1lbnQudXJsOwogICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGFnZUFuY2hvcik7CiAgICAgICAgYWdlQW5jaG9yLmFwcGVuZENoaWxkKGFnZVRleHQpOwogICAgICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhZ2VBbmNob3IpOwogICAgfSBlbHNlIHsKICAgICAgICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQoYWdlVGV4dCk7CiAgICB9CiAgICByaHNEaXYuYXBwZW5kQ2hpbGQoaGVhZGVyRGl2KTsKICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gY29tbWVudC5jb250ZW50OwogICAgY29udGVudERpdi5xdWVyeVNlbGVjdG9yQWxsKCdhJykuZm9yRWFjaChleHRlcm5hbGl6ZUFuY2hvcik7CiAgICByaHNEaXYuYXBwZW5kQ2hpbGQoY29udGVudERpdik7CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgY29tbWVudC5hdHRhY2htZW50cyl7CiAgICAgICAgY29uc3QgYXR0YWNobWVudERldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkZXRhaWxzJyk7CiAgICAgICAgY29uc3Qgc3VtbWFyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1bW1hcnknKTsKICAgICAgICBzdW1tYXJ5LnRleHRDb250ZW50ID0gYEF0dGFjaG1lbnQgKCR7YXR0YWNobWVudC5tZWRpYVR5cGV9KWA7CiAgICAgICAgYXR0YWNobWVudERldGFpbHMuYXBwZW5kQ2hpbGQoc3VtbWFyeSk7CiAgICAgICAgY29uc3QgaW1nID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnaW1nJyk7CiAgICAgICAgaW1nLnNyYyA9IGF0dGFjaG1lbnQudXJsOwogICAgICAgIGlmIChhdHRhY2htZW50LndpZHRoICYmIGF0dGFjaG1lbnQuaGVpZ2h0KSB7CiAgICAgICAgICAgIGltZy53aWR0aCA9IGF0dGFjaG1lbnQud2lkdGg7CiAgICAgICAgICAgIGltZy5oZWlnaHQgPSBhdHRhY2htZW50LmhlaWdodDsKICAgICAgICB9CiAgICAgICAgYXR0YWNobWVudERldGFpbHMuYXBwZW5kQ2hpbGQoaW1nKTsKICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQoYXR0YWNobWVudERldGFpbHMpOwogICAgfQogICAgaWYgKGNvbW1lbnQudXJsKSB7CiAgICAgICAgY29uc3QgcmVwbHlUb1VybCA9IGNvbW1lbnQudXJsOwogICAgICAgIGNvbnN0IHJlcGx5RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmVwbHlEaXYuY2xhc3NOYW1lID0gJ3JlcGx5JzsKICAgICAgICBjb25zdCByZXBseUFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICByZXBseUFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgICAgIHJlcGx5QW5jaG9yLmhyZWYgPSAnIyc7CiAgICAgICAgcmVwbHlEaXYuYXBwZW5kQ2hpbGQocmVwbHlBbmNob3IpOwogICAgICAgIGNvbnN0IHJlcGx5RmllbGRzZXRDb250YWluZXIgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByZXBseURpdi5hcHBlbmRDaGlsZChyZXBseUZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICByZXBseUFuY2hvci5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgdG9nZ2xlUmVwbHlCb3gocmVwbHlBbmNob3IsIHJlcGx5RmllbGRzZXRDb250YWluZXIsIHJlcGx5VG9VcmwsIHZtMyk7CiAgICAgICAgfTsKICAgICAgICByaHNEaXYuYXBwZW5kQ2hpbGQocmVwbHlEaXYpOwogICAgfQogICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChyaHNEaXYpOwogICAgY29udGFpbmVyRWxlbWVudC5hcHBlbmRDaGlsZChjb21tZW50RGl2KTsKICAgIGZvciAoY29uc3QgcmVwbHkgb2YgY29tbWVudC5yZXBsaWVzKXsKICAgICAgICByZW5kZXJOb2RlKHJlcGx5LCBjb21tZW50ZXJzLCBjb250YWluZXJFbGVtZW50LCBsZXZlbCArIDEsIHZtMyk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFnZShkYXRlKSB7CiAgICBjb25zdCBtaWxsaXMgPSBEYXRlLm5vdygpIC0gZGF0ZS5nZXRUaW1lKCk7CiAgICBjb25zdCBzZWNvbmRzID0gbWlsbGlzIC8gMTAwMDsKICAgIGNvbnN0IG1pbnV0ZXMgPSBzZWNvbmRzIC8gNjA7CiAgICBpZiAobWludXRlcyA8IDYwKSByZXR1cm4gYCR7TWF0aC5tYXgoTWF0aC5mbG9vcihtaW51dGVzKSwgMSl9bWA7CiAgICBjb25zdCBob3VycyA9IG1pbnV0ZXMgLyA2MDsKICAgIGlmIChob3VycyA8IDI0KSByZXR1cm4gYCR7TWF0aC5mbG9vcihob3Vycyl9aGA7CiAgICBjb25zdCBkYXlzID0gaG91cnMgLyAyNDsKICAgIHJldHVybiBgJHtNYXRoLmZsb29yKGRheXMpfWRgOwp9CmZ1bmN0aW9uIHRvZ2dsZVJlcGx5Qm94KGFuY2hvciwgZmllbGRzZXRDb250YWluZXIsIHJlcGx5VG9VcmwsIHZtNCkgewogICAgaWYgKGFuY2hvci50ZXh0Q29udGVudD8uc3RhcnRzV2l0aCgnUmVwbHknKSkgewogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICdDYW5jZWwg4oW5JzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihSRVBMWV9CT1gsIGZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICBjb25zdCBsb2dpbkFuY2hvciA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdhJylbMF07CiAgICAgICAgY29uc3QgdGV4dGFyZWEgPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgndGV4dGFyZWEnKVswXTsKICAgICAgICBjb25zdCBidXR0b24gPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYnV0dG9uJylbMF07CiAgICAgICAgY29uc3Qgb3V0cHV0ID0gZmllbGRzZXRDb250YWluZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ291dHB1dCcpWzBdOwogICAgICAgIGNvbnN0IG91dHB1dEFuY2hvciA9IG91dHB1dC5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYScpWzBdOwogICAgICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBVUkwocmVwbHlUb1VybCkub3JpZ2luOwogICAgICAgIG91dHB1dEFuY2hvci50ZXh0Q29udGVudCA9IG9yaWdpbjsKICAgICAgICBsZXQgc2VudCA9IGZhbHNlOwogICAgICAgIGxldCBuZXdSZXBseVVybDsKICAgICAgICBjb25zdCB1cGRhdGUgPSAoKT0+ewogICAgICAgICAgICBjb25zdCBsb2dnZWRJbiA9IHZtNC5pc0xvZ2dlZEluKG9yaWdpbik7CiAgICAgICAgICAgIGxvZ2luQW5jaG9yLnRleHRDb250ZW50ID0gbG9nZ2VkSW4gPyBgU2lnbiBvdXQgb2YgJHtvcmlnaW59YCA6IGBTaWduIGluIGF0ICR7b3JpZ2lufS4uLmA7CiAgICAgICAgICAgIGxvZ2luQW5jaG9yLnN0eWxlLmRpc3BsYXkgPSAhc2VudCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIHRleHRhcmVhLnN0eWxlLmRpc3BsYXkgPSBidXR0b24uc3R5bGUuZGlzcGxheSA9IGxvZ2dlZEluICYmICFzZW50ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgb3V0cHV0LnN0eWxlLmRpc3BsYXkgPSBzZW50ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICAgICAgb3V0cHV0QW5jaG9yLmhyZWYgPSBuZXdSZXBseVVybCB8fCBvcmlnaW47CiAgICAgICAgfTsKICAgICAgICBsb2dpbkFuY2hvci5vbmNsaWNrID0gKGUxKT0+ewogICAgICAgICAgICBlMS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBjb25zdCBsb2dnZWRJbiA9IHZtNC5pc0xvZ2dlZEluKG9yaWdpbik7CiAgICAgICAgICAgIGlmIChsb2dnZWRJbikgewogICAgICAgICAgICAgICAgdm00LmV4cGlyZUxvZ2luKG9yaWdpbik7CiAgICAgICAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHcgPSB3aW5kb3cub3BlbihgL2xvZ2luP29yaWdpbj0ke2VuY29kZVVSSUNvbXBvbmVudChvcmlnaW4pfWAsICdsb2dpbicpOwogICAgICAgICAgICAgICAgaWYgKHcpIHsKICAgICAgICAgICAgICAgICAgICBnbG9iYWxUaGlzLm9ubWVzc2FnZSA9IChlKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGRhdGEgIH0gPSBlOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnb25tZXNzYWdlJywgZGF0YSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgZGF0YS5vcmlnaW4gPT09ICdzdHJpbmcnICYmIGlzT2F1dGhPYnRhaW5Ub2tlblJlc3BvbnNlKGRhdGEudG9rZW5SZXNwb25zZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZtNC5hY2NlcHRMb2dpbihkYXRhLm9yaWdpbiwgZGF0YS50b2tlblJlc3BvbnNlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZSgpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgdy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgYnV0dG9uLm9uY2xpY2sgPSBhc3luYyAoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICBuZXdSZXBseVVybCA9IGF3YWl0IHZtNC5zZW5kUmVwbHkodGV4dGFyZWEudmFsdWUudHJpbSgpLCByZXBseVRvVXJsKTsKICAgICAgICAgICAgc2VudCA9IHRydWU7CiAgICAgICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICdDbG9zZSDihbknOwogICAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICB9OwogICAgICAgIHVwZGF0ZSgpOwogICAgICAgIHRleHRhcmVhLmZvY3VzKCk7CiAgICB9IGVsc2UgewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKHVuZGVmaW5lZCwgZmllbGRzZXRDb250YWluZXIpOwogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICJSZXBseSDihpIiOwogICAgfQp9CmNvbnN0IFJFUExZX0JPWCA9IGh0bWxgCjxmaWVsZHNldD4KICAgIDxsZWdlbmQ+UmVwbHk8L2xlZ2VuZD4KICAgIDxhIGhyZWY9IiMiPkxvZ2luIHRvIC4uLjwvYT4KICAgIDx0ZXh0YXJlYSB0eXBlPSJ0ZXh0IiBuYW1lPSJjb250ZW50IiByb3dzPSI0IiBwbGFjZWhvbGRlcj0iWW91ciByZXBseS4uLiI+PC90ZXh0YXJlYT4KICAgIDxidXR0b24gdHlwZT0ic3VibWl0Ij5TZW5kPC9idXR0b24+CiAgICA8b3V0cHV0PlJlcGx5IHNlbnQhIEl0IG1heSB0YWtlIGEgd2hpbGUgdG8gYXBwZWFyIGhlcmUsIGJ1dCB5b3UgY2FuIHZpZXcgaXQgb3ZlciBhdCA8YSBocmVmPSIjIiB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93Ij4ob3JpZ2luKTwvYT48L291dHB1dD4KPC9maWVsZHNldD4KYDsKY29uc3QgSU5GT19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnptMS05QzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHoiLz48L3N2Zz5gOwpjb25zdCBXQVJOSU5HX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PHBhdGggZD0iTTEyIDUuOTlMMTkuNTMgMTlINC40N0wxMiA1Ljk5TTIuNzQgMThjLS43NyAxLjMzLjE5IDMgMS43MyAzaDE1LjA2YzEuNTQgMCAyLjUtMS42NyAxLjczLTNMMTMuNzMgNC45OWMtLjc3LTEuMzMtMi42OS0xLjMzLTMuNDYgMEwyLjc0IDE4ek0xMSAxMXYyYzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMXYtMmMwLS41NS0uNDUtMS0xLTFzLTEgLjQ1LTEgMXptMCA1aDJ2MmgtMnoiLz48L3N2Zz5gOwpjb25zdCBFUlJPUl9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0yMC43MSA3Ljk4TDE2LjAzIDMuM2MtLjE5LS4xOS0uNDUtLjMtLjcxLS4zSDguNjhjLS4yNiAwLS41Mi4xMS0uNy4yOUwzLjI5IDcuOThjLS4xOC4xOC0uMjkuNDQtLjI5Ljd2Ni42M2MwIC4yNy4xMS41Mi4yOS43MWw0LjY4IDQuNjhjLjE5LjE5LjQ1LjMuNzEuM2g2LjYzYy4yNyAwIC41Mi0uMTEuNzEtLjI5bDQuNjgtNC42OGMuMTktLjE5LjI5LS40NC4yOS0uNzFWOC42OGMuMDEtLjI2LS4xLS41Mi0uMjgtLjd6TTE5IDE0LjlMMTQuOSAxOUg5LjFMNSAxNC45VjkuMUw5LjEgNWg1LjhMMTkgOS4xdjUuOHoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjE2IiByPSIxIi8+PHBhdGggZD0iTTEyIDdjLS41NSAwLTEgLjQ1LTEgMXY1YzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMVY4YzAtLjU1LS40NS0xLTEtMXoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHptMy44OC0xMS43MUwxMCAxNC4xN2wtMS44OC0xLjg4Yy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMC0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDIuNTkgMi41OWMuMzkuMzkgMS4wMi4zOSAxLjQxIDBMMTcuMyA5LjdjLjM5LS4zOS4zOS0xLjAyIDAtMS40MS0uMzktLjM5LTEuMDMtLjM5LTEuNDIgMHoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS0xJU1RfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik01LDVoMnYxYzAsMS4xLDAuOSwyLDIsMmg2YzEuMSwwLDItMC45LDItMlY1aDJ2NWgyVjVjMC0xLjEtMC45LTItMi0yaC00LjE4QzE0LjQsMS44NCwxMy4zLDEsMTIsMVM5LjYsMS44NCw5LjE4LDNINSBDMy45LDMsMywzLjksMyw1djE0YzAsMS4xLDAuOSwyLDIsMmg2di0ySDVWNXogTTEyLDNjMC41NSwwLDEsMC40NSwxLDFzLTAuNDUsMS0xLDFzLTEtMC40NS0xLTFTMTEuNDUsMywxMiwzeiIvPjxwYXRoIGQ9Ik0yMS43NSwxMi4yNWMtMC40MS0wLjQxLTEuMDktMC40MS0xLjUsMEwxNS41MSwxN2wtMi4yNi0yLjI1Yy0wLjQxLTAuNDEtMS4wOC0wLjQxLTEuNSwwbDAsMGMtMC40MSwwLjQxLTAuNDEsMS4wOSwwLDEuNSBsMy4wNSwzLjA0YzAuMzksMC4zOSwxLjAyLDAuMzksMS40MSwwbDUuNTMtNS41NEMyMi4xNiwxMy4zNCwyMi4xNiwxMi42NiwyMS43NSwxMi4yNXoiLz48L2c+PC9nPjwvc3ZnPmA7CmNvbnN0IFNRVUFSRV9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNCAyNCIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48Zz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjI0IiB3aWR0aD0iMjQiLz48L2c+PGc+PGc+PHBhdGggZD0iTTMsM3YxOGgxOFYzSDN6IE0xOSwxOUg1VjVoMTRWMTl6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBGT1JNX0hUTUwgPSBodG1sYAo8aGVhZGVyPiR7Q0hFQ0tMSVNUX0lDT059PGgxPkxpdmV3aXJlIFBvZGNhc3QgVmFsaWRhdG9yIDxzcGFuIGlkPSJ2ZXJzaW9uIj52MC4yPC9zcGFuPjwvaDE+PC9oZWFkZXI+Cjxmb3JtIGlkPSJmb3JtIj4KICAgIDxpbnB1dCBpZD0idGV4dC1pbnB1dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IlBvZGNhc3QgZmVlZCB1cmwsIEFjdGl2aXR5UHViIHVybCwgQXBwbGUgUG9kY2FzdHMgdXJsLCBvciBzZWFyY2ggdGV4dCIgYXV0b2NvbXBsZXRlPSJ1cmwiIHJlcXVpcmVkPgogICAgPGJ1dHRvbiBpZD0ic3VibWl0IiB0eXBlPSJzdWJtaXQiPlZhbGlkYXRlPC9idXR0b24+CjwvZm9ybT4KYDsKY29uc3QgRk9STV9DU1MgPSBjc3NgCgpoZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDFyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgb3BhY2l0eTogMC43NTsKfQoKaGVhZGVyIGgxIHsKICAgIG1hcmdpbjogMDsKfQoKaGVhZGVyIHN2ZyB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiN2ZXJzaW9uIHsKICAgIG9wYWNpdHk6IDAuMjU7Cn0KCiNmb3JtIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwp9CgovKiogaW9zIHJlc2V0cyAqLwpAc3VwcG9ydHMgKC13ZWJraXQtdG91Y2gtY2FsbG91dDogbm9uZSkgewogICAgaW5wdXQsIHRleHRhcmVhLCBidXR0b24gewogICAgICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgICAgICBib3JkZXItcmFkaXVzOiAwOwogICAgfQoKICAgIGJ1dHRvbiB7CiAgICAgICAgYm9yZGVyOiBzb2xpZCAxcHggd2hpdGU7CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDY1MHB4KSB7CgogICAgaGVhZGVyIHsKICAgICAgICBmb250LXNpemU6IDY2JTsKICAgICAgICBnYXA6IDAuNXJlbTsKICAgIH0KCiAgICBoZWFkZXIgc3ZnIHsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7CiAgICB9CgogICAgI2Zvcm0gewogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDUwMHB4KSB7CgogICAgI3ZlcnNpb24gewogICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9Cgp9CgojdGV4dC1pbnB1dCB7CiAgICBmb250LXNpemU6IDFyZW07CiAgICBmbGV4LWdyb3c6IDE7CiAgICBwYWRkaW5nOiAwLjVyZW0gMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgb3V0bGluZTogbm9uZTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3RleHQtaW5wdXQ6cmVhZC1vbmx5IHsKICAgIG9wYWNpdHk6IDAuNTsgCn0KCmlucHV0Oi13ZWJraXQtYXV0b2ZpbGwsIGlucHV0Oi13ZWJraXQtYXV0b2ZpbGw6Zm9jdXMgewogICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciA2MDAwMDBzIDBzLCBjb2xvciA2MDAwMDBzIDBzOwp9CgojZm9ybSBidXR0b24gewogICAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRGb3JtKGRvY3VtZW50LCB2bTUsIHN0YXRpY0RhdGExKSB7CiAgICBjb25zdCBmb3JtID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2Zvcm0nKTsKICAgIGNvbnN0IHRleHRJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd0ZXh0LWlucHV0Jyk7CiAgICBjb25zdCBzdWJtaXRCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc3VibWl0Jyk7CiAgICBjb25zdCB2ZXJzaW9uU3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2ZXJzaW9uJyk7CiAgICBjb25zdCB2ZXJzaW9uID0gWwogICAgICAgIHN0YXRpY0RhdGExLnZlcnNpb24sCiAgICAgICAgc3RhdGljRGF0YTEucHVzaElkCiAgICBdLm1hcCgodik9Pih2IHx8ICcnKS50cmltKCkKICAgICkuZmlsdGVyKCh2KT0+di5sZW5ndGggPiAwCiAgICApLmpvaW4oJy4nKTsKICAgIHZlcnNpb25TcGFuLnRleHRDb250ZW50ID0gc3RhdGljRGF0YTEudmVyc2lvbiA/IGB2JHt2ZXJzaW9ufWAgOiAnJzsKICAgIGNvbnN0IHsgc2VhcmNoUGFyYW1zICB9ID0gbmV3IFVSTChkb2N1bWVudC5VUkwpOwogICAgY29uc3QgdmFsaWRhdGUxID0gc2VhcmNoUGFyYW1zLmdldCgndmFsaWRhdGUnKSB8fCB1bmRlZmluZWQ7CiAgICBjb25zdCBpbnB1dCA9IHNlYXJjaFBhcmFtcy5nZXQoJ2lucHV0JykgfHwgdW5kZWZpbmVkOwogICAgY29uc3Qgbm9jb21tZW50cyA9IHNlYXJjaFBhcmFtcy5oYXMoJ25vY29tbWVudHMnKTsKICAgIGNvbnN0IHN0YXJ0VmFsaWRhdGlvbiA9ICgpPT52bTUuc3RhcnRWYWxpZGF0aW9uKHRleHRJbnB1dC52YWx1ZSwgewogICAgICAgICAgICB2YWxpZGF0ZUNvbW1lbnRzOiAhbm9jb21tZW50cywKICAgICAgICAgICAgdXNlckFnZW50OiBuYXZpZ2F0b3IudXNlckFnZW50CiAgICAgICAgfSkKICAgIDsKICAgIGZvcm0ub25zdWJtaXQgPSAoZSk9PnsKICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgaWYgKHZtNS52YWxpZGF0aW5nKSB7CiAgICAgICAgICAgIHZtNS5jYW5jZWxWYWxpZGF0aW9uKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRWYWxpZGF0aW9uKCk7CiAgICAgICAgfQogICAgfTsKICAgIGlmICh2YWxpZGF0ZTEpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSB2YWxpZGF0ZTE7CiAgICAgICAgc2V0VGltZW91dChzdGFydFZhbGlkYXRpb24sIDApOwogICAgfSBlbHNlIGlmIChpbnB1dCkgewogICAgICAgIHRleHRJbnB1dC52YWx1ZSA9IGlucHV0OwogICAgfQogICAgdGV4dElucHV0LmZvY3VzKCk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB3YXNEaXNhYmxlZCA9IHRleHRJbnB1dC5kaXNhYmxlZDsKICAgICAgICB0ZXh0SW5wdXQuZGlzYWJsZWQgPSB2bTUudmFsaWRhdGluZzsKICAgICAgICB0ZXh0SW5wdXQucmVhZE9ubHkgPSB2bTUudmFsaWRhdGluZzsKICAgICAgICBzdWJtaXRCdXR0b24udGV4dENvbnRlbnQgPSB2bTUudmFsaWRhdGluZyA/ICdDYW5jZWwnIDogJ1ZhbGlkYXRlJzsKICAgICAgICBpZiAod2FzRGlzYWJsZWQgJiYgIXRleHRJbnB1dC5kaXNhYmxlZCkgewogICAgICAgICAgICB0ZXh0SW5wdXQuZm9jdXMoKTsKICAgICAgICB9CiAgICB9Owp9CmNvbnN0IE1FU1NBR0VTX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJtZXNzYWdlcyI+PC9vdXRwdXQ+CmA7CmNvbnN0IE1FU1NBR0VTX0NTUyA9IGNzc2AKCiNtZXNzYWdlcyB7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgZGlzcGxheTogZ3JpZDsKICAgIGdyaWQtdGVtcGxhdGUtY29sdW1uczogMnJlbSBhdXRvOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKfQoKI21lc3NhZ2VzID4gZGl2LCAjbWVzc2FnZXMgPiBhIHsKICAgIGFuaW1hdGlvbjogZmFkZUluQW5pbWF0aW9uIDAuNHM7Cn0KCiNtZXNzYWdlcyBzdmcgewogICAgdHJhbnNmb3JtOiBzY2FsZSgwLjc1KTsKICAgIGZpbGw6IGN1cnJlbnRDb2xvcjsKfQoKI21lc3NhZ2VzID4gZGl2LmluZm8gewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgojbWVzc2FnZXMgPiBkaXYuZ29vZCB7CiAgICBjb2xvcjogIzQzYTA0NzsKfQojbWVzc2FnZXMgPiBkaXYud2FybmluZyB7CiAgICBjb2xvcjogI2U2NTEwMDsKfQoKI21lc3NhZ2VzID4gZGl2LmVycm9yIHsKICAgIGNvbG9yOiAjYjcxYzFjOwp9CgojbWVzc2FnZXMgPiBkaXYucnVubmluZywgI21lc3NhZ2VzID4gZGl2LmRvbmUgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9Owp9CgojbWVzc2FnZXMgLmljb24gewogICAgZ3JpZC1jb2x1bW46IDE7CiAgICB3aWR0aDogMjRweDsKICAgIGhlaWdodDogMjRweDsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBqdXN0aWZ5LWNvbnRlbnQ6IGNlbnRlcjsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7Cn0KCiNtZXNzYWdlcyAubWVzc2FnZSB7CiAgICBncmlkLWNvbHVtbjogMjsKfQoKI21lc3NhZ2VzIC51cmwgewogICAgZ3JpZC1jb2x1bW46IDI7CiAgICBtYXJnaW4tYm90dG9tOiAwLjI1cmVtOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKICAgIHRleHQtb3ZlcmZsb3c6IGVsbGlwc2lzOwp9CgojbWVzc2FnZXMgcHJvZ3Jlc3MgewogICAgZm9udC1zaXplOiAwLjM1cmVtOwp9CgojbWVzc2FnZXMgLnJlZmVyZW5jZSB7CiAgICBkaXNwbGF5OiBpbmxpbmUtYmxvY2s7CiAgICBtYXJnaW4tbGVmdDogMC4yNXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdE1lc3NhZ2VzKGRvY3VtZW50LCB2bTYpIHsKICAgIGNvbnN0IG1lc3NhZ2VzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2VzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihNRVNTQUdFX0hUTUwodm02KSwgbWVzc2FnZXNPdXRwdXQpOwogICAgfTsKfQpjb25zdCBNRVNTQUdFX0hUTUwgPSAodm03KT0+aHRtbGAKICAgICR7dm03Lm1lc3NhZ2VzLmZpbHRlcihmaWx0ZXJEdXBsaWNhdGVzKCkpLm1hcCgobWVzc2FnZSk9Pmh0bWxgCiAgICAgICAgPGRpdiBjbGFzcz0iJHttZXNzYWdlLnR5cGV9IGljb24iPiR7aWNvbihtZXNzYWdlLnR5cGUpfTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBtZXNzYWdlIj4ke21lc3NhZ2UudGV4dH0ke1JFRkVSRU5DRV9IVE1MKG1lc3NhZ2UucmVmZXJlbmNlKX08L2Rpdj4KICAgICAgICAke0FOQ0hPUl9IVE1MKG1lc3NhZ2UudXJsKX1gCiAgICApfWAKOwpjb25zdCBSRUZFUkVOQ0VfSFRNTCA9IChyZWZlcmVuY2UpPT5yZWZlcmVuY2UgPyBodG1sYDxhIGNsYXNzPSJyZWZlcmVuY2UiIGhyZWY9JHtyZWZlcmVuY2UuaHJlZn0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyI+WyR7cmVmZXJlbmNlLnJ1bGVzZXR9XTwvYT5gIDogdW5kZWZpbmVkCjsKY29uc3QgQU5DSE9SX0hUTUwgPSAodXJsKT0+dXJsID8gaHRtbGA8YSBocmVmPSR7dXJsfSB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93IiBjbGFzcz0idXJsIj4ke3VybH08L2E+YCA6IHVuZGVmaW5lZAo7CmZ1bmN0aW9uIGljb24odHlwZSkgewogICAgcmV0dXJuIHR5cGUgPT09ICdydW5uaW5nJyA/IGh0bWxgPHByb2dyZXNzIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPmAgOiB0eXBlID09PSAnZG9uZScgPyBDSEVDS19JQ09OIDogdHlwZSA9PT0gJ2Vycm9yJyA/IEVSUk9SX0lDT04gOiB0eXBlID09PSAnd2FybmluZycgPyBXQVJOSU5HX0lDT04gOiB0eXBlID09PSAnZ29vZCcgPyBDSEVDS19JQ09OIDogSU5GT19JQ09OOwp9CmZ1bmN0aW9uIGZpbHRlckR1cGxpY2F0ZXMoKSB7CiAgICBjb25zdCB0YWdVcmxzID0gbmV3IFNldCgpOwogICAgcmV0dXJuIChtZXNzYWdlKT0+ewogICAgICAgIGNvbnN0IHsgdGFnICwgdXJsICB9ID0gbWVzc2FnZTsKICAgICAgICBpZiAodGFnICYmIHVybCkgewogICAgICAgICAgICBjb25zdCB0YWdVcmwgPSBgJHt0YWd9fCR7dXJsfWA7CiAgICAgICAgICAgIGlmICh0YWdVcmxzLmhhcyh0YWdVcmwpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRhZ1VybHMuYWRkKHRhZ1VybCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH07Cn0KY29uc3QgU0VBUkNIX1JFU1VMVFNfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InNlYXJjaC1yZXN1bHRzIj48L291dHB1dD4KYDsKY29uc3QgU0VBUkNIX1JFU1VMVFNfQ1NTID0gY3NzYAoKI3NlYXJjaC1yZXN1bHRzIHsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBkaXNwbGF5OiBub25lOwp9Cgojc2VhcmNoLXJlc3VsdHMgPiBkaXYgewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGFuaW1hdGlvbjogZmFkZUluQW5pbWF0aW9uIDAuNHM7CiAgICBtYXJnaW4tYm90dG9tOiAwLjc1cmVtOwogICAgY3Vyc29yOiBwb2ludGVyOwp9Cgojc2VhcmNoLXJlc3VsdHMgLmljb24sICNzZWFyY2gtcmVzdWx0cyBpbWcgewogICAgd2lkdGg6IDEuNXJlbTsKICAgIGhlaWdodDogMS41cmVtOwp9Cgojc2VhcmNoLXJlc3VsdHMgLnRpdGxlIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3NlYXJjaC1yZXN1bHRzIC5hdXRob3IgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgpgOwpmdW5jdGlvbiBpbml0U2VhcmNoUmVzdWx0cyhkb2N1bWVudCwgdm04KSB7CiAgICBjb25zdCBzZWFyY2hSZXN1bHRzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlYXJjaC1yZXN1bHRzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihSRVNVTFRTX0hUTUwodm04KSwgc2VhcmNoUmVzdWx0c091dHB1dCk7CiAgICAgICAgc2VhcmNoUmVzdWx0c091dHB1dC5zdHlsZS5kaXNwbGF5ID0gdm04LmlzU2VhcmNoID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgIH07Cn0KY29uc3QgUkVTVUxUU19IVE1MID0gKHZtOSk9Pmh0bWxgCiAgICAke3ZtOS5zZWFyY2hSZXN1bHRzLm1hcCgocmVzdWx0KT0+aHRtbGA8ZGl2IGNsYXNzPSJzZWFyY2gtcmVzdWx0IiBAY2xpY2s9IiR7c2VsZWN0UmVzdWx0KHZtOSwgcmVzdWx0LnVybCl9Ij48ZGl2IGNsYXNzPSJpY29uIj4ke0lNQUdFX0hUTUwocmVzdWx0LmFydHdvcmspfTwvZGl2PjxkaXYgY2xhc3M9InRpdGxlIj4ke3Jlc3VsdC50aXRsZX08L2Rpdj48ZGl2IGNsYXNzPSJhdXRob3IiPiR7cmVzdWx0LmF1dGhvcn08L2Rpdj48L2Rpdj5gCiAgICApfWAKOwpjb25zdCBJTUFHRV9IVE1MID0gKGFydHdvcmspPT5hcnR3b3JrID8gaHRtbGA8aW1nIHNyYz0ke2FydHdvcmt9PmAgOiBTUVVBUkVfSUNPTgo7CmZ1bmN0aW9uIHNlbGVjdFJlc3VsdCh2bTEwLCB1cmwpIHsKICAgIHJldHVybiAoKT0+dm0xMC5jb250aW51ZVdpdGgodXJsKQogICAgOwp9CmNvbnN0IFhNTF9IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ieG1sIj48L291dHB1dD4KYDsKY29uc3QgWE1MX0NTUyA9IGNzc2AKI3htbCB7CiAgICBmb250LWZhbWlseTogJHt1bnNhZmVDU1MoVGhlbWUubW9ub3NwYWNlRm9udEZhbWlseSl9OwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgbGluZS1oZWlnaHQ6IDFyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07CiAgICBvdmVyZmxvdy13cmFwOiBicmVhay13b3JkOwogICAgbGluZS1oZWlnaHQ6IDEuNDsKfQoKI3htbCAucm9vdCB7CiAgICBmb250LWZhbWlseTogJHt1bnNhZmVDU1MoVGhlbWUuc2Fuc1NlcmlmRm9udEZhbWlseSl9OwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbGluZS1oZWlnaHQ6IDI7Cn0KCiN4bWwgLmNvbnRlbnQgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9Owp9CgojeG1sIC5wb2RjYXN0IHsKICAgIGNvbG9yOiAjYWI0N2JjOwp9CgojeG1sIC5pbmRlbnQgewogICAgbWFyZ2luLWxlZnQ6IDAuNzVyZW07Cn0KCiN4bWwgLmluZGVudDIgewogICAgbWFyZ2luLWxlZnQ6IDEuNXJlbTsKfQoKc3VtbWFyeS5lbXB0eSB7IGxpc3Qtc3R5bGU6IG5vbmU7IGN1cnNvcjogdGV4dDsgfQpzdW1tYXJ5LmVtcHR5Ojotd2Via2l0LWRldGFpbHMtbWFya2VyIHsgZGlzcGxheTogbm9uZTsgfQoKI3htbCBhdWRpbyB7CiAgICBtYXJnaW46IDAuNXJlbSAxcmVtOwp9CmA7CmZ1bmN0aW9uIGluaXRYbWwoZG9jdW1lbnQsIHZtMTEpIHsKICAgIGNvbnN0IHhtbE91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd4bWwnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHhtbCA9IHZtMTEueG1sOwogICAgICAgIGlmICh4bWwgIT09IF9yZW5kZXJlZFhtbCkgewogICAgICAgICAgICByZW5kZXJYbWwoeG1sLCB4bWxPdXRwdXQsIHZtMTEueG1sU3VtbWFyeVRleHQpOwogICAgICAgICAgICBfcmVuZGVyZWRYbWwgPSB4bWw7CiAgICAgICAgfQogICAgfTsKfQpsZXQgX3JlbmRlcmVkWG1sOwpmdW5jdGlvbiByZW5kZXJYbWwoeG1sLCB4bWxPdXRwdXQsIHhtbFN1bW1hcnlUZXh0KSB7CiAgICB3aGlsZSh4bWxPdXRwdXQuZmlyc3RDaGlsZCl4bWxPdXRwdXQucmVtb3ZlQ2hpbGQoeG1sT3V0cHV0LmZpcnN0Q2hpbGQpOwogICAgaWYgKHhtbCkgcmVuZGVyTm9kZTEoeG1sLCB4bWxPdXRwdXQsIDAsIG5ldyBTZXQoKSwgdW5kZWZpbmVkLCB4bWxTdW1tYXJ5VGV4dCk7Cn0KZnVuY3Rpb24gcmVuZGVyTm9kZTEobm9kZSwgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwsIGNvbnRleHQsIGl0ZW1OdW1iZXIsIHhtbFN1bW1hcnlUZXh0KSB7CiAgICBjb25zdCB7IGF0dHMgIH0gPSBub2RlOwogICAgY29uc3QgZGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RldGFpbHMnKTsKICAgIGNvbnN0IHRleHQgPSBub2RlLnZhbCB8fCAnJzsKICAgIGRldGFpbHMub3BlbiA9ICFjb250ZXh0LmhhcygnZm91bmQtaXRlbScpIHx8IHRleHQubGVuZ3RoID4gMDsKICAgIGlmIChsZXZlbCA+IDApIGRldGFpbHMuY2xhc3NMaXN0LmFkZCgnaW5kZW50Jyk7CiAgICBjb25zdCBzdW1tYXJ5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3VtbWFyeScpOwogICAgaWYgKGxldmVsID09PSAwKSB7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhzdW1tYXJ5LCB4bWxTdW1tYXJ5VGV4dCB8fCAnWG1sJyk7CiAgICAgICAgc3VtbWFyeS5jbGFzc0xpc3QuYWRkKCdyb290Jyk7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IHNwYW5DbGFzcyA9IFFuYW1lcy5Qb2RjYXN0SW5kZXguTkFNRVNQQUNFUy5pbmNsdWRlcyhub2RlLnFuYW1lLm5hbWVzcGFjZVVyaSB8fCAnJykgPyAncG9kY2FzdCcgOiB1bmRlZmluZWQ7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhzdW1tYXJ5LCAnPCcsIHsKICAgICAgICAgICAgdGV4dDogbm9kZS50YWduYW1lLAogICAgICAgICAgICBzcGFuQ2xhc3MKICAgICAgICB9LCAuLi5bCiAgICAgICAgICAgIC4uLmF0dHMuZW50cmllcygpCiAgICAgICAgXS5mbGF0TWFwKCh2KT0+WwogICAgICAgICAgICAgICAgYCAke3ZbMF19PSJgLAogICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgIHRleHQ6IHZbMV0sCiAgICAgICAgICAgICAgICAgICAgc3BhbkNsYXNzOiAnY29udGVudCcKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAnIicKICAgICAgICAgICAgXQogICAgICAgICksICc+JywgaXRlbU51bWJlciA/IGAgIyR7aXRlbU51bWJlcn1gIDogJycpOwogICAgfQogICAgZGV0YWlscy5hcHBlbmRDaGlsZChzdW1tYXJ5KTsKICAgIGxldCBjaGlsZENvdW50ID0gMDsKICAgIGlmICh0ZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgnY29udGVudCcpOwogICAgICAgIHJlbmRlclRleHRQaWVjZXMoZGl2LCB0ZXh0KTsKICAgICAgICBkaXYuY2xhc3NMaXN0LmFkZCgnaW5kZW50MicpOwogICAgICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoZGl2KTsKICAgICAgICBjaGlsZENvdW50Kys7CiAgICB9CiAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMobm9kZS5jaGlsZCkpewogICAgICAgIGxldCBpdGVtTnVtYmVyID0gMTsKICAgICAgICBsZXQgaXRlbXNOb3RTaG93biA9IDA7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIGlmIChuYW1lID09PSAnaXRlbScgJiYgaXRlbU51bWJlciA+IDIwKSB7CiAgICAgICAgICAgICAgICBpdGVtc05vdFNob3duKys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZW5kZXJOb2RlMShjaGlsZCwgZGV0YWlscywgbGV2ZWwgKyAxLCBjb250ZXh0LCB2YWx1ZS5sZW5ndGggPiAxID8gaXRlbU51bWJlciA6IHVuZGVmaW5lZCk7CiAgICAgICAgICAgIGNoaWxkQ291bnQrKzsKICAgICAgICAgICAgaXRlbU51bWJlcisrOwogICAgICAgIH0KICAgICAgICBpZiAoaXRlbXNOb3RTaG93biA+IDApIHsKICAgICAgICAgICAgY29uc3QgZmFrZU5vZGUgPSB7CiAgICAgICAgICAgICAgICB0YWduYW1lOiBgLi4uYW5kICR7bmV3IEludGwuTnVtYmVyRm9ybWF0KCkuZm9ybWF0KGl0ZW1zTm90U2hvd24pfSBtb3JlIGl0ZW1zYCwKICAgICAgICAgICAgICAgIGF0dHM6IG5ldyBNYXAoKSwKICAgICAgICAgICAgICAgIHFuYW1lOiB7CiAgICAgICAgICAgICAgICAgICAgbmFtZTogJycKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBhdHRyc01hcDoge30sCiAgICAgICAgICAgICAgICBjaGlsZDoge30KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmVuZGVyTm9kZTEoZmFrZU5vZGUsIGRldGFpbHMsIGxldmVsIC0gMSwgY29udGV4dCwgdW5kZWZpbmVkKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zdCBhdWRpb1VybCA9IG5vZGUudGFnbmFtZSA9PT0gJ2VuY2xvc3VyZScgJiYgYXR0cy5nZXQoJ3VybCcpIHx8IG5vZGUucW5hbWUubmFtZXNwYWNlVXJpICYmIHFuYW1lc0luY2x1ZGUoUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VyY2UsIG5vZGUucW5hbWUpICYmIGF0dHMuZ2V0KCd1cmknKSB8fCBxbmFtZUVxKG5vZGUucW5hbWUsIFFuYW1lcy5NZWRpYVJzcy5jb250ZW50KSAmJiAoYXR0cy5nZXQoJ3R5cGUnKSB8fCAnJykuc3RhcnRzV2l0aCgnYXVkaW8nKSAmJiBhdHRzLmdldCgndXJsJyk7CiAgICBpZiAoYXVkaW9VcmwpIHsKICAgICAgICBjb25zdCBhdWRpbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7CiAgICAgICAgYXVkaW8uY29udHJvbHMgPSB0cnVlOwogICAgICAgIGF1ZGlvLnByZWxvYWQgPSAnbm9uZSc7CiAgICAgICAgYXVkaW8uc3JjID0gYXVkaW9Vcmw7CiAgICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChhdWRpbyk7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgaWYgKGNoaWxkQ291bnQgPT09IDApIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgnZW1wdHknLCAnaW5kZW50Jyk7CiAgICBjb250YWluZXJFbGVtZW50LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgaWYgKG5vZGUudGFnbmFtZSA9PT0gJ2l0ZW0nKSBjb250ZXh0LmFkZCgnZm91bmQtaXRlbScpOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRQaWVjZXMoZWxlbWVudCwgLi4ucGllY2VzKSB7CiAgICBmb3IgKGNvbnN0IHBpZWNlIG9mIHBpZWNlcyl7CiAgICAgICAgY29uc3QgdGV4dCA9IHR5cGVvZiBwaWVjZSA9PT0gJ3N0cmluZycgPyBwaWVjZSA6IHBpZWNlLnRleHQ7CiAgICAgICAgY29uc3Qgc3BhbkNsYXNzID0gdHlwZW9mIHBpZWNlID09PSAnb2JqZWN0JyA/IHBpZWNlLnNwYW5DbGFzcyA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAoL15odHRwcz86XC9cL1teXHMpXSskLy50ZXN0KHRleHQpKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHRleHQ7CiAgICAgICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGEpOwogICAgICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgICAgICBpZiAoc3BhbkNsYXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgc3Bhbi5jbGFzc0xpc3QuYWRkKHNwYW5DbGFzcyk7CiAgICAgICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCmEgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnByaW1hcnlDb2xvcjMwMEhleCl9OwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICBhOmhvdmVyIHsKICAgICAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICAgIH0KfQoKbWFpbiB7CiAgICBtYXJnaW46IDJyZW07CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKQGtleWZyYW1lcyBmYWRlSW5BbmltYXRpb24gewogICAgMCUgewogICAgICAgIG9wYWNpdHk6IDA7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBvcGFjaXR5OiAxOwogICAgfQp9CgpzdW1tYXJ5IHsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKYDsKY29uc3QgYXBwSHRtbCA9IGh0bWxgCjxtYWluPgoke0ZPUk1fSFRNTH0KJHtNRVNTQUdFU19IVE1MfQoke1NFQVJDSF9SRVNVTFRTX0hUTUx9CiR7Q09NTUVOVFNfSFRNTH0KJHtYTUxfSFRNTH0KPC9tYWluPgpgOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgYXBwQ3NzLmNzc1RleHQsCiAgICBGT1JNX0NTUy5jc3NUZXh0LAogICAgTUVTU0FHRVNfQ1NTLmNzc1RleHQsCiAgICBTRUFSQ0hfUkVTVUxUU19DU1MuY3NzVGV4dCwKICAgIENPTU1FTlRTX0NTUy5jc3NUZXh0LAogICAgWE1MX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmZ1bmN0aW9uIHBhcnNlU3RhdGljRGF0YSgpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0aWMtZGF0YS1zY3JpcHQnKTsKICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YS52ZXJzaW9uID09PSAnc3RyaW5nJyA/IGRhdGEudmVyc2lvbiA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGZsYWdzID0gdHlwZW9mIGRhdGEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YS5mbGFncyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGRlYnVnID0gdHlwZW9mIGRhdGEuZGVidWcgPT09ICdvYmplY3QnID8gZGF0YS5kZWJ1ZyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IHB1c2hJZCA9IHR5cGVvZiBkYXRhLnB1c2hJZCA9PT0gJ3N0cmluZycgPyBkYXRhLnB1c2hJZCA6IHVuZGVmaW5lZDsKICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbiwKICAgICAgICBmbGFncywKICAgICAgICBkZWJ1ZywKICAgICAgICBwdXNoSWQKICAgIH07Cn0KY29uc3Qgc3RhdGljRGF0YSA9IHBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCBsb2NhbEZldGNoZXIgPSAodXJsLCBoZWFkZXJzKT0+ZmV0Y2godXJsLCB7CiAgICAgICAgaGVhZGVycwogICAgfSkKOwpjb25zdCByZW1vdGVGZXRjaGVyID0gKHVybCwgaGVhZGVycyk9PmZldGNoKGAvZi8ke3VybC5yZXBsYWNlQWxsKC9bXmEtekEtWjAtOS5dKy9nLCAnXycpfWAsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgaGVhZGVycwogICAgICAgIH0pCiAgICB9KQo7CmNvbnN0IHBpU2VhcmNoRmV0Y2hlciA9IChpbnB1dCwgaGVhZGVycyk9PmZldGNoKGAvc2AsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGlucHV0LAogICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgfSkKICAgIH0pCjsKY29uc3Qgdm0gPSBuZXcgVmFsaWRhdG9yQXBwVk0oewogICAgbG9jYWxGZXRjaGVyLAogICAgcmVtb3RlRmV0Y2hlciwKICAgIHBpU2VhcmNoRmV0Y2hlcgp9KTsKY29uc3QgdXBkYXRlRm9ybSA9IGluaXRGb3JtKGRvY3VtZW50LCB2bSwgc3RhdGljRGF0YSk7CmNvbnN0IHVwZGF0ZU1lc3NhZ2VzID0gaW5pdE1lc3NhZ2VzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZVNlYXJjaFJlc3VsdHMgPSBpbml0U2VhcmNoUmVzdWx0cyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVDb21tZW50cyA9IGluaXRDb21tZW50cyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVYbWwgPSBpbml0WG1sKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZUZvcm0oKTsKICAgIHVwZGF0ZU1lc3NhZ2VzKCk7CiAgICB1cGRhdGVTZWFyY2hSZXN1bHRzKCk7CiAgICB1cGRhdGVDb21tZW50cygpOwogICAgdXBkYXRlWG1sKCk7Cn07CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';
