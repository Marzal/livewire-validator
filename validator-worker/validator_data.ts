export const VALIDATOR_APP_HASH = '257bc5b3fd97abc8fe2ce405aa6851b7cb869487';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wczEgPSB0aGlzLnByb3BlcnRpZXM7CiAgICAgICAgICAgIGNvbnN0IHByb3BLZXlzID0gWwogICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMxKSwKICAgICAgICAgICAgICAgIC4uLnR5cGVvZiBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzID09PSAiZnVuY3Rpb24iID8gT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyhwcm9wczEpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHMxW3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBfYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBvcHRpb25zLmF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlID09PSBmYWxzZSA/IHZvaWQgMCA6IHR5cGVvZiBhdHRyaWJ1dGUgPT09ICJzdHJpbmciID8gYXR0cmlidXRlIDogdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogdm9pZCAwOwogICAgfQogICAgc3RhdGljIF92YWx1ZUhhc0NoYW5nZWQodmFsdWUsIG9sZCwgaGFzQ2hhbmdlZCA9IG5vdEVxdWFsKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodmFsdWUsIG9sZCk7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyOwogICAgICAgIGNvbnN0IHRvQXR0cmlidXRlID0gY29udmVydGVyICYmIGNvbnZlcnRlci50b0F0dHJpYnV0ZSB8fCBkZWZhdWx0Q29udmVydGVyLnRvQXR0cmlidXRlOwogICAgICAgIHJldHVybiB0b0F0dHJpYnV0ZSh2YWx1ZSwgdHlwZSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICB9CiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkLCB2YWx1ZSkgewogICAgICAgIGlmIChvbGQgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9wcm9wZXJ0eVRvQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBhdHRyID0gY3Rvci5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgYXR0clZhbHVlID0gY3Rvci5fcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0clZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgIH0KICAgIH0KICAgIF9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IGN0b3IuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuZ2V0KG5hbWUpOwogICAgICAgIGlmIChwcm9wTmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhwcm9wTmFtZSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSwgb3B0aW9ucykgewogICAgICAgIGxldCBzaG91bGRSZXF1ZXN0VXBkYXRlID0gdHJ1ZTsKICAgICAgICBpZiAobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhuYW1lKTsKICAgICAgICAgICAgaWYgKGN0b3IuX3ZhbHVlSGFzQ2hhbmdlZCh0aGlzW25hbWVdLCBvbGRWYWx1ZSwgb3B0aW9ucy5oYXNDaGFuZ2VkKSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5oYXMobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5zZXQobmFtZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdHJ1ZSAmJiAhKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlICYmIHNob3VsZFJlcXVlc3RVcGRhdGUpIHsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUHJvbWlzZSA9IHRoaXMuX2VucXVldWVVcGRhdGUoKTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlKG5hbWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUpOwogICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUNvbXBsZXRlOwogICAgfQogICAgYXN5bmMgX2VucXVldWVVcGRhdGUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucGVyZm9ybVVwZGF0ZSgpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlOwogICAgfQogICAgZ2V0IF9oYXNSZXF1ZXN0ZWRVcGRhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCBoYXNVcGRhdGVkKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIDE7CiAgICB9CiAgICBwZXJmb3JtVXBkYXRlKCkgewogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICB0aGlzLl9hcHBseUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIH0KICAgICAgICBsZXQgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgY29uc3QgY2hhbmdlZFByb3BlcnRpZXMgPSB0aGlzLl9jaGFuZ2VkUHJvcGVydGllczsKICAgICAgICB0cnkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0aGlzLnNob3VsZFVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghKHRoaXMuX3VwZGF0ZVN0YXRlICYgMSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9IQVNfVVBEQVRFRDsKICAgICAgICAgICAgICAgIHRoaXMuZmlyc3RVcGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgIH0KICAgIH0KICAgIF9tYXJrVXBkYXRlZCgpIHsKICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgdXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBfZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIGdldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgfQogICAgc2hvdWxkVXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgdXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyAhPT0gdm9pZCAwICYmIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9wcm9wZXJ0eVRvQXR0cmlidXRlKGssIHRoaXNba10sIHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgfQogICAgdXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgIH0KICAgIGZpcnN0VXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgIH0KfQpfYSA9IGZpbmFsaXplZDsKVXBkYXRpbmdFbGVtZW50W19hXSA9IHRydWU7CmNvbnN0IEVsZW1lbnRQcm90byA9IEVsZW1lbnQucHJvdG90eXBlOwpFbGVtZW50UHJvdG8ubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudFByb3RvLndlYmtpdE1hdGNoZXNTZWxlY3RvcjsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+ewogICAgY29uc3QgY3NzVGV4dCA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzW2lkeCArIDFdCiAgICAsIHN0cmluZ3NbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dCwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7Cn07CmNsYXNzIExpdEVsZW1lbnQgZXh0ZW5kcyBVcGRhdGluZ0VsZW1lbnQgewogICAgc3RhdGljIGdldFN0eWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdHlsZXM7CiAgICB9CiAgICBzdGF0aWMgX2dldFVuaXF1ZVN0eWxlcygpIHsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfc3R5bGVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXNlclN0eWxlcyA9IHRoaXMuZ2V0U3R5bGVzKCk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXNlclN0eWxlcykpIHsKICAgICAgICAgICAgY29uc3QgYWRkU3R5bGVzID0gKHN0eWxlczIsIHNldDIpPT5zdHlsZXMyLnJlZHVjZVJpZ2h0KChzZXQzLCBzKT0+QXJyYXkuaXNBcnJheShzKSA/IGFkZFN0eWxlcyhzLCBzZXQzKSA6IChzZXQzLmFkZChzKSwgc2V0MykKICAgICAgICAgICAgICAgICwgc2V0MikKICAgICAgICAgICAgOwogICAgICAgICAgICBjb25zdCBzZXQgPSBhZGRTdHlsZXModXNlclN0eWxlcywgbmV3IFNldCgpKTsKICAgICAgICAgICAgY29uc3Qgc3R5bGVzID0gW107CiAgICAgICAgICAgIHNldC5mb3JFYWNoKCh2KT0+c3R5bGVzLnVuc2hpZnQodikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gc3R5bGVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHVzZXJTdHlsZXMgPT09IHZvaWQgMCA/IFtdIDogWwogICAgICAgICAgICAgICAgdXNlclN0eWxlcwogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdHlsZXMgPSB0aGlzLl9zdHlsZXMubWFwKChzKT0+ewogICAgICAgICAgICBpZiAocyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgJiYgIXN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgY29uc3QgY3NzVGV4dCA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHMuY3NzUnVsZXMpLnJlZHVjZSgoY3NzMiwgcnVsZSk9PmNzczIgKyBydWxlLmNzc1RleHQKICAgICAgICAgICAgICAgICwgIiIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuc2FmZUNTUyhjc3NUZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9KTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2dldFVuaXF1ZVN0eWxlcygpOwogICAgICAgIHRoaXMucmVuZGVyUm9vdCA9IHRoaXMuY3JlYXRlUmVuZGVyUm9vdCgpOwogICAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiB0aGlzLnJlbmRlclJvb3QgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCkgewogICAgICAgICAgICB0aGlzLmFkb3B0U3R5bGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY3JlYXRlUmVuZGVyUm9vdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hTaGFkb3codGhpcy5jb25zdHJ1Y3Rvci5zaGFkb3dSb290T3B0aW9ucyk7CiAgICB9CiAgICBhZG9wdFN0eWxlcygpIHsKICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXM7CiAgICAgICAgaWYgKHN0eWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAod2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDAgJiYgIXdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLlNjb3BpbmdTaGltLnByZXBhcmVBZG9wdGVkQ3NzVGV4dChzdHlsZXMubWFwKChzKT0+cy5jc3NUZXh0CiAgICAgICAgICAgICksIHRoaXMubG9jYWxOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYWRvcHRlZFN0eWxlU2hlZXRzID0gc3R5bGVzLm1hcCgocyk9PnMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ID8gcyA6IHMuc3R5bGVTaGVldAogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgc3VwZXIuY29ubmVjdGVkQ2FsbGJhY2soKTsKICAgICAgICBpZiAodGhpcy5oYXNVcGRhdGVkICYmIHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5zdHlsZUVsZW1lbnQodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgdXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZXN1bHQgPSB0aGlzLnJlbmRlcigpOwogICAgICAgIHN1cGVyLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgaWYgKHRlbXBsYXRlUmVzdWx0ICE9PSByZW5kZXJOb3RJbXBsZW1lbnRlZCkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnJlbmRlcih0ZW1wbGF0ZVJlc3VsdCwgdGhpcy5yZW5kZXJSb290LCB7CiAgICAgICAgICAgICAgICBzY29wZU5hbWU6IHRoaXMubG9jYWxOYW1lLAogICAgICAgICAgICAgICAgZXZlbnRDb250ZXh0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXMuZm9yRWFjaCgocyk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcy5jc3NUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmVuZGVyKCkgewogICAgICAgIHJldHVybiByZW5kZXJOb3RJbXBsZW1lbnRlZDsKICAgIH0KfQpMaXRFbGVtZW50WyJmaW5hbGl6ZWQiXSA9IHRydWU7CkxpdEVsZW1lbnQucmVuZGVyID0gcmVuZGVyOwpMaXRFbGVtZW50LnNoYWRvd1Jvb3RPcHRpb25zID0gewogICAgbW9kZTogIm9wZW4iCn07CmNsYXNzIFRoZW1lIHsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IyMDBIZXggPSAnIzY5YjdmZic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMzAwSGV4ID0gJyMwMDg4RkYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjkwMEhleCA9ICcjMDA1Y2NiJzsKICAgIHN0YXRpYyBiYWNrZ3JvdW5kQ29sb3JIZXggPSAnIzEyMTIxMic7CiAgICBzdGF0aWMgdGV4dENvbG9ySGV4ID0gJyNlYmViZWInOwogICAgc3RhdGljIHRleHRDb2xvclNlY29uZGFyeUhleCA9ICcjODg4ODg4JzsKICAgIHN0YXRpYyBzYW5zU2VyaWZGb250RmFtaWx5ID0gJy1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgYXZlbmlyIG5leHQsIGF2ZW5pciwgaGVsdmV0aWNhIG5ldWUsIGhlbHZldGljYSwgVWJ1bnR1LCByb2JvdG8sIG5vdG8sIHNlZ29lIHVpLCBhcmlhbCwgc2Fucy1zZXJpZic7CiAgICBzdGF0aWMgbW9ub3NwYWNlRm9udEZhbWlseSA9ICdNZW5sbywgIlNGIE1vbm8iLCAiQW5kYWxlIE1vbm8iLCAiUm9ib3RvIE1vbm8iLCBNb25hY28sIG1vbm9zcGFjZSc7Cn0KY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0UgPSAnaHR0cHM6Ly9wb2RjYXN0aW5kZXgub3JnL25hbWVzcGFjZS8xLjAnOwpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9BTFQgPSAnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcgPSAnaHR0cHM6Ly9wb2RjYXN0aW5kZXgub3JnL25hbWVzcGFjZS8xLjAvJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VTID0gWwogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0UsCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9BTFQsCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRV9LTk9XTl9NSVNTUEVMTElORwpdOwpjb25zdCBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTID0gbmV3IFNldCgpOwpmdW5jdGlvbiBfcG9kY2FzdEluZGV4KG5hbWUsIGtub3duID0gdHJ1ZSkgewogICAgaWYgKGtub3duKSBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTLmFkZChuYW1lKTsKICAgIHJldHVybiBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMubWFwKCh2KT0+KHsKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICk7Cn0KY29uc3QgTUVESUFfUlNTX05BTUVTUEFDRSA9ICdodHRwOi8vc2VhcmNoLnlhaG9vLmNvbS9tcnNzLyc7CmZ1bmN0aW9uIF9tZWRpYVJzcyhuYW1lKSB7CiAgICByZXR1cm4gewogICAgICAgIG5hbWUsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBNRURJQV9SU1NfTkFNRVNQQUNFCiAgICB9Owp9CmNsYXNzIFFuYW1lcyB7CiAgICBzdGF0aWMgUG9kY2FzdEluZGV4ID0gewogICAgICAgIE5BTUVTUEFDRVM6IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUywKICAgICAgICBLTk9XTl9NSVNTUEVMTEVEX05BTUVTUEFDRVM6IFsKICAgICAgICAgICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcKICAgICAgICBdLAogICAgICAgIGdldCBLTk9XTl9OQU1FUyAoKSB7CiAgICAgICAgICAgIHJldHVybiBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTOwogICAgICAgIH0sCiAgICAgICAgb2Y6IChuYW1lKT0+X3BvZGNhc3RJbmRleChuYW1lLCBmYWxzZSkKICAgICAgICAsCiAgICAgICAgYWx0ZXJuYXRlRW5jbG9zdXJlOiBfcG9kY2FzdEluZGV4KCdhbHRlcm5hdGVFbmNsb3N1cmUnKSwKICAgICAgICBjaGFwdGVyczogX3BvZGNhc3RJbmRleCgnY2hhcHRlcnMnKSwKICAgICAgICBlcGlzb2RlOiBfcG9kY2FzdEluZGV4KCdlcGlzb2RlJyksCiAgICAgICAgZnVuZGluZzogX3BvZGNhc3RJbmRleCgnZnVuZGluZycpLAogICAgICAgIGd1aWQ6IF9wb2RjYXN0SW5kZXgoJ2d1aWQnKSwKICAgICAgICBoaXZlQWNjb3VudDogX3BvZGNhc3RJbmRleCgnaGl2ZUFjY291bnQnKSwKICAgICAgICBpbWFnZXM6IF9wb2RjYXN0SW5kZXgoJ2ltYWdlcycpLAogICAgICAgIGludGVncml0eTogX3BvZGNhc3RJbmRleCgnaW50ZWdyaXR5JyksCiAgICAgICAgbGljZW5zZTogX3BvZGNhc3RJbmRleCgnbGljZW5zZScpLAogICAgICAgIGxvY2F0aW9uOiBfcG9kY2FzdEluZGV4KCdsb2NhdGlvbicpLAogICAgICAgIGxvY2tlZDogX3BvZGNhc3RJbmRleCgnbG9ja2VkJyksCiAgICAgICAgbWVkaXVtOiBfcG9kY2FzdEluZGV4KCdtZWRpdW0nKSwKICAgICAgICBwZXJzb246IF9wb2RjYXN0SW5kZXgoJ3BlcnNvbicpLAogICAgICAgIHBvZHBpbmc6IF9wb2RjYXN0SW5kZXgoJ3BvZHBpbmcnKSwKICAgICAgICBzZWFzb246IF9wb2RjYXN0SW5kZXgoJ3NlYXNvbicpLAogICAgICAgIHNvY2lhbDogX3BvZGNhc3RJbmRleCgnc29jaWFsJyksCiAgICAgICAgc29jaWFsSW50ZXJhY3Q6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbEludGVyYWN0JyksCiAgICAgICAgc29jaWFsU2lnblVwOiBfcG9kY2FzdEluZGV4KCdzb2NpYWxTaWduVXAnKSwKICAgICAgICBzb3VuZGJpdGU6IF9wb2RjYXN0SW5kZXgoJ3NvdW5kYml0ZScpLAogICAgICAgIHNvdXJjZTogX3BvZGNhc3RJbmRleCgnc291cmNlJyksCiAgICAgICAgdHJhaWxlcjogX3BvZGNhc3RJbmRleCgndHJhaWxlcicpLAogICAgICAgIHRyYW5zY3JpcHQ6IF9wb2RjYXN0SW5kZXgoJ3RyYW5zY3JpcHQnKSwKICAgICAgICB2YWx1ZTogX3BvZGNhc3RJbmRleCgndmFsdWUnKSwKICAgICAgICB2YWx1ZVJlY2lwaWVudDogX3BvZGNhc3RJbmRleCgndmFsdWVSZWNpcGllbnQnKQogICAgfTsKICAgIHN0YXRpYyBNZWRpYVJzcyA9IHsKICAgICAgICBOQU1FU1BBQ0U6IE1FRElBX1JTU19OQU1FU1BBQ0UsCiAgICAgICAgb2Y6IChuYW1lKT0+X21lZGlhUnNzKG5hbWUpCiAgICAgICAgLAogICAgICAgIGNvbnRlbnQ6IF9tZWRpYVJzcygnY29udGVudCcpCiAgICB9Owp9CmZ1bmN0aW9uIGNoZWNrTWF0Y2hlcyhuYW1lLCB2YWx1ZSwgcGF0dGVybikgewogICAgaWYgKCFwYXR0ZXJuLnRlc3QodmFsdWUpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwogICAgcmV0dXJuIHZhbHVlOwp9CmZ1bmN0aW9uIGNoZWNrRXF1YWwobmFtZSwgdmFsdWUsIGV4cGVjdGVkKSB7CiAgICBpZiAodmFsdWUgIT09IGV4cGVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfSwgZXhwZWN0ZWQgJHtleHBlY3RlZH1gKTsKfQpmdW5jdGlvbiBjaGVja1RydWUobmFtZSwgdmFsdWUsIHRlc3QpIHsKICAgIGlmICghdGVzdCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKfQpmdW5jdGlvbiBpc09iamVjdChvYmopIHsKICAgIHJldHVybiB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheShvYmopICYmIG9iaiAhPT0gbnVsbDsKfQpjb25zdCBoZXhSZWdleCA9IC9eWy0rXT8weFthLWZBLUYwLTldKyQvOwpjb25zdCBudW1SZWdleCA9IC9eKFtcLVwrXSk/KDAqKShcLlswLTldKyhbZUVdXC0/WzAtOV0rKT98WzAtOV0rKFwuWzAtOV0rKFtlRV1cLT9bMC05XSspPyk/KSQvOwpjb25zdCBjb25zaWRlciA9IHsKICAgIGhleDogdHJ1ZSwKICAgIGxlYWRpbmdaZXJvczogdHJ1ZSwKICAgIGRlY2ltYWxQb2ludDogIi4iCn07CmZ1bmN0aW9uIHRvTnVtYmVyKHN0ciwgb3B0aW9ucyA9IHsKfSkgewogICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oewogICAgfSwgY29uc2lkZXIsIG9wdGlvbnMpOwogICAgaWYgKCFzdHIgfHwgdHlwZW9mIHN0ciAhPT0gInN0cmluZyIpIHJldHVybiBzdHI7CiAgICBsZXQgdHJpbW1lZFN0ciA9IHN0ci50cmltKCk7CiAgICBpZiAob3B0aW9ucy5za2lwTGlrZSAhPT0gdm9pZCAwICYmIG9wdGlvbnMuc2tpcExpa2UudGVzdCh0cmltbWVkU3RyKSkgcmV0dXJuIHN0cjsKICAgIGVsc2UgaWYgKG9wdGlvbnMuaGV4ICYmIGhleFJlZ2V4LnRlc3QodHJpbW1lZFN0cikpIHsKICAgICAgICByZXR1cm4gTnVtYmVyLnBhcnNlSW50KHRyaW1tZWRTdHIsIDE2KTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSBudW1SZWdleC5leGVjKHRyaW1tZWRTdHIpOwogICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBtYXRjaFsxXTsKICAgICAgICAgICAgY29uc3QgbGVhZGluZ1plcm9zID0gbWF0Y2hbMl07CiAgICAgICAgICAgIGNvbnN0IG51bSA9IG1hdGNoWzNdOwogICAgICAgICAgICBtYXRjaFs0XSB8fCBtYXRjaFs2XTsKICAgICAgICAgICAgaWYgKGxlYWRpbmdaZXJvcy5sZW5ndGggPT09IDEgJiYgbnVtWzBdID09PSAiLiIpIHJldHVybiBOdW1iZXIoc3RyKTsKICAgICAgICAgICAgZWxzZSBpZiAoIW9wdGlvbnMubGVhZGluZ1plcm9zICYmIGxlYWRpbmdaZXJvcy5sZW5ndGggPiAwKSByZXR1cm4gc3RyOwogICAgICAgICAgICBlbHNlIHJldHVybiBOdW1iZXIodHJpbW1lZFN0cik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9CiAgICB9Cn0KdmFyIHN0cm51bSA9IHRvTnVtYmVyOwpmdW5jdGlvbiBjcmVhdGVDb21tb25qc01vZHVsZShmbiwgYmFzZWRpciwgbW9kdWxlKSB7CiAgICByZXR1cm4gbW9kdWxlID0gewogICAgICAgIHBhdGg6IGJhc2VkaXIsCiAgICAgICAgZXhwb3J0czogewogICAgICAgIH0sCiAgICAgICAgcmVxdWlyZTogZnVuY3Rpb24ocGF0aCwgYmFzZSkgewogICAgICAgICAgICByZXR1cm4gY29tbW9uanNSZXF1aXJlKHBhdGgsIGJhc2UgPT09IHZvaWQgMCB8fCBiYXNlID09PSBudWxsID8gbW9kdWxlLnBhdGggOiBiYXNlKTsKICAgICAgICB9CiAgICB9LCBmbihtb2R1bGUsIG1vZHVsZS5leHBvcnRzKSwgbW9kdWxlLmV4cG9ydHM7Cn0KZnVuY3Rpb24gY29tbW9uanNSZXF1aXJlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJEeW5hbWljIHJlcXVpcmVzIGFyZSBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBieSBAcm9sbHVwL3BsdWdpbi1jb21tb25qcyIpOwp9CnZhciB1dGlsID0gY3JlYXRlQ29tbW9uanNNb2R1bGUoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CiAgICBjb25zdCBuYW1lU3RhcnRDaGFyID0gIjpBLVphLXpfXFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgIGNvbnN0IG5hbWVDaGFyID0gbmFtZVN0YXJ0Q2hhciArICJcXC0uXFxkXFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICBjb25zdCBuYW1lUmVnZXhwID0gIlsiICsgbmFtZVN0YXJ0Q2hhciArICJdWyIgKyBuYW1lQ2hhciArICJdKiI7CiAgICBjb25zdCByZWdleE5hbWUgPSBuZXcgUmVnRXhwKCJeIiArIG5hbWVSZWdleHAgKyAiJCIpOwogICAgY29uc3QgZ2V0QWxsTWF0Y2hlcyA9IGZ1bmN0aW9uKHN0cmluZywgcmVnZXgpIHsKICAgICAgICBjb25zdCBtYXRjaGVzID0gW107CiAgICAgICAgbGV0IG1hdGNoID0gcmVnZXguZXhlYyhzdHJpbmcpOwogICAgICAgIHdoaWxlKG1hdGNoKXsKICAgICAgICAgICAgY29uc3QgYWxsbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBhbGxtYXRjaGVzLnN0YXJ0SW5kZXggPSByZWdleC5sYXN0SW5kZXggLSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbGVuOyBpbmRleCsrKXsKICAgICAgICAgICAgICAgIGFsbG1hdGNoZXMucHVzaChtYXRjaFtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoZXMucHVzaChhbGxtYXRjaGVzKTsKICAgICAgICAgICAgbWF0Y2ggPSByZWdleC5leGVjKHN0cmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgfTsKICAgIGNvbnN0IGlzTmFtZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIGNvbnN0IG1hdGNoID0gcmVnZXhOYW1lLmV4ZWMoc3RyaW5nKTsKICAgICAgICByZXR1cm4gIShtYXRjaCA9PT0gbnVsbCB8fCB0eXBlb2YgbWF0Y2ggPT09ICJ1bmRlZmluZWQiKTsKICAgIH07CiAgICBleHBvcnRzLmlzRXhpc3QgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ICE9PSAidW5kZWZpbmVkIjsKICAgIH07CiAgICBleHBvcnRzLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDA7CiAgICB9OwogICAgZXhwb3J0cy5tZXJnZSA9IGZ1bmN0aW9uKHRhcmdldCwgYSwgYXJyYXlNb2RlKSB7CiAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGEpOwogICAgICAgICAgICBjb25zdCBsZW4gPSBrZXlzLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGlmIChhcnJheU1vZGUgPT09ICJzdHJpY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gWwogICAgICAgICAgICAgICAgICAgICAgICBhW2tleXNbaV1dCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gYVtrZXlzW2ldXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmdldFZhbHVlID0gZnVuY3Rpb24odikgewogICAgICAgIGlmIChleHBvcnRzLmlzRXhpc3QodikpIHsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmJ1aWxkT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zMiwgcHJvcHMyKSB7CiAgICAgICAgbGV0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgfTsKICAgICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRPcHRpb25zMjsKICAgICAgICB9CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHByb3BzMi5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmIChvcHRpb25zW3Byb3BzMltpXV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gb3B0aW9uc1twcm9wczJbaV1dOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gZGVmYXVsdE9wdGlvbnMyW3Byb3BzMltpXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld09wdGlvbnM7CiAgICB9OwogICAgZXhwb3J0cy5pc1RhZ05hbWVJbkFycmF5TW9kZSA9IGZ1bmN0aW9uKHRhZ05hbWUsIGFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSkgewogICAgICAgIGlmIChhcnJheU1vZGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKGFycmF5TW9kZSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gYXJyYXlNb2RlLnRlc3QodGFnTmFtZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJyYXlNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiAhIWFycmF5TW9kZSh0YWdOYW1lLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycmF5TW9kZSA9PT0gInN0cmljdCI7CiAgICB9OwogICAgZXhwb3J0cy5pc05hbWUgPSBpc05hbWU7CiAgICBleHBvcnRzLmdldEFsbE1hdGNoZXMgPSBnZXRBbGxNYXRjaGVzOwogICAgZXhwb3J0cy5uYW1lUmVnZXhwID0gbmFtZVJlZ2V4cDsKfSk7CmNvbnN0IGNvbnZlcnRUb0pzb24gPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBwYXJlbnRUYWdOYW1lKSB7CiAgICBjb25zdCBqT2JqID0gewogICAgfTsKICAgIGlmICghb3B0aW9ucy5hbHdheXNDcmVhdGVUZXh0Tm9kZSAmJiAoIW5vZGUuY2hpbGQgfHwgdXRpbC5pc0VtcHR5T2JqZWN0KG5vZGUuY2hpbGQpKSAmJiAoIW5vZGUuYXR0cnNNYXAgfHwgdXRpbC5pc0VtcHR5T2JqZWN0KG5vZGUuYXR0cnNNYXApKSkgewogICAgICAgIHJldHVybiB1dGlsLmlzRXhpc3Qobm9kZS52YWwpID8gbm9kZS52YWwgOiAiIjsKICAgIH0KICAgIGlmICh1dGlsLmlzRXhpc3Qobm9kZS52YWwpICYmICEodHlwZW9mIG5vZGUudmFsID09PSAic3RyaW5nIiAmJiAobm9kZS52YWwgPT09ICIiIHx8IG5vZGUudmFsID09PSBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyKSkpIHsKICAgICAgICBjb25zdCBhc0FycmF5ID0gdXRpbC5pc1RhZ05hbWVJbkFycmF5TW9kZShub2RlLnRhZ25hbWUsIG9wdGlvbnMuYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICBqT2JqW29wdGlvbnMudGV4dE5vZGVOYW1lXSA9IGFzQXJyYXkgPyBbCiAgICAgICAgICAgIG5vZGUudmFsCiAgICAgICAgXSA6IG5vZGUudmFsOwogICAgfQogICAgdXRpbC5tZXJnZShqT2JqLCBub2RlLmF0dHJzTWFwLCBvcHRpb25zLmFycmF5TW9kZSk7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5jaGlsZCk7CiAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgY29uc3QgdGFnTmFtZSA9IGtleXNbaW5kZXhdOwogICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ05hbWVdICYmIG5vZGUuY2hpbGRbdGFnTmFtZV0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBqT2JqW3RhZ05hbWVdID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdGFnIGluIG5vZGUuY2hpbGRbdGFnTmFtZV0pewogICAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnTmFtZV0uaGFzT3duUHJvcGVydHkodGFnKSkgewogICAgICAgICAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0ucHVzaChjb252ZXJ0VG9Kc29uKG5vZGUuY2hpbGRbdGFnTmFtZV1bdGFnXSwgb3B0aW9ucywgdGFnTmFtZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY29udmVydFRvSnNvbihub2RlLmNoaWxkW3RhZ05hbWVdWzBdLCBvcHRpb25zLCB0YWdOYW1lKTsKICAgICAgICAgICAgY29uc3QgYXNBcnJheSA9IG9wdGlvbnMuYXJyYXlNb2RlID09PSB0cnVlICYmIHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiIHx8IHV0aWwuaXNUYWdOYW1lSW5BcnJheU1vZGUodGFnTmFtZSwgb3B0aW9ucy5hcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgICAgICBqT2JqW3RhZ05hbWVdID0gYXNBcnJheSA/IFsKICAgICAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgICBdIDogcmVzdWx0OwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBqT2JqOwp9Owp2YXIgY29udmVydFRvSnNvbl8xID0gY29udmVydFRvSnNvbjsKdmFyIG5vZGUyanNvbiA9IHsKICAgIGNvbnZlcnRUb0pzb246IGNvbnZlcnRUb0pzb25fMQp9Owp2YXIgeG1sTm9kZSA9IGZ1bmN0aW9uKHRhZ25hbWUsIHBhcmVudCwgdmFsKSB7CiAgICB0aGlzLnRhZ25hbWUgPSB0YWduYW1lOwogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICB0aGlzLmNoaWxkID0gewogICAgfTsKICAgIHRoaXMuYXR0cnNNYXAgPSB7CiAgICB9OwogICAgdGhpcy52YWwgPSB2YWw7CiAgICB0aGlzLmFkZENoaWxkID0gZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdKSkgewogICAgICAgICAgICB0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdLnB1c2goY2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0gPSBbCiAgICAgICAgICAgICAgICBjaGlsZAogICAgICAgICAgICBdOwogICAgICAgIH0KICAgIH07Cn07CmNvbnN0IGJ1aWxkT3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zOwoiPCgoIVxcW0NEQVRBXFxbKFtcXHNcXFNdKj8pKF1dPikpfCgoTkFNRTopPyhOQU1FKSkoW14+XSopPnwoKFxcLykoTkFNRSlcXHMqPikpKFtePF0qKSIucmVwbGFjZSgvTkFNRS9nLCB1dGlsLm5hbWVSZWdleHApOwppZiAoIU51bWJlci5wYXJzZUludCAmJiB3aW5kb3cucGFyc2VJbnQpIHsKICAgIE51bWJlci5wYXJzZUludCA9IHdpbmRvdy5wYXJzZUludDsKfQppZiAoIU51bWJlci5wYXJzZUZsb2F0ICYmIHdpbmRvdy5wYXJzZUZsb2F0KSB7CiAgICBOdW1iZXIucGFyc2VGbG9hdCA9IHdpbmRvdy5wYXJzZUZsb2F0Owp9CmNvbnN0IGRlZmF1bHRPcHRpb25zID0gewogICAgYXR0cmlidXRlTmFtZVByZWZpeDogIkBfIiwKICAgIGF0dHJOb2RlTmFtZTogZmFsc2UsCiAgICB0ZXh0Tm9kZU5hbWU6ICIjdGV4dCIsCiAgICBpZ25vcmVBdHRyaWJ1dGVzOiB0cnVlLAogICAgaWdub3JlTmFtZVNwYWNlOiBmYWxzZSwKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlLAogICAgcGFyc2VOb2RlVmFsdWU6IHRydWUsCiAgICBwYXJzZUF0dHJpYnV0ZVZhbHVlOiBmYWxzZSwKICAgIGFycmF5TW9kZTogZmFsc2UsCiAgICB0cmltVmFsdWVzOiB0cnVlLAogICAgY2RhdGFUYWdOYW1lOiBmYWxzZSwKICAgIGNkYXRhUG9zaXRpb25DaGFyOiAiXFxjIiwKICAgIG51bVBhcnNlT3B0aW9uczogewogICAgICAgIGhleDogdHJ1ZSwKICAgICAgICBsZWFkaW5nWmVyb3M6IHRydWUKICAgIH0sCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgdGFnTmFtZSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgYXR0ck5hbWUpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBzdG9wTm9kZXM6IFtdLAogICAgYWx3YXlzQ3JlYXRlVGV4dE5vZGU6IGZhbHNlCn07CnZhciBkZWZhdWx0T3B0aW9uc18xID0gZGVmYXVsdE9wdGlvbnM7CmNvbnN0IHByb3BzID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJpZ25vcmVOYW1lU3BhY2UiLAogICAgImFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMiLAogICAgInBhcnNlTm9kZVZhbHVlIiwKICAgICJwYXJzZUF0dHJpYnV0ZVZhbHVlIiwKICAgICJhcnJheU1vZGUiLAogICAgInRyaW1WYWx1ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInBhcnNlVHJ1ZU51bWJlck9ubHkiLAogICAgIm51bVBhcnNlT3B0aW9ucyIsCiAgICAic3RvcE5vZGVzIiwKICAgICJhbHdheXNDcmVhdGVUZXh0Tm9kZSIKXTsKdmFyIHByb3BzXzEgPSBwcm9wczsKZnVuY3Rpb24gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHZhbCwgb3B0aW9ucykgewogICAgaWYgKHZhbCkgewogICAgICAgIGlmIChvcHRpb25zLnRyaW1WYWx1ZXMpIHsKICAgICAgICAgICAgdmFsID0gdmFsLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFsID0gb3B0aW9ucy50YWdWYWx1ZVByb2Nlc3Nvcih2YWwsIHRhZ05hbWUpOwogICAgICAgIHZhbCA9IHBhcnNlVmFsdWUodmFsLCBvcHRpb25zLnBhcnNlTm9kZVZhbHVlLCBvcHRpb25zLm51bVBhcnNlT3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gdmFsOwp9CmZ1bmN0aW9uIHJlc29sdmVOYW1lU3BhY2UodGFnbmFtZSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgY29uc3QgdGFncyA9IHRhZ25hbWUuc3BsaXQoIjoiKTsKICAgICAgICBjb25zdCBwcmVmaXggPSB0YWduYW1lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgaWYgKHRhZ3NbMF0gPT09ICJ4bWxucyIpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBpZiAodGFncy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgdGFnbmFtZSA9IHByZWZpeCArIHRhZ3NbMV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhZ25hbWU7Cn0KZnVuY3Rpb24gcGFyc2VWYWx1ZSh2YWwsIHNob3VsZFBhcnNlLCBvcHRpb25zKSB7CiAgICBpZiAoc2hvdWxkUGFyc2UgJiYgdHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBuZXd2YWwgPSB2YWwudHJpbSgpOwogICAgICAgIGlmIChuZXd2YWwgPT09ICJ0cnVlIikgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZSBpZiAobmV3dmFsID09PSAiZmFsc2UiKSByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSByZXR1cm4gc3RybnVtKHZhbCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3QodmFsKSkgewogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgYXR0cnNSZWd4ID0gbmV3IFJlZ0V4cChgKFteXFxzPV0rKVxccyooPVxccyooWyciXSkoLio/KVxcMyk/YCwgImciKTsKZnVuY3Rpb24gYnVpbGRBdHRyaWJ1dGVzTWFwKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIHR5cGVvZiBhdHRyU3RyID09PSAic3RyaW5nIikgewogICAgICAgIGF0dHJTdHIgPSBhdHRyU3RyLnJlcGxhY2UoL1xyP1xuL2csICIgIik7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHV0aWwuZ2V0QWxsTWF0Y2hlcyhhdHRyU3RyLCBhdHRyc1JlZ3gpOwogICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGF0dHJzID0gewogICAgICAgIH07CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgYXR0ck5hbWUgPSByZXNvbHZlTmFtZVNwYWNlKG1hdGNoZXNbaV1bMV0sIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0ck5hbWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlc1tpXVs0XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudHJpbVZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzW2ldWzRdID0gbWF0Y2hlc1tpXVs0XS50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXNbaV1bNF0gPSBvcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcihtYXRjaGVzW2ldWzRdLCBhdHRyTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gcGFyc2VWYWx1ZShtYXRjaGVzW2ldWzRdLCBvcHRpb25zLnBhcnNlQXR0cmlidXRlVmFsdWUsIG9wdGlvbnMubnVtUGFyc2VPcHRpb25zKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5rZXlzKGF0dHJzKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgY29uc3QgYXR0ckNvbGxlY3Rpb24gPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGF0dHJDb2xsZWN0aW9uW29wdGlvbnMuYXR0ck5vZGVOYW1lXSA9IGF0dHJzOwogICAgICAgICAgICByZXR1cm4gYXR0ckNvbGxlY3Rpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KfQpjb25zdCBnZXRUcmF2ZXJzYWxPYmogPSBmdW5jdGlvbih4bWxEYXRhLCBvcHRpb25zKSB7CiAgICB4bWxEYXRhID0geG1sRGF0YS5yZXBsYWNlKC9cclxuPy9nLCAiXG4iKTsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMsIHByb3BzKTsKICAgIGNvbnN0IHhtbE9iaiA9IG5ldyB4bWxOb2RlKCIheG1sIik7CiAgICBsZXQgY3VycmVudE5vZGUgPSB4bWxPYmo7CiAgICBsZXQgdGV4dERhdGEgPSAiIjsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBjb25zdCBjaCA9IHhtbERhdGFbaV07CiAgICAgICAgaWYgKGNoID09PSAiPCIpIHsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI+IiwgaSwgIkNsb3NpbmcgVGFnIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyAyLCBjbG9zZUluZGV4KS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gdGFnTmFtZS5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGN1cnJlbnROb2RlLnRhZ25hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuY2hpbGQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuYXR0cnNNYXAgPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmF0dHJzTWFwID0gewogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB4bWxEYXRhLnN1YnN0cihjdXJyZW50Tm9kZS5zdGFydEluZGV4ICsgMSwgaSAtIGN1cnJlbnROb2RlLnN0YXJ0SW5kZXggLSAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUucGFyZW50OwogICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgIGkgPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI/PiIsIGksICJQaSBUYWcgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMykgPT09ICIhLS0iKSB7CiAgICAgICAgICAgICAgICBpID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiLS0+IiwgaSwgIkNvbW1lbnQgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMikgPT09ICIhRCIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI+IiwgaSwgIkRPQ1RZUEUgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhZ0V4cCA9IHhtbERhdGEuc3Vic3RyaW5nKGksIGNsb3NlSW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKHRhZ0V4cC5pbmRleE9mKCJbIikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGkgPSB4bWxEYXRhLmluZGV4T2YoIl0+IiwgaSkgKyAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMikgPT09ICIhWyIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICJdXT4iLCBpLCAiQ0RBVEEgaXMgbm90IGNsb3NlZC4iKSAtIDI7CiAgICAgICAgICAgICAgICBjb25zdCB0YWdFeHAgPSB4bWxEYXRhLnN1YnN0cmluZyhpICsgOSwgY2xvc2VJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodGV4dERhdGEpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZShjdXJyZW50Tm9kZS50YWduYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNkYXRhVGFnTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKG9wdGlvbnMuY2RhdGFUYWdOYW1lLCBjdXJyZW50Tm9kZSwgdGFnRXhwKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArIG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUudmFsID0gdGFnRXhwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gKGN1cnJlbnROb2RlLnZhbCB8fCAiIikgKyAodGFnRXhwIHx8ICIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4ICsgMjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNsb3NpbmdJbmRleEZvck9wZW5pbmdUYWcoeG1sRGF0YSwgaSArIDEpOwogICAgICAgICAgICAgICAgbGV0IHRhZ0V4cCA9IHJlc3VsdC5kYXRhOwogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IHJlc3VsdC5pbmRleDsKICAgICAgICAgICAgICAgIGNvbnN0IHNlcGFyYXRvckluZGV4ID0gdGFnRXhwLmluZGV4T2YoIiAiKTsKICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0gdGFnRXhwOwogICAgICAgICAgICAgICAgbGV0IHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2VwYXJhdG9ySW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ0V4cC5zdWJzdHIoMCwgc2VwYXJhdG9ySW5kZXgpLnJlcGxhY2UoL1xzXHMqJC8sICIiKTsKICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdFeHAuc3Vic3RyKHNlcGFyYXRvckluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gdGFnTmFtZS5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCA9IHRhZ05hbWUgIT09IHJlc3VsdC5kYXRhLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlICYmIHRleHREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnRhZ25hbWUgIT09ICIheG1sIikgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZShjdXJyZW50Tm9kZS50YWduYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRhZ0V4cC5sZW5ndGggPiAwICYmIHRhZ0V4cC5sYXN0SW5kZXhPZigiLyIpID09PSB0YWdFeHAubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lW3RhZ05hbWUubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHIoMCwgdGFnTmFtZS5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdFeHAuc3Vic3RyKDAsIHRhZ0V4cC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUodGFnTmFtZSwgY3VycmVudE5vZGUsICIiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gdGFnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5hdHRyc01hcCA9IGJ1aWxkQXR0cmlidXRlc01hcCh0YWdFeHAsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZSh0YWdOYW1lLCBjdXJyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RvcE5vZGVzLmxlbmd0aCAmJiBvcHRpb25zLnN0b3BOb2Rlcy5pbmNsdWRlcyhjaGlsZE5vZGUudGFnbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLnN0YXJ0SW5kZXggPSBjbG9zZUluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gdGFnRXhwICYmIHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuYXR0cnNNYXAgPSBidWlsZEF0dHJpYnV0ZXNNYXAodGFnRXhwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGNoaWxkTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHREYXRhICs9IHhtbERhdGFbaV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHhtbE9iajsKfTsKZnVuY3Rpb24gY2xvc2luZ0luZGV4Rm9yT3BlbmluZ1RhZyhkYXRhLCBpKSB7CiAgICBsZXQgYXR0ckJvdW5kYXJ5OwogICAgbGV0IHRhZ0V4cCA9ICIiOwogICAgZm9yKGxldCBpbmRleCA9IGk7IGluZGV4IDwgZGF0YS5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGxldCBjaCA9IGRhdGFbaW5kZXhdOwogICAgICAgIGlmIChhdHRyQm91bmRhcnkpIHsKICAgICAgICAgICAgaWYgKGNoID09PSBhdHRyQm91bmRhcnkpIGF0dHJCb3VuZGFyeSA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICciJyB8fCBjaCA9PT0gIiciKSB7CiAgICAgICAgICAgIGF0dHJCb3VuZGFyeSA9IGNoOwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICI+IikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZGF0YTogdGFnRXhwLAogICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiCSIpIHsKICAgICAgICAgICAgY2ggPSAiICI7CiAgICAgICAgfQogICAgICAgIHRhZ0V4cCArPSBjaDsKICAgIH0KfQpmdW5jdGlvbiBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsIHN0ciwgaSwgZXJyTXNnKSB7CiAgICBjb25zdCBjbG9zaW5nSW5kZXggPSB4bWxEYXRhLmluZGV4T2Yoc3RyLCBpKTsKICAgIGlmIChjbG9zaW5nSW5kZXggPT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyck1zZyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjbG9zaW5nSW5kZXggKyBzdHIubGVuZ3RoIC0gMTsKICAgIH0KfQp2YXIgZ2V0VHJhdmVyc2FsT2JqXzEgPSBnZXRUcmF2ZXJzYWxPYmo7CnZhciB4bWxzdHIyeG1sbm9kZSA9IHsKICAgIGRlZmF1bHRPcHRpb25zOiBkZWZhdWx0T3B0aW9uc18xLAogICAgcHJvcHM6IHByb3BzXzEsCiAgICBnZXRUcmF2ZXJzYWxPYmo6IGdldFRyYXZlcnNhbE9ial8xCn07CmNvbnN0IGRlZmF1bHRPcHRpb25zJDEgPSB7CiAgICBhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzOiBmYWxzZQp9Owpjb25zdCBwcm9wcyQxID0gWwogICAgImFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMiCl07CnZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uKHhtbERhdGEsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSB1dGlsLmJ1aWxkT3B0aW9ucyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucyQxLCBwcm9wcyQxKTsKICAgIGNvbnN0IHRhZ3MgPSBbXTsKICAgIGxldCB0YWdGb3VuZCA9IGZhbHNlOwogICAgbGV0IHJlYWNoZWRSb290ID0gZmFsc2U7CiAgICBpZiAoeG1sRGF0YVswXSA9PT0gIlx1RkVGRiIpIHsKICAgICAgICB4bWxEYXRhID0geG1sRGF0YS5zdWJzdHIoMSk7CiAgICB9CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgaSA9IHJlYWRQSSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgaWYgKGkuZXJyKSByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICBsZXQgdGFnU3RhcnRQb3MgPSBpOwogICAgICAgICAgICBpKys7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiISIpIHsKICAgICAgICAgICAgICAgIGkgPSByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsZXQgY2xvc2luZ1RhZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIGNsb3NpbmdUYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0gIiI7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGggJiYgeG1sRGF0YVtpXSAhPT0gIj4iICYmIHhtbERhdGFbaV0gIT09ICIgIiAmJiB4bWxEYXRhW2ldICE9PSAiCSIgJiYgeG1sRGF0YVtpXSAhPT0gIlxuIiAmJiB4bWxEYXRhW2ldICE9PSAiXHIiOyBpKyspewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgKz0geG1sRGF0YVtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lW3RhZ05hbWUubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cmluZygwLCB0YWdOYW1lLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVUYWdOYW1lKHRhZ05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG1zZzsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICJJbnZhbGlkIHNwYWNlIGFmdGVyICc8Jy4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICJUYWcgJyIgKyB0YWdOYW1lICsgIicgaXMgYW4gaW52YWxpZCBuYW1lLiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsIG1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlYWRBdHRyaWJ1dGVTdHIoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlcyBmb3IgJyIgKyB0YWdOYW1lICsgIicgaGF2ZSBvcGVuIHF1b3RlLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgYXR0clN0ciA9IHJlc3VsdC52YWx1ZTsKICAgICAgICAgICAgICAgIGkgPSByZXN1bHQuaW5kZXg7CiAgICAgICAgICAgICAgICBpZiAoYXR0clN0clthdHRyU3RyLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyU3RyU3RhcnQgPSBpIC0gYXR0clN0ci5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0ciA9IGF0dHJTdHIuc3Vic3RyaW5nKDAsIGF0dHJTdHIubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoaXNWYWxpZC5lcnIuY29kZSwgaXNWYWxpZC5lcnIubXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgYXR0clN0clN0YXJ0ICsgaXNWYWxpZC5lcnIubGluZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xvc2luZ1RhZykgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0LnRhZ0Nsb3NlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiQ2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicgZG9lc24ndCBoYXZlIHByb3BlciBjbG9zaW5nLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRyU3RyLnRyaW0oKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJDbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJyBjYW4ndCBoYXZlIGF0dHJpYnV0ZXMgb3IgaW52YWxpZCBzdGFydGluZy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnU3RhcnRQb3MpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGcgPSB0YWdzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gb3RnLnRhZ05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvcGVuUG9zID0gZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIG90Zy50YWdTdGFydFBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiRXhwZWN0ZWQgY2xvc2luZyB0YWcgJyIgKyBvdGcudGFnTmFtZSArICInIChvcGVuZWQgaW4gbGluZSAiICsgb3BlblBvcy5saW5lICsgIiwgY29sICIgKyBvcGVuUG9zLmNvbCArICIpIGluc3RlYWQgb2YgY2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ1N0YXJ0UG9zKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWNoZWRSb290ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdChpc1ZhbGlkLmVyci5jb2RlLCBpc1ZhbGlkLmVyci5tc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpIC0gYXR0clN0ci5sZW5ndGggKyBpc1ZhbGlkLmVyci5saW5lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjaGVkUm9vdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiTXVsdGlwbGUgcG9zc2libGUgcm9vdCBub2RlcyBmb3VuZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3MucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnU3RhcnRQb3MKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRhZ0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihpKys7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSByZWFkUEkoeG1sRGF0YSwgKytpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpLmVycikgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFmdGVyQW1wID0gdmFsaWRhdGVBbXBlcnNhbmQoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZnRlckFtcCA9PSAtMSkgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQ2hhciIsICJjaGFyICcmJyBpcyBub3QgZXhwZWN0ZWQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGFmdGVyQW1wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIiAiIHx8IHhtbERhdGFbaV0gPT09ICIJIiB8fCB4bWxEYXRhW2ldID09PSAiXG4iIHx8IHhtbERhdGFbaV0gPT09ICJcciIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZENoYXIiLCAiY2hhciAnIiArIHhtbERhdGFbaV0gKyAiJyBpcyBub3QgZXhwZWN0ZWQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoIXRhZ0ZvdW5kKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIlN0YXJ0IHRhZyBleHBlY3RlZC4iLCAxKTsKICAgIH0gZWxzZSBpZiAodGFncy5sZW5ndGggPT0gMSkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJVbmNsb3NlZCB0YWcgJyIgKyB0YWdzWzBdLnRhZ05hbWUgKyAiJy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnc1swXS50YWdTdGFydFBvcykpOwogICAgfSBlbHNlIGlmICh0YWdzLmxlbmd0aCA+IDApIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiSW52YWxpZCAnIiArIEpTT04uc3RyaW5naWZ5KHRhZ3MubWFwKCh0KT0+dC50YWdOYW1lCiAgICAgICAgKSwgbnVsbCwgNCkucmVwbGFjZSgvXHI/XG4vZywgIiIpICsgIicgZm91bmQuIiwgewogICAgICAgICAgICBsaW5lOiAxLAogICAgICAgICAgICBjb2w6IDEKICAgICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9OwpmdW5jdGlvbiByZWFkUEkoeG1sRGF0YSwgaSkgewogICAgY29uc3Qgc3RhcnQgPSBpOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09ICI/IiB8fCB4bWxEYXRhW2ldID09ICIgIikgewogICAgICAgICAgICBjb25zdCB0YWduYW1lID0geG1sRGF0YS5zdWJzdHIoc3RhcnQsIGkgLSBzdGFydCk7CiAgICAgICAgICAgIGlmIChpID4gNSAmJiB0YWduYW1lID09PSAieG1sIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIlhNTCBkZWNsYXJhdGlvbiBhbGxvd2VkIG9ubHkgYXQgdGhlIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT0gIj8iICYmIHhtbERhdGFbaSArIDFdID09ICI+IikgewogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwp9CmZ1bmN0aW9uIHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSkgewogICAgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDUgJiYgeG1sRGF0YVtpICsgMV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIi0iKSB7CiAgICAgICAgZm9yKGkgKz0gMzsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDFdID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICI+IikgewogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDggJiYgeG1sRGF0YVtpICsgMV0gPT09ICJEIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIk8iICYmIHhtbERhdGFbaSArIDNdID09PSAiQyIgJiYgeG1sRGF0YVtpICsgNF0gPT09ICJUIiAmJiB4bWxEYXRhW2kgKyA1XSA9PT0gIlkiICYmIHhtbERhdGFbaSArIDZdID09PSAiUCIgJiYgeG1sRGF0YVtpICsgN10gPT09ICJFIikgewogICAgICAgIGxldCBhbmdsZUJyYWNrZXRzQ291bnQgPSAxOwogICAgICAgIGZvcihpICs9IDg7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgYW5nbGVCcmFja2V0c0NvdW50Kys7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBhbmdsZUJyYWNrZXRzQ291bnQtLTsKICAgICAgICAgICAgICAgIGlmIChhbmdsZUJyYWNrZXRzQ291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgOSAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIlsiICYmIHhtbERhdGFbaSArIDJdID09PSAiQyIgJiYgeG1sRGF0YVtpICsgM10gPT09ICJEIiAmJiB4bWxEYXRhW2kgKyA0XSA9PT0gIkEiICYmIHhtbERhdGFbaSArIDVdID09PSAiVCIgJiYgeG1sRGF0YVtpICsgNl0gPT09ICJBIiAmJiB4bWxEYXRhW2kgKyA3XSA9PT0gIlsiKSB7CiAgICAgICAgZm9yKGkgKz0gODsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIl0iICYmIHhtbERhdGFbaSArIDFdID09PSAiXSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICI+IikgewogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gaTsKfQpjb25zdCBkb3VibGVRdW90ZSA9ICciJzsKY29uc3Qgc2luZ2xlUXVvdGUgPSAiJyI7CmZ1bmN0aW9uIHJlYWRBdHRyaWJ1dGVTdHIoeG1sRGF0YSwgaSkgewogICAgbGV0IGF0dHJTdHIgPSAiIjsKICAgIGxldCBzdGFydENoYXIgPSAiIjsKICAgIGxldCB0YWdDbG9zZWQgPSBmYWxzZTsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gZG91YmxlUXVvdGUgfHwgeG1sRGF0YVtpXSA9PT0gc2luZ2xlUXVvdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXJ0Q2hhciA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHN0YXJ0Q2hhciA9IHhtbERhdGFbaV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRDaGFyICE9PSB4bWxEYXRhW2ldKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgc3RhcnRDaGFyID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI+IikgewogICAgICAgICAgICBpZiAoc3RhcnRDaGFyID09PSAiIikgewogICAgICAgICAgICAgICAgdGFnQ2xvc2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF0dHJTdHIgKz0geG1sRGF0YVtpXTsKICAgIH0KICAgIGlmIChzdGFydENoYXIgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogYXR0clN0ciwKICAgICAgICBpbmRleDogaSwKICAgICAgICB0YWdDbG9zZWQKICAgIH07Cn0KY29uc3QgdmFsaWRBdHRyU3RyUmVneHAgPSBuZXcgUmVnRXhwKGAoXFxzKikoW15cXHM9XSspKFxccyo9KT8oXFxzKihbJyJdKSgoW1xcc1xcU10pKj8pXFw1KT9gLCAiZyIpOwpmdW5jdGlvbiB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKSB7CiAgICBjb25zdCBtYXRjaGVzID0gdXRpbC5nZXRBbGxNYXRjaGVzKGF0dHJTdHIsIHZhbGlkQXR0clN0clJlZ3hwKTsKICAgIGNvbnN0IGF0dHJOYW1lcyA9IHsKICAgIH07CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgbWF0Y2hlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKG1hdGNoZXNbaV1bMV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGhhcyBubyBzcGFjZSBpbiBzdGFydGluZy4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaGVzW2ldWzNdID09PSB2b2lkIDAgJiYgIW9wdGlvbnMuYWxsb3dCb29sZWFuQXR0cmlidXRlcykgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgImJvb2xlYW4gYXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGlzIG5vdCBhbGxvd2VkLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0ck5hbWUgPSBtYXRjaGVzW2ldWzJdOwogICAgICAgIGlmICghdmFsaWRhdGVBdHRyTmFtZShhdHRyTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBhdHRyTmFtZSArICInIGlzIGFuIGludmFsaWQgbmFtZS4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgICAgIGlmICghYXR0ck5hbWVzLmhhc093blByb3BlcnR5KGF0dHJOYW1lKSkgewogICAgICAgICAgICBhdHRyTmFtZXNbYXR0ck5hbWVdID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgcmVwZWF0ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGxldCByZSA9IC9cZC87CiAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIngiKSB7CiAgICAgICAgaSsrOwogICAgICAgIHJlID0gL1tcZGEtZkEtRl0vOwogICAgfQogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiBpOwogICAgICAgIGlmICgheG1sRGF0YVtpXS5tYXRjaChyZSkpIGJyZWFrOwogICAgfQogICAgcmV0dXJuIC0xOwp9CmZ1bmN0aW9uIHZhbGlkYXRlQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGkrKzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiAtMTsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiIyIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpOwogICAgfQogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrLCBjb3VudCsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXS5tYXRjaCgvXHcvKSAmJiBjb3VudCA8IDIwKSBjb250aW51ZTsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjsiKSBicmVhazsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICByZXR1cm4gaTsKfQpmdW5jdGlvbiBnZXRFcnJvck9iamVjdChjb2RlLCBtZXNzYWdlLCBsaW5lTnVtYmVyKSB7CiAgICByZXR1cm4gewogICAgICAgIGVycjogewogICAgICAgICAgICBjb2RlLAogICAgICAgICAgICBtc2c6IG1lc3NhZ2UsCiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIubGluZSB8fCBsaW5lTnVtYmVyLAogICAgICAgICAgICBjb2w6IGxpbmVOdW1iZXIuY29sCiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiB2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUoYXR0ck5hbWUpOwp9CmZ1bmN0aW9uIHZhbGlkYXRlVGFnTmFtZSh0YWduYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUodGFnbmFtZSk7Cn0KZnVuY3Rpb24gZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGluZGV4KSB7CiAgICBjb25zdCBsaW5lcyA9IHhtbERhdGEuc3Vic3RyaW5nKDAsIGluZGV4KS5zcGxpdCgvXHI/XG4vKTsKICAgIHJldHVybiB7CiAgICAgICAgbGluZTogbGluZXMubGVuZ3RoLAogICAgICAgIGNvbDogbGluZXNbbGluZXMubGVuZ3RoIC0gMV0ubGVuZ3RoICsgMQogICAgfTsKfQpmdW5jdGlvbiBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaCkgewogICAgcmV0dXJuIG1hdGNoLnN0YXJ0SW5kZXggKyBtYXRjaFsxXS5sZW5ndGg7Cn0KdmFyIHZhbGlkYXRvciA9IHsKICAgIHZhbGlkYXRlCn07CmNvbnN0IF9fY2hhciA9IGZ1bmN0aW9uKGEpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGEpOwp9Owpjb25zdCBjaGFycyA9IHsKICAgIG5pbENoYXI6IF9fY2hhcigxNzYpLAogICAgbWlzc2luZ0NoYXI6IF9fY2hhcigyMDEpLAogICAgbmlsUHJlbWl0aXZlOiBfX2NoYXIoMTc1KSwKICAgIG1pc3NpbmdQcmVtaXRpdmU6IF9fY2hhcigyMDApLAogICAgZW1wdHlDaGFyOiBfX2NoYXIoMTc4KSwKICAgIGVtcHR5VmFsdWU6IF9fY2hhcigxNzcpLAogICAgYm91bmRyeUNoYXI6IF9fY2hhcigxNzkpLAogICAgb2JqU3RhcnQ6IF9fY2hhcigxOTgpLAogICAgYXJyU3RhcnQ6IF9fY2hhcigyMDQpLAogICAgYXJyYXlFbmQ6IF9fY2hhcigxODUpCn07CmNvbnN0IGNoYXJzQXJyID0gWwogICAgY2hhcnMubmlsQ2hhciwKICAgIGNoYXJzLm5pbFByZW1pdGl2ZSwKICAgIGNoYXJzLm1pc3NpbmdDaGFyLAogICAgY2hhcnMubWlzc2luZ1ByZW1pdGl2ZSwKICAgIGNoYXJzLmJvdW5kcnlDaGFyLAogICAgY2hhcnMuZW1wdHlDaGFyLAogICAgY2hhcnMuZW1wdHlWYWx1ZSwKICAgIGNoYXJzLmFycmF5RW5kLAogICAgY2hhcnMub2JqU3RhcnQsCiAgICBjaGFycy5hcnJTdGFydApdOwpjb25zdCBfZSA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIGVfc2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgIGlmIChub2RlICYmIG5vZGVbMF0gJiYgbm9kZVswXS52YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWUobm9kZVswXS52YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGhhc1ZhbGlkRGF0YSA9IGhhc0RhdGEobm9kZSk7CiAgICAgICAgaWYgKGhhc1ZhbGlkRGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICBsZXQgc3RyID0gIiI7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVfc2NoZW1hKSkgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFyclN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3QgaXRlbVNjaGVtYSA9IGVfc2NoZW1hWzBdOwogICAgICAgICAgICAgICAgY29uc3QgYXJyX2xlbiA9IG5vZGUubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtU2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gZ2V0VmFsdWUobm9kZVthcnJfaV0udmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGFycl9pID0gMDsgYXJyX2kgPCBhcnJfbGVuOyBhcnJfaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IF9lKG5vZGVbYXJyX2ldLCBpdGVtU2NoZW1hLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFycmF5RW5kOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLm9ialN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGVfc2NoZW1hKTsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgaW4ga2V5cyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyAmJiBub2RlLmF0dHJzTWFwICYmIG5vZGUuYXR0cnNNYXBba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5hdHRyc01hcFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gb3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IF9lKG5vZGUudmFsLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5jaGlsZFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gaGFzVmFsaWREYXRhOwogICAgICAgIH0KICAgIH0KfTsKY29uc3QgZ2V0VmFsdWUgPSBmdW5jdGlvbihhKSB7CiAgICBzd2l0Y2goYSl7CiAgICAgICAgY2FzZSB2b2lkIDA6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nUHJlbWl0aXZlOwogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm5pbFByZW1pdGl2ZTsKICAgICAgICBjYXNlICIiOgogICAgICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlWYWx1ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gYTsKICAgIH0KfTsKY29uc3QgcHJvY2Vzc1ZhbHVlID0gZnVuY3Rpb24oc3RyLCByKSB7CiAgICBpZiAoIWlzQXBwQ2hhcihyWzBdKSAmJiAhaXNBcHBDaGFyKHN0cltzdHIubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgc3RyICs9IGNoYXJzLmJvdW5kcnlDaGFyOwogICAgfQogICAgcmV0dXJuIHN0ciArIHI7Cn07CmNvbnN0IGlzQXBwQ2hhciA9IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gY2hhcnNBcnIuaW5kZXhPZihjaCkgIT09IC0xOwp9OwpmdW5jdGlvbiBoYXNEYXRhKGpPYmopIHsKICAgIGlmIChqT2JqID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gY2hhcnMubWlzc2luZ0NoYXI7CiAgICB9IGVsc2UgaWYgKGpPYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2hhcnMubmlsQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iai5jaGlsZCAmJiBPYmplY3Qua2V5cyhqT2JqLmNoaWxkKS5sZW5ndGggPT09IDAgJiYgKCFqT2JqLmF0dHJzTWFwIHx8IE9iamVjdC5rZXlzKGpPYmouYXR0cnNNYXApLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQpjb25zdCBidWlsZE9wdGlvbnMkMSA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0Mm5pbW4gPSBmdW5jdGlvbihub2RlLCBlX3NjaGVtYSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQxKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICByZXR1cm4gX2Uobm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpOwp9Owp2YXIgY29udmVydDJuaW1uXzEgPSBjb252ZXJ0Mm5pbW47CnZhciBuaW1uZGF0YSA9IHsKICAgIGNvbnZlcnQybmltbjogY29udmVydDJuaW1uXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDIgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgY29udmVydFRvSnNvblN0cmluZyA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMihvcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5kZWZhdWx0T3B0aW9ucywgeG1sc3RyMnhtbG5vZGUucHJvcHMpOwogICAgb3B0aW9ucy5pbmRlbnRCeSA9IG9wdGlvbnMuaW5kZW50QnkgfHwgIiI7CiAgICByZXR1cm4gX2NUb0pzb25TdHIobm9kZSwgb3B0aW9ucyk7Cn07CmNvbnN0IF9jVG9Kc29uU3RyID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucywgbGV2ZWwpIHsKICAgIGxldCBqT2JqID0gInsiOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUuY2hpbGQpOwogICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwga2V5cy5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGNvbnN0IHRhZ25hbWUgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWduYW1lXSAmJiBub2RlLmNoaWxkW3RhZ25hbWVdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgak9iaiArPSAnIicgKyB0YWduYW1lICsgJyIgOiBbICc7CiAgICAgICAgICAgIGZvcihsZXQgdGFnIGluIG5vZGUuY2hpbGRbdGFnbmFtZV0pewogICAgICAgICAgICAgICAgak9iaiArPSBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdW3RhZ10sIG9wdGlvbnMpICsgIiAsICI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMSkgKyAiIF0gIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6ICcgKyBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdWzBdLCBvcHRpb25zKSArICIgLCI7CiAgICAgICAgfQogICAgfQogICAgdXRpbC5tZXJnZShqT2JqLCBub2RlLmF0dHJzTWFwKTsKICAgIGlmICh1dGlsLmlzRW1wdHlPYmplY3Qoak9iaikpIHsKICAgICAgICByZXR1cm4gdXRpbC5pc0V4aXN0KG5vZGUudmFsKSA/IG5vZGUudmFsIDogIiI7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3Qobm9kZS52YWwpKSB7CiAgICAgICAgICAgIGlmICghKHR5cGVvZiBub2RlLnZhbCA9PT0gInN0cmluZyIgJiYgKG5vZGUudmFsID09PSAiIiB8fCBub2RlLnZhbCA9PT0gb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcikpKSB7CiAgICAgICAgICAgICAgICBqT2JqICs9ICciJyArIG9wdGlvbnMudGV4dE5vZGVOYW1lICsgJyIgOiAnICsgc3RyaW5ndmFsKG5vZGUudmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmIChqT2JqW2pPYmoubGVuZ3RoIC0gMV0gPT09ICIsIikgewogICAgICAgIGpPYmogPSBqT2JqLnN1YnN0cigwLCBqT2JqLmxlbmd0aCAtIDIpOwogICAgfQogICAgcmV0dXJuIGpPYmogKyAifSI7Cn07CmZ1bmN0aW9uIHN0cmluZ3ZhbCh2KSB7CiAgICBpZiAodiA9PT0gdHJ1ZSB8fCB2ID09PSBmYWxzZSB8fCAhaXNOYU4odikpIHsKICAgICAgICByZXR1cm4gdjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICciJyArIHYgKyAnIic7CiAgICB9Cn0KdmFyIGNvbnZlcnRUb0pzb25TdHJpbmdfMSA9IGNvbnZlcnRUb0pzb25TdHJpbmc7CnZhciBub2RlMmpzb25fc3RyID0gewogICAgY29udmVydFRvSnNvblN0cmluZzogY29udmVydFRvSnNvblN0cmluZ18xCn07CmNvbnN0IGJ1aWxkT3B0aW9ucyQzID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGRlZmF1bHRPcHRpb25zJDIgPSB7CiAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAiQF8iLAogICAgYXR0ck5vZGVOYW1lOiBmYWxzZSwKICAgIHRleHROb2RlTmFtZTogIiN0ZXh0IiwKICAgIGlnbm9yZUF0dHJpYnV0ZXM6IHRydWUsCiAgICBjZGF0YVRhZ05hbWU6IGZhbHNlLAogICAgY2RhdGFQb3NpdGlvbkNoYXI6ICJcXGMiLAogICAgZm9ybWF0OiBmYWxzZSwKICAgIGluZGVudEJ5OiAiICAiLAogICAgc3VwcmVzc0VtcHR5Tm9kZTogZmFsc2UsCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9wcyQyID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJjZGF0YVRhZ05hbWUiLAogICAgImNkYXRhUG9zaXRpb25DaGFyIiwKICAgICJmb3JtYXQiLAogICAgImluZGVudEJ5IiwKICAgICJzdXByZXNzRW1wdHlOb2RlIiwKICAgICJ0YWdWYWx1ZVByb2Nlc3NvciIsCiAgICAiYXR0clZhbHVlUHJvY2Vzc29yIiwKICAgICJyb290Tm9kZU5hbWUiCl07CmZ1bmN0aW9uIFBhcnNlcihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucyQyLCBwcm9wcyQyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyB8fCB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hdHRyUHJlZml4TGVuID0gdGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgubGVuZ3RoOwogICAgICAgIHRoaXMuaXNBdHRyaWJ1dGUgPSBpc0F0dHJpYnV0ZTsKICAgIH0KICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gaXNDREFUQTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQogICAgdGhpcy5yZXBsYWNlQ0RBVEFzdHIgPSByZXBsYWNlQ0RBVEFzdHI7CiAgICB0aGlzLnJlcGxhY2VDREFUQWFyciA9IHJlcGxhY2VDREFUQWFycjsKICAgIHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUgPSBwcm9jZXNzVGV4dE9yT2JqTm9kZTsKICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0KSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBpbmRlbnRhdGU7CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj5cbiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIlxuIjsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH07CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj4iOwogICAgICAgIHRoaXMubmV3TGluZSA9ICIiOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5zdXByZXNzRW1wdHlOb2RlKSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRFbXB0eVRleHROb2RlOwogICAgICAgIHRoaXMuYnVpbGRPYmpOb2RlID0gYnVpbGRFbXB0eU9iak5vZGU7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYnVpbGRUZXh0Tm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZE9iamVjdE5vZGU7CiAgICB9CiAgICB0aGlzLmJ1aWxkVGV4dFZhbE5vZGUgPSBidWlsZFRleHRWYWxOb2RlOwogICAgdGhpcy5idWlsZE9iamVjdE5vZGUgPSBidWlsZE9iamVjdE5vZGU7Cn0KUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGpPYmopIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGpPYmopICYmIHRoaXMub3B0aW9ucy5yb290Tm9kZU5hbWUgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZS5sZW5ndGggPiAxKSB7CiAgICAgICAgak9iaiA9IHsKICAgICAgICAgICAgW3RoaXMub3B0aW9ucy5yb290Tm9kZU5hbWVdOiBqT2JqCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiB0aGlzLmoyeChqT2JqLCAwKS52YWw7Cn07ClBhcnNlci5wcm90b3R5cGUuajJ4ID0gZnVuY3Rpb24oak9iaiwgbGV2ZWwpIHsKICAgIGxldCBhdHRyU3RyID0gIiI7CiAgICBsZXQgdmFsID0gIiI7CiAgICBmb3IobGV0IGtleSBpbiBqT2JqKXsKICAgICAgICBpZiAodHlwZW9mIGpPYmpba2V5XSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICBlbHNlIGlmIChqT2JqW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICB9IGVsc2UgaWYgKGpPYmpba2V5XSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBqT2JqW2tleV0gIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLmlzQXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIGF0dHIgKyAnPSInICsgdGhpcy5vcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcigiIiArIGpPYmpba2V5XSkgKyAnIic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQXN0cigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHRoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lXSkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmJ1aWxkVGV4dE5vZGUoak9ialtrZXldLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoak9ialtrZXldKSkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCk7CiAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycihqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFhcnIoIiIsIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJMZW4gPSBqT2JqW2tleV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IGFyckxlbjsgaisrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gak9ialtrZXldW2pdOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpdGVtID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUoaXRlbSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShpdGVtLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUgJiYga2V5ID09PSB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjb25zdCBLcyA9IE9iamVjdC5rZXlzKGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICBjb25zdCBMID0gS3MubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IEw7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0ciArPSAiICIgKyBLc1tqXSArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldW0tzW2pdXSkgKyAnIic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShqT2JqW2tleV0sIGtleSwgbGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBhdHRyU3RyLAogICAgICAgIHZhbAogICAgfTsKfTsKZnVuY3Rpb24gcHJvY2Vzc1RleHRPck9iak5vZGUob2JqZWN0LCBrZXksIGxldmVsKSB7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmoyeChvYmplY3QsIGxldmVsICsgMSk7CiAgICBpZiAob2JqZWN0W3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdICE9PSB2b2lkIDAgJiYgT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHROb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRPYmpOb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFzdHIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIsICI8IVtDREFUQVsiICsgY2RhdGEgKyAiXV0iICsgdGhpcy50YWdFbmRDaGFyKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFhcnIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YS5qb2luKCJdXT48IVtDREFUQVsiKSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIGZvcihsZXQgdiBpbiBjZGF0YSl7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YVt2XSArICJdXT4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0ciArIHRoaXMubmV3TGluZTsKICAgIH0KfQpmdW5jdGlvbiBidWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAoYXR0clN0ciAmJiB2YWwuaW5kZXhPZigiPCIpID09PSAtMSkgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdmFsICsgIjwvIiArIGtleSArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyB0aGlzLnRhZ0VuZENoYXIgKyB2YWwgKyB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlPYmpOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKHZhbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlUZXh0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmICh2YWwgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBpbmRlbnRhdGUobGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaW5kZW50QnkucmVwZWF0KGxldmVsKTsKfQpmdW5jdGlvbiBpc0F0dHJpYnV0ZShuYW1lKSB7CiAgICBpZiAobmFtZS5zdGFydHNXaXRoKHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4KSkgewogICAgICAgIHJldHVybiBuYW1lLnN1YnN0cih0aGlzLmF0dHJQcmVmaXhMZW4pOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KZnVuY3Rpb24gaXNDREFUQShuYW1lKSB7CiAgICByZXR1cm4gbmFtZSA9PT0gdGhpcy5vcHRpb25zLmNkYXRhVGFnTmFtZTsKfQp2YXIganNvbjJ4bWwgPSBQYXJzZXI7CnZhciBwYXJzZXIgPSBjcmVhdGVDb21tb25qc01vZHVsZShmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IHgyeG1sbm9kZSA9IHhtbHN0cjJ4bWxub2RlOwogICAgY29uc3QgYnVpbGRPcHRpb25zMiA9IHV0aWwuYnVpbGRPcHRpb25zOwogICAgZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uKHhtbERhdGEsIGdpdmVuT3B0aW9ucyA9IHsKICAgIH0sIHZhbGlkYXRpb25PcHRpb24pIHsKICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbikgewogICAgICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbiA9PT0gdHJ1ZSkgdmFsaWRhdGlvbk9wdGlvbiA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKHhtbERhdGEsIHZhbGlkYXRpb25PcHRpb24pOwogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihyZXN1bHQuZXJyLm1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGdpdmVuT3B0aW9ucy5wYXJzZVRydWVOdW1iZXJPbmx5ICYmIGdpdmVuT3B0aW9ucy5wYXJzZU5vZGVWYWx1ZSAhPT0gZmFsc2UgJiYgIWdpdmVuT3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpIHsKICAgICAgICAgICAgZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgIGxlYWRpbmdaZXJvczogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgbGV0IG9wdGlvbnMgPSBidWlsZE9wdGlvbnMyKGdpdmVuT3B0aW9ucywgeDJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4MnhtbG5vZGUucHJvcHMpOwogICAgICAgIGNvbnN0IHRyYXZlcnNhYmxlT2JqID0geG1sc3RyMnhtbG5vZGUuZ2V0VHJhdmVyc2FsT2JqKHhtbERhdGEsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBub2RlMmpzb24uY29udmVydFRvSnNvbih0cmF2ZXJzYWJsZU9iaiwgb3B0aW9ucyk7CiAgICB9OwogICAgZXhwb3J0cy5jb252ZXJ0VG9uaW1uID0gbmltbmRhdGEuY29udmVydDJuaW1uOwogICAgZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmo7CiAgICBleHBvcnRzLmNvbnZlcnRUb0pzb24gPSBub2RlMmpzb24uY29udmVydFRvSnNvbjsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvblN0cmluZyA9IG5vZGUyanNvbl9zdHIuY29udmVydFRvSnNvblN0cmluZzsKICAgIGV4cG9ydHMudmFsaWRhdGUgPSB2YWxpZGF0b3IudmFsaWRhdGU7CiAgICBleHBvcnRzLmoyeFBhcnNlciA9IGpzb24yeG1sOwogICAgZXhwb3J0cy5wYXJzZVRvTmltbiA9IGZ1bmN0aW9uKHhtbERhdGEsIHNjaGVtYSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBleHBvcnRzLmNvbnZlcnRUb25pbW4oZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyksIHNjaGVtYSwgb3B0aW9ucyk7CiAgICB9Owp9KTsKcGFyc2VyLmNvbnZlcnRUb0pzb247CnBhcnNlci5jb252ZXJ0VG9Kc29uU3RyaW5nOwpwYXJzZXIuY29udmVydFRvbmltbjsKdmFyIGdldFRyYXZlcnNhbE9iaiQxID0gcGFyc2VyLmdldFRyYXZlcnNhbE9iajsKcGFyc2VyLmoyeFBhcnNlcjsKcGFyc2VyLnBhcnNlOwpwYXJzZXIucGFyc2VUb05pbW47CnBhcnNlci52YWxpZGF0ZTsKZnVuY3Rpb24gcGFyc2VYbWwoeG1sKSB7CiAgICBjb25zdCBydCA9IGdldFRyYXZlcnNhbE9iaiQxKHhtbCwgewogICAgICAgIGlnbm9yZUF0dHJpYnV0ZXM6IGZhbHNlLAogICAgICAgIHBhcnNlQXR0cmlidXRlVmFsdWU6IGZhbHNlLAogICAgICAgIHBhcnNlTm9kZVZhbHVlOiBmYWxzZQogICAgfSk7CiAgICBjb25zdCBuYW1lc3BhY2VzID0gbmV3IFhtbE5hbWVzcGFjZXMoKTsKICAgIGFwcGx5UW5hbWVzKHJ0LCBuYW1lc3BhY2VzKTsKICAgIGNoZWNrRXF1YWwoJ25hbWVzcGFjZXMuc3RhY2tTaXplJywgbmFtZXNwYWNlcy5zdGFja1NpemUsIDApOwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVNYXAoYXR0cnNNYXApIHsKICAgIGxldCBtYXA7CiAgICBpZiAoYXR0cnNNYXApIHsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXR0cnNNYXApKXsKICAgICAgICAgICAgaWYgKCFuYW1lLnN0YXJ0c1dpdGgoJ0BfJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGF0dHJzTWFwIG5hbWU6ICR7bmFtZX0sICR7YXR0cnNNYXB9YCk7CiAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgIG1hcC5zZXQobmFtZS5zdWJzdHJpbmcoMiksIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbWFwIHx8IEVNUFRZX1NUUklOR19NQVA7Cn0KZnVuY3Rpb24gZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4ucW5hbWVzKSB7CiAgICBsZXQgcnQ7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgcW5hbWUgb2YgcW5hbWVzKXsKICAgICAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgICAgaWYgKHFuYW1lLm5hbWUgPT09ICcqJyA/IHFuYW1lLm5hbWVzcGFjZVVyaSA9PT0gZXh0Q2hpbGQucW5hbWUubmFtZXNwYWNlVXJpIDogcW5hbWVFcShxbmFtZSwgZXh0Q2hpbGQucW5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcnQgPSBydCB8fCBbXTsKICAgICAgICAgICAgICAgICAgICBydC5wdXNoKGV4dENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydCB8fCBFTVBUWV9YTUxfTk9ERV9BUlJBWTsKfQpmdW5jdGlvbiBmaW5kRWxlbWVudFJlY3Vyc2l2ZShyb290LCB0ZXN0KSB7CiAgICBpZiAodGVzdChyb290KSkgcmV0dXJuIHJvb3Q7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMocm9vdC5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdmFsdWUpewogICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICBjb25zdCBydCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKGV4dENoaWxkLCB0ZXN0KTsKICAgICAgICAgICAgaWYgKHJ0KSByZXR1cm4gcnQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBxbmFtZUVxKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLm5hbWUgPT09IHJocy5uYW1lICYmIGxocy5uYW1lc3BhY2VVcmkgPT09IHJocy5uYW1lc3BhY2VVcmk7Cn0KZnVuY3Rpb24gcW5hbWVzSW5jbHVkZShsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zb21lKCh2KT0+cW5hbWVFcSh2LCByaHMpCiAgICApOwp9CmNvbnN0IEVNUFRZX1NUUklOR19NQVAgPSBuZXcgTWFwKCk7CmNvbnN0IEVNUFRZX1hNTF9OT0RFX0FSUkFZID0gW107CmZ1bmN0aW9uIGFwcGx5UW5hbWVzKG5vZGUsIG5hbWVzcGFjZXMpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgYXR0cyA9IG5hbWVzcGFjZXMucHVzaChub2RlLmF0dHJzTWFwKTsKICAgICAgICBjb25zdCBub2RlQXNBbnkgPSBub2RlOwogICAgICAgIG5vZGVBc0FueS5hdHRzID0gYXR0czsKICAgICAgICBub2RlQXNBbnkucW5hbWUgPSBjb21wdXRlUW5hbWUobm9kZS50YWduYW1lLCBuYW1lc3BhY2VzKTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkTm9kZSBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBhcHBseVFuYW1lcyhjaGlsZE5vZGUsIG5hbWVzcGFjZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBmaW5hbGx5ewogICAgICAgIG5hbWVzcGFjZXMucG9wKCk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVFuYW1lKG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsIG5hbWVzcGFjZXMpIHsKICAgIGNvbnN0IGkgPSBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5maW5kTmFtZXNwYWNlVXJpKCcnKQogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoaSArIDEpLAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5nZXROYW1lc3BhY2VVcmkobmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoMCwgaSkpCiAgICB9Owp9CmNsYXNzIFhtbE5hbWVzcGFjZXMgewogICAgc3RhY2sgPSBbXTsKICAgIGdldCBzdGFja1NpemUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2subGVuZ3RoOwogICAgfQogICAgcHVzaChhdHRyc01hcCkgewogICAgICAgIGNvbnN0IGF0dHJzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCk7CiAgICAgICAgbGV0IG1hcDsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgYXR0cnMuZW50cmllcygpKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICd4bWxucycpIHsKICAgICAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICBtYXAuc2V0KCcnLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5zdGFydHNXaXRoKCd4bWxuczonKSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWUuc3Vic3RyaW5nKDYpOwogICAgICAgICAgICAgICAgbWFwLnNldChwcmVmaXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnN0YWNrLnB1c2gobWFwIHx8IEVNUFRZX1NUUklOR19NQVApOwogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KICAgIHBvcCgpIHsKICAgICAgICB0aGlzLnN0YWNrLnBvcCgpOwogICAgfQogICAgZmluZE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGdldE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBnZXROYW1lc3BhY2VVcmk6IHByZWZpeCBub3QgZm91bmQ6ICR7cHJlZml4fWApOwogICAgfQp9CmZ1bmN0aW9uIGlzUmVhZG9ubHlBcnJheShhcmcpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyZyk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybCh1cmwsIHN1YmplY3QsIG9wdHMpIHsKICAgIGNvbnN0IHJvb3RDb21tZW50ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKTsKICAgIGlmICghcm9vdENvbW1lbnQpIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBjb21tZW50ZXJzID0gYXdhaXQgY29sbGVjdENvbW1lbnRlcnMocm9vdENvbW1lbnQsIG9wdHMpOwogICAgcmV0dXJuIHsKICAgICAgICBzdWJqZWN0LAogICAgICAgIHJvb3RDb21tZW50LAogICAgICAgIGNvbW1lbnRlcnMKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRDb3VudChjb21tZW50KSB7CiAgICByZXR1cm4gMSArIGNvbW1lbnQucmVwbGllcy5tYXAoY29tcHV0ZUNvbW1lbnRDb3VudCkucmVkdWNlKChhLCBiKT0+YSArIGIKICAgICwgMCk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3Qgb2JqID0gb3B0cy5vYmogfHwgYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFvYmopIHJldHVybiB1bmRlZmluZWQ7CiAgICBpZiAob2JqLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvbicpIHsKICAgICAgICBjb25zdCBlbXB0eUNvbW1lbnQgPSB7CiAgICAgICAgICAgIGNvbnRlbnQ6ICcoT3JkZXJlZENvbGxlY3Rpb24pJywKICAgICAgICAgICAgcmVwbGllczogW10sCiAgICAgICAgICAgIGF0dGFjaG1lbnRzOiBbXQogICAgICAgIH07CiAgICAgICAgY29uc3Qgb3JkZXJlZENvbGxlY3Rpb24gPSBvYmo7CiAgICAgICAgYXdhaXQgY29sbGVjdENvbW1lbnRzRnJvbU9yZGVyZWRDb2xsZWN0aW9uKG9yZGVyZWRDb2xsZWN0aW9uLCBlbXB0eUNvbW1lbnQsIG9wdHMsIG5ldyBTZXQoKSk7CiAgICAgICAgcmV0dXJuIGVtcHR5Q29tbWVudDsKICAgIH0KICAgIGNvbnN0IG5vdGVPclBvZGNhc3RFcGlzb2RlID0gb2JqOwogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsobm90ZU9yUG9kY2FzdEVwaXNvZGUpOwogICAgYXdhaXQgY29sbGVjdENvbW1lbnRzKG5vdGVPclBvZGNhc3RFcGlzb2RlLCByb290Q29tbWVudCwgb3B0cywgdXJsKTsKICAgIHJldHVybiByb290Q29tbWVudDsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpIHsKICAgIGlmICgob3JkZXJlZENvbGxlY3Rpb24uaXRlbXM/Lmxlbmd0aCB8fCAwKSA+IDAgfHwgKG9yZGVyZWRDb2xsZWN0aW9uLm9yZGVyZWRJdGVtcz8ubGVuZ3RoIHx8IDApID4gMCkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb3JkZXJlZENvbGxlY3Rpb24uaXRlbXMvb3JkZXJlZEl0ZW1zIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9yZGVyZWRDb2xsZWN0aW9uKX1gKTsKICAgIH0KICAgIGlmIChvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCA9PT0gdW5kZWZpbmVkICYmIG9yZGVyZWRDb2xsZWN0aW9uLnRvdGFsSXRlbXMgPT09IDApIHsKICAgIH0gZWxzZSBpZiAodHlwZW9mIG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0ID09PSAnc3RyaW5nJykgewogICAgICAgIGF3YWl0IGZldGNoUGFnZXMob3JkZXJlZENvbGxlY3Rpb24uZmlyc3QsIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0IG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9yZGVyZWRDb2xsZWN0aW9uKX1gKTsKICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudHMobm90ZSwgY29tbWVudCwgb3B0cywgdXJsKSB7CiAgICBjb25zdCB7IGtlZXBHb2luZyAsIGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3QgZmV0Y2hlZCA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IHBvZGNhc3RFcGlzb2RlQ29tbWVudHMgPSBub3RlLnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScgPyBub3RlLmNvbW1lbnRzIDogbm90ZS5yZXBsaWVzOwogICAgaWYgKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMpIHsKICAgICAgICBpZiAodHlwZW9mIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgIGNvbnN0IHVybCA9IHBvZGNhc3RFcGlzb2RlQ29tbWVudHM7CiAgICAgICAgICAgIGNvbnN0IG9iaiA9IGF3YWl0IGZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgICAgICBpZiAoIW9iaikgcmV0dXJuOwogICAgICAgICAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgICAgICAgICBpZiAob2JqLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvbicpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9yZGVyZWRDb2xsZWN0aW9uID0gb2JqOwogICAgICAgICAgICAgICAgYXdhaXQgY29sbGVjdENvbW1lbnRzRnJvbU9yZGVyZWRDb2xsZWN0aW9uKG9yZGVyZWRDb2xsZWN0aW9uLCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb2JqLnR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QgPT09ICdvYmplY3QnICYmIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QudHlwZSA9PT0gJ0NvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICAgICAgaWYgKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QuaXRlbXMgJiYgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgYXdhaXQgY29sbGVjdEl0ZW1zKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QuaXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QubmV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBhd2FpdCBmZXRjaFBhZ2VzKHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QubmV4dCwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBmaXJzdC5uZXh0IG5vdCBpbXBsZW1lbnRlZCAke3BvZGNhc3RFcGlzb2RlQ29tbWVudHMuZmlyc3QubmV4dH1gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0IHR5cGUgbm90IGltcGxlbWVudGVkICR7cG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShwb2RjYXN0RXBpc29kZUNvbW1lbnRzKSkgewogICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IG5vbi1zdGFuZGFyZCBwb2RjYXN0RXBpc29kZUNvbW1lbnRzIGFycmF5IG5vdCBlbXB0eWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHBvZGNhc3RFcGlzb2RlQ29tbWVudHMuaXRlbXMpKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwb2RjYXN0RXBpc29kZUNvbW1lbnRzLml0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBmaXJzdCBvciBpdGVtcyBhcnJheSBub3QgZm91bmRgKTsKICAgICAgICB9CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hQYWdlcyh1cmwsIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpIHsKICAgIGNvbnN0IHsgZmV0Y2hBY3Rpdml0eVB1YiAsIGtlZXBHb2luZyAgfSA9IG9wdHM7CiAgICBsZXQgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgaWYgKCFvYmopIHJldHVybjsKICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgbGV0IGtlZXBDb2xsZWN0aW5nID0gdHJ1ZTsKICAgIHdoaWxlKGtlZXBDb2xsZWN0aW5nKXsKICAgICAgICBpZiAob2JqLnR5cGUgIT09ICdDb2xsZWN0aW9uUGFnZScgJiYgb2JqLnR5cGUgIT09ICdPcmRlcmVkQ29sbGVjdGlvblBhZ2UnKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogcGFnZSBvYmoudHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgICAgIH0KICAgICAgICBjb25zdCBwYWdlID0gb2JqLnR5cGUgPT09ICdDb2xsZWN0aW9uUGFnZScgPyBvYmogOiBvYmo7CiAgICAgICAgaWYgKHBhZ2UuaXRlbXMpIHsKICAgICAgICAgICAgYXdhaXQgY29sbGVjdEl0ZW1zKHBhZ2UuaXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCk7CiAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHBhZ2UudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uUGFnZScgJiYgcGFnZS5vcmRlcmVkSXRlbXMpIHsKICAgICAgICAgICAgYXdhaXQgY29sbGVjdEl0ZW1zKHBhZ2Uub3JkZXJlZEl0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlLm5leHQpIHsKICAgICAgICAgICAgaWYgKHR5cGVvZiBwYWdlLm5leHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBpZiAoZmV0Y2hlZC5oYXMocGFnZS5uZXh0KSkgewogICAgICAgICAgICAgICAgICAgIGtlZXBDb2xsZWN0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHVybCA9IHBhZ2UubmV4dDsKICAgICAgICAgICAgICAgICAgICBvYmogPSBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGlmICghb2JqKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgZmV0Y2hlZC5hZGQodXJsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogcGFnZS5uZXh0IG5vdCBpbXBsZW1lbnRlZCAke3BhZ2UubmV4dH1gKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGtlZXBDb2xsZWN0aW5nID0gZmFsc2U7CiAgICAgICAgfQogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RJdGVtcyhpdGVtcywgY29tbWVudCwgb3B0cywgdXJsKSB7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpewogICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycgJiYgIWl0ZW0uc3RhcnRzV2l0aCgneycpKSB7CiAgICAgICAgICAgIGNvbnN0IHJlcGx5ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybF8oaXRlbSwgb3B0cyk7CiAgICAgICAgICAgIGlmIChyZXBseSkgewogICAgICAgICAgICAgICAgY29tbWVudC5yZXBsaWVzLnB1c2gocmVwbHkpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaXRlbU9iaiA9IHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJyA/IEpTT04ucGFyc2UoaXRlbSkgOiBpdGVtOwogICAgICAgICAgICBjb25zdCByZXBseSA9IGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhpdGVtT2JqKTsKICAgICAgICAgICAgY29tbWVudC5yZXBsaWVzLnB1c2gocmVwbHkpOwogICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICBvcHRzLndhcm4ocmVwbHksIHVybCwgJ0ZvdW5kIGl0ZW0gaW5jb3JyZWN0bHkgZG91YmxlIGVuY29kZWQgYXMgYSBqc29uIHN0cmluZycpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RDb21tZW50cyhpdGVtLCByZXBseSwgb3B0cywgdXJsKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gaW5pdENvbW1lbnRGcm9tT2JqZWN0T3JMaW5rKG9iamVjdCkgewogICAgaWYgKG9iamVjdC50eXBlID09PSAnTm90ZScpIHsKICAgICAgICBjb25zdCB7IGF0dHJpYnV0ZWRUbyAsIGNvbnRlbnQgLCBwdWJsaXNoZWQgLCBpZCAgfSA9IG9iamVjdDsKICAgICAgICBjb25zdCB1cmwgPSAob2JqZWN0LnVybCA9PT0gbnVsbCA/IHVuZGVmaW5lZCA6IG9iamVjdC51cmwpIHx8IGlkOwogICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlZFRvICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50ICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmNvbnRlbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHt0eXBlb2YgY29udGVudH0gJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGlmICh0eXBlb2YgcHVibGlzaGVkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLnB1Ymxpc2hlZCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHVybCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUudXJsIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYXR0cmlidXRlZFRvLAogICAgICAgICAgICBjb250ZW50LAogICAgICAgICAgICBwdWJsaXNoZWQsCiAgICAgICAgICAgIHJlcGxpZXM6IFtdLAogICAgICAgICAgICBhdHRhY2htZW50cwogICAgICAgIH07CiAgICB9CiAgICBpZiAob2JqZWN0LnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScpIHsKICAgICAgICBjb25zdCBwb2RjYXN0RXBpc29kZSA9IG9iamVjdDsKICAgICAgICBjb25zdCB7IGF0dHJpYnV0ZWRUbyAsIHB1Ymxpc2hlZCAsIGRlc2NyaXB0aW9uICwgaW1hZ2UgIH0gPSBwb2RjYXN0RXBpc29kZTsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZWRUbyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuYXR0cmlidXRlZFRvIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIHB1Ymxpc2hlZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUucHVibGlzaGVkIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIGRlc2NyaXB0aW9uICE9PSAnb2JqZWN0JyB8fCBkZXNjcmlwdGlvbi50eXBlICE9PSAnTm90ZScpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuZGVzY3JpcHRpb24gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IHsgY29udGVudCAgfSA9IGRlc2NyaXB0aW9uOwogICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3R5cGVvZiBjb250ZW50fSAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgY29uc3QgdXJsID0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gaW1hZ2UgPyBbCiAgICAgICAgICAgIGNvbXB1dGVBdHRhY2htZW50KGltYWdlKQogICAgICAgIF0gOiBbXTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGF0dHJpYnV0ZWRUbywKICAgICAgICAgICAgY29udGVudCwKICAgICAgICAgICAgcHVibGlzaGVkLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHMKICAgICAgICB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBpdGVtIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKfQpmdW5jdGlvbiBjb21wdXRlQXR0YWNobWVudHMob2JqZWN0KSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgaWYgKCFvYmplY3QuYXR0YWNobWVudCkgcmV0dXJuIHJ0OwogICAgY29uc3QgYXR0YWNobWVudHMgPSBpc1JlYWRvbmx5QXJyYXkob2JqZWN0LmF0dGFjaG1lbnQpID8gb2JqZWN0LmF0dGFjaG1lbnQgOiBbCiAgICAgICAgb2JqZWN0LmF0dGFjaG1lbnQKICAgIF07CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgYXR0YWNobWVudHMpewogICAgICAgIHJ0LnB1c2goY29tcHV0ZUF0dGFjaG1lbnQoYXR0YWNobWVudCkpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50KG9iamVjdCkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdC50eXBlICE9PSAnRG9jdW1lbnQnICYmIG9iamVjdC50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGF0dGFjaG1lbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgY29uc3QgeyBtZWRpYVR5cGUgLCB3aWR0aCAsIGhlaWdodCAsIHVybCAgfSA9IG9iamVjdDsKICAgIGlmICh0eXBlb2YgbWVkaWFUeXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBtZWRpYVR5cGUgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKHdpZHRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHdpZHRoICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB3aWR0aCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICBpZiAoaGVpZ2h0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGhlaWdodCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcihgVE9ETzogaGVpZ2h0IHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB1cmwgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZWRpYVR5cGUsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHVybAogICAgfTsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudGVycyhjb21tZW50LCBvcHRzKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9zID0gbmV3IFNldCgpOwogICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcyk7CiAgICBjb25zdCBydCA9IG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlZFRvIG9mIGF0dHJpYnV0ZWRUb3MpewogICAgICAgIGNvbnN0IGNvbW1lbnRlciA9IGF3YWl0IGZldGNoQ29tbWVudGVyKGF0dHJpYnV0ZWRUbywgb3B0cyk7CiAgICAgICAgaWYgKCFjb21tZW50ZXIpIHJldHVybiBydDsKICAgICAgICBydC5zZXQoYXR0cmlidXRlZFRvLCBjb21tZW50ZXIpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoQ29tbWVudGVyKHVybCwgb3B0cykgewogICAgY29uc3Qgb2JqID0gYXdhaXQgb3B0cy5mZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHBlcnNvbiA9IG9iajsKICAgIHJldHVybiBjb21wdXRlQ29tbWVudGVyKHBlcnNvbik7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pIHsKICAgIGxldCBpY29uMTsKICAgIGlmIChwZXJzb24uaWNvbikgewogICAgICAgIGlmICh0eXBlb2YgcGVyc29uLmljb24gIT09ICdvYmplY3QnIHx8IGlzUmVhZG9ubHlBcnJheShwZXJzb24uaWNvbikgfHwgcGVyc29uLmljb24udHlwZSAhPT0gJ0ltYWdlJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5pY29uIG5vdCBpbXBsZW1lbnRlZDogJHtKU09OLnN0cmluZ2lmeShwZXJzb24uaWNvbil9YCk7CiAgICAgICAgaWNvbjEgPSBjb21wdXRlSWNvbihwZXJzb24uaWNvbik7CiAgICB9CiAgICBjb25zdCB7IG5hbWUgLCB1cmwgIH0gPSBwZXJzb247CiAgICBpZiAodHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLm5hbWUgbm90IGltcGxlbWVudGVkOiAke25hbWV9YCk7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBwZXJzb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBjb25zdCBmcVVzZXJuYW1lID0gY29tcHV0ZUZxVXNlcm5hbWUodXJsLCBwZXJzb24ucHJlZmVycmVkVXNlcm5hbWUpOwogICAgcmV0dXJuIHsKICAgICAgICBpY29uOiBpY29uMSwKICAgICAgICBuYW1lLAogICAgICAgIHVybCwKICAgICAgICBmcVVzZXJuYW1lCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGljb24yKSB7CiAgICBjb25zdCB7IHVybCAsIG1lZGlhVHlwZSAgfSA9IGljb24yOwogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gaWNvbi51cmwgbm90IGltcGxlbWVudGVkOiAke3VybH1gKTsKICAgIGlmIChtZWRpYVR5cGUgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgbWVkaWFUeXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIGljb24ubWVkaWFUeXBlIG5vdCBpbXBsZW1lbnRlZDogJHttZWRpYVR5cGV9YCk7CiAgICByZXR1cm4gewogICAgICAgIHVybCwKICAgICAgICBtZWRpYVR5cGUKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUZxVXNlcm5hbWUodXJsLCBwcmVmZXJyZWRVc2VybmFtZSkgewogICAgY29uc3QgdSA9IG5ldyBVUkwodXJsKTsKICAgIGNvbnN0IG0gPSAvXlwvKEBbXlwvXSspJC8uZXhlYyh1LnBhdGhuYW1lKTsKICAgIGNvbnN0IHVzZXJuYW1lID0gbSA/IG1bMV0gOiBwcmVmZXJyZWRVc2VybmFtZTsKICAgIGlmICghdXNlcm5hbWUpIHRocm93IG5ldyBFcnJvcihgVW5hYmxlIHRvIGNvbXB1dGUgdXNlcm5hbWUgZnJvbSB1cmw6ICR7dXJsfWApOwogICAgcmV0dXJuIGAke3VzZXJuYW1lfUAke3UuaG9zdG5hbWV9YDsKfQpmdW5jdGlvbiBjb2xsZWN0QXR0cmlidXRlZFRvcyhjb21tZW50LCBhdHRyaWJ1dGVkVG9zKSB7CiAgICBpZiAoY29tbWVudC5hdHRyaWJ1dGVkVG8pIGF0dHJpYnV0ZWRUb3MuYWRkKGNvbW1lbnQuYXR0cmlidXRlZFRvKTsKICAgIGZvciAoY29uc3QgcmVwbHkgb2YgY29tbWVudC5yZXBsaWVzKXsKICAgICAgICBjb2xsZWN0QXR0cmlidXRlZFRvcyhyZXBseSwgYXR0cmlidXRlZFRvcyk7CiAgICB9Cn0KZnVuY3Rpb24gaXNQb2RjYXN0SW1hZ2VzU3JjU2V0KHRyaW1tZWRUZXh0KSB7CiAgICBjb25zdCB3aWR0aHMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBkZW5zaXRpZXMgPSBuZXcgU2V0KCk7CiAgICBsZXQgd2l0aFdpZHRoQ291bnQgPSAwOwogICAgY29uc3QgcGllY2VzID0gdHJpbW1lZFRleHQuc3BsaXQoLyxccysvKTsKICAgIGZvciAoY29uc3QgcGllY2Ugb2YgcGllY2VzKXsKICAgICAgICBjb25zdCBtID0gL14oW15cc10rKShccysoXGQrd3xcZCsoXC5cZCspP3gpKT8kLy5leGVjKHBpZWNlKTsKICAgICAgICBpZiAoIW0pIHJldHVybiBmYWxzZTsKICAgICAgICBjb25zdCB1cmwgPSBtWzFdOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSBtWzNdIHx8ICcnOwogICAgICAgIGlmICghaXNVcmwodXJsKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChkZXNjcmlwdG9yLmVuZHNXaXRoKCd3JykpIHsKICAgICAgICAgICAgd2l0aFdpZHRoQ291bnQrKzsKICAgICAgICAgICAgY29uc3Qgd2lkdGggPSBwYXJzZUludChkZXNjcmlwdG9yLnN1YnN0cmluZygwLCBkZXNjcmlwdG9yLmxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgaWYgKHdpZHRoIDw9IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKHdpZHRocy5oYXMod2lkdGgpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHdpZHRocy5hZGQod2lkdGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGRlbnNpdHkgPSBkZXNjcmlwdG9yLmVuZHNXaXRoKCd4JykgPyBwYXJzZUZsb2F0KGRlc2NyaXB0b3Iuc3Vic3RyaW5nKDAsIGRlc2NyaXB0b3IubGVuZ3RoIC0gMSkpIDogMTsKICAgICAgICAgICAgaWYgKGRlbnNpdHkgPD0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoZGVuc2l0aWVzLmhhcyhkZW5zaXR5KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBkZW5zaXRpZXMuYWRkKGRlbnNpdHkpOwogICAgICAgIH0KICAgIH0KICAgIGlmICh3aXRoV2lkdGhDb3VudCA+IDAgJiYgd2l0aFdpZHRoQ291bnQgIT09IHBpZWNlcy5sZW5ndGgpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGlzTm90RW1wdHkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cmltbWVkVGV4dC5sZW5ndGggPiAwOwp9CmZ1bmN0aW9uIGlzVXJsKHRyaW1tZWRUZXh0KSB7CiAgICBjb25zdCB1ID0gdHJ5UGFyc2VVcmwodHJpbW1lZFRleHQpOwogICAgcmV0dXJuIHUgJiYgdS5wcm90b2NvbCA9PT0gJ2h0dHBzOicgfHwgdT8ucHJvdG9jb2wgPT09ICdodHRwOic7Cn0KZnVuY3Rpb24gaXNVcmkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cnlQYXJzZVVybCh0cmltbWVkVGV4dCkgIT09IHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBpc01pbWVUeXBlKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cdytcL1stKy5cd10rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNVdWlkKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXsxMn0kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0VtYWlsQWRkcmVzcyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW15AXHNdK0BbXkBcc10rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNBdE1vc3RDaGFyYWN0ZXJzKG1heENoYXJhY3RlcnMpIHsKICAgIHJldHVybiAodHJpbW1lZFRleHQpPT50cmltbWVkVGV4dC5sZW5ndGggPD0gbWF4Q2hhcmFjdGVycwogICAgOwp9CmZ1bmN0aW9uIGlzU2Vjb25kcyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrKFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0dlb0xhdExvbih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eZ2VvOi0/XGR7MSwyfShcLlxkKyk/LC0/XGR7MSwzfShcLlxkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW05XUl1cZCsoI1xkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNOb25OZWdhdGl2ZUludGVnZXIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkKyQvLnRlc3QodHJpbW1lZFRleHQpICYmIHBhcnNlSW50KHRyaW1tZWRUZXh0KSA+PSAwICYmIHBhcnNlSW50KHRyaW1tZWRUZXh0KS50b1N0cmluZygpID09PSB0cmltbWVkVGV4dDsKfQpmdW5jdGlvbiBpc0RlY2ltYWwodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkKyhcLlxkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNSZmMyODIyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bMC05QS1aYS16LCBdKyBcZHsyfTpcZHsyfSg6XGR7Mn0pPyAoLT9bMC05XSt8W0EtWl17Myx9KSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzSXNvODYwMSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGR7NH0tXGR7Mn0tXGR7Mn1UXGR7Mn06XGR7Mn06XGR7Mn0oXC5cZCspP1okLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0Jvb2xlYW4odHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXih0cnVlfGZhbHNlKSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzUG9kY2FzdFZhbHVlVHlwZVNsdWcodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlthLXpdKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzUG9kY2FzdE1lZGl1bSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW2Etel0rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwoc3RyLCBiYXNlKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHN0ciwgYmFzZSk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpmdW5jdGlvbiB2YWxpZGF0ZUZlZWRYbWwoeG1sLCBjYWxsYmFja3MpIHsKICAgIGlmICh4bWwudGFnbmFtZSAhPT0gJyF4bWwnKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC50YWduYW1lOiAke3htbC50YWduYW1lfWApOwogICAgaWYgKE9iamVjdC5rZXlzKHhtbC5hdHRyc01hcCkubGVuZ3RoID4gMCkgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHhtbCwgYEJhZCB4bWwuYXR0cnNNYXA6ICR7eG1sLmF0dHJzTWFwfWApOwogICAgY29uc3QgZG9jRWxlbWVudCA9IE9iamVjdC52YWx1ZXMoeG1sLmNoaWxkKS5mbGF0TWFwKCh2KT0+dgogICAgKVswXTsKICAgIGlmICghZG9jRWxlbWVudCkgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHhtbCwgYE5vIHhtbCByb290IGVsZW1lbnRgKTsKICAgIHZhbGlkYXRlUnNzKGRvY0VsZW1lbnQsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gcG9kY2FzdEluZGV4UmVmZXJlbmNlKGhyZWYpIHsKICAgIHJldHVybiB7CiAgICAgICAgcnVsZXNldDogJ3BvZGNhc3RpbmRleCcsCiAgICAgICAgaHJlZgogICAgfTsKfQpmdW5jdGlvbiBnZXRTaW5nbGVDaGlsZChub2RlLCBuYW1lLCBjYWxsYmFja3MsIG9wdHMgPSB7Cn0pIHsKICAgIGNvbnN0IGNoaWxkcmVuID0gZmluZENoaWxkRWxlbWVudHMobm9kZSwgewogICAgICAgIG5hbWUKICAgIH0pOwogICAgaWYgKGNoaWxkcmVuLmxlbmd0aCAhPT0gMSkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEV4cGVjdGVkIHNpbmdsZSA8JHtuYW1lfT4gY2hpbGQgZWxlbWVudCB1bmRlciA8JHtub2RlLnRhZ25hbWV9PiwgZm91bmQgJHtjaGlsZHJlbi5sZW5ndGggPT09IDAgPyAnbm9uZScgOiBjaGlsZHJlbi5sZW5ndGh9YCwgb3B0cyk7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIHJldHVybiBjaGlsZHJlblswXTsKfQpmdW5jdGlvbiB2YWxpZGF0ZVJzcyhyc3MsIGNhbGxiYWNrcykgewogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCN3aGF0SXNSc3MnCiAgICAgICAgfQogICAgfTsKICAgIGlmIChyc3MudGFnbmFtZSAhPT0gJ3JzcycpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcihyc3MsIGBCYWQgeG1sIHJvb3QgdGFnOiAke3Jzcy50YWduYW1lfSwgZXhwZWN0ZWQgcnNzYCwgb3B0cyk7CiAgICBjb25zdCB2ZXJzaW9uID0gcnNzLmF0dHMuZ2V0KCd2ZXJzaW9uJyk7CiAgICBpZiAodmVyc2lvbiAhPT0gJzIuMCcpIGNhbGxiYWNrcy5vbldhcm5pbmcocnNzLCBgQmFkIHJzcy52ZXJzaW9uOiAke3ZlcnNpb259LCBleHBlY3RlZCAyLjBgLCBvcHRzKTsKICAgIGNvbnN0IGl0dW5lc09wdHMgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9wb2RjYXN0ZXJzLmFwcGxlLmNvbS9zdXBwb3J0LzgyMy1wb2RjYXN0LXJlcXVpcmVtZW50cyM6fjp0ZXh0PVBvZGNhc3QlMjBSU1MlMjBmZWVkJTIwdGVjaG5pY2FsJTIwcmVxdWlyZW1lbnRzJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCBoYXNJdHVuZXNQcmVmaXggPSBmaW5kRWxlbWVudFJlY3Vyc2l2ZShyc3MsICh2KT0+di50YWduYW1lLnN0YXJ0c1dpdGgoJ2l0dW5lczonKQogICAgKSAhPT0gdW5kZWZpbmVkOwogICAgaWYgKGhhc0l0dW5lc1ByZWZpeCkgY2hlY2tBdHRyaWJ1dGVFcXVhbChyc3MsICd4bWxuczppdHVuZXMnLCAnaHR0cDovL3d3dy5pdHVuZXMuY29tL2R0ZHMvcG9kY2FzdC0xLjAuZHRkJywgY2FsbGJhY2tzLCBpdHVuZXNPcHRzKTsKICAgIGNvbnN0IGhhc0NvbnRlbnRQcmVmaXggPSBmaW5kRWxlbWVudFJlY3Vyc2l2ZShyc3MsICh2KT0+di50YWduYW1lLnN0YXJ0c1dpdGgoJ2NvbnRlbnQ6JykKICAgICkgIT09IHVuZGVmaW5lZDsKICAgIGlmIChoYXNDb250ZW50UHJlZml4KSBjaGVja0F0dHJpYnV0ZUVxdWFsKHJzcywgJ3htbG5zOmNvbnRlbnQnLCAnaHR0cDovL3B1cmwub3JnL3Jzcy8xLjAvbW9kdWxlcy9jb250ZW50LycsIGNhbGxiYWNrcywgaXR1bmVzT3B0cyk7CiAgICBjb25zdCBjaGFubmVsID0gZ2V0U2luZ2xlQ2hpbGQocnNzLCAnY2hhbm5lbCcsIGNhbGxiYWNrcywgb3B0cyk7CiAgICBpZiAoIWNoYW5uZWwpIHJldHVybjsKICAgIHZhbGlkYXRlQ2hhbm5lbChjaGFubmVsLCBjYWxsYmFja3MpOwp9CmZ1bmN0aW9uIHZhbGlkYXRlQ2hhbm5lbChjaGFubmVsLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IG9wdHMgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdyc3MnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9jeWJlci5oYXJ2YXJkLmVkdS9yc3MvcnNzLmh0bWwjcmVxdWlyZWRDaGFubmVsRWxlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IHRpdGxlID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ3RpdGxlJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dCh0aXRsZSwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNvbnN0IGxpbmsgPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAnbGluaycsIGNhbGxiYWNrcywgb3B0cyk7CiAgICBjaGVja1RleHQobGluaywgaXNVcmwsIGNhbGxiYWNrcywgb3B0cyk7CiAgICBjb25zdCBkZXNjcmlwdGlvbiA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICdkZXNjcmlwdGlvbicsIGNhbGxiYWNrcywgb3B0cyk7CiAgICBjaGVja1RleHQoZGVzY3JpcHRpb24sIGlzTm90RW1wdHksIGNhbGxiYWNrcywgb3B0cyk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjZ3VpZCcpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4Lmd1aWQpLmNoZWNrVmFsdWUoaXNVdWlkLCAoZ3VpZFRleHQpPT57CiAgICAgICAgY29uc3QgdmVyc2lvbiA9IGd1aWRUZXh0LmNoYXJBdCgxNCk7CiAgICAgICAgaWYgKHZlcnNpb24gIT09ICc1JykgewogICAgICAgICAgICByZXR1cm4gYGV4cGVjdGVkIGEgVVVJRHY1LCBmb3VuZCBhIFVVSUR2JHt2ZXJzaW9ufWA7CiAgICAgICAgfQogICAgfSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbG9ja2VkJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubG9ja2VkKS5jaGVja1ZhbHVlKCh2KT0+L14oeWVzfG5vKSQvLnRlc3QodikKICAgICkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnb3duZXInLCBpc0VtYWlsQWRkcmVzcykuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBmb3IgKGNvbnN0IGZ1bmRpbmcgb2YgZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5mdW5kaW5nKSl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnY2hhbm5lbCcsIGZ1bmRpbmcsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjZnVuZGluZycpKS5jaGVja1ZhbHVlKGlzTm90RW1wdHkpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIGNoZWNrUG9kY2FzdFBlcnNvbignY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RMb2NhdGlvbignY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBmb3IgKGNvbnN0IHRyYWlsZXIgb2YgZmluZENoaWxkRWxlbWVudHMoY2hhbm5lbCwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC50cmFpbGVyKSl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnY2hhbm5lbCcsIHRyYWlsZXIsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdHJhaWxlcicpKS5jaGVja1ZhbHVlKGlzTm90RW1wdHkpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwdWJkYXRlJywgaXNSZmMyODIyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdsZW5ndGgnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3NlYXNvbicsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIGNoZWNrUG9kY2FzdExpY2Vuc2UoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY2hlY2tQb2RjYXN0VmFsdWUoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI21lZGl1bScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4Lm1lZGl1bSkuY2hlY2tWYWx1ZShpc1BvZGNhc3RNZWRpdW0pLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY2hlY2tQb2RjYXN0SW1hZ2VzKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IHNvY2lhbHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbCk7CiAgICBjb25zdCBzb2NpYWxSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9wcm9wb3NhbC1kb2NzL3NvY2lhbC9zb2NpYWwubWQjc29jaWFsLWVsZW1lbnQnKTsKICAgIGNvbnN0IHNvY2lhbFNpZ25VcFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWxzaWdudXAtZWxlbWVudCcpOwogICAgZm9yIChjb25zdCBzb2NpYWwgb2Ygc29jaWFscyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnY2hhbm5lbCcsIHNvY2lhbCwgY2FsbGJhY2tzLCBzb2NpYWxSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3BsYXRmb3JtJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncHJvdG9jb2wnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50SWQnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50VXJsJywgaXNVcmwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNvbnN0IHNvY2lhbFNpZ25VcHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbFNpZ25VcCk7CiAgICAgICAgZm9yIChjb25zdCBzb2NpYWxTaWduVXAgb2Ygc29jaWFsU2lnblVwcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3NvY2lhbCcsIHNvY2lhbFNpZ25VcCwgY2FsbGJhY2tzLCBzb2NpYWxTaWduVXBSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2hvbWVVcmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc2lnblVwVXJsJywgaXNVcmwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnN0IGJhZFNvY2lhbFNpZ251cHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbFNpZ25VcCk7CiAgICBpZiAoYmFkU29jaWFsU2lnbnVwcy5sZW5ndGggPiAwKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhiYWRTb2NpYWxTaWdudXBzWzBdLCBgQmFkIDwke2JhZFNvY2lhbFNpZ251cHNbMF0udGFnbmFtZX0+OiBzaG91bGQgYmUgYSBjaGlsZCBvZiA8cG9kY2FzdDpzb2NpYWw+LCBub3QgY2hhbm5lbGApOwogICAgfQogICAgY29uc3QgcG9kcGluZ1JlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3MvcG9kcGluZy9wb2RwaW5nLm1kI3NwZWNpZmljYXRpb24nKTsKICAgIGNvbnN0IHBvZHBpbmcgPSBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kcGluZ1JlZmVyZW5jZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5wb2RwaW5nKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1c2VzUG9kcGluZycsIGlzQm9vbGVhbikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkubm9kZTsKICAgIGlmIChwb2RwaW5nKSB7CiAgICAgICAgZm9yIChjb25zdCBoaXZlQWNjb3VudCBvZiBmaW5kQ2hpbGRFbGVtZW50cyhwb2RwaW5nLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmhpdmVBY2NvdW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3BvZHBpbmcnLCBoaXZlQWNjb3VudCwgY2FsbGJhY2tzLCBwb2RwaW5nUmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhY2NvdW50JywgaXNOb3RFbXB0eSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY2hlY2tQb2RjYXN0VGFnVXNhZ2UoY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGl0ZW1zID0gY2hhbm5lbC5jaGlsZC5pdGVtIHx8IFtdOwogICAgbGV0IGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCA9IDA7CiAgICBsZXQgaXRlbXNWYWxpZGF0ZWQgPSAwOwogICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXsKICAgICAgICBpZiAoaXRlbXNWYWxpZGF0ZWQgPCAxKSB7CiAgICAgICAgICAgIHZhbGlkYXRlSXRlbShpdGVtLCBjYWxsYmFja3MpOwogICAgICAgICAgICBpdGVtc1ZhbGlkYXRlZCsrOwogICAgICAgIH0KICAgICAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIHsKICAgICAgICAgICAgbmFtZTogJ2VuY2xvc3VyZScKICAgICAgICB9KTsKICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoID4gMCkgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50Kys7CiAgICB9CiAgICBjYWxsYmFja3Mub25Sc3NJdGVtc0ZvdW5kKGl0ZW1zLmxlbmd0aCwgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50KTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RQZXJzb24obGV2ZWwsIG5vZGUsIGNhbGxiYWNrcykgewogICAgZm9yIChjb25zdCBwZXJzb24gb2YgZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5wZXJzb24pKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KGxldmVsLCBwZXJzb24sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjcGVyc29uJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncm9sZScsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2dyb3VwJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaW1nJywgaXNVcmwpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2hyZWYnLCBpc1VybCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0TG9jYXRpb24obGV2ZWwsIG5vZGUsIGNhbGxiYWNrcykgewogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbG9jYXRpb24nKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5sb2NhdGlvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZ2VvJywgaXNHZW9MYXRMb24pLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ29zbScsIGlzT3BlblN0cmVldE1hcElkZW50aWZpZXIpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0TGljZW5zZShsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsaWNlbnNlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubGljZW5zZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0VmFsdWUobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcykgewogICAgY29uc3QgdmFsdWUgPSBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN2YWx1ZScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnZhbHVlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNQb2RjYXN0VmFsdWVUeXBlU2x1ZykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnbWV0aG9kJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnc3VnZ2VzdGVkJywgaXNEZWNpbWFsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKS5ub2RlOwogICAgaWYgKHZhbHVlKSB7CiAgICAgICAgZm9yIChjb25zdCB2YWx1ZVJlY2lwaWVudCBvZiBmaW5kQ2hpbGRFbGVtZW50cyh2YWx1ZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC52YWx1ZVJlY2lwaWVudCkpewogICAgICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCd2YWx1ZScsIHZhbHVlUmVjaXBpZW50LCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3ZhbHVlLXJlY2lwaWVudCcpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCduYW1lJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnY3VzdG9tS2V5JywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnY3VzdG9tVmFsdWUnLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNQb2RjYXN0VmFsdWVUeXBlU2x1ZykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnYWRkcmVzcycsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3NwbGl0JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2ZlZScsIGlzQm9vbGVhbikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdEltYWdlcyhsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNpbWFnZXMnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5pbWFnZXMpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3NyY3NldCcsIGlzUG9kY2FzdEltYWdlc1NyY1NldCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0VGFnVXNhZ2Uobm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBrbm93biA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IHVua25vd24gPSBuZXcgU2V0KCk7CiAgICBjb25zdCBuYW1lc3BhY2VVcmlzID0gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBlbGVtZW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguTkFNRVNQQUNFUy5tYXAoKHYpPT4oewogICAgICAgICAgICBuYW1lOiAnKicsCiAgICAgICAgICAgIG5hbWVzcGFjZVVyaTogdgogICAgICAgIH0pCiAgICApKSl7CiAgICAgICAgY29uc3QgaXNLbm93biA9IFFuYW1lcy5Qb2RjYXN0SW5kZXguS05PV05fTkFNRVMuaGFzKGVsZW1lbnQucW5hbWUubmFtZSk7CiAgICAgICAgKGlzS25vd24gPyBrbm93biA6IHVua25vd24pLmFkZChlbGVtZW50LnFuYW1lLm5hbWUpOwogICAgICAgIGlmIChlbGVtZW50LnFuYW1lLm5hbWVzcGFjZVVyaSkgbmFtZXNwYWNlVXJpcy5hZGQoZWxlbWVudC5xbmFtZS5uYW1lc3BhY2VVcmkpOwogICAgfQogICAgaWYgKGtub3duLnNpemUgKyB1bmtub3duLnNpemUgPiAwKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uUG9kY2FzdEluZGV4VGFnTmFtZXNGb3VuZChrbm93biwgdW5rbm93biwgbmFtZXNwYWNlVXJpcyk7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tBdHRyaWJ1dGVFcXVhbChub2RlLCBhdHROYW1lLCBhdHRFeHBlY3RlZFZhbHVlLCBjYWxsYmFja3MsIG9wdHMgPSB7Cn0pIHsKICAgIGNvbnN0IGF0dFZhbHVlID0gbm9kZS5hdHRzLmdldChhdHROYW1lKTsKICAgIGlmICghYXR0VmFsdWUpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nIDwke25vZGUudGFnbmFtZX0+ICR7YXR0TmFtZX0gYXR0cmlidXRlLCBleHBlY3RlZCAke2F0dEV4cGVjdGVkVmFsdWV9YCwgb3B0cyk7CiAgICB9IGVsc2UgaWYgKGF0dFZhbHVlICE9PSBhdHRFeHBlY3RlZFZhbHVlKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+ICR7YXR0TmFtZX0gYXR0cmlidXRlIHZhbHVlOiAke2F0dFZhbHVlfSwgZXhwZWN0ZWQgJHthdHRFeHBlY3RlZFZhbHVlfWAsIG9wdHMpOwogICAgfQp9CmZ1bmN0aW9uIGNoZWNrVGV4dChub2RlLCB0ZXN0LCBjYWxsYmFja3MsIG9wdHMgPSB7Cn0pIHsKICAgIGlmIChub2RlKSB7CiAgICAgICAgY29uc3QgdHJpbW1lZFRleHQgPSAobm9kZS52YWwgfHwgJycpLnRyaW0oKTsKICAgICAgICBpZiAoIXRlc3QodHJpbW1lZFRleHQpKSB7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiB2YWx1ZTogJHt0cmltbWVkVGV4dCA9PT0gJycgPyAnPGVtcHR5PicgOiB0cmltbWVkVGV4dH1gLCBvcHRzKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRyaW1tZWRUZXh0OwogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBmaW5kRmlyc3RDaGlsZEVsZW1lbnQobm9kZSwgcW5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgZWxlbWVudHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCBxbmFtZSk7CiAgICBpZiAoZWxlbWVudHMubGVuZ3RoID09PSAwKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgSXRlbSBpcyBtaXNzaW5nIGFuIDwke3FuYW1lLm5hbWV9PiBlbGVtZW50YCwgb3B0cyk7CiAgICB9IGVsc2UgewogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAxKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBJdGVtIGhhcyBtdWx0aXBsZSA8JHtxbmFtZS5uYW1lfT4gZWxlbWVudHNgLCBvcHRzKTsKICAgICAgICByZXR1cm4gZWxlbWVudHNbMF07CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHZhbGlkYXRlSXRlbShpdGVtLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IGl0dW5lc09wdHMxID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAnaXR1bmVzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vcG9kY2FzdGVycy5hcHBsZS5jb20vc3VwcG9ydC84MjMtcG9kY2FzdC1yZXF1aXJlbWVudHMjOn46dGV4dD1Qb2RjYXN0JTIwUlNTJTIwZmVlZCUyMHRlY2huaWNhbCUyMHJlcXVpcmVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgaXR1bmVzT3B0czIgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9oZWxwLmFwcGxlLmNvbS9pdGMvcG9kY2FzdHNfY29ubmVjdC8jL2l0Y2I1NDM1MzM5MCcKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBmaW5kRmlyc3RDaGlsZEVsZW1lbnQoaXRlbSwgewogICAgICAgIG5hbWU6ICd0aXRsZScKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgaWYgKHRpdGxlKSB7CiAgICAgICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIGl0dW5lc09wdHMyKTsKICAgIH0KICAgIGNvbnN0IGVuY2xvc3VyZSA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ2VuY2xvc3VyZScKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgaWYgKGVuY2xvc3VyZSkgewogICAgICAgIGNvbnN0IHJzc0VuY2xvc3VyZU9wdHMgPSB7CiAgICAgICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9jeWJlci5oYXJ2YXJkLmVkdS9yc3MvcnNzLmh0bWwjbHRlbmNsb3N1cmVndFN1YmVsZW1lbnRPZkx0aXRlbWd0JwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCB1cmwgPSBlbmNsb3N1cmUuYXR0cy5nZXQoJ3VybCcpOwogICAgICAgIGlmICghdXJsKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgaXRlbSA8ZW5jbG9zdXJlPiB1cmwgYXR0cmlidXRlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgaWYgKHVybCAmJiAhaXNVcmwodXJsKSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBCYWQgaXRlbSA8ZW5jbG9zdXJlPiB1cmwgYXR0cmlidXRlIHZhbHVlOiAke3VybH0sIGV4cGVjdGVkIHVybGAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgICAgIGNvbnN0IGxlbmd0aCA9IGVuY2xvc3VyZS5hdHRzLmdldCgnbGVuZ3RoJyk7CiAgICAgICAgaWYgKCFsZW5ndGgpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgTWlzc2luZyA8ZW5jbG9zdXJlPiBsZW5ndGggYXR0cmlidXRlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgaWYgKGxlbmd0aCAmJiAhaXNOb25OZWdhdGl2ZUludGVnZXIobGVuZ3RoKSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBCYWQgaXRlbSA8ZW5jbG9zdXJlPiBsZW5ndGggYXR0cmlidXRlIHZhbHVlOiAke2xlbmd0aH0sIGV4cGVjdGVkIG5vbi1uZWdhdGl2ZSBpbnRlZ2VyYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgdHlwZSA9IGVuY2xvc3VyZS5hdHRzLmdldCgndHlwZScpOwogICAgICAgIGlmICghdHlwZSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nIDxlbmNsb3N1cmU+IHR5cGUgYXR0cmlidXRlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgaWYgKHR5cGUgJiYgIWlzTWltZVR5cGUodHlwZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgQmFkIGl0ZW0gPGVuY2xvc3VyZT4gdHlwZSBhdHRyaWJ1dGUgdmFsdWU6ICR7dHlwZX0sIGV4cGVjdGVkIE1JTUUgdHlwZWAsIHJzc0VuY2xvc3VyZU9wdHMpOwogICAgfQogICAgY29uc3QgZ3VpZCA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ2d1aWQnCiAgICB9LCBjYWxsYmFja3MsIGl0dW5lc09wdHMxKTsKICAgIGlmIChndWlkKSB7CiAgICAgICAgY29uc3QgZ3VpZFRleHQgPSBjaGVja1RleHQoZ3VpZCwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMSk7CiAgICAgICAgY29uc3QgcnNzR3VpZE9wdHMgPSB7CiAgICAgICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9jeWJlci5oYXJ2YXJkLmVkdS9yc3MvcnNzLmh0bWwjbHRndWlkZ3RTdWJlbGVtZW50T2ZMdGl0ZW1ndCcKICAgICAgICAgICAgfQogICAgICAgIH07CiAgICAgICAgY29uc3QgbWlzc3BlbGxpbmdzID0gWwogICAgICAgICAgICAuLi5ndWlkLmF0dHMua2V5cygpCiAgICAgICAgXS5maWx0ZXIoKHYpPT52ICE9PSAnaXNQZXJtYUxpbmsnICYmIHYudG9Mb3dlckNhc2UoKSA9PT0gJ2lzcGVybWFsaW5rJwogICAgICAgICk7CiAgICAgICAgZm9yIChjb25zdCBtaXNzcGVsbGluZyBvZiBtaXNzcGVsbGluZ3MpewogICAgICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKGd1aWQsIGBCYWQgaXRlbSA8Z3VpZD4gaXNQZXJtYUxpbmsgYXR0cmlidXRlIHNwZWxsaW5nOiAke21pc3NwZWxsaW5nfWAsIHJzc0d1aWRPcHRzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXNQZXJtYUxpbmsgPSBndWlkLmF0dHMuZ2V0KCdpc1Blcm1hTGluaycpIHx8ICd0cnVlJzsKICAgICAgICBpZiAoaXNQZXJtYUxpbmsgPT09ICd0cnVlJyAmJiBndWlkVGV4dCAmJiAhaXNVcmwoZ3VpZFRleHQpICYmIG1pc3NwZWxsaW5ncy5sZW5ndGggPT09IDApIGNhbGxiYWNrcy5vbldhcm5pbmcoZ3VpZCwgYEJhZCBpdGVtIDxndWlkPiB2YWx1ZTogJHtndWlkVGV4dH0sIGV4cGVjdGVkIHVybCB3aGVuIGlzUGVybWFMaW5rPSJ0cnVlIiBvciB1bnNwZWNpZmllZGAsIHJzc0d1aWRPcHRzKTsKICAgIH0KICAgIGNvbnN0IHRyYW5zY3JpcHRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC50cmFuc2NyaXB0KTsKICAgIGZvciAoY29uc3QgdHJhbnNjcmlwdCBvZiB0cmFuc2NyaXB0cyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIHRyYW5zY3JpcHQsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdHJhbnNjcmlwdCcpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xhbmd1YWdlJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncmVsJywgaXNOb3RFbXB0eSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICB9CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjY2hhcHRlcnMnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5jaGFwdGVycykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc01pbWVUeXBlKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGNvbnN0IHNvdW5kYml0ZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvdW5kYml0ZSk7CiAgICBmb3IgKGNvbnN0IHNvdW5kYml0ZSBvZiBzb3VuZGJpdGVzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgc291bmRiaXRlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3NvdW5kYml0ZScpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdzdGFydFRpbWUnLCBpc1NlY29uZHMpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2R1cmF0aW9uJywgaXNTZWNvbmRzKS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIGNoZWNrUG9kY2FzdFBlcnNvbignaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RMb2NhdGlvbignaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjc2Vhc29uJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc2Vhc29uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCduYW1lJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKHYpCiAgICApLmNoZWNrVmFsdWUoaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2VwaXNvZGUnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5lcGlzb2RlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdkaXNwbGF5JywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICkuY2hlY2tWYWx1ZShpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY2hlY2tQb2RjYXN0TGljZW5zZSgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjb25zdCBhbHRlcm5hdGVFbmNsb3N1cmVzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5hbHRlcm5hdGVFbmNsb3N1cmUpOwogICAgZm9yIChjb25zdCBhbHRlcm5hdGVFbmNsb3N1cmUgb2YgYWx0ZXJuYXRlRW5jbG9zdXJlcyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIGFsdGVybmF0ZUVuY2xvc3VyZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNhbHRlcm5hdGUtZW5jbG9zdXJlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc01pbWVUeXBlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdsZW5ndGgnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnYml0cmF0ZScsIGlzRGVjaW1hbCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaGVpZ2h0JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xhbmcnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd0aXRsZScsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMzIpKHYpCiAgICAgICAgKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyZWwnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgICAgICkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnY29kZWNzJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZGVmYXVsdCcsIGlzQm9vbGVhbikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yU2luZ2xlQ2hpbGQoJ2FsdGVybmF0ZUVuY2xvc3VyZScsIGFsdGVybmF0ZUVuY2xvc3VyZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNpbnRlZ3JpdHknKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5pbnRlZ3JpdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCAodik9Pi9eKHNyaXxwZ3Atc2lnbmF0dXJlKSQvLnRlc3QodikKICAgICAgICApLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3ZhbHVlJywgaXNOb3RFbXB0eSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgY29uc3Qgc291cmNlcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGFsdGVybmF0ZUVuY2xvc3VyZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VyY2UpOwogICAgICAgIGZvciAoY29uc3Qgc291cmNlIG9mIHNvdXJjZXMpewogICAgICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdhbHRlcm5hdGVFbmNsb3N1cmUnLCBzb3VyY2UsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjYWx0ZXJuYXRlLWVuY2xvc3VyZScpKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmknLCBpc1VyaSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnY29udGVudFR5cGUnLCBpc01pbWVUeXBlKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjaGVja1BvZGNhc3RWYWx1ZSgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RJbWFnZXMoJ2l0ZW0nLCBpdGVtLCBjYWxsYmFja3MpOwogICAgY29uc3Qgc29jaWFsSW50ZXJhY3RzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zb2NpYWxJbnRlcmFjdCk7CiAgICBjb25zdCBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWxpbnRlcmFjdC1lbGVtZW50Jyk7CiAgICBmb3IgKGNvbnN0IHNvY2lhbEludGVyYWN0IG9mIHNvY2lhbEludGVyYWN0cyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIHNvY2lhbEludGVyYWN0LCBjYWxsYmFja3MsIHNvY2lhbEludGVyYWN0UmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwbGF0Zm9ybScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3Byb3RvY29sJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnYWNjb3VudElkJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHViRGF0ZScsIGlzSXNvODYwMSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHJpb3JpdHknLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tWYWx1ZShpc1VyaSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgY2FsbGJhY2tzLm9uR29vZChzb2NpYWxJbnRlcmFjdCwgJ0ZvdW5kIDxwb2RjYXN0OnNvY2lhbEludGVyYWN0PiwgbmljZSEnLCB7CiAgICAgICAgICAgIHRhZzogJ3NvY2lhbC1pbnRlcmFjdCcsCiAgICAgICAgICAgIHJlZmVyZW5jZTogc29jaWFsSW50ZXJhY3RSZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIGNoZWNrUG9kY2FzdFRhZ1VzYWdlKGl0ZW0sIGNhbGxiYWNrcyk7Cn0KY2xhc3MgRWxlbWVudFZhbGlkYXRpb24gewogICAgc3RhdGljIEVNUFRZX1NUUklOR19TRVQgPSBuZXcgU2V0KCk7CiAgICBub2RlOwogICAgbGV2ZWw7CiAgICBjYWxsYmFja3M7CiAgICBvcHRzOwogICAgcmVtYWluaW5nQXR0TmFtZXM7CiAgICBjb25zdHJ1Y3RvcihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBvcHRzKXsKICAgICAgICB0aGlzLmxldmVsID0gbGV2ZWw7CiAgICAgICAgdGhpcy5ub2RlID0gbm9kZTsKICAgICAgICB0aGlzLmNhbGxiYWNrcyA9IGNhbGxiYWNrczsKICAgICAgICB0aGlzLm9wdHMgPSBvcHRzOwogICAgICAgIHRoaXMucmVtYWluaW5nQXR0TmFtZXMgPSBub2RlID8gbmV3IFNldChub2RlLmF0dHMua2V5cygpKSA6IEVsZW1lbnRWYWxpZGF0aW9uLkVNUFRZX1NUUklOR19TRVQ7CiAgICB9CiAgICBzdGF0aWMgZm9yRWxlbWVudChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCByZWZlcmVuY2UpIHsKICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHsKICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgfSk7CiAgICB9CiAgICBzdGF0aWMgZm9yU2luZ2xlQ2hpbGQobGV2ZWwsIHBhcmVudCwgY2FsbGJhY2tzLCByZWZlcmVuY2UsIC4uLnFuYW1lcykgewogICAgICAgIGNoZWNrVHJ1ZSgncW5hbWVzLmxlbmd0aCcsIHFuYW1lcy5sZW5ndGgsIHFuYW1lcy5sZW5ndGggPiAwKTsKICAgICAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKHBhcmVudCwgLi4ucW5hbWVzKTsKICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoID4gMCkgewogICAgICAgICAgICBpZiAoZWxlbWVudHMubGVuZ3RoID4gMSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbGVtZW50c1sxXSwgYE11bHRpcGxlICR7bGV2ZWx9IDwke2VsZW1lbnRzWzFdLnRhZ25hbWV9PiBlbGVtZW50cyBhcmUgbm90IGFsbG93ZWRgLCB7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIGNvbnN0IGVsZW1lbnQgPSBlbGVtZW50c1swXTsKICAgICAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgZWxlbWVudCwgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIHVuZGVmaW5lZCwgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgY2hlY2tWYWx1ZSh0ZXN0LCBhZGRpdGlvbmFsVGVzdCkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgIH0gPSB0aGlzOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgIGNvbnN0IHRyaW1tZWRUZXh0ID0gY2hlY2tUZXh0KG5vZGUsIHRlc3QsIGNhbGxiYWNrcywgb3B0cyk7CiAgICAgICAgICAgIGlmICh0cmltbWVkVGV4dCAmJiBhZGRpdGlvbmFsVGVzdCkgewogICAgICAgICAgICAgICAgY29uc3Qgd2FybmluZ1N1ZmZpeCA9IGFkZGl0aW9uYWxUZXN0KHRyaW1tZWRUZXh0KTsKICAgICAgICAgICAgICAgIGlmICh3YXJuaW5nU3VmZml4KSB7CiAgICAgICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+IHZhbHVlOiAke3RyaW1tZWRUZXh0ID09PSAnJyA/ICc8ZW1wdHk+JyA6IHRyaW1tZWRUZXh0fSwgJHt3YXJuaW5nU3VmZml4fWAsIG9wdHMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZShuYW1lLCB0ZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmICghdmFsdWUpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYE1pc3NpbmcgJHtsZXZlbH0gPCR7bm9kZS50YWduYW1lfT4gJHtuYW1lfSBhdHRyaWJ1dGVgLCBvcHRzKTsKICAgICAgICAgICAgaWYgKHZhbHVlICYmICF0ZXN0KHZhbHVlKSkgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlIHZhbHVlOiAke3ZhbHVlfWAsIG9wdHMpOwogICAgICAgICAgICB0aGlzLnJlbWFpbmluZ0F0dE5hbWVzLmRlbGV0ZShuYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjaGVja09wdGlvbmFsQXR0cmlidXRlKG5hbWUsIHRlc3QpIHsKICAgICAgICBjb25zdCB7IG5vZGUgLCBjYWxsYmFja3MgLCBvcHRzICwgbGV2ZWwgIH0gPSB0aGlzOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gbm9kZS5hdHRzLmdldChuYW1lKTsKICAgICAgICAgICAgaWYgKHZhbHVlICYmICF0ZXN0KHZhbHVlKSkgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlIHZhbHVlOiAke3ZhbHVlfWAsIG9wdHMpOwogICAgICAgICAgICB0aGlzLnJlbWFpbmluZ0F0dE5hbWVzLmRlbGV0ZShuYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9CiAgICBjaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKSB7CiAgICAgICAgY29uc3QgeyByZW1haW5pbmdBdHROYW1lcyAsIGNhbGxiYWNrcyAsIG5vZGUgLCBvcHRzICwgbGV2ZWwgIH0gPSB0aGlzOwogICAgICAgIGlmIChub2RlKSB7CiAgICAgICAgICAgIGlmIChyZW1haW5pbmdBdHROYW1lcy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+IGF0dHJpYnV0ZSBuYW1lJHtyZW1haW5pbmdBdHROYW1lcy5zaXplID4gMSA/ICdzJyA6ICcnfTogJHtbCiAgICAgICAgICAgICAgICAgICAgLi4ucmVtYWluaW5nQXR0TmFtZXMKICAgICAgICAgICAgICAgIF0uam9pbignLCAnKX1gLCBvcHRzKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KfQpmdW5jdGlvbiBzZXRJbnRlcnNlY3QobGhzLCByaHMpIHsKICAgIGNvbnN0IHJ0ID0gbmV3IFNldCgpOwogICAgZm9yIChjb25zdCBpdGVtIG9mIGxocyl7CiAgICAgICAgaWYgKHJocy5oYXMoaXRlbSkpIHJ0LmFkZChpdGVtKTsKICAgIH0KICAgIGZvciAoY29uc3QgaXRlbTEgb2YgcmhzKXsKICAgICAgICBpZiAobGhzLmhhcyhpdGVtMSkpIHJ0LmFkZChpdGVtMSk7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KY2xhc3MgVmFsaWRhdGlvbkpvYlZNIHsKICAgIGZldGNoZXJzOwogICAgcGlTZWFyY2hGZXRjaGVyOwogICAgbmV4dEpvYklkID0gMTsKICAgIGN1cnJlbnRKb2I7CiAgICBnZXQgdmFsaWRhdGluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuY3VycmVudEpvYi5kb25lOwogICAgfQogICAgZ2V0IGRvbmUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY3VycmVudEpvYi5kb25lOwogICAgfQogICAgZ2V0IG1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2IubWVzc2FnZXMgOiBbXTsKICAgIH0KICAgIGdldCBpc1NlYXJjaCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jdXJyZW50Sm9iLnNlYXJjaDsKICAgIH0KICAgIGdldCBzZWFyY2hSZXN1bHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cyA6IFtdOwogICAgfQogICAgZ2V0IHhtbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy54bWw7CiAgICB9CiAgICBnZXQgeG1sU3VtbWFyeVRleHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8ueG1sU3VtbWFyeVRleHQ7CiAgICB9CiAgICBnZXQgZmV0Y2hDb21tZW50c1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy5mZXRjaENvbW1lbnRzUmVzdWx0OwogICAgfQogICAgY29uc3RydWN0b3Iob3B0cyl7CiAgICAgICAgY29uc3QgeyBsb2NhbEZldGNoZXI6IGxvY2FsRmV0Y2hlcjEgLCByZW1vdGVGZXRjaGVyOiByZW1vdGVGZXRjaGVyMSAsIHBpU2VhcmNoRmV0Y2hlciAgfSA9IG9wdHM7CiAgICAgICAgdGhpcy5mZXRjaGVycyA9IHsKICAgICAgICAgICAgbG9jYWxGZXRjaGVyOiBsb2NhbEZldGNoZXIxLAogICAgICAgICAgICByZW1vdGVGZXRjaGVyOiByZW1vdGVGZXRjaGVyMQogICAgICAgIH07CiAgICAgICAgdGhpcy5waVNlYXJjaEZldGNoZXIgPSBwaVNlYXJjaEZldGNoZXI7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57CiAgICB9OwogICAgY29udGludWVXaXRoKHVybCkgewogICAgICAgIGNvbnN0IHsgY3VycmVudEpvYiAgfSA9IHRoaXM7CiAgICAgICAgaWYgKGN1cnJlbnRKb2IpIHsKICAgICAgICAgICAgY3VycmVudEpvYi5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiAncnVubmluZycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnVmFsaWRhdGluZycKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY3VycmVudEpvYi5tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRleHQ6ICdDb250aW51aW5nIHdpdGggZmVlZCBmcm9tIHNlYXJjaCcsCiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgdGhpcy52YWxpZGF0ZUFzeW5jKHVybCwgY3VycmVudEpvYik7CiAgICAgICAgfQogICAgfQogICAgc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgY29uc3Qgam9iID0gewogICAgICAgICAgICBpZDogdGhpcy5uZXh0Sm9iSWQrKywKICAgICAgICAgICAgbWVzc2FnZXM6IFtdLAogICAgICAgICAgICBzZWFyY2hSZXN1bHRzOiBbXSwKICAgICAgICAgICAgdGltZXM6IHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3B0aW9ucywKICAgICAgICAgICAgc2VhcmNoOiBmYWxzZSwKICAgICAgICAgICAgZG9uZTogZmFsc2UsCiAgICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2UKICAgICAgICB9OwogICAgICAgIHRoaXMuY3VycmVudEpvYiA9IGpvYjsKICAgICAgICBqb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICdydW5uaW5nJywKICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyhpbnB1dCwgam9iKTsKICAgIH0KICAgIGNhbmNlbFZhbGlkYXRpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudEpvYiAmJiAhdGhpcy5jdXJyZW50Sm9iLmRvbmUpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEpvYi5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZldGNoKHVybCwgb3B0cykgewogICAgICAgIGNvbnN0IHsgaGVhZGVycyAgfSA9IG9wdHM7CiAgICAgICAgY29uc3QgeyBmZXRjaGVycyAgfSA9IHRoaXM7CiAgICAgICAgcmV0dXJuIGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICAgICAgZmV0Y2hlcnMsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KTsKICAgIH0KICAgIGFzeW5jIHZhbGlkYXRlQXN5bmMoaW5wdXQsIGpvYikgewogICAgICAgIGlucHV0ID0gbm9ybWFsaXplSW5wdXQoaW5wdXQpOwogICAgICAgIGNvbnN0IHsgbWVzc2FnZXMgIH0gPSBqb2I7CiAgICAgICAgY29uc3Qgc2V0U3RhdHVzID0gKHRleHQsIG9wdHMgPSB7CiAgICAgICAgfSk9PnsKICAgICAgICAgICAgY29uc3QgeyB1cmwgLCB0eXBlICB9ID0gb3B0czsKICAgICAgICAgICAgbWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlIHx8IG1lc3NhZ2VzWzBdLnR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGFkZE1lc3NhZ2UgPSAodHlwZSwgdGV4dCwgb3B0cyA9IHsKICAgICAgICB9KT0+ewogICAgICAgICAgICBjb25zdCB7IHVybCAsIHRhZyAsIGNvbW1lbnQgLCByZWZlcmVuY2UgIH0gPSBvcHRzOwogICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdGFnLAogICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH07CiAgICAgICAgbGV0IGFjdGl2aXR5UHViOwogICAgICAgIGNvbnN0IGhlYWRlcnMgPSB7CiAgICAgICAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiAnZ3ppcCcsCiAgICAgICAgICAgICdVc2VyLUFnZW50Jzogam9iLm9wdGlvbnMudXNlckFnZW50LAogICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZScKICAgICAgICB9OwogICAgICAgIGxldCBjb250aW51ZVdpdGhVcmw7CiAgICAgICAgY29uc3Qgam9iU3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgIGNvbnN0IHsgZmV0Y2hlcnMgLCBwaVNlYXJjaEZldGNoZXIgIH0gPSB0aGlzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQudHJpbSgpOwogICAgICAgICAgICBpZiAoaW5wdXQgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGlucHV0YCk7CiAgICAgICAgICAgIGlmICgvXmh0dHBzPzpcL1wvLisvaS50ZXN0KGlucHV0KSkgewogICAgICAgICAgICAgICAgY29uc3QgaW5wdXRVcmwgPSB0cnlQYXJzZVVybDEoaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKCFpbnB1dFVybCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiAke2lucHV0fWApOwogICAgICAgICAgICAgICAgY2hlY2tNYXRjaGVzKCdpbnB1dFVybC5wcm90b2NvbCcsIGlucHV0VXJsLnByb3RvY29sLCAvXmh0dHBzPzokLyk7CiAgICAgICAgICAgICAgICBpbnB1dFVybC5zZWFyY2hQYXJhbXMuc2V0KCdfdCcsIERhdGUubm93KCkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZTogc2lkZTEgLCBmZXRjaFRpbWUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2goaW5wdXRVcmwudG9TdHJpbmcoKSwgewogICAgICAgICAgICAgICAgICAgIGZldGNoZXJzLAogICAgICAgICAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGpvYi5kb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICBqb2IudGltZXMuZmV0Y2hUaW1lID0gZmV0Y2hUaW1lOwogICAgICAgICAgICAgICAgaWYgKHNpZGUxID09PSAnbG9jYWwnKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZ29vZCcsIGBMb2NhbCBmZXRjaCBzdWNjZWVkZWQgKENPUlMgZW5hYmxlZClgLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogaW5wdXQKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNoZWNrRXF1YWwoYCR7aW5wdXRVcmwuaG9zdH0gcmVzcG9uc2Ugc3RhdHVzYCwgcmVzcG9uc2Uuc3RhdHVzLCAyMDApOwogICAgICAgICAgICAgICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICAgICAgICAgICAgICBsZXQgdmFsaWRhdGVGZWVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChjb250ZW50VHlwZSAmJiBjb250ZW50VHlwZS5pbmNsdWRlcygnL2h0bWwnKSkgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnRm91bmQgaHRtbCwgd2lsbCB0cnkgYWdhaW4gYXMgQWN0aXZpdHlQdWInKTsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUZlZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBpbnB1dCwKICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogJ2lucHV0IHVybCcKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlICYmIGNvbnRlbnRUeXBlLnN0YXJ0c1dpdGgoJ2FwcGxpY2F0aW9uL2FjdGl2aXR5K2pzb24nKSkgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnRm91bmQgQWN0aXZpdHlQdWIganNvbicpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IG9iaiA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUZlZWQgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YiA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBpbnB1dCwKICAgICAgICAgICAgICAgICAgICAgICAgc3ViamVjdDogJ2lucHV0IHVybCcsCiAgICAgICAgICAgICAgICAgICAgICAgIG9iagogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodmFsaWRhdGVGZWVkKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpOwogICAgICAgICAgICAgICAgICAgIGlmIChqb2IuZG9uZSkgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy5yZWFkVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgbGV0IHhtbDsKICAgICAgICAgICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgICAgICAgICB4bWwgPSBwYXJzZVhtbCh0ZXh0KTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coeG1sKTsKICAgICAgICAgICAgICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1lc3NhZ2UgPSB0eXBlb2YgZS5tZXNzYWdlID09PSAnc3RyaW5nJyA/IGUubWVzc2FnZSA6ICcnOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93bkludmFsaWQgPSBtZXNzYWdlID09PSBgQ2Fubm90IHJlYWQgcHJvcGVydGllcyBvZiB1bmRlZmluZWQgKHJlYWRpbmcgJ3BhcmVudCcpYDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBgWG1sIHBhcnNlIGZhaWxlZDogJHtrbm93bkludmFsaWQgPyAnSW52YWxpZCB4bWwnIDogZS5tZXNzYWdlfWApOwogICAgICAgICAgICAgICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnBhcnNlVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHhtbCkgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9uTWVzc2FnZSA9ICh0eXBlLCBub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSh0eXBlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChvcHRzPy50YWcgPT09ICdzb2NpYWwtaW50ZXJhY3QnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUudmFsICYmIG5vZGUudmFsICE9PSAnJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChub2RlLmF0dHJzTWFwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZXMuZ2V0KCdwbGF0Zm9ybScpID09PSAnYWN0aXZpdHlwdWInIHx8IGF0dHJpYnV0ZXMuZ2V0KCdwcm90b2NvbCcpID09PSAnYWN0aXZpdHlwdWInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBlcGlzb2RlVGl0bGUgPSBmaW5kRXBpc29kZVRpdGxlKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBub2RlLnZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiBlcGlzb2RlVGl0bGUgPyBg4oCcJHtlcGlzb2RlVGl0bGV94oCdYCA6ICdlcGlzb2RlJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qga25vd25QaVRhZ3MgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVua25vd25QaVRhZ3MgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpTmFtZXNwYWNlVXJpcyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJzc0l0ZW1JbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkdvb2Q6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2dvb2QnLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkVycm9yOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnZXJyb3InLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbldhcm5pbmc6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ3dhcm5pbmcnLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkluZm86IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2luZm8nLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBvZGNhc3RJbmRleFRhZ05hbWVzRm91bmQ6IChrbm93biwgdW5rbm93biwgbmFtZXNwYWNlVXJpcyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrbm93bi5mb3JFYWNoKCh2KT0+a25vd25QaVRhZ3MuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmtub3duLmZvckVhY2goKHYpPT51bmtub3duUGlUYWdzLmFkZCh2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbmFtZXNwYWNlVXJpcy5mb3JFYWNoKCh2KT0+cGlOYW1lc3BhY2VVcmlzLmFkZCh2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Sc3NJdGVtc0ZvdW5kOiAoaXRlbXNDb3VudCwgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50KT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJzc0l0ZW1JbmZvID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgeG1sU3VtbWFyeVRleHQgPSAnWG1sIHN0cnVjdHVyZSc7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy52YWxpZGF0ZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChyc3NJdGVtSW5mbykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBpdGVtc0NvdW50ICwgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ICB9ID0gcnNzSXRlbUluZm87CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQgPSBpdGVtc0NvdW50IC0gaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGllY2VzID0gWwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGBGb3VuZCAke3VuaXRTdHJpbmcoaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50LCAnZXBpc29kZScpfWAKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50ID4gMCkgcGllY2VzLnB1c2goYGFuZCAke3VuaXRTdHJpbmcoaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50LCAnaXRlbScpfSB3aXRob3V0IGVuY2xvc3VyZXNgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpZWNlcy5wdXNoKGBpbiBhICR7Zm9ybWF0Qnl0ZXModGV4dC5sZW5ndGgpfSBmZWVkYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgcGllY2VzLmpvaW4oJyAnKSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB4bWxTdW1tYXJ5VGV4dCA9IGAke2l0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCA+IDEgPyAnUG9kY2FzdCBmZWVkJyA6ICdGZWVkJ30gc3RydWN0dXJlYDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaVJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kJyk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHRhZ1N0cmluZyA9IChzZXQpPT5bCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uc2V0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLm1hcCgodik9PmA8cG9kY2FzdDoke3Z9PmAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICkuam9pbignLCAnKQogICAgICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChrbm93blBpVGFncy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZ29vZCcsIGBGb3VuZCAke3VuaXRTdHJpbmcoa25vd25QaVRhZ3Muc2l6ZSwgJ3BvZGNhc3QgbmFtZXNwYWNlIHRhZycpfTogJHt0YWdTdHJpbmcoa25vd25QaVRhZ3MpfWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2U6IHBpUmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodW5rbm93blBpVGFncy5zaXplID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIGBGb3VuZCAke3VuaXRTdHJpbmcodW5rbm93blBpVGFncy5zaXplLCAndW5rbm93biBwb2RjYXN0IG5hbWVzcGFjZSB0YWcnKX06ICR7dGFnU3RyaW5nKHVua25vd25QaVRhZ3MpfWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2U6IHBpUmVmZXJlbmNlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtaXNzcGVsbGVkTmFtZXNwYWNlcyA9IHNldEludGVyc2VjdChwaU5hbWVzcGFjZVVyaXMsIG5ldyBTZXQoUW5hbWVzLlBvZGNhc3RJbmRleC5LTk9XTl9NSVNTUEVMTEVEX05BTUVTUEFDRVMpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG1pc3NwZWxsZWROYW1lc3BhY2VzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNyc3MtbmFtZXNwYWNlLWV4dGVuc2lvbi1mb3ItcG9kY2FzdGluZy10YWctc3BlY2lmaWNhdGlvbicpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIGBGb3VuZCAke3VuaXRTdHJpbmcobWlzc3BlbGxlZE5hbWVzcGFjZXMuc2l6ZSwgJ21pc3NwZWxsZWQgcG9kY2FzdCBuYW1lc3BhY2UgdXJpJyl9OiAke1sKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5taXNzcGVsbGVkTmFtZXNwYWNlcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5qb2luKCcsICcpfWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4bWwgJiYgT2JqZWN0LmtleXMoeG1sKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2IueG1sID0geG1sOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgam9iLnhtbFN1bW1hcnlUZXh0ID0geG1sU3VtbWFyeVRleHQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0ZUNvbW1lbnRzID0gam9iLm9wdGlvbnMudmFsaWRhdGVDb21tZW50cyAhPT0gdW5kZWZpbmVkID8gam9iLm9wdGlvbnMudmFsaWRhdGVDb21tZW50cyA6IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHlQdWIgJiYgIXZhbGlkYXRlQ29tbWVudHMpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0NvbW1lbnRzIHZhbGlkYXRpb24gZGlzYWJsZWQsIG5vdCBmZXRjaGluZyBBY3Rpdml0eVB1YicpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpdml0eVB1YikgewogICAgICAgICAgICAgICAgICAgIHNldFN0YXR1cyhgVmFsaWRhdGluZyBBY3Rpdml0eVB1YiBmb3IgJHthY3Rpdml0eVB1Yi5zdWJqZWN0fWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBhY3Rpdml0eVB1Yi51cmwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZldGNoaW5nIEFjdGl2aXR5UHViIGNvbW1lbnRzJywgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGFjdGl2aXR5UHViLnVybAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtlZXBHb2luZyA9ICgpPT4ham9iLmRvbmUKICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3RlT25seU9yaWdpbnMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZVVzZVNpZGUgPSAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3RlT25seU9yaWdpbnMuaGFzKG5ldyBVUkwodXJsKS5vcmlnaW4pID8gJ3JlbW90ZScgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHlQdWJDYWxscyA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hBY3Rpdml0eVB1YiA9IGFzeW5jICh1cmwpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB7IG9iaiAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgZmV0Y2hlcnMsIGNvbXB1dGVVc2VTaWRlKHVybCksIDApOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShvYmosIHVuZGVmaW5lZCwgMikpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodXJsLmluY2x1ZGVzKCcvYXBpL3YxL3N0YXR1c2VzJykgJiYgdHlwZW9mIG9iai51cmkgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwgPSBvYmoudXJpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgbG9jYWxPclJlbW90ZUZldGNoRmV0Y2hBY3Rpdml0eVB1Yih1cmwsIGZldGNoZXJzLCBjb21wdXRlVXNlU2lkZSh1cmwpLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmogPSByZXMub2JqOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9IHJlcy5zaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JlbW90ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBVUkwodXJsKS5vcmlnaW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbW90ZU9ubHlPcmlnaW5zLmhhcyhvcmlnaW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIGBMb2NhbCBBY3Rpdml0eVB1YiBmZXRjaCBmYWlsZWQgKENPUlMgZGlzYWJsZWQ/KWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWc6ICdjb3JzJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZU9ubHlPcmlnaW5zLmFkZChvcmlnaW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViQ2FsbHMrKzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdhcm4gPSAoY29tbWVudCwgdXJsLCBtZXNzYWdlKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgbWVzc2FnZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmZXRjaENvbW1lbnRzUmVzdWx0ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybChhY3Rpdml0eVB1Yi51cmwsIGFjdGl2aXR5UHViLnN1YmplY3QsIHsKICAgICAgICAgICAgICAgICAgICAgICAga2VlcEdvaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBmZXRjaEFjdGl2aXR5UHViLAogICAgICAgICAgICAgICAgICAgICAgICB3YXJuCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZldGNoQ29tbWVudHNSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGBGb3VuZCAke3VuaXRTdHJpbmcoY29tcHV0ZUNvbW1lbnRDb3VudChmZXRjaENvbW1lbnRzUmVzdWx0LnJvb3RDb21tZW50KSwgJ2NvbW1lbnQnKX0gYW5kICR7dW5pdFN0cmluZyhmZXRjaENvbW1lbnRzUmVzdWx0LmNvbW1lbnRlcnMuc2l6ZSwgJ3BhcnRpY2lwYW50Jyl9LCBtYWRlICR7dW5pdFN0cmluZyhhY3Rpdml0eVB1YkNhbGxzLCAnQWN0aXZpdHlQdWIgY2FsbCcpfWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBqb2IuZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgam9iLnNlYXJjaCA9IHRydWU7CiAgICAgICAgICAgICAgICBzZXRTdGF0dXMoJ1NlYXJjaGluZycpOwogICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoUmVzcG9uc2UgPSBhd2FpdCBwaVNlYXJjaEZldGNoZXIoaW5wdXQsIGhlYWRlcnMpOwogICAgICAgICAgICAgICAgY2hlY2tFcXVhbCgnc2VhcmNoUmVzcG9uc2Uuc3RhdHVzJywgc2VhcmNoUmVzcG9uc2Uuc3RhdHVzLCAyMDApOwogICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoUmVzdWx0ID0gYXdhaXQgc2VhcmNoUmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgaWYgKHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnNlYXJjaFJlc3VsdHMucHVzaCguLi5zZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQuZmVlZHMuc2xpY2UoMCwgMjApKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc1JlYWRvbmx5QXJyYXkoc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQuZmVlZCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlV2l0aFVybCA9IHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0LmZlZWQudXJsOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmVycm9yKGUpOwogICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIGUubWVzc2FnZSk7CiAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgYCR7am9iLnNlYXJjaCA/ICdTZWFyY2ggdG9vaycgOiAnVG9vayd9ICR7Zm9ybWF0VGltZShEYXRlLm5vdygpIC0gam9iU3RhcnQpfSR7Y29tcHV0ZUpvYlRpbWVzU3RyaW5nU3VmZml4KGpvYi50aW1lcyl9YCk7CiAgICAgICAgICAgIGlmIChjb250aW51ZVdpdGhVcmwpIHsKICAgICAgICAgICAgICAgIHRoaXMuY29udGludWVXaXRoKGNvbnRpbnVlV2l0aFVybCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBqb2IuZG9uZSA9IHRydWU7CiAgICAgICAgICAgICAgICBjb25zdCBzdGF0dXMgPSBqb2IuY2FuY2VsbGVkID8gJ0NhbmNlbGxlZCcgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMCA/ICdGb3VuZCBubyBwb2RjYXN0cycgOiBqb2Iuc2VhcmNoICYmIGpvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aCA9PT0gMSA/ICdGb3VuZCBvbmUgcG9kY2FzdCwgc2VsZWN0IHRvIGNvbnRpbnVlJyA6IGpvYi5zZWFyY2ggPyBgRm91bmQgJHtqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGh9IHBvZGNhc3RzLCBzZWxlY3Qgb25lIHRvIGNvbnRpbnVlYCA6ICdEb25lJzsKICAgICAgICAgICAgICAgIHNldFN0YXR1cyhzdGF0dXMsIHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnZG9uZScKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGZvcm1hdFRpbWUobWlsbGlzKSB7CiAgICBpZiAobWlsbGlzIDwgMTAwMCkgcmV0dXJuIGAke21pbGxpc31tc2A7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChtaWxsaXMgLyAxMDAwICogMTAwKSAvIDEwMH1zYDsKfQpmdW5jdGlvbiBjb21wdXRlSm9iVGltZXNTdHJpbmdTdWZmaXgodGltZXMpIHsKICAgIGNvbnN0IHJ0ID0gWwogICAgICAgIFsKICAgICAgICAgICAgJ2ZldGNoJywKICAgICAgICAgICAgdGltZXMuZmV0Y2hUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdyZWFkJywKICAgICAgICAgICAgdGltZXMucmVhZFRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ3BhcnNlJywKICAgICAgICAgICAgdGltZXMucGFyc2VUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICd2YWxpZGF0ZScsCiAgICAgICAgICAgIHRpbWVzLnZhbGlkYXRlVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAnY29tbWVudHMnLAogICAgICAgICAgICB0aW1lcy5jb21tZW50c1RpbWUKICAgICAgICBdCiAgICBdLmZpbHRlcigodik9PnZbMV0gIT09IHVuZGVmaW5lZAogICAgKS5tYXAoKHYpPT5gJHt2WzBdfT0ke2Zvcm1hdFRpbWUodlsxXSl9YAogICAgKS5qb2luKCcsICcpOwogICAgcmV0dXJuIHJ0ID09PSAnJyA/ICcnIDogYCAoJHtydH0pYDsKfQpmdW5jdGlvbiBmb3JtYXRCeXRlcyhieXRlcykgewogICAgbGV0IGFtb3VudCA9IGJ5dGVzOwogICAgaWYgKGFtb3VudCA8IDEwMjQpIHJldHVybiBgJHthbW91bnR9LWJ5dGVgOwogICAgYW1vdW50ID0gYW1vdW50IC8gMTAyNDsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfWtiYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfW1iYDsKfQpmdW5jdGlvbiB1bml0U3RyaW5nKGFtb3VudCwgdW5pdCkgewogICAgcmV0dXJuIGAke2Ftb3VudCA9PT0gMCA/ICdubycgOiBhbW91bnQgPT09IDEgPyAnb25lJyA6IG5ldyBJbnRsLk51bWJlckZvcm1hdCgpLmZvcm1hdChhbW91bnQpfSAke3VuaXR9JHthbW91bnQgPT09IDEgPyAnJyA6ICdzJ31gOwp9CmZ1bmN0aW9uIG5vcm1hbGl6ZUlucHV0KGlucHV0KSB7CiAgICBpbnB1dCA9IGlucHV0LnRyaW0oKTsKICAgIGNvbnN0IG0gPSAvXmh0dHBzOlwvXC9wb2RjYXN0c1wuYXBwbGVcLmNvbVwvLio/KGlkXGQrKSQvLmV4ZWMoaW5wdXQpOwogICAgaWYgKG0pIHJldHVybiBtWzFdOwogICAgcmV0dXJuIGlucHV0Owp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsMSh1cmwpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwodXJsKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIHNsZWVwKG1zKSB7CiAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUpPT5zZXRUaW1lb3V0KHJlc29sdmUsIG1zKQogICAgKTsKfQphc3luYyBmdW5jdGlvbiBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgZmV0Y2hlcnMsIHVzZVNpZGUsIHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzKSB7CiAgICBpZiAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMgPiAwKSBhd2FpdCBzbGVlcChzbGVlcE1pbGxpc0JldHdlZW5DYWxscyk7CiAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICBmZXRjaGVycywKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicKICAgICAgICB9LAogICAgICAgIHVzZVNpZGUKICAgIH0pOwogICAgY2hlY2tFcXVhbCgncmVzLnN0YXR1cycsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5yZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKSk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgIGlmICghKGNvbnRlbnRUeXBlIHx8ICcnKS5pbmNsdWRlcygnanNvbicpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCBodG1sLCBub3QgQWN0aXZpdHlQdWInKTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgIHJldHVybiB7CiAgICAgICAgb2JqLAogICAgICAgIHNpZGUKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoKHVybCwgb3B0cykgewogICAgY29uc3QgeyBmZXRjaGVycyAsIGhlYWRlcnMgLCB1c2VTaWRlICB9ID0gb3B0czsKICAgIGlmICh1c2VTaWRlICE9PSAncmVtb3RlJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBsb2NhbCBmZXRjaDogJHt1cmx9YCk7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaGVycy5sb2NhbEZldGNoZXIodXJsLCBoZWFkZXJzKTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGZldGNoVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0LAogICAgICAgICAgICAgICAgc2lkZTogJ2xvY2FsJywKICAgICAgICAgICAgICAgIHJlc3BvbnNlCiAgICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGxvY2FsIGZldGNoLCB0cnlpbmcgcmVtb3RlJywgZSk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5sb2coYHJlbW90ZSBmZXRjaDogJHt1cmx9YCk7CiAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoZXJzLnJlbW90ZUZldGNoZXIodXJsLCBoZWFkZXJzKTsKICAgIHJldHVybiB7CiAgICAgICAgZmV0Y2hUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnQsCiAgICAgICAgc2lkZTogJ3JlbW90ZScsCiAgICAgICAgcmVzcG9uc2UKICAgIH07Cn0KZnVuY3Rpb24gZmluZEVwaXNvZGVUaXRsZShzb2NpYWxJbnRlcmFjdCkgewogICAgY29uc3QgaXRlbSA9IHNvY2lhbEludGVyYWN0LnBhcmVudDsKICAgIGlmIChpdGVtKSB7CiAgICAgICAgY29uc3QgdGl0bGUgPSBpdGVtLmNoaWxkWyd0aXRsZSddOwogICAgICAgIGlmICh0aXRsZS5sZW5ndGggPiAwICYmIHRpdGxlWzBdLnZhbCkgewogICAgICAgICAgICBjb25zdCB2YWwgPSB0aXRsZVswXS52YWwudHJpbSgpOwogICAgICAgICAgICBpZiAodmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGlzT2F1dGhPYnRhaW5Ub2tlblJlc3BvbnNlKG9iaikgewogICAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgdHlwZW9mIG9iai5hY2Nlc3NfdG9rZW4gPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmoudG9rZW5fdHlwZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5zY29wZSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5jcmVhdGVkX2F0ID09PSAnbnVtYmVyJzsKfQpjb25zdCBBUFBMSUNBVElPTl9KU09OX0NIQVJTRVRfVVRGOCA9ICdhcHBsaWNhdGlvbi9qc29uOyBjaGFyc2V0PXV0Zi04JzsKYXN5bmMgZnVuY3Rpb24gdmVyaWZ5SnNvblJlc3BvbnNlKHJlcywgYm9keVZlcmlmaWVyKSB7CiAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaHR0cCByZXNwb25zZSBzdGF0dXM6ICR7cmVzLnN0YXR1c30sIGV4cGVjdGVkIDIwMCwgYm9keT0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlcy5oZWFkZXJzLmdldCgnY29udGVudC10eXBlJyk7CiAgICBpZiAoY29udGVudFR5cGUgIT09IEFQUExJQ0FUSU9OX0pTT05fQ0hBUlNFVF9VVEY4KSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgaHR0cCByZXNwb25zZSBzdGF0dXM6ICR7Y29udGVudFR5cGV9LCBleHBlY3RlZCAke0FQUExJQ0FUSU9OX0pTT05fQ0hBUlNFVF9VVEY4fSwgYm9keT0ke2F3YWl0IHJlcy50ZXh0KCl9YCk7CiAgICBjb25zdCBib2R5ID0gYXdhaXQgcmVzLmpzb24oKTsKICAgIGlmICghYm9keVZlcmlmaWVyKGJvZHkpKSB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgYm9keTogJHtKU09OLnN0cmluZ2lmeShib2R5LCB1bmRlZmluZWQsIDIpfWApOwogICAgcmV0dXJuIGJvZHk7Cn0KYXN5bmMgZnVuY3Rpb24gc3RhdHVzZXNQdWJsaXNoKGFwaUJhc2UsIGFjY2Vzc1Rva2VuLCBvcHRzKSB7CiAgICBjb25zdCB7IGlkZW1wb3RlbmN5S2V5ICwgc3RhdHVzICwgaW5fcmVwbHlfdG9faWQgIH0gPSBvcHRzOwogICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7CiAgICBoZWFkZXJzLnNldCgnQXV0aG9yaXphdGlvbicsIGBCZWFyZXIgJHthY2Nlc3NUb2tlbn1gKTsKICAgIGlmIChpZGVtcG90ZW5jeUtleSkgaGVhZGVycy5zZXQoJ0lkZW1wb3RlbmN5LUtleScsIGlkZW1wb3RlbmN5S2V5KTsKICAgIGNvbnN0IGRhdGEgPSBuZXcgRm9ybURhdGEoKTsKICAgIGRhdGEuc2V0KCdzdGF0dXMnLCBzdGF0dXMpOwogICAgaWYgKGluX3JlcGx5X3RvX2lkKSBkYXRhLnNldCgnaW5fcmVwbHlfdG9faWQnLCBpbl9yZXBseV90b19pZCk7CiAgICBjb25zdCByZXMgPSBhd2FpdCBmZXRjaChgJHthcGlCYXNlfS9hcGkvdjEvc3RhdHVzZXNgLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogZGF0YSwKICAgICAgICBoZWFkZXJzCiAgICB9KTsKICAgIHJldHVybiB2ZXJpZnlKc29uUmVzcG9uc2UocmVzLCBpc1N0YXR1cyk7Cn0KZnVuY3Rpb24gaXNTdGF0dXMob2JqKSB7CiAgICByZXR1cm4gaXNPYmplY3Qob2JqKSAmJiB0eXBlb2Ygb2JqLmlkID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIG9iai5jcmVhdGVkX2F0ID09PSAnc3RyaW5nJyAmJiB0eXBlb2Ygb2JqLmNvbnRlbnQgPT09ICdzdHJpbmcnICYmIHR5cGVvZiBvYmoudmlzaWJpbGl0eSA9PT0gJ3N0cmluZycgJiYgKG9iai51cmwgPT09IHVuZGVmaW5lZCB8fCB0eXBlb2Ygb2JqLnVybCA9PT0gJ3N0cmluZycpICYmIChvYmouaW5fcmVwbHlfdG9faWQgPT09IHVuZGVmaW5lZCB8fCBvYmouaW5fcmVwbHlfdG9faWQgPT09IG51bGwgfHwgdHlwZW9mIG9iai5pbl9yZXBseV90b19pZCA9PT0gJ3N0cmluZycpOwp9CmNsYXNzIFZhbGlkYXRvckFwcFZNIHsKICAgIGpvYjsKICAgIGdldCB2YWxpZGF0aW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi52YWxpZGF0aW5nOwogICAgfQogICAgZ2V0IG1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiB0aGlzLmpvYi5tZXNzYWdlczsKICAgIH0KICAgIGdldCBpc1NlYXJjaCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IuaXNTZWFyY2g7CiAgICB9CiAgICBnZXQgc2VhcmNoUmVzdWx0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2Iuc2VhcmNoUmVzdWx0czsKICAgIH0KICAgIGdldCB4bWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuam9iLnhtbDsKICAgIH0KICAgIGdldCB4bWxTdW1tYXJ5VGV4dCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IueG1sU3VtbWFyeVRleHQ7CiAgICB9CiAgICBnZXQgZmV0Y2hDb21tZW50c1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5qb2IuZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgIH0KICAgIGNvbnN0cnVjdG9yKG9wdHMpewogICAgICAgIHRoaXMuam9iID0gbmV3IFZhbGlkYXRpb25Kb2JWTShvcHRzKTsKICAgICAgICB0aGlzLmpvYi5vbkNoYW5nZSA9ICgpPT50aGlzLm9uQ2hhbmdlKCkKICAgICAgICA7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57CiAgICB9OwogICAgc3RhcnQoKSB7CiAgICB9CiAgICBjb250aW51ZVdpdGgodXJsKSB7CiAgICAgICAgdGhpcy5qb2IuY29udGludWVXaXRoKHVybCk7CiAgICB9CiAgICBzdGFydFZhbGlkYXRpb24oaW5wdXQsIG9wdGlvbnMpIHsKICAgICAgICB0aGlzLmpvYi5zdGFydFZhbGlkYXRpb24oaW5wdXQsIG9wdGlvbnMpOwogICAgfQogICAgY2FuY2VsVmFsaWRhdGlvbigpIHsKICAgICAgICB0aGlzLmpvYi5jYW5jZWxWYWxpZGF0aW9uKCk7CiAgICB9CiAgICBpc0xvZ2dlZEluKG9yaWdpbikgewogICAgICAgIGNvbnN0IGluZm8gPSBsb2FkTG9naW5JbmZvKG9yaWdpbik7CiAgICAgICAgcmV0dXJuIGluZm8gIT09IHVuZGVmaW5lZCAmJiAhY29tcHV0ZUV4cGlyZWQoaW5mby50b2tlblJlc3BvbnNlKTsKICAgIH0KICAgIGFjY2VwdExvZ2luKG9yaWdpbiwgdG9rZW5SZXNwb25zZSkgewogICAgICAgIGNoZWNrRXF1YWwoJ3Rva2VuX3R5cGUnLCB0b2tlblJlc3BvbnNlLnRva2VuX3R5cGUudG9Mb3dlckNhc2UoKSwgJ2JlYXJlcicpOwogICAgICAgIGNoZWNrVHJ1ZSgnY3JlYXRlZF9hdCwgZXhwaXJlc19pbicsIFsKICAgICAgICAgICAgdG9rZW5SZXNwb25zZS5jcmVhdGVkX2F0LAogICAgICAgICAgICB0b2tlblJlc3BvbnNlLmV4cGlyZXNfaW4KICAgICAgICBdLmpvaW4oJywgJyksICFjb21wdXRlRXhwaXJlZCh0b2tlblJlc3BvbnNlKSk7CiAgICAgICAgc2F2ZUxvZ2luSW5mbyh7CiAgICAgICAgICAgIG9yaWdpbiwKICAgICAgICAgICAgdG9rZW5SZXNwb25zZQogICAgICAgIH0pOwogICAgfQogICAgZXhwaXJlTG9naW4ob3JpZ2luKSB7CiAgICAgICAgZGVsZXRlTG9naW5JbmZvKG9yaWdpbik7CiAgICB9CiAgICBhc3luYyBzZW5kUmVwbHkocmVwbHksIHJlcGx5VG9VcmwpIHsKICAgICAgICByZXBseSA9IHJlcGx5LnRyaW0oKTsKICAgICAgICBpZiAocmVwbHkgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoJ0JhZCByZXBseTogPGVtcHR5PicpOwogICAgICAgIGNvbnN0IHsgb3JpZ2luICB9ID0gbmV3IFVSTChyZXBseVRvVXJsKTsKICAgICAgICBjb25zdCBpbmZvID0gbG9hZExvZ2luSW5mbyhvcmlnaW4pOwogICAgICAgIGlmICghaW5mbykgdGhyb3cgbmV3IEVycm9yKGBObyBsb2dpbiBmb3IgJHtvcmlnaW59YCk7CiAgICAgICAgaWYgKGNvbXB1dGVFeHBpcmVkKGluZm8udG9rZW5SZXNwb25zZSkpIHRocm93IG5ldyBFcnJvcihgTG9naW4gZXhwaXJlZCBmb3IgJHtvcmlnaW59YCk7CiAgICAgICAgY29uc29sZS5sb2coYHJlcGx5VG9VcmxgLCByZXBseVRvVXJsKTsKICAgICAgICBjb25zdCBtYXN0b2RvbklkID0gYXdhaXQgY29tcHV0ZU1hc3RvZG9uSWRGb3JVcmwocmVwbHlUb1VybCwgYXN5bmMgKHVybCwgaGVhZGVycyk9PnsKICAgICAgICAgICAgY29uc3QgeyByZXNwb25zZSAgfSA9IGF3YWl0IHRoaXMuam9iLmZldGNoKHVybCwgewogICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHJlc3BvbnNlOwogICAgICAgIH0pOwogICAgICAgIGNvbnNvbGUubG9nKGBtYXN0b2RvbklkYCwgbWFzdG9kb25JZCk7CiAgICAgICAgY29uc3QgeyB1cmw6IHVybDEgIH0gPSBhd2FpdCBzdGF0dXNlc1B1Ymxpc2gob3JpZ2luLCBpbmZvLnRva2VuUmVzcG9uc2UuYWNjZXNzX3Rva2VuLCB7CiAgICAgICAgICAgIHN0YXR1czogcmVwbHksCiAgICAgICAgICAgIGluX3JlcGx5X3RvX2lkOiBtYXN0b2RvbklkCiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIHVybDE7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUV4cGlyZWQodG9rZW5SZXNwb25zZSkgewogICAgcmV0dXJuIHR5cGVvZiB0b2tlblJlc3BvbnNlLmV4cGlyZXNfaW4gPT09ICdudW1iZXInICYmICh0b2tlblJlc3BvbnNlLmNyZWF0ZWRfYXQgKyB0b2tlblJlc3BvbnNlLmV4cGlyZXNfaW4pICogMTAwMCA8PSBEYXRlLm5vdygpOwp9CmZ1bmN0aW9uIGNvbXB1dGVMb2dpbkluZm9Mb2NhbFN0b3JhZ2VLZXkob3JpZ2luKSB7CiAgICByZXR1cm4gYGxvZ2luOiR7b3JpZ2lufWA7Cn0KZnVuY3Rpb24gbG9hZExvZ2luSW5mbyhvcmlnaW4pIHsKICAgIGNvbnN0IHN0ciA9IGxvY2FsU3RvcmFnZS5nZXRJdGVtKGNvbXB1dGVMb2dpbkluZm9Mb2NhbFN0b3JhZ2VLZXkob3JpZ2luKSk7CiAgICBjb25zdCBvYmogPSB0eXBlb2Ygc3RyID09PSAnc3RyaW5nJyA/IEpTT04ucGFyc2Uoc3RyKSA6IHVuZGVmaW5lZDsKICAgIHJldHVybiBpc0xvZ2luSW5mbyhvYmopID8gb2JqIDogdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHNhdmVMb2dpbkluZm8oaW5mbykgewogICAgY29uc3QgeyBvcmlnaW4gIH0gPSBpbmZvOwogICAgbG9jYWxTdG9yYWdlLnNldEl0ZW0oY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pLCBKU09OLnN0cmluZ2lmeShpbmZvKSk7Cn0KZnVuY3Rpb24gZGVsZXRlTG9naW5JbmZvKG9yaWdpbikgewogICAgbG9jYWxTdG9yYWdlLnJlbW92ZUl0ZW0oY29tcHV0ZUxvZ2luSW5mb0xvY2FsU3RvcmFnZUtleShvcmlnaW4pKTsKfQphc3luYyBmdW5jdGlvbiBjb21wdXRlTWFzdG9kb25JZEZvclVybChyZXBseVRvVXJsLCBmZXRjaGVyKSB7CiAgICBjb25zdCB7IHBhdGhuYW1lICB9ID0gbmV3IFVSTChyZXBseVRvVXJsKTsKICAgIGNvbnN0IG0gPSAvXlwvLio/XC8oXGQrKSQvLmV4ZWMocGF0aG5hbWUpOwogICAgaWYgKG0pIHJldHVybiBtWzFdOwogICAgaWYgKC9eLio/XC9vYmplY3RzXC9bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXsxMn0kLy50ZXN0KG5ldyBVUkwocmVwbHlUb1VybCkucGF0aG5hbWUpKSB7CiAgICAgICAgY29uc3QgcmVzID0gYXdhaXQgZmV0Y2hlcihyZXBseVRvVXJsLCB7CiAgICAgICAgICAgIGFjY2VwdDogJ3RleHQvaHRtbCcKICAgICAgICB9KTsKICAgICAgICBpZiAocmVzLnN0YXR1cyAhPT0gMjAwKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBzdGF0dXMgJHtyZXMuc3RhdHVzfSwgZXhwZWN0ZWQgMjAwIGZvciAke3JlcGx5VG9Vcmx9YCk7CiAgICAgICAgY29uc3QgbTIgPSAvXlwvLio/XC8oW2EtekEtWjAtOV0rKSQvLmV4ZWMobmV3IFVSTChyZXMudXJsKS5wYXRobmFtZSk7CiAgICAgICAgaWYgKG0yKSByZXR1cm4gbTJbMV07CiAgICB9CiAgICB0aHJvdyBuZXcgRXJyb3IoYGNvbXB1dGVNYXN0b2RvbklkRm9yVXJsOiB1bmFibGUgdG8gY29tcHV0ZSBmb3IgJHtyZXBseVRvVXJsfWApOwp9CmZ1bmN0aW9uIGlzTG9naW5JbmZvKG9iaikgewogICAgcmV0dXJuIGlzT2JqZWN0KG9iaikgJiYgdHlwZW9mIG9iai5vcmlnaW4gPT09ICdzdHJpbmcnICYmIGlzT2F1dGhPYnRhaW5Ub2tlblJlc3BvbnNlKG9iai50b2tlblJlc3BvbnNlKTsKfQpjb25zdCBDSVJDVUxBUl9QUk9HUkVTU19DU1MgPSBjc3NgCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgIC1tb3otYXBwZWFyYW5jZTogbm9uZTsKICAgIGFwcGVhcmFuY2U6IG5vbmU7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBub25lOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgcGFkZGluZzogMC4yNWVtOwogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgY29sb3I6IHZhcigtLXB1cmUtbWF0ZXJpYWwtcHJpbWFyeS1yZ2IsIHJnYigzMywgMTUwLCAyNDMpKTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgZm9udC1zaXplOiAxNnB4OwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6Oi13ZWJraXQtcHJvZ3Jlc3MtYmFyIHsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50Owp9CgovKiBJbmRldGVybWluYXRlICovCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGUgewogICAgLXdlYmtpdC1tYXNrLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpLCBsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKTsKICAgIG1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIDZzIGluZmluaXRlIGN1YmljLWJlemllcigwLjMsIDAuNiwgMSwgMSk7Cn0KCjotbXMtbGFuZyh4KSwgLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICBhbmltYXRpb246IG5vbmU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6OmJlZm9yZSwKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LXdlYmtpdC1wcm9ncmVzcy12YWx1ZSB7CiAgICBjb250ZW50OiAiIjsKICAgIGRpc3BsYXk6IGJsb2NrOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIG1hcmdpbi1ib3R0b206IDAuMjVlbTsKICAgIGJvcmRlcjogc29saWQgMC4yNWVtIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogY3VycmVudENvbG9yOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgd2lkdGg6IDEwMCUgIWltcG9ydGFudDsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbW96LXByb2dyZXNzLWJhciB7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJTsKICAgIGhlaWdodDogMTAwJTsKICAgIGJhY2tncm91bmQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgYW5pbWF0aW9uOiBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyAwLjc1cyBpbmZpbml0ZSBsaW5lYXIgYWx0ZXJuYXRlOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotbXMtZmlsbCB7CiAgICBhbmltYXRpb24tbmFtZTogLW1zLXJpbmc7Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMGRlZyk7CiAgICB9CiAgICAxMi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTgwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAyNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDYzMGRlZyk7CiAgICB9CiAgICAzNy41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoODEwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICA1MCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDEyNjBkZWcpOwogICAgfQogICAgNjIuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE0NDBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDc1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTg5MGRlZyk7CiAgICB9CiAgICA4Ny41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjA3MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjUyMGRlZyk7CiAgICB9Cn0KCkBrZXlmcmFtZXMgcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gewogICAgMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKC0zMGRlZyk7CiAgICB9CiAgICAyOS40JSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgMjkuNDElIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgfQogICAgNjQuNyUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IHRyYW5zcGFyZW50OwogICAgfQogICAgNjQuNzElIHsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMjVkZWcpOwogICAgfQp9CmA7CmZ1bmN0aW9uIGV4dGVybmFsaXplQW5jaG9yKGFuY2hvcikgewogICAgYW5jaG9yLnRhcmdldCA9ICdfYmxhbmsnOwogICAgYW5jaG9yLnJlbCA9ICdub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93JzsKfQpjb25zdCBDT01NRU5UU19IVE1MID0gaHRtbGAKPGRldGFpbHMgaWQ9ImNvbW1lbnRzLWRldGFpbHMiIG9wZW4+CiAgICA8c3VtbWFyeT5Db21tZW50cyBmb3IgPHNwYW4gaWQ9ImNvbW1lbnRzLXN1YmplY3QiPnN1YmplY3Q8L3NwYW4+PC9zdW1tYXJ5PgogICAgPG91dHB1dCBpZD0iY29tbWVudHMiPjwvb3V0cHV0Pgo8L2RldGFpbHM+CmA7CmNvbnN0IENPTU1FTlRTX0NTUyA9IGNzc2AKCiNjb21tZW50cy1kZXRhaWxzIHsKICAgIGRpc3BsYXk6IG5vbmU7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgbWF4LXdpZHRoOiAxMDAlOwogICAgb3ZlcmZsb3c6IGhpZGRlbjsKfQoKLmNvbW1lbnQgewogICAgZGlzcGxheTogZmxleDsKICAgIG1heC13aWR0aDogODBjaDsKICAgIGxpbmUtaGVpZ2h0OiAxLjU7Cn0KCi5jb21tZW50IC5pY29uIHsKICAgIHdpZHRoOiAzZW07CiAgICBoZWlnaHQ6IDNlbTsKICAgIGJvcmRlci1yYWRpdXM6IDAuNWVtOwogICAgbWFyZ2luOiAwLjc1ZW0gMWVtIDFlbSAwOwp9CgouY29tbWVudCAucmhzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgbWFyZ2luOiAwLjc1ZW0gMWVtIDAgMDsKICAgIGZsZXgtZ3JvdzogMTsKfQoKLmNvbW1lbnQgLmhlYWRlciB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAwLjVlbTsKICAgIGFsaWduLWl0ZW1zOiBiYXNlbGluZTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKLmNvbW1lbnQgLmhlYWRlciAudXJsIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKLmNvbW1lbnQgLnJocyBwIHsKICAgIG1hcmdpbi1ibG9jay1zdGFydDogMGVtOwogICAgbWFyZ2luLWJsb2NrLWVuZDogMGVtOwp9CgouY29tbWVudCBpbWcgewogICAgbWF4LXdpZHRoOiA4MGNoOwogICAgd2lkdGg6IGF1dG87CiAgICBoZWlnaHQ6IGF1dG87Cn0KCi5yZXBseSBmaWVsZHNldCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIGJvcmRlcjogc29saWQgMXB4ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9IAoKLnJlcGx5IHRleHRhcmVhIHsKICAgIHdpZHRoOiAxMDAlOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgYmFja2dyb3VuZC1jb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUuYmFja2dyb3VuZENvbG9ySGV4KX07CiAgICBtYXJnaW4tdG9wOiAwLjVyZW07Cn0KCi5yZXBseSBidXR0b24gewogICAgcGFkZGluZzogMC4yNXJlbSAycmVtOwogICAgYWxpZ24tc2VsZjogZmxleC1lbmQ7CiAgICBtYXJnaW46IDAuNXJlbSAwOwp9CgpgOwpmdW5jdGlvbiBpbml0Q29tbWVudHMoZG9jdW1lbnQsIHZtMSkgewogICAgY29uc3QgY29tbWVudHNEZXRhaWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzLWRldGFpbHMnKTsKICAgIGNvbnN0IGNvbW1lbnRzU3ViamVjdFNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtc3ViamVjdCcpOwogICAgY29uc3QgY29tbWVudHNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHJlc3VsdCA9IHZtMS5mZXRjaENvbW1lbnRzUmVzdWx0OwogICAgICAgIGNvbW1lbnRzRGV0YWlscy5zdHlsZS5kaXNwbGF5ID0gcmVzdWx0ID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgICAgICBjb21tZW50c1N1YmplY3RTcGFuLnRleHRDb250ZW50ID0gcmVzdWx0Py5zdWJqZWN0IHx8ICdzdWJqZWN0JzsKICAgICAgICBpZiAocmVzdWx0ICE9PSBfcmVuZGVyZWRSZXN1bHQpIHsKICAgICAgICAgICAgcmVuZGVyQ29tbWVudHMocmVzdWx0LCBjb21tZW50c091dHB1dCwgdm0xKTsKICAgICAgICAgICAgX3JlbmRlcmVkUmVzdWx0ID0gcmVzdWx0OwogICAgICAgIH0KICAgIH07Cn0KbGV0IF9yZW5kZXJlZFJlc3VsdDsKZnVuY3Rpb24gcmVuZGVyQ29tbWVudHMocmVzdWx0LCBjb21tZW50c091dHB1dCwgdm0yKSB7CiAgICB3aGlsZShjb21tZW50c091dHB1dC5maXJzdENoaWxkKWNvbW1lbnRzT3V0cHV0LnJlbW92ZUNoaWxkKGNvbW1lbnRzT3V0cHV0LmZpcnN0Q2hpbGQpOwogICAgaWYgKHJlc3VsdCkgcmVuZGVyTm9kZShyZXN1bHQucm9vdENvbW1lbnQsIHJlc3VsdC5jb21tZW50ZXJzLCBjb21tZW50c091dHB1dCwgMCwgdm0yKTsKfQpmdW5jdGlvbiByZW5kZXJOb2RlKGNvbW1lbnQsIGNvbW1lbnRlcnMsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCB2bTMpIHsKICAgIGNvbnN0IGNvbW1lbnRlciA9IGNvbW1lbnQuYXR0cmlidXRlZFRvID8gY29tbWVudGVycy5nZXQoY29tbWVudC5hdHRyaWJ1dGVkVG8pIDogdW5kZWZpbmVkOwogICAgY29uc3QgY29tbWVudERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgY29tbWVudERpdi5jbGFzc0xpc3QuYWRkKCdjb21tZW50Jyk7CiAgICBpZiAobGV2ZWwgPiAwKSBjb21tZW50RGl2LnN0eWxlLm1hcmdpbkxlZnQgPSBgJHtsZXZlbCAqIDR9ZW1gOwogICAgY29uc3QgaWNvbkltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgaWNvbkltZy5jbGFzc0xpc3QuYWRkKCdpY29uJyk7CiAgICBpY29uSW1nLnNyYyA9IGNvbW1lbnRlciAmJiBjb21tZW50ZXIuaWNvbiA/IGNvbW1lbnRlci5pY29uLnVybCA6ICcjJzsKICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQoaWNvbkltZyk7CiAgICBjb25zdCByaHNEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHJoc0Rpdi5jbGFzc0xpc3QuYWRkKCdyaHMnKTsKICAgIGNvbnN0IGhlYWRlckRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaGVhZGVyRGl2LmNsYXNzTGlzdC5hZGQoJ2hlYWRlcicpOwogICAgY29uc3QgYXR0cmlidXRlZFRvRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBhdHRyaWJ1dGVkVG9EaXYuY2xhc3NMaXN0LmFkZCgnYXR0cmlidXRlZC10bycpOwogICAgaWYgKGNvbW1lbnRlcikgewogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gY29tbWVudGVyLnVybDsKICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgIGEudGV4dENvbnRlbnQgPSBjb21tZW50ZXIubmFtZSArICcgJyArIGNvbW1lbnRlci5mcVVzZXJuYW1lOwogICAgICAgIGF0dHJpYnV0ZWRUb0Rpdi5hcHBlbmRDaGlsZChhKTsKICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cmlidXRlZFRvRGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbW1lbnQuYXR0cmlidXRlZFRvIHx8ICc8dW5rbm93bj4nKSk7CiAgICB9CiAgICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQoYXR0cmlidXRlZFRvRGl2KTsKICAgIGNvbnN0IGFnZVRleHQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb21tZW50LnB1Ymxpc2hlZCA/IGNvbXB1dGVBZ2UobmV3IERhdGUoY29tbWVudC5wdWJsaXNoZWQpKSA6ICcnKTsKICAgIGlmIChjb21tZW50LnVybCkgewogICAgICAgIGNvbnN0IGFnZUFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhZ2VBbmNob3IuY2xhc3NMaXN0LmFkZCgndXJsJyk7CiAgICAgICAgYWdlQW5jaG9yLmhyZWYgPSBjb21tZW50LnVybDsKICAgICAgICBleHRlcm5hbGl6ZUFuY2hvcihhZ2VBbmNob3IpOwogICAgICAgIGFnZUFuY2hvci5hcHBlbmRDaGlsZChhZ2VUZXh0KTsKICAgICAgICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQoYWdlQW5jaG9yKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGFnZVRleHQpOwogICAgfQogICAgcmhzRGl2LmFwcGVuZENoaWxkKGhlYWRlckRpdik7CiAgICBjb25zdCBjb250ZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IGNvbW1lbnQuY29udGVudDsKICAgIGNvbnRlbnREaXYucXVlcnlTZWxlY3RvckFsbCgnYScpLmZvckVhY2goZXh0ZXJuYWxpemVBbmNob3IpOwogICAgcmhzRGl2LmFwcGVuZENoaWxkKGNvbnRlbnREaXYpOwogICAgZm9yIChjb25zdCBhdHRhY2htZW50IG9mIGNvbW1lbnQuYXR0YWNobWVudHMpewogICAgICAgIGNvbnN0IGF0dGFjaG1lbnREZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGV0YWlscycpOwogICAgICAgIGNvbnN0IHN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICAgICAgc3VtbWFyeS50ZXh0Q29udGVudCA9IGBBdHRhY2htZW50ICgke2F0dGFjaG1lbnQubWVkaWFUeXBlfSlgOwogICAgICAgIGF0dGFjaG1lbnREZXRhaWxzLmFwcGVuZENoaWxkKHN1bW1hcnkpOwogICAgICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgICAgIGltZy5zcmMgPSBhdHRhY2htZW50LnVybDsKICAgICAgICBpZiAoYXR0YWNobWVudC53aWR0aCAmJiBhdHRhY2htZW50LmhlaWdodCkgewogICAgICAgICAgICBpbWcud2lkdGggPSBhdHRhY2htZW50LndpZHRoOwogICAgICAgICAgICBpbWcuaGVpZ2h0ID0gYXR0YWNobWVudC5oZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGF0dGFjaG1lbnREZXRhaWxzLmFwcGVuZENoaWxkKGltZyk7CiAgICAgICAgcmhzRGl2LmFwcGVuZENoaWxkKGF0dGFjaG1lbnREZXRhaWxzKTsKICAgIH0KICAgIGlmIChjb21tZW50LnVybCkgewogICAgICAgIGNvbnN0IHJlcGx5VG9VcmwgPSBjb21tZW50LnVybDsKICAgICAgICBjb25zdCByZXBseURpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJlcGx5RGl2LmNsYXNzTmFtZSA9ICdyZXBseSc7CiAgICAgICAgY29uc3QgcmVwbHlBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgcmVwbHlBbmNob3IudGV4dENvbnRlbnQgPSAiUmVwbHkg4oaSIjsKICAgICAgICByZXBseUFuY2hvci5ocmVmID0gJyMnOwogICAgICAgIHJlcGx5RGl2LmFwcGVuZENoaWxkKHJlcGx5QW5jaG9yKTsKICAgICAgICBjb25zdCByZXBseUZpZWxkc2V0Q29udGFpbmVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgcmVwbHlEaXYuYXBwZW5kQ2hpbGQocmVwbHlGaWVsZHNldENvbnRhaW5lcik7CiAgICAgICAgcmVwbHlBbmNob3Iub25jbGljayA9IChlKT0+ewogICAgICAgICAgICBlLnByZXZlbnREZWZhdWx0KCk7CiAgICAgICAgICAgIHRvZ2dsZVJlcGx5Qm94KHJlcGx5QW5jaG9yLCByZXBseUZpZWxkc2V0Q29udGFpbmVyLCByZXBseVRvVXJsLCB2bTMpOwogICAgICAgIH07CiAgICAgICAgcmhzRGl2LmFwcGVuZENoaWxkKHJlcGx5RGl2KTsKICAgIH0KICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQocmhzRGl2KTsKICAgIGNvbnRhaW5lckVsZW1lbnQuYXBwZW5kQ2hpbGQoY29tbWVudERpdik7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIGNvbW1lbnQucmVwbGllcyl7CiAgICAgICAgcmVuZGVyTm9kZShyZXBseSwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwgKyAxLCB2bTMpOwogICAgfQp9CmZ1bmN0aW9uIGNvbXB1dGVBZ2UoZGF0ZSkgewogICAgY29uc3QgbWlsbGlzID0gRGF0ZS5ub3coKSAtIGRhdGUuZ2V0VGltZSgpOwogICAgY29uc3Qgc2Vjb25kcyA9IG1pbGxpcyAvIDEwMDA7CiAgICBjb25zdCBtaW51dGVzID0gc2Vjb25kcyAvIDYwOwogICAgaWYgKG1pbnV0ZXMgPCA2MCkgcmV0dXJuIGAke01hdGgubWF4KE1hdGguZmxvb3IobWludXRlcyksIDEpfW1gOwogICAgY29uc3QgaG91cnMgPSBtaW51dGVzIC8gNjA7CiAgICBpZiAoaG91cnMgPCAyNCkgcmV0dXJuIGAke01hdGguZmxvb3IoaG91cnMpfWhgOwogICAgY29uc3QgZGF5cyA9IGhvdXJzIC8gMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5mbG9vcihkYXlzKX1kYDsKfQpmdW5jdGlvbiB0b2dnbGVSZXBseUJveChhbmNob3IsIGZpZWxkc2V0Q29udGFpbmVyLCByZXBseVRvVXJsLCB2bTQpIHsKICAgIGlmIChhbmNob3IudGV4dENvbnRlbnQ/LnN0YXJ0c1dpdGgoJ1JlcGx5JykpIHsKICAgICAgICBhbmNob3IudGV4dENvbnRlbnQgPSAnQ2FuY2VsIOKFuSc7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUkVQTFlfQk9YLCBmaWVsZHNldENvbnRhaW5lcik7CiAgICAgICAgY29uc3QgbG9naW5BbmNob3IgPSBmaWVsZHNldENvbnRhaW5lci5nZXRFbGVtZW50c0J5VGFnTmFtZSgnYScpWzBdOwogICAgICAgIGNvbnN0IHRleHRhcmVhID0gZmllbGRzZXRDb250YWluZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ3RleHRhcmVhJylbMF07CiAgICAgICAgY29uc3QgYnV0dG9uID0gZmllbGRzZXRDb250YWluZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2J1dHRvbicpWzBdOwogICAgICAgIGNvbnN0IG91dHB1dCA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdvdXRwdXQnKVswXTsKICAgICAgICBjb25zdCBvdXRwdXRBbmNob3IgPSBvdXRwdXQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2EnKVswXTsKICAgICAgICBjb25zdCBvcmlnaW4gPSBuZXcgVVJMKHJlcGx5VG9VcmwpLm9yaWdpbjsKICAgICAgICBvdXRwdXRBbmNob3IudGV4dENvbnRlbnQgPSBvcmlnaW47CiAgICAgICAgbGV0IHNlbnQgPSBmYWxzZTsKICAgICAgICBsZXQgbmV3UmVwbHlVcmw7CiAgICAgICAgY29uc3QgdXBkYXRlID0gKCk9PnsKICAgICAgICAgICAgY29uc3QgbG9nZ2VkSW4gPSB2bTQuaXNMb2dnZWRJbihvcmlnaW4pOwogICAgICAgICAgICBsb2dpbkFuY2hvci50ZXh0Q29udGVudCA9IGxvZ2dlZEluID8gYFNpZ24gb3V0IG9mICR7b3JpZ2lufWAgOiBgU2lnbiBpbiBhdCAke29yaWdpbn0uLi5gOwogICAgICAgICAgICBsb2dpbkFuY2hvci5zdHlsZS5kaXNwbGF5ID0gIXNlbnQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS5kaXNwbGF5ID0gYnV0dG9uLnN0eWxlLmRpc3BsYXkgPSBsb2dnZWRJbiAmJiAhc2VudCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIG91dHB1dC5zdHlsZS5kaXNwbGF5ID0gc2VudCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgICAgIG91dHB1dEFuY2hvci5ocmVmID0gbmV3UmVwbHlVcmwgfHwgb3JpZ2luOwogICAgICAgIH07CiAgICAgICAgbG9naW5BbmNob3Iub25jbGljayA9IChlMSk9PnsKICAgICAgICAgICAgZTEucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgbG9nZ2VkSW4gPSB2bTQuaXNMb2dnZWRJbihvcmlnaW4pOwogICAgICAgICAgICBpZiAobG9nZ2VkSW4pIHsKICAgICAgICAgICAgICAgIHZtNC5leHBpcmVMb2dpbihvcmlnaW4pOwogICAgICAgICAgICAgICAgdXBkYXRlKCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCB3ID0gd2luZG93Lm9wZW4oYC9sb2dpbj9vcmlnaW49JHtlbmNvZGVVUklDb21wb25lbnQob3JpZ2luKX1gLCAnbG9naW4nKTsKICAgICAgICAgICAgICAgIGlmICh3KSB7CiAgICAgICAgICAgICAgICAgICAgZ2xvYmFsVGhpcy5vbm1lc3NhZ2UgPSAoZSk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgeyBkYXRhICB9ID0gZTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29ubWVzc2FnZScsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGRhdGEub3JpZ2luID09PSAnc3RyaW5nJyAmJiBpc09hdXRoT2J0YWluVG9rZW5SZXNwb25zZShkYXRhLnRva2VuUmVzcG9uc2UpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2bTQuYWNjZXB0TG9naW4oZGF0YS5vcmlnaW4sIGRhdGEudG9rZW5SZXNwb25zZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGUoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHcuY2xvc2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGJ1dHRvbi5vbmNsaWNrID0gYXN5bmMgKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgbmV3UmVwbHlVcmwgPSBhd2FpdCB2bTQuc2VuZFJlcGx5KHRleHRhcmVhLnZhbHVlLnRyaW0oKSwgcmVwbHlUb1VybCk7CiAgICAgICAgICAgIHNlbnQgPSB0cnVlOwogICAgICAgICAgICBhbmNob3IudGV4dENvbnRlbnQgPSAnQ2xvc2Ug4oW5JzsKICAgICAgICAgICAgdXBkYXRlKCk7CiAgICAgICAgfTsKICAgICAgICB1cGRhdGUoKTsKICAgICAgICB0ZXh0YXJlYS5mb2N1cygpOwogICAgfSBlbHNlIHsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcih1bmRlZmluZWQsIGZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICBhbmNob3IudGV4dENvbnRlbnQgPSAiUmVwbHkg4oaSIjsKICAgIH0KfQpjb25zdCBSRVBMWV9CT1ggPSBodG1sYAo8ZmllbGRzZXQ+CiAgICA8bGVnZW5kPlJlcGx5PC9sZWdlbmQ+CiAgICA8YSBocmVmPSIjIj5Mb2dpbiB0byAuLi48L2E+CiAgICA8dGV4dGFyZWEgdHlwZT0idGV4dCIgbmFtZT0iY29udGVudCIgcm93cz0iNCIgcGxhY2Vob2xkZXI9IllvdXIgcmVwbHkuLi4iPjwvdGV4dGFyZWE+CiAgICA8YnV0dG9uIHR5cGU9InN1Ym1pdCI+U2VuZDwvYnV0dG9uPgogICAgPG91dHB1dD5SZXBseSBzZW50ISBJdCBtYXkgdGFrZSBhIHdoaWxlIHRvIGFwcGVhciBoZXJlLCBidXQgeW91IGNhbiB2aWV3IGl0IG92ZXIgYXQgPGEgaHJlZj0iIyIgdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyI+KG9yaWdpbik8L2E+PC9vdXRwdXQ+CjwvZmllbGRzZXQ+CmA7CmNvbnN0IElORk9fSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTEgN2gydjJoLTJ6bTAgNGgydjZoLTJ6bTEtOUM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6Ii8+PC9zdmc+YDsKY29uc3QgV0FSTklOR19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0xMiA1Ljk5TDE5LjUzIDE5SDQuNDdMMTIgNS45OU0yLjc0IDE4Yy0uNzcgMS4zMy4xOSAzIDEuNzMgM2gxNS4wNmMxLjU0IDAgMi41LTEuNjcgMS43My0zTDEzLjczIDQuOTljLS43Ny0xLjMzLTIuNjktMS4zMy0zLjQ2IDBMMi43NCAxOHpNMTEgMTF2MmMwIC41NS40NSAxIDEgMXMxLS40NSAxLTF2LTJjMC0uNTUtLjQ1LTEtMS0xcy0xIC40NS0xIDF6bTAgNWgydjJoLTJ6Ii8+PC9zdmc+YDsKY29uc3QgRVJST1JfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMjAuNzEgNy45OEwxNi4wMyAzLjNjLS4xOS0uMTktLjQ1LS4zLS43MS0uM0g4LjY4Yy0uMjYgMC0uNTIuMTEtLjcuMjlMMy4yOSA3Ljk4Yy0uMTguMTgtLjI5LjQ0LS4yOS43djYuNjNjMCAuMjcuMTEuNTIuMjkuNzFsNC42OCA0LjY4Yy4xOS4xOS40NS4zLjcxLjNoNi42M2MuMjcgMCAuNTItLjExLjcxLS4yOWw0LjY4LTQuNjhjLjE5LS4xOS4yOS0uNDQuMjktLjcxVjguNjhjLjAxLS4yNi0uMS0uNTItLjI4LS43ek0xOSAxNC45TDE0LjkgMTlIOS4xTDUgMTQuOVY5LjFMOS4xIDVoNS44TDE5IDkuMXY1Ljh6Ii8+PGNpcmNsZSBjeD0iMTIiIGN5PSIxNiIgcj0iMSIvPjxwYXRoIGQ9Ik0xMiA3Yy0uNTUgMC0xIC40NS0xIDF2NWMwIC41NS40NSAxIDEgMXMxLS40NSAxLTFWOGMwLS41NS0uNDUtMS0xLTF6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48cGF0aCBkPSJNMCAwaDI0djI0SDBWMHoiIGZpbGw9Im5vbmUiLz48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMCAxOGMtNC40MSAwLTgtMy41OS04LThzMy41OS04IDgtOCA4IDMuNTkgOCA4LTMuNTkgOC04IDh6bTMuODgtMTEuNzFMMTAgMTQuMTdsLTEuODgtMS44OGMtLjM5LS4zOS0xLjAyLS4zOS0xLjQxIDAtLjM5LjM5LS4zOSAxLjAyIDAgMS40MWwyLjU5IDIuNTljLjM5LjM5IDEuMDIuMzkgMS40MSAwTDE3LjMgOS43Yy4zOS0uMzkuMzktMS4wMiAwLTEuNDEtLjM5LS4zOS0xLjAzLS4zOS0xLjQyIDB6Ii8+PC9zdmc+YDsKY29uc3QgQ0hFQ0tMSVNUX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI0IDI0IiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxnPjxyZWN0IGZpbGw9Im5vbmUiIGhlaWdodD0iMjQiIHdpZHRoPSIyNCIvPjwvZz48Zz48Zz48cGF0aCBkPSJNNSw1aDJ2MWMwLDEuMSwwLjksMiwyLDJoNmMxLjEsMCwyLTAuOSwyLTJWNWgydjVoMlY1YzAtMS4xLTAuOS0yLTItMmgtNC4xOEMxNC40LDEuODQsMTMuMywxLDEyLDFTOS42LDEuODQsOS4xOCwzSDUgQzMuOSwzLDMsMy45LDMsNXYxNGMwLDEuMSwwLjksMiwyLDJoNnYtMkg1VjV6IE0xMiwzYzAuNTUsMCwxLDAuNDUsMSwxcy0wLjQ1LDEtMSwxcy0xLTAuNDUtMS0xUzExLjQ1LDMsMTIsM3oiLz48cGF0aCBkPSJNMjEuNzUsMTIuMjVjLTAuNDEtMC40MS0xLjA5LTAuNDEtMS41LDBMMTUuNTEsMTdsLTIuMjYtMi4yNWMtMC40MS0wLjQxLTEuMDgtMC40MS0xLjUsMGwwLDBjLTAuNDEsMC40MS0wLjQxLDEuMDksMCwxLjUgbDMuMDUsMy4wNGMwLjM5LDAuMzksMS4wMiwwLjM5LDEuNDEsMGw1LjUzLTUuNTRDMjIuMTYsMTMuMzQsMjIuMTYsMTIuNjYsMjEuNzUsMTIuMjV6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBTUVVBUkVfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik0zLDN2MThoMThWM0gzeiBNMTksMTlINVY1aDE0VjE5eiIvPjwvZz48L2c+PC9zdmc+YDsKY29uc3QgRk9STV9IVE1MID0gaHRtbGAKPGhlYWRlcj4ke0NIRUNLTElTVF9JQ09OfTxoMT5MaXZld2lyZSBQb2RjYXN0IFZhbGlkYXRvciA8c3BhbiBpZD0idmVyc2lvbiI+djAuMjwvc3Bhbj48L2gxPjwvaGVhZGVyPgo8Zm9ybSBpZD0iZm9ybSI+CiAgICA8aW5wdXQgaWQ9InRleHQtaW5wdXQiIHR5cGU9InRleHQiIHBsYWNlaG9sZGVyPSJQb2RjYXN0IGZlZWQgdXJsLCBBY3Rpdml0eVB1YiB1cmwsIEFwcGxlIFBvZGNhc3RzIHVybCwgb3Igc2VhcmNoIHRleHQiIGF1dG9jb21wbGV0ZT0idXJsIiByZXF1aXJlZD4KICAgIDxidXR0b24gaWQ9InN1Ym1pdCIgdHlwZT0ic3VibWl0Ij5WYWxpZGF0ZTwvYnV0dG9uPgo8L2Zvcm0+CmA7CmNvbnN0IEZPUk1fQ1NTID0gY3NzYAoKaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwogICAgZ2FwOiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIG9wYWNpdHk6IDAuNzU7Cn0KCmhlYWRlciBoMSB7CiAgICBtYXJnaW46IDA7Cn0KCmhlYWRlciBzdmcgewogICAgdHJhbnNmb3JtOiBzY2FsZSgxLjUpOwogICAgZmlsbDogY3VycmVudENvbG9yOwp9CgojdmVyc2lvbiB7CiAgICBvcGFjaXR5OiAwLjI1Owp9CgojZm9ybSB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZ2FwOiAxcmVtOwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKfQoKLyoqIGlvcyByZXNldHMgKi8KQHN1cHBvcnRzICgtd2Via2l0LXRvdWNoLWNhbGxvdXQ6IG5vbmUpIHsKICAgIGlucHV0LCB0ZXh0YXJlYSwgYnV0dG9uIHsKICAgICAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CiAgICAgICAgYm9yZGVyLXJhZGl1czogMDsKICAgIH0KCiAgICBidXR0b24gewogICAgICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA2NTBweCkgewoKICAgIGhlYWRlciB7CiAgICAgICAgZm9udC1zaXplOiA2NiU7CiAgICAgICAgZ2FwOiAwLjVyZW07CiAgICB9CgogICAgaGVhZGVyIHN2ZyB7CiAgICAgICAgdHJhbnNmb3JtOiBzY2FsZSgxLjApOwogICAgfQoKICAgICNmb3JtIHsKICAgICAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgfQoKfQoKQG1lZGlhIG9ubHkgc2NyZWVuIGFuZCAobWF4LXdpZHRoOiA1MDBweCkgewoKICAgICN2ZXJzaW9uIHsKICAgICAgICBkaXNwbGF5OiBub25lOwogICAgfQoKfQoKI3RleHQtaW5wdXQgewogICAgZm9udC1zaXplOiAxcmVtOwogICAgZmxleC1ncm93OiAxOwogICAgcGFkZGluZzogMC41cmVtIDAuNXJlbTsKICAgIGJhY2tncm91bmQtY29sb3I6IGluaGVyaXQ7CiAgICBib3JkZXI6IHNvbGlkIDFweCB3aGl0ZTsKICAgIG91dGxpbmU6IG5vbmU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiN0ZXh0LWlucHV0OnJlYWQtb25seSB7CiAgICBvcGFjaXR5OiAwLjU7IAp9CgppbnB1dDotd2Via2l0LWF1dG9maWxsLCBpbnB1dDotd2Via2l0LWF1dG9maWxsOmZvY3VzIHsKICAgIHRyYW5zaXRpb246IGJhY2tncm91bmQtY29sb3IgNjAwMDAwcyAwcywgY29sb3IgNjAwMDAwcyAwczsKfQoKI2Zvcm0gYnV0dG9uIHsKICAgIHBhZGRpbmc6IDAuNXJlbSAxcmVtOwogICAgbWluLXdpZHRoOiA4cmVtOwp9CgpgOwpmdW5jdGlvbiBpbml0Rm9ybShkb2N1bWVudCwgdm01LCBzdGF0aWNEYXRhMSkgewogICAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtJyk7CiAgICBjb25zdCB0ZXh0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dC1pbnB1dCcpOwogICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Ym1pdCcpOwogICAgY29uc3QgdmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyc2lvbicpOwogICAgY29uc3QgdmVyc2lvbiA9IFsKICAgICAgICBzdGF0aWNEYXRhMS52ZXJzaW9uLAogICAgICAgIHN0YXRpY0RhdGExLnB1c2hJZAogICAgXS5tYXAoKHYpPT4odiB8fCAnJykudHJpbSgpCiAgICApLmZpbHRlcigodik9PnYubGVuZ3RoID4gMAogICAgKS5qb2luKCcuJyk7CiAgICB2ZXJzaW9uU3Bhbi50ZXh0Q29udGVudCA9IHN0YXRpY0RhdGExLnZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyAgfSA9IG5ldyBVUkwoZG9jdW1lbnQuVVJMKTsKICAgIGNvbnN0IHZhbGlkYXRlMSA9IHNlYXJjaFBhcmFtcy5nZXQoJ3ZhbGlkYXRlJykgfHwgdW5kZWZpbmVkOwogICAgY29uc3QgaW5wdXQgPSBzZWFyY2hQYXJhbXMuZ2V0KCdpbnB1dCcpIHx8IHVuZGVmaW5lZDsKICAgIGNvbnN0IG5vY29tbWVudHMgPSBzZWFyY2hQYXJhbXMuaGFzKCdub2NvbW1lbnRzJyk7CiAgICBjb25zdCBzdGFydFZhbGlkYXRpb24gPSAoKT0+dm01LnN0YXJ0VmFsaWRhdGlvbih0ZXh0SW5wdXQudmFsdWUsIHsKICAgICAgICAgICAgdmFsaWRhdGVDb21tZW50czogIW5vY29tbWVudHMsCiAgICAgICAgICAgIHVzZXJBZ2VudDogbmF2aWdhdG9yLnVzZXJBZ2VudAogICAgICAgIH0pCiAgICA7CiAgICBmb3JtLm9uc3VibWl0ID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGlmICh2bTUudmFsaWRhdGluZykgewogICAgICAgICAgICB2bTUuY2FuY2VsVmFsaWRhdGlvbigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHN0YXJ0VmFsaWRhdGlvbigpOwogICAgICAgIH0KICAgIH07CiAgICBpZiAodmFsaWRhdGUxKSB7CiAgICAgICAgdGV4dElucHV0LnZhbHVlID0gdmFsaWRhdGUxOwogICAgICAgIHNldFRpbWVvdXQoc3RhcnRWYWxpZGF0aW9uLCAwKTsKICAgIH0gZWxzZSBpZiAoaW5wdXQpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSBpbnB1dDsKICAgIH0KICAgIHRleHRJbnB1dC5mb2N1cygpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSB0ZXh0SW5wdXQuZGlzYWJsZWQ7CiAgICAgICAgdGV4dElucHV0LmRpc2FibGVkID0gdm01LnZhbGlkYXRpbmc7CiAgICAgICAgdGV4dElucHV0LnJlYWRPbmx5ID0gdm01LnZhbGlkYXRpbmc7CiAgICAgICAgc3VibWl0QnV0dG9uLnRleHRDb250ZW50ID0gdm01LnZhbGlkYXRpbmcgPyAnQ2FuY2VsJyA6ICdWYWxpZGF0ZSc7CiAgICAgICAgaWYgKHdhc0Rpc2FibGVkICYmICF0ZXh0SW5wdXQuZGlzYWJsZWQpIHsKICAgICAgICAgICAgdGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNRVNTQUdFU19IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ibWVzc2FnZXMiPjwvb3V0cHV0PgpgOwpjb25zdCBNRVNTQUdFU19DU1MgPSBjc3NgCgojbWVzc2FnZXMgewogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDJyZW0gYXV0bzsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07Cn0KCiNtZXNzYWdlcyA+IGRpdiwgI21lc3NhZ2VzID4gYSB7CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwp9CgojbWVzc2FnZXMgc3ZnIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC43NSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiNtZXNzYWdlcyA+IGRpdi5pbmZvIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKI21lc3NhZ2VzID4gZGl2Lmdvb2QgewogICAgY29sb3I6ICM0M2EwNDc7Cn0KI21lc3NhZ2VzID4gZGl2Lndhcm5pbmcgewogICAgY29sb3I6ICNlNjUxMDA7Cn0KCiNtZXNzYWdlcyA+IGRpdi5lcnJvciB7CiAgICBjb2xvcjogI2I3MWMxYzsKfQoKI21lc3NhZ2VzID4gZGl2LnJ1bm5pbmcsICNtZXNzYWdlcyA+IGRpdi5kb25lIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI21lc3NhZ2VzIC5pY29uIHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgd2lkdGg6IDI0cHg7CiAgICBoZWlnaHQ6IDI0cHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgojbWVzc2FnZXMgLm1lc3NhZ2UgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCiNtZXNzYWdlcyAudXJsIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKfQoKI21lc3NhZ2VzIHByb2dyZXNzIHsKICAgIGZvbnQtc2l6ZTogMC4zNXJlbTsKfQoKI21lc3NhZ2VzIC5yZWZlcmVuY2UgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgbWFyZ2luLWxlZnQ6IDAuMjVyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRNZXNzYWdlcyhkb2N1bWVudCwgdm02KSB7CiAgICBjb25zdCBtZXNzYWdlc091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZXNzYWdlcycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoTUVTU0FHRV9IVE1MKHZtNiksIG1lc3NhZ2VzT3V0cHV0KTsKICAgIH07Cn0KY29uc3QgTUVTU0FHRV9IVE1MID0gKHZtNyk9Pmh0bWxgCiAgICAke3ZtNy5tZXNzYWdlcy5maWx0ZXIoZmlsdGVyRHVwbGljYXRlcygpKS5tYXAoKG1lc3NhZ2UpPT5odG1sYAogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBpY29uIj4ke2ljb24obWVzc2FnZS50eXBlKX08L2Rpdj4KICAgICAgICA8ZGl2IGNsYXNzPSIke21lc3NhZ2UudHlwZX0gbWVzc2FnZSI+JHttZXNzYWdlLnRleHR9JHtSRUZFUkVOQ0VfSFRNTChtZXNzYWdlLnJlZmVyZW5jZSl9PC9kaXY+CiAgICAgICAgJHtBTkNIT1JfSFRNTChtZXNzYWdlLnVybCl9YAogICAgKX1gCjsKY29uc3QgUkVGRVJFTkNFX0hUTUwgPSAocmVmZXJlbmNlKT0+cmVmZXJlbmNlID8gaHRtbGA8YSBjbGFzcz0icmVmZXJlbmNlIiBocmVmPSR7cmVmZXJlbmNlLmhyZWZ9IHRhcmdldD0iX2JsYW5rIiByZWw9Im5vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3ciPlske3JlZmVyZW5jZS5ydWxlc2V0fV08L2E+YCA6IHVuZGVmaW5lZAo7CmNvbnN0IEFOQ0hPUl9IVE1MID0gKHVybCk9PnVybCA/IGh0bWxgPGEgaHJlZj0ke3VybH0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyIgY2xhc3M9InVybCI+JHt1cmx9PC9hPmAgOiB1bmRlZmluZWQKOwpmdW5jdGlvbiBpY29uKHR5cGUpIHsKICAgIHJldHVybiB0eXBlID09PSAncnVubmluZycgPyBodG1sYDxwcm9ncmVzcyBjbGFzcz0icHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciI+PC9wcm9ncmVzcz5gIDogdHlwZSA9PT0gJ2RvbmUnID8gQ0hFQ0tfSUNPTiA6IHR5cGUgPT09ICdlcnJvcicgPyBFUlJPUl9JQ09OIDogdHlwZSA9PT0gJ3dhcm5pbmcnID8gV0FSTklOR19JQ09OIDogdHlwZSA9PT0gJ2dvb2QnID8gQ0hFQ0tfSUNPTiA6IElORk9fSUNPTjsKfQpmdW5jdGlvbiBmaWx0ZXJEdXBsaWNhdGVzKCkgewogICAgY29uc3QgdGFnVXJscyA9IG5ldyBTZXQoKTsKICAgIHJldHVybiAobWVzc2FnZSk9PnsKICAgICAgICBjb25zdCB7IHRhZyAsIHVybCAgfSA9IG1lc3NhZ2U7CiAgICAgICAgaWYgKHRhZyAmJiB1cmwpIHsKICAgICAgICAgICAgY29uc3QgdGFnVXJsID0gYCR7dGFnfXwke3VybH1gOwogICAgICAgICAgICBpZiAodGFnVXJscy5oYXModGFnVXJsKSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB0YWdVcmxzLmFkZCh0YWdVcmwpOwogICAgICAgICAgICByZXR1cm4gdHJ1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Owp9CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJzZWFyY2gtcmVzdWx0cyI+PC9vdXRwdXQ+CmA7CmNvbnN0IFNFQVJDSF9SRVNVTFRTX0NTUyA9IGNzc2AKCiNzZWFyY2gtcmVzdWx0cyB7CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgZGlzcGxheTogbm9uZTsKfQoKI3NlYXJjaC1yZXN1bHRzID4gZGl2IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNXJlbTsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwogICAgbWFyZ2luLWJvdHRvbTogMC43NXJlbTsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKI3NlYXJjaC1yZXN1bHRzIC5pY29uLCAjc2VhcmNoLXJlc3VsdHMgaW1nIHsKICAgIHdpZHRoOiAxLjVyZW07CiAgICBoZWlnaHQ6IDEuNXJlbTsKfQoKI3NlYXJjaC1yZXN1bHRzIC50aXRsZSB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiNzZWFyY2gtcmVzdWx0cyAuYXV0aG9yIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKYDsKZnVuY3Rpb24gaW5pdFNlYXJjaFJlc3VsdHMoZG9jdW1lbnQsIHZtOCkgewogICAgY29uc3Qgc2VhcmNoUmVzdWx0c091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzZWFyY2gtcmVzdWx0cycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIoUkVTVUxUU19IVE1MKHZtOCksIHNlYXJjaFJlc3VsdHNPdXRwdXQpOwogICAgICAgIHNlYXJjaFJlc3VsdHNPdXRwdXQuc3R5bGUuZGlzcGxheSA9IHZtOC5pc1NlYXJjaCA/ICdibG9jaycgOiAnbm9uZSc7CiAgICB9Owp9CmNvbnN0IFJFU1VMVFNfSFRNTCA9ICh2bTkpPT5odG1sYAogICAgJHt2bTkuc2VhcmNoUmVzdWx0cy5tYXAoKHJlc3VsdCk9Pmh0bWxgPGRpdiBjbGFzcz0ic2VhcmNoLXJlc3VsdCIgQGNsaWNrPSIke3NlbGVjdFJlc3VsdCh2bTksIHJlc3VsdC51cmwpfSI+PGRpdiBjbGFzcz0iaWNvbiI+JHtJTUFHRV9IVE1MKHJlc3VsdC5hcnR3b3JrKX08L2Rpdj48ZGl2IGNsYXNzPSJ0aXRsZSI+JHtyZXN1bHQudGl0bGV9PC9kaXY+PGRpdiBjbGFzcz0iYXV0aG9yIj4ke3Jlc3VsdC5hdXRob3J9PC9kaXY+PC9kaXY+YAogICAgKX1gCjsKY29uc3QgSU1BR0VfSFRNTCA9IChhcnR3b3JrKT0+YXJ0d29yayA/IGh0bWxgPGltZyBzcmM9JHthcnR3b3JrfT5gIDogU1FVQVJFX0lDT04KOwpmdW5jdGlvbiBzZWxlY3RSZXN1bHQodm0xMCwgdXJsKSB7CiAgICByZXR1cm4gKCk9PnZtMTAuY29udGludWVXaXRoKHVybCkKICAgIDsKfQpjb25zdCBYTUxfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InhtbCI+PC9vdXRwdXQ+CmA7CmNvbnN0IFhNTF9DU1MgPSBjc3NgCiN4bWwgewogICAgZm9udC1mYW1pbHk6ICR7dW5zYWZlQ1NTKFRoZW1lLm1vbm9zcGFjZUZvbnRGYW1pbHkpfTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGxpbmUtaGVpZ2h0OiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9OwogICAgb3ZlcmZsb3ctd3JhcDogYnJlYWstd29yZDsKICAgIGxpbmUtaGVpZ2h0OiAxLjQ7Cn0KCiN4bWwgLnJvb3QgewogICAgZm9udC1mYW1pbHk6ICR7dW5zYWZlQ1NTKFRoZW1lLnNhbnNTZXJpZkZvbnRGYW1pbHkpfTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIGxpbmUtaGVpZ2h0OiAyOwp9CgojeG1sIC5jb250ZW50IHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3htbCAucG9kY2FzdCB7CiAgICBjb2xvcjogI2FiNDdiYzsKfQoKI3htbCAuaW5kZW50IHsKICAgIG1hcmdpbi1sZWZ0OiAwLjc1cmVtOwp9CgojeG1sIC5pbmRlbnQyIHsKICAgIG1hcmdpbi1sZWZ0OiAxLjVyZW07Cn0KCnN1bW1hcnkuZW1wdHkgeyBsaXN0LXN0eWxlOiBub25lOyBjdXJzb3I6IHRleHQ7IH0Kc3VtbWFyeS5lbXB0eTo6LXdlYmtpdC1kZXRhaWxzLW1hcmtlciB7IGRpc3BsYXk6IG5vbmU7IH0KCiN4bWwgYXVkaW8gewogICAgbWFyZ2luOiAwLjVyZW0gMXJlbTsKfQpgOwpmdW5jdGlvbiBpbml0WG1sKGRvY3VtZW50LCB2bTExKSB7CiAgICBjb25zdCB4bWxPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneG1sJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB4bWwgPSB2bTExLnhtbDsKICAgICAgICBpZiAoeG1sICE9PSBfcmVuZGVyZWRYbWwpIHsKICAgICAgICAgICAgcmVuZGVyWG1sKHhtbCwgeG1sT3V0cHV0LCB2bTExLnhtbFN1bW1hcnlUZXh0KTsKICAgICAgICAgICAgX3JlbmRlcmVkWG1sID0geG1sOwogICAgICAgIH0KICAgIH07Cn0KbGV0IF9yZW5kZXJlZFhtbDsKZnVuY3Rpb24gcmVuZGVyWG1sKHhtbCwgeG1sT3V0cHV0LCB4bWxTdW1tYXJ5VGV4dCkgewogICAgd2hpbGUoeG1sT3V0cHV0LmZpcnN0Q2hpbGQpeG1sT3V0cHV0LnJlbW92ZUNoaWxkKHhtbE91dHB1dC5maXJzdENoaWxkKTsKICAgIGlmICh4bWwpIHJlbmRlck5vZGUxKHhtbCwgeG1sT3V0cHV0LCAwLCBuZXcgU2V0KCksIHVuZGVmaW5lZCwgeG1sU3VtbWFyeVRleHQpOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUxKG5vZGUsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCBjb250ZXh0LCBpdGVtTnVtYmVyLCB4bWxTdW1tYXJ5VGV4dCkgewogICAgY29uc3QgeyBhdHRzICB9ID0gbm9kZTsKICAgIGNvbnN0IGRldGFpbHMgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkZXRhaWxzJyk7CiAgICBjb25zdCB0ZXh0ID0gbm9kZS52YWwgfHwgJyc7CiAgICBkZXRhaWxzLm9wZW4gPSAhY29udGV4dC5oYXMoJ2ZvdW5kLWl0ZW0nKSB8fCB0ZXh0Lmxlbmd0aCA+IDA7CiAgICBpZiAobGV2ZWwgPiAwKSBkZXRhaWxzLmNsYXNzTGlzdC5hZGQoJ2luZGVudCcpOwogICAgY29uc3Qgc3VtbWFyeSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N1bW1hcnknKTsKICAgIGlmIChsZXZlbCA9PT0gMCkgewogICAgICAgIHJlbmRlclRleHRQaWVjZXMoc3VtbWFyeSwgeG1sU3VtbWFyeVRleHQgfHwgJ1htbCcpOwogICAgICAgIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgncm9vdCcpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBzcGFuQ2xhc3MgPSBRbmFtZXMuUG9kY2FzdEluZGV4Lk5BTUVTUEFDRVMuaW5jbHVkZXMobm9kZS5xbmFtZS5uYW1lc3BhY2VVcmkgfHwgJycpID8gJ3BvZGNhc3QnIDogdW5kZWZpbmVkOwogICAgICAgIHJlbmRlclRleHRQaWVjZXMoc3VtbWFyeSwgJzwnLCB7CiAgICAgICAgICAgIHRleHQ6IG5vZGUudGFnbmFtZSwKICAgICAgICAgICAgc3BhbkNsYXNzCiAgICAgICAgfSwgLi4uWwogICAgICAgICAgICAuLi5hdHRzLmVudHJpZXMoKQogICAgICAgIF0uZmxhdE1hcCgodik9PlsKICAgICAgICAgICAgICAgIGAgJHt2WzBdfT0iYCwKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0OiB2WzFdLAogICAgICAgICAgICAgICAgICAgIHNwYW5DbGFzczogJ2NvbnRlbnQnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgJyInCiAgICAgICAgICAgIF0KICAgICAgICApLCAnPicsIGl0ZW1OdW1iZXIgPyBgICMke2l0ZW1OdW1iZXJ9YCA6ICcnKTsKICAgIH0KICAgIGRldGFpbHMuYXBwZW5kQ2hpbGQoc3VtbWFyeSk7CiAgICBsZXQgY2hpbGRDb3VudCA9IDA7CiAgICBpZiAodGV4dC5sZW5ndGggPiAwKSB7CiAgICAgICAgY29uc3QgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2NvbnRlbnQnKTsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKGRpdiwgdGV4dCk7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2luZGVudDInKTsKICAgICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG5vZGUuY2hpbGQpKXsKICAgICAgICBsZXQgaXRlbU51bWJlciA9IDE7CiAgICAgICAgbGV0IGl0ZW1zTm90U2hvd24gPSAwOwogICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdmFsdWUpewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ2l0ZW0nICYmIGl0ZW1OdW1iZXIgPiAyMCkgewogICAgICAgICAgICAgICAgaXRlbXNOb3RTaG93bisrOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmVuZGVyTm9kZTEoY2hpbGQsIGRldGFpbHMsIGxldmVsICsgMSwgY29udGV4dCwgdmFsdWUubGVuZ3RoID4gMSA/IGl0ZW1OdW1iZXIgOiB1bmRlZmluZWQpOwogICAgICAgICAgICBjaGlsZENvdW50Kys7CiAgICAgICAgICAgIGl0ZW1OdW1iZXIrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGl0ZW1zTm90U2hvd24gPiAwKSB7CiAgICAgICAgICAgIGNvbnN0IGZha2VOb2RlID0gewogICAgICAgICAgICAgICAgdGFnbmFtZTogYC4uLmFuZCAke25ldyBJbnRsLk51bWJlckZvcm1hdCgpLmZvcm1hdChpdGVtc05vdFNob3duKX0gbW9yZSBpdGVtc2AsCiAgICAgICAgICAgICAgICBhdHRzOiBuZXcgTWFwKCksCiAgICAgICAgICAgICAgICBxbmFtZTogewogICAgICAgICAgICAgICAgICAgIG5hbWU6ICcnCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgYXR0cnNNYXA6IHsKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBjaGlsZDogewogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgICAgICByZW5kZXJOb2RlMShmYWtlTm9kZSwgZGV0YWlscywgbGV2ZWwgLSAxLCBjb250ZXh0LCB1bmRlZmluZWQpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnN0IGF1ZGlvVXJsID0gbm9kZS50YWduYW1lID09PSAnZW5jbG9zdXJlJyAmJiBhdHRzLmdldCgndXJsJykgfHwgbm9kZS5xbmFtZS5uYW1lc3BhY2VVcmkgJiYgcW5hbWVzSW5jbHVkZShRbmFtZXMuUG9kY2FzdEluZGV4LnNvdXJjZSwgbm9kZS5xbmFtZSkgJiYgYXR0cy5nZXQoJ3VyaScpIHx8IHFuYW1lRXEobm9kZS5xbmFtZSwgUW5hbWVzLk1lZGlhUnNzLmNvbnRlbnQpICYmIChhdHRzLmdldCgndHlwZScpIHx8ICcnKS5zdGFydHNXaXRoKCdhdWRpbycpICYmIGF0dHMuZ2V0KCd1cmwnKTsKICAgIGlmIChhdWRpb1VybCkgewogICAgICAgIGNvbnN0IGF1ZGlvID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYXVkaW8nKTsKICAgICAgICBhdWRpby5jb250cm9scyA9IHRydWU7CiAgICAgICAgYXVkaW8ucHJlbG9hZCA9ICdub25lJzsKICAgICAgICBhdWRpby5zcmMgPSBhdWRpb1VybDsKICAgICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGF1ZGlvKTsKICAgICAgICBjaGlsZENvdW50Kys7CiAgICB9CiAgICBpZiAoY2hpbGRDb3VudCA9PT0gMCkgc3VtbWFyeS5jbGFzc0xpc3QuYWRkKCdlbXB0eScsICdpbmRlbnQnKTsKICAgIGNvbnRhaW5lckVsZW1lbnQuYXBwZW5kQ2hpbGQoZGV0YWlscyk7CiAgICBpZiAobm9kZS50YWduYW1lID09PSAnaXRlbScpIGNvbnRleHQuYWRkKCdmb3VuZC1pdGVtJyk7Cn0KZnVuY3Rpb24gcmVuZGVyVGV4dFBpZWNlcyhlbGVtZW50LCAuLi5waWVjZXMpIHsKICAgIGZvciAoY29uc3QgcGllY2Ugb2YgcGllY2VzKXsKICAgICAgICBjb25zdCB0ZXh0ID0gdHlwZW9mIHBpZWNlID09PSAnc3RyaW5nJyA/IHBpZWNlIDogcGllY2UudGV4dDsKICAgICAgICBjb25zdCBzcGFuQ2xhc3MgPSB0eXBlb2YgcGllY2UgPT09ICdvYmplY3QnID8gcGllY2Uuc3BhbkNsYXNzIDogdW5kZWZpbmVkOwogICAgICAgIGlmICgvXmh0dHBzPzpcL1wvW15ccyldKyQvLnRlc3QodGV4dCkpIHsKICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgYS5ocmVmID0gdGV4dDsKICAgICAgICAgICAgZXh0ZXJuYWxpemVBbmNob3IoYSk7CiAgICAgICAgICAgIGEuYXBwZW5kQ2hpbGQoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCkpOwogICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKGEpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHRleHROb2RlID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodGV4dCk7CiAgICAgICAgICAgIGlmIChzcGFuQ2xhc3MpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHNwYW4gPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzcGFuJyk7CiAgICAgICAgICAgICAgICBzcGFuLmNsYXNzTGlzdC5hZGQoc3BhbkNsYXNzKTsKICAgICAgICAgICAgICAgIHNwYW4uYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChzcGFuKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQodGV4dE5vZGUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGFwcE1vZHVsZVNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdhcHAtbW9kdWxlLXNjcmlwdCcpOwpmdW5jdGlvbiBzZXRBcHBTdGF0ZShhcHBTdGF0ZSkgewogICAgYXBwTW9kdWxlU2NyaXB0LmRhdGFzZXQuc3RhdGUgPSBhcHBTdGF0ZTsKfQpzZXRBcHBTdGF0ZSgnc3RhcnRpbmcnKTsKY29uc3QgYXBwQ3NzID0gY3NzYAoKYSB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUucHJpbWFyeUNvbG9yMzAwSGV4KX07CiAgICB0ZXh0LXVuZGVybGluZS1vZmZzZXQ6IDAuMnJlbTsKICAgIHRleHQtZGVjb3JhdGlvbjogbm9uZTsKfQoKQG1lZGlhIChob3ZlcjogaG92ZXIpIHsKICAgIGE6aG92ZXIgewogICAgICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOwogICAgfQp9CgptYWluIHsKICAgIG1hcmdpbjogMnJlbTsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwp9CgpAa2V5ZnJhbWVzIGZhZGVJbkFuaW1hdGlvbiB7CiAgICAwJSB7CiAgICAgICAgb3BhY2l0eTogMDsKICAgIH0KICAgIDEwMCUgewogICAgICAgIG9wYWNpdHk6IDE7CiAgICB9Cn0KCnN1bW1hcnkgewogICAgY3Vyc29yOiBwb2ludGVyOwp9CgpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7Rk9STV9IVE1MfQoke01FU1NBR0VTX0hUTUx9CiR7U0VBUkNIX1JFU1VMVFNfSFRNTH0KJHtDT01NRU5UU19IVE1MfQoke1hNTF9IVE1MfQo8L21haW4+CmA7CmZ1bmN0aW9uIGFwcGVuZFN0eWxlc2hlZXRzKGNzc1RleHRzKSB7CiAgICBjb25zdCBzdHlsZVNoZWV0ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3R5bGUnKTsKICAgIHN0eWxlU2hlZXQudHlwZSA9ICd0ZXh0L2Nzcyc7CiAgICBzdHlsZVNoZWV0LnRleHRDb250ZW50ID0gY3NzVGV4dHMuam9pbignXG5cbicpOwogICAgZG9jdW1lbnQuaGVhZC5hcHBlbmRDaGlsZChzdHlsZVNoZWV0KTsKfQphcHBlbmRTdHlsZXNoZWV0cyhbCiAgICBhcHBDc3MuY3NzVGV4dCwKICAgIEZPUk1fQ1NTLmNzc1RleHQsCiAgICBNRVNTQUdFU19DU1MuY3NzVGV4dCwKICAgIFNFQVJDSF9SRVNVTFRTX0NTUy5jc3NUZXh0LAogICAgQ09NTUVOVFNfQ1NTLmNzc1RleHQsCiAgICBYTUxfQ1NTLmNzc1RleHQsCiAgICBDSVJDVUxBUl9QUk9HUkVTU19DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0LnRleHQpOwogICAgY29uc3QgdmVyc2lvbiA9IHR5cGVvZiBkYXRhLnZlcnNpb24gPT09ICdzdHJpbmcnID8gZGF0YS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YS5mbGFncyA9PT0gJ3N0cmluZycgPyBkYXRhLmZsYWdzIDogdW5kZWZpbmVkOwogICAgY29uc3QgZGVidWcgPSB0eXBlb2YgZGF0YS5kZWJ1ZyA9PT0gJ29iamVjdCcgPyBkYXRhLmRlYnVnIDogdW5kZWZpbmVkOwogICAgY29uc3QgcHVzaElkID0gdHlwZW9mIGRhdGEucHVzaElkID09PSAnc3RyaW5nJyA/IGRhdGEucHVzaElkIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGZsYWdzLAogICAgICAgIGRlYnVnLAogICAgICAgIHB1c2hJZAogICAgfTsKfQpjb25zdCBzdGF0aWNEYXRhID0gcGFyc2VTdGF0aWNEYXRhKCk7CmNvbnN0IGxvY2FsRmV0Y2hlciA9ICh1cmwsIGhlYWRlcnMpPT5mZXRjaCh1cmwsIHsKICAgICAgICBoZWFkZXJzCiAgICB9KQo7CmNvbnN0IHJlbW90ZUZldGNoZXIgPSAodXJsLCBoZWFkZXJzKT0+ZmV0Y2goYC9mLyR7dXJsLnJlcGxhY2VBbGwoL1teYS16QS1aMC05Ll0rL2csICdfJyl9YCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgfSkKICAgIH0pCjsKY29uc3QgcGlTZWFyY2hGZXRjaGVyMSA9IChpbnB1dCwgaGVhZGVycyk9PmZldGNoKGAvc2AsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIGlucHV0LAogICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgfSkKICAgIH0pCjsKY29uc3Qgdm0gPSBuZXcgVmFsaWRhdG9yQXBwVk0oewogICAgbG9jYWxGZXRjaGVyLAogICAgcmVtb3RlRmV0Y2hlciwKICAgIHBpU2VhcmNoRmV0Y2hlcjogcGlTZWFyY2hGZXRjaGVyMQp9KTsKY29uc3QgdXBkYXRlRm9ybSA9IGluaXRGb3JtKGRvY3VtZW50LCB2bSwgc3RhdGljRGF0YSk7CmNvbnN0IHVwZGF0ZU1lc3NhZ2VzID0gaW5pdE1lc3NhZ2VzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZVNlYXJjaFJlc3VsdHMgPSBpbml0U2VhcmNoUmVzdWx0cyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVDb21tZW50cyA9IGluaXRDb21tZW50cyhkb2N1bWVudCwgdm0pOwpjb25zdCB1cGRhdGVYbWwgPSBpbml0WG1sKGRvY3VtZW50LCB2bSk7CnZtLm9uQ2hhbmdlID0gKCk9PnsKICAgIHVwZGF0ZUZvcm0oKTsKICAgIHVwZGF0ZU1lc3NhZ2VzKCk7CiAgICB1cGRhdGVTZWFyY2hSZXN1bHRzKCk7CiAgICB1cGRhdGVDb21tZW50cygpOwogICAgdXBkYXRlWG1sKCk7Cn07CnZtLnN0YXJ0KCk7CnNldEFwcFN0YXRlKCdzdGFydGVkJyk7Cg==';
