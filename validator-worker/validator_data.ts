export const VALIDATOR_APP_HASH = 'd04c5ece316b23c8adfa05fa8c340be3f965026b';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHsKfTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKY29uc3QgaGV4UmVnZXggPSAvXlstK10/MHhbYS1mQS1GMC05XSskLzsKY29uc3QgbnVtUmVnZXggPSAvXihbXC1cK10pPygwKikoXC5bMC05XSsoW2VFXVwtP1swLTldKyk/fFswLTldKyhcLlswLTldKyhbZUVdXC0/WzAtOV0rKT8pPykkLzsKY29uc3QgY29uc2lkZXIgPSB7CiAgICBoZXg6IHRydWUsCiAgICBsZWFkaW5nWmVyb3M6IHRydWUsCiAgICBkZWNpbWFsUG9pbnQ6ICIuIgp9OwpmdW5jdGlvbiB0b051bWJlcihzdHIsIG9wdGlvbnMgPSB7Cn0pIHsKICAgIG9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHsKICAgIH0sIGNvbnNpZGVyLCBvcHRpb25zKTsKICAgIGlmICghc3RyIHx8IHR5cGVvZiBzdHIgIT09ICJzdHJpbmciKSByZXR1cm4gc3RyOwogICAgbGV0IHRyaW1tZWRTdHIgPSBzdHIudHJpbSgpOwogICAgaWYgKG9wdGlvbnMuc2tpcExpa2UgIT09IHZvaWQgMCAmJiBvcHRpb25zLnNraXBMaWtlLnRlc3QodHJpbW1lZFN0cikpIHJldHVybiBzdHI7CiAgICBlbHNlIGlmIChvcHRpb25zLmhleCAmJiBoZXhSZWdleC50ZXN0KHRyaW1tZWRTdHIpKSB7CiAgICAgICAgcmV0dXJuIE51bWJlci5wYXJzZUludCh0cmltbWVkU3RyLCAxNik7CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IG1hdGNoID0gbnVtUmVnZXguZXhlYyh0cmltbWVkU3RyKTsKICAgICAgICBpZiAobWF0Y2gpIHsKICAgICAgICAgICAgbWF0Y2hbMV07CiAgICAgICAgICAgIGNvbnN0IGxlYWRpbmdaZXJvcyA9IG1hdGNoWzJdOwogICAgICAgICAgICBjb25zdCBudW0gPSBtYXRjaFszXTsKICAgICAgICAgICAgbWF0Y2hbNF0gfHwgbWF0Y2hbNl07CiAgICAgICAgICAgIGlmIChsZWFkaW5nWmVyb3MubGVuZ3RoID09PSAxICYmIG51bVswXSA9PT0gIi4iKSByZXR1cm4gTnVtYmVyKHN0cik7CiAgICAgICAgICAgIGVsc2UgaWYgKCFvcHRpb25zLmxlYWRpbmdaZXJvcyAmJiBsZWFkaW5nWmVyb3MubGVuZ3RoID4gMCkgcmV0dXJuIHN0cjsKICAgICAgICAgICAgZWxzZSByZXR1cm4gTnVtYmVyKHRyaW1tZWRTdHIpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgfQogICAgfQp9CnZhciBzdHJudW0gPSB0b051bWJlcjsKZnVuY3Rpb24gY3JlYXRlQ29tbW9uanNNb2R1bGUoZm4sIGJhc2VkaXIsIG1vZHVsZSkgewogICAgcmV0dXJuIG1vZHVsZSA9IHsKICAgICAgICBwYXRoOiBiYXNlZGlyLAogICAgICAgIGV4cG9ydHM6IHsKICAgICAgICB9LAogICAgICAgIHJlcXVpcmU6IGZ1bmN0aW9uKHBhdGgsIGJhc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGNvbW1vbmpzUmVxdWlyZShwYXRoLCBiYXNlID09PSB2b2lkIDAgfHwgYmFzZSA9PT0gbnVsbCA/IG1vZHVsZS5wYXRoIDogYmFzZSk7CiAgICAgICAgfQogICAgfSwgZm4obW9kdWxlLCBtb2R1bGUuZXhwb3J0cyksIG1vZHVsZS5leHBvcnRzOwp9CmZ1bmN0aW9uIGNvbW1vbmpzUmVxdWlyZSgpIHsKICAgIHRocm93IG5ldyBFcnJvcigiRHluYW1pYyByZXF1aXJlcyBhcmUgbm90IGN1cnJlbnRseSBzdXBwb3J0ZWQgYnkgQHJvbGx1cC9wbHVnaW4tY29tbW9uanMiKTsKfQp2YXIgdXRpbCA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewogICAgY29uc3QgbmFtZVN0YXJ0Q2hhciA9ICI6QS1aYS16X1xcdTAwQzAtXFx1MDBENlxcdTAwRDgtXFx1MDBGNlxcdTAwRjgtXFx1MDJGRlxcdTAzNzAtXFx1MDM3RFxcdTAzN0YtXFx1MUZGRlxcdTIwMEMtXFx1MjAwRFxcdTIwNzAtXFx1MjE4RlxcdTJDMDAtXFx1MkZFRlxcdTMwMDEtXFx1RDdGRlxcdUY5MDAtXFx1RkRDRlxcdUZERjAtXFx1RkZGRCI7CiAgICBjb25zdCBuYW1lQ2hhciA9IG5hbWVTdGFydENoYXIgKyAiXFwtLlxcZFxcdTAwQjdcXHUwMzAwLVxcdTAzNkZcXHUyMDNGLVxcdTIwNDAiOwogICAgY29uc3QgbmFtZVJlZ2V4cCA9ICJbIiArIG5hbWVTdGFydENoYXIgKyAiXVsiICsgbmFtZUNoYXIgKyAiXSoiOwogICAgY29uc3QgcmVnZXhOYW1lID0gbmV3IFJlZ0V4cCgiXiIgKyBuYW1lUmVnZXhwICsgIiQiKTsKICAgIGNvbnN0IGdldEFsbE1hdGNoZXMgPSBmdW5jdGlvbihzdHJpbmcsIHJlZ2V4KSB7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IFtdOwogICAgICAgIGxldCBtYXRjaCA9IHJlZ2V4LmV4ZWMoc3RyaW5nKTsKICAgICAgICB3aGlsZShtYXRjaCl7CiAgICAgICAgICAgIGNvbnN0IGFsbG1hdGNoZXMgPSBbXTsKICAgICAgICAgICAgYWxsbWF0Y2hlcy5zdGFydEluZGV4ID0gcmVnZXgubGFzdEluZGV4IC0gbWF0Y2hbMF0ubGVuZ3RoOwogICAgICAgICAgICBjb25zdCBsZW4gPSBtYXRjaC5sZW5ndGg7CiAgICAgICAgICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGxlbjsgaW5kZXgrKyl7CiAgICAgICAgICAgICAgICBhbGxtYXRjaGVzLnB1c2gobWF0Y2hbaW5kZXhdKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBtYXRjaGVzLnB1c2goYWxsbWF0Y2hlcyk7CiAgICAgICAgICAgIG1hdGNoID0gcmVnZXguZXhlYyhzdHJpbmcpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbWF0Y2hlczsKICAgIH07CiAgICBjb25zdCBpc05hbWUgPSBmdW5jdGlvbihzdHJpbmcpIHsKICAgICAgICBjb25zdCBtYXRjaCA9IHJlZ2V4TmFtZS5leGVjKHN0cmluZyk7CiAgICAgICAgcmV0dXJuICEobWF0Y2ggPT09IG51bGwgfHwgdHlwZW9mIG1hdGNoID09PSAidW5kZWZpbmVkIik7CiAgICB9OwogICAgZXhwb3J0cy5pc0V4aXN0ID0gZnVuY3Rpb24odikgewogICAgICAgIHJldHVybiB0eXBlb2YgdiAhPT0gInVuZGVmaW5lZCI7CiAgICB9OwogICAgZXhwb3J0cy5pc0VtcHR5T2JqZWN0ID0gZnVuY3Rpb24ob2JqKSB7CiAgICAgICAgcmV0dXJuIE9iamVjdC5rZXlzKG9iaikubGVuZ3RoID09PSAwOwogICAgfTsKICAgIGV4cG9ydHMubWVyZ2UgPSBmdW5jdGlvbih0YXJnZXQsIGEsIGFycmF5TW9kZSkgewogICAgICAgIGlmIChhKSB7CiAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhKTsKICAgICAgICAgICAgY29uc3QgbGVuID0ga2V5cy5sZW5ndGg7CiAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgICAgICBpZiAoYXJyYXlNb2RlID09PSAic3RyaWN0IikgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXlzW2ldXSA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgYVtrZXlzW2ldXQogICAgICAgICAgICAgICAgICAgIF07CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHRhcmdldFtrZXlzW2ldXSA9IGFba2V5c1tpXV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5nZXRWYWx1ZSA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICBpZiAoZXhwb3J0cy5pc0V4aXN0KHYpKSB7CiAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9OwogICAgZXhwb3J0cy5idWlsZE9wdGlvbnMgPSBmdW5jdGlvbihvcHRpb25zLCBkZWZhdWx0T3B0aW9uczIsIHByb3BzMikgewogICAgICAgIGxldCBuZXdPcHRpb25zID0gewogICAgICAgIH07CiAgICAgICAgaWYgKCFvcHRpb25zKSB7CiAgICAgICAgICAgIHJldHVybiBkZWZhdWx0T3B0aW9uczI7CiAgICAgICAgfQogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBwcm9wczIubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAob3B0aW9uc1twcm9wczJbaV1dICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIG5ld09wdGlvbnNbcHJvcHMyW2ldXSA9IG9wdGlvbnNbcHJvcHMyW2ldXTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIG5ld09wdGlvbnNbcHJvcHMyW2ldXSA9IGRlZmF1bHRPcHRpb25zMltwcm9wczJbaV1dOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBuZXdPcHRpb25zOwogICAgfTsKICAgIGV4cG9ydHMuaXNUYWdOYW1lSW5BcnJheU1vZGUgPSBmdW5jdGlvbih0YWdOYW1lLCBhcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpIHsKICAgICAgICBpZiAoYXJyYXlNb2RlID09PSBmYWxzZSkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfSBlbHNlIGlmIChhcnJheU1vZGUgaW5zdGFuY2VvZiBSZWdFeHApIHsKICAgICAgICAgICAgcmV0dXJuIGFycmF5TW9kZS50ZXN0KHRhZ05hbWUpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGFycmF5TW9kZSA9PT0gImZ1bmN0aW9uIikgewogICAgICAgICAgICByZXR1cm4gISFhcnJheU1vZGUodGFnTmFtZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBhcnJheU1vZGUgPT09ICJzdHJpY3QiOwogICAgfTsKICAgIGV4cG9ydHMuaXNOYW1lID0gaXNOYW1lOwogICAgZXhwb3J0cy5nZXRBbGxNYXRjaGVzID0gZ2V0QWxsTWF0Y2hlczsKICAgIGV4cG9ydHMubmFtZVJlZ2V4cCA9IG5hbWVSZWdleHA7Cn0pOwpjb25zdCBjb252ZXJ0VG9Kc29uID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucywgcGFyZW50VGFnTmFtZSkgewogICAgY29uc3Qgak9iaiA9IHsKICAgIH07CiAgICBpZiAoIW9wdGlvbnMuYWx3YXlzQ3JlYXRlVGV4dE5vZGUgJiYgKCFub2RlLmNoaWxkIHx8IHV0aWwuaXNFbXB0eU9iamVjdChub2RlLmNoaWxkKSkgJiYgKCFub2RlLmF0dHJzTWFwIHx8IHV0aWwuaXNFbXB0eU9iamVjdChub2RlLmF0dHJzTWFwKSkpIHsKICAgICAgICByZXR1cm4gdXRpbC5pc0V4aXN0KG5vZGUudmFsKSA/IG5vZGUudmFsIDogIiI7CiAgICB9CiAgICBpZiAodXRpbC5pc0V4aXN0KG5vZGUudmFsKSAmJiAhKHR5cGVvZiBub2RlLnZhbCA9PT0gInN0cmluZyIgJiYgKG5vZGUudmFsID09PSAiIiB8fCBub2RlLnZhbCA9PT0gb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcikpKSB7CiAgICAgICAgY29uc3QgYXNBcnJheSA9IHV0aWwuaXNUYWdOYW1lSW5BcnJheU1vZGUobm9kZS50YWduYW1lLCBvcHRpb25zLmFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgak9ialtvcHRpb25zLnRleHROb2RlTmFtZV0gPSBhc0FycmF5ID8gWwogICAgICAgICAgICBub2RlLnZhbAogICAgICAgIF0gOiBub2RlLnZhbDsKICAgIH0KICAgIHV0aWwubWVyZ2Uoak9iaiwgbm9kZS5hdHRyc01hcCwgb3B0aW9ucy5hcnJheU1vZGUpOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUuY2hpbGQpOwogICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwga2V5cy5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGNvbnN0IHRhZ05hbWUgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWdOYW1lXSAmJiBub2RlLmNoaWxkW3RhZ05hbWVdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgak9ialt0YWdOYW1lXSA9IFtdOwogICAgICAgICAgICBmb3IobGV0IHRhZyBpbiBub2RlLmNoaWxkW3RhZ05hbWVdKXsKICAgICAgICAgICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ05hbWVdLmhhc093blByb3BlcnR5KHRhZykpIHsKICAgICAgICAgICAgICAgICAgICBqT2JqW3RhZ05hbWVdLnB1c2goY29udmVydFRvSnNvbihub2RlLmNoaWxkW3RhZ05hbWVdW3RhZ10sIG9wdGlvbnMsIHRhZ05hbWUpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNvbnZlcnRUb0pzb24obm9kZS5jaGlsZFt0YWdOYW1lXVswXSwgb3B0aW9ucywgdGFnTmFtZSk7CiAgICAgICAgICAgIGNvbnN0IGFzQXJyYXkgPSBvcHRpb25zLmFycmF5TW9kZSA9PT0gdHJ1ZSAmJiB0eXBlb2YgcmVzdWx0ID09PSAib2JqZWN0IiB8fCB1dGlsLmlzVGFnTmFtZUluQXJyYXlNb2RlKHRhZ05hbWUsIG9wdGlvbnMuYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICAgICAgak9ialt0YWdOYW1lXSA9IGFzQXJyYXkgPyBbCiAgICAgICAgICAgICAgICByZXN1bHQKICAgICAgICAgICAgXSA6IHJlc3VsdDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gak9iajsKfTsKdmFyIGNvbnZlcnRUb0pzb25fMSA9IGNvbnZlcnRUb0pzb247CnZhciBub2RlMmpzb24gPSB7CiAgICBjb252ZXJ0VG9Kc29uOiBjb252ZXJ0VG9Kc29uXzEKfTsKdmFyIHhtbE5vZGUgPSBmdW5jdGlvbih0YWduYW1lLCBwYXJlbnQsIHZhbCkgewogICAgdGhpcy50YWduYW1lID0gdGFnbmFtZTsKICAgIHRoaXMucGFyZW50ID0gcGFyZW50OwogICAgdGhpcy5jaGlsZCA9IHsKICAgIH07CiAgICB0aGlzLmF0dHJzTWFwID0gewogICAgfTsKICAgIHRoaXMudmFsID0gdmFsOwogICAgdGhpcy5hZGRDaGlsZCA9IGZ1bmN0aW9uKGNoaWxkKSB7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXSkpIHsKICAgICAgICAgICAgdGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXS5wdXNoKGNoaWxkKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdID0gWwogICAgICAgICAgICAgICAgY2hpbGQKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICB9Owp9Owpjb25zdCBidWlsZE9wdGlvbnMgPSB1dGlsLmJ1aWxkT3B0aW9uczsKIjwoKCFcXFtDREFUQVxcWyhbXFxzXFxTXSo/KShdXT4pKXwoKE5BTUU6KT8oTkFNRSkpKFtePl0qKT58KChcXC8pKE5BTUUpXFxzKj4pKShbXjxdKikiLnJlcGxhY2UoL05BTUUvZywgdXRpbC5uYW1lUmVnZXhwKTsKaWYgKCFOdW1iZXIucGFyc2VJbnQgJiYgd2luZG93LnBhcnNlSW50KSB7CiAgICBOdW1iZXIucGFyc2VJbnQgPSB3aW5kb3cucGFyc2VJbnQ7Cn0KaWYgKCFOdW1iZXIucGFyc2VGbG9hdCAmJiB3aW5kb3cucGFyc2VGbG9hdCkgewogICAgTnVtYmVyLnBhcnNlRmxvYXQgPSB3aW5kb3cucGFyc2VGbG9hdDsKfQpjb25zdCBkZWZhdWx0T3B0aW9ucyA9IHsKICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICJAXyIsCiAgICBhdHRyTm9kZU5hbWU6IGZhbHNlLAogICAgdGV4dE5vZGVOYW1lOiAiI3RleHQiLAogICAgaWdub3JlQXR0cmlidXRlczogdHJ1ZSwKICAgIGlnbm9yZU5hbWVTcGFjZTogZmFsc2UsCiAgICBhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzOiBmYWxzZSwKICAgIHBhcnNlTm9kZVZhbHVlOiB0cnVlLAogICAgcGFyc2VBdHRyaWJ1dGVWYWx1ZTogZmFsc2UsCiAgICBhcnJheU1vZGU6IGZhbHNlLAogICAgdHJpbVZhbHVlczogdHJ1ZSwKICAgIGNkYXRhVGFnTmFtZTogZmFsc2UsCiAgICBjZGF0YVBvc2l0aW9uQ2hhcjogIlxcYyIsCiAgICBudW1QYXJzZU9wdGlvbnM6IHsKICAgICAgICBoZXg6IHRydWUsCiAgICAgICAgbGVhZGluZ1plcm9zOiB0cnVlCiAgICB9LAogICAgdGFnVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEsIHRhZ05hbWUpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBhdHRyVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEsIGF0dHJOYW1lKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgc3RvcE5vZGVzOiBbXSwKICAgIGFsd2F5c0NyZWF0ZVRleHROb2RlOiBmYWxzZQp9Owp2YXIgZGVmYXVsdE9wdGlvbnNfMSA9IGRlZmF1bHRPcHRpb25zOwpjb25zdCBwcm9wcyA9IFsKICAgICJhdHRyaWJ1dGVOYW1lUHJlZml4IiwKICAgICJhdHRyTm9kZU5hbWUiLAogICAgInRleHROb2RlTmFtZSIsCiAgICAiaWdub3JlQXR0cmlidXRlcyIsCiAgICAiaWdub3JlTmFtZVNwYWNlIiwKICAgICJhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzIiwKICAgICJwYXJzZU5vZGVWYWx1ZSIsCiAgICAicGFyc2VBdHRyaWJ1dGVWYWx1ZSIsCiAgICAiYXJyYXlNb2RlIiwKICAgICJ0cmltVmFsdWVzIiwKICAgICJjZGF0YVRhZ05hbWUiLAogICAgImNkYXRhUG9zaXRpb25DaGFyIiwKICAgICJ0YWdWYWx1ZVByb2Nlc3NvciIsCiAgICAiYXR0clZhbHVlUHJvY2Vzc29yIiwKICAgICJwYXJzZVRydWVOdW1iZXJPbmx5IiwKICAgICJudW1QYXJzZU9wdGlvbnMiLAogICAgInN0b3BOb2RlcyIsCiAgICAiYWx3YXlzQ3JlYXRlVGV4dE5vZGUiCl07CnZhciBwcm9wc18xID0gcHJvcHM7CmZ1bmN0aW9uIHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB2YWwsIG9wdGlvbnMpIHsKICAgIGlmICh2YWwpIHsKICAgICAgICBpZiAob3B0aW9ucy50cmltVmFsdWVzKSB7CiAgICAgICAgICAgIHZhbCA9IHZhbC50cmltKCk7CiAgICAgICAgfQogICAgICAgIHZhbCA9IG9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IodmFsLCB0YWdOYW1lKTsKICAgICAgICB2YWwgPSBwYXJzZVZhbHVlKHZhbCwgb3B0aW9ucy5wYXJzZU5vZGVWYWx1ZSwgb3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpOwogICAgfQogICAgcmV0dXJuIHZhbDsKfQpmdW5jdGlvbiByZXNvbHZlTmFtZVNwYWNlKHRhZ25hbWUsIG9wdGlvbnMpIHsKICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgIGNvbnN0IHRhZ3MgPSB0YWduYW1lLnNwbGl0KCI6Iik7CiAgICAgICAgY29uc3QgcHJlZml4ID0gdGFnbmFtZS5jaGFyQXQoMCkgPT09ICIvIiA/ICIvIiA6ICIiOwogICAgICAgIGlmICh0YWdzWzBdID09PSAieG1sbnMiKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09PSAyKSB7CiAgICAgICAgICAgIHRhZ25hbWUgPSBwcmVmaXggKyB0YWdzWzFdOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0YWduYW1lOwp9CmZ1bmN0aW9uIHBhcnNlVmFsdWUodmFsLCBzaG91bGRQYXJzZSwgb3B0aW9ucykgewogICAgaWYgKHNob3VsZFBhcnNlICYmIHR5cGVvZiB2YWwgPT09ICJzdHJpbmciKSB7CiAgICAgICAgY29uc3QgbmV3dmFsID0gdmFsLnRyaW0oKTsKICAgICAgICBpZiAobmV3dmFsID09PSAidHJ1ZSIpIHJldHVybiB0cnVlOwogICAgICAgIGVsc2UgaWYgKG5ld3ZhbCA9PT0gImZhbHNlIikgcmV0dXJuIGZhbHNlOwogICAgICAgIGVsc2UgcmV0dXJuIHN0cm51bSh2YWwsIG9wdGlvbnMpOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodXRpbC5pc0V4aXN0KHZhbCkpIHsKICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGF0dHJzUmVneCA9IG5ldyBSZWdFeHAoYChbXlxccz1dKylcXHMqKD1cXHMqKFsnIl0pKC4qPylcXDMpP2AsICJnIik7CmZ1bmN0aW9uIGJ1aWxkQXR0cmlidXRlc01hcChhdHRyU3RyLCBvcHRpb25zKSB7CiAgICBpZiAoIW9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyAmJiB0eXBlb2YgYXR0clN0ciA9PT0gInN0cmluZyIpIHsKICAgICAgICBhdHRyU3RyID0gYXR0clN0ci5yZXBsYWNlKC9ccj9cbi9nLCAiICIpOwogICAgICAgIGNvbnN0IG1hdGNoZXMgPSB1dGlsLmdldEFsbE1hdGNoZXMoYXR0clN0ciwgYXR0cnNSZWd4KTsKICAgICAgICBjb25zdCBsZW4gPSBtYXRjaGVzLmxlbmd0aDsKICAgICAgICBjb25zdCBhdHRycyA9IHsKICAgICAgICB9OwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW47IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IGF0dHJOYW1lID0gcmVzb2x2ZU5hbWVTcGFjZShtYXRjaGVzW2ldWzFdLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJOYW1lLmxlbmd0aCkgewogICAgICAgICAgICAgICAgaWYgKG1hdGNoZXNbaV1bNF0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnRyaW1WYWx1ZXMpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2hlc1tpXVs0XSA9IG1hdGNoZXNbaV1bNF0udHJpbSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBtYXRjaGVzW2ldWzRdID0gb3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IobWF0Y2hlc1tpXVs0XSwgYXR0ck5hbWUpOwogICAgICAgICAgICAgICAgICAgIGF0dHJzW29wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeCArIGF0dHJOYW1lXSA9IHBhcnNlVmFsdWUobWF0Y2hlc1tpXVs0XSwgb3B0aW9ucy5wYXJzZUF0dHJpYnV0ZVZhbHVlLCBvcHRpb25zLm51bVBhcnNlT3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdGlvbnMuYWxsb3dCb29sZWFuQXR0cmlidXRlcykgewogICAgICAgICAgICAgICAgICAgIGF0dHJzW29wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeCArIGF0dHJOYW1lXSA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCFPYmplY3Qua2V5cyhhdHRycykubGVuZ3RoKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKG9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHJDb2xsZWN0aW9uID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBhdHRyQ29sbGVjdGlvbltvcHRpb25zLmF0dHJOb2RlTmFtZV0gPSBhdHRyczsKICAgICAgICAgICAgcmV0dXJuIGF0dHJDb2xsZWN0aW9uOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXR0cnM7CiAgICB9Cn0KY29uc3QgZ2V0VHJhdmVyc2FsT2JqID0gZnVuY3Rpb24oeG1sRGF0YSwgb3B0aW9ucykgewogICAgeG1sRGF0YSA9IHhtbERhdGEucmVwbGFjZSgvXHJcbj8vZywgIlxuIik7CiAgICBvcHRpb25zID0gYnVpbGRPcHRpb25zKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zLCBwcm9wcyk7CiAgICBjb25zdCB4bWxPYmogPSBuZXcgeG1sTm9kZSgiIXhtbCIpOwogICAgbGV0IGN1cnJlbnROb2RlID0geG1sT2JqOwogICAgbGV0IHRleHREYXRhID0gIiI7CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgY29uc3QgY2ggPSB4bWxEYXRhW2ldOwogICAgICAgIGlmIChjaCA9PT0gIjwiKSB7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiPiIsIGksICJDbG9zaW5nIFRhZyBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSB4bWxEYXRhLnN1YnN0cmluZyhpICsgMiwgY2xvc2VJbmRleCkudHJpbSgpOwogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb25JbmRleCA9IHRhZ05hbWUuaW5kZXhPZigiOiIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb2xvbkluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHIoY29sb25JbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS52YWwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgIiIgKyBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RvcE5vZGVzLmxlbmd0aCAmJiBvcHRpb25zLnN0b3BOb2Rlcy5pbmNsdWRlcyhjdXJyZW50Tm9kZS50YWduYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmNoaWxkID0gW107CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLmF0dHJzTWFwID09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hdHRyc01hcCA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0geG1sRGF0YS5zdWJzdHIoY3VycmVudE5vZGUuc3RhcnRJbmRleCArIDEsIGkgLSBjdXJyZW50Tm9kZS5zdGFydEluZGV4IC0gMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGN1cnJlbnROb2RlLnBhcmVudDsKICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICBpID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiPz4iLCBpLCAiUGkgVGFnIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDMpID09PSAiIS0tIikgewogICAgICAgICAgICAgICAgaSA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIi0tPiIsIGksICJDb21tZW50IGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDIpID09PSAiIUQiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiPiIsIGksICJET0NUWVBFIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgICAgICBjb25zdCB0YWdFeHAgPSB4bWxEYXRhLnN1YnN0cmluZyhpLCBjbG9zZUluZGV4KTsKICAgICAgICAgICAgICAgIGlmICh0YWdFeHAuaW5kZXhPZigiWyIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBpID0geG1sRGF0YS5pbmRleE9mKCJdPiIsIGkpICsgMTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5zdWJzdHIoaSArIDEsIDIpID09PSAiIVsiKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiXV0+IiwgaSwgIkNEQVRBIGlzIG5vdCBjbG9zZWQuIikgLSAyOwogICAgICAgICAgICAgICAgY29uc3QgdGFnRXhwID0geG1sRGF0YS5zdWJzdHJpbmcoaSArIDksIGNsb3NlSW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKHRleHREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgIiIgKyBwcm9jZXNzVGFnVmFsdWUoY3VycmVudE5vZGUudGFnbmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5jZGF0YVRhZ05hbWUpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZShvcHRpb25zLmNkYXRhVGFnTmFtZSwgY3VycmVudE5vZGUsIHRhZ0V4cCk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLnZhbCA9IHRhZ0V4cDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IChjdXJyZW50Tm9kZS52YWwgfHwgIiIpICsgKHRhZ0V4cCB8fCAiIik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleCArIDI7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSBjbG9zaW5nSW5kZXhGb3JPcGVuaW5nVGFnKHhtbERhdGEsIGkgKyAxKTsKICAgICAgICAgICAgICAgIGxldCB0YWdFeHAgPSByZXN1bHQuZGF0YTsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSByZXN1bHQuaW5kZXg7CiAgICAgICAgICAgICAgICBjb25zdCBzZXBhcmF0b3JJbmRleCA9IHRhZ0V4cC5pbmRleE9mKCIgIik7CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9IHRhZ0V4cDsKICAgICAgICAgICAgICAgIGxldCBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXAgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKHNlcGFyYXRvckluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdFeHAuc3Vic3RyKDAsIHNlcGFyYXRvckluZGV4KS5yZXBsYWNlKC9cc1xzKiQvLCAiIik7CiAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnRXhwLnN1YnN0cihzZXBhcmF0b3JJbmRleCArIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29sb25JbmRleCA9IHRhZ05hbWUuaW5kZXhPZigiOiIpOwogICAgICAgICAgICAgICAgICAgIGlmIChjb2xvbkluZGV4ICE9PSAtMSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHIoY29sb25JbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgICAgICBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXAgPSB0YWdOYW1lICE9PSByZXN1bHQuZGF0YS5zdWJzdHIoY29sb25JbmRleCArIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZSAmJiB0ZXh0RGF0YSkgewogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS50YWduYW1lICE9PSAiIXhtbCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgIiIgKyBwcm9jZXNzVGFnVmFsdWUoY3VycmVudE5vZGUudGFnbmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh0YWdFeHAubGVuZ3RoID4gMCAmJiB0YWdFeHAubGFzdEluZGV4T2YoIi8iKSA9PT0gdGFnRXhwLmxlbmd0aCAtIDEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZVt0YWdOYW1lLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKDAsIHRhZ05hbWUubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ05hbWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnRXhwLnN1YnN0cigwLCB0YWdFeHAubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKHRhZ05hbWUsIGN1cnJlbnROb2RlLCAiIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IHRhZ0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuYXR0cnNNYXAgPSBidWlsZEF0dHJpYnV0ZXNNYXAodGFnRXhwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUodGFnTmFtZSwgY3VycmVudE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BOb2Rlcy5sZW5ndGggJiYgb3B0aW9ucy5zdG9wTm9kZXMuaW5jbHVkZXMoY2hpbGROb2RlLnRhZ25hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5zdGFydEluZGV4ID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IHRhZ0V4cCAmJiBzaG91bGRCdWlsZEF0dHJpYnV0ZXNNYXApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLmF0dHJzTWFwID0gYnVpbGRBdHRyaWJ1dGVzTWFwKHRhZ0V4cCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjaGlsZE5vZGU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0ZXh0RGF0YSArPSB4bWxEYXRhW2ldOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB4bWxPYmo7Cn07CmZ1bmN0aW9uIGNsb3NpbmdJbmRleEZvck9wZW5pbmdUYWcoZGF0YSwgaSkgewogICAgbGV0IGF0dHJCb3VuZGFyeTsKICAgIGxldCB0YWdFeHAgPSAiIjsKICAgIGZvcihsZXQgaW5kZXggPSBpOyBpbmRleCA8IGRhdGEubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBsZXQgY2ggPSBkYXRhW2luZGV4XTsKICAgICAgICBpZiAoYXR0ckJvdW5kYXJ5KSB7CiAgICAgICAgICAgIGlmIChjaCA9PT0gYXR0ckJvdW5kYXJ5KSBhdHRyQm91bmRhcnkgPSAiIjsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAnIicgfHwgY2ggPT09ICInIikgewogICAgICAgICAgICBhdHRyQm91bmRhcnkgPSBjaDsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiPiIpIHsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGRhdGE6IHRhZ0V4cCwKICAgICAgICAgICAgICAgIGluZGV4CiAgICAgICAgICAgIH07CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIgkiKSB7CiAgICAgICAgICAgIGNoID0gIiAiOwogICAgICAgIH0KICAgICAgICB0YWdFeHAgKz0gY2g7CiAgICB9Cn0KZnVuY3Rpb24gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCBzdHIsIGksIGVyck1zZykgewogICAgY29uc3QgY2xvc2luZ0luZGV4ID0geG1sRGF0YS5pbmRleE9mKHN0ciwgaSk7CiAgICBpZiAoY2xvc2luZ0luZGV4ID09PSAtMSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcihlcnJNc2cpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gY2xvc2luZ0luZGV4ICsgc3RyLmxlbmd0aCAtIDE7CiAgICB9Cn0KdmFyIGdldFRyYXZlcnNhbE9ial8xID0gZ2V0VHJhdmVyc2FsT2JqOwp2YXIgeG1sc3RyMnhtbG5vZGUgPSB7CiAgICBkZWZhdWx0T3B0aW9uczogZGVmYXVsdE9wdGlvbnNfMSwKICAgIHByb3BzOiBwcm9wc18xLAogICAgZ2V0VHJhdmVyc2FsT2JqOiBnZXRUcmF2ZXJzYWxPYmpfMQp9Owpjb25zdCBkZWZhdWx0T3B0aW9ucyQxID0gewogICAgYWxsb3dCb29sZWFuQXR0cmlidXRlczogZmFsc2UKfTsKY29uc3QgcHJvcHMkMSA9IFsKICAgICJhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzIgpdOwp2YXIgdmFsaWRhdGUgPSBmdW5jdGlvbih4bWxEYXRhLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gdXRpbC5idWlsZE9wdGlvbnMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMkMSwgcHJvcHMkMSk7CiAgICBjb25zdCB0YWdzID0gW107CiAgICBsZXQgdGFnRm91bmQgPSBmYWxzZTsKICAgIGxldCByZWFjaGVkUm9vdCA9IGZhbHNlOwogICAgaWYgKHhtbERhdGFbMF0gPT09ICJcdUZFRkYiKSB7CiAgICAgICAgeG1sRGF0YSA9IHhtbERhdGEuc3Vic3RyKDEpOwogICAgfQogICAgZm9yKGxldCBpID0gMDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgIGkgPSByZWFkUEkoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgIGlmIChpLmVycikgcmV0dXJuIGk7CiAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgbGV0IHRhZ1N0YXJ0UG9zID0gaTsKICAgICAgICAgICAgaSsrOwogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICBpID0gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbGV0IGNsb3NpbmdUYWcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICBjbG9zaW5nVGFnID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9ICIiOwogICAgICAgICAgICAgICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoICYmIHhtbERhdGFbaV0gIT09ICI+IiAmJiB4bWxEYXRhW2ldICE9PSAiICIgJiYgeG1sRGF0YVtpXSAhPT0gIgkiICYmIHhtbERhdGFbaV0gIT09ICJcbiIgJiYgeG1sRGF0YVtpXSAhPT0gIlxyIjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lICs9IHhtbERhdGFbaV07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAodGFnTmFtZVt0YWdOYW1lLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHJpbmcoMCwgdGFnTmFtZS5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoIXZhbGlkYXRlVGFnTmFtZSh0YWdOYW1lKSkgewogICAgICAgICAgICAgICAgICAgIGxldCBtc2c7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUudHJpbSgpLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAiSW52YWxpZCBzcGFjZSBhZnRlciAnPCcuIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBtc2cgPSAiVGFnICciICsgdGFnTmFtZSArICInIGlzIGFuIGludmFsaWQgbmFtZS4iOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCBtc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCByZXN1bHQgPSByZWFkQXR0cmlidXRlU3RyKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgaWYgKHJlc3VsdCA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZXMgZm9yICciICsgdGFnTmFtZSArICInIGhhdmUgb3BlbiBxdW90ZS4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IGF0dHJTdHIgPSByZXN1bHQudmFsdWU7CiAgICAgICAgICAgICAgICBpID0gcmVzdWx0LmluZGV4OwogICAgICAgICAgICAgICAgaWYgKGF0dHJTdHJbYXR0clN0ci5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0clN0clN0YXJ0ID0gaSAtIGF0dHJTdHIubGVuZ3RoOwogICAgICAgICAgICAgICAgICAgIGF0dHJTdHIgPSBhdHRyU3RyLnN1YnN0cmluZygwLCBhdHRyU3RyLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KGlzVmFsaWQuZXJyLmNvZGUsIGlzVmFsaWQuZXJyLm1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGF0dHJTdHJTdGFydCArIGlzVmFsaWQuZXJyLmxpbmUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGNsb3NpbmdUYWcpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoIXJlc3VsdC50YWdDbG9zZWQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInIGRvZXNuJ3QgaGF2ZSBwcm9wZXIgY2xvc2luZy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoYXR0clN0ci50cmltKCkubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiQ2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicgY2FuJ3QgaGF2ZSBhdHRyaWJ1dGVzIG9yIGludmFsaWQgc3RhcnRpbmcuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ1N0YXJ0UG9zKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb3RnID0gdGFncy5wb3AoKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWUgIT09IG90Zy50YWdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3BlblBvcyA9IGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBvdGcudGFnU3RhcnRQb3MpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkV4cGVjdGVkIGNsb3NpbmcgdGFnICciICsgb3RnLnRhZ05hbWUgKyAiJyAob3BlbmVkIGluIGxpbmUgIiArIG9wZW5Qb3MubGluZSArICIsIGNvbCAiICsgb3BlblBvcy5jb2wgKyAiKSBpbnN0ZWFkIG9mIGNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdTdGFydFBvcykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdzLmxlbmd0aCA9PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWFjaGVkUm9vdCA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGlzVmFsaWQgPSB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICBpZiAoaXNWYWxpZCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoaXNWYWxpZC5lcnIuY29kZSwgaXNWYWxpZC5lcnIubXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSAtIGF0dHJTdHIubGVuZ3RoICsgaXNWYWxpZC5lcnIubGluZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAocmVhY2hlZFJvb3QgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIk11bHRpcGxlIHBvc3NpYmxlIHJvb3Qgbm9kZXMgZm91bmQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ1N0YXJ0UG9zCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0YWdGb3VuZCA9IHRydWU7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IoaSsrOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gcmVhZFBJKHhtbERhdGEsICsraSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoaS5lcnIpIHJldHVybiBpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICImIikgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhZnRlckFtcCA9IHZhbGlkYXRlQW1wZXJzYW5kKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoYWZ0ZXJBbXAgPT0gLTEpIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZENoYXIiLCAiY2hhciAnJicgaXMgbm90IGV4cGVjdGVkLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGkgPSBhZnRlckFtcDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIgIiB8fCB4bWxEYXRhW2ldID09PSAiCSIgfHwgeG1sRGF0YVtpXSA9PT0gIlxuIiB8fCB4bWxEYXRhW2ldID09PSAiXHIiKSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRDaGFyIiwgImNoYXIgJyIgKyB4bWxEYXRhW2ldICsgIicgaXMgbm90IGV4cGVjdGVkLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgfQogICAgfQogICAgaWYgKCF0YWdGb3VuZCkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJTdGFydCB0YWcgZXhwZWN0ZWQuIiwgMSk7CiAgICB9IGVsc2UgaWYgKHRhZ3MubGVuZ3RoID09IDEpIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiVW5jbG9zZWQgdGFnICciICsgdGFnc1swXS50YWdOYW1lICsgIicuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ3NbMF0udGFnU3RhcnRQb3MpKTsKICAgIH0gZWxzZSBpZiAodGFncy5sZW5ndGggPiAwKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIkludmFsaWQgJyIgKyBKU09OLnN0cmluZ2lmeSh0YWdzLm1hcCgodCk9PnQudGFnTmFtZQogICAgICAgICksIG51bGwsIDQpLnJlcGxhY2UoL1xyP1xuL2csICIiKSArICInIGZvdW5kLiIsIHsKICAgICAgICAgICAgbGluZTogMSwKICAgICAgICAgICAgY29sOiAxCiAgICAgICAgfSk7CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfTsKZnVuY3Rpb24gcmVhZFBJKHhtbERhdGEsIGkpIHsKICAgIGNvbnN0IHN0YXJ0ID0gaTsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PSAiPyIgfHwgeG1sRGF0YVtpXSA9PSAiICIpIHsKICAgICAgICAgICAgY29uc3QgdGFnbmFtZSA9IHhtbERhdGEuc3Vic3RyKHN0YXJ0LCBpIC0gc3RhcnQpOwogICAgICAgICAgICBpZiAoaSA+IDUgJiYgdGFnbmFtZSA9PT0gInhtbCIpIHsKICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJYTUwgZGVjbGFyYXRpb24gYWxsb3dlZCBvbmx5IGF0IHRoZSBzdGFydCBvZiB0aGUgZG9jdW1lbnQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09ICI/IiAmJiB4bWxEYXRhW2kgKyAxXSA9PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gaTsKfQpmdW5jdGlvbiByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpIHsKICAgIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA1ICYmIHhtbERhdGFbaSArIDFdID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICItIikgewogICAgICAgIGZvcihpICs9IDM7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDJdID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA4ICYmIHhtbERhdGFbaSArIDFdID09PSAiRCIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICJPIiAmJiB4bWxEYXRhW2kgKyAzXSA9PT0gIkMiICYmIHhtbERhdGFbaSArIDRdID09PSAiVCIgJiYgeG1sRGF0YVtpICsgNV0gPT09ICJZIiAmJiB4bWxEYXRhW2kgKyA2XSA9PT0gIlAiICYmIHhtbERhdGFbaSArIDddID09PSAiRSIpIHsKICAgICAgICBsZXQgYW5nbGVCcmFja2V0c0NvdW50ID0gMTsKICAgICAgICBmb3IoaSArPSA4OyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgIGFuZ2xlQnJhY2tldHNDb3VudCsrOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI+IikgewogICAgICAgICAgICAgICAgYW5nbGVCcmFja2V0c0NvdW50LS07CiAgICAgICAgICAgICAgICBpZiAoYW5nbGVCcmFja2V0c0NvdW50ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDkgJiYgeG1sRGF0YVtpICsgMV0gPT09ICJbIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIkMiICYmIHhtbERhdGFbaSArIDNdID09PSAiRCIgJiYgeG1sRGF0YVtpICsgNF0gPT09ICJBIiAmJiB4bWxEYXRhW2kgKyA1XSA9PT0gIlQiICYmIHhtbERhdGFbaSArIDZdID09PSAiQSIgJiYgeG1sRGF0YVtpICsgN10gPT09ICJbIikgewogICAgICAgIGZvcihpICs9IDg7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICJdIiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIl0iICYmIHhtbERhdGFbaSArIDJdID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7Cn0KY29uc3QgZG91YmxlUXVvdGUgPSAnIic7CmNvbnN0IHNpbmdsZVF1b3RlID0gIiciOwpmdW5jdGlvbiByZWFkQXR0cmlidXRlU3RyKHhtbERhdGEsIGkpIHsKICAgIGxldCBhdHRyU3RyID0gIiI7CiAgICBsZXQgc3RhcnRDaGFyID0gIiI7CiAgICBsZXQgdGFnQ2xvc2VkID0gZmFsc2U7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09IGRvdWJsZVF1b3RlIHx8IHhtbERhdGFbaV0gPT09IHNpbmdsZVF1b3RlKSB7CiAgICAgICAgICAgIGlmIChzdGFydENoYXIgPT09ICIiKSB7CiAgICAgICAgICAgICAgICBzdGFydENoYXIgPSB4bWxEYXRhW2ldOwogICAgICAgICAgICB9IGVsc2UgaWYgKHN0YXJ0Q2hhciAhPT0geG1sRGF0YVtpXSkgOwogICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgIHN0YXJ0Q2hhciA9ICIiOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPiIpIHsKICAgICAgICAgICAgaWYgKHN0YXJ0Q2hhciA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHRhZ0Nsb3NlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBhdHRyU3RyICs9IHhtbERhdGFbaV07CiAgICB9CiAgICBpZiAoc3RhcnRDaGFyICE9PSAiIikgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgdmFsdWU6IGF0dHJTdHIsCiAgICAgICAgaW5kZXg6IGksCiAgICAgICAgdGFnQ2xvc2VkCiAgICB9Owp9CmNvbnN0IHZhbGlkQXR0clN0clJlZ3hwID0gbmV3IFJlZ0V4cChgKFxccyopKFteXFxzPV0rKShcXHMqPSk/KFxccyooWyciXSkoKFtcXHNcXFNdKSo/KVxcNSk/YCwgImciKTsKZnVuY3Rpb24gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucykgewogICAgY29uc3QgbWF0Y2hlcyA9IHV0aWwuZ2V0QWxsTWF0Y2hlcyhhdHRyU3RyLCB2YWxpZEF0dHJTdHJSZWd4cCk7CiAgICBjb25zdCBhdHRyTmFtZXMgPSB7CiAgICB9OwogICAgZm9yKGxldCBpID0gMDsgaSA8IG1hdGNoZXMubGVuZ3RoOyBpKyspewogICAgICAgIGlmIChtYXRjaGVzW2ldWzFdLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIG1hdGNoZXNbaV1bMl0gKyAiJyBoYXMgbm8gc3BhY2UgaW4gc3RhcnRpbmcuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0gZWxzZSBpZiAobWF0Y2hlc1tpXVszXSA9PT0gdm9pZCAwICYmICFvcHRpb25zLmFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJib29sZWFuIGF0dHJpYnV0ZSAnIiArIG1hdGNoZXNbaV1bMl0gKyAiJyBpcyBub3QgYWxsb3dlZC4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGF0dHJOYW1lID0gbWF0Y2hlc1tpXVsyXTsKICAgICAgICBpZiAoIXZhbGlkYXRlQXR0ck5hbWUoYXR0ck5hbWUpKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgYXR0ck5hbWUgKyAiJyBpcyBhbiBpbnZhbGlkIG5hbWUuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgICAgICBpZiAoIWF0dHJOYW1lcy5oYXNPd25Qcm9wZXJ0eShhdHRyTmFtZSkpIHsKICAgICAgICAgICAgYXR0ck5hbWVzW2F0dHJOYW1lXSA9IDE7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBhdHRyTmFtZSArICInIGlzIHJlcGVhdGVkLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdHJ1ZTsKfQpmdW5jdGlvbiB2YWxpZGF0ZU51bWJlckFtcGVyc2FuZCh4bWxEYXRhLCBpKSB7CiAgICBsZXQgcmUgPSAvXGQvOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICJ4IikgewogICAgICAgIGkrKzsKICAgICAgICByZSA9IC9bXGRhLWZBLUZdLzsKICAgIH0KICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjsiKSByZXR1cm4gaTsKICAgICAgICBpZiAoIXhtbERhdGFbaV0ubWF0Y2gocmUpKSBicmVhazsKICAgIH0KICAgIHJldHVybiAtMTsKfQpmdW5jdGlvbiB2YWxpZGF0ZUFtcGVyc2FuZCh4bWxEYXRhLCBpKSB7CiAgICBpKys7CiAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjsiKSByZXR1cm4gLTE7CiAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIiMiKSB7CiAgICAgICAgaSsrOwogICAgICAgIHJldHVybiB2YWxpZGF0ZU51bWJlckFtcGVyc2FuZCh4bWxEYXRhLCBpKTsKICAgIH0KICAgIGxldCBjb3VudCA9IDA7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKywgY291bnQrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0ubWF0Y2goL1x3LykgJiYgY291bnQgPCAyMCkgY29udGludWU7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgYnJlYWs7CiAgICAgICAgcmV0dXJuIC0xOwogICAgfQogICAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gZ2V0RXJyb3JPYmplY3QoY29kZSwgbWVzc2FnZSwgbGluZU51bWJlcikgewogICAgcmV0dXJuIHsKICAgICAgICBlcnI6IHsKICAgICAgICAgICAgY29kZSwKICAgICAgICAgICAgbXNnOiBtZXNzYWdlLAogICAgICAgICAgICBsaW5lOiBsaW5lTnVtYmVyLmxpbmUgfHwgbGluZU51bWJlciwKICAgICAgICAgICAgY29sOiBsaW5lTnVtYmVyLmNvbAogICAgICAgIH0KICAgIH07Cn0KZnVuY3Rpb24gdmFsaWRhdGVBdHRyTmFtZShhdHRyTmFtZSkgewogICAgcmV0dXJuIHV0aWwuaXNOYW1lKGF0dHJOYW1lKTsKfQpmdW5jdGlvbiB2YWxpZGF0ZVRhZ05hbWUodGFnbmFtZSkgewogICAgcmV0dXJuIHV0aWwuaXNOYW1lKHRhZ25hbWUpOwp9CmZ1bmN0aW9uIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpbmRleCkgewogICAgY29uc3QgbGluZXMgPSB4bWxEYXRhLnN1YnN0cmluZygwLCBpbmRleCkuc3BsaXQoL1xyP1xuLyk7CiAgICByZXR1cm4gewogICAgICAgIGxpbmU6IGxpbmVzLmxlbmd0aCwKICAgICAgICBjb2w6IGxpbmVzW2xpbmVzLmxlbmd0aCAtIDFdLmxlbmd0aCArIDEKICAgIH07Cn0KZnVuY3Rpb24gZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2gpIHsKICAgIHJldHVybiBtYXRjaC5zdGFydEluZGV4ICsgbWF0Y2hbMV0ubGVuZ3RoOwp9CnZhciB2YWxpZGF0b3IgPSB7CiAgICB2YWxpZGF0ZQp9Owpjb25zdCBfX2NoYXIgPSBmdW5jdGlvbihhKSB7CiAgICByZXR1cm4gU3RyaW5nLmZyb21DaGFyQ29kZShhKTsKfTsKY29uc3QgY2hhcnMgPSB7CiAgICBuaWxDaGFyOiBfX2NoYXIoMTc2KSwKICAgIG1pc3NpbmdDaGFyOiBfX2NoYXIoMjAxKSwKICAgIG5pbFByZW1pdGl2ZTogX19jaGFyKDE3NSksCiAgICBtaXNzaW5nUHJlbWl0aXZlOiBfX2NoYXIoMjAwKSwKICAgIGVtcHR5Q2hhcjogX19jaGFyKDE3OCksCiAgICBlbXB0eVZhbHVlOiBfX2NoYXIoMTc3KSwKICAgIGJvdW5kcnlDaGFyOiBfX2NoYXIoMTc5KSwKICAgIG9ialN0YXJ0OiBfX2NoYXIoMTk4KSwKICAgIGFyclN0YXJ0OiBfX2NoYXIoMjA0KSwKICAgIGFycmF5RW5kOiBfX2NoYXIoMTg1KQp9Owpjb25zdCBjaGFyc0FyciA9IFsKICAgIGNoYXJzLm5pbENoYXIsCiAgICBjaGFycy5uaWxQcmVtaXRpdmUsCiAgICBjaGFycy5taXNzaW5nQ2hhciwKICAgIGNoYXJzLm1pc3NpbmdQcmVtaXRpdmUsCiAgICBjaGFycy5ib3VuZHJ5Q2hhciwKICAgIGNoYXJzLmVtcHR5Q2hhciwKICAgIGNoYXJzLmVtcHR5VmFsdWUsCiAgICBjaGFycy5hcnJheUVuZCwKICAgIGNoYXJzLm9ialN0YXJ0LAogICAgY2hhcnMuYXJyU3RhcnQKXTsKY29uc3QgX2UgPSBmdW5jdGlvbihub2RlLCBlX3NjaGVtYSwgb3B0aW9ucykgewogICAgaWYgKHR5cGVvZiBlX3NjaGVtYSA9PT0gInN0cmluZyIpIHsKICAgICAgICBpZiAobm9kZSAmJiBub2RlWzBdICYmIG5vZGVbMF0udmFsICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldFZhbHVlKG5vZGVbMF0udmFsKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWUobm9kZSk7CiAgICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBoYXNWYWxpZERhdGEgPSBoYXNEYXRhKG5vZGUpOwogICAgICAgIGlmIChoYXNWYWxpZERhdGEgPT09IHRydWUpIHsKICAgICAgICAgICAgbGV0IHN0ciA9ICIiOwogICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShlX3NjaGVtYSkpIHsKICAgICAgICAgICAgICAgIHN0ciArPSBjaGFycy5hcnJTdGFydDsKICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1TY2hlbWEgPSBlX3NjaGVtYVswXTsKICAgICAgICAgICAgICAgIGNvbnN0IGFycl9sZW4gPSBub2RlLmxlbmd0aDsKICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlbVNjaGVtYSA9PT0gInN0cmluZyIpIHsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGFycl9pID0gMDsgYXJyX2kgPCBhcnJfbGVuOyBhcnJfaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IGdldFZhbHVlKG5vZGVbYXJyX2ldLnZhbCk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHByb2Nlc3NWYWx1ZShzdHIsIHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBhcnJfaSA9IDA7IGFycl9pIDwgYXJyX2xlbjsgYXJyX2krKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBfZShub2RlW2Fycl9pXSwgaXRlbVNjaGVtYSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0ciA9IHByb2Nlc3NWYWx1ZShzdHIsIHIpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHN0ciArPSBjaGFycy5hcnJheUVuZDsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHN0ciArPSBjaGFycy5vYmpTdGFydDsKICAgICAgICAgICAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhlX3NjaGVtYSk7CiAgICAgICAgICAgICAgICBpZiAoQXJyYXkuaXNBcnJheShub2RlKSkgewogICAgICAgICAgICAgICAgICAgIG5vZGUgPSBub2RlWzBdOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yKGxldCBpIGluIGtleXMpewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtleSA9IGtleXNbaV07CiAgICAgICAgICAgICAgICAgICAgbGV0IHI7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvcHRpb25zLmlnbm9yZUF0dHJpYnV0ZXMgJiYgbm9kZS5hdHRyc01hcCAmJiBub2RlLmF0dHJzTWFwW2tleV0pIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IF9lKG5vZGUuYXR0cnNNYXBba2V5XSwgZV9zY2hlbWFba2V5XSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChrZXkgPT09IG9wdGlvbnMudGV4dE5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLnZhbCwgZV9zY2hlbWFba2V5XSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IF9lKG5vZGUuY2hpbGRba2V5XSwgZV9zY2hlbWFba2V5XSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHN0ciA9IHByb2Nlc3NWYWx1ZShzdHIsIHIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzdHI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGhhc1ZhbGlkRGF0YTsKICAgICAgICB9CiAgICB9Cn07CmNvbnN0IGdldFZhbHVlID0gZnVuY3Rpb24oYSkgewogICAgc3dpdGNoKGEpewogICAgICAgIGNhc2Ugdm9pZCAwOgogICAgICAgICAgICByZXR1cm4gY2hhcnMubWlzc2luZ1ByZW1pdGl2ZTsKICAgICAgICBjYXNlIG51bGw6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5uaWxQcmVtaXRpdmU7CiAgICAgICAgY2FzZSAiIjoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLmVtcHR5VmFsdWU7CiAgICAgICAgZGVmYXVsdDoKICAgICAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn07CmNvbnN0IHByb2Nlc3NWYWx1ZSA9IGZ1bmN0aW9uKHN0ciwgcikgewogICAgaWYgKCFpc0FwcENoYXIoclswXSkgJiYgIWlzQXBwQ2hhcihzdHJbc3RyLmxlbmd0aCAtIDFdKSkgewogICAgICAgIHN0ciArPSBjaGFycy5ib3VuZHJ5Q2hhcjsKICAgIH0KICAgIHJldHVybiBzdHIgKyByOwp9Owpjb25zdCBpc0FwcENoYXIgPSBmdW5jdGlvbihjaCkgewogICAgcmV0dXJuIGNoYXJzQXJyLmluZGV4T2YoY2gpICE9PSAtMTsKfTsKZnVuY3Rpb24gaGFzRGF0YShqT2JqKSB7CiAgICBpZiAoak9iaiA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIGNoYXJzLm1pc3NpbmdDaGFyOwogICAgfSBlbHNlIGlmIChqT2JqID09PSBudWxsKSB7CiAgICAgICAgcmV0dXJuIGNoYXJzLm5pbENoYXI7CiAgICB9IGVsc2UgaWYgKGpPYmouY2hpbGQgJiYgT2JqZWN0LmtleXMoak9iai5jaGlsZCkubGVuZ3RoID09PSAwICYmICghak9iai5hdHRyc01hcCB8fCBPYmplY3Qua2V5cyhqT2JqLmF0dHJzTWFwKS5sZW5ndGggPT09IDApKSB7CiAgICAgICAgcmV0dXJuIGNoYXJzLmVtcHR5Q2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9Cn0KY29uc3QgYnVpbGRPcHRpb25zJDEgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgY29udmVydDJuaW1uID0gZnVuY3Rpb24obm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMShvcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5kZWZhdWx0T3B0aW9ucywgeG1sc3RyMnhtbG5vZGUucHJvcHMpOwogICAgcmV0dXJuIF9lKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKTsKfTsKdmFyIGNvbnZlcnQybmltbl8xID0gY29udmVydDJuaW1uOwp2YXIgbmltbmRhdGEgPSB7CiAgICBjb252ZXJ0Mm5pbW46IGNvbnZlcnQybmltbl8xCn07CmNvbnN0IGJ1aWxkT3B0aW9ucyQyID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGNvbnZlcnRUb0pzb25TdHJpbmcgPSBmdW5jdGlvbihub2RlLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gYnVpbGRPcHRpb25zJDIob3B0aW9ucywgeG1sc3RyMnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLnByb3BzKTsKICAgIG9wdGlvbnMuaW5kZW50QnkgPSBvcHRpb25zLmluZGVudEJ5IHx8ICIiOwogICAgcmV0dXJuIF9jVG9Kc29uU3RyKG5vZGUsIG9wdGlvbnMpOwp9Owpjb25zdCBfY1RvSnNvblN0ciA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMsIGxldmVsKSB7CiAgICBsZXQgak9iaiA9ICJ7IjsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhub2RlLmNoaWxkKTsKICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGtleXMubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBjb25zdCB0YWduYW1lID0ga2V5c1tpbmRleF07CiAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnbmFtZV0gJiYgbm9kZS5jaGlsZFt0YWduYW1lXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGpPYmogKz0gJyInICsgdGFnbmFtZSArICciIDogWyAnOwogICAgICAgICAgICBmb3IobGV0IHRhZyBpbiBub2RlLmNoaWxkW3RhZ25hbWVdKXsKICAgICAgICAgICAgICAgIGpPYmogKz0gX2NUb0pzb25TdHIobm9kZS5jaGlsZFt0YWduYW1lXVt0YWddLCBvcHRpb25zKSArICIgLCAiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGpPYmogPSBqT2JqLnN1YnN0cigwLCBqT2JqLmxlbmd0aCAtIDEpICsgIiBdICI7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgak9iaiArPSAnIicgKyB0YWduYW1lICsgJyIgOiAnICsgX2NUb0pzb25TdHIobm9kZS5jaGlsZFt0YWduYW1lXVswXSwgb3B0aW9ucykgKyAiICwiOwogICAgICAgIH0KICAgIH0KICAgIHV0aWwubWVyZ2Uoak9iaiwgbm9kZS5hdHRyc01hcCk7CiAgICBpZiAodXRpbC5pc0VtcHR5T2JqZWN0KGpPYmopKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuaXNFeGlzdChub2RlLnZhbCkgPyBub2RlLnZhbCA6ICIiOwogICAgfSBlbHNlIHsKICAgICAgICBpZiAodXRpbC5pc0V4aXN0KG5vZGUudmFsKSkgewogICAgICAgICAgICBpZiAoISh0eXBlb2Ygbm9kZS52YWwgPT09ICJzdHJpbmciICYmIChub2RlLnZhbCA9PT0gIiIgfHwgbm9kZS52YWwgPT09IG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIpKSkgewogICAgICAgICAgICAgICAgak9iaiArPSAnIicgKyBvcHRpb25zLnRleHROb2RlTmFtZSArICciIDogJyArIHN0cmluZ3ZhbChub2RlLnZhbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBpZiAoak9ialtqT2JqLmxlbmd0aCAtIDFdID09PSAiLCIpIHsKICAgICAgICBqT2JqID0gak9iai5zdWJzdHIoMCwgak9iai5sZW5ndGggLSAyKTsKICAgIH0KICAgIHJldHVybiBqT2JqICsgIn0iOwp9OwpmdW5jdGlvbiBzdHJpbmd2YWwodikgewogICAgaWYgKHYgPT09IHRydWUgfHwgdiA9PT0gZmFsc2UgfHwgIWlzTmFOKHYpKSB7CiAgICAgICAgcmV0dXJuIHY7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiAnIicgKyB2ICsgJyInOwogICAgfQp9CnZhciBjb252ZXJ0VG9Kc29uU3RyaW5nXzEgPSBjb252ZXJ0VG9Kc29uU3RyaW5nOwp2YXIgbm9kZTJqc29uX3N0ciA9IHsKICAgIGNvbnZlcnRUb0pzb25TdHJpbmc6IGNvbnZlcnRUb0pzb25TdHJpbmdfMQp9Owpjb25zdCBidWlsZE9wdGlvbnMkMyA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBkZWZhdWx0T3B0aW9ucyQyID0gewogICAgYXR0cmlidXRlTmFtZVByZWZpeDogIkBfIiwKICAgIGF0dHJOb2RlTmFtZTogZmFsc2UsCiAgICB0ZXh0Tm9kZU5hbWU6ICIjdGV4dCIsCiAgICBpZ25vcmVBdHRyaWJ1dGVzOiB0cnVlLAogICAgY2RhdGFUYWdOYW1lOiBmYWxzZSwKICAgIGNkYXRhUG9zaXRpb25DaGFyOiAiXFxjIiwKICAgIGZvcm1hdDogZmFsc2UsCiAgICBpbmRlbnRCeTogIiAgIiwKICAgIHN1cHJlc3NFbXB0eU5vZGU6IGZhbHNlLAogICAgdGFnVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBhdHRyVmFsdWVQcm9jZXNzb3I6IGZ1bmN0aW9uKGEpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0KfTsKY29uc3QgcHJvcHMkMiA9IFsKICAgICJhdHRyaWJ1dGVOYW1lUHJlZml4IiwKICAgICJhdHRyTm9kZU5hbWUiLAogICAgInRleHROb2RlTmFtZSIsCiAgICAiaWdub3JlQXR0cmlidXRlcyIsCiAgICAiY2RhdGFUYWdOYW1lIiwKICAgICJjZGF0YVBvc2l0aW9uQ2hhciIsCiAgICAiZm9ybWF0IiwKICAgICJpbmRlbnRCeSIsCiAgICAic3VwcmVzc0VtcHR5Tm9kZSIsCiAgICAidGFnVmFsdWVQcm9jZXNzb3IiLAogICAgImF0dHJWYWx1ZVByb2Nlc3NvciIsCiAgICAicm9vdE5vZGVOYW1lIgpdOwpmdW5jdGlvbiBQYXJzZXIob3B0aW9ucykgewogICAgdGhpcy5vcHRpb25zID0gYnVpbGRPcHRpb25zJDMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMkMiwgcHJvcHMkMik7CiAgICBpZiAodGhpcy5vcHRpb25zLmlnbm9yZUF0dHJpYnV0ZXMgfHwgdGhpcy5vcHRpb25zLmF0dHJOb2RlTmFtZSkgewogICAgICAgIHRoaXMuaXNBdHRyaWJ1dGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYXR0clByZWZpeExlbiA9IHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4Lmxlbmd0aDsKICAgICAgICB0aGlzLmlzQXR0cmlidXRlID0gaXNBdHRyaWJ1dGU7CiAgICB9CiAgICBpZiAodGhpcy5vcHRpb25zLmNkYXRhVGFnTmFtZSkgewogICAgICAgIHRoaXMuaXNDREFUQSA9IGlzQ0RBVEE7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaXNDREFUQSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgIH0KICAgIHRoaXMucmVwbGFjZUNEQVRBc3RyID0gcmVwbGFjZUNEQVRBc3RyOwogICAgdGhpcy5yZXBsYWNlQ0RBVEFhcnIgPSByZXBsYWNlQ0RBVEFhcnI7CiAgICB0aGlzLnByb2Nlc3NUZXh0T3JPYmpOb2RlID0gcHJvY2Vzc1RleHRPck9iak5vZGU7CiAgICBpZiAodGhpcy5vcHRpb25zLmZvcm1hdCkgewogICAgICAgIHRoaXMuaW5kZW50YXRlID0gaW5kZW50YXRlOwogICAgICAgIHRoaXMudGFnRW5kQ2hhciA9ICI+XG4iOwogICAgICAgIHRoaXMubmV3TGluZSA9ICJcbiI7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuaW5kZW50YXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9OwogICAgICAgIHRoaXMudGFnRW5kQ2hhciA9ICI+IjsKICAgICAgICB0aGlzLm5ld0xpbmUgPSAiIjsKICAgIH0KICAgIGlmICh0aGlzLm9wdGlvbnMuc3VwcmVzc0VtcHR5Tm9kZSkgewogICAgICAgIHRoaXMuYnVpbGRUZXh0Tm9kZSA9IGJ1aWxkRW1wdHlUZXh0Tm9kZTsKICAgICAgICB0aGlzLmJ1aWxkT2JqTm9kZSA9IGJ1aWxkRW1wdHlPYmpOb2RlOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmJ1aWxkVGV4dE5vZGUgPSBidWlsZFRleHRWYWxOb2RlOwogICAgICAgIHRoaXMuYnVpbGRPYmpOb2RlID0gYnVpbGRPYmplY3ROb2RlOwogICAgfQogICAgdGhpcy5idWlsZFRleHRWYWxOb2RlID0gYnVpbGRUZXh0VmFsTm9kZTsKICAgIHRoaXMuYnVpbGRPYmplY3ROb2RlID0gYnVpbGRPYmplY3ROb2RlOwp9ClBhcnNlci5wcm90b3R5cGUucGFyc2UgPSBmdW5jdGlvbihqT2JqKSB7CiAgICBpZiAoQXJyYXkuaXNBcnJheShqT2JqKSAmJiB0aGlzLm9wdGlvbnMucm9vdE5vZGVOYW1lICYmIHRoaXMub3B0aW9ucy5yb290Tm9kZU5hbWUubGVuZ3RoID4gMSkgewogICAgICAgIGpPYmogPSB7CiAgICAgICAgICAgIFt0aGlzLm9wdGlvbnMucm9vdE5vZGVOYW1lXTogak9iagogICAgICAgIH07CiAgICB9CiAgICByZXR1cm4gdGhpcy5qMngoak9iaiwgMCkudmFsOwp9OwpQYXJzZXIucHJvdG90eXBlLmoyeCA9IGZ1bmN0aW9uKGpPYmosIGxldmVsKSB7CiAgICBsZXQgYXR0clN0ciA9ICIiOwogICAgbGV0IHZhbCA9ICIiOwogICAgZm9yKGxldCBrZXkgaW4gak9iail7CiAgICAgICAgaWYgKHR5cGVvZiBqT2JqW2tleV0gPT09ICJ1bmRlZmluZWQiKSA7CiAgICAgICAgZWxzZSBpZiAoak9ialtrZXldID09PSBudWxsKSB7CiAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICAgICAgfSBlbHNlIGlmIChqT2JqW2tleV0gaW5zdGFuY2VvZiBEYXRlKSB7CiAgICAgICAgICAgIHZhbCArPSB0aGlzLmJ1aWxkVGV4dE5vZGUoak9ialtrZXldLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2Ygak9ialtrZXldICE9PSAib2JqZWN0IikgewogICAgICAgICAgICBjb25zdCBhdHRyID0gdGhpcy5pc0F0dHJpYnV0ZShrZXkpOwogICAgICAgICAgICBpZiAoYXR0cikgewogICAgICAgICAgICAgICAgYXR0clN0ciArPSAiICIgKyBhdHRyICsgJz0iJyArIHRoaXMub3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV0pICsgJyInOwogICAgICAgICAgICB9IGVsc2UgaWYgKHRoaXMuaXNDREFUQShrZXkpKSB7CiAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQXN0cihqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFzdHIoIiIsIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBpZiAoa2V5ID09PSB0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGpPYmpbdGhpcy5vcHRpb25zLmNkYXRhVGFnTmFtZV0pIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMub3B0aW9ucy50YWdWYWx1ZVByb2Nlc3NvcigiIiArIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGpPYmpba2V5XSwga2V5LCAiIiwgbGV2ZWwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGpPYmpba2V5XSkpIHsKICAgICAgICAgICAgaWYgKHRoaXMuaXNDREFUQShrZXkpKSB7CiAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5pbmRlbnRhdGUobGV2ZWwpOwogICAgICAgICAgICAgICAgaWYgKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFhcnIoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBYXJyKCIiLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgYXJyTGVuID0gak9ialtrZXldLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaiA9IDA7IGogPCBhcnJMZW47IGorKyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbSA9IGpPYmpba2V5XVtqXTsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICJ1bmRlZmluZWQiKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSBpZiAoaXRlbSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGl0ZW0gPT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnByb2Nlc3NUZXh0T3JPYmpOb2RlKGl0ZW0sIGtleSwgbGV2ZWwpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmJ1aWxkVGV4dE5vZGUoaXRlbSwga2V5LCAiIiwgbGV2ZWwpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lICYmIGtleSA9PT0gdGhpcy5vcHRpb25zLmF0dHJOb2RlTmFtZSkgewogICAgICAgICAgICAgICAgY29uc3QgS3MgPSBPYmplY3Qua2V5cyhqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgY29uc3QgTCA9IEtzLmxlbmd0aDsKICAgICAgICAgICAgICAgIGZvcihsZXQgaiA9IDA7IGogPCBMOyBqKyspewogICAgICAgICAgICAgICAgICAgIGF0dHJTdHIgKz0gIiAiICsgS3Nbal0gKyAnPSInICsgdGhpcy5vcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcigiIiArIGpPYmpba2V5XVtLc1tqXV0pICsgJyInOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUoak9ialtrZXldLCBrZXksIGxldmVsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB7CiAgICAgICAgYXR0clN0ciwKICAgICAgICB2YWwKICAgIH07Cn07CmZ1bmN0aW9uIHByb2Nlc3NUZXh0T3JPYmpOb2RlKG9iamVjdCwga2V5LCBsZXZlbCkgewogICAgY29uc3QgcmVzdWx0ID0gdGhpcy5qMngob2JqZWN0LCBsZXZlbCArIDEpOwogICAgaWYgKG9iamVjdFt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSAhPT0gdm9pZCAwICYmIE9iamVjdC5rZXlzKG9iamVjdCkubGVuZ3RoID09PSAxKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRUZXh0Tm9kZShyZXN1bHQudmFsLCBrZXksIHJlc3VsdC5hdHRyU3RyLCBsZXZlbCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkT2JqTm9kZShyZXN1bHQudmFsLCBrZXksIHJlc3VsdC5hdHRyU3RyLCBsZXZlbCk7CiAgICB9Cn0KZnVuY3Rpb24gcmVwbGFjZUNEQVRBc3RyKHN0ciwgY2RhdGEpIHsKICAgIHN0ciA9IHRoaXMub3B0aW9ucy50YWdWYWx1ZVByb2Nlc3NvcigiIiArIHN0cik7CiAgICBpZiAodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyID09PSAiIiB8fCBzdHIgPT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHN0ciArICI8IVtDREFUQVsiICsgY2RhdGEgKyAiXV0iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gc3RyLnJlcGxhY2UodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyLCAiPCFbQ0RBVEFbIiArIGNkYXRhICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcik7CiAgICB9Cn0KZnVuY3Rpb24gcmVwbGFjZUNEQVRBYXJyKHN0ciwgY2RhdGEpIHsKICAgIHN0ciA9IHRoaXMub3B0aW9ucy50YWdWYWx1ZVByb2Nlc3NvcigiIiArIHN0cik7CiAgICBpZiAodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyID09PSAiIiB8fCBzdHIgPT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHN0ciArICI8IVtDREFUQVsiICsgY2RhdGEuam9pbigiXV0+PCFbQ0RBVEFbIikgKyAiXV0iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICBmb3IobGV0IHYgaW4gY2RhdGEpewogICAgICAgICAgICBzdHIgPSBzdHIucmVwbGFjZSh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIsICI8IVtDREFUQVsiICsgY2RhdGFbdl0gKyAiXV0+Iik7CiAgICAgICAgfQogICAgICAgIHJldHVybiBzdHIgKyB0aGlzLm5ld0xpbmU7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRPYmplY3ROb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKGF0dHJTdHIgJiYgdmFsLmluZGV4T2YoIjwiKSA9PT0gLTEpIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICI+IiArIHZhbCArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgdGhpcy50YWdFbmRDaGFyICsgdmFsICsgdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwvIiArIGtleSArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBidWlsZEVtcHR5T2JqTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmICh2YWwgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRPYmplY3ROb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkVGV4dFZhbE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICI+IiArIHRoaXMub3B0aW9ucy50YWdWYWx1ZVByb2Nlc3Nvcih2YWwpICsgIjwvIiArIGtleSArIHRoaXMudGFnRW5kQ2hhcjsKfQpmdW5jdGlvbiBidWlsZEVtcHR5VGV4dE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAodmFsICE9PSAiIikgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkVGV4dFZhbE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gaW5kZW50YXRlKGxldmVsKSB7CiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmluZGVudEJ5LnJlcGVhdChsZXZlbCk7Cn0KZnVuY3Rpb24gaXNBdHRyaWJ1dGUobmFtZSkgewogICAgaWYgKG5hbWUuc3RhcnRzV2l0aCh0aGlzLm9wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeCkpIHsKICAgICAgICByZXR1cm4gbmFtZS5zdWJzdHIodGhpcy5hdHRyUHJlZml4TGVuKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQp9CmZ1bmN0aW9uIGlzQ0RBVEEobmFtZSkgewogICAgcmV0dXJuIG5hbWUgPT09IHRoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWU7Cn0KdmFyIGpzb24yeG1sID0gUGFyc2VyOwp2YXIgcGFyc2VyID0gY3JlYXRlQ29tbW9uanNNb2R1bGUoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CiAgICBjb25zdCB4MnhtbG5vZGUgPSB4bWxzdHIyeG1sbm9kZTsKICAgIGNvbnN0IGJ1aWxkT3B0aW9uczIgPSB1dGlsLmJ1aWxkT3B0aW9uczsKICAgIGV4cG9ydHMucGFyc2UgPSBmdW5jdGlvbih4bWxEYXRhLCBnaXZlbk9wdGlvbnMgPSB7CiAgICB9LCB2YWxpZGF0aW9uT3B0aW9uKSB7CiAgICAgICAgaWYgKHZhbGlkYXRpb25PcHRpb24pIHsKICAgICAgICAgICAgaWYgKHZhbGlkYXRpb25PcHRpb24gPT09IHRydWUpIHZhbGlkYXRpb25PcHRpb24gPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHZhbGlkYXRvci52YWxpZGF0ZSh4bWxEYXRhLCB2YWxpZGF0aW9uT3B0aW9uKTsKICAgICAgICAgICAgaWYgKHJlc3VsdCAhPT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgdGhyb3cgRXJyb3IocmVzdWx0LmVyci5tc2cpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmIChnaXZlbk9wdGlvbnMucGFyc2VUcnVlTnVtYmVyT25seSAmJiBnaXZlbk9wdGlvbnMucGFyc2VOb2RlVmFsdWUgIT09IGZhbHNlICYmICFnaXZlbk9wdGlvbnMubnVtUGFyc2VPcHRpb25zKSB7CiAgICAgICAgICAgIGdpdmVuT3B0aW9ucy5udW1QYXJzZU9wdGlvbnMgPSB7CiAgICAgICAgICAgICAgICBsZWFkaW5nWmVyb3M6IGZhbHNlCiAgICAgICAgICAgIH07CiAgICAgICAgfQogICAgICAgIGxldCBvcHRpb25zID0gYnVpbGRPcHRpb25zMihnaXZlbk9wdGlvbnMsIHgyeG1sbm9kZS5kZWZhdWx0T3B0aW9ucywgeDJ4bWxub2RlLnByb3BzKTsKICAgICAgICBjb25zdCB0cmF2ZXJzYWJsZU9iaiA9IHhtbHN0cjJ4bWxub2RlLmdldFRyYXZlcnNhbE9iaih4bWxEYXRhLCBvcHRpb25zKTsKICAgICAgICByZXR1cm4gbm9kZTJqc29uLmNvbnZlcnRUb0pzb24odHJhdmVyc2FibGVPYmosIG9wdGlvbnMpOwogICAgfTsKICAgIGV4cG9ydHMuY29udmVydFRvbmltbiA9IG5pbW5kYXRhLmNvbnZlcnQybmltbjsKICAgIGV4cG9ydHMuZ2V0VHJhdmVyc2FsT2JqID0geG1sc3RyMnhtbG5vZGUuZ2V0VHJhdmVyc2FsT2JqOwogICAgZXhwb3J0cy5jb252ZXJ0VG9Kc29uID0gbm9kZTJqc29uLmNvbnZlcnRUb0pzb247CiAgICBleHBvcnRzLmNvbnZlcnRUb0pzb25TdHJpbmcgPSBub2RlMmpzb25fc3RyLmNvbnZlcnRUb0pzb25TdHJpbmc7CiAgICBleHBvcnRzLnZhbGlkYXRlID0gdmFsaWRhdG9yLnZhbGlkYXRlOwogICAgZXhwb3J0cy5qMnhQYXJzZXIgPSBqc29uMnhtbDsKICAgIGV4cG9ydHMucGFyc2VUb05pbW4gPSBmdW5jdGlvbih4bWxEYXRhLCBzY2hlbWEsIG9wdGlvbnMpIHsKICAgICAgICByZXR1cm4gZXhwb3J0cy5jb252ZXJ0VG9uaW1uKGV4cG9ydHMuZ2V0VHJhdmVyc2FsT2JqKHhtbERhdGEsIG9wdGlvbnMpLCBzY2hlbWEsIG9wdGlvbnMpOwogICAgfTsKfSk7CnBhcnNlci5jb252ZXJ0VG9Kc29uOwpwYXJzZXIuY29udmVydFRvSnNvblN0cmluZzsKcGFyc2VyLmNvbnZlcnRUb25pbW47CnZhciBnZXRUcmF2ZXJzYWxPYmokMSA9IHBhcnNlci5nZXRUcmF2ZXJzYWxPYmo7CnBhcnNlci5qMnhQYXJzZXI7CnBhcnNlci5wYXJzZTsKcGFyc2VyLnBhcnNlVG9OaW1uOwpwYXJzZXIudmFsaWRhdGU7CmNsYXNzIFRoZW1lIHsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IyMDBIZXggPSAnIzY5YjdmZic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMzAwSGV4ID0gJyMwMDg4RkYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjkwMEhleCA9ICcjMDA1Y2NiJzsKICAgIHN0YXRpYyBiYWNrZ3JvdW5kQ29sb3JIZXggPSAnIzEyMTIxMic7CiAgICBzdGF0aWMgdGV4dENvbG9ySGV4ID0gJyNlYmViZWInOwogICAgc3RhdGljIHRleHRDb2xvclNlY29uZGFyeUhleCA9ICcjODg4ODg4JzsKICAgIHN0YXRpYyBzYW5zU2VyaWZGb250RmFtaWx5ID0gJy1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgYXZlbmlyIG5leHQsIGF2ZW5pciwgaGVsdmV0aWNhIG5ldWUsIGhlbHZldGljYSwgVWJ1bnR1LCByb2JvdG8sIG5vdG8sIHNlZ29lIHVpLCBhcmlhbCwgc2Fucy1zZXJpZic7CiAgICBzdGF0aWMgbW9ub3NwYWNlRm9udEZhbWlseSA9ICdNZW5sbywgIlNGIE1vbm8iLCAiQW5kYWxlIE1vbm8iLCAiUm9ib3RvIE1vbm8iLCBNb25hY28sIG1vbm9zcGFjZSc7Cn0KZnVuY3Rpb24gY2hlY2tNYXRjaGVzKG5hbWUsIHZhbHVlLCBwYXR0ZXJuKSB7CiAgICBpZiAoIXBhdHRlcm4udGVzdCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9YCk7CiAgICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gY2hlY2tFcXVhbChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWQpIHsKICAgIGlmICh2YWx1ZSAhPT0gZXhwZWN0ZWQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9LCBleHBlY3RlZCAke2V4cGVjdGVkfWApOwp9CmZ1bmN0aW9uIGNoZWNrVHJ1ZShuYW1lLCB2YWx1ZSwgdGVzdCkgewogICAgaWYgKCF0ZXN0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwp9CmZ1bmN0aW9uIGlzUmVhZG9ubHlBcnJheShhcmcpIHsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KGFyZyk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybCh1cmwsIHN1YmplY3QsIG9wdHMpIHsKICAgIGNvbnN0IHJvb3RDb21tZW50ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKTsKICAgIGlmICghcm9vdENvbW1lbnQpIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBjb21tZW50ZXJzID0gYXdhaXQgY29sbGVjdENvbW1lbnRlcnMocm9vdENvbW1lbnQsIG9wdHMpOwogICAgcmV0dXJuIHsKICAgICAgICBzdWJqZWN0LAogICAgICAgIHJvb3RDb21tZW50LAogICAgICAgIGNvbW1lbnRlcnMKICAgIH07Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRDb3VudChjb21tZW50KSB7CiAgICByZXR1cm4gMSArIGNvbW1lbnQucmVwbGllcy5tYXAoY29tcHV0ZUNvbW1lbnRDb3VudCkucmVkdWNlKChhLCBiKT0+YSArIGIKICAgICwgMCk7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3Qgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFvYmopIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBub3RlT3JQb2RjYXN0RXBpc29kZSA9IG9iajsKICAgIGNvbnN0IHJvb3RDb21tZW50ID0gaW5pdENvbW1lbnRGcm9tT2JqZWN0T3JMaW5rKG5vdGVPclBvZGNhc3RFcGlzb2RlKTsKICAgIGF3YWl0IGNvbGxlY3RDb21tZW50cyhub3RlT3JQb2RjYXN0RXBpc29kZSwgcm9vdENvbW1lbnQsIG9wdHMsIHVybCk7CiAgICByZXR1cm4gcm9vdENvbW1lbnQ7Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdENvbW1lbnRzKG5vdGUsIGNvbW1lbnQsIG9wdHMsIHVybCkgewogICAgY29uc3QgeyBrZWVwR29pbmcgLCBmZXRjaEFjdGl2aXR5UHViICB9ID0gb3B0czsKICAgIGNvbnN0IGZldGNoZWQgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBwb2RjYXN0RXBpc29kZUNvbW1lbnRzID0gbm90ZS50eXBlID09PSAnUG9kY2FzdEVwaXNvZGUnID8gbm90ZS5jb21tZW50cyA6IG5vdGUucmVwbGllczsKICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zdCB1cmwgPSBwb2RjYXN0RXBpc29kZUNvbW1lbnRzOwogICAgICAgICAgICBjb25zdCBvYmogPSBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgaWYgKCFvYmopIHJldHVybjsKICAgICAgICAgICAgZmV0Y2hlZC5hZGQodXJsKTsKICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgaWYgKG9iai50eXBlID09PSAnT3JkZXJlZENvbGxlY3Rpb24nKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvcmRlcmVkQ29sbGVjdGlvbiA9IG9iajsKICAgICAgICAgICAgICAgIGlmICgob3JkZXJlZENvbGxlY3Rpb24uaXRlbXM/Lmxlbmd0aCB8fCAwKSA+IDAgfHwgKG9yZGVyZWRDb2xsZWN0aW9uLm9yZGVyZWRJdGVtcz8ubGVuZ3RoIHx8IDApID4gMCkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb3JkZXJlZENvbGxlY3Rpb24uaXRlbXMvb3JkZXJlZEl0ZW1zIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3JkZXJlZENvbGxlY3Rpb24uZmlyc3QgPT09IHVuZGVmaW5lZCAmJiBvcmRlcmVkQ29sbGVjdGlvbi50b3RhbEl0ZW1zID09PSAwKSB7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBmZXRjaFBhZ2VzKG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0LCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvYmoudHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdCA9PT0gJ29iamVjdCcgJiYgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnKSB7CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcyAmJiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lml0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZldGNoUGFnZXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0LCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0Lm5leHQgbm90IGltcGxlbWVudGVkICR7cG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0fWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3QgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0fWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBmaXJzdCBub3QgZm91bmQsIGltcGxlbWVudCBpdGVtc2ApOwogICAgICAgIH0KICAgIH0KfQphc3luYyBmdW5jdGlvbiBmZXRjaFBhZ2VzKHVybCwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCkgewogICAgY29uc3QgeyBmZXRjaEFjdGl2aXR5UHViICwga2VlcEdvaW5nICB9ID0gb3B0czsKICAgIGxldCBvYmogPSBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICBpZiAoIW9iaikgcmV0dXJuOwogICAgZmV0Y2hlZC5hZGQodXJsKTsKICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICBsZXQga2VlcENvbGxlY3RpbmcgPSB0cnVlOwogICAgd2hpbGUoa2VlcENvbGxlY3RpbmcpewogICAgICAgIGlmIChvYmoudHlwZSAhPT0gJ0NvbGxlY3Rpb25QYWdlJyAmJiBvYmoudHlwZSAhPT0gJ09yZGVyZWRDb2xsZWN0aW9uUGFnZScpIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBwYWdlIG9iai50eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iail9YCk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHBhZ2UgPSBvYmoudHlwZSA9PT0gJ0NvbGxlY3Rpb25QYWdlJyA/IG9iaiA6IG9iajsKICAgICAgICBpZiAocGFnZS5pdGVtcykgewogICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocGFnZS5pdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZS50eXBlID09PSAnT3JkZXJlZENvbGxlY3Rpb25QYWdlJyAmJiBwYWdlLm9yZGVyZWRJdGVtcykgewogICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocGFnZS5vcmRlcmVkSXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCk7CiAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHBhZ2UubmV4dCkgewogICAgICAgICAgICBpZiAodHlwZW9mIHBhZ2UubmV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIGlmIChmZXRjaGVkLmhhcyhwYWdlLm5leHQpKSB7CiAgICAgICAgICAgICAgICAgICAga2VlcENvbGxlY3RpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdXJsID0gcGFnZS5uZXh0OwogICAgICAgICAgICAgICAgICAgIG9iaiA9IGF3YWl0IGZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgaWYgKCFvYmopIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBwYWdlLm5leHQgbm90IGltcGxlbWVudGVkICR7cGFnZS5uZXh0fWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAga2VlcENvbGxlY3RpbmcgPSBmYWxzZTsKICAgICAgICB9CiAgICB9Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdEl0ZW1zKGl0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpIHsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcyl7CiAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJyAmJiAhaXRlbS5zdGFydHNXaXRoKCd7JykpIHsKICAgICAgICAgICAgY29uc3QgcmVwbHkgPSBhd2FpdCBmZXRjaENvbW1lbnRzRm9yVXJsXyhpdGVtLCBvcHRzKTsKICAgICAgICAgICAgaWYgKHJlcGx5KSB7CiAgICAgICAgICAgICAgICBjb21tZW50LnJlcGxpZXMucHVzaChyZXBseSk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpdGVtT2JqID0gdHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnID8gSlNPTi5wYXJzZShpdGVtKSA6IGl0ZW07CiAgICAgICAgICAgIGNvbnN0IHJlcGx5ID0gaW5pdENvbW1lbnRGcm9tT2JqZWN0T3JMaW5rKGl0ZW1PYmopOwogICAgICAgICAgICBjb21tZW50LnJlcGxpZXMucHVzaChyZXBseSk7CiAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgIG9wdHMud2FybihyZXBseSwgdXJsLCAnRm91bmQgaXRlbSBpbmNvcnJlY3RseSBkb3VibGUgZW5jb2RlZCBhcyBhIGpzb24gc3RyaW5nJyk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgYXdhaXQgY29sbGVjdENvbW1lbnRzKGl0ZW0sIHJlcGx5LCBvcHRzLCB1cmwpOwogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsob2JqZWN0KSB7CiAgICBpZiAob2JqZWN0LnR5cGUgPT09ICdOb3RlJykgewogICAgICAgIGNvbnN0IHsgYXR0cmlidXRlZFRvICwgY29udGVudCAsIHB1Ymxpc2hlZCAsIHVybCAgfSA9IG9iamVjdDsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZWRUbyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogTm90ZS5hdHRyaWJ1dGVkVG8gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogTm90ZS5jb250ZW50IHR5cGUgbm90IGltcGxlbWVudGVkICR7dHlwZW9mIGNvbnRlbnR9ICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIHB1Ymxpc2hlZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogTm90ZS5wdWJsaXNoZWQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGlmICh1cmwgIT09IHVuZGVmaW5lZCAmJiB0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLnVybCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgY29uc3QgYXR0YWNobWVudHMgPSBjb21wdXRlQXR0YWNobWVudHMob2JqZWN0KTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGF0dHJpYnV0ZWRUbywKICAgICAgICAgICAgY29udGVudCwKICAgICAgICAgICAgcHVibGlzaGVkLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHMKICAgICAgICB9OwogICAgfQogICAgaWYgKG9iamVjdC50eXBlID09PSAnUG9kY2FzdEVwaXNvZGUnKSB7CiAgICAgICAgY29uc3QgcG9kY2FzdEVwaXNvZGUgPSBvYmplY3Q7CiAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gLCBwdWJsaXNoZWQgLCBkZXNjcmlwdGlvbiAsIGltYWdlICB9ID0gcG9kY2FzdEVwaXNvZGU7CiAgICAgICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVkVG8gIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IFBvZGNhc3RFcGlzb2RlLmF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBwdWJsaXNoZWQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IFBvZGNhc3RFcGlzb2RlLnB1Ymxpc2hlZCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBkZXNjcmlwdGlvbiAhPT0gJ29iamVjdCcgfHwgZGVzY3JpcHRpb24udHlwZSAhPT0gJ05vdGUnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IFBvZGNhc3RFcGlzb2RlLmRlc2NyaXB0aW9uIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBjb25zdCB7IGNvbnRlbnQgIH0gPSBkZXNjcmlwdGlvbjsKICAgICAgICBpZiAodHlwZW9mIGNvbnRlbnQgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IFBvZGNhc3RFcGlzb2RlLmNvbnRlbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHt0eXBlb2YgY29udGVudH0gJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IHVybCA9IHVuZGVmaW5lZDsKICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IGltYWdlID8gWwogICAgICAgICAgICBjb21wdXRlQXR0YWNobWVudChpbWFnZSkKICAgICAgICBdIDogW107CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICBhdHRyaWJ1dGVkVG8sCiAgICAgICAgICAgIGNvbnRlbnQsCiAgICAgICAgICAgIHB1Ymxpc2hlZCwKICAgICAgICAgICAgcmVwbGllczogW10sCiAgICAgICAgICAgIGF0dGFjaG1lbnRzCiAgICAgICAgfTsKICAgIH0KICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogaXRlbSB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dGFjaG1lbnRzKG9iamVjdCkgewogICAgY29uc3QgcnQgPSBbXTsKICAgIGlmICghb2JqZWN0LmF0dGFjaG1lbnQpIHJldHVybiBydDsKICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gaXNSZWFkb25seUFycmF5KG9iamVjdC5hdHRhY2htZW50KSA/IG9iamVjdC5hdHRhY2htZW50IDogWwogICAgICAgIG9iamVjdC5hdHRhY2htZW50CiAgICBdOwogICAgZm9yIChjb25zdCBhdHRhY2htZW50IG9mIGF0dGFjaG1lbnRzKXsKICAgICAgICBydC5wdXNoKGNvbXB1dGVBdHRhY2htZW50KGF0dGFjaG1lbnQpKTsKICAgIH0KICAgIHJldHVybiBydDsKfQpmdW5jdGlvbiBjb21wdXRlQXR0YWNobWVudChvYmplY3QpIHsKICAgIGlmICh0eXBlb2Ygb2JqZWN0ICE9PSAnb2JqZWN0JyB8fCBvYmplY3QudHlwZSAhPT0gJ0RvY3VtZW50JyAmJiBvYmplY3QudHlwZSAhPT0gJ0ltYWdlJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBhdHRhY2htZW50IHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGNvbnN0IHsgbWVkaWFUeXBlICwgd2lkdGggLCBoZWlnaHQgLCB1cmwgIH0gPSBvYmplY3Q7CiAgICBpZiAodHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogbWVkaWFUeXBlIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGlmICh3aWR0aCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB3aWR0aCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcihgVE9ETzogd2lkdGggdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKGhlaWdodCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiBoZWlnaHQgIT09ICdudW1iZXInKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGhlaWdodCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogdXJsIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIHJldHVybiB7CiAgICAgICAgbWVkaWFUeXBlLAogICAgICAgIHdpZHRoLAogICAgICAgIGhlaWdodCwKICAgICAgICB1cmwKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdENvbW1lbnRlcnMoY29tbWVudCwgb3B0cykgewogICAgY29uc3QgYXR0cmlidXRlZFRvcyA9IG5ldyBTZXQoKTsKICAgIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKGNvbW1lbnQsIGF0dHJpYnV0ZWRUb3MpOwogICAgY29uc3QgcnQgPSBuZXcgTWFwKCk7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZWRUbyBvZiBhdHRyaWJ1dGVkVG9zKXsKICAgICAgICBjb25zdCBjb21tZW50ZXIgPSBhd2FpdCBmZXRjaENvbW1lbnRlcihhdHRyaWJ1dGVkVG8sIG9wdHMpOwogICAgICAgIGlmICghY29tbWVudGVyKSByZXR1cm4gcnQ7CiAgICAgICAgcnQuc2V0KGF0dHJpYnV0ZWRUbywgY29tbWVudGVyKTsKICAgIH0KICAgIHJldHVybiBydDsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRlcih1cmwsIG9wdHMpIHsKICAgIGNvbnN0IG9iaiA9IGF3YWl0IG9wdHMuZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFvYmopIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBwZXJzb24gPSBvYmo7CiAgICByZXR1cm4gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pOwp9CmZ1bmN0aW9uIGNvbXB1dGVDb21tZW50ZXIocGVyc29uKSB7CiAgICBpZiAodHlwZW9mIHBlcnNvbi5pY29uICE9PSAnb2JqZWN0JyB8fCBpc1JlYWRvbmx5QXJyYXkocGVyc29uLmljb24pIHx8IHBlcnNvbi5pY29uLnR5cGUgIT09ICdJbWFnZScpIHRocm93IG5ldyBFcnJvcihgVE9ETyBwZXJzb24uaWNvbiBub3QgaW1wbGVtZW50ZWQ6ICR7cGVyc29uLmljb259YCk7CiAgICBjb25zdCBpY29uID0gY29tcHV0ZUljb24ocGVyc29uLmljb24pOwogICAgY29uc3QgeyBuYW1lICwgdXJsICB9ID0gcGVyc29uOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5uYW1lIG5vdCBpbXBsZW1lbnRlZDogJHtuYW1lfWApOwogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLnVybCBub3QgaW1wbGVtZW50ZWQ6ICR7dXJsfWApOwogICAgY29uc3QgZnFVc2VybmFtZSA9IGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcGVyc29uLnByZWZlcnJlZFVzZXJuYW1lKTsKICAgIHJldHVybiB7CiAgICAgICAgaWNvbiwKICAgICAgICBuYW1lLAogICAgICAgIHVybCwKICAgICAgICBmcVVzZXJuYW1lCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGljb24pIHsKICAgIGNvbnN0IHsgdXJsICwgbWVkaWFUeXBlICB9ID0gaWNvbjsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIGljb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBpZiAobWVkaWFUeXBlICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBpY29uLm1lZGlhVHlwZSBub3QgaW1wbGVtZW50ZWQ6ICR7bWVkaWFUeXBlfWApOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWVkaWFUeXBlCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcHJlZmVycmVkVXNlcm5hbWUpIHsKICAgIGNvbnN0IHUgPSBuZXcgVVJMKHVybCk7CiAgICBjb25zdCBtID0gL15cLyhAW15cL10rKSQvLmV4ZWModS5wYXRobmFtZSk7CiAgICBjb25zdCB1c2VybmFtZSA9IG0gPyBtWzFdIDogcHJlZmVycmVkVXNlcm5hbWU7CiAgICBpZiAoIXVzZXJuYW1lKSB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBjb21wdXRlIHVzZXJuYW1lIGZyb20gdXJsOiAke3VybH1gKTsKICAgIHJldHVybiBgJHt1c2VybmFtZX1AJHt1Lmhvc3RuYW1lfWA7Cn0KZnVuY3Rpb24gY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcykgewogICAgYXR0cmlidXRlZFRvcy5hZGQoY29tbWVudC5hdHRyaWJ1dGVkVG8pOwogICAgZm9yIChjb25zdCByZXBseSBvZiBjb21tZW50LnJlcGxpZXMpewogICAgICAgIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKHJlcGx5LCBhdHRyaWJ1dGVkVG9zKTsKICAgIH0KfQpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRSA9ICdodHRwczovL3BvZGNhc3RpbmRleC5vcmcvbmFtZXNwYWNlLzEuMCc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0FMVCA9ICdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQnOwpjb25zdCBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMgPSBbCiAgICBQT0RDQVNUX0lOREVYX05BTUVTUEFDRSwKICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0FMVApdOwpjb25zdCBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTID0gbmV3IFNldCgpOwpmdW5jdGlvbiBfcG9kY2FzdEluZGV4KG5hbWUsIGtub3duID0gdHJ1ZSkgewogICAgaWYgKGtub3duKSBQT0RDQVNUX0lOREVYX0tOT1dOX05BTUVTLmFkZChuYW1lKTsKICAgIHJldHVybiBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMubWFwKCh2KT0+KHsKICAgICAgICAgICAgbmFtZSwKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICk7Cn0KY29uc3QgTUVESUFfUlNTX05BTUVTUEFDRSA9ICdodHRwOi8vc2VhcmNoLnlhaG9vLmNvbS9tcnNzLyc7CmZ1bmN0aW9uIF9tZWRpYVJzcyhuYW1lKSB7CiAgICByZXR1cm4gewogICAgICAgIG5hbWUsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBNRURJQV9SU1NfTkFNRVNQQUNFCiAgICB9Owp9CmNsYXNzIFFuYW1lcyB7CiAgICBzdGF0aWMgUG9kY2FzdEluZGV4ID0gewogICAgICAgIE5BTUVTUEFDRVM6IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUywKICAgICAgICBnZXQgS05PV05fTkFNRVMgKCkgewogICAgICAgICAgICByZXR1cm4gUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUzsKICAgICAgICB9LAogICAgICAgIG9mOiAobmFtZSk9Pl9wb2RjYXN0SW5kZXgobmFtZSwgZmFsc2UpCiAgICAgICAgLAogICAgICAgIHNvdXJjZTogX3BvZGNhc3RJbmRleCgnc291cmNlJyksCiAgICAgICAgc29jaWFsSW50ZXJhY3Q6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbEludGVyYWN0JyksCiAgICAgICAgZ3VpZDogX3BvZGNhc3RJbmRleCgnZ3VpZCcpLAogICAgICAgIGxvY2tlZDogX3BvZGNhc3RJbmRleCgnbG9ja2VkJyksCiAgICAgICAgdHJhbnNjcmlwdDogX3BvZGNhc3RJbmRleCgndHJhbnNjcmlwdCcpLAogICAgICAgIGZ1bmRpbmc6IF9wb2RjYXN0SW5kZXgoJ2Z1bmRpbmcnKSwKICAgICAgICBjaGFwdGVyczogX3BvZGNhc3RJbmRleCgnY2hhcHRlcnMnKSwKICAgICAgICBzb3VuZGJpdGU6IF9wb2RjYXN0SW5kZXgoJ3NvdW5kYml0ZScpLAogICAgICAgIHBlcnNvbjogX3BvZGNhc3RJbmRleCgncGVyc29uJyksCiAgICAgICAgbG9jYXRpb246IF9wb2RjYXN0SW5kZXgoJ2xvY2F0aW9uJyksCiAgICAgICAgc2Vhc29uOiBfcG9kY2FzdEluZGV4KCdzZWFzb24nKSwKICAgICAgICBlcGlzb2RlOiBfcG9kY2FzdEluZGV4KCdlcGlzb2RlJyksCiAgICAgICAgdHJhaWxlcjogX3BvZGNhc3RJbmRleCgndHJhaWxlcicpLAogICAgICAgIGxpY2Vuc2U6IF9wb2RjYXN0SW5kZXgoJ2xpY2Vuc2UnKSwKICAgICAgICBhbHRlcm5hdGVFbmNsb3N1cmU6IF9wb2RjYXN0SW5kZXgoJ2FsdGVybmF0ZUVuY2xvc3VyZScpLAogICAgICAgIGludGVncml0eTogX3BvZGNhc3RJbmRleCgnaW50ZWdyaXR5JyksCiAgICAgICAgdmFsdWU6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlJyksCiAgICAgICAgdmFsdWVSZWNpcGllbnQ6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlUmVjaXBpZW50JykKICAgIH07CiAgICBzdGF0aWMgTWVkaWFSc3MgPSB7CiAgICAgICAgTkFNRVNQQUNFOiBNRURJQV9SU1NfTkFNRVNQQUNFLAogICAgICAgIG9mOiAobmFtZSk9Pl9tZWRpYVJzcyhuYW1lKQogICAgICAgICwKICAgICAgICBjb250ZW50OiBfbWVkaWFSc3MoJ2NvbnRlbnQnKQogICAgfTsKfQpmdW5jdGlvbiBwYXJzZVhtbCh4bWwpIHsKICAgIGNvbnN0IHJ0ID0gZ2V0VHJhdmVyc2FsT2JqJDEoeG1sLCB7CiAgICAgICAgaWdub3JlQXR0cmlidXRlczogZmFsc2UsCiAgICAgICAgcGFyc2VBdHRyaWJ1dGVWYWx1ZTogZmFsc2UsCiAgICAgICAgcGFyc2VOb2RlVmFsdWU6IGZhbHNlCiAgICB9KTsKICAgIGNvbnN0IG5hbWVzcGFjZXMgPSBuZXcgWG1sTmFtZXNwYWNlcygpOwogICAgYXBwbHlRbmFtZXMocnQsIG5hbWVzcGFjZXMpOwogICAgY2hlY2tFcXVhbCgnbmFtZXNwYWNlcy5zdGFja1NpemUnLCBuYW1lc3BhY2VzLnN0YWNrU2l6ZSwgMCk7CiAgICByZXR1cm4gcnQ7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCkgewogICAgbGV0IG1hcDsKICAgIGlmIChhdHRyc01hcCkgewogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhdHRyc01hcCkpewogICAgICAgICAgICBpZiAoIW5hbWUuc3RhcnRzV2l0aCgnQF8nKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgYXR0cnNNYXAgbmFtZTogJHtuYW1lfSwgJHthdHRyc01hcH1gKTsKICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgbWFwLnNldChuYW1lLnN1YnN0cmluZygyKSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBtYXAgfHwgRU1QVFlfU1RSSU5HX01BUDsKfQpmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5xbmFtZXMpIHsKICAgIGxldCBydDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBxbmFtZSBvZiBxbmFtZXMpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgICAgICBpZiAocW5hbWUubmFtZSA9PT0gJyonID8gcW5hbWUubmFtZXNwYWNlVXJpID09PSBleHRDaGlsZC5xbmFtZS5uYW1lc3BhY2VVcmkgOiBxbmFtZUVxKHFuYW1lLCBleHRDaGlsZC5xbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBydCA9IHJ0IHx8IFtdOwogICAgICAgICAgICAgICAgICAgIHJ0LnB1c2goZXh0Q2hpbGQpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHJ0IHx8IEVNUFRZX1hNTF9OT0RFX0FSUkFZOwp9CmZ1bmN0aW9uIGZpbmRFbGVtZW50UmVjdXJzaXZlKHJvb3QsIHRlc3QpIHsKICAgIGlmICh0ZXN0KHJvb3QpKSByZXR1cm4gcm9vdDsKICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhyb290LmNoaWxkKSl7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIGNvbnN0IGV4dENoaWxkID0gY2hpbGQ7CiAgICAgICAgICAgIGNvbnN0IHJ0ID0gZmluZEVsZW1lbnRSZWN1cnNpdmUoZXh0Q2hpbGQsIHRlc3QpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIHFuYW1lRXEobGhzLCByaHMpIHsKICAgIHJldHVybiBsaHMubmFtZSA9PT0gcmhzLm5hbWUgJiYgbGhzLm5hbWVzcGFjZVVyaSA9PT0gcmhzLm5hbWVzcGFjZVVyaTsKfQpmdW5jdGlvbiBxbmFtZXNJbmNsdWRlKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLnNvbWUoKHYpPT5xbmFtZUVxKHYsIHJocykKICAgICk7Cn0KY29uc3QgRU1QVFlfU1RSSU5HX01BUCA9IG5ldyBNYXAoKTsKY29uc3QgRU1QVFlfWE1MX05PREVfQVJSQVkgPSBbXTsKZnVuY3Rpb24gYXBwbHlRbmFtZXMobm9kZSwgbmFtZXNwYWNlcykgewogICAgdHJ5IHsKICAgICAgICBjb25zdCBhdHRzID0gbmFtZXNwYWNlcy5wdXNoKG5vZGUuYXR0cnNNYXApOwogICAgICAgIGNvbnN0IG5vZGVBc0FueSA9IG5vZGU7CiAgICAgICAgbm9kZUFzQW55LmF0dHMgPSBhdHRzOwogICAgICAgIG5vZGVBc0FueS5xbmFtZSA9IGNvbXB1dGVRbmFtZShub2RlLnRhZ25hbWUsIG5hbWVzcGFjZXMpOwogICAgICAgIGZvciAoY29uc3QgdmFsdWUgb2YgT2JqZWN0LnZhbHVlcyhub2RlLmNoaWxkKSl7CiAgICAgICAgICAgIGZvciAoY29uc3QgY2hpbGROb2RlIG9mIHZhbHVlKXsKICAgICAgICAgICAgICAgIGFwcGx5UW5hbWVzKGNoaWxkTm9kZSwgbmFtZXNwYWNlcyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGZpbmFsbHl7CiAgICAgICAgbmFtZXNwYWNlcy5wb3AoKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlUW5hbWUobmFtZVdpdGhPcHRpb25hbFByZWZpeCwgbmFtZXNwYWNlcykgewogICAgY29uc3QgaSA9IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXguaW5kZXhPZignOicpOwogICAgaWYgKGkgPCAwKSByZXR1cm4gewogICAgICAgIG5hbWU6IG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmZpbmROYW1lc3BhY2VVcmkoJycpCiAgICB9OwogICAgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZyhpICsgMSksCiAgICAgICAgbmFtZXNwYWNlVXJpOiBuYW1lc3BhY2VzLmdldE5hbWVzcGFjZVVyaShuYW1lV2l0aE9wdGlvbmFsUHJlZml4LnN1YnN0cmluZygwLCBpKSkKICAgIH07Cn0KY2xhc3MgWG1sTmFtZXNwYWNlcyB7CiAgICBzdGFjayA9IFtdOwogICAgZ2V0IHN0YWNrU2l6ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdGFjay5sZW5ndGg7CiAgICB9CiAgICBwdXNoKGF0dHJzTWFwKSB7CiAgICAgICAgY29uc3QgYXR0cnMgPSBjb21wdXRlQXR0cmlidXRlTWFwKGF0dHJzTWFwKTsKICAgICAgICBsZXQgbWFwOwogICAgICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBhdHRycy5lbnRyaWVzKCkpewogICAgICAgICAgICBpZiAobmFtZSA9PT0gJ3htbG5zJykgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIG1hcC5zZXQoJycsIHZhbHVlKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChuYW1lLnN0YXJ0c1dpdGgoJ3htbG5zOicpKSB7CiAgICAgICAgICAgICAgICBtYXAgPSBtYXAgfHwgbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZS5zdWJzdHJpbmcoNik7CiAgICAgICAgICAgICAgICBtYXAuc2V0KHByZWZpeCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHRoaXMuc3RhY2sucHVzaChtYXAgfHwgRU1QVFlfU1RSSU5HX01BUCk7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQogICAgcG9wKCkgewogICAgICAgIHRoaXMuc3RhY2sucG9wKCk7CiAgICB9CiAgICBmaW5kTmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0TmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGdldE5hbWVzcGFjZVVyaTogcHJlZml4IG5vdCBmb3VuZDogJHtwcmVmaXh9YCk7CiAgICB9Cn0KZnVuY3Rpb24gdmFsaWRhdGVGZWVkWG1sKHhtbCwgY2FsbGJhY2tzKSB7CiAgICBpZiAoeG1sLnRhZ25hbWUgIT09ICcheG1sJykgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHhtbCwgYEJhZCB4bWwudGFnbmFtZTogJHt4bWwudGFnbmFtZX1gKTsKICAgIGlmIChPYmplY3Qua2V5cyh4bWwuYXR0cnNNYXApLmxlbmd0aCA+IDApIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBCYWQgeG1sLmF0dHJzTWFwOiAke3htbC5hdHRyc01hcH1gKTsKICAgIGNvbnN0IGRvY0VsZW1lbnQgPSBPYmplY3QudmFsdWVzKHhtbC5jaGlsZCkuZmxhdE1hcCgodik9PnYKICAgIClbMF07CiAgICBpZiAoIWRvY0VsZW1lbnQpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBObyB4bWwgcm9vdCBlbGVtZW50YCk7CiAgICB2YWxpZGF0ZVJzcyhkb2NFbGVtZW50LCBjYWxsYmFja3MpOwp9CmZ1bmN0aW9uIGdldFNpbmdsZUNoaWxkKG5vZGUsIG5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgY2hpbGRyZW4gPSBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCB7CiAgICAgICAgbmFtZQogICAgfSk7CiAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgRXhwZWN0ZWQgc2luZ2xlIDwke25hbWV9PiBjaGlsZCBlbGVtZW50IHVuZGVyIDwke25vZGUudGFnbmFtZX0+LCBmb3VuZCAke2NoaWxkcmVuLmxlbmd0aCA9PT0gMCA/ICdub25lJyA6IGNoaWxkcmVuLmxlbmd0aH1gLCBvcHRzKTsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuWzBdOwp9CmZ1bmN0aW9uIHZhbGlkYXRlUnNzKHJzcywgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBvcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI3doYXRJc1JzcycKICAgICAgICB9CiAgICB9OwogICAgaWYgKHJzcy50YWduYW1lICE9PSAncnNzJykgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHJzcywgYEJhZCB4bWwgcm9vdCB0YWc6ICR7cnNzLnRhZ25hbWV9LCBleHBlY3RlZCByc3NgLCBvcHRzKTsKICAgIGNvbnN0IHZlcnNpb24gPSByc3MuYXR0cy5nZXQoJ3ZlcnNpb24nKTsKICAgIGlmICh2ZXJzaW9uICE9PSAnMi4wJykgY2FsbGJhY2tzLm9uV2FybmluZyhyc3MsIGBCYWQgcnNzLnZlcnNpb246ICR7dmVyc2lvbn0sIGV4cGVjdGVkIDIuMGAsIG9wdHMpOwogICAgY29uc3QgaXR1bmVzT3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL3BvZGNhc3RlcnMuYXBwbGUuY29tL3N1cHBvcnQvODIzLXBvZGNhc3QtcmVxdWlyZW1lbnRzIzp+OnRleHQ9UG9kY2FzdCUyMFJTUyUyMGZlZWQlMjB0ZWNobmljYWwlMjByZXF1aXJlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IGhhc0l0dW5lc1ByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnaXR1bmVzOicpCiAgICApICE9PSB1bmRlZmluZWQ7CiAgICBpZiAoaGFzSXR1bmVzUHJlZml4KSBjaGVja0F0dHJpYnV0ZUVxdWFsKHJzcywgJ3htbG5zOml0dW5lcycsICdodHRwOi8vd3d3Lml0dW5lcy5jb20vZHRkcy9wb2RjYXN0LTEuMC5kdGQnLCBjYWxsYmFja3MsIGl0dW5lc09wdHMpOwogICAgY29uc3QgaGFzQ29udGVudFByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnY29udGVudDonKQogICAgKSAhPT0gdW5kZWZpbmVkOwogICAgaWYgKGhhc0NvbnRlbnRQcmVmaXgpIGNoZWNrQXR0cmlidXRlRXF1YWwocnNzLCAneG1sbnM6Y29udGVudCcsICdodHRwOi8vcHVybC5vcmcvcnNzLzEuMC9tb2R1bGVzL2NvbnRlbnQvJywgY2FsbGJhY2tzLCBpdHVuZXNPcHRzKTsKICAgIGNvbnN0IGNoYW5uZWwgPSBnZXRTaW5nbGVDaGlsZChyc3MsICdjaGFubmVsJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGlmICghY2hhbm5lbCkgcmV0dXJuOwogICAgdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcykgewogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNyZXF1aXJlZENoYW5uZWxFbGVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAndGl0bGUnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIG9wdHMpOwogICAgY29uc3QgbGluayA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICdsaW5rJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChsaW5rLCBpc1VybCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ2Rlc2NyaXB0aW9uJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChkZXNjcmlwdGlvbiwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNndWlkJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZ3VpZCkuY2hlY2tWYWx1ZShpc1V1aWQsIChndWlkVGV4dCk9PnsKICAgICAgICBjb25zdCB2ZXJzaW9uID0gZ3VpZFRleHQuY2hhckF0KDE0KTsKICAgICAgICBpZiAodmVyc2lvbiAhPT0gJzUnKSB7CiAgICAgICAgICAgIHJldHVybiBgZXhwZWN0ZWQgYSBVVUlEdjUsIGZvdW5kIGEgVVVJRHYke3ZlcnNpb259YDsKICAgICAgICB9CiAgICB9KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NrZWQnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5sb2NrZWQpLmNoZWNrVmFsdWUoKHYpPT4vXih5ZXN8bm8pJC8udGVzdCh2KQogICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdvd25lcicsIGlzRW1haWxBZGRyZXNzKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGZvciAoY29uc3QgZnVuZGluZyBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmZ1bmRpbmcpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgZnVuZGluZywgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNmdW5kaW5nJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGZvciAoY29uc3QgdHJhaWxlciBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYWlsZXIpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgdHJhaWxlciwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFpbGVyJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3B1YmRhdGUnLCBpc1JmYzI4MjIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnc2Vhc29uJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0TGljZW5zZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RWYWx1ZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RUYWdVc2FnZShjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3QgaXRlbXMgPSBjaGFubmVsLmNoaWxkLml0ZW0gfHwgW107CiAgICBsZXQgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ID0gMDsKICAgIGxldCBpdGVtc1ZhbGlkYXRlZCA9IDA7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpewogICAgICAgIGlmIChpdGVtc1ZhbGlkYXRlZCA8IDEpIHsKICAgICAgICAgICAgdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcyk7CiAgICAgICAgICAgIGl0ZW1zVmFsaWRhdGVkKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgewogICAgICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgICAgIH0pOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQrKzsKICAgIH0KICAgIGNhbGxiYWNrcy5vblJzc0l0ZW1zRm91bmQoaXRlbXMubGVuZ3RoLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFBlcnNvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBmb3IgKGNvbnN0IHBlcnNvbiBvZiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBlcnNvbikpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQobGV2ZWwsIHBlcnNvbiwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNwZXJzb24nKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyb2xlJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZ3JvdXAnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdpbWcnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaHJlZicsIGlzVXJsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMb2NhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NhdGlvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxvY2F0aW9uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdnZW8nLCBpc0dlb0xhdExvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnb3NtJywgaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcikuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMaWNlbnNlKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xpY2Vuc2UnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5saWNlbnNlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RWYWx1ZShsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCB2YWx1ZSA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3ZhbHVlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudmFsdWUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdtZXRob2QnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdzdWdnZXN0ZWQnLCBpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpLm5vZGU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlUmVjaXBpZW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHZhbHVlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnZhbHVlUmVjaXBpZW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3ZhbHVlJywgdmFsdWVSZWNpcGllbnQsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdmFsdWUtcmVjaXBpZW50JykpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21LZXknLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21WYWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhZGRyZXNzJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3BsaXQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZmVlJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0VGFnVXNhZ2Uobm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBrbm93biA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IHVua25vd24gPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWU6ICcqJywKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICkpKXsKICAgICAgICBjb25zdCBpc0tub3duID0gUW5hbWVzLlBvZGNhc3RJbmRleC5LTk9XTl9OQU1FUy5oYXMoZWxlbWVudC5xbmFtZS5uYW1lKTsKICAgICAgICAoaXNLbm93biA/IGtub3duIDogdW5rbm93bikuYWRkKGVsZW1lbnQucW5hbWUubmFtZSk7CiAgICB9CiAgICBpZiAoa25vd24uc2l6ZSArIHVua25vd24uc2l6ZSA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kKGtub3duLCB1bmtub3duKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZUVxdWFsKG5vZGUsIGF0dE5hbWUsIGF0dEV4cGVjdGVkVmFsdWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgYXR0VmFsdWUgPSBub2RlLmF0dHMuZ2V0KGF0dE5hbWUpOwogICAgaWYgKCFhdHRWYWx1ZSkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYE1pc3NpbmcgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUsIGV4cGVjdGVkICR7YXR0RXhwZWN0ZWRWYWx1ZX1gLCBvcHRzKTsKICAgIH0gZWxzZSBpZiAoYXR0VmFsdWUgIT09IGF0dEV4cGVjdGVkVmFsdWUpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7YXR0VmFsdWV9LCBleHBlY3RlZCAke2F0dEV4cGVjdGVkVmFsdWV9YCwgb3B0cyk7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tUZXh0KG5vZGUsIHRlc3QsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgaWYgKG5vZGUpIHsKICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IChub2RlLnZhbCB8fCAnJykudHJpbSgpOwogICAgICAgIGlmICghdGVzdCh0cmltbWVkVGV4dCkpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+IHZhbHVlOiAke3RyaW1tZWRUZXh0ID09PSAnJyA/ICc8ZW1wdHk+JyA6IHRyaW1tZWRUZXh0fWAsIG9wdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpbW1lZFRleHQ7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGlzTm90RW1wdHkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cmltbWVkVGV4dC5sZW5ndGggPiAwOwp9CmZ1bmN0aW9uIGlzVXJsKHRyaW1tZWRUZXh0KSB7CiAgICBjb25zdCB1ID0gdHJ5UGFyc2VVcmwodHJpbW1lZFRleHQpOwogICAgcmV0dXJuIHUgJiYgdS5wcm90b2NvbCA9PT0gJ2h0dHBzOicgfHwgdT8ucHJvdG9jb2wgPT09ICdodHRwOic7Cn0KZnVuY3Rpb24gaXNVcmkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cnlQYXJzZVVybCh0cmltbWVkVGV4dCkgIT09IHVuZGVmaW5lZDsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybChzdHIpIHsKICAgIHRyeSB7CiAgICAgICAgcmV0dXJuIG5ldyBVUkwoc3RyKTsKICAgIH0gY2F0Y2ggIHsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQp9CmZ1bmN0aW9uIGlzTWltZVR5cGUodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlx3K1wvWy0rLlx3XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1V1aWQodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlhLWZdezh9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezR9LVswLTlhLWZdezEyfSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzRW1haWxBZGRyZXNzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bXkBcc10rQFteQFxzXSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0F0TW9zdENoYXJhY3RlcnMobWF4Q2hhcmFjdGVycykgewogICAgcmV0dXJuICh0cmltbWVkVGV4dCk9PnRyaW1tZWRUZXh0Lmxlbmd0aCA8PSBtYXhDaGFyYWN0ZXJzCiAgICA7Cn0KZnVuY3Rpb24gaXNTZWNvbmRzKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cZCsoXC5cZCspPyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzR2VvTGF0TG9uKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15nZW86LT9cZHsxLDJ9KFwuXGQrKT8sLT9cZHsxLDN9KFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc09wZW5TdHJlZXRNYXBJZGVudGlmaWVyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bTldSXVxkKygjXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc05vbk5lZ2F0aXZlSW50ZWdlcih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrJC8udGVzdCh0cmltbWVkVGV4dCkgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpID49IDAgJiYgcGFyc2VJbnQodHJpbW1lZFRleHQpLnRvU3RyaW5nKCkgPT09IHRyaW1tZWRUZXh0Owp9CmZ1bmN0aW9uIGlzRGVjaW1hbCh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrKFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1JmYzI4MjIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlswLTlBLVphLXo6IC1dKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzSXNvODYwMSh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGR7NH0tXGR7Mn0tXGR7Mn1UXGR7Mn06XGR7Mn06XGR7Mn0oXC5cZCspP1okLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0Jvb2xlYW4odHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXih0cnVlfGZhbHNlKSQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGlzUG9kY2FzdFZhbHVlVHlwZVNsdWcodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlthLXpdKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIGZpbmRGaXJzdENoaWxkRWxlbWVudChub2RlLCBxbmFtZSwgY2FsbGJhY2tzLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIHFuYW1lKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBJdGVtIGlzIG1pc3NpbmcgYW4gPCR7cW5hbWUubmFtZX0+IGVsZW1lbnRgLCBvcHRzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEl0ZW0gaGFzIG11bHRpcGxlIDwke3FuYW1lLm5hbWV9PiBlbGVtZW50c2AsIG9wdHMpOwogICAgICAgIHJldHVybiBlbGVtZW50c1swXTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcykgewogICAgY29uc3QgaXR1bmVzT3B0czEgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9wb2RjYXN0ZXJzLmFwcGxlLmNvbS9zdXBwb3J0LzgyMy1wb2RjYXN0LXJlcXVpcmVtZW50cyM6fjp0ZXh0PVBvZGNhc3QlMjBSU1MlMjBmZWVkJTIwdGVjaG5pY2FsJTIwcmVxdWlyZW1lbnRzJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCBpdHVuZXNPcHRzMiA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2hlbHAuYXBwbGUuY29tL2l0Yy9wb2RjYXN0c19jb25uZWN0LyMvaXRjYjU0MzUzMzkwJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCB0aXRsZSA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ3RpdGxlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAodGl0bGUpIHsKICAgICAgICBjaGVja1RleHQodGl0bGUsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgfQogICAgY29uc3QgZW5jbG9zdXJlID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAoZW5jbG9zdXJlKSB7CiAgICAgICAgY29uc3QgcnNzRW5jbG9zdXJlT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGVuY2xvc3VyZWd0U3ViZWxlbWVudE9mTHRpdGVtZ3QnCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHVybCA9IGVuY2xvc3VyZS5hdHRzLmdldCgndXJsJyk7CiAgICAgICAgaWYgKCF1cmwpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgTWlzc2luZyBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodXJsICYmICFpc1VybCh1cmwpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGUgdmFsdWU6ICR7dXJsfSwgZXhwZWN0ZWQgdXJsYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCdsZW5ndGgnKTsKICAgICAgICBpZiAoIWxlbmd0aCkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAobGVuZ3RoICYmICFpc05vbk5lZ2F0aXZlSW50ZWdlcihsZW5ndGgpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGUgdmFsdWU6ICR7bGVuZ3RofSwgZXhwZWN0ZWQgbm9uLW5lZ2F0aXZlIGludGVnZXJgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBjb25zdCB0eXBlID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCd0eXBlJyk7CiAgICAgICAgaWYgKCF0eXBlKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgPGVuY2xvc3VyZT4gdHlwZSBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodHlwZSAmJiAhaXNNaW1lVHlwZSh0eXBlKSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBCYWQgaXRlbSA8ZW5jbG9zdXJlPiB0eXBlIGF0dHJpYnV0ZSB2YWx1ZTogJHt0eXBlfSwgZXhwZWN0ZWQgTUlNRSB0eXBlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICB9CiAgICBjb25zdCBndWlkID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZ3VpZCcKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czEpOwogICAgaWYgKGd1aWQpIHsKICAgICAgICBjb25zdCBndWlkVGV4dCA9IGNoZWNrVGV4dChndWlkLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIGl0dW5lc09wdHMxKTsKICAgICAgICBjb25zdCByc3NHdWlkT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGd1aWRndFN1YmVsZW1lbnRPZkx0aXRlbWd0JwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCBtaXNzcGVsbGluZ3MgPSBbCiAgICAgICAgICAgIC4uLmd1aWQuYXR0cy5rZXlzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYgIT09ICdpc1Blcm1hTGluaycgJiYgdi50b0xvd2VyQ2FzZSgpID09PSAnaXNwZXJtYWxpbmsnCiAgICAgICAgKTsKICAgICAgICBmb3IgKGNvbnN0IG1pc3NwZWxsaW5nIG9mIG1pc3NwZWxsaW5ncyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcoZ3VpZCwgYEJhZCBpdGVtIDxndWlkPiBpc1Blcm1hTGluayBhdHRyaWJ1dGUgc3BlbGxpbmc6ICR7bWlzc3BlbGxpbmd9YCwgcnNzR3VpZE9wdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1Blcm1hTGluayA9IGd1aWQuYXR0cy5nZXQoJ2lzUGVybWFMaW5rJykgfHwgJ3RydWUnOwogICAgICAgIGlmIChpc1Blcm1hTGluayA9PT0gJ3RydWUnICYmIGd1aWRUZXh0ICYmICFpc1VybChndWlkVGV4dCkgJiYgbWlzc3BlbGxpbmdzLmxlbmd0aCA9PT0gMCkgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkIGl0ZW0gPGd1aWQ+IHZhbHVlOiAke2d1aWRUZXh0fSwgZXhwZWN0ZWQgdXJsIHdoZW4gaXNQZXJtYUxpbms9InRydWUiIG9yIHVuc3BlY2lmaWVkYCwgcnNzR3VpZE9wdHMpOwogICAgfQogICAgY29uc3QgdHJhbnNjcmlwdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYW5zY3JpcHQpOwogICAgZm9yIChjb25zdCB0cmFuc2NyaXB0IG9mIHRyYW5zY3JpcHRzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgdHJhbnNjcmlwdCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFuc2NyaXB0JykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZ3VhZ2UnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyZWwnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNjaGFwdGVycycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmNoYXB0ZXJzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY29uc3Qgc291bmRiaXRlcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc291bmRiaXRlKTsKICAgIGZvciAoY29uc3Qgc291bmRiaXRlIG9mIHNvdW5kYml0ZXMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCBzb3VuZGJpdGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjc291bmRiaXRlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3N0YXJ0VGltZScsIGlzU2Vjb25kcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnZHVyYXRpb24nLCBpc1NlY29uZHMpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNzZWFzb24nKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zZWFzb24pLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkodikKICAgICkuY2hlY2tWYWx1ZShpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjZXBpc29kZScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmVwaXNvZGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2Rpc3BsYXknLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgKS5jaGVja1ZhbHVlKGlzRGVjaW1hbCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RMaWNlbnNlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmFsdGVybmF0ZUVuY2xvc3VyZSk7CiAgICBmb3IgKGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZSBvZiBhbHRlcm5hdGVFbmNsb3N1cmVzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2FsdGVybmF0ZS1lbmNsb3N1cmUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdiaXRyYXRlJywgaXNEZWNpbWFsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdoZWlnaHQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZycsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3RpdGxlJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICAgICApLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3JlbCcsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMzIpKHYpCiAgICAgICAgKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb2RlY3MnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdkZWZhdWx0JywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnYWx0ZXJuYXRlRW5jbG9zdXJlJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ludGVncml0eScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmludGVncml0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsICh2KT0+L14oc3JpfHBncC1zaWduYXR1cmUpJC8udGVzdCh2KQogICAgICAgICkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndmFsdWUnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjb25zdCBzb3VyY2VzID0gZmluZENoaWxkRWxlbWVudHMoYWx0ZXJuYXRlRW5jbG9zdXJlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvdXJjZSk7CiAgICAgICAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2FsdGVybmF0ZUVuY2xvc3VyZScsIHNvdXJjZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNhbHRlcm5hdGUtZW5jbG9zdXJlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VyaScsIGlzVXJpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb250ZW50VHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNoZWNrUG9kY2FzdFZhbHVlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IHNvY2lhbEludGVyYWN0cyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsSW50ZXJhY3QpOwogICAgY29uc3Qgc29jaWFsSW50ZXJhY3RSZWZlcmVuY2UgPSBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9iZW5qYW1pbmJlbGxhbXkvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9wYXRjaC05L3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWxpbnRlcmFjdC1lbGVtZW50Jyk7CiAgICBmb3IgKGNvbnN0IHNvY2lhbEludGVyYWN0IG9mIHNvY2lhbEludGVyYWN0cyl7CiAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnaXRlbScsIHNvY2lhbEludGVyYWN0LCBjYWxsYmFja3MsIHNvY2lhbEludGVyYWN0UmVmZXJlbmNlKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwbGF0Zm9ybScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3BvZGNhc3RBY2NvdW50SWQnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwdWJEYXRlJywgaXNJc284NjAxKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdwcmlvcml0eScsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja1ZhbHVlKGlzVXJpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjYWxsYmFja3Mub25Hb29kKHNvY2lhbEludGVyYWN0LCAnRm91bmQgPHBvZGNhc3Q6c29jaWFsSW50ZXJhY3Q+LCBuaWNlIScsIHsKICAgICAgICAgICAgdGFnOiAnc29jaWFsLWludGVyYWN0JywKICAgICAgICAgICAgcmVmZXJlbmNlOiBzb2NpYWxJbnRlcmFjdFJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgY2hlY2tQb2RjYXN0VGFnVXNhZ2UoaXRlbSwgY2FsbGJhY2tzKTsKfQpmdW5jdGlvbiBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoaHJlZikgewogICAgcmV0dXJuIHsKICAgICAgICBydWxlc2V0OiAncG9kY2FzdGluZGV4JywKICAgICAgICBocmVmCiAgICB9Owp9CmNsYXNzIEVsZW1lbnRWYWxpZGF0aW9uIHsKICAgIHN0YXRpYyBFTVBUWV9TVFJJTkdfU0VUID0gbmV3IFNldCgpOwogICAgbm9kZTsKICAgIGxldmVsOwogICAgY2FsbGJhY2tzOwogICAgb3B0czsKICAgIHJlbWFpbmluZ0F0dE5hbWVzOwogICAgY29uc3RydWN0b3IobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5vcHRzID0gb3B0czsKICAgICAgICB0aGlzLnJlbWFpbmluZ0F0dE5hbWVzID0gbm9kZSA/IG5ldyBTZXQobm9kZS5hdHRzLmtleXMoKSkgOiBFbGVtZW50VmFsaWRhdGlvbi5FTVBUWV9TVFJJTkdfU0VUOwogICAgfQogICAgc3RhdGljIGZvckVsZW1lbnQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcmVmZXJlbmNlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGZvclNpbmdsZUNoaWxkKGxldmVsLCBwYXJlbnQsIGNhbGxiYWNrcywgcmVmZXJlbmNlLCAuLi5xbmFtZXMpIHsKICAgICAgICBjaGVja1RydWUoJ3FuYW1lcy5sZW5ndGgnLCBxbmFtZXMubGVuZ3RoLCBxbmFtZXMubGVuZ3RoID4gMCk7CiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhwYXJlbnQsIC4uLnFuYW1lcyk7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcoZWxlbWVudHNbMV0sIGBNdWx0aXBsZSAke2xldmVsfSA8JHtlbGVtZW50c1sxXS50YWduYW1lfT4gZWxlbWVudHMgYXJlIG5vdCBhbGxvd2VkYCwgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIGVsZW1lbnQsIGNhbGxiYWNrcywgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCB1bmRlZmluZWQsIGNhbGxiYWNrcywgewogICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIGNoZWNrVmFsdWUodGVzdCwgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICBjb25zdCB7IG5vZGUgLCBjYWxsYmFja3MgLCBvcHRzICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IGNoZWNrVGV4dChub2RlLCB0ZXN0LCBjYWxsYmFja3MsIG9wdHMpOwogICAgICAgICAgICBpZiAodHJpbW1lZFRleHQgJiYgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhcm5pbmdTdWZmaXggPSBhZGRpdGlvbmFsVGVzdCh0cmltbWVkVGV4dCk7CiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1N1ZmZpeCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiB2YWx1ZTogJHt0cmltbWVkVGV4dCA9PT0gJycgPyAnPGVtcHR5PicgOiB0cmltbWVkVGV4dH0sICR7d2FybmluZ1N1ZmZpeH1gLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUobmFtZSwgdGVzdCkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBub2RlLmF0dHMuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZiAoIXZhbHVlKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlYCwgb3B0cyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tPcHRpb25hbEF0dHJpYnV0ZShuYW1lLCB0ZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkgewogICAgICAgIGNvbnN0IHsgcmVtYWluaW5nQXR0TmFtZXMgLCBjYWxsYmFja3MgLCBub2RlICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBpZiAocmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiBhdHRyaWJ1dGUgbmFtZSR7cmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDEgPyAncycgOiAnJ306ICR7WwogICAgICAgICAgICAgICAgICAgIC4uLnJlbWFpbmluZ0F0dE5hbWVzCiAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0KY2xhc3MgVmFsaWRhdG9yQXBwVk0gewogICAgbmV4dEpvYklkID0gMTsKICAgIGN1cnJlbnRKb2I7CiAgICBnZXQgdmFsaWRhdGluZygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgIXRoaXMuY3VycmVudEpvYi5kb25lOwogICAgfQogICAgZ2V0IG1lc3NhZ2VzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2IubWVzc2FnZXMgOiBbXTsKICAgIH0KICAgIGdldCBpc1NlYXJjaCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iICE9PSB1bmRlZmluZWQgJiYgdGhpcy5jdXJyZW50Sm9iLnNlYXJjaDsKICAgIH0KICAgIGdldCBzZWFyY2hSZXN1bHRzKCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2IgPyB0aGlzLmN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cyA6IFtdOwogICAgfQogICAgZ2V0IHhtbCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy54bWw7CiAgICB9CiAgICBnZXQgZmV0Y2hDb21tZW50c1Jlc3VsdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iPy5mZXRjaENvbW1lbnRzUmVzdWx0OwogICAgfQogICAgb25DaGFuZ2UgPSAoKT0+ewogICAgfTsKICAgIHN0YXJ0KCkgewogICAgfQogICAgY29udGludWVXaXRoKHVybCkgewogICAgICAgIGNvbnN0IHsgY3VycmVudEpvYiAgfSA9IHRoaXM7CiAgICAgICAgaWYgKGN1cnJlbnRKb2IpIHsKICAgICAgICAgICAgY3VycmVudEpvYi5kb25lID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoID0gZmFsc2U7CiAgICAgICAgICAgIGN1cnJlbnRKb2Iuc2VhcmNoUmVzdWx0cy5zcGxpY2UoMCk7CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiAncnVubmluZycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnVmFsaWRhdGluZycKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY3VycmVudEpvYi5tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdpbmZvJywKICAgICAgICAgICAgICAgIHRleHQ6ICdDb250aW51aW5nIHdpdGggZmVlZCBmcm9tIHNlYXJjaCcsCiAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgdGhpcy52YWxpZGF0ZUFzeW5jKHVybCwgY3VycmVudEpvYik7CiAgICAgICAgfQogICAgfQogICAgc3RhcnRWYWxpZGF0aW9uKGlucHV0LCBvcHRpb25zKSB7CiAgICAgICAgY29uc3Qgam9iID0gewogICAgICAgICAgICBpZDogdGhpcy5uZXh0Sm9iSWQrKywKICAgICAgICAgICAgbWVzc2FnZXM6IFtdLAogICAgICAgICAgICBzZWFyY2hSZXN1bHRzOiBbXSwKICAgICAgICAgICAgdGltZXM6IHsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgb3B0aW9ucywKICAgICAgICAgICAgc2VhcmNoOiBmYWxzZSwKICAgICAgICAgICAgZG9uZTogZmFsc2UsCiAgICAgICAgICAgIGNhbmNlbGxlZDogZmFsc2UKICAgICAgICB9OwogICAgICAgIHRoaXMuY3VycmVudEpvYiA9IGpvYjsKICAgICAgICBqb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgIHR5cGU6ICdydW5uaW5nJywKICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgfSk7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyhpbnB1dCwgam9iKTsKICAgIH0KICAgIGNhbmNlbFZhbGlkYXRpb24oKSB7CiAgICAgICAgaWYgKHRoaXMuY3VycmVudEpvYiAmJiAhdGhpcy5jdXJyZW50Sm9iLmRvbmUpIHsKICAgICAgICAgICAgdGhpcy5jdXJyZW50Sm9iLmNhbmNlbGxlZCA9IHRydWU7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEpvYi5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIHZhbGlkYXRlQXN5bmMoaW5wdXQsIGpvYikgewogICAgICAgIGlucHV0ID0gbm9ybWFsaXplSW5wdXQoaW5wdXQpOwogICAgICAgIGNvbnN0IHsgbWVzc2FnZXMgIH0gPSBqb2I7CiAgICAgICAgY29uc3Qgc2V0U3RhdHVzID0gKHRleHQsIG9wdHMgPSB7CiAgICAgICAgfSk9PnsKICAgICAgICAgICAgY29uc3QgeyB1cmwgLCB0eXBlICB9ID0gb3B0czsKICAgICAgICAgICAgbWVzc2FnZXNbMF0gPSB7CiAgICAgICAgICAgICAgICB0eXBlOiB0eXBlIHx8IG1lc3NhZ2VzWzBdLnR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9OwogICAgICAgIGNvbnN0IGFkZE1lc3NhZ2UgPSAodHlwZSwgdGV4dCwgb3B0cyA9IHsKICAgICAgICB9KT0+ewogICAgICAgICAgICBjb25zdCB7IHVybCAsIHRhZyAsIGNvbW1lbnQgLCByZWZlcmVuY2UgIH0gPSBvcHRzOwogICAgICAgICAgICBtZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGUsCiAgICAgICAgICAgICAgICB0ZXh0LAogICAgICAgICAgICAgICAgdGFnLAogICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH07CiAgICAgICAgbGV0IGFjdGl2aXR5UHViOwogICAgICAgIGNvbnN0IGhlYWRlcnMgPSB7CiAgICAgICAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiAnZ3ppcCcsCiAgICAgICAgICAgICdVc2VyLUFnZW50Jzogam9iLm9wdGlvbnMudXNlckFnZW50LAogICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZScKICAgICAgICB9OwogICAgICAgIGxldCBjb250aW51ZVdpdGhVcmw7CiAgICAgICAgY29uc3Qgam9iU3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlucHV0ID0gaW5wdXQudHJpbSgpOwogICAgICAgICAgICBpZiAoaW5wdXQgPT09ICcnKSB0aHJvdyBuZXcgRXJyb3IoYE5vIGlucHV0YCk7CiAgICAgICAgICAgIGlmICgvXmh0dHBzPzpcL1wvLisvaS50ZXN0KGlucHV0KSkgewogICAgICAgICAgICAgICAgY29uc3QgaW5wdXRVcmwgPSB0cnlQYXJzZVVybDEoaW5wdXQpOwogICAgICAgICAgICAgICAgaWYgKCFpbnB1dFVybCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiAke2lucHV0fWApOwogICAgICAgICAgICAgICAgY2hlY2tNYXRjaGVzKCdpbnB1dFVybC5wcm90b2NvbCcsIGlucHV0VXJsLnByb3RvY29sLCAvXmh0dHBzPzokLyk7CiAgICAgICAgICAgICAgICBpbnB1dFVybC5zZWFyY2hQYXJhbXMuc2V0KCdfdCcsIERhdGUubm93KCkudG9TdHJpbmcoKSk7CiAgICAgICAgICAgICAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAsIGZldGNoVGltZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaChpbnB1dFVybC50b1N0cmluZygpLCB7CiAgICAgICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBpZiAoam9iLmRvbmUpIHJldHVybjsKICAgICAgICAgICAgICAgIGpvYi50aW1lcy5mZXRjaFRpbWUgPSBmZXRjaFRpbWU7CiAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ2xvY2FsJykgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgTG9jYWwgZmV0Y2ggc3VjY2VlZGVkIChDT1JTIGVuYWJsZWQpYCwgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjaGVja0VxdWFsKGAke2lucHV0VXJsLmhvc3R9IHJlc3BvbnNlIHN0YXR1c2AsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IGNvbnRlbnRUeXBlID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpOwogICAgICAgICAgICAgICAgbGV0IHZhbGlkYXRlRmVlZCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoY29udGVudFR5cGUgJiYgY29udGVudFR5cGUuaW5jbHVkZXMoJy9odG1sJykpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZvdW5kIGh0bWwsIHdpbGwgdHJ5IGFnYWluIGFzIEFjdGl2aXR5UHViJyk7CiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgYWN0aXZpdHlQdWIgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6ICdpbnB1dCB1cmwnCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0ZUZlZWQpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGpvYi5kb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnJlYWRUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBsZXQgeG1sOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHBhcnNlWG1sKHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh4bWwpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBgWG1sIHBhcnNlIGZhaWxlZDogJHtlLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMucGFyc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoeG1sICYmIE9iamVjdC5rZXlzKHhtbCkubGVuZ3RoID4gMCkgam9iLnhtbCA9IHhtbDsKICAgICAgICAgICAgICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb25NZXNzYWdlID0gKHR5cGUsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHM/LnRhZyA9PT0gJ3NvY2lhbC1pbnRlcmFjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS52YWwgJiYgbm9kZS52YWwgIT09ICcnICYmIGNvbXB1dGVBdHRyaWJ1dGVNYXAobm9kZS5hdHRyc01hcCkuZ2V0KCdwbGF0Zm9ybScpID09PSAnYWN0aXZpdHlwdWInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVwaXNvZGVUaXRsZSA9IGZpbmRFcGlzb2RlVGl0bGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBub2RlLnZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6IGVwaXNvZGVUaXRsZSA/IGDigJwke2VwaXNvZGVUaXRsZX3igJ1gIDogJ2VwaXNvZGUnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5rbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHJzc0l0ZW1JbmZvOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkdvb2Q6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2dvb2QnLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkVycm9yOiAobm9kZSwgbWVzc2FnZSwgb3B0cyk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnZXJyb3InLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbldhcm5pbmc6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUud2FybihtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ3dhcm5pbmcnLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbkluZm86IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvbk1lc3NhZ2UoJ2luZm8nLCBub2RlLCBtZXNzYWdlLCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblBvZGNhc3RJbmRleFRhZ05hbWVzRm91bmQ6IChrbm93biwgdW5rbm93bik9PnsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBrbm93bi5mb3JFYWNoKCh2KT0+a25vd25QaVRhZ3MuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB1bmtub3duLmZvckVhY2goKHYpPT51bmtub3duUGlUYWdzLmFkZCh2KQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgb25Sc3NJdGVtc0ZvdW5kOiAoaXRlbXNDb3VudCwgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50KT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJzc0l0ZW1JbmZvID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc0NvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICB2YWxpZGF0ZUZlZWRYbWwoeG1sLCBjYWxsYmFja3MpOwogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMudmFsaWRhdGVUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocnNzSXRlbUluZm8pIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgaXRlbXNDb3VudCAsIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCAgfSA9IHJzc0l0ZW1JbmZvOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgaXRlbXNXaXRob3V0RW5jbG9zdXJlc0NvdW50ID0gaXRlbXNDb3VudCAtIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpZWNlcyA9IFsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBgRm91bmQgJHt1bml0U3RyaW5nKGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudCwgJ2VwaXNvZGUnKX1gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCA+IDApIHBpZWNlcy5wdXNoKGBhbmQgJHt1bml0U3RyaW5nKGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCwgJ2l0ZW0nKX0gd2l0aG91dCBlbmNsb3N1cmVzYCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaWVjZXMucHVzaChgaW4gYSAke2Zvcm1hdEJ5dGVzKHRleHQubGVuZ3RoKX0gZmVlZGApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIHBpZWNlcy5qb2luKCcgJykpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpUmVmZXJlbmNlID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcnVsZXNldDogJ3BvZGNhc3RpbmRleCcsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kJwogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0YWdTdHJpbmcgPSAoc2V0KT0+WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLnNldAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXS5tYXAoKHYpPT5gPHBvZGNhc3Q6JHt2fT5gCiAgICAgICAgICAgICAgICAgICAgICAgICAgICApLmpvaW4oJywgJykKICAgICAgICAgICAgICAgICAgICAgICAgOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoa25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2dvb2QnLCBgRm91bmQgJHt1bml0U3RyaW5nKGtub3duUGlUYWdzLnNpemUsICdwb2RjYXN0IG5hbWVzcGFjZSB0YWcnKX06ICR7dGFnU3RyaW5nKGtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVua25vd25QaVRhZ3Muc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgRm91bmQgJHt1bml0U3RyaW5nKHVua25vd25QaVRhZ3Muc2l6ZSwgJ3Vua25vd24gcG9kY2FzdCBuYW1lc3BhY2UgdGFnJyl9OiAke3RhZ1N0cmluZyh1bmtub3duUGlUYWdzKX1gLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVmZXJlbmNlOiBwaVJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBjb25zdCB2YWxpZGF0ZUNvbW1lbnRzID0gam9iLm9wdGlvbnMudmFsaWRhdGVDb21tZW50cyAhPT0gdW5kZWZpbmVkID8gam9iLm9wdGlvbnMudmFsaWRhdGVDb21tZW50cyA6IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoYWN0aXZpdHlQdWIgJiYgIXZhbGlkYXRlQ29tbWVudHMpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0NvbW1lbnRzIHZhbGlkYXRpb24gZGlzYWJsZWQsIG5vdCBmZXRjaGluZyBBY3Rpdml0eVB1YicpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhY3Rpdml0eVB1YikgewogICAgICAgICAgICAgICAgICAgIHNldFN0YXR1cyhgVmFsaWRhdGluZyBBY3Rpdml0eVB1YiBmb3IgJHthY3Rpdml0eVB1Yi5zdWJqZWN0fWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBhY3Rpdml0eVB1Yi51cmwKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdpbmZvJywgJ0ZldGNoaW5nIEFjdGl2aXR5UHViIGNvbW1lbnRzJywgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGFjdGl2aXR5UHViLnVybAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IGtlZXBHb2luZyA9ICgpPT4ham9iLmRvbmUKICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3RlT25seU9yaWdpbnMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZVVzZVNpZGUgPSAodXJsKT0+ewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVtb3RlT25seU9yaWdpbnMuaGFzKG5ldyBVUkwodXJsKS5vcmlnaW4pID8gJ3JlbW90ZScgOiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBsZXQgYWN0aXZpdHlQdWJDYWxscyA9IDA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hBY3Rpdml0eVB1YiA9IGFzeW5jICh1cmwpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB7IG9iaiAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoJy9hcGkvdjEvc3RhdHVzZXMnKSAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IG9iai51cmk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gcmVzLm9iajsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGUgPSByZXMuc2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBuZXcgVVJMKHVybCkub3JpZ2luOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW1vdGVPbmx5T3JpZ2lucy5oYXMob3JpZ2luKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ3dhcm5pbmcnLCBgTG9jYWwgQWN0aXZpdHlQdWIgZmV0Y2ggZmFpbGVkIChDT1JTIGRpc2FibGVkPylgLCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnOiAnY29ycycKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVPbmx5T3JpZ2lucy5hZGQob3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBhY3Rpdml0eVB1YkNhbGxzKys7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBvYmo7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCB3YXJuID0gKGNvbW1lbnQsIHVybCwgbWVzc2FnZSk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIG1lc3NhZ2UsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1lbnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB1cmwKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmwoYWN0aXZpdHlQdWIudXJsLCBhY3Rpdml0eVB1Yi5zdWJqZWN0LCB7CiAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBHb2luZywKICAgICAgICAgICAgICAgICAgICAgICAgZmV0Y2hBY3Rpdml0eVB1YiwKICAgICAgICAgICAgICAgICAgICAgICAgd2FybgogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGlmIChmZXRjaENvbW1lbnRzUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi50aW1lcy5jb21tZW50c1RpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCBgRm91bmQgJHt1bml0U3RyaW5nKGNvbXB1dGVDb21tZW50Q291bnQoZmV0Y2hDb21tZW50c1Jlc3VsdC5yb290Q29tbWVudCksICdjb21tZW50Jyl9IGFuZCAke3VuaXRTdHJpbmcoZmV0Y2hDb21tZW50c1Jlc3VsdC5jb21tZW50ZXJzLnNpemUsICdwYXJ0aWNpcGFudCcpfSwgbWFkZSAke3VuaXRTdHJpbmcoYWN0aXZpdHlQdWJDYWxscywgJ0FjdGl2aXR5UHViIGNhbGwnKX1gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgam9iLmZldGNoQ29tbWVudHNSZXN1bHQgPSBmZXRjaENvbW1lbnRzUmVzdWx0OwogICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpvYi5zZWFyY2ggPSB0cnVlOwogICAgICAgICAgICAgICAgc2V0U3RhdHVzKCdTZWFyY2hpbmcnKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYC9zYCwgewogICAgICAgICAgICAgICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgICAgICAgICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXQsCiAgICAgICAgICAgICAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICBjaGVja0VxdWFsKCdzZWFyY2hSZXNwb25zZS5zdGF0dXMnLCBzZWFyY2hSZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBzZWFyY2hSZXN1bHQgPSBhd2FpdCBzZWFyY2hSZXNwb25zZS5qc29uKCk7CiAgICAgICAgICAgICAgICBpZiAoc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBzZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2Vycm9yJywgc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBqb2Iuc2VhcmNoUmVzdWx0cy5wdXNoKC4uLnNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdC5mZWVkcy5zbGljZSgwLCAyMCkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdlcnJvcicsIHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0KTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWlzUmVhZG9ubHlBcnJheShzZWFyY2hSZXN1bHQucGlJZFJlc3VsdC5mZWVkKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWVXaXRoVXJsID0gc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQuZmVlZC51cmw7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZSk7CiAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2Vycm9yJywgZS5tZXNzYWdlKTsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCBgJHtqb2Iuc2VhcmNoID8gJ1NlYXJjaCB0b29rJyA6ICdUb29rJ30gJHtmb3JtYXRUaW1lKERhdGUubm93KCkgLSBqb2JTdGFydCl9JHtjb21wdXRlSm9iVGltZXNTdHJpbmdTdWZmaXgoam9iKX1gKTsKICAgICAgICAgICAgaWYgKGNvbnRpbnVlV2l0aFVybCkgewogICAgICAgICAgICAgICAgdGhpcy5jb250aW51ZVdpdGgoY29udGludWVXaXRoVXJsKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGpvYi5kb25lID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGNvbnN0IHN0YXR1cyA9IGpvYi5jYW5jZWxsZWQgPyAnQ2FuY2VsbGVkJyA6IGpvYi5zZWFyY2ggJiYgam9iLnNlYXJjaFJlc3VsdHMubGVuZ3RoID09PSAwID8gJ0ZvdW5kIG5vIHBvZGNhc3RzJyA6IGpvYi5zZWFyY2ggJiYgam9iLnNlYXJjaFJlc3VsdHMubGVuZ3RoID09PSAxID8gJ0ZvdW5kIG9uZSBwb2RjYXN0LCBzZWxlY3QgdG8gY29udGludWUnIDogam9iLnNlYXJjaCA/IGBGb3VuZCAke2pvYi5zZWFyY2hSZXN1bHRzLmxlbmd0aH0gcG9kY2FzdHMsIHNlbGVjdCBvbmUgdG8gY29udGludWVgIDogJ0RvbmUnOwogICAgICAgICAgICAgICAgc2V0U3RhdHVzKHN0YXR1cywgewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdkb25lJwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gZm9ybWF0Qnl0ZXMoYnl0ZXMpIHsKICAgIGxldCBhbW91bnQgPSBieXRlczsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7YW1vdW50fS1ieXRlYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICBpZiAoYW1vdW50IDwgMTAyNCkgcmV0dXJuIGAke01hdGgucm91bmQoYW1vdW50ICogMTAwKSAvIDEwMH1rYmA7CiAgICBhbW91bnQgPSBhbW91bnQgLyAxMDI0OwogICAgcmV0dXJuIGAke01hdGgucm91bmQoYW1vdW50ICogMTAwKSAvIDEwMH1tYmA7Cn0KZnVuY3Rpb24gZm9ybWF0VGltZShtaWxsaXMpIHsKICAgIGlmIChtaWxsaXMgPCAxMDAwKSByZXR1cm4gYCR7bWlsbGlzfW1zYDsKICAgIHJldHVybiBgJHtNYXRoLnJvdW5kKG1pbGxpcyAvIDEwMDAgKiAxMDApIC8gMTAwfXNgOwp9CmZ1bmN0aW9uIGNvbXB1dGVKb2JUaW1lc1N0cmluZ1N1ZmZpeChqb2IpIHsKICAgIGNvbnN0IHJ0ID0gWwogICAgICAgIFsKICAgICAgICAgICAgJ2ZldGNoJywKICAgICAgICAgICAgam9iLnRpbWVzLmZldGNoVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAncmVhZCcsCiAgICAgICAgICAgIGpvYi50aW1lcy5yZWFkVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAncGFyc2UnLAogICAgICAgICAgICBqb2IudGltZXMucGFyc2VUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICd2YWxpZGF0ZScsCiAgICAgICAgICAgIGpvYi50aW1lcy52YWxpZGF0ZVRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ2NvbW1lbnRzJywKICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZQogICAgICAgIF0KICAgIF0uZmlsdGVyKCh2KT0+dlsxXSAhPT0gdW5kZWZpbmVkCiAgICApLm1hcCgodik9PmAke3ZbMF19PSR7Zm9ybWF0VGltZSh2WzFdKX1gCiAgICApLmpvaW4oJywgJyk7CiAgICByZXR1cm4gcnQgPT09ICcnID8gJycgOiBgICgke3J0fSlgOwp9CmZ1bmN0aW9uIHVuaXRTdHJpbmcoYW1vdW50LCB1bml0KSB7CiAgICByZXR1cm4gYCR7YW1vdW50ID09PSAwID8gJ25vJyA6IGFtb3VudCA9PT0gMSA/ICdvbmUnIDogbmV3IEludGwuTnVtYmVyRm9ybWF0KCkuZm9ybWF0KGFtb3VudCl9ICR7dW5pdH0ke2Ftb3VudCA9PT0gMSA/ICcnIDogJ3MnfWA7Cn0KZnVuY3Rpb24gbm9ybWFsaXplSW5wdXQoaW5wdXQpIHsKICAgIGlucHV0ID0gaW5wdXQudHJpbSgpOwogICAgY29uc3QgbSA9IC9eaHR0cHM6XC9cL3BvZGNhc3RzXC5hcHBsZVwuY29tXC8uKj8oaWRcZCspJC8uZXhlYyhpbnB1dCk7CiAgICBpZiAobSkgcmV0dXJuIG1bMV07CiAgICByZXR1cm4gaW5wdXQ7Cn0KZnVuY3Rpb24gdHJ5UGFyc2VVcmwxKHVybCkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IFVSTCh1cmwpOwogICAgfSBjYXRjaCAgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KZnVuY3Rpb24gc2xlZXAobXMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSk9PnNldFRpbWVvdXQocmVzb2x2ZSwgbXMpCiAgICApOwp9CmFzeW5jIGZ1bmN0aW9uIGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCB1c2VTaWRlLCBzbGVlcE1pbGxpc0JldHdlZW5DYWxscykgewogICAgaWYgKHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzID4gMCkgYXdhaXQgc2xlZXAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMpOwogICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCB7CiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2FjdGl2aXR5K2pzb24nCiAgICAgICAgfSwKICAgICAgICB1c2VTaWRlCiAgICB9KTsKICAgIGNoZWNrRXF1YWwoJ3Jlcy5zdGF0dXMnLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4ucmVzcG9uc2UuaGVhZGVycwogICAgXS5tYXAoKHYpPT52LmpvaW4oJzogJykKICAgICkpOwogICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICBpZiAoIShjb250ZW50VHlwZSB8fCAnJykuaW5jbHVkZXMoJ2pzb24nKSkgewogICAgICAgIHRocm93IG5ldyBFcnJvcignRm91bmQgaHRtbCwgbm90IEFjdGl2aXR5UHViJyk7CiAgICB9CiAgICBjb25zdCBvYmogPSBhd2FpdCByZXNwb25zZS5qc29uKCk7CiAgICByZXR1cm4gewogICAgICAgIG9iaiwKICAgICAgICBzaWRlCiAgICB9Owp9CmFzeW5jIGZ1bmN0aW9uIGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIG9wdHMgPSB7Cn0pIHsKICAgIGNvbnN0IHsgaGVhZGVycyAsIHVzZVNpZGUgIH0gPSBvcHRzOwogICAgaWYgKHVzZVNpZGUgIT09ICdyZW1vdGUnKSB7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgY29uc29sZS5sb2coYGxvY2FsIGZldGNoOiAke3VybH1gKTsKICAgICAgICAgICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVybCwgewogICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgICAgIGZldGNoVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0LAogICAgICAgICAgICAgICAgc2lkZTogJ2xvY2FsJywKICAgICAgICAgICAgICAgIHJlc3BvbnNlCiAgICAgICAgICAgIH07CiAgICAgICAgfSBjYXRjaCAoZSkgewogICAgICAgICAgICBjb25zb2xlLmxvZygnRmFpbGVkIHRvIGxvY2FsIGZldGNoLCB0cnlpbmcgcmVtb3RlJywgZSk7CiAgICAgICAgfQogICAgfQogICAgY29uc29sZS5sb2coYHJlbW90ZSBmZXRjaDogJHt1cmx9YCk7CiAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKGAvZi8ke3VybC5yZXBsYWNlQWxsKC9bXmEtekEtWjAtOS5dKy9nLCAnXycpfWAsIHsKICAgICAgICBtZXRob2Q6ICdQT1NUJywKICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeSh7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgaGVhZGVycwogICAgICAgIH0pCiAgICB9KTsKICAgIHJldHVybiB7CiAgICAgICAgZmV0Y2hUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnQsCiAgICAgICAgc2lkZTogJ3JlbW90ZScsCiAgICAgICAgcmVzcG9uc2UKICAgIH07Cn0KZnVuY3Rpb24gZmluZEVwaXNvZGVUaXRsZShzb2NpYWxJbnRlcmFjdCkgewogICAgY29uc3QgaXRlbSA9IHNvY2lhbEludGVyYWN0LnBhcmVudDsKICAgIGlmIChpdGVtKSB7CiAgICAgICAgY29uc3QgdGl0bGUgPSBpdGVtLmNoaWxkWyd0aXRsZSddOwogICAgICAgIGlmICh0aXRsZS5sZW5ndGggPiAwICYmIHRpdGxlWzBdLnZhbCkgewogICAgICAgICAgICBjb25zdCB2YWwgPSB0aXRsZVswXS52YWwudHJpbSgpOwogICAgICAgICAgICBpZiAodmFsLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmNvbnN0IENJUkNVTEFSX1BST0dSRVNTX0NTUyA9IGNzc2AKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgLXdlYmtpdC1hcHBlYXJhbmNlOiBub25lOwogICAgLW1vei1hcHBlYXJhbmNlOiBub25lOwogICAgYXBwZWFyYW5jZTogbm9uZTsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IG5vbmU7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICBwYWRkaW5nOiAwLjI1ZW07CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBjb2xvcjogdmFyKC0tcHVyZS1tYXRlcmlhbC1wcmltYXJ5LXJnYiwgcmdiKDMzLCAxNTAsIDI0MykpOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBmb250LXNpemU6IDE2cHg7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjo6LXdlYmtpdC1wcm9ncmVzcy1iYXIgewogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7Cn0KCi8qIEluZGV0ZXJtaW5hdGUgKi8KLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZSB7CiAgICAtd2Via2l0LW1hc2staW1hZ2U6IGxpbmVhci1ncmFkaWVudCh0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSksIGxpbmVhci1ncmFkaWVudCh0byByaWdodCwgdHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpOwogICAgbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgNnMgaW5maW5pdGUgY3ViaWMtYmV6aWVyKDAuMywgMC42LCAxLCAxKTsKfQoKOi1tcy1sYW5nKHgpLCAucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIGFuaW1hdGlvbjogbm9uZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6YmVmb3JlLAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjotd2Via2l0LXByb2dyZXNzLXZhbHVlIHsKICAgIGNvbnRlbnQ6ICIiOwogICAgZGlzcGxheTogYmxvY2s7CiAgICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogICAgbWFyZ2luLWJvdHRvbTogMC4yNWVtOwogICAgYm9yZGVyOiBzb2xpZCAwLjI1ZW0gdHJhbnNwYXJlbnQ7CiAgICBib3JkZXItdG9wLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICBib3JkZXItcmFkaXVzOiA1MCU7CiAgICB3aWR0aDogMTAwJSAhaW1wb3J0YW50OwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tb3otcHJvZ3Jlc3MtYmFyIHsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlOwogICAgaGVpZ2h0OiAxMDAlOwogICAgYmFja2dyb3VuZC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICBhbmltYXRpb246IHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIDAuNzVzIGluZmluaXRlIGxpbmVhciBhbHRlcm5hdGU7Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi1tcy1maWxsIHsKICAgIGFuaW1hdGlvbi1uYW1lOiAtbXMtcmluZzsKfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgwZGVnKTsKICAgIH0KICAgIDEyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDI1JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoNjMwZGVnKTsKICAgIH0KICAgIDM3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg4MTBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDUwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTI2MGRlZyk7CiAgICB9CiAgICA2Mi41JSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMTQ0MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNzUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxODkwZGVnKTsKICAgIH0KICAgIDg3LjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyMDcwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgyNTIwZGVnKTsKICAgIH0KfQoKQGtleWZyYW1lcyBwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyLXBzZXVkbyB7CiAgICAwJSB7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoLTMwZGVnKTsKICAgIH0KICAgIDI5LjQlIHsKICAgICAgICBib3JkZXItbGVmdC1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICAyOS40MSUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICB9CiAgICA2NC43JSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogdHJhbnNwYXJlbnQ7CiAgICB9CiAgICA2NC43MSUgewogICAgICAgIGJvcmRlci1ib3R0b20tY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIyNWRlZyk7CiAgICB9Cn0KYDsKZnVuY3Rpb24gZXh0ZXJuYWxpemVBbmNob3IoYW5jaG9yKSB7CiAgICBhbmNob3IudGFyZ2V0ID0gJ19ibGFuayc7CiAgICBhbmNob3IucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwp9CmNvbnN0IENPTU1FTlRTX0hUTUwgPSBodG1sYAo8ZGV0YWlscyBpZD0iY29tbWVudHMtZGV0YWlscyIgb3Blbj4KICAgIDxzdW1tYXJ5PkNvbW1lbnRzIGZvciA8c3BhbiBpZD0iY29tbWVudHMtc3ViamVjdCI+c3ViamVjdDwvc3Bhbj48L3N1bW1hcnk+CiAgICA8b3V0cHV0IGlkPSJjb21tZW50cyI+PC9vdXRwdXQ+CjwvZGV0YWlscz4KYDsKY29uc3QgQ09NTUVOVFNfQ1NTID0gY3NzYAoKI2NvbW1lbnRzLWRldGFpbHMgewogICAgZGlzcGxheTogbm9uZTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBtYXgtd2lkdGg6IDEwMCU7CiAgICBvdmVyZmxvdzogaGlkZGVuOwp9CgouY29tbWVudCB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgbWF4LXdpZHRoOiA4MGNoOwogICAgbGluZS1oZWlnaHQ6IDEuNTsKfQoKLmNvbW1lbnQgLmljb24gewogICAgd2lkdGg6IDNlbTsKICAgIGhlaWdodDogM2VtOwogICAgYm9yZGVyLXJhZGl1czogMC41ZW07CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMWVtIDA7Cn0KCi5jb21tZW50IC5yaHMgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBtYXJnaW46IDAuNzVlbSAxZW0gMCAwOwogICAgZmxleC1ncm93OiAxOwp9CgouY29tbWVudCAuaGVhZGVyIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDAuNWVtOwogICAgYWxpZ24taXRlbXM6IGJhc2VsaW5lOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAuaGVhZGVyIC51cmwgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgouY29tbWVudCAucmhzIHAgewogICAgbWFyZ2luLWJsb2NrLXN0YXJ0OiAwZW07CiAgICBtYXJnaW4tYmxvY2stZW5kOiAwZW07Cn0KCi5jb21tZW50IGltZyB7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICB3aWR0aDogYXV0bzsKICAgIGhlaWdodDogYXV0bzsKfQoKYDsKZnVuY3Rpb24gaW5pdENvbW1lbnRzKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgY29tbWVudHNEZXRhaWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzLWRldGFpbHMnKTsKICAgIGNvbnN0IGNvbW1lbnRzU3ViamVjdFNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtc3ViamVjdCcpOwogICAgY29uc3QgY29tbWVudHNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHJlc3VsdCA9IHZtLmZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgY29tbWVudHNEZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSByZXN1bHQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGNvbW1lbnRzU3ViamVjdFNwYW4udGV4dENvbnRlbnQgPSByZXN1bHQ/LnN1YmplY3QgfHwgJ3N1YmplY3QnOwogICAgICAgIGlmIChyZXN1bHQgIT09IF9yZW5kZXJlZFJlc3VsdCkgewogICAgICAgICAgICByZW5kZXJDb21tZW50cyhyZXN1bHQsIGNvbW1lbnRzT3V0cHV0KTsKICAgICAgICAgICAgX3JlbmRlcmVkUmVzdWx0ID0gcmVzdWx0OwogICAgICAgIH0KICAgIH07Cn0KbGV0IF9yZW5kZXJlZFJlc3VsdDsKZnVuY3Rpb24gcmVuZGVyQ29tbWVudHMocmVzdWx0LCBjb21tZW50c091dHB1dCkgewogICAgd2hpbGUoY29tbWVudHNPdXRwdXQuZmlyc3RDaGlsZCljb21tZW50c091dHB1dC5yZW1vdmVDaGlsZChjb21tZW50c091dHB1dC5maXJzdENoaWxkKTsKICAgIGlmIChyZXN1bHQpIHJlbmRlck5vZGUocmVzdWx0LnJvb3RDb21tZW50LCByZXN1bHQuY29tbWVudGVycywgY29tbWVudHNPdXRwdXQsIDApOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUoY29tbWVudCwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwpIHsKICAgIGNvbnN0IGNvbW1lbnRlciA9IGNvbW1lbnRlcnMuZ2V0KGNvbW1lbnQuYXR0cmlidXRlZFRvKTsKICAgIGNvbnN0IGNvbW1lbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbW1lbnREaXYuY2xhc3NMaXN0LmFkZCgnY29tbWVudCcpOwogICAgaWYgKGxldmVsID4gMCkgY29tbWVudERpdi5zdHlsZS5tYXJnaW5MZWZ0ID0gYCR7bGV2ZWwgKiA0fWVtYDsKICAgIGNvbnN0IGljb25JbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgIGljb25JbWcuY2xhc3NMaXN0LmFkZCgnaWNvbicpOwogICAgaWNvbkltZy5zcmMgPSBjb21tZW50ZXIgPyBjb21tZW50ZXIuaWNvbi51cmwgOiAnIyc7CiAgICBjb21tZW50RGl2LmFwcGVuZENoaWxkKGljb25JbWcpOwogICAgY29uc3QgcmhzRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICByaHNEaXYuY2xhc3NMaXN0LmFkZCgncmhzJyk7CiAgICBjb25zdCBoZWFkZXJEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGhlYWRlckRpdi5jbGFzc0xpc3QuYWRkKCdoZWFkZXInKTsKICAgIGNvbnN0IGF0dHJpYnV0ZWRUb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgYXR0cmlidXRlZFRvRGl2LmNsYXNzTGlzdC5hZGQoJ2F0dHJpYnV0ZWQtdG8nKTsKICAgIGlmIChjb21tZW50ZXIpIHsKICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGEuaHJlZiA9IGNvbW1lbnRlci51cmw7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBhLnRleHRDb250ZW50ID0gY29tbWVudGVyLm5hbWUgKyAnICcgKyBjb21tZW50ZXIuZnFVc2VybmFtZTsKICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoYSk7CiAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZWRUb0Rpdi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb21tZW50LmF0dHJpYnV0ZWRUbykpOwogICAgfQogICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGF0dHJpYnV0ZWRUb0Rpdik7CiAgICBjb25zdCBhZ2VUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29tcHV0ZUFnZShuZXcgRGF0ZShjb21tZW50LnB1Ymxpc2hlZCkpKTsKICAgIGlmIChjb21tZW50LnVybCkgewogICAgICAgIGNvbnN0IGFnZUFuY2hvciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICBhZ2VBbmNob3IuY2xhc3NMaXN0LmFkZCgndXJsJyk7CiAgICAgICAgYWdlQW5jaG9yLmhyZWYgPSBjb21tZW50LnVybDsKICAgICAgICBleHRlcm5hbGl6ZUFuY2hvcihhZ2VBbmNob3IpOwogICAgICAgIGFnZUFuY2hvci5hcHBlbmRDaGlsZChhZ2VUZXh0KTsKICAgICAgICBoZWFkZXJEaXYuYXBwZW5kQ2hpbGQoYWdlQW5jaG9yKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGFnZVRleHQpOwogICAgfQogICAgcmhzRGl2LmFwcGVuZENoaWxkKGhlYWRlckRpdik7CiAgICBjb25zdCBjb250ZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb250ZW50RGl2LmlubmVySFRNTCA9IGNvbW1lbnQuY29udGVudDsKICAgIGNvbnRlbnREaXYucXVlcnlTZWxlY3RvckFsbCgnYScpLmZvckVhY2goZXh0ZXJuYWxpemVBbmNob3IpOwogICAgcmhzRGl2LmFwcGVuZENoaWxkKGNvbnRlbnREaXYpOwogICAgZm9yIChjb25zdCBhdHRhY2htZW50IG9mIGNvbW1lbnQuYXR0YWNobWVudHMpewogICAgICAgIGNvbnN0IGF0dGFjaG1lbnREZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGV0YWlscycpOwogICAgICAgIGNvbnN0IHN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICAgICAgc3VtbWFyeS50ZXh0Q29udGVudCA9IGBBdHRhY2htZW50ICgke2F0dGFjaG1lbnQubWVkaWFUeXBlfSlgOwogICAgICAgIGF0dGFjaG1lbnREZXRhaWxzLmFwcGVuZENoaWxkKHN1bW1hcnkpOwogICAgICAgIGNvbnN0IGltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgICAgIGltZy5zcmMgPSBhdHRhY2htZW50LnVybDsKICAgICAgICBpZiAoYXR0YWNobWVudC53aWR0aCAmJiBhdHRhY2htZW50LmhlaWdodCkgewogICAgICAgICAgICBpbWcud2lkdGggPSBhdHRhY2htZW50LndpZHRoOwogICAgICAgICAgICBpbWcuaGVpZ2h0ID0gYXR0YWNobWVudC5oZWlnaHQ7CiAgICAgICAgfQogICAgICAgIGF0dGFjaG1lbnREZXRhaWxzLmFwcGVuZENoaWxkKGltZyk7CiAgICAgICAgcmhzRGl2LmFwcGVuZENoaWxkKGF0dGFjaG1lbnREZXRhaWxzKTsKICAgIH0KICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQocmhzRGl2KTsKICAgIGNvbnRhaW5lckVsZW1lbnQuYXBwZW5kQ2hpbGQoY29tbWVudERpdik7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIGNvbW1lbnQucmVwbGllcyl7CiAgICAgICAgcmVuZGVyTm9kZShyZXBseSwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwgKyAxKTsKICAgIH0KfQpmdW5jdGlvbiBjb21wdXRlQWdlKGRhdGUpIHsKICAgIGNvbnN0IG1pbGxpcyA9IERhdGUubm93KCkgLSBkYXRlLmdldFRpbWUoKTsKICAgIGNvbnN0IHNlY29uZHMgPSBtaWxsaXMgLyAxMDAwOwogICAgY29uc3QgbWludXRlcyA9IHNlY29uZHMgLyA2MDsKICAgIGlmIChtaW51dGVzIDwgNjApIHJldHVybiBgJHtNYXRoLm1heChNYXRoLmZsb29yKG1pbnV0ZXMpLCAxKX1tYDsKICAgIGNvbnN0IGhvdXJzID0gbWludXRlcyAvIDYwOwogICAgaWYgKGhvdXJzIDwgMjQpIHJldHVybiBgJHtNYXRoLmZsb29yKGhvdXJzKX1oYDsKICAgIGNvbnN0IGRheXMgPSBob3VycyAvIDI0OwogICAgcmV0dXJuIGAke01hdGguZmxvb3IoZGF5cyl9ZGA7Cn0KY29uc3QgSU5GT19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnptMS05QzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHoiLz48L3N2Zz5gOwpjb25zdCBXQVJOSU5HX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PHBhdGggZD0iTTEyIDUuOTlMMTkuNTMgMTlINC40N0wxMiA1Ljk5TTIuNzQgMThjLS43NyAxLjMzLjE5IDMgMS43MyAzaDE1LjA2YzEuNTQgMCAyLjUtMS42NyAxLjczLTNMMTMuNzMgNC45OWMtLjc3LTEuMzMtMi42OS0xLjMzLTMuNDYgMEwyLjc0IDE4ek0xMSAxMXYyYzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMXYtMmMwLS41NS0uNDUtMS0xLTFzLTEgLjQ1LTEgMXptMCA1aDJ2MmgtMnoiLz48L3N2Zz5gOwpjb25zdCBFUlJPUl9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0yMC43MSA3Ljk4TDE2LjAzIDMuM2MtLjE5LS4xOS0uNDUtLjMtLjcxLS4zSDguNjhjLS4yNiAwLS41Mi4xMS0uNy4yOUwzLjI5IDcuOThjLS4xOC4xOC0uMjkuNDQtLjI5Ljd2Ni42M2MwIC4yNy4xMS41Mi4yOS43MWw0LjY4IDQuNjhjLjE5LjE5LjQ1LjMuNzEuM2g2LjYzYy4yNyAwIC41Mi0uMTEuNzEtLjI5bDQuNjgtNC42OGMuMTktLjE5LjI5LS40NC4yOS0uNzFWOC42OGMuMDEtLjI2LS4xLS41Mi0uMjgtLjd6TTE5IDE0LjlMMTQuOSAxOUg5LjFMNSAxNC45VjkuMUw5LjEgNWg1LjhMMTkgOS4xdjUuOHoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjE2IiByPSIxIi8+PHBhdGggZD0iTTEyIDdjLS41NSAwLTEgLjQ1LTEgMXY1YzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMVY4YzAtLjU1LS40NS0xLTEtMXoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHptMy44OC0xMS43MUwxMCAxNC4xN2wtMS44OC0xLjg4Yy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMC0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDIuNTkgMi41OWMuMzkuMzkgMS4wMi4zOSAxLjQxIDBMMTcuMyA5LjdjLjM5LS4zOS4zOS0xLjAyIDAtMS40MS0uMzktLjM5LTEuMDMtLjM5LTEuNDIgMHoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS0xJU1RfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik01LDVoMnYxYzAsMS4xLDAuOSwyLDIsMmg2YzEuMSwwLDItMC45LDItMlY1aDJ2NWgyVjVjMC0xLjEtMC45LTItMi0yaC00LjE4QzE0LjQsMS44NCwxMy4zLDEsMTIsMVM5LjYsMS44NCw5LjE4LDNINSBDMy45LDMsMywzLjksMyw1djE0YzAsMS4xLDAuOSwyLDIsMmg2di0ySDVWNXogTTEyLDNjMC41NSwwLDEsMC40NSwxLDFzLTAuNDUsMS0xLDFzLTEtMC40NS0xLTFTMTEuNDUsMywxMiwzeiIvPjxwYXRoIGQ9Ik0yMS43NSwxMi4yNWMtMC40MS0wLjQxLTEuMDktMC40MS0xLjUsMEwxNS41MSwxN2wtMi4yNi0yLjI1Yy0wLjQxLTAuNDEtMS4wOC0wLjQxLTEuNSwwbDAsMGMtMC40MSwwLjQxLTAuNDEsMS4wOSwwLDEuNSBsMy4wNSwzLjA0YzAuMzksMC4zOSwxLjAyLDAuMzksMS40MSwwbDUuNTMtNS41NEMyMi4xNiwxMy4zNCwyMi4xNiwxMi42NiwyMS43NSwxMi4yNXoiLz48L2c+PC9nPjwvc3ZnPmA7CmNvbnN0IFNRVUFSRV9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNCAyNCIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48Zz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjI0IiB3aWR0aD0iMjQiLz48L2c+PGc+PGc+PHBhdGggZD0iTTMsM3YxOGgxOFYzSDN6IE0xOSwxOUg1VjVoMTRWMTl6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBGT1JNX0hUTUwgPSBodG1sYAo8aGVhZGVyPiR7Q0hFQ0tMSVNUX0lDT059PGgxPkxpdmV3aXJlIFBvZGNhc3QgVmFsaWRhdG9yIDxzcGFuIGlkPSJ2ZXJzaW9uIj52MC4yPC9zcGFuPjwvaDE+PC9oZWFkZXI+Cjxmb3JtIGlkPSJmb3JtIj4KICAgIDxpbnB1dCBpZD0idGV4dC1pbnB1dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IlBvZGNhc3QgZmVlZCB1cmwsIEFjdGl2aXR5UHViIHVybCwgQXBwbGUgUG9kY2FzdHMgdXJsLCBvciBzZWFyY2ggdGV4dCIgYXV0b2NvbXBsZXRlPSJ1cmwiIHJlcXVpcmVkPgogICAgPGJ1dHRvbiBpZD0ic3VibWl0IiB0eXBlPSJzdWJtaXQiPlZhbGlkYXRlPC9idXR0b24+CjwvZm9ybT4KYDsKY29uc3QgRk9STV9DU1MgPSBjc3NgCgpoZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDFyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgb3BhY2l0eTogMC43NTsKfQoKaGVhZGVyIGgxIHsKICAgIG1hcmdpbjogMDsKfQoKaGVhZGVyIHN2ZyB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiN2ZXJzaW9uIHsKICAgIG9wYWNpdHk6IDAuMjU7Cn0KCiNmb3JtIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwp9CgovKiogaW9zIHJlc2V0cyAqLwpAc3VwcG9ydHMgKC13ZWJraXQtdG91Y2gtY2FsbG91dDogbm9uZSkgewogICAgaW5wdXQsIHRleHRhcmVhLCBidXR0b24gewogICAgICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgICAgICBib3JkZXItcmFkaXVzOiAwOwogICAgfQoKICAgIGJ1dHRvbiB7CiAgICAgICAgYm9yZGVyOiBzb2xpZCAxcHggd2hpdGU7CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDY1MHB4KSB7CgogICAgaGVhZGVyIHsKICAgICAgICBmb250LXNpemU6IDY2JTsKICAgICAgICBnYXA6IDAuNXJlbTsKICAgIH0KCiAgICBoZWFkZXIgc3ZnIHsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7CiAgICB9CgogICAgI2Zvcm0gewogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDUwMHB4KSB7CgogICAgI3ZlcnNpb24gewogICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9Cgp9CgojdGV4dC1pbnB1dCB7CiAgICBmb250LXNpemU6IDFyZW07CiAgICBmbGV4LWdyb3c6IDE7CiAgICBwYWRkaW5nOiAwLjVyZW0gMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgb3V0bGluZTogbm9uZTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3RleHQtaW5wdXQ6cmVhZC1vbmx5IHsKICAgIG9wYWNpdHk6IDAuNTsgCn0KCmlucHV0Oi13ZWJraXQtYXV0b2ZpbGwsIGlucHV0Oi13ZWJraXQtYXV0b2ZpbGw6Zm9jdXMgewogICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciA2MDAwMDBzIDBzLCBjb2xvciA2MDAwMDBzIDBzOwp9CgojZm9ybSBidXR0b24gewogICAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRGb3JtKGRvY3VtZW50LCB2bSwgc3RhdGljRGF0YSkgewogICAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtJyk7CiAgICBjb25zdCB0ZXh0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dC1pbnB1dCcpOwogICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Ym1pdCcpOwogICAgY29uc3QgdmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyc2lvbicpOwogICAgY29uc3QgdmVyc2lvbiA9IFsKICAgICAgICBzdGF0aWNEYXRhLnZlcnNpb24sCiAgICAgICAgc3RhdGljRGF0YS5wdXNoSWQKICAgIF0ubWFwKCh2KT0+KHYgfHwgJycpLnRyaW0oKQogICAgKS5maWx0ZXIoKHYpPT52Lmxlbmd0aCA+IDAKICAgICkuam9pbignLicpOwogICAgdmVyc2lvblNwYW4udGV4dENvbnRlbnQgPSBzdGF0aWNEYXRhLnZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyAgfSA9IG5ldyBVUkwoZG9jdW1lbnQuVVJMKTsKICAgIGNvbnN0IHZhbGlkYXRlID0gc2VhcmNoUGFyYW1zLmdldCgndmFsaWRhdGUnKSB8fCB1bmRlZmluZWQ7CiAgICBjb25zdCBpbnB1dCA9IHNlYXJjaFBhcmFtcy5nZXQoJ2lucHV0JykgfHwgdW5kZWZpbmVkOwogICAgY29uc3Qgbm9jb21tZW50cyA9IHNlYXJjaFBhcmFtcy5oYXMoJ25vY29tbWVudHMnKTsKICAgIGNvbnN0IHN0YXJ0VmFsaWRhdGlvbiA9ICgpPT52bS5zdGFydFZhbGlkYXRpb24odGV4dElucHV0LnZhbHVlLCB7CiAgICAgICAgICAgIHZhbGlkYXRlQ29tbWVudHM6ICFub2NvbW1lbnRzLAogICAgICAgICAgICB1c2VyQWdlbnQ6IG5hdmlnYXRvci51c2VyQWdlbnQKICAgICAgICB9KQogICAgOwogICAgZm9ybS5vbnN1Ym1pdCA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAodm0udmFsaWRhdGluZykgewogICAgICAgICAgICB2bS5jYW5jZWxWYWxpZGF0aW9uKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRWYWxpZGF0aW9uKCk7CiAgICAgICAgfQogICAgfTsKICAgIGlmICh2YWxpZGF0ZSkgewogICAgICAgIHRleHRJbnB1dC52YWx1ZSA9IHZhbGlkYXRlOwogICAgICAgIHNldFRpbWVvdXQoc3RhcnRWYWxpZGF0aW9uLCAwKTsKICAgIH0gZWxzZSBpZiAoaW5wdXQpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSBpbnB1dDsKICAgIH0KICAgIHRleHRJbnB1dC5mb2N1cygpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSB0ZXh0SW5wdXQuZGlzYWJsZWQ7CiAgICAgICAgdGV4dElucHV0LmRpc2FibGVkID0gdm0udmFsaWRhdGluZzsKICAgICAgICB0ZXh0SW5wdXQucmVhZE9ubHkgPSB2bS52YWxpZGF0aW5nOwogICAgICAgIHN1Ym1pdEJ1dHRvbi50ZXh0Q29udGVudCA9IHZtLnZhbGlkYXRpbmcgPyAnQ2FuY2VsJyA6ICdWYWxpZGF0ZSc7CiAgICAgICAgaWYgKHdhc0Rpc2FibGVkICYmICF0ZXh0SW5wdXQuZGlzYWJsZWQpIHsKICAgICAgICAgICAgdGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNRVNTQUdFU19IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ibWVzc2FnZXMiPjwvb3V0cHV0PgpgOwpjb25zdCBNRVNTQUdFU19DU1MgPSBjc3NgCgojbWVzc2FnZXMgewogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDJyZW0gYXV0bzsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07Cn0KCiNtZXNzYWdlcyA+IGRpdiwgI21lc3NhZ2VzID4gYSB7CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwp9CgojbWVzc2FnZXMgc3ZnIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC43NSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiNtZXNzYWdlcyA+IGRpdi5pbmZvIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKI21lc3NhZ2VzID4gZGl2Lmdvb2QgewogICAgY29sb3I6ICM0M2EwNDc7Cn0KI21lc3NhZ2VzID4gZGl2Lndhcm5pbmcgewogICAgY29sb3I6ICNlNjUxMDA7Cn0KCiNtZXNzYWdlcyA+IGRpdi5lcnJvciB7CiAgICBjb2xvcjogI2I3MWMxYzsKfQoKI21lc3NhZ2VzID4gZGl2LnJ1bm5pbmcsICNtZXNzYWdlcyA+IGRpdi5kb25lIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI21lc3NhZ2VzIC5pY29uIHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgd2lkdGg6IDI0cHg7CiAgICBoZWlnaHQ6IDI0cHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgojbWVzc2FnZXMgLm1lc3NhZ2UgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCiNtZXNzYWdlcyAudXJsIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKfQoKI21lc3NhZ2VzIHByb2dyZXNzIHsKICAgIGZvbnQtc2l6ZTogMC4zNXJlbTsKfQoKI21lc3NhZ2VzIC5yZWZlcmVuY2UgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgbWFyZ2luLWxlZnQ6IDAuMjVyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRNZXNzYWdlcyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IG1lc3NhZ2VzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2VzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihNRVNTQUdFX0hUTUwodm0pLCBtZXNzYWdlc091dHB1dCk7CiAgICB9Owp9CmNvbnN0IE1FU1NBR0VfSFRNTCA9ICh2bSk9Pmh0bWxgCiAgICAke3ZtLm1lc3NhZ2VzLmZpbHRlcihmaWx0ZXJEdXBsaWNhdGVzKCkpLm1hcCgobWVzc2FnZSk9Pmh0bWxgCiAgICAgICAgPGRpdiBjbGFzcz0iJHttZXNzYWdlLnR5cGV9IGljb24iPiR7aWNvbihtZXNzYWdlLnR5cGUpfTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBtZXNzYWdlIj4ke21lc3NhZ2UudGV4dH0ke1JFRkVSRU5DRV9IVE1MKG1lc3NhZ2UucmVmZXJlbmNlKX08L2Rpdj4KICAgICAgICAke0FOQ0hPUl9IVE1MKG1lc3NhZ2UudXJsKX1gCiAgICApfWAKOwpjb25zdCBSRUZFUkVOQ0VfSFRNTCA9IChyZWZlcmVuY2UpPT5yZWZlcmVuY2UgPyBodG1sYDxhIGNsYXNzPSJyZWZlcmVuY2UiIGhyZWY9JHtyZWZlcmVuY2UuaHJlZn0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyI+WyR7cmVmZXJlbmNlLnJ1bGVzZXR9XTwvYT5gIDogdW5kZWZpbmVkCjsKY29uc3QgQU5DSE9SX0hUTUwgPSAodXJsKT0+dXJsID8gaHRtbGA8YSBocmVmPSR7dXJsfSB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93IiBjbGFzcz0idXJsIj4ke3VybH08L2E+YCA6IHVuZGVmaW5lZAo7CmZ1bmN0aW9uIGljb24odHlwZSkgewogICAgcmV0dXJuIHR5cGUgPT09ICdydW5uaW5nJyA/IGh0bWxgPHByb2dyZXNzIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPmAgOiB0eXBlID09PSAnZG9uZScgPyBDSEVDS19JQ09OIDogdHlwZSA9PT0gJ2Vycm9yJyA/IEVSUk9SX0lDT04gOiB0eXBlID09PSAnd2FybmluZycgPyBXQVJOSU5HX0lDT04gOiB0eXBlID09PSAnZ29vZCcgPyBDSEVDS19JQ09OIDogSU5GT19JQ09OOwp9CmZ1bmN0aW9uIGZpbHRlckR1cGxpY2F0ZXMoKSB7CiAgICBjb25zdCB0YWdVcmxzID0gbmV3IFNldCgpOwogICAgcmV0dXJuIChtZXNzYWdlKT0+ewogICAgICAgIGNvbnN0IHsgdGFnICwgdXJsICB9ID0gbWVzc2FnZTsKICAgICAgICBpZiAodGFnICYmIHVybCkgewogICAgICAgICAgICBjb25zdCB0YWdVcmwgPSBgJHt0YWd9fCR7dXJsfWA7CiAgICAgICAgICAgIGlmICh0YWdVcmxzLmhhcyh0YWdVcmwpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRhZ1VybHMuYWRkKHRhZ1VybCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH07Cn0KY29uc3QgU0VBUkNIX1JFU1VMVFNfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InNlYXJjaC1yZXN1bHRzIj48L291dHB1dD4KYDsKY29uc3QgU0VBUkNIX1JFU1VMVFNfQ1NTID0gY3NzYAoKI3NlYXJjaC1yZXN1bHRzIHsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBkaXNwbGF5OiBub25lOwp9Cgojc2VhcmNoLXJlc3VsdHMgPiBkaXYgewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGFuaW1hdGlvbjogZmFkZUluQW5pbWF0aW9uIDAuNHM7CiAgICBtYXJnaW4tYm90dG9tOiAwLjc1cmVtOwogICAgY3Vyc29yOiBwb2ludGVyOwp9Cgojc2VhcmNoLXJlc3VsdHMgLmljb24sICNzZWFyY2gtcmVzdWx0cyBpbWcgewogICAgd2lkdGg6IDEuNXJlbTsKICAgIGhlaWdodDogMS41cmVtOwp9Cgojc2VhcmNoLXJlc3VsdHMgLnRpdGxlIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3NlYXJjaC1yZXN1bHRzIC5hdXRob3IgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgpgOwpmdW5jdGlvbiBpbml0U2VhcmNoUmVzdWx0cyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHNlYXJjaFJlc3VsdHNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VhcmNoLXJlc3VsdHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFJFU1VMVFNfSFRNTCh2bSksIHNlYXJjaFJlc3VsdHNPdXRwdXQpOwogICAgICAgIHNlYXJjaFJlc3VsdHNPdXRwdXQuc3R5bGUuZGlzcGxheSA9IHZtLmlzU2VhcmNoID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgIH07Cn0KY29uc3QgUkVTVUxUU19IVE1MID0gKHZtKT0+aHRtbGAKICAgICR7dm0uc2VhcmNoUmVzdWx0cy5tYXAoKHJlc3VsdCk9Pmh0bWxgPGRpdiBjbGFzcz0ic2VhcmNoLXJlc3VsdCIgQGNsaWNrPSIke3NlbGVjdFJlc3VsdCh2bSwgcmVzdWx0LnVybCl9Ij48ZGl2IGNsYXNzPSJpY29uIj4ke0lNQUdFX0hUTUwocmVzdWx0LmFydHdvcmspfTwvZGl2PjxkaXYgY2xhc3M9InRpdGxlIj4ke3Jlc3VsdC50aXRsZX08L2Rpdj48ZGl2IGNsYXNzPSJhdXRob3IiPiR7cmVzdWx0LmF1dGhvcn08L2Rpdj48L2Rpdj5gCiAgICApfWAKOwpjb25zdCBJTUFHRV9IVE1MID0gKGFydHdvcmspPT5hcnR3b3JrID8gaHRtbGA8aW1nIHNyYz0ke2FydHdvcmt9PmAgOiBTUVVBUkVfSUNPTgo7CmZ1bmN0aW9uIHNlbGVjdFJlc3VsdCh2bSwgdXJsKSB7CiAgICByZXR1cm4gKCk9PnZtLmNvbnRpbnVlV2l0aCh1cmwpCiAgICA7Cn0KY29uc3QgWE1MX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJ4bWwiPjwvb3V0cHV0PgpgOwpjb25zdCBYTUxfQ1NTID0gY3NzYAojeG1sIHsKICAgIGZvbnQtZmFtaWx5OiAke3Vuc2FmZUNTUyhUaGVtZS5tb25vc3BhY2VGb250RmFtaWx5KX07CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBsaW5lLWhlaWdodDogMXJlbTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKICAgIG92ZXJmbG93LXdyYXA6IGJyZWFrLXdvcmQ7Cn0KCiN4bWwgLmNvbnRlbnQgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9Owp9CgojeG1sIC5wb2RjYXN0IHsKICAgIGNvbG9yOiAjYWI0N2JjOwp9CgojeG1sIC5pbmRlbnQgewogICAgbWFyZ2luLWxlZnQ6IDAuNzVyZW07Cn0KCiN4bWwgLmluZGVudDIgewogICAgbWFyZ2luLWxlZnQ6IDEuNXJlbTsKfQoKc3VtbWFyeS5lbXB0eSB7IGxpc3Qtc3R5bGU6IG5vbmU7IGN1cnNvcjogdGV4dDsgfQpzdW1tYXJ5LmVtcHR5Ojotd2Via2l0LWRldGFpbHMtbWFya2VyIHsgZGlzcGxheTogbm9uZTsgfQoKI3htbCBhdWRpbyB7CiAgICBtYXJnaW46IDAuNXJlbSAxcmVtOwp9CmA7CmZ1bmN0aW9uIGluaXRYbWwoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCB4bWxPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgneG1sJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBjb25zdCB4bWwgPSB2bS54bWw7CiAgICAgICAgaWYgKHhtbCAhPT0gX3JlbmRlcmVkWG1sKSB7CiAgICAgICAgICAgIHJlbmRlclhtbCh4bWwsIHhtbE91dHB1dCk7CiAgICAgICAgICAgIF9yZW5kZXJlZFhtbCA9IHhtbDsKICAgICAgICB9CiAgICB9Owp9CmxldCBfcmVuZGVyZWRYbWw7CmZ1bmN0aW9uIHJlbmRlclhtbCh4bWwsIHhtbE91dHB1dCkgewogICAgd2hpbGUoeG1sT3V0cHV0LmZpcnN0Q2hpbGQpeG1sT3V0cHV0LnJlbW92ZUNoaWxkKHhtbE91dHB1dC5maXJzdENoaWxkKTsKICAgIGlmICh4bWwpIHJlbmRlck5vZGUxKHhtbCwgeG1sT3V0cHV0LCAwLCBuZXcgU2V0KCksIHVuZGVmaW5lZCk7Cn0KZnVuY3Rpb24gcmVuZGVyTm9kZTEobm9kZSwgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwsIGNvbnRleHQsIGl0ZW1OdW1iZXIpIHsKICAgIGNvbnN0IHsgYXR0cyAgfSA9IG5vZGU7CiAgICBjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGV0YWlscycpOwogICAgY29uc3QgdGV4dCA9IG5vZGUudmFsIHx8ICcnOwogICAgZGV0YWlscy5vcGVuID0gIWNvbnRleHQuaGFzKCdmb3VuZC1pdGVtJykgfHwgdGV4dC5sZW5ndGggPiAwOwogICAgaWYgKGxldmVsID4gMCkgZGV0YWlscy5jbGFzc0xpc3QuYWRkKCdpbmRlbnQnKTsKICAgIGNvbnN0IHN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICBpZiAobGV2ZWwgPT09IDApIHsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKHN1bW1hcnksICdYbWwnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BhbkNsYXNzID0gUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLmluY2x1ZGVzKG5vZGUucW5hbWUubmFtZXNwYWNlVXJpIHx8ICcnKSA/ICdwb2RjYXN0JyA6IHVuZGVmaW5lZDsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKHN1bW1hcnksICc8JywgewogICAgICAgICAgICB0ZXh0OiBub2RlLnRhZ25hbWUsCiAgICAgICAgICAgIHNwYW5DbGFzcwogICAgICAgIH0sIC4uLlsKICAgICAgICAgICAgLi4uYXR0cy5lbnRyaWVzKCkKICAgICAgICBdLmZsYXRNYXAoKHYpPT5bCiAgICAgICAgICAgICAgICBgICR7dlswXX09ImAsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogdlsxXSwKICAgICAgICAgICAgICAgICAgICBzcGFuQ2xhc3M6ICdjb250ZW50JwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICciJwogICAgICAgICAgICBdCiAgICAgICAgKSwgJz4nLCBpdGVtTnVtYmVyID8gYCAjJHtpdGVtTnVtYmVyfWAgOiAnJyk7CiAgICB9CiAgICBkZXRhaWxzLmFwcGVuZENoaWxkKHN1bW1hcnkpOwogICAgbGV0IGNoaWxkQ291bnQgPSAwOwogICAgaWYgKHRleHQubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCdjb250ZW50Jyk7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhkaXYsIHRleHQpOwogICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCdpbmRlbnQyJyk7CiAgICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChkaXYpOwogICAgICAgIGNoaWxkQ291bnQrKzsKICAgIH0KICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhub2RlLmNoaWxkKSl7CiAgICAgICAgbGV0IGl0ZW1OdW1iZXIgPSAxOwogICAgICAgIGxldCBpdGVtc05vdFNob3duID0gMDsKICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHZhbHVlKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdpdGVtJyAmJiBpdGVtTnVtYmVyID4gMjApIHsKICAgICAgICAgICAgICAgIGl0ZW1zTm90U2hvd24rKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlck5vZGUxKGNoaWxkLCBkZXRhaWxzLCBsZXZlbCArIDEsIGNvbnRleHQsIHZhbHVlLmxlbmd0aCA+IDEgPyBpdGVtTnVtYmVyIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgY2hpbGRDb3VudCsrOwogICAgICAgICAgICBpdGVtTnVtYmVyKys7CiAgICAgICAgfQogICAgICAgIGlmIChpdGVtc05vdFNob3duID4gMCkgewogICAgICAgICAgICBjb25zdCBmYWtlTm9kZSA9IHsKICAgICAgICAgICAgICAgIHRhZ25hbWU6IGAuLi5hbmQgJHtuZXcgSW50bC5OdW1iZXJGb3JtYXQoKS5mb3JtYXQoaXRlbXNOb3RTaG93bil9IG1vcmUgaXRlbXNgLAogICAgICAgICAgICAgICAgYXR0czogbmV3IE1hcCgpLAogICAgICAgICAgICAgICAgcW5hbWU6IHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGF0dHJzTWFwOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2hpbGQ6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmVuZGVyTm9kZTEoZmFrZU5vZGUsIGRldGFpbHMsIGxldmVsIC0gMSwgY29udGV4dCwgdW5kZWZpbmVkKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zdCBhdWRpb1VybCA9IG5vZGUudGFnbmFtZSA9PT0gJ2VuY2xvc3VyZScgJiYgYXR0cy5nZXQoJ3VybCcpIHx8IG5vZGUucW5hbWUubmFtZXNwYWNlVXJpICYmIHFuYW1lc0luY2x1ZGUoUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VyY2UsIG5vZGUucW5hbWUpICYmIGF0dHMuZ2V0KCd1cmknKSB8fCBxbmFtZUVxKG5vZGUucW5hbWUsIFFuYW1lcy5NZWRpYVJzcy5jb250ZW50KSAmJiAoYXR0cy5nZXQoJ3R5cGUnKSB8fCAnJykuc3RhcnRzV2l0aCgnYXVkaW8nKSAmJiBhdHRzLmdldCgndXJsJyk7CiAgICBpZiAoYXVkaW9VcmwpIHsKICAgICAgICBjb25zdCBhdWRpbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7CiAgICAgICAgYXVkaW8uY29udHJvbHMgPSB0cnVlOwogICAgICAgIGF1ZGlvLnByZWxvYWQgPSAnbm9uZSc7CiAgICAgICAgYXVkaW8uc3JjID0gYXVkaW9Vcmw7CiAgICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChhdWRpbyk7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgaWYgKGNoaWxkQ291bnQgPT09IDApIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgnZW1wdHknLCAnaW5kZW50Jyk7CiAgICBjb250YWluZXJFbGVtZW50LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgaWYgKG5vZGUudGFnbmFtZSA9PT0gJ2l0ZW0nKSBjb250ZXh0LmFkZCgnZm91bmQtaXRlbScpOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRQaWVjZXMoZWxlbWVudCwgLi4ucGllY2VzKSB7CiAgICBmb3IgKGNvbnN0IHBpZWNlIG9mIHBpZWNlcyl7CiAgICAgICAgY29uc3QgdGV4dCA9IHR5cGVvZiBwaWVjZSA9PT0gJ3N0cmluZycgPyBwaWVjZSA6IHBpZWNlLnRleHQ7CiAgICAgICAgY29uc3Qgc3BhbkNsYXNzID0gdHlwZW9mIHBpZWNlID09PSAnb2JqZWN0JyA/IHBpZWNlLnNwYW5DbGFzcyA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAoL15odHRwcz86XC9cL1teXHMpXSskLy50ZXN0KHRleHQpKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHRleHQ7CiAgICAgICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGEpOwogICAgICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgICAgICBpZiAoc3BhbkNsYXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgc3Bhbi5jbGFzc0xpc3QuYWRkKHNwYW5DbGFzcyk7CiAgICAgICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCmEgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnByaW1hcnlDb2xvcjMwMEhleCl9OwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICBhOmhvdmVyIHsKICAgICAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICAgIH0KfQoKbWFpbiB7CiAgICBtYXJnaW46IDJyZW07CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKQGtleWZyYW1lcyBmYWRlSW5BbmltYXRpb24gewogICAgMCUgewogICAgICAgIG9wYWNpdHk6IDA7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBvcGFjaXR5OiAxOwogICAgfQp9CgpzdW1tYXJ5IHsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKYDsKY29uc3QgYXBwSHRtbCA9IGh0bWxgCjxtYWluPgoke0ZPUk1fSFRNTH0KJHtNRVNTQUdFU19IVE1MfQoke1NFQVJDSF9SRVNVTFRTX0hUTUx9CiR7Q09NTUVOVFNfSFRNTH0KJHtYTUxfSFRNTH0KPC9tYWluPgpgOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgYXBwQ3NzLmNzc1RleHQsCiAgICBGT1JNX0NTUy5jc3NUZXh0LAogICAgTUVTU0FHRVNfQ1NTLmNzc1RleHQsCiAgICBTRUFSQ0hfUkVTVUxUU19DU1MuY3NzVGV4dCwKICAgIENPTU1FTlRTX0NTUy5jc3NUZXh0LAogICAgWE1MX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmZ1bmN0aW9uIHBhcnNlU3RhdGljRGF0YSgpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0aWMtZGF0YS1zY3JpcHQnKTsKICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YS52ZXJzaW9uID09PSAnc3RyaW5nJyA/IGRhdGEudmVyc2lvbiA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGZsYWdzID0gdHlwZW9mIGRhdGEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YS5mbGFncyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGRlYnVnID0gdHlwZW9mIGRhdGEuZGVidWcgPT09ICdvYmplY3QnID8gZGF0YS5kZWJ1ZyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IHB1c2hJZCA9IHR5cGVvZiBkYXRhLnB1c2hJZCA9PT0gJ3N0cmluZycgPyBkYXRhLnB1c2hJZCA6IHVuZGVmaW5lZDsKICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbiwKICAgICAgICBmbGFncywKICAgICAgICBkZWJ1ZywKICAgICAgICBwdXNoSWQKICAgIH07Cn0KY29uc3Qgc3RhdGljRGF0YSA9IHBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCB2bSA9IG5ldyBWYWxpZGF0b3JBcHBWTSgpOwpjb25zdCB1cGRhdGVGb3JtID0gaW5pdEZvcm0oZG9jdW1lbnQsIHZtLCBzdGF0aWNEYXRhKTsKY29uc3QgdXBkYXRlTWVzc2FnZXMgPSBpbml0TWVzc2FnZXMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlU2VhcmNoUmVzdWx0cyA9IGluaXRTZWFyY2hSZXN1bHRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZUNvbW1lbnRzID0gaW5pdENvbW1lbnRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZVhtbCA9IGluaXRYbWwoZG9jdW1lbnQsIHZtKTsKdm0ub25DaGFuZ2UgPSAoKT0+ewogICAgdXBkYXRlRm9ybSgpOwogICAgdXBkYXRlTWVzc2FnZXMoKTsKICAgIHVwZGF0ZVNlYXJjaFJlc3VsdHMoKTsKICAgIHVwZGF0ZUNvbW1lbnRzKCk7CiAgICB1cGRhdGVYbWwoKTsKfTsKdm0uc3RhcnQoKTsKc2V0QXBwU3RhdGUoJ3N0YXJ0ZWQnKTsK';
