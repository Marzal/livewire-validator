

export const VALIDATOR_APP_HASH = '025aed45bcc184c8ea16ae1141f6b48612cbd2b9';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlbW92ZU5vZGVzID0gKGNvbnRhaW5lciwgc3RhcnQsIGVuZCA9IG51bGwpPT57CiAgICB3aGlsZShzdGFydCAhPT0gZW5kKXsKICAgICAgICBjb25zdCBuID0gc3RhcnQubmV4dFNpYmxpbmc7CiAgICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKHN0YXJ0KTsKICAgICAgICBzdGFydCA9IG47CiAgICB9Cn07CmNvbnN0IG5vQ2hhbmdlID0gewp9Owpjb25zdCBub3RoaW5nID0gewp9Owpjb25zdCBtYXJrZXIgPSBge3tsaXQtJHtTdHJpbmcoTWF0aC5yYW5kb20oKSkuc2xpY2UoMil9fX1gOwpjb25zdCBub2RlTWFya2VyID0gYDwhLS0ke21hcmtlcn0tLT5gOwpjb25zdCBtYXJrZXJSZWdleCA9IG5ldyBSZWdFeHAoYCR7bWFya2VyfXwke25vZGVNYXJrZXJ9YCk7CmNvbnN0IGJvdW5kQXR0cmlidXRlU3VmZml4ID0gIiRsaXQkIjsKY2xhc3MgVGVtcGxhdGUgewogICAgY29uc3RydWN0b3IocmVzdWx0LCBlbGVtZW50KXsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICBjb25zdCBub2Rlc1RvUmVtb3ZlID0gW107CiAgICAgICAgY29uc3Qgc3RhY2sgPSBbXTsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGVsZW1lbnQuY29udGVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IGxhc3RQYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpbmRleCA9IC0xOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGNvbnN0IHsgc3RyaW5ncyAsIHZhbHVlczogeyBsZW5ndGggIH0gIH0gPSByZXN1bHQ7CiAgICAgICAgd2hpbGUocGFydEluZGV4IDwgbGVuZ3RoKXsKICAgICAgICAgICAgY29uc3Qgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICBpZiAobm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMSkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuaGFzQXR0cmlidXRlcygpKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlcyA9IG5vZGUuYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGxlbmd0aDogbGVuZ3RoMiAgfSA9IGF0dHJpYnV0ZXM7CiAgICAgICAgICAgICAgICAgICAgbGV0IGNvdW50ID0gMDsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuZ3RoMjsgaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGVuZHNXaXRoKGF0dHJpYnV0ZXNbaV0ubmFtZSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb3VudCsrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHdoaWxlKGNvdW50LS0gPiAwKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nRm9yUGFydCA9IHN0cmluZ3NbcGFydEluZGV4XTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbmFtZSA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzdHJpbmdGb3JQYXJ0KVsyXTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTG9va3VwTmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKSArIGJvdW5kQXR0cmlidXRlU3VmZml4OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVWYWx1ZSA9IG5vZGUuZ2V0QXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBub2RlLnJlbW92ZUF0dHJpYnV0ZShhdHRyaWJ1dGVMb29rdXBOYW1lKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RhdGljcyA9IGF0dHJpYnV0ZVZhbHVlLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJhdHRyaWJ1dGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RyaW5nczogc3RhdGljcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICAgICAgcGFydEluZGV4ICs9IHN0YXRpY3MubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAobm9kZS50YWdOYW1lID09PSAiVEVNUExBVEUiKSB7CiAgICAgICAgICAgICAgICAgICAgc3RhY2sucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBub2RlLmNvbnRlbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICAgICAgY29uc3QgZGF0YSA9IG5vZGUuZGF0YTsKICAgICAgICAgICAgICAgIGlmIChkYXRhLmluZGV4T2YobWFya2VyKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0cmluZ3MyID0gZGF0YS5zcGxpdChtYXJrZXJSZWdleCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgbGFzdEluZGV4ID0gc3RyaW5nczIubGVuZ3RoIC0gMTsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGFzdEluZGV4OyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgaW5zZXJ0OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcyA9IHN0cmluZ3MyW2ldOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAocyA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGNyZWF0ZU1hcmtlcigpOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgbWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobWF0Y2ggIT09IG51bGwgJiYgZW5kc1dpdGgobWF0Y2hbMl0sIGJvdW5kQXR0cmlidXRlU3VmZml4KSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBzLnNsaWNlKDAsIG1hdGNoLmluZGV4KSArIG1hdGNoWzFdICsgbWF0Y2hbMl0uc2xpY2UoMCwgLWJvdW5kQXR0cmlidXRlU3VmZml4Lmxlbmd0aCkgKyBtYXRjaFszXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluc2VydCA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHMpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudC5pbnNlcnRCZWZvcmUoaW5zZXJ0LCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5wYXJ0cy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4OiArK2luZGV4CiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoc3RyaW5nczJbbGFzdEluZGV4XSA9PT0gIiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjcmVhdGVNYXJrZXIoKSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGVzVG9SZW1vdmUucHVzaChub2RlKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSBzdHJpbmdzMltsYXN0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gbGFzdEluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKG5vZGUubm9kZVR5cGUgPT09IDgpIHsKICAgICAgICAgICAgICAgIGlmIChub2RlLmRhdGEgPT09IG1hcmtlcikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhcmVudCA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5wcmV2aW91c1NpYmxpbmcgPT09IG51bGwgfHwgaW5kZXggPT09IGxhc3RQYXJ0SW5kZXgpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShjcmVhdGVNYXJrZXIoKSwgbm9kZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGxhc3RQYXJ0SW5kZXggPSBpbmRleDsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4CiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUubmV4dFNpYmxpbmcgPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZS5kYXRhID0gIiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICBpbmRleC0tOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IGkgPSAtMTsKICAgICAgICAgICAgICAgICAgICB3aGlsZSgoaSA9IG5vZGUuZGF0YS5pbmRleE9mKG1hcmtlciwgaSArIDEpKSAhPT0gLTEpewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6IC0xCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBuIG9mIG5vZGVzVG9SZW1vdmUpewogICAgICAgICAgICBuLnBhcmVudE5vZGUucmVtb3ZlQ2hpbGQobik7CiAgICAgICAgfQogICAgfQp9CmNvbnN0IGVuZHNXaXRoID0gKHN0ciwgc3VmZml4KT0+ewogICAgY29uc3QgaW5kZXggPSBzdHIubGVuZ3RoIC0gc3VmZml4Lmxlbmd0aDsKICAgIHJldHVybiBpbmRleCA+PSAwICYmIHN0ci5zbGljZShpbmRleCkgPT09IHN1ZmZpeDsKfTsKY29uc3QgaXNUZW1wbGF0ZVBhcnRBY3RpdmUgPSAocGFydCk9PnBhcnQuaW5kZXggIT09IC0xCjsKY29uc3QgY3JlYXRlTWFya2VyID0gKCk9PmRvY3VtZW50LmNyZWF0ZUNvbW1lbnQoIiIpCjsKY29uc3QgbGFzdEF0dHJpYnV0ZU5hbWVSZWdleCA9IC8oWyBceDA5XHgwYVx4MGNceDBkXSkoW15cMC1ceDFGXHg3Ri1ceDlGICInPj0vXSspKFsgXHgwOVx4MGFceDBjXHgwZF0qPVsgXHgwOVx4MGFceDBjXHgwZF0qKD86W14gXHgwOVx4MGFceDBjXHgwZCInYDw+PV0qfCJbXiJdKnwnW14nXSopKSQvOwpjbGFzcyBUZW1wbGF0ZUluc3RhbmNlIHsKICAgIGNvbnN0cnVjdG9yKHRlbXBsYXRlLCBwcm9jZXNzb3IsIG9wdGlvbnMpewogICAgICAgIHRoaXMuX19wYXJ0cyA9IFtdOwogICAgICAgIHRoaXMudGVtcGxhdGUgPSB0ZW1wbGF0ZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgICAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zOwogICAgfQogICAgdXBkYXRlKHZhbHVlcykgewogICAgICAgIGxldCBpID0gMDsKICAgICAgICBmb3IgKGNvbnN0IHBhcnQgb2YgdGhpcy5fX3BhcnRzKXsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydC5zZXRWYWx1ZSh2YWx1ZXNbaV0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGkrKzsKICAgICAgICB9CiAgICAgICAgZm9yIChjb25zdCBwYXJ0MSBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydDEgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgcGFydDEuY29tbWl0KCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBfY2xvbmUoKSB7CiAgICAgICAgY29uc3QgZnJhZ21lbnQgPSBpc0NFUG9seWZpbGwgPyB0aGlzLnRlbXBsYXRlLmVsZW1lbnQuY29udGVudC5jbG9uZU5vZGUodHJ1ZSkgOiBkb2N1bWVudC5pbXBvcnROb2RlKHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LCB0cnVlKTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMudGVtcGxhdGUucGFydHM7CiAgICAgICAgY29uc3Qgd2Fsa2VyID0gZG9jdW1lbnQuY3JlYXRlVHJlZVdhbGtlcihmcmFnbWVudCwgMTMzLCBudWxsLCBmYWxzZSk7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IG5vZGVJbmRleCA9IDA7CiAgICAgICAgbGV0IHBhcnQ7CiAgICAgICAgbGV0IG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBwYXJ0czIubGVuZ3RoKXsKICAgICAgICAgICAgcGFydCA9IHBhcnRzMltwYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoIWlzVGVtcGxhdGVQYXJ0QWN0aXZlKHBhcnQpKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaCh2b2lkIDApOwogICAgICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICB3aGlsZShub2RlSW5kZXggPCBwYXJ0LmluZGV4KXsKICAgICAgICAgICAgICAgIG5vZGVJbmRleCsrOwogICAgICAgICAgICAgICAgaWYgKG5vZGUubm9kZU5hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICgobm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpKSA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IHN0YWNrLnBvcCgpOwogICAgICAgICAgICAgICAgICAgIG5vZGUgPSB3YWxrZXIubmV4dE5vZGUoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAocGFydC50eXBlID09PSAibm9kZSIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHBhcnQyID0gdGhpcy5wcm9jZXNzb3IuaGFuZGxlVGV4dEV4cHJlc3Npb24odGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIHBhcnQyLmluc2VydEFmdGVyTm9kZShub2RlLnByZXZpb3VzU2libGluZyk7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaChwYXJ0Mik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9fcGFydHMucHVzaCguLi50aGlzLnByb2Nlc3Nvci5oYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhub2RlLCBwYXJ0Lm5hbWUsIHBhcnQuc3RyaW5ncywgdGhpcy5vcHRpb25zKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgfQogICAgICAgIGlmIChpc0NFUG9seWZpbGwpIHsKICAgICAgICAgICAgZG9jdW1lbnQuYWRvcHROb2RlKGZyYWdtZW50KTsKICAgICAgICAgICAgY3VzdG9tRWxlbWVudHMudXBncmFkZShmcmFnbWVudCk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBmcmFnbWVudDsKICAgIH0KfQpjb25zdCBwb2xpY3kgPSB3aW5kb3cudHJ1c3RlZFR5cGVzICYmIHRydXN0ZWRUeXBlcy5jcmVhdGVQb2xpY3koImxpdC1odG1sIiwgewogICAgY3JlYXRlSFRNTDogKHMpPT5zCn0pOwpjb25zdCBjb21tZW50TWFya2VyID0gYCAke21hcmtlcn0gYDsKY2xhc3MgVGVtcGxhdGVSZXN1bHQgewogICAgY29uc3RydWN0b3Ioc3RyaW5ncywgdmFsdWVzLCB0eXBlLCBwcm9jZXNzb3IpewogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3M7CiAgICAgICAgdGhpcy52YWx1ZXMgPSB2YWx1ZXM7CiAgICAgICAgdGhpcy50eXBlID0gdHlwZTsKICAgICAgICB0aGlzLnByb2Nlc3NvciA9IHByb2Nlc3NvcjsKICAgIH0KICAgIGdldEhUTUwoKSB7CiAgICAgICAgY29uc3QgbCA9IHRoaXMuc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGxldCBodG1sMiA9ICIiOwogICAgICAgIGxldCBpc0NvbW1lbnRCaW5kaW5nID0gZmFsc2U7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIGNvbnN0IHMgPSB0aGlzLnN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IGNvbW1lbnRPcGVuID0gcy5sYXN0SW5kZXhPZigiPCEtLSIpOwogICAgICAgICAgICBpc0NvbW1lbnRCaW5kaW5nID0gKGNvbW1lbnRPcGVuID4gLTEgfHwgaXNDb21tZW50QmluZGluZykgJiYgcy5pbmRleE9mKCItLT4iLCBjb21tZW50T3BlbiArIDEpID09PSAtMTsKICAgICAgICAgICAgY29uc3QgYXR0cmlidXRlTWF0Y2ggPSBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4LmV4ZWMocyk7CiAgICAgICAgICAgIGlmIChhdHRyaWJ1dGVNYXRjaCA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcyArIChpc0NvbW1lbnRCaW5kaW5nID8gY29tbWVudE1hcmtlciA6IG5vZGVNYXJrZXIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaHRtbDIgKz0gcy5zdWJzdHIoMCwgYXR0cmlidXRlTWF0Y2guaW5kZXgpICsgYXR0cmlidXRlTWF0Y2hbMV0gKyBhdHRyaWJ1dGVNYXRjaFsyXSArIGJvdW5kQXR0cmlidXRlU3VmZml4ICsgYXR0cmlidXRlTWF0Y2hbM10gKyBtYXJrZXI7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaHRtbDIgKz0gdGhpcy5zdHJpbmdzW2xdOwogICAgICAgIHJldHVybiBodG1sMjsKICAgIH0KICAgIGdldFRlbXBsYXRlRWxlbWVudCgpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoInRlbXBsYXRlIik7CiAgICAgICAgbGV0IHZhbHVlID0gdGhpcy5nZXRIVE1MKCk7CiAgICAgICAgaWYgKHBvbGljeSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHZhbHVlID0gcG9saWN5LmNyZWF0ZUhUTUwodmFsdWUpOwogICAgICAgIH0KICAgICAgICB0ZW1wbGF0ZS5pbm5lckhUTUwgPSB2YWx1ZTsKICAgICAgICByZXR1cm4gdGVtcGxhdGU7CiAgICB9Cn0KY29uc3QgaXNQcmltaXRpdmUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgfHwgISh0eXBlb2YgdmFsdWUgPT09ICJvYmplY3QiIHx8IHR5cGVvZiB2YWx1ZSA9PT0gImZ1bmN0aW9uIik7Cn07CmNvbnN0IGlzSXRlcmFibGUgPSAodmFsdWUpPT57CiAgICByZXR1cm4gQXJyYXkuaXNBcnJheSh2YWx1ZSkgfHwgISEodmFsdWUgJiYgdmFsdWVbU3ltYm9sLml0ZXJhdG9yXSk7Cn07CmNsYXNzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLmRpcnR5ID0gdHJ1ZTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnBhcnRzID0gW107CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHN0cmluZ3MubGVuZ3RoIC0gMTsgaSsrKXsKICAgICAgICAgICAgdGhpcy5wYXJ0c1tpXSA9IHRoaXMuX2NyZWF0ZVBhcnQoKTsKICAgICAgICB9CiAgICB9CiAgICBfY3JlYXRlUGFydCgpIHsKICAgICAgICByZXR1cm4gbmV3IEF0dHJpYnV0ZVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgY29uc3Qgc3RyaW5ncyA9IHRoaXMuc3RyaW5nczsKICAgICAgICBjb25zdCBsID0gc3RyaW5ncy5sZW5ndGggLSAxOwogICAgICAgIGNvbnN0IHBhcnRzMiA9IHRoaXMucGFydHM7CiAgICAgICAgaWYgKGwgPT09IDEgJiYgc3RyaW5nc1swXSA9PT0gIiIgJiYgc3RyaW5nc1sxXSA9PT0gIiIpIHsKICAgICAgICAgICAgY29uc3QgdiA9IHBhcnRzMlswXS52YWx1ZTsKICAgICAgICAgICAgaWYgKHR5cGVvZiB2ID09PSAic3ltYm9sIikgewogICAgICAgICAgICAgICAgcmV0dXJuIFN0cmluZyh2KTsKICAgICAgICAgICAgfQogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzdHJpbmciIHx8ICFpc0l0ZXJhYmxlKHYpKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBsZXQgdGV4dCA9ICIiOwogICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsOyBpKyspewogICAgICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbaV07CiAgICAgICAgICAgIGNvbnN0IHBhcnQgPSBwYXJ0czJbaV07CiAgICAgICAgICAgIGlmIChwYXJ0ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGNvbnN0IHYgPSBwYXJ0LnZhbHVlOwogICAgICAgICAgICAgICAgaWYgKGlzUHJpbWl0aXZlKHYpIHx8ICFpc0l0ZXJhYmxlKHYpKSB7CiAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdiA9PT0gInN0cmluZyIgPyB2IDogU3RyaW5nKHYpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IHQgb2Ygdil7CiAgICAgICAgICAgICAgICAgICAgICAgIHRleHQgKz0gdHlwZW9mIHQgPT09ICJzdHJpbmciID8gdCA6IFN0cmluZyh0KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdGV4dCArPSBzdHJpbmdzW2xdOwogICAgICAgIHJldHVybiB0ZXh0OwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsIHRoaXMuX2dldFZhbHVlKCkpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBBdHRyaWJ1dGVQYXJ0IHsKICAgIGNvbnN0cnVjdG9yKGNvbW1pdHRlcil7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmNvbW1pdHRlciA9IGNvbW1pdHRlcjsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgaWYgKHZhbHVlICE9PSBub0NoYW5nZSAmJiAoIWlzUHJpbWl0aXZlKHZhbHVlKSB8fCB2YWx1ZSAhPT0gdGhpcy52YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgICAgICBpZiAoIWlzRGlyZWN0aXZlKHZhbHVlKSkgewogICAgICAgICAgICAgICAgdGhpcy5jb21taXR0ZXIuZGlydHkgPSB0cnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMudmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMudmFsdWU7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMudmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgdGhpcy5jb21taXR0ZXIuY29tbWl0KCk7CiAgICB9Cn0KY2xhc3MgTm9kZVBhcnQgewogICAgY29uc3RydWN0b3Iob3B0aW9ucyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICBhcHBlbmRJbnRvKGNvbnRhaW5lcikgewogICAgICAgIHRoaXMuc3RhcnROb2RlID0gY29udGFpbmVyLmFwcGVuZENoaWxkKGNyZWF0ZU1hcmtlcigpKTsKICAgICAgICB0aGlzLmVuZE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgfQogICAgaW5zZXJ0QWZ0ZXJOb2RlKHJlZikgewogICAgICAgIHRoaXMuc3RhcnROb2RlID0gcmVmOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5uZXh0U2libGluZzsKICAgIH0KICAgIGFwcGVuZEludG9QYXJ0KHBhcnQpIHsKICAgICAgICBwYXJ0Ll9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5lbmROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgfQogICAgaW5zZXJ0QWZ0ZXJQYXJ0KHJlZikgewogICAgICAgIHJlZi5fX2luc2VydCh0aGlzLnN0YXJ0Tm9kZSA9IGNyZWF0ZU1hcmtlcigpKTsKICAgICAgICB0aGlzLmVuZE5vZGUgPSByZWYuZW5kTm9kZTsKICAgICAgICByZWYuZW5kTm9kZSA9IHRoaXMuc3RhcnROb2RlOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUgPT09IG51bGwpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBpZiAodmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKGlzUHJpbWl0aXZlKHZhbHVlKSkgewogICAgICAgICAgICBpZiAodmFsdWUgIT09IHRoaXMudmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19jb21taXRUZXh0KHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlc3VsdCkgewogICAgICAgICAgICB0aGlzLl9fY29tbWl0VGVtcGxhdGVSZXN1bHQodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAodmFsdWUgaW5zdGFuY2VvZiBOb2RlKSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXROb2RlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKGlzSXRlcmFibGUodmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRJdGVyYWJsZSh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSA9PT0gbm90aGluZykgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gbm90aGluZzsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZXh0KHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICBfX2luc2VydChub2RlKSB7CiAgICAgICAgdGhpcy5lbmROb2RlLnBhcmVudE5vZGUuaW5zZXJ0QmVmb3JlKG5vZGUsIHRoaXMuZW5kTm9kZSk7CiAgICB9CiAgICBfX2NvbW1pdE5vZGUodmFsdWUpIHsKICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gdmFsdWUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgdGhpcy5fX2luc2VydCh2YWx1ZSk7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgX19jb21taXRUZXh0KHZhbHVlKSB7CiAgICAgICAgY29uc3Qgbm9kZSA9IHRoaXMuc3RhcnROb2RlLm5leHRTaWJsaW5nOwogICAgICAgIHZhbHVlID0gdmFsdWUgPT0gbnVsbCA/ICIiIDogdmFsdWU7CiAgICAgICAgY29uc3QgdmFsdWVBc1N0cmluZyA9IHR5cGVvZiB2YWx1ZSA9PT0gInN0cmluZyIgPyB2YWx1ZSA6IFN0cmluZyh2YWx1ZSk7CiAgICAgICAgaWYgKG5vZGUgPT09IHRoaXMuZW5kTm9kZS5wcmV2aW91c1NpYmxpbmcgJiYgbm9kZS5ub2RlVHlwZSA9PT0gMykgewogICAgICAgICAgICBub2RlLmRhdGEgPSB2YWx1ZUFzU3RyaW5nOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXROb2RlKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHZhbHVlQXNTdHJpbmcpKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgfQogICAgX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gdGhpcy5vcHRpb25zLnRlbXBsYXRlRmFjdG9yeSh2YWx1ZSk7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgaW5zdGFuY2VvZiBUZW1wbGF0ZUluc3RhbmNlICYmIHRoaXMudmFsdWUudGVtcGxhdGUgPT09IHRlbXBsYXRlKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUudXBkYXRlKHZhbHVlLnZhbHVlcyk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgaW5zdGFuY2UgPSBuZXcgVGVtcGxhdGVJbnN0YW5jZSh0ZW1wbGF0ZSwgdmFsdWUucHJvY2Vzc29yLCB0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICBjb25zdCBmcmFnbWVudCA9IGluc3RhbmNlLl9jbG9uZSgpOwogICAgICAgICAgICBpbnN0YW5jZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICB0aGlzLnZhbHVlID0gaW5zdGFuY2U7CiAgICAgICAgfQogICAgfQogICAgX19jb21taXRJdGVyYWJsZSh2YWx1ZSkgewogICAgICAgIGlmICghQXJyYXkuaXNBcnJheSh0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gW107CiAgICAgICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgaXRlbVBhcnRzID0gdGhpcy52YWx1ZTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgaXRlbVBhcnQ7CiAgICAgICAgZm9yIChjb25zdCBpdGVtIG9mIHZhbHVlKXsKICAgICAgICAgICAgaXRlbVBhcnQgPSBpdGVtUGFydHNbcGFydEluZGV4XTsKICAgICAgICAgICAgaWYgKGl0ZW1QYXJ0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0ID0gbmV3IE5vZGVQYXJ0KHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgICAgICBpdGVtUGFydHMucHVzaChpdGVtUGFydCk7CiAgICAgICAgICAgICAgICBpZiAocGFydEluZGV4ID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuYXBwZW5kSW50b1BhcnQodGhpcyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGl0ZW1QYXJ0Lmluc2VydEFmdGVyUGFydChpdGVtUGFydHNbcGFydEluZGV4IC0gMV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGl0ZW1QYXJ0LnNldFZhbHVlKGl0ZW0pOwogICAgICAgICAgICBpdGVtUGFydC5jb21taXQoKTsKICAgICAgICAgICAgcGFydEluZGV4Kys7CiAgICAgICAgfQogICAgICAgIGlmIChwYXJ0SW5kZXggPCBpdGVtUGFydHMubGVuZ3RoKSB7CiAgICAgICAgICAgIGl0ZW1QYXJ0cy5sZW5ndGggPSBwYXJ0SW5kZXg7CiAgICAgICAgICAgIHRoaXMuY2xlYXIoaXRlbVBhcnQgJiYgaXRlbVBhcnQuZW5kTm9kZSk7CiAgICAgICAgfQogICAgfQogICAgY2xlYXIoc3RhcnROb2RlID0gdGhpcy5zdGFydE5vZGUpIHsKICAgICAgICByZW1vdmVOb2Rlcyh0aGlzLnN0YXJ0Tm9kZS5wYXJlbnROb2RlLCBzdGFydE5vZGUubmV4dFNpYmxpbmcsIHRoaXMuZW5kTm9kZSk7CiAgICB9Cn0KY2xhc3MgQm9vbGVhbkF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIGlmIChzdHJpbmdzLmxlbmd0aCAhPT0gMiB8fCBzdHJpbmdzWzBdICE9PSAiIiB8fCBzdHJpbmdzWzFdICE9PSAiIikgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkJvb2xlYW4gYXR0cmlidXRlcyBjYW4gb25seSBjb250YWluIGEgc2luZ2xlIGV4cHJlc3Npb24iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5lbGVtZW50ID0gZWxlbWVudDsKICAgICAgICB0aGlzLm5hbWUgPSBuYW1lOwogICAgICAgIHRoaXMuc3RyaW5ncyA9IHN0cmluZ3M7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHZhbHVlID0gISF0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh0aGlzLnZhbHVlICE9PSB2YWx1ZSkgewogICAgICAgICAgICBpZiAodmFsdWUpIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5zZXRBdHRyaWJ1dGUodGhpcy5uYW1lLCAiIik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlQXR0cmlidXRlKHRoaXMubmFtZSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy52YWx1ZSA9IHZhbHVlOwogICAgICAgIH0KICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICB9Cn0KY2xhc3MgUHJvcGVydHlDb21taXR0ZXIgZXh0ZW5kcyBBdHRyaWJ1dGVDb21taXR0ZXIgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyl7CiAgICAgICAgc3VwZXIoZWxlbWVudCwgbmFtZSwgc3RyaW5ncyk7CiAgICAgICAgdGhpcy5zaW5nbGUgPSBzdHJpbmdzLmxlbmd0aCA9PT0gMiAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIjsKICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgUHJvcGVydHlQYXJ0KHRoaXMpOwogICAgfQogICAgX2dldFZhbHVlKCkgewogICAgICAgIGlmICh0aGlzLnNpbmdsZSkgewogICAgICAgICAgICByZXR1cm4gdGhpcy5wYXJ0c1swXS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN1cGVyLl9nZXRWYWx1ZSgpOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIGlmICh0aGlzLmRpcnR5KSB7CiAgICAgICAgICAgIHRoaXMuZGlydHkgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5lbGVtZW50W3RoaXMubmFtZV0gPSB0aGlzLl9nZXRWYWx1ZSgpOwogICAgICAgIH0KICAgIH0KfQpjbGFzcyBQcm9wZXJ0eVBhcnQgZXh0ZW5kcyBBdHRyaWJ1dGVQYXJ0IHsKfQpsZXQgZXZlbnRPcHRpb25zU3VwcG9ydGVkID0gZmFsc2U7CigoKT0+ewogICAgdHJ5IHsKICAgICAgICBjb25zdCBvcHRpb25zID0gewogICAgICAgICAgICBnZXQgY2FwdHVyZSAoKSB7CiAgICAgICAgICAgICAgICBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigidGVzdCIsIG9wdGlvbnMsIG9wdGlvbnMpOwogICAgICAgIHdpbmRvdy5yZW1vdmVFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICB9IGNhdGNoIChfZSkgewogICAgfQp9KSgpOwpjbGFzcyBFdmVudFBhcnQgewogICAgY29uc3RydWN0b3IoZWxlbWVudCwgZXZlbnROYW1lLCBldmVudENvbnRleHQpewogICAgICAgIHRoaXMudmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMuZXZlbnROYW1lID0gZXZlbnROYW1lOwogICAgICAgIHRoaXMuZXZlbnRDb250ZXh0ID0gZXZlbnRDb250ZXh0OwogICAgICAgIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50ID0gKGUpPT50aGlzLmhhbmRsZUV2ZW50KGUpCiAgICAgICAgOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy5fX3BlbmRpbmdWYWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fX3BlbmRpbmdWYWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBuZXdMaXN0ZW5lciA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgY29uc3Qgb2xkTGlzdGVuZXIgPSB0aGlzLnZhbHVlOwogICAgICAgIGNvbnN0IHNob3VsZFJlbW92ZUxpc3RlbmVyID0gbmV3TGlzdGVuZXIgPT0gbnVsbCB8fCBvbGRMaXN0ZW5lciAhPSBudWxsICYmIChuZXdMaXN0ZW5lci5jYXB0dXJlICE9PSBvbGRMaXN0ZW5lci5jYXB0dXJlIHx8IG5ld0xpc3RlbmVyLm9uY2UgIT09IG9sZExpc3RlbmVyLm9uY2UgfHwgbmV3TGlzdGVuZXIucGFzc2l2ZSAhPT0gb2xkTGlzdGVuZXIucGFzc2l2ZSk7CiAgICAgICAgY29uc3Qgc2hvdWxkQWRkTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciAhPSBudWxsICYmIChvbGRMaXN0ZW5lciA9PSBudWxsIHx8IHNob3VsZFJlbW92ZUxpc3RlbmVyKTsKICAgICAgICBpZiAoc2hvdWxkUmVtb3ZlTGlzdGVuZXIpIHsKICAgICAgICAgICAgdGhpcy5lbGVtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIodGhpcy5ldmVudE5hbWUsIHRoaXMuX19ib3VuZEhhbmRsZUV2ZW50LCB0aGlzLl9fb3B0aW9ucyk7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRBZGRMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLl9fb3B0aW9ucyA9IGdldE9wdGlvbnMobmV3TGlzdGVuZXIpOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuYWRkRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgdGhpcy52YWx1ZSA9IG5ld0xpc3RlbmVyOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KICAgIGhhbmRsZUV2ZW50KGV2ZW50KSB7CiAgICAgICAgaWYgKHR5cGVvZiB0aGlzLnZhbHVlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuY2FsbCh0aGlzLmV2ZW50Q29udGV4dCB8fCB0aGlzLmVsZW1lbnQsIGV2ZW50KTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aGlzLnZhbHVlLmhhbmRsZUV2ZW50KGV2ZW50KTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZ2V0T3B0aW9ucyA9IChvKT0+byAmJiAoZXZlbnRPcHRpb25zU3VwcG9ydGVkID8gewogICAgICAgIGNhcHR1cmU6IG8uY2FwdHVyZSwKICAgICAgICBwYXNzaXZlOiBvLnBhc3NpdmUsCiAgICAgICAgb25jZTogby5vbmNlCiAgICB9IDogby5jYXB0dXJlKQo7CmNsYXNzIERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvciB7CiAgICBoYW5kbGVBdHRyaWJ1dGVFeHByZXNzaW9ucyhlbGVtZW50LCBuYW1lLCBzdHJpbmdzLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgcHJlZml4ID0gbmFtZVswXTsKICAgICAgICBpZiAocHJlZml4ID09PSAiLiIpIHsKICAgICAgICAgICAgY29uc3QgY29tbWl0dGVyMiA9IG5ldyBQcm9wZXJ0eUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKTsKICAgICAgICAgICAgcmV0dXJuIGNvbW1pdHRlcjIucGFydHM7CiAgICAgICAgfQogICAgICAgIGlmIChwcmVmaXggPT09ICJAIikgewogICAgICAgICAgICByZXR1cm4gWwogICAgICAgICAgICAgICAgbmV3IEV2ZW50UGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBvcHRpb25zLmV2ZW50Q29udGV4dCkKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIj8iKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgQm9vbGVhbkF0dHJpYnV0ZVBhcnQoZWxlbWVudCwgbmFtZS5zbGljZSgxKSwgc3RyaW5ncykKICAgICAgICAgICAgXTsKICAgICAgICB9CiAgICAgICAgY29uc3QgY29tbWl0dGVyID0gbmV3IEF0dHJpYnV0ZUNvbW1pdHRlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICByZXR1cm4gY29tbWl0dGVyLnBhcnRzOwogICAgfQogICAgaGFuZGxlVGV4dEV4cHJlc3Npb24ob3B0aW9ucykgewogICAgICAgIHJldHVybiBuZXcgTm9kZVBhcnQob3B0aW9ucyk7CiAgICB9Cn0KY29uc3QgZGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yID0gbmV3IERlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcigpOwpmdW5jdGlvbiB0ZW1wbGF0ZUZhY3RvcnkocmVzdWx0KSB7CiAgICBsZXQgdGVtcGxhdGVDYWNoZSA9IHRlbXBsYXRlQ2FjaGVzLmdldChyZXN1bHQudHlwZSk7CiAgICBpZiAodGVtcGxhdGVDYWNoZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGVDYWNoZSA9IHsKICAgICAgICAgICAgc3RyaW5nc0FycmF5OiBuZXcgV2Vha01hcCgpLAogICAgICAgICAgICBrZXlTdHJpbmc6IG5ldyBNYXAoKQogICAgICAgIH07CiAgICAgICAgdGVtcGxhdGVDYWNoZXMuc2V0KHJlc3VsdC50eXBlLCB0ZW1wbGF0ZUNhY2hlKTsKICAgIH0KICAgIGxldCB0ZW1wbGF0ZSA9IHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LmdldChyZXN1bHQuc3RyaW5ncyk7CiAgICBpZiAodGVtcGxhdGUgIT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KICAgIGNvbnN0IGtleSA9IHJlc3VsdC5zdHJpbmdzLmpvaW4obWFya2VyKTsKICAgIHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5rZXlTdHJpbmcuZ2V0KGtleSk7CiAgICBpZiAodGVtcGxhdGUgPT09IHZvaWQgMCkgewogICAgICAgIHRlbXBsYXRlID0gbmV3IFRlbXBsYXRlKHJlc3VsdCwgcmVzdWx0LmdldFRlbXBsYXRlRWxlbWVudCgpKTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5zZXQoa2V5LCB0ZW1wbGF0ZSk7CiAgICB9CiAgICB0ZW1wbGF0ZUNhY2hlLnN0cmluZ3NBcnJheS5zZXQocmVzdWx0LnN0cmluZ3MsIHRlbXBsYXRlKTsKICAgIHJldHVybiB0ZW1wbGF0ZTsKfQpjb25zdCB0ZW1wbGF0ZUNhY2hlcyA9IG5ldyBNYXAoKTsKY29uc3QgcGFydHMgPSBuZXcgV2Vha01hcCgpOwpjb25zdCByZW5kZXIgPSAocmVzdWx0LCBjb250YWluZXIsIG9wdGlvbnMpPT57CiAgICBsZXQgcGFydCA9IHBhcnRzLmdldChjb250YWluZXIpOwogICAgaWYgKHBhcnQgPT09IHZvaWQgMCkgewogICAgICAgIHJlbW92ZU5vZGVzKGNvbnRhaW5lciwgY29udGFpbmVyLmZpcnN0Q2hpbGQpOwogICAgICAgIHBhcnRzLnNldChjb250YWluZXIsIHBhcnQgPSBuZXcgTm9kZVBhcnQoT2JqZWN0LmFzc2lnbih7CiAgICAgICAgICAgIHRlbXBsYXRlRmFjdG9yeQogICAgICAgIH0sIG9wdGlvbnMpKSk7CiAgICAgICAgcGFydC5hcHBlbmRJbnRvKGNvbnRhaW5lcik7CiAgICB9CiAgICBwYXJ0LnNldFZhbHVlKHJlc3VsdCk7CiAgICBwYXJ0LmNvbW1pdCgpOwp9OwppZiAodHlwZW9mIHdpbmRvdyAhPT0gInVuZGVmaW5lZCIpIHsKICAgICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEh0bWxWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIxLjQuMSIpOwp9CmNvbnN0IGh0bWwgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFRlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgImh0bWwiLCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IpCjsKdmFyIF9hOwp3aW5kb3cuSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSA9IChwcm9wLCBfb2JqKT0+cHJvcAo7CmNvbnN0IGRlZmF1bHRDb252ZXJ0ZXIgPSB7CiAgICB0b0F0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA/ICIiIDogbnVsbDsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT0gbnVsbCA/IHZhbHVlIDogSlNPTi5zdHJpbmdpZnkodmFsdWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9LAogICAgZnJvbUF0dHJpYnV0ZSAodmFsdWUsIHR5cGUpIHsKICAgICAgICBzd2l0Y2godHlwZSl7CiAgICAgICAgICAgIGNhc2UgQm9vbGVhbjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSAhPT0gbnVsbDsKICAgICAgICAgICAgY2FzZSBOdW1iZXI6CiAgICAgICAgICAgICAgICByZXR1cm4gdmFsdWUgPT09IG51bGwgPyBudWxsIDogTnVtYmVyKHZhbHVlKTsKICAgICAgICAgICAgY2FzZSBPYmplY3Q6CiAgICAgICAgICAgIGNhc2UgQXJyYXk6CiAgICAgICAgICAgICAgICByZXR1cm4gSlNPTi5wYXJzZSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0KfTsKY29uc3Qgbm90RXF1YWwgPSAodmFsdWUsIG9sZCk9PnsKICAgIHJldHVybiBvbGQgIT09IHZhbHVlICYmIChvbGQgPT09IG9sZCB8fCB2YWx1ZSA9PT0gdmFsdWUpOwp9Owpjb25zdCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbiA9IHsKICAgIGF0dHJpYnV0ZTogdHJ1ZSwKICAgIHR5cGU6IFN0cmluZywKICAgIGNvbnZlcnRlcjogZGVmYXVsdENvbnZlcnRlciwKICAgIHJlZmxlY3Q6IGZhbHNlLAogICAgaGFzQ2hhbmdlZDogbm90RXF1YWwKfTsKY29uc3QgU1RBVEVfSEFTX1VQREFURUQgPSAxOwpjb25zdCBTVEFURV9VUERBVEVfUkVRVUVTVEVEID0gMSA8PCAyOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSA9IDEgPDwgMzsKY29uc3QgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSA9IDEgPDwgNDsKY29uc3QgZmluYWxpemVkID0gImZpbmFsaXplZCI7CmNsYXNzIFVwZGF0aW5nRWxlbWVudCBleHRlbmRzIEhUTUxFbGVtZW50IHsKICAgIGNvbnN0cnVjdG9yKCl7CiAgICAgICAgc3VwZXIoKTsKICAgICAgICB0aGlzLmluaXRpYWxpemUoKTsKICAgIH0KICAgIHN0YXRpYyBnZXQgb2JzZXJ2ZWRBdHRyaWJ1dGVzKCkgewogICAgICAgIHRoaXMuZmluYWxpemUoKTsKICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gW107CiAgICAgICAgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT57CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkocCwgdik7CiAgICAgICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuc2V0KGF0dHIsIHApOwogICAgICAgICAgICAgICAgYXR0cmlidXRlcy5wdXNoKGF0dHIpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICAgICAgcmV0dXJuIGF0dHJpYnV0ZXM7CiAgICB9CiAgICBzdGF0aWMgX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpIHsKICAgICAgICBpZiAoIXRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgiX2NsYXNzUHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgICAgIGNvbnN0IHN1cGVyUHJvcGVydGllcyA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKS5fY2xhc3NQcm9wZXJ0aWVzOwogICAgICAgICAgICBpZiAoc3VwZXJQcm9wZXJ0aWVzICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHN1cGVyUHJvcGVydGllcy5mb3JFYWNoKCh2LCBrKT0+dGhpcy5fY2xhc3NQcm9wZXJ0aWVzLnNldChrLCB2KQogICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBjcmVhdGVQcm9wZXJ0eShuYW1lLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChvcHRpb25zLm5vQWNjZXNzb3IgfHwgdGhpcy5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkobmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBrZXkgPSB0eXBlb2YgbmFtZSA9PT0gInN5bWJvbCIgPyBTeW1ib2woKSA6IGBfXyR7bmFtZX1gOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSB0aGlzLmdldFByb3BlcnR5RGVzY3JpcHRvcihuYW1lLCBrZXksIG9wdGlvbnMpOwogICAgICAgIGlmIChkZXNjcmlwdG9yICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRoaXMucHJvdG90eXBlLCBuYW1lLCBkZXNjcmlwdG9yKTsKICAgICAgICB9CiAgICB9CiAgICBzdGF0aWMgZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIGdldCAoKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gdGhpc1trZXldOwogICAgICAgICAgICB9LAogICAgICAgICAgICBzZXQgKHZhbHVlKSB7CiAgICAgICAgICAgICAgICBjb25zdCBvbGRWYWx1ZSA9IHRoaXNbbmFtZV07CiAgICAgICAgICAgICAgICB0aGlzW2tleV0gPSB2YWx1ZTsKICAgICAgICAgICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgfSwKICAgICAgICAgICAgY29uZmlndXJhYmxlOiB0cnVlLAogICAgICAgICAgICBlbnVtZXJhYmxlOiB0cnVlCiAgICAgICAgfTsKICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eU9wdGlvbnMobmFtZSkgewogICAgICAgIHJldHVybiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMgJiYgdGhpcy5fY2xhc3NQcm9wZXJ0aWVzLmdldChuYW1lKSB8fCBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbjsKICAgIH0KICAgIHN0YXRpYyBmaW5hbGl6ZSgpIHsKICAgICAgICBjb25zdCBzdXBlckN0b3IgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2YodGhpcyk7CiAgICAgICAgaWYgKCFzdXBlckN0b3IuaGFzT3duUHJvcGVydHkoZmluYWxpemVkKSkgewogICAgICAgICAgICBzdXBlckN0b3IuZmluYWxpemUoKTsKICAgICAgICB9CiAgICAgICAgdGhpc1tmaW5hbGl6ZWRdID0gdHJ1ZTsKICAgICAgICB0aGlzLl9lbnN1cmVDbGFzc1Byb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLl9hdHRyaWJ1dGVUb1Byb3BlcnR5TWFwID0gbmV3IE1hcCgpOwogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoInByb3BlcnRpZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgY29uc3QgcHJvcHMgPSB0aGlzLnByb3BlcnRpZXM7CiAgICAgICAgICAgIGNvbnN0IHByb3BLZXlzID0gWwogICAgICAgICAgICAgICAgLi4uT2JqZWN0LmdldE93blByb3BlcnR5TmFtZXMocHJvcHMpLAogICAgICAgICAgICAgICAgLi4udHlwZW9mIE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMgPT09ICJmdW5jdGlvbiIgPyBPYmplY3QuZ2V0T3duUHJvcGVydHlTeW1ib2xzKHByb3BzKSA6IFtdCiAgICAgICAgICAgIF07CiAgICAgICAgICAgIGZvciAoY29uc3QgcCBvZiBwcm9wS2V5cyl7CiAgICAgICAgICAgICAgICB0aGlzLmNyZWF0ZVByb3BlcnR5KHAsIHByb3BzW3BdKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBfYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBhdHRyaWJ1dGUgPSBvcHRpb25zLmF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlID09PSBmYWxzZSA/IHZvaWQgMCA6IHR5cGVvZiBhdHRyaWJ1dGUgPT09ICJzdHJpbmciID8gYXR0cmlidXRlIDogdHlwZW9mIG5hbWUgPT09ICJzdHJpbmciID8gbmFtZS50b0xvd2VyQ2FzZSgpIDogdm9pZCAwOwogICAgfQogICAgc3RhdGljIF92YWx1ZUhhc0NoYW5nZWQodmFsdWUsIG9sZCwgaGFzQ2hhbmdlZCA9IG5vdEVxdWFsKSB7CiAgICAgICAgcmV0dXJuIGhhc0NoYW5nZWQodmFsdWUsIG9sZCk7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgY29uc3QgdHlwZSA9IG9wdGlvbnMudHlwZTsKICAgICAgICBjb25zdCBjb252ZXJ0ZXIgPSBvcHRpb25zLmNvbnZlcnRlciB8fCBkZWZhdWx0Q29udmVydGVyOwogICAgICAgIGNvbnN0IGZyb21BdHRyaWJ1dGUgPSB0eXBlb2YgY29udmVydGVyID09PSAiZnVuY3Rpb24iID8gY29udmVydGVyIDogY29udmVydGVyLmZyb21BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIGZyb21BdHRyaWJ1dGUgPyBmcm9tQXR0cmlidXRlKHZhbHVlLCB0eXBlKSA6IHZhbHVlOwogICAgfQogICAgc3RhdGljIF9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyOwogICAgICAgIGNvbnN0IHRvQXR0cmlidXRlID0gY29udmVydGVyICYmIGNvbnZlcnRlci50b0F0dHJpYnV0ZSB8fCBkZWZhdWx0Q29udmVydGVyLnRvQXR0cmlidXRlOwogICAgICAgIHJldHVybiB0b0F0dHJpYnV0ZSh2YWx1ZSwgdHlwZSk7CiAgICB9CiAgICBpbml0aWFsaXplKCkgewogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gMDsKICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gbmV3IFByb21pc2UoKHJlcyk9PnRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSByZXMKICAgICAgICApOwogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKTsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbCgpOwogICAgfQogICAgX3NhdmVJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fY2xhc3NQcm9wZXJ0aWVzLmZvckVhY2goKF92LCBwKT0+ewogICAgICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShwKSkgewogICAgICAgICAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzW3BdOwogICAgICAgICAgICAgICAgZGVsZXRlIHRoaXNbcF07CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRoaXMuX2luc3RhbmNlUHJvcGVydGllcy5zZXQocCwgdmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSk7CiAgICB9CiAgICBfYXBwbHlJbnN0YW5jZVByb3BlcnRpZXMoKSB7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLmZvckVhY2goKHYsIHApPT50aGlzW3BdID0gdgogICAgICAgICk7CiAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgdGhpcy5lbmFibGVVcGRhdGluZygpOwogICAgfQogICAgZW5hYmxlVXBkYXRpbmcoKSB7CiAgICAgICAgaWYgKHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgIT09IHZvaWQgMCkgewogICAgICAgICAgICB0aGlzLl9lbmFibGVVcGRhdGluZ1Jlc29sdmVyKCk7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIgPSB2b2lkIDA7CiAgICAgICAgfQogICAgfQogICAgZGlzY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICB9CiAgICBhdHRyaWJ1dGVDaGFuZ2VkQ2FsbGJhY2sobmFtZSwgb2xkLCB2YWx1ZSkgewogICAgICAgIGlmIChvbGQgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9wcm9wZXJ0eVRvQXR0cmlidXRlKG5hbWUsIHZhbHVlLCBvcHRpb25zID0gZGVmYXVsdFByb3BlcnR5RGVjbGFyYXRpb24pIHsKICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBhdHRyID0gY3Rvci5fYXR0cmlidXRlTmFtZUZvclByb3BlcnR5KG5hbWUsIG9wdGlvbnMpOwogICAgICAgIGlmIChhdHRyICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgYXR0clZhbHVlID0gY3Rvci5fcHJvcGVydHlWYWx1ZVRvQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgaWYgKGF0dHJWYWx1ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICByZXR1cm47CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09IG51bGwpIHsKICAgICAgICAgICAgICAgIHRoaXMucmVtb3ZlQXR0cmlidXRlKGF0dHIpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5zZXRBdHRyaWJ1dGUoYXR0ciwgYXR0clZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFOwogICAgICAgIH0KICAgIH0KICAgIF9hdHRyaWJ1dGVUb1Byb3BlcnR5KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgaWYgKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCBjdG9yID0gdGhpcy5jb25zdHJ1Y3RvcjsKICAgICAgICBjb25zdCBwcm9wTmFtZSA9IGN0b3IuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAuZ2V0KG5hbWUpOwogICAgICAgIGlmIChwcm9wTmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IG9wdGlvbnMgPSBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhwcm9wTmFtZSk7CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgICAgICB0aGlzW3Byb3BOYW1lXSA9IGN0b3IuX3Byb3BlcnR5VmFsdWVGcm9tQXR0cmlidXRlKHZhbHVlLCBvcHRpb25zKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSAmIH5TVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSwgb3B0aW9ucykgewogICAgICAgIGxldCBzaG91bGRSZXF1ZXN0VXBkYXRlID0gdHJ1ZTsKICAgICAgICBpZiAobmFtZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgICAgICBvcHRpb25zID0gb3B0aW9ucyB8fCBjdG9yLmdldFByb3BlcnR5T3B0aW9ucyhuYW1lKTsKICAgICAgICAgICAgaWYgKGN0b3IuX3ZhbHVlSGFzQ2hhbmdlZCh0aGlzW25hbWVdLCBvbGRWYWx1ZSwgb3B0aW9ucy5oYXNDaGFuZ2VkKSkgewogICAgICAgICAgICAgICAgaWYgKCF0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5oYXMobmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcy5zZXQobmFtZSwgb2xkVmFsdWUpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMucmVmbGVjdCA9PT0gdHJ1ZSAmJiAhKHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfSVNfUkVGTEVDVElOR19UT19QUk9QRVJUWSkpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2V0KG5hbWUsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc2hvdWxkUmVxdWVzdFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlICYmIHNob3VsZFJlcXVlc3RVcGRhdGUpIHsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlUHJvbWlzZSA9IHRoaXMuX2VucXVldWVVcGRhdGUoKTsKICAgICAgICB9CiAgICB9CiAgICByZXF1ZXN0VXBkYXRlKG5hbWUsIG9sZFZhbHVlKSB7CiAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUpOwogICAgICAgIHJldHVybiB0aGlzLnVwZGF0ZUNvbXBsZXRlOwogICAgfQogICAgYXN5bmMgX2VucXVldWVVcGRhdGUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICAgICAgdHJ5IHsKICAgICAgICAgICAgYXdhaXQgdGhpcy5fdXBkYXRlUHJvbWlzZTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgfQogICAgICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMucGVyZm9ybVVwZGF0ZSgpOwogICAgICAgIGlmIChyZXN1bHQgIT0gbnVsbCkgewogICAgICAgICAgICBhd2FpdCByZXN1bHQ7CiAgICAgICAgfQogICAgICAgIHJldHVybiAhdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlOwogICAgfQogICAgZ2V0IF9oYXNSZXF1ZXN0ZWRVcGRhdGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCBoYXNVcGRhdGVkKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVTdGF0ZSAmIDE7CiAgICB9CiAgICBwZXJmb3JtVXBkYXRlKCkgewogICAgICAgIGlmICghdGhpcy5faGFzUmVxdWVzdGVkVXBkYXRlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX2luc3RhbmNlUHJvcGVydGllcykgewogICAgICAgICAgICB0aGlzLl9hcHBseUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIH0KICAgICAgICBsZXQgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgY29uc3QgY2hhbmdlZFByb3BlcnRpZXMgPSB0aGlzLl9jaGFuZ2VkUHJvcGVydGllczsKICAgICAgICB0cnkgewogICAgICAgICAgICBzaG91bGRVcGRhdGUgPSB0aGlzLnNob3VsZFVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgICAgICAgICB0aHJvdyBlOwogICAgICAgIH0KICAgICAgICBpZiAoc2hvdWxkVXBkYXRlKSB7CiAgICAgICAgICAgIGlmICghKHRoaXMuX3VwZGF0ZVN0YXRlICYgMSkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgfCBTVEFURV9IQVNfVVBEQVRFRDsKICAgICAgICAgICAgICAgIHRoaXMuZmlyc3RVcGRhdGVkKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgIH0KICAgIH0KICAgIF9tYXJrVXBkYXRlZCgpIHsKICAgICAgICB0aGlzLl9jaGFuZ2VkUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX1VQREFURV9SRVFVRVNURUQ7CiAgICB9CiAgICBnZXQgdXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2dldFVwZGF0ZUNvbXBsZXRlKCk7CiAgICB9CiAgICBfZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIGdldFVwZGF0ZUNvbXBsZXRlKCkgewogICAgICAgIHJldHVybiB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgfQogICAgc2hvdWxkVXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQogICAgdXBkYXRlKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyAhPT0gdm9pZCAwICYmIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLnNpemUgPiAwKSB7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9wcm9wZXJ0eVRvQXR0cmlidXRlKGssIHRoaXNba10sIHYpCiAgICAgICAgICAgICk7CiAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gdm9pZCAwOwogICAgICAgIH0KICAgICAgICB0aGlzLl9tYXJrVXBkYXRlZCgpOwogICAgfQogICAgdXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgIH0KICAgIGZpcnN0VXBkYXRlZChfY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgIH0KfQpfYSA9IGZpbmFsaXplZDsKVXBkYXRpbmdFbGVtZW50W19hXSA9IHRydWU7CmNvbnN0IEVsZW1lbnRQcm90byA9IEVsZW1lbnQucHJvdG90eXBlOwpFbGVtZW50UHJvdG8ubXNNYXRjaGVzU2VsZWN0b3IgfHwgRWxlbWVudFByb3RvLndlYmtpdE1hdGNoZXNTZWxlY3RvcjsKY29uc3Qgc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzID0gd2luZG93LlNoYWRvd1Jvb3QgJiYgKHdpbmRvdy5TaGFkeUNTUyA9PT0gdm9pZCAwIHx8IHdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpICYmICJhZG9wdGVkU3R5bGVTaGVldHMiIGluIERvY3VtZW50LnByb3RvdHlwZSAmJiAicmVwbGFjZSIgaW4gQ1NTU3R5bGVTaGVldC5wcm90b3R5cGU7CmNvbnN0IGNvbnN0cnVjdGlvblRva2VuID0gU3ltYm9sKCk7CmNsYXNzIENTU1Jlc3VsdCB7CiAgICBjb25zdHJ1Y3Rvcihjc3NUZXh0LCBzYWZlVG9rZW4pewogICAgICAgIGlmIChzYWZlVG9rZW4gIT09IGNvbnN0cnVjdGlvblRva2VuKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQ1NTUmVzdWx0IGlzIG5vdCBjb25zdHJ1Y3RhYmxlLiBVc2UgYHVuc2FmZUNTU2Agb3IgYGNzc2AgaW5zdGVhZC4iKTsKICAgICAgICB9CiAgICAgICAgdGhpcy5jc3NUZXh0ID0gY3NzVGV4dDsKICAgIH0KICAgIGdldCBzdHlsZVNoZWV0KCkgewogICAgICAgIGlmICh0aGlzLl9zdHlsZVNoZWV0ID09PSB2b2lkIDApIHsKICAgICAgICAgICAgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgdGhpcy5fc3R5bGVTaGVldCA9IG5ldyBDU1NTdHlsZVNoZWV0KCk7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0LnJlcGxhY2VTeW5jKHRoaXMuY3NzVGV4dCk7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpcy5fc3R5bGVTaGVldDsKICAgIH0KICAgIHRvU3RyaW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLmNzc1RleHQ7CiAgICB9Cn0KY29uc3QgdW5zYWZlQ1NTID0gKHZhbHVlKT0+ewogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoU3RyaW5nKHZhbHVlKSwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owpjb25zdCB0ZXh0RnJvbUNTU1Jlc3VsdCA9ICh2YWx1ZSk9PnsKICAgIGlmICh2YWx1ZSBpbnN0YW5jZW9mIENTU1Jlc3VsdCkgewogICAgICAgIHJldHVybiB2YWx1ZS5jc3NUZXh0OwogICAgfSBlbHNlIGlmICh0eXBlb2YgdmFsdWUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfSBlbHNlIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFZhbHVlIHBhc3NlZCB0byAnY3NzJyBmdW5jdGlvbiBtdXN0IGJlIGEgJ2NzcycgZnVuY3Rpb24gcmVzdWx0OiAke3ZhbHVlfS4gVXNlICd1bnNhZmVDU1MnIHRvIHBhc3Mgbm9uLWxpdGVyYWwgdmFsdWVzLCBidXQKICAgICAgICAgICAgdGFrZSBjYXJlIHRvIGVuc3VyZSBwYWdlIHNlY3VyaXR5LmApOwogICAgfQp9Owpjb25zdCBjc3MgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+ewogICAgY29uc3QgY3NzVGV4dCA9IHZhbHVlcy5yZWR1Y2UoKGFjYywgdiwgaWR4KT0+YWNjICsgdGV4dEZyb21DU1NSZXN1bHQodikgKyBzdHJpbmdzW2lkeCArIDFdCiAgICAsIHN0cmluZ3NbMF0pOwogICAgcmV0dXJuIG5ldyBDU1NSZXN1bHQoY3NzVGV4dCwgY29uc3RydWN0aW9uVG9rZW4pOwp9Owood2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSB8fCAod2luZG93WyJsaXRFbGVtZW50VmVyc2lvbnMiXSA9IFtdKSkucHVzaCgiMi41LjEiKTsKY29uc3QgcmVuZGVyTm90SW1wbGVtZW50ZWQgPSB7Cn07CmNsYXNzIExpdEVsZW1lbnQgZXh0ZW5kcyBVcGRhdGluZ0VsZW1lbnQgewogICAgc3RhdGljIGdldFN0eWxlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5zdHlsZXM7CiAgICB9CiAgICBzdGF0aWMgX2dldFVuaXF1ZVN0eWxlcygpIHsKICAgICAgICBpZiAodGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfc3R5bGVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdXNlclN0eWxlcyA9IHRoaXMuZ2V0U3R5bGVzKCk7CiAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkodXNlclN0eWxlcykpIHsKICAgICAgICAgICAgY29uc3QgYWRkU3R5bGVzID0gKHN0eWxlczIsIHNldDIpPT5zdHlsZXMyLnJlZHVjZVJpZ2h0KChzZXQzLCBzKT0+QXJyYXkuaXNBcnJheShzKSA/IGFkZFN0eWxlcyhzLCBzZXQzKSA6IChzZXQzLmFkZChzKSwgc2V0MykKICAgICAgICAgICAgICAgICwgc2V0MikKICAgICAgICAgICAgOwogICAgICAgICAgICBjb25zdCBzZXQgPSBhZGRTdHlsZXModXNlclN0eWxlcywgbmV3IFNldCgpKTsKICAgICAgICAgICAgY29uc3Qgc3R5bGVzID0gW107CiAgICAgICAgICAgIHNldC5mb3JFYWNoKCh2KT0+c3R5bGVzLnVuc2hpZnQodikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gc3R5bGVzOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX3N0eWxlcyA9IHVzZXJTdHlsZXMgPT09IHZvaWQgMCA/IFtdIDogWwogICAgICAgICAgICAgICAgdXNlclN0eWxlcwogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICB0aGlzLl9zdHlsZXMgPSB0aGlzLl9zdHlsZXMubWFwKChzKT0+ewogICAgICAgICAgICBpZiAocyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgJiYgIXN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICAgICAgY29uc3QgY3NzVGV4dCA9IEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKHMuY3NzUnVsZXMpLnJlZHVjZSgoY3NzMiwgcnVsZSk9PmNzczIgKyBydWxlLmNzc1RleHQKICAgICAgICAgICAgICAgICwgIiIpOwogICAgICAgICAgICAgICAgcmV0dXJuIHVuc2FmZUNTUyhjc3NUZXh0KTsKICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gczsKICAgICAgICB9KTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgc3VwZXIuaW5pdGlhbGl6ZSgpOwogICAgICAgIHRoaXMuY29uc3RydWN0b3IuX2dldFVuaXF1ZVN0eWxlcygpOwogICAgICAgIHRoaXMucmVuZGVyUm9vdCA9IHRoaXMuY3JlYXRlUmVuZGVyUm9vdCgpOwogICAgICAgIGlmICh3aW5kb3cuU2hhZG93Um9vdCAmJiB0aGlzLnJlbmRlclJvb3QgaW5zdGFuY2VvZiB3aW5kb3cuU2hhZG93Um9vdCkgewogICAgICAgICAgICB0aGlzLmFkb3B0U3R5bGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY3JlYXRlUmVuZGVyUm9vdCgpIHsKICAgICAgICByZXR1cm4gdGhpcy5hdHRhY2hTaGFkb3codGhpcy5jb25zdHJ1Y3Rvci5zaGFkb3dSb290T3B0aW9ucyk7CiAgICB9CiAgICBhZG9wdFN0eWxlcygpIHsKICAgICAgICBjb25zdCBzdHlsZXMgPSB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXM7CiAgICAgICAgaWYgKHN0eWxlcy5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAod2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDAgJiYgIXdpbmRvdy5TaGFkeUNTUy5uYXRpdmVTaGFkb3cpIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLlNjb3BpbmdTaGltLnByZXBhcmVBZG9wdGVkQ3NzVGV4dChzdHlsZXMubWFwKChzKT0+cy5jc3NUZXh0CiAgICAgICAgICAgICksIHRoaXMubG9jYWxOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHN1cHBvcnRzQWRvcHRpbmdTdHlsZVNoZWV0cykgewogICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYWRvcHRlZFN0eWxlU2hlZXRzID0gc3R5bGVzLm1hcCgocyk9PnMgaW5zdGFuY2VvZiBDU1NTdHlsZVNoZWV0ID8gcyA6IHMuc3R5bGVTaGVldAogICAgICAgICAgICApOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IHRydWU7CiAgICAgICAgfQogICAgfQogICAgY29ubmVjdGVkQ2FsbGJhY2soKSB7CiAgICAgICAgc3VwZXIuY29ubmVjdGVkQ2FsbGJhY2soKTsKICAgICAgICBpZiAodGhpcy5oYXNVcGRhdGVkICYmIHdpbmRvdy5TaGFkeUNTUyAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHdpbmRvdy5TaGFkeUNTUy5zdHlsZUVsZW1lbnQodGhpcyk7CiAgICAgICAgfQogICAgfQogICAgdXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGVSZXN1bHQgPSB0aGlzLnJlbmRlcigpOwogICAgICAgIHN1cGVyLnVwZGF0ZShjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgaWYgKHRlbXBsYXRlUmVzdWx0ICE9PSByZW5kZXJOb3RJbXBsZW1lbnRlZCkgewogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLnJlbmRlcih0ZW1wbGF0ZVJlc3VsdCwgdGhpcy5yZW5kZXJSb290LCB7CiAgICAgICAgICAgICAgICBzY29wZU5hbWU6IHRoaXMubG9jYWxOYW1lLAogICAgICAgICAgICAgICAgZXZlbnRDb250ZXh0OiB0aGlzCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMuX25lZWRzU2hpbUFkb3B0ZWRTdHlsZVNoZWV0cyA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9zdHlsZXMuZm9yRWFjaCgocyk9PnsKICAgICAgICAgICAgICAgIGNvbnN0IHN0eWxlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3R5bGUiKTsKICAgICAgICAgICAgICAgIHN0eWxlLnRleHRDb250ZW50ID0gcy5jc3NUZXh0OwogICAgICAgICAgICAgICAgdGhpcy5yZW5kZXJSb290LmFwcGVuZENoaWxkKHN0eWxlKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgcmVuZGVyKCkgewogICAgICAgIHJldHVybiByZW5kZXJOb3RJbXBsZW1lbnRlZDsKICAgIH0KfQpMaXRFbGVtZW50WyJmaW5hbGl6ZWQiXSA9IHRydWU7CkxpdEVsZW1lbnQucmVuZGVyID0gcmVuZGVyOwpMaXRFbGVtZW50LnNoYWRvd1Jvb3RPcHRpb25zID0gewogICAgbW9kZTogIm9wZW4iCn07CmNvbnN0IGhleFJlZ2V4ID0gL15bLStdPzB4W2EtZkEtRjAtOV0rJC87CmNvbnN0IG51bVJlZ2V4ID0gL14oW1wtXCtdKT8oMCopKFwuWzAtOV0rKFtlRV1cLT9bMC05XSspP3xbMC05XSsoXC5bMC05XSsoW2VFXVwtP1swLTldKyk/KT8pJC87CmNvbnN0IGNvbnNpZGVyID0gewogICAgaGV4OiB0cnVlLAogICAgbGVhZGluZ1plcm9zOiB0cnVlLAogICAgZGVjaW1hbFBvaW50OiAiLiIKfTsKZnVuY3Rpb24gdG9OdW1iZXIoc3RyLCBvcHRpb25zID0gewp9KSB7CiAgICBvcHRpb25zID0gT2JqZWN0LmFzc2lnbih7CiAgICB9LCBjb25zaWRlciwgb3B0aW9ucyk7CiAgICBpZiAoIXN0ciB8fCB0eXBlb2Ygc3RyICE9PSAic3RyaW5nIikgcmV0dXJuIHN0cjsKICAgIGxldCB0cmltbWVkU3RyID0gc3RyLnRyaW0oKTsKICAgIGlmIChvcHRpb25zLnNraXBMaWtlICE9PSB2b2lkIDAgJiYgb3B0aW9ucy5za2lwTGlrZS50ZXN0KHRyaW1tZWRTdHIpKSByZXR1cm4gc3RyOwogICAgZWxzZSBpZiAob3B0aW9ucy5oZXggJiYgaGV4UmVnZXgudGVzdCh0cmltbWVkU3RyKSkgewogICAgICAgIHJldHVybiBOdW1iZXIucGFyc2VJbnQodHJpbW1lZFN0ciwgMTYpOwogICAgfSBlbHNlIHsKICAgICAgICBjb25zdCBtYXRjaCA9IG51bVJlZ2V4LmV4ZWModHJpbW1lZFN0cik7CiAgICAgICAgaWYgKG1hdGNoKSB7CiAgICAgICAgICAgIG1hdGNoWzFdOwogICAgICAgICAgICBjb25zdCBsZWFkaW5nWmVyb3MgPSBtYXRjaFsyXTsKICAgICAgICAgICAgY29uc3QgbnVtID0gbWF0Y2hbM107CiAgICAgICAgICAgIG1hdGNoWzRdIHx8IG1hdGNoWzZdOwogICAgICAgICAgICBpZiAobGVhZGluZ1plcm9zLmxlbmd0aCA9PT0gMSAmJiBudW1bMF0gPT09ICIuIikgcmV0dXJuIE51bWJlcihzdHIpOwogICAgICAgICAgICBlbHNlIGlmICghb3B0aW9ucy5sZWFkaW5nWmVyb3MgJiYgbGVhZGluZ1plcm9zLmxlbmd0aCA+IDApIHJldHVybiBzdHI7CiAgICAgICAgICAgIGVsc2UgcmV0dXJuIE51bWJlcih0cmltbWVkU3RyKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0KICAgIH0KfQp2YXIgc3RybnVtID0gdG9OdW1iZXI7CmZ1bmN0aW9uIGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZuLCBiYXNlZGlyLCBtb2R1bGUpIHsKICAgIHJldHVybiBtb2R1bGUgPSB7CiAgICAgICAgcGF0aDogYmFzZWRpciwKICAgICAgICBleHBvcnRzOiB7CiAgICAgICAgfSwKICAgICAgICByZXF1aXJlOiBmdW5jdGlvbihwYXRoLCBiYXNlKSB7CiAgICAgICAgICAgIHJldHVybiBjb21tb25qc1JlcXVpcmUocGF0aCwgYmFzZSA9PT0gdm9pZCAwIHx8IGJhc2UgPT09IG51bGwgPyBtb2R1bGUucGF0aCA6IGJhc2UpOwogICAgICAgIH0KICAgIH0sIGZuKG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMpLCBtb2R1bGUuZXhwb3J0czsKfQpmdW5jdGlvbiBjb21tb25qc1JlcXVpcmUoKSB7CiAgICB0aHJvdyBuZXcgRXJyb3IoIkR5bmFtaWMgcmVxdWlyZXMgYXJlIG5vdCBjdXJyZW50bHkgc3VwcG9ydGVkIGJ5IEByb2xsdXAvcGx1Z2luLWNvbW1vbmpzIik7Cn0KdmFyIHV0aWwgPSBjcmVhdGVDb21tb25qc01vZHVsZShmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IG5hbWVTdGFydENoYXIgPSAiOkEtWmEtel9cXHUwMEMwLVxcdTAwRDZcXHUwMEQ4LVxcdTAwRjZcXHUwMEY4LVxcdTAyRkZcXHUwMzcwLVxcdTAzN0RcXHUwMzdGLVxcdTFGRkZcXHUyMDBDLVxcdTIwMERcXHUyMDcwLVxcdTIxOEZcXHUyQzAwLVxcdTJGRUZcXHUzMDAxLVxcdUQ3RkZcXHVGOTAwLVxcdUZEQ0ZcXHVGREYwLVxcdUZGRkQiOwogICAgY29uc3QgbmFtZUNoYXIgPSBuYW1lU3RhcnRDaGFyICsgIlxcLS5cXGRcXHUwMEI3XFx1MDMwMC1cXHUwMzZGXFx1MjAzRi1cXHUyMDQwIjsKICAgIGNvbnN0IG5hbWVSZWdleHAgPSAiWyIgKyBuYW1lU3RhcnRDaGFyICsgIl1bIiArIG5hbWVDaGFyICsgIl0qIjsKICAgIGNvbnN0IHJlZ2V4TmFtZSA9IG5ldyBSZWdFeHAoIl4iICsgbmFtZVJlZ2V4cCArICIkIik7CiAgICBjb25zdCBnZXRBbGxNYXRjaGVzID0gZnVuY3Rpb24oc3RyaW5nLCByZWdleCkgewogICAgICAgIGNvbnN0IG1hdGNoZXMgPSBbXTsKICAgICAgICBsZXQgbWF0Y2ggPSByZWdleC5leGVjKHN0cmluZyk7CiAgICAgICAgd2hpbGUobWF0Y2gpewogICAgICAgICAgICBjb25zdCBhbGxtYXRjaGVzID0gW107CiAgICAgICAgICAgIGFsbG1hdGNoZXMuc3RhcnRJbmRleCA9IHJlZ2V4Lmxhc3RJbmRleCAtIG1hdGNoWzBdLmxlbmd0aDsKICAgICAgICAgICAgY29uc3QgbGVuID0gbWF0Y2gubGVuZ3RoOwogICAgICAgICAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBsZW47IGluZGV4KyspewogICAgICAgICAgICAgICAgYWxsbWF0Y2hlcy5wdXNoKG1hdGNoW2luZGV4XSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgbWF0Y2hlcy5wdXNoKGFsbG1hdGNoZXMpOwogICAgICAgICAgICBtYXRjaCA9IHJlZ2V4LmV4ZWMoc3RyaW5nKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIG1hdGNoZXM7CiAgICB9OwogICAgY29uc3QgaXNOYW1lID0gZnVuY3Rpb24oc3RyaW5nKSB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSByZWdleE5hbWUuZXhlYyhzdHJpbmcpOwogICAgICAgIHJldHVybiAhKG1hdGNoID09PSBudWxsIHx8IHR5cGVvZiBtYXRjaCA9PT0gInVuZGVmaW5lZCIpOwogICAgfTsKICAgIGV4cG9ydHMuaXNFeGlzdCA9IGZ1bmN0aW9uKHYpIHsKICAgICAgICByZXR1cm4gdHlwZW9mIHYgIT09ICJ1bmRlZmluZWQiOwogICAgfTsKICAgIGV4cG9ydHMuaXNFbXB0eU9iamVjdCA9IGZ1bmN0aW9uKG9iaikgewogICAgICAgIHJldHVybiBPYmplY3Qua2V5cyhvYmopLmxlbmd0aCA9PT0gMDsKICAgIH07CiAgICBleHBvcnRzLm1lcmdlID0gZnVuY3Rpb24odGFyZ2V0LCBhLCBhcnJheU1vZGUpIHsKICAgICAgICBpZiAoYSkgewogICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYSk7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IGtleXMubGVuZ3RoOwogICAgICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICAgICAgaWYgKGFycmF5TW9kZSA9PT0gInN0cmljdCIpIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5c1tpXV0gPSBbCiAgICAgICAgICAgICAgICAgICAgICAgIGFba2V5c1tpXV0KICAgICAgICAgICAgICAgICAgICBdOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB0YXJnZXRba2V5c1tpXV0gPSBhW2tleXNbaV1dOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuZ2V0VmFsdWUgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgaWYgKGV4cG9ydHMuaXNFeGlzdCh2KSkgewogICAgICAgICAgICByZXR1cm4gdjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgfTsKICAgIGV4cG9ydHMuYnVpbGRPcHRpb25zID0gZnVuY3Rpb24ob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMyLCBwcm9wczIpIHsKICAgICAgICBsZXQgbmV3T3B0aW9ucyA9IHsKICAgICAgICB9OwogICAgICAgIGlmICghb3B0aW9ucykgewogICAgICAgICAgICByZXR1cm4gZGVmYXVsdE9wdGlvbnMyOwogICAgICAgIH0KICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgcHJvcHMyLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKG9wdGlvbnNbcHJvcHMyW2ldXSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBuZXdPcHRpb25zW3Byb3BzMltpXV0gPSBvcHRpb25zW3Byb3BzMltpXV07CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBuZXdPcHRpb25zW3Byb3BzMltpXV0gPSBkZWZhdWx0T3B0aW9uczJbcHJvcHMyW2ldXTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3T3B0aW9uczsKICAgIH07CiAgICBleHBvcnRzLmlzVGFnTmFtZUluQXJyYXlNb2RlID0gZnVuY3Rpb24odGFnTmFtZSwgYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKSB7CiAgICAgICAgaWYgKGFycmF5TW9kZSA9PT0gZmFsc2UpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH0gZWxzZSBpZiAoYXJyYXlNb2RlIGluc3RhbmNlb2YgUmVnRXhwKSB7CiAgICAgICAgICAgIHJldHVybiBhcnJheU1vZGUudGVzdCh0YWdOYW1lKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBhcnJheU1vZGUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgcmV0dXJuICEhYXJyYXlNb2RlKHRhZ05hbWUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gYXJyYXlNb2RlID09PSAic3RyaWN0IjsKICAgIH07CiAgICBleHBvcnRzLmlzTmFtZSA9IGlzTmFtZTsKICAgIGV4cG9ydHMuZ2V0QWxsTWF0Y2hlcyA9IGdldEFsbE1hdGNoZXM7CiAgICBleHBvcnRzLm5hbWVSZWdleHAgPSBuYW1lUmVnZXhwOwp9KTsKY29uc3QgY29udmVydFRvSnNvbiA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMsIHBhcmVudFRhZ05hbWUpIHsKICAgIGNvbnN0IGpPYmogPSB7CiAgICB9OwogICAgaWYgKCFvcHRpb25zLmFsd2F5c0NyZWF0ZVRleHROb2RlICYmICghbm9kZS5jaGlsZCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5jaGlsZCkpICYmICghbm9kZS5hdHRyc01hcCB8fCB1dGlsLmlzRW1wdHlPYmplY3Qobm9kZS5hdHRyc01hcCkpKSB7CiAgICAgICAgcmV0dXJuIHV0aWwuaXNFeGlzdChub2RlLnZhbCkgPyBub2RlLnZhbCA6ICIiOwogICAgfQogICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkgJiYgISh0eXBlb2Ygbm9kZS52YWwgPT09ICJzdHJpbmciICYmIChub2RlLnZhbCA9PT0gIiIgfHwgbm9kZS52YWwgPT09IG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIpKSkgewogICAgICAgIGNvbnN0IGFzQXJyYXkgPSB1dGlsLmlzVGFnTmFtZUluQXJyYXlNb2RlKG5vZGUudGFnbmFtZSwgb3B0aW9ucy5hcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgIGpPYmpbb3B0aW9ucy50ZXh0Tm9kZU5hbWVdID0gYXNBcnJheSA/IFsKICAgICAgICAgICAgbm9kZS52YWwKICAgICAgICBdIDogbm9kZS52YWw7CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXAsIG9wdGlvbnMuYXJyYXlNb2RlKTsKICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhub2RlLmNoaWxkKTsKICAgIGZvcihsZXQgaW5kZXggPSAwOyBpbmRleCA8IGtleXMubGVuZ3RoOyBpbmRleCsrKXsKICAgICAgICBjb25zdCB0YWdOYW1lID0ga2V5c1tpbmRleF07CiAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnTmFtZV0gJiYgbm9kZS5jaGlsZFt0YWdOYW1lXS5sZW5ndGggPiAxKSB7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBbXTsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWdOYW1lXSl7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWdOYW1lXS5oYXNPd25Qcm9wZXJ0eSh0YWcpKSB7CiAgICAgICAgICAgICAgICAgICAgak9ialt0YWdOYW1lXS5wdXNoKGNvbnZlcnRUb0pzb24obm9kZS5jaGlsZFt0YWdOYW1lXVt0YWddLCBvcHRpb25zLCB0YWdOYW1lKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCByZXN1bHQgPSBjb252ZXJ0VG9Kc29uKG5vZGUuY2hpbGRbdGFnTmFtZV1bMF0sIG9wdGlvbnMsIHRhZ05hbWUpOwogICAgICAgICAgICBjb25zdCBhc0FycmF5ID0gb3B0aW9ucy5hcnJheU1vZGUgPT09IHRydWUgJiYgdHlwZW9mIHJlc3VsdCA9PT0gIm9iamVjdCIgfHwgdXRpbC5pc1RhZ05hbWVJbkFycmF5TW9kZSh0YWdOYW1lLCBvcHRpb25zLmFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSk7CiAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0gPSBhc0FycmF5ID8gWwogICAgICAgICAgICAgICAgcmVzdWx0CiAgICAgICAgICAgIF0gOiByZXN1bHQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGpPYmo7Cn07CnZhciBjb252ZXJ0VG9Kc29uXzEgPSBjb252ZXJ0VG9Kc29uOwp2YXIgbm9kZTJqc29uID0gewogICAgY29udmVydFRvSnNvbjogY29udmVydFRvSnNvbl8xCn07CnZhciB4bWxOb2RlID0gZnVuY3Rpb24odGFnbmFtZSwgcGFyZW50LCB2YWwpIHsKICAgIHRoaXMudGFnbmFtZSA9IHRhZ25hbWU7CiAgICB0aGlzLnBhcmVudCA9IHBhcmVudDsKICAgIHRoaXMuY2hpbGQgPSB7CiAgICB9OwogICAgdGhpcy5hdHRyc01hcCA9IHsKICAgIH07CiAgICB0aGlzLnZhbCA9IHZhbDsKICAgIHRoaXMuYWRkQ2hpbGQgPSBmdW5jdGlvbihjaGlsZCkgewogICAgICAgIGlmIChBcnJheS5pc0FycmF5KHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0pKSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0ucHVzaChjaGlsZCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5jaGlsZFtjaGlsZC50YWduYW1lXSA9IFsKICAgICAgICAgICAgICAgIGNoaWxkCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgfTsKfTsKY29uc3QgYnVpbGRPcHRpb25zID0gdXRpbC5idWlsZE9wdGlvbnM7CiI8KCghXFxbQ0RBVEFcXFsoW1xcc1xcU10qPykoXV0+KSl8KChOQU1FOik/KE5BTUUpKShbXj5dKik+fCgoXFwvKShOQU1FKVxccyo+KSkoW148XSopIi5yZXBsYWNlKC9OQU1FL2csIHV0aWwubmFtZVJlZ2V4cCk7CmlmICghTnVtYmVyLnBhcnNlSW50ICYmIHdpbmRvdy5wYXJzZUludCkgewogICAgTnVtYmVyLnBhcnNlSW50ID0gd2luZG93LnBhcnNlSW50Owp9CmlmICghTnVtYmVyLnBhcnNlRmxvYXQgJiYgd2luZG93LnBhcnNlRmxvYXQpIHsKICAgIE51bWJlci5wYXJzZUZsb2F0ID0gd2luZG93LnBhcnNlRmxvYXQ7Cn0KY29uc3QgZGVmYXVsdE9wdGlvbnMgPSB7CiAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAiQF8iLAogICAgYXR0ck5vZGVOYW1lOiBmYWxzZSwKICAgIHRleHROb2RlTmFtZTogIiN0ZXh0IiwKICAgIGlnbm9yZUF0dHJpYnV0ZXM6IHRydWUsCiAgICBpZ25vcmVOYW1lU3BhY2U6IGZhbHNlLAogICAgYWxsb3dCb29sZWFuQXR0cmlidXRlczogZmFsc2UsCiAgICBwYXJzZU5vZGVWYWx1ZTogdHJ1ZSwKICAgIHBhcnNlQXR0cmlidXRlVmFsdWU6IGZhbHNlLAogICAgYXJyYXlNb2RlOiBmYWxzZSwKICAgIHRyaW1WYWx1ZXM6IHRydWUsCiAgICBjZGF0YVRhZ05hbWU6IGZhbHNlLAogICAgY2RhdGFQb3NpdGlvbkNoYXI6ICJcXGMiLAogICAgbnVtUGFyc2VPcHRpb25zOiB7CiAgICAgICAgaGV4OiB0cnVlLAogICAgICAgIGxlYWRpbmdaZXJvczogdHJ1ZQogICAgfSwKICAgIHRhZ1ZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhLCB0YWdOYW1lKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgYXR0clZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhLCBhdHRyTmFtZSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIHN0b3BOb2RlczogW10sCiAgICBhbHdheXNDcmVhdGVUZXh0Tm9kZTogZmFsc2UKfTsKdmFyIGRlZmF1bHRPcHRpb25zXzEgPSBkZWZhdWx0T3B0aW9uczsKY29uc3QgcHJvcHMgPSBbCiAgICAiYXR0cmlidXRlTmFtZVByZWZpeCIsCiAgICAiYXR0ck5vZGVOYW1lIiwKICAgICJ0ZXh0Tm9kZU5hbWUiLAogICAgImlnbm9yZUF0dHJpYnV0ZXMiLAogICAgImlnbm9yZU5hbWVTcGFjZSIsCiAgICAiYWxsb3dCb29sZWFuQXR0cmlidXRlcyIsCiAgICAicGFyc2VOb2RlVmFsdWUiLAogICAgInBhcnNlQXR0cmlidXRlVmFsdWUiLAogICAgImFycmF5TW9kZSIsCiAgICAidHJpbVZhbHVlcyIsCiAgICAiY2RhdGFUYWdOYW1lIiwKICAgICJjZGF0YVBvc2l0aW9uQ2hhciIsCiAgICAidGFnVmFsdWVQcm9jZXNzb3IiLAogICAgImF0dHJWYWx1ZVByb2Nlc3NvciIsCiAgICAicGFyc2VUcnVlTnVtYmVyT25seSIsCiAgICAibnVtUGFyc2VPcHRpb25zIiwKICAgICJzdG9wTm9kZXMiLAogICAgImFsd2F5c0NyZWF0ZVRleHROb2RlIgpdOwp2YXIgcHJvcHNfMSA9IHByb3BzOwpmdW5jdGlvbiBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdmFsLCBvcHRpb25zKSB7CiAgICBpZiAodmFsKSB7CiAgICAgICAgaWYgKG9wdGlvbnMudHJpbVZhbHVlcykgewogICAgICAgICAgICB2YWwgPSB2YWwudHJpbSgpOwogICAgICAgIH0KICAgICAgICB2YWwgPSBvcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKHZhbCwgdGFnTmFtZSk7CiAgICAgICAgdmFsID0gcGFyc2VWYWx1ZSh2YWwsIG9wdGlvbnMucGFyc2VOb2RlVmFsdWUsIG9wdGlvbnMubnVtUGFyc2VPcHRpb25zKTsKICAgIH0KICAgIHJldHVybiB2YWw7Cn0KZnVuY3Rpb24gcmVzb2x2ZU5hbWVTcGFjZSh0YWduYW1lLCBvcHRpb25zKSB7CiAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICBjb25zdCB0YWdzID0gdGFnbmFtZS5zcGxpdCgiOiIpOwogICAgICAgIGNvbnN0IHByZWZpeCA9IHRhZ25hbWUuY2hhckF0KDApID09PSAiLyIgPyAiLyIgOiAiIjsKICAgICAgICBpZiAodGFnc1swXSA9PT0gInhtbG5zIikgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfQogICAgICAgIGlmICh0YWdzLmxlbmd0aCA9PT0gMikgewogICAgICAgICAgICB0YWduYW1lID0gcHJlZml4ICsgdGFnc1sxXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gdGFnbmFtZTsKfQpmdW5jdGlvbiBwYXJzZVZhbHVlKHZhbCwgc2hvdWxkUGFyc2UsIG9wdGlvbnMpIHsKICAgIGlmIChzaG91bGRQYXJzZSAmJiB0eXBlb2YgdmFsID09PSAic3RyaW5nIikgewogICAgICAgIGNvbnN0IG5ld3ZhbCA9IHZhbC50cmltKCk7CiAgICAgICAgaWYgKG5ld3ZhbCA9PT0gInRydWUiKSByZXR1cm4gdHJ1ZTsKICAgICAgICBlbHNlIGlmIChuZXd2YWwgPT09ICJmYWxzZSIpIHJldHVybiBmYWxzZTsKICAgICAgICBlbHNlIHJldHVybiBzdHJudW0odmFsLCBvcHRpb25zKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNFeGlzdCh2YWwpKSB7CiAgICAgICAgICAgIHJldHVybiB2YWw7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBhdHRyc1JlZ3ggPSBuZXcgUmVnRXhwKGAoW15cXHM9XSspXFxzKig9XFxzKihbJyJdKSguKj8pXFwzKT9gLCAiZyIpOwpmdW5jdGlvbiBidWlsZEF0dHJpYnV0ZXNNYXAoYXR0clN0ciwgb3B0aW9ucykgewogICAgaWYgKCFvcHRpb25zLmlnbm9yZUF0dHJpYnV0ZXMgJiYgdHlwZW9mIGF0dHJTdHIgPT09ICJzdHJpbmciKSB7CiAgICAgICAgYXR0clN0ciA9IGF0dHJTdHIucmVwbGFjZSgvXHI/XG4vZywgIiAiKTsKICAgICAgICBjb25zdCBtYXRjaGVzID0gdXRpbC5nZXRBbGxNYXRjaGVzKGF0dHJTdHIsIGF0dHJzUmVneCk7CiAgICAgICAgY29uc3QgbGVuID0gbWF0Y2hlcy5sZW5ndGg7CiAgICAgICAgY29uc3QgYXR0cnMgPSB7CiAgICAgICAgfTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbGVuOyBpKyspewogICAgICAgICAgICBjb25zdCBhdHRyTmFtZSA9IHJlc29sdmVOYW1lU3BhY2UobWF0Y2hlc1tpXVsxXSwgb3B0aW9ucyk7CiAgICAgICAgICAgIGlmIChhdHRyTmFtZS5sZW5ndGgpIHsKICAgICAgICAgICAgICAgIGlmIChtYXRjaGVzW2ldWzRdICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy50cmltVmFsdWVzKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoZXNbaV1bNF0gPSBtYXRjaGVzW2ldWzRdLnRyaW0oKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbWF0Y2hlc1tpXVs0XSA9IG9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKG1hdGNoZXNbaV1bNF0sIGF0dHJOYW1lKTsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tvcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXggKyBhdHRyTmFtZV0gPSBwYXJzZVZhbHVlKG1hdGNoZXNbaV1bNF0sIG9wdGlvbnMucGFyc2VBdHRyaWJ1dGVWYWx1ZSwgb3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpOwogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChvcHRpb25zLmFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMpIHsKICAgICAgICAgICAgICAgICAgICBhdHRyc1tvcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXggKyBhdHRyTmFtZV0gPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGlmICghT2JqZWN0LmtleXMoYXR0cnMpLmxlbmd0aCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChvcHRpb25zLmF0dHJOb2RlTmFtZSkgewogICAgICAgICAgICBjb25zdCBhdHRyQ29sbGVjdGlvbiA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgYXR0ckNvbGxlY3Rpb25bb3B0aW9ucy5hdHRyTm9kZU5hbWVdID0gYXR0cnM7CiAgICAgICAgICAgIHJldHVybiBhdHRyQ29sbGVjdGlvbjsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQp9CmNvbnN0IGdldFRyYXZlcnNhbE9iaiA9IGZ1bmN0aW9uKHhtbERhdGEsIG9wdGlvbnMpIHsKICAgIHhtbERhdGEgPSB4bWxEYXRhLnJlcGxhY2UoL1xyXG4/L2csICJcbiIpOwogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucywgcHJvcHMpOwogICAgY29uc3QgeG1sT2JqID0gbmV3IHhtbE5vZGUoIiF4bWwiKTsKICAgIGxldCBjdXJyZW50Tm9kZSA9IHhtbE9iajsKICAgIGxldCB0ZXh0RGF0YSA9ICIiOwogICAgZm9yKGxldCBpID0gMDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGNvbnN0IGNoID0geG1sRGF0YVtpXTsKICAgICAgICBpZiAoY2ggPT09ICI8IikgewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiQ2xvc2luZyBUYWcgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0geG1sRGF0YS5zdWJzdHJpbmcoaSArIDIsIGNsb3NlSW5kZXgpLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudmFsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSBwcm9jZXNzVGFnVmFsdWUodGFnTmFtZSwgdGV4dERhdGEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLnN0b3BOb2Rlcy5sZW5ndGggJiYgb3B0aW9ucy5zdG9wTm9kZXMuaW5jbHVkZXMoY3VycmVudE5vZGUudGFnbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5jaGlsZCA9IFtdOwogICAgICAgICAgICAgICAgICAgIGlmIChjdXJyZW50Tm9kZS5hdHRyc01hcCA9PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYXR0cnNNYXAgPSB7CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHhtbERhdGEuc3Vic3RyKGN1cnJlbnROb2RlLnN0YXJ0SW5kZXggKyAxLCBpIC0gY3VycmVudE5vZGUuc3RhcnRJbmRleCAtIDEpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY3VycmVudE5vZGUgPSBjdXJyZW50Tm9kZS5wYXJlbnQ7CiAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgaSA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj8+IiwgaSwgIlBpIFRhZyBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAzKSA9PT0gIiEtLSIpIHsKICAgICAgICAgICAgICAgIGkgPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICItLT4iLCBpLCAiQ29tbWVudCBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFEIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIj4iLCBpLCAiRE9DVFlQRSBpcyBub3QgY2xvc2VkLiIpOwogICAgICAgICAgICAgICAgY29uc3QgdGFnRXhwID0geG1sRGF0YS5zdWJzdHJpbmcoaSwgY2xvc2VJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmluZGV4T2YoIlsiKSA+PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgaSA9IHhtbERhdGEuaW5kZXhPZigiXT4iLCBpKSArIDE7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGEuc3Vic3RyKGkgKyAxLCAyKSA9PT0gIiFbIikgewogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgIl1dPiIsIGksICJDREFUQSBpcyBub3QgY2xvc2VkLiIpIC0gMjsKICAgICAgICAgICAgICAgIGNvbnN0IHRhZ0V4cCA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyA5LCBjbG9zZUluZGV4KTsKICAgICAgICAgICAgICAgIGlmICh0ZXh0RGF0YSkgewogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB0ZXh0RGF0YSA9ICIiOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUob3B0aW9ucy5jZGF0YVRhZ05hbWUsIGN1cnJlbnROb2RlLCB0YWdFeHApOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gdXRpbC5nZXRWYWx1ZShjdXJyZW50Tm9kZS52YWwpICsgb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcjsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS52YWwgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSAoY3VycmVudE5vZGUudmFsIHx8ICIiKSArICh0YWdFeHAgfHwgIiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaSA9IGNsb3NlSW5kZXggKyAyOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY2xvc2luZ0luZGV4Rm9yT3BlbmluZ1RhZyh4bWxEYXRhLCBpICsgMSk7CiAgICAgICAgICAgICAgICBsZXQgdGFnRXhwID0gcmVzdWx0LmRhdGE7CiAgICAgICAgICAgICAgICBjb25zdCBjbG9zZUluZGV4ID0gcmVzdWx0LmluZGV4OwogICAgICAgICAgICAgICAgY29uc3Qgc2VwYXJhdG9ySW5kZXggPSB0YWdFeHAuaW5kZXhPZigiICIpOwogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSB0YWdFeHA7CiAgICAgICAgICAgICAgICBsZXQgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChzZXBhcmF0b3JJbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnRXhwLnN1YnN0cigwLCBzZXBhcmF0b3JJbmRleCkucmVwbGFjZSgvXHNccyokLywgIiIpOwogICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoc2VwYXJhdG9ySW5kZXggKyAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmlnbm9yZU5hbWVTcGFjZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNvbG9uSW5kZXggPSB0YWdOYW1lLmluZGV4T2YoIjoiKTsKICAgICAgICAgICAgICAgICAgICBpZiAoY29sb25JbmRleCAhPT0gLTEpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwID0gdGFnTmFtZSAhPT0gcmVzdWx0LmRhdGEuc3Vic3RyKGNvbG9uSW5kZXggKyAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUgJiYgdGV4dERhdGEpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUudGFnbmFtZSAhPT0gIiF4bWwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArICIiICsgcHJvY2Vzc1RhZ1ZhbHVlKGN1cnJlbnROb2RlLnRhZ25hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAodGFnRXhwLmxlbmd0aCA+IDAgJiYgdGFnRXhwLmxhc3RJbmRleE9mKCIvIikgPT09IHRhZ0V4cC5sZW5ndGggLSAxKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cigwLCB0YWdOYW1lLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdOYW1lOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0V4cCA9IHRhZ0V4cC5zdWJzdHIoMCwgdGFnRXhwLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZSh0YWdOYW1lLCBjdXJyZW50Tm9kZSwgIiIpOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHApIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLmF0dHJzTWFwID0gYnVpbGRBdHRyaWJ1dGVzTWFwKHRhZ0V4cCwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmFkZENoaWxkKGNoaWxkTm9kZSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKHRhZ05hbWUsIGN1cnJlbnROb2RlKTsKICAgICAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGNoaWxkTm9kZS50YWduYW1lKSkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuc3RhcnRJbmRleCA9IGNsb3NlSW5kZXg7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSB0YWdFeHAgJiYgc2hvdWxkQnVpbGRBdHRyaWJ1dGVzTWFwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5hdHRyc01hcCA9IGJ1aWxkQXR0cmlidXRlc01hcCh0YWdFeHAsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY2hpbGROb2RlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGV4dERhdGEgKz0geG1sRGF0YVtpXTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4geG1sT2JqOwp9OwpmdW5jdGlvbiBjbG9zaW5nSW5kZXhGb3JPcGVuaW5nVGFnKGRhdGEsIGkpIHsKICAgIGxldCBhdHRyQm91bmRhcnk7CiAgICBsZXQgdGFnRXhwID0gIiI7CiAgICBmb3IobGV0IGluZGV4ID0gaTsgaW5kZXggPCBkYXRhLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgbGV0IGNoID0gZGF0YVtpbmRleF07CiAgICAgICAgaWYgKGF0dHJCb3VuZGFyeSkgewogICAgICAgICAgICBpZiAoY2ggPT09IGF0dHJCb3VuZGFyeSkgYXR0ckJvdW5kYXJ5ID0gIiI7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gJyInIHx8IGNoID09PSAiJyIpIHsKICAgICAgICAgICAgYXR0ckJvdW5kYXJ5ID0gY2g7CiAgICAgICAgfSBlbHNlIGlmIChjaCA9PT0gIj4iKSB7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBkYXRhOiB0YWdFeHAsCiAgICAgICAgICAgICAgICBpbmRleAogICAgICAgICAgICB9OwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICIJIikgewogICAgICAgICAgICBjaCA9ICIgIjsKICAgICAgICB9CiAgICAgICAgdGFnRXhwICs9IGNoOwogICAgfQp9CmZ1bmN0aW9uIGZpbmRDbG9zaW5nSW5kZXgoeG1sRGF0YSwgc3RyLCBpLCBlcnJNc2cpIHsKICAgIGNvbnN0IGNsb3NpbmdJbmRleCA9IHhtbERhdGEuaW5kZXhPZihzdHIsIGkpOwogICAgaWYgKGNsb3NpbmdJbmRleCA9PT0gLTEpIHsKICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyTXNnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIGNsb3NpbmdJbmRleCArIHN0ci5sZW5ndGggLSAxOwogICAgfQp9CnZhciBnZXRUcmF2ZXJzYWxPYmpfMSA9IGdldFRyYXZlcnNhbE9iajsKdmFyIHhtbHN0cjJ4bWxub2RlID0gewogICAgZGVmYXVsdE9wdGlvbnM6IGRlZmF1bHRPcHRpb25zXzEsCiAgICBwcm9wczogcHJvcHNfMSwKICAgIGdldFRyYXZlcnNhbE9iajogZ2V0VHJhdmVyc2FsT2JqXzEKfTsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMSA9IHsKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlCn07CmNvbnN0IHByb3BzJDEgPSBbCiAgICAiYWxsb3dCb29sZWFuQXR0cmlidXRlcyIKXTsKdmFyIHZhbGlkYXRlID0gZnVuY3Rpb24oeG1sRGF0YSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDEsIHByb3BzJDEpOwogICAgY29uc3QgdGFncyA9IFtdOwogICAgbGV0IHRhZ0ZvdW5kID0gZmFsc2U7CiAgICBsZXQgcmVhY2hlZFJvb3QgPSBmYWxzZTsKICAgIGlmICh4bWxEYXRhWzBdID09PSAiXHVGRUZGIikgewogICAgICAgIHhtbERhdGEgPSB4bWxEYXRhLnN1YnN0cigxKTsKICAgIH0KICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiICYmIHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICBpID0gcmVhZFBJKHhtbERhdGEsIGkpOwogICAgICAgICAgICBpZiAoaS5lcnIpIHJldHVybiBpOwogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgIGxldCB0YWdTdGFydFBvcyA9IGk7CiAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIhIikgewogICAgICAgICAgICAgICAgaSA9IHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGxldCBjbG9zaW5nVGFnID0gZmFsc2U7CiAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgY2xvc2luZ1RhZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgbGV0IHRhZ05hbWUgPSAiIjsKICAgICAgICAgICAgICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aCAmJiB4bWxEYXRhW2ldICE9PSAiPiIgJiYgeG1sRGF0YVtpXSAhPT0gIiAiICYmIHhtbERhdGFbaV0gIT09ICIJIiAmJiB4bWxEYXRhW2ldICE9PSAiXG4iICYmIHhtbERhdGFbaV0gIT09ICJcciI7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSArPSB4bWxEYXRhW2ldOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUudHJpbSgpOwogICAgICAgICAgICAgICAgaWYgKHRhZ05hbWVbdGFnTmFtZS5sZW5ndGggLSAxXSA9PT0gIi8iKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ05hbWUuc3Vic3RyaW5nKDAsIHRhZ05hbWUubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgaS0tOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKCF2YWxpZGF0ZVRhZ05hbWUodGFnTmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgbXNnOwogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lLnRyaW0oKS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIkludmFsaWQgc3BhY2UgYWZ0ZXIgJzwnLiI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbXNnID0gIlRhZyAnIiArIHRhZ05hbWUgKyAiJyBpcyBhbiBpbnZhbGlkIG5hbWUuIjsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgbXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgIGlmIChyZXN1bHQgPT09IGZhbHNlKSB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGVzIGZvciAnIiArIHRhZ05hbWUgKyAiJyBoYXZlIG9wZW4gcXVvdGUuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCBhdHRyU3RyID0gcmVzdWx0LnZhbHVlOwogICAgICAgICAgICAgICAgaSA9IHJlc3VsdC5pbmRleDsKICAgICAgICAgICAgICAgIGlmIChhdHRyU3RyW2F0dHJTdHIubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJTdHJTdGFydCA9IGkgLSBhdHRyU3RyLmxlbmd0aDsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyID0gYXR0clN0ci5zdWJzdHJpbmcoMCwgYXR0clN0ci5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgPT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdChpc1ZhbGlkLmVyci5jb2RlLCBpc1ZhbGlkLmVyci5tc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBhdHRyU3RyU3RhcnQgKyBpc1ZhbGlkLmVyci5saW5lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChjbG9zaW5nVGFnKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKCFyZXN1bHQudGFnQ2xvc2VkKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJDbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJyBkb2Vzbid0IGhhdmUgcHJvcGVyIGNsb3NpbmcuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGF0dHJTdHIudHJpbSgpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIkNsb3NpbmcgdGFnICciICsgdGFnTmFtZSArICInIGNhbid0IGhhdmUgYXR0cmlidXRlcyBvciBpbnZhbGlkIHN0YXJ0aW5nLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdTdGFydFBvcykpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG90ZyA9IHRhZ3MucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lICE9PSBvdGcudGFnTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9wZW5Qb3MgPSBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgb3RnLnRhZ1N0YXJ0UG9zKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJFeHBlY3RlZCBjbG9zaW5nIHRhZyAnIiArIG90Zy50YWdOYW1lICsgIicgKG9wZW5lZCBpbiBsaW5lICIgKyBvcGVuUG9zLmxpbmUgKyAiLCBjb2wgIiArIG9wZW5Qb3MuY29sICsgIikgaW5zdGVhZCBvZiBjbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnU3RhcnRQb3MpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFncy5sZW5ndGggPT0gMCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhY2hlZFJvb3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpc1ZhbGlkID0gdmFsaWRhdGVBdHRyaWJ1dGVTdHJpbmcoYXR0clN0ciwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGlzVmFsaWQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KGlzVmFsaWQuZXJyLmNvZGUsIGlzVmFsaWQuZXJyLm1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkgLSBhdHRyU3RyLmxlbmd0aCArIGlzVmFsaWQuZXJyLmxpbmUpKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgaWYgKHJlYWNoZWRSb290ID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJNdWx0aXBsZSBwb3NzaWJsZSByb290IG5vZGVzIGZvdW5kLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdGFncy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdTdGFydFBvcwogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgdGFnRm91bmQgPSB0cnVlOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgZm9yKGkrKzsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiISIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpICsgMV0gPT09ICI/IikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaSA9IHJlYWRQSSh4bWxEYXRhLCArK2kpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGkuZXJyKSByZXR1cm4gaTsKICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiJiIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgYWZ0ZXJBbXAgPSB2YWxpZGF0ZUFtcGVyc2FuZCh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGFmdGVyQW1wID09IC0xKSByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRDaGFyIiwgImNoYXIgJyYnIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgICAgICBpID0gYWZ0ZXJBbXA7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiICIgfHwgeG1sRGF0YVtpXSA9PT0gIgkiIHx8IHhtbERhdGFbaV0gPT09ICJcbiIgfHwgeG1sRGF0YVtpXSA9PT0gIlxyIikgewogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQ2hhciIsICJjaGFyICciICsgeG1sRGF0YVtpXSArICInIGlzIG5vdCBleHBlY3RlZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgIH0KICAgIH0KICAgIGlmICghdGFnRm91bmQpIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiU3RhcnQgdGFnIGV4cGVjdGVkLiIsIDEpOwogICAgfSBlbHNlIGlmICh0YWdzLmxlbmd0aCA9PSAxKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkVGFnIiwgIlVuY2xvc2VkIHRhZyAnIiArIHRhZ3NbMF0udGFnTmFtZSArICInLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCB0YWdzWzBdLnRhZ1N0YXJ0UG9zKSk7CiAgICB9IGVsc2UgaWYgKHRhZ3MubGVuZ3RoID4gMCkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFhtbCIsICJJbnZhbGlkICciICsgSlNPTi5zdHJpbmdpZnkodGFncy5tYXAoKHQpPT50LnRhZ05hbWUKICAgICAgICApLCBudWxsLCA0KS5yZXBsYWNlKC9ccj9cbi9nLCAiIikgKyAiJyBmb3VuZC4iLCB7CiAgICAgICAgICAgIGxpbmU6IDEsCiAgICAgICAgICAgIGNvbDogMQogICAgICAgIH0pOwogICAgfQogICAgcmV0dXJuIHRydWU7Cn07CmZ1bmN0aW9uIHJlYWRQSSh4bWxEYXRhLCBpKSB7CiAgICBjb25zdCBzdGFydCA9IGk7CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT0gIj8iIHx8IHhtbERhdGFbaV0gPT0gIiAiKSB7CiAgICAgICAgICAgIGNvbnN0IHRhZ25hbWUgPSB4bWxEYXRhLnN1YnN0cihzdGFydCwgaSAtIHN0YXJ0KTsKICAgICAgICAgICAgaWYgKGkgPiA1ICYmIHRhZ25hbWUgPT09ICJ4bWwiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiWE1MIGRlY2xhcmF0aW9uIGFsbG93ZWQgb25seSBhdCB0aGUgc3RhcnQgb2YgdGhlIGRvY3VtZW50LiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PSAiPyIgJiYgeG1sRGF0YVtpICsgMV0gPT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIGk7Cn0KZnVuY3Rpb24gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKSB7CiAgICBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgNSAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDJdID09PSAiLSIpIHsKICAgICAgICBmb3IoaSArPSAzOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgOCAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDJdID09PSAiTyIgJiYgeG1sRGF0YVtpICsgM10gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyA0XSA9PT0gIlQiICYmIHhtbERhdGFbaSArIDVdID09PSAiWSIgJiYgeG1sRGF0YVtpICsgNl0gPT09ICJQIiAmJiB4bWxEYXRhW2kgKyA3XSA9PT0gIkUiKSB7CiAgICAgICAgbGV0IGFuZ2xlQnJhY2tldHNDb3VudCA9IDE7CiAgICAgICAgZm9yKGkgKz0gODsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICBhbmdsZUJyYWNrZXRzQ291bnQrKzsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhW2ldID09PSAiPiIpIHsKICAgICAgICAgICAgICAgIGFuZ2xlQnJhY2tldHNDb3VudC0tOwogICAgICAgICAgICAgICAgaWYgKGFuZ2xlQnJhY2tldHNDb3VudCA9PT0gMCkgewogICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBlbHNlIGlmICh4bWxEYXRhLmxlbmd0aCA+IGkgKyA5ICYmIHhtbERhdGFbaSArIDFdID09PSAiWyIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICJDIiAmJiB4bWxEYXRhW2kgKyAzXSA9PT0gIkQiICYmIHhtbERhdGFbaSArIDRdID09PSAiQSIgJiYgeG1sRGF0YVtpICsgNV0gPT09ICJUIiAmJiB4bWxEYXRhW2kgKyA2XSA9PT0gIkEiICYmIHhtbERhdGFbaSArIDddID09PSAiWyIpIHsKICAgICAgICBmb3IoaSArPSA4OyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiXSIgJiYgeG1sRGF0YVtpICsgMV0gPT09ICJdIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBpICs9IDI7CiAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwp9CmNvbnN0IGRvdWJsZVF1b3RlID0gJyInOwpjb25zdCBzaW5nbGVRdW90ZSA9ICInIjsKZnVuY3Rpb24gcmVhZEF0dHJpYnV0ZVN0cih4bWxEYXRhLCBpKSB7CiAgICBsZXQgYXR0clN0ciA9ICIiOwogICAgbGV0IHN0YXJ0Q2hhciA9ICIiOwogICAgbGV0IHRhZ0Nsb3NlZCA9IGZhbHNlOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSBkb3VibGVRdW90ZSB8fCB4bWxEYXRhW2ldID09PSBzaW5nbGVRdW90ZSkgewogICAgICAgICAgICBpZiAoc3RhcnRDaGFyID09PSAiIikgewogICAgICAgICAgICAgICAgc3RhcnRDaGFyID0geG1sRGF0YVtpXTsKICAgICAgICAgICAgfSBlbHNlIGlmIChzdGFydENoYXIgIT09IHhtbERhdGFbaV0pIDsKICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICBzdGFydENoYXIgPSAiIjsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIj4iKSB7CiAgICAgICAgICAgIGlmIChzdGFydENoYXIgPT09ICIiKSB7CiAgICAgICAgICAgICAgICB0YWdDbG9zZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgYXR0clN0ciArPSB4bWxEYXRhW2ldOwogICAgfQogICAgaWYgKHN0YXJ0Q2hhciAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIHZhbHVlOiBhdHRyU3RyLAogICAgICAgIGluZGV4OiBpLAogICAgICAgIHRhZ0Nsb3NlZAogICAgfTsKfQpjb25zdCB2YWxpZEF0dHJTdHJSZWd4cCA9IG5ldyBSZWdFeHAoYChcXHMqKShbXlxccz1dKykoXFxzKj0pPyhcXHMqKFsnIl0pKChbXFxzXFxTXSkqPylcXDUpP2AsICJnIik7CmZ1bmN0aW9uIHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGNvbnN0IG1hdGNoZXMgPSB1dGlsLmdldEFsbE1hdGNoZXMoYXR0clN0ciwgdmFsaWRBdHRyU3RyUmVneHApOwogICAgY29uc3QgYXR0ck5hbWVzID0gewogICAgfTsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCBtYXRjaGVzLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAobWF0Y2hlc1tpXVsxXS5sZW5ndGggPT09IDApIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaGFzIG5vIHNwYWNlIGluIHN0YXJ0aW5nLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9IGVsc2UgaWYgKG1hdGNoZXNbaV1bM10gPT09IHZvaWQgMCAmJiAhb3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiYm9vbGVhbiBhdHRyaWJ1dGUgJyIgKyBtYXRjaGVzW2ldWzJdICsgIicgaXMgbm90IGFsbG93ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgICAgICBjb25zdCBhdHRyTmFtZSA9IG1hdGNoZXNbaV1bMl07CiAgICAgICAgaWYgKCF2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSkgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgYW4gaW52YWxpZCBuYW1lLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgaWYgKCFhdHRyTmFtZXMuaGFzT3duUHJvcGVydHkoYXR0ck5hbWUpKSB7CiAgICAgICAgICAgIGF0dHJOYW1lc1thdHRyTmFtZV0gPSAxOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgYXR0ck5hbWUgKyAiJyBpcyByZXBlYXRlZC4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRydWU7Cn0KZnVuY3Rpb24gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgbGV0IHJlID0gL1xkLzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAieCIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmUgPSAvW1xkYS1mQS1GXS87CiAgICB9CiAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIGk7CiAgICAgICAgaWYgKCF4bWxEYXRhW2ldLm1hdGNoKHJlKSkgYnJlYWs7CiAgICB9CiAgICByZXR1cm4gLTE7Cn0KZnVuY3Rpb24gdmFsaWRhdGVBbXBlcnNhbmQoeG1sRGF0YSwgaSkgewogICAgaSsrOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICI7IikgcmV0dXJuIC0xOwogICAgaWYgKHhtbERhdGFbaV0gPT09ICIjIikgewogICAgICAgIGkrKzsKICAgICAgICByZXR1cm4gdmFsaWRhdGVOdW1iZXJBbXBlcnNhbmQoeG1sRGF0YSwgaSk7CiAgICB9CiAgICBsZXQgY291bnQgPSAwOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyssIGNvdW50KyspewogICAgICAgIGlmICh4bWxEYXRhW2ldLm1hdGNoKC9cdy8pICYmIGNvdW50IDwgMjApIGNvbnRpbnVlOwogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIGJyZWFrOwogICAgICAgIHJldHVybiAtMTsKICAgIH0KICAgIHJldHVybiBpOwp9CmZ1bmN0aW9uIGdldEVycm9yT2JqZWN0KGNvZGUsIG1lc3NhZ2UsIGxpbmVOdW1iZXIpIHsKICAgIHJldHVybiB7CiAgICAgICAgZXJyOiB7CiAgICAgICAgICAgIGNvZGUsCiAgICAgICAgICAgIG1zZzogbWVzc2FnZSwKICAgICAgICAgICAgbGluZTogbGluZU51bWJlci5saW5lIHx8IGxpbmVOdW1iZXIsCiAgICAgICAgICAgIGNvbDogbGluZU51bWJlci5jb2wKICAgICAgICB9CiAgICB9Owp9CmZ1bmN0aW9uIHZhbGlkYXRlQXR0ck5hbWUoYXR0ck5hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZShhdHRyTmFtZSk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVUYWdOYW1lKHRhZ25hbWUpIHsKICAgIHJldHVybiB1dGlsLmlzTmFtZSh0YWduYW1lKTsKfQpmdW5jdGlvbiBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaW5kZXgpIHsKICAgIGNvbnN0IGxpbmVzID0geG1sRGF0YS5zdWJzdHJpbmcoMCwgaW5kZXgpLnNwbGl0KC9ccj9cbi8pOwogICAgcmV0dXJuIHsKICAgICAgICBsaW5lOiBsaW5lcy5sZW5ndGgsCiAgICAgICAgY29sOiBsaW5lc1tsaW5lcy5sZW5ndGggLSAxXS5sZW5ndGggKyAxCiAgICB9Owp9CmZ1bmN0aW9uIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoKSB7CiAgICByZXR1cm4gbWF0Y2guc3RhcnRJbmRleCArIG1hdGNoWzFdLmxlbmd0aDsKfQp2YXIgdmFsaWRhdG9yID0gewogICAgdmFsaWRhdGUKfTsKY29uc3QgX19jaGFyID0gZnVuY3Rpb24oYSkgewogICAgcmV0dXJuIFN0cmluZy5mcm9tQ2hhckNvZGUoYSk7Cn07CmNvbnN0IGNoYXJzID0gewogICAgbmlsQ2hhcjogX19jaGFyKDE3NiksCiAgICBtaXNzaW5nQ2hhcjogX19jaGFyKDIwMSksCiAgICBuaWxQcmVtaXRpdmU6IF9fY2hhcigxNzUpLAogICAgbWlzc2luZ1ByZW1pdGl2ZTogX19jaGFyKDIwMCksCiAgICBlbXB0eUNoYXI6IF9fY2hhcigxNzgpLAogICAgZW1wdHlWYWx1ZTogX19jaGFyKDE3NyksCiAgICBib3VuZHJ5Q2hhcjogX19jaGFyKDE3OSksCiAgICBvYmpTdGFydDogX19jaGFyKDE5OCksCiAgICBhcnJTdGFydDogX19jaGFyKDIwNCksCiAgICBhcnJheUVuZDogX19jaGFyKDE4NSkKfTsKY29uc3QgY2hhcnNBcnIgPSBbCiAgICBjaGFycy5uaWxDaGFyLAogICAgY2hhcnMubmlsUHJlbWl0aXZlLAogICAgY2hhcnMubWlzc2luZ0NoYXIsCiAgICBjaGFycy5taXNzaW5nUHJlbWl0aXZlLAogICAgY2hhcnMuYm91bmRyeUNoYXIsCiAgICBjaGFycy5lbXB0eUNoYXIsCiAgICBjaGFycy5lbXB0eVZhbHVlLAogICAgY2hhcnMuYXJyYXlFbmQsCiAgICBjaGFycy5vYmpTdGFydCwKICAgIGNoYXJzLmFyclN0YXJ0Cl07CmNvbnN0IF9lID0gZnVuY3Rpb24obm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpIHsKICAgIGlmICh0eXBlb2YgZV9zY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgaWYgKG5vZGUgJiYgbm9kZVswXSAmJiBub2RlWzBdLnZhbCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlWzBdLnZhbCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIGdldFZhbHVlKG5vZGUpOwogICAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgaGFzVmFsaWREYXRhID0gaGFzRGF0YShub2RlKTsKICAgICAgICBpZiAoaGFzVmFsaWREYXRhID09PSB0cnVlKSB7CiAgICAgICAgICAgIGxldCBzdHIgPSAiIjsKICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkoZV9zY2hlbWEpKSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBpdGVtU2NoZW1hID0gZV9zY2hlbWFbMF07CiAgICAgICAgICAgICAgICBjb25zdCBhcnJfbGVuID0gbm9kZS5sZW5ndGg7CiAgICAgICAgICAgICAgICBpZiAodHlwZW9mIGl0ZW1TY2hlbWEgPT09ICJzdHJpbmciKSB7CiAgICAgICAgICAgICAgICAgICAgZm9yKGxldCBhcnJfaSA9IDA7IGFycl9pIDwgYXJyX2xlbjsgYXJyX2krKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHIgPSBnZXRWYWx1ZShub2RlW2Fycl9pXS52YWwpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gX2Uobm9kZVthcnJfaV0sIGl0ZW1TY2hlbWEsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMuYXJyYXlFbmQ7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzdHIgKz0gY2hhcnMub2JqU3RhcnQ7CiAgICAgICAgICAgICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoZV9zY2hlbWEpOwogICAgICAgICAgICAgICAgaWYgKEFycmF5LmlzQXJyYXkobm9kZSkpIHsKICAgICAgICAgICAgICAgICAgICBub2RlID0gbm9kZVswXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihsZXQgaSBpbiBrZXlzKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldOwogICAgICAgICAgICAgICAgICAgIGxldCByOwogICAgICAgICAgICAgICAgICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIG5vZGUuYXR0cnNNYXAgJiYgbm9kZS5hdHRyc01hcFtrZXldKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmF0dHJzTWFwW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoa2V5ID09PSBvcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS52YWwsIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHIgPSBfZShub2RlLmNoaWxkW2tleV0sIGVfc2NoZW1hW2tleV0sIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBzdHIgPSBwcm9jZXNzVmFsdWUoc3RyLCByKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICByZXR1cm4gc3RyOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBoYXNWYWxpZERhdGE7CiAgICAgICAgfQogICAgfQp9Owpjb25zdCBnZXRWYWx1ZSA9IGZ1bmN0aW9uKGEpIHsKICAgIHN3aXRjaChhKXsKICAgICAgICBjYXNlIHZvaWQgMDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm1pc3NpbmdQcmVtaXRpdmU7CiAgICAgICAgY2FzZSBudWxsOgogICAgICAgICAgICByZXR1cm4gY2hhcnMubmlsUHJlbWl0aXZlOwogICAgICAgIGNhc2UgIiI6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5lbXB0eVZhbHVlOwogICAgICAgIGRlZmF1bHQ6CiAgICAgICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9jZXNzVmFsdWUgPSBmdW5jdGlvbihzdHIsIHIpIHsKICAgIGlmICghaXNBcHBDaGFyKHJbMF0pICYmICFpc0FwcENoYXIoc3RyW3N0ci5sZW5ndGggLSAxXSkpIHsKICAgICAgICBzdHIgKz0gY2hhcnMuYm91bmRyeUNoYXI7CiAgICB9CiAgICByZXR1cm4gc3RyICsgcjsKfTsKY29uc3QgaXNBcHBDaGFyID0gZnVuY3Rpb24oY2gpIHsKICAgIHJldHVybiBjaGFyc0Fyci5pbmRleE9mKGNoKSAhPT0gLTE7Cn07CmZ1bmN0aW9uIGhhc0RhdGEoak9iaikgewogICAgaWYgKGpPYmogPT09IHZvaWQgMCkgewogICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iaiA9PT0gbnVsbCkgewogICAgICAgIHJldHVybiBjaGFycy5uaWxDaGFyOwogICAgfSBlbHNlIGlmIChqT2JqLmNoaWxkICYmIE9iamVjdC5rZXlzKGpPYmouY2hpbGQpLmxlbmd0aCA9PT0gMCAmJiAoIWpPYmouYXR0cnNNYXAgfHwgT2JqZWN0LmtleXMoak9iai5hdHRyc01hcCkubGVuZ3RoID09PSAwKSkgewogICAgICAgIHJldHVybiBjaGFycy5lbXB0eUNoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0cnVlOwogICAgfQp9CmNvbnN0IGJ1aWxkT3B0aW9ucyQxID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGNvbnZlcnQybmltbiA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBvcHRpb25zID0gYnVpbGRPcHRpb25zJDEob3B0aW9ucywgeG1sc3RyMnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLnByb3BzKTsKICAgIHJldHVybiBfZShub2RlLCBlX3NjaGVtYSwgb3B0aW9ucyk7Cn07CnZhciBjb252ZXJ0Mm5pbW5fMSA9IGNvbnZlcnQybmltbjsKdmFyIG5pbW5kYXRhID0gewogICAgY29udmVydDJuaW1uOiBjb252ZXJ0Mm5pbW5fMQp9Owpjb25zdCBidWlsZE9wdGlvbnMkMiA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0VG9Kc29uU3RyaW5nID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQyKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICBvcHRpb25zLmluZGVudEJ5ID0gb3B0aW9ucy5pbmRlbnRCeSB8fCAiIjsKICAgIHJldHVybiBfY1RvSnNvblN0cihub2RlLCBvcHRpb25zKTsKfTsKY29uc3QgX2NUb0pzb25TdHIgPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBsZXZlbCkgewogICAgbGV0IGpPYmogPSAieyI7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5jaGlsZCk7CiAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgY29uc3QgdGFnbmFtZSA9IGtleXNbaW5kZXhdOwogICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ25hbWVdICYmIG5vZGUuY2hpbGRbdGFnbmFtZV0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6IFsgJzsKICAgICAgICAgICAgZm9yKGxldCB0YWcgaW4gbm9kZS5jaGlsZFt0YWduYW1lXSl7CiAgICAgICAgICAgICAgICBqT2JqICs9IF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bdGFnXSwgb3B0aW9ucykgKyAiICwgIjsKICAgICAgICAgICAgfQogICAgICAgICAgICBqT2JqID0gak9iai5zdWJzdHIoMCwgak9iai5sZW5ndGggLSAxKSArICIgXSAiOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGpPYmogKz0gJyInICsgdGFnbmFtZSArICciIDogJyArIF9jVG9Kc29uU3RyKG5vZGUuY2hpbGRbdGFnbmFtZV1bMF0sIG9wdGlvbnMpICsgIiAsIjsKICAgICAgICB9CiAgICB9CiAgICB1dGlsLm1lcmdlKGpPYmosIG5vZGUuYXR0cnNNYXApOwogICAgaWYgKHV0aWwuaXNFbXB0eU9iamVjdChqT2JqKSkgewogICAgICAgIHJldHVybiB1dGlsLmlzRXhpc3Qobm9kZS52YWwpID8gbm9kZS52YWwgOiAiIjsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKHV0aWwuaXNFeGlzdChub2RlLnZhbCkpIHsKICAgICAgICAgICAgaWYgKCEodHlwZW9mIG5vZGUudmFsID09PSAic3RyaW5nIiAmJiAobm9kZS52YWwgPT09ICIiIHx8IG5vZGUudmFsID09PSBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyKSkpIHsKICAgICAgICAgICAgICAgIGpPYmogKz0gJyInICsgb3B0aW9ucy50ZXh0Tm9kZU5hbWUgKyAnIiA6ICcgKyBzdHJpbmd2YWwobm9kZS52YWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgaWYgKGpPYmpbak9iai5sZW5ndGggLSAxXSA9PT0gIiwiKSB7CiAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMik7CiAgICB9CiAgICByZXR1cm4gak9iaiArICJ9IjsKfTsKZnVuY3Rpb24gc3RyaW5ndmFsKHYpIHsKICAgIGlmICh2ID09PSB0cnVlIHx8IHYgPT09IGZhbHNlIHx8ICFpc05hTih2KSkgewogICAgICAgIHJldHVybiB2OwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gJyInICsgdiArICciJzsKICAgIH0KfQp2YXIgY29udmVydFRvSnNvblN0cmluZ18xID0gY29udmVydFRvSnNvblN0cmluZzsKdmFyIG5vZGUyanNvbl9zdHIgPSB7CiAgICBjb252ZXJ0VG9Kc29uU3RyaW5nOiBjb252ZXJ0VG9Kc29uU3RyaW5nXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDMgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgZGVmYXVsdE9wdGlvbnMkMiA9IHsKICAgIGF0dHJpYnV0ZU5hbWVQcmVmaXg6ICJAXyIsCiAgICBhdHRyTm9kZU5hbWU6IGZhbHNlLAogICAgdGV4dE5vZGVOYW1lOiAiI3RleHQiLAogICAgaWdub3JlQXR0cmlidXRlczogdHJ1ZSwKICAgIGNkYXRhVGFnTmFtZTogZmFsc2UsCiAgICBjZGF0YVBvc2l0aW9uQ2hhcjogIlxcYyIsCiAgICBmb3JtYXQ6IGZhbHNlLAogICAgaW5kZW50Qnk6ICIgICIsCiAgICBzdXByZXNzRW1wdHlOb2RlOiBmYWxzZSwKICAgIHRhZ1ZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9LAogICAgYXR0clZhbHVlUHJvY2Vzc29yOiBmdW5jdGlvbihhKSB7CiAgICAgICAgcmV0dXJuIGE7CiAgICB9Cn07CmNvbnN0IHByb3BzJDIgPSBbCiAgICAiYXR0cmlidXRlTmFtZVByZWZpeCIsCiAgICAiYXR0ck5vZGVOYW1lIiwKICAgICJ0ZXh0Tm9kZU5hbWUiLAogICAgImlnbm9yZUF0dHJpYnV0ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgImZvcm1hdCIsCiAgICAiaW5kZW50QnkiLAogICAgInN1cHJlc3NFbXB0eU5vZGUiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInJvb3ROb2RlTmFtZSIKXTsKZnVuY3Rpb24gUGFyc2VyKG9wdGlvbnMpIHsKICAgIHRoaXMub3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQzKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zJDIsIHByb3BzJDIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzIHx8IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICB0aGlzLmlzQXR0cmlidXRlID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmF0dHJQcmVmaXhMZW4gPSB0aGlzLm9wdGlvbnMuYXR0cmlidXRlTmFtZVByZWZpeC5sZW5ndGg7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGlzQXR0cmlidXRlOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWUpIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBpc0NEQVRBOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmlzQ0RBVEEgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgICAgIH07CiAgICB9CiAgICB0aGlzLnJlcGxhY2VDREFUQXN0ciA9IHJlcGxhY2VDREFUQXN0cjsKICAgIHRoaXMucmVwbGFjZUNEQVRBYXJyID0gcmVwbGFjZUNEQVRBYXJyOwogICAgdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZSA9IHByb2Nlc3NUZXh0T3JPYmpOb2RlOwogICAgaWYgKHRoaXMub3B0aW9ucy5mb3JtYXQpIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGluZGVudGF0ZTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPlxuIjsKICAgICAgICB0aGlzLm5ld0xpbmUgPSAiXG4iOwogICAgfSBlbHNlIHsKICAgICAgICB0aGlzLmluZGVudGF0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gIiI7CiAgICAgICAgfTsKICAgICAgICB0aGlzLnRhZ0VuZENoYXIgPSAiPiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIiI7CiAgICB9CiAgICBpZiAodGhpcy5vcHRpb25zLnN1cHJlc3NFbXB0eU5vZGUpIHsKICAgICAgICB0aGlzLmJ1aWxkVGV4dE5vZGUgPSBidWlsZEVtcHR5VGV4dE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZEVtcHR5T2JqTm9kZTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRUZXh0VmFsTm9kZTsKICAgICAgICB0aGlzLmJ1aWxkT2JqTm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKICAgIH0KICAgIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSA9IGJ1aWxkT2JqZWN0Tm9kZTsKfQpQYXJzZXIucHJvdG90eXBlLnBhcnNlID0gZnVuY3Rpb24oak9iaikgewogICAgaWYgKEFycmF5LmlzQXJyYXkoak9iaikgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZSAmJiB0aGlzLm9wdGlvbnMucm9vdE5vZGVOYW1lLmxlbmd0aCA+IDEpIHsKICAgICAgICBqT2JqID0gewogICAgICAgICAgICBbdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZV06IGpPYmoKICAgICAgICB9OwogICAgfQogICAgcmV0dXJuIHRoaXMuajJ4KGpPYmosIDApLnZhbDsKfTsKUGFyc2VyLnByb3RvdHlwZS5qMnggPSBmdW5jdGlvbihqT2JqLCBsZXZlbCkgewogICAgbGV0IGF0dHJTdHIgPSAiIjsKICAgIGxldCB2YWwgPSAiIjsKICAgIGZvcihsZXQga2V5IGluIGpPYmopewogICAgICAgIGlmICh0eXBlb2Ygak9ialtrZXldID09PSAidW5kZWZpbmVkIikgOwogICAgICAgIGVsc2UgaWYgKGpPYmpba2V5XSA9PT0gbnVsbCkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgICAgIH0gZWxzZSBpZiAoak9ialtrZXldIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGpPYmpba2V5XSwga2V5LCAiIiwgbGV2ZWwpOwogICAgICAgIH0gZWxzZSBpZiAodHlwZW9mIGpPYmpba2V5XSAhPT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuaXNBdHRyaWJ1dGUoa2V5KTsKICAgICAgICAgICAgaWYgKGF0dHIpIHsKICAgICAgICAgICAgICAgIGF0dHJTdHIgKz0gIiAiICsgYXR0ciArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKSArICciJzsKICAgICAgICAgICAgfSBlbHNlIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgaWYgKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0pIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFzdHIoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKCIiLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgaWYgKGtleSA9PT0gdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy5jZGF0YVRhZ05hbWVdKSA7CiAgICAgICAgICAgICAgICAgICAgZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSBpZiAoQXJyYXkuaXNBcnJheShqT2JqW2tleV0pKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmlzQ0RBVEEoa2V5KSkgewogICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKTsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBYXJyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IGFyckxlbiA9IGpPYmpba2V5XS5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgYXJyTGVuOyBqKyspewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW0gPSBqT2JqW2tleV1bal07CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAidW5kZWZpbmVkIikgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKGl0ZW0gPT09IG51bGwpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBpdGVtID09PSAib2JqZWN0IikgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShpdGVtLCBrZXksIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5idWlsZFRleHROb2RlKGl0ZW0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAodGhpcy5vcHRpb25zLmF0dHJOb2RlTmFtZSAmJiBrZXkgPT09IHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IEtzID0gT2JqZWN0LmtleXMoak9ialtrZXldKTsKICAgICAgICAgICAgICAgIGNvbnN0IEwgPSBLcy5sZW5ndGg7CiAgICAgICAgICAgICAgICBmb3IobGV0IGogPSAwOyBqIDwgTDsgaisrKXsKICAgICAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIEtzW2pdICsgJz0iJyArIHRoaXMub3B0aW9ucy5hdHRyVmFsdWVQcm9jZXNzb3IoIiIgKyBqT2JqW2tleV1bS3Nbal1dKSArICciJzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnByb2Nlc3NUZXh0T3JPYmpOb2RlKGpPYmpba2V5XSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gewogICAgICAgIGF0dHJTdHIsCiAgICAgICAgdmFsCiAgICB9Owp9OwpmdW5jdGlvbiBwcm9jZXNzVGV4dE9yT2JqTm9kZShvYmplY3QsIGtleSwgbGV2ZWwpIHsKICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuajJ4KG9iamVjdCwgbGV2ZWwgKyAxKTsKICAgIGlmIChvYmplY3RbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0gIT09IHZvaWQgMCAmJiBPYmplY3Qua2V5cyhvYmplY3QpLmxlbmd0aCA9PT0gMSkgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkVGV4dE5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iak5vZGUocmVzdWx0LnZhbCwga2V5LCByZXN1bHQuYXR0clN0ciwgbGV2ZWwpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQXN0cihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXIpOwogICAgfQp9CmZ1bmN0aW9uIHJlcGxhY2VDREFUQWFycihzdHIsIGNkYXRhKSB7CiAgICBzdHIgPSB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IoIiIgKyBzdHIpOwogICAgaWYgKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciA9PT0gIiIgfHwgc3RyID09PSAiIikgewogICAgICAgIHJldHVybiBzdHIgKyAiPCFbQ0RBVEFbIiArIGNkYXRhLmpvaW4oIl1dPjwhW0NEQVRBWyIpICsgIl1dIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgZm9yKGxldCB2IGluIGNkYXRhKXsKICAgICAgICAgICAgc3RyID0gc3RyLnJlcGxhY2UodGhpcy5vcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyLCAiPCFbQ0RBVEFbIiArIGNkYXRhW3ZdICsgIl1dPiIpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3RyICsgdGhpcy5uZXdMaW5lOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmIChhdHRyU3RyICYmIHZhbC5pbmRleE9mKCI8IikgPT09IC0xKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB2YWwgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArIHRoaXMudGFnRW5kQ2hhciArIHZhbCArIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eU9iak5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAodmFsICE9PSAiIikgewogICAgICAgIHJldHVybiB0aGlzLmJ1aWxkT2JqZWN0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBidWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiPiIgKyB0aGlzLm9wdGlvbnMudGFnVmFsdWVQcm9jZXNzb3IodmFsKSArICI8LyIgKyBrZXkgKyB0aGlzLnRhZ0VuZENoYXI7Cn0KZnVuY3Rpb24gYnVpbGRFbXB0eVRleHROb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHRWYWxOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIi8iICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGluZGVudGF0ZShsZXZlbCkgewogICAgcmV0dXJuIHRoaXMub3B0aW9ucy5pbmRlbnRCeS5yZXBlYXQobGV2ZWwpOwp9CmZ1bmN0aW9uIGlzQXR0cmlidXRlKG5hbWUpIHsKICAgIGlmIChuYW1lLnN0YXJ0c1dpdGgodGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgpKSB7CiAgICAgICAgcmV0dXJuIG5hbWUuc3Vic3RyKHRoaXMuYXR0clByZWZpeExlbik7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBmYWxzZTsKICAgIH0KfQpmdW5jdGlvbiBpc0NEQVRBKG5hbWUpIHsKICAgIHJldHVybiBuYW1lID09PSB0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lOwp9CnZhciBqc29uMnhtbCA9IFBhcnNlcjsKdmFyIHBhcnNlciA9IGNyZWF0ZUNvbW1vbmpzTW9kdWxlKGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewogICAgY29uc3QgeDJ4bWxub2RlID0geG1sc3RyMnhtbG5vZGU7CiAgICBjb25zdCBidWlsZE9wdGlvbnMyID0gdXRpbC5idWlsZE9wdGlvbnM7CiAgICBleHBvcnRzLnBhcnNlID0gZnVuY3Rpb24oeG1sRGF0YSwgZ2l2ZW5PcHRpb25zID0gewogICAgfSwgdmFsaWRhdGlvbk9wdGlvbikgewogICAgICAgIGlmICh2YWxpZGF0aW9uT3B0aW9uKSB7CiAgICAgICAgICAgIGlmICh2YWxpZGF0aW9uT3B0aW9uID09PSB0cnVlKSB2YWxpZGF0aW9uT3B0aW9uID0gewogICAgICAgICAgICB9OwogICAgICAgICAgICBjb25zdCByZXN1bHQgPSB2YWxpZGF0b3IudmFsaWRhdGUoeG1sRGF0YSwgdmFsaWRhdGlvbk9wdGlvbik7CiAgICAgICAgICAgIGlmIChyZXN1bHQgIT09IHRydWUpIHsKICAgICAgICAgICAgICAgIHRocm93IEVycm9yKHJlc3VsdC5lcnIubXNnKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoZ2l2ZW5PcHRpb25zLnBhcnNlVHJ1ZU51bWJlck9ubHkgJiYgZ2l2ZW5PcHRpb25zLnBhcnNlTm9kZVZhbHVlICE9PSBmYWxzZSAmJiAhZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucykgewogICAgICAgICAgICBnaXZlbk9wdGlvbnMubnVtUGFyc2VPcHRpb25zID0gewogICAgICAgICAgICAgICAgbGVhZGluZ1plcm9zOiBmYWxzZQogICAgICAgICAgICB9OwogICAgICAgIH0KICAgICAgICBsZXQgb3B0aW9ucyA9IGJ1aWxkT3B0aW9uczIoZ2l2ZW5PcHRpb25zLCB4MnhtbG5vZGUuZGVmYXVsdE9wdGlvbnMsIHgyeG1sbm9kZS5wcm9wcyk7CiAgICAgICAgY29uc3QgdHJhdmVyc2FibGVPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyk7CiAgICAgICAgcmV0dXJuIG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uKHRyYXZlcnNhYmxlT2JqLCBvcHRpb25zKTsKICAgIH07CiAgICBleHBvcnRzLmNvbnZlcnRUb25pbW4gPSBuaW1uZGF0YS5jb252ZXJ0Mm5pbW47CiAgICBleHBvcnRzLmdldFRyYXZlcnNhbE9iaiA9IHhtbHN0cjJ4bWxub2RlLmdldFRyYXZlcnNhbE9iajsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvbiA9IG5vZGUyanNvbi5jb252ZXJ0VG9Kc29uOwogICAgZXhwb3J0cy5jb252ZXJ0VG9Kc29uU3RyaW5nID0gbm9kZTJqc29uX3N0ci5jb252ZXJ0VG9Kc29uU3RyaW5nOwogICAgZXhwb3J0cy52YWxpZGF0ZSA9IHZhbGlkYXRvci52YWxpZGF0ZTsKICAgIGV4cG9ydHMuajJ4UGFyc2VyID0ganNvbjJ4bWw7CiAgICBleHBvcnRzLnBhcnNlVG9OaW1uID0gZnVuY3Rpb24oeG1sRGF0YSwgc2NoZW1hLCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIGV4cG9ydHMuY29udmVydFRvbmltbihleHBvcnRzLmdldFRyYXZlcnNhbE9iaih4bWxEYXRhLCBvcHRpb25zKSwgc2NoZW1hLCBvcHRpb25zKTsKICAgIH07Cn0pOwpwYXJzZXIuY29udmVydFRvSnNvbjsKcGFyc2VyLmNvbnZlcnRUb0pzb25TdHJpbmc7CnBhcnNlci5jb252ZXJ0VG9uaW1uOwp2YXIgZ2V0VHJhdmVyc2FsT2JqJDEgPSBwYXJzZXIuZ2V0VHJhdmVyc2FsT2JqOwpwYXJzZXIuajJ4UGFyc2VyOwpwYXJzZXIucGFyc2U7CnBhcnNlci5wYXJzZVRvTmltbjsKcGFyc2VyLnZhbGlkYXRlOwpmdW5jdGlvbiBjaGVja01hdGNoZXMobmFtZSwgdmFsdWUsIHBhdHRlcm4pIHsKICAgIGlmICghcGF0dGVybi50ZXN0KHZhbHVlKSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKICAgIHJldHVybiB2YWx1ZTsKfQpmdW5jdGlvbiBjaGVja01hdGNoZXNSZXR1cm5NYXRjaGVyKG5hbWUsIHZhbHVlLCBwYXR0ZXJuKSB7CiAgICBjb25zdCBtID0gcGF0dGVybi5leGVjKHZhbHVlKTsKICAgIGlmICghbSkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKICAgIHJldHVybiBtOwp9CmZ1bmN0aW9uIGNoZWNrRXF1YWwobmFtZSwgdmFsdWUsIGV4cGVjdGVkKSB7CiAgICBpZiAodmFsdWUgIT09IGV4cGVjdGVkKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfSwgZXhwZWN0ZWQgJHtleHBlY3RlZH1gKTsKfQpmdW5jdGlvbiBjaGVja1RydWUobmFtZSwgdmFsdWUsIHRlc3QpIHsKICAgIGlmICghdGVzdCkgdGhyb3cgbmV3IEVycm9yKGBCYWQgJHtuYW1lfTogJHt2YWx1ZX1gKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRzRm9yVXJsKHVybCwgb3B0cykgewogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBhd2FpdCBmZXRjaENvbW1lbnRzRm9yVXJsXyh1cmwsIG9wdHMpOwogICAgaWYgKCFyb290Q29tbWVudCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IGNvbW1lbnRlcnMgPSBhd2FpdCBjb2xsZWN0Q29tbWVudGVycyhyb290Q29tbWVudCwgb3B0cyk7CiAgICByZXR1cm4gewogICAgICAgIHJvb3RDb21tZW50LAogICAgICAgIGNvbW1lbnRlcnMKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50c0ZvclVybF8odXJsLCBvcHRzKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3Qgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgaWYgKCFvYmopIHJldHVybiB1bmRlZmluZWQ7CiAgICBjb25zdCBub3RlID0gb2JqOwogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsobm90ZSk7CiAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMobm90ZSwgcm9vdENvbW1lbnQsIG9wdHMpOwogICAgcmV0dXJuIHJvb3RDb21tZW50Owp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RDb21tZW50cyhub3RlLCBjb21tZW50LCBvcHRzKSB7CiAgICBjb25zdCB7IGtlZXBHb2luZyAsIGZldGNoQWN0aXZpdHlQdWIgIH0gPSBvcHRzOwogICAgY29uc3QgZmV0Y2hlZCA9IG5ldyBTZXQoKTsKICAgIGlmIChub3RlLnJlcGxpZXMpIHsKICAgICAgICBpZiAobm90ZS5yZXBsaWVzLmZpcnN0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2Ygbm90ZS5yZXBsaWVzLmZpcnN0ID09PSAnb2JqZWN0JyAmJiBub3RlLnJlcGxpZXMuZmlyc3QudHlwZSA9PT0gJ0NvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICAgICAgaWYgKG5vdGUucmVwbGllcy5maXJzdC5pdGVtcyAmJiBub3RlLnJlcGxpZXMuZmlyc3QuaXRlbXMubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhub3RlLnJlcGxpZXMuZmlyc3QuaXRlbXMsIGNvbW1lbnQsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub3RlLnJlcGxpZXMuZmlyc3QubmV4dCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygbm90ZS5yZXBsaWVzLmZpcnN0Lm5leHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHVybCA9IG5vdGUucmVwbGllcy5maXJzdC5uZXh0OwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBrZWVwQ29sbGVjdGluZyA9IHRydWU7CiAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlKGtlZXBDb2xsZWN0aW5nKXsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBhZ2UgPSBvYmo7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAocGFnZS5pdGVtcykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLml0ZW1zLCBjb21tZW50LCBvcHRzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoKHBhZ2UuaXRlbXM/Lmxlbmd0aCB8fCAwKSA9PT0gMCkga2VlcENvbGxlY3RpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChwYWdlLm5leHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHBhZ2UubmV4dCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGZldGNoZWQuaGFzKHBhZ2UubmV4dCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtlZXBDb2xsZWN0aW5nID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmogPSBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHBhZ2UubmV4dCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBwYWdlLm5leHQgbm90IGltcGxlbWVudGVkICR7cGFnZS5uZXh0fWApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2VlcENvbGxlY3RpbmcgPSBmYWxzZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3QubmV4dCBub3QgaW1wbGVtZW50ZWQgJHtub3RlLnJlcGxpZXMuZmlyc3QubmV4dH1gKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0IHR5cGUgbm90IGltcGxlbWVudGVkICR7bm90ZS5yZXBsaWVzLmZpcnN0fWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBmaXJzdCBub3QgZm91bmQsIGltcGxlbWVudCBpdGVtc2ApOwogICAgICAgIH0KICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0SXRlbXMoaXRlbXMsIGNvbW1lbnQsIG9wdHMpIHsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBpdGVtcyl7CiAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykgewogICAgICAgICAgICBjb25zdCByZXBseSA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmxfKGl0ZW0sIG9wdHMpOwogICAgICAgICAgICBpZiAocmVwbHkpIHsKICAgICAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IHJlcGx5ID0gaW5pdENvbW1lbnRGcm9tT2JqZWN0T3JMaW5rKGl0ZW0pOwogICAgICAgICAgICBjb21tZW50LnJlcGxpZXMucHVzaChyZXBseSk7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RDb21tZW50cyhpdGVtLCByZXBseSwgb3B0cyk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhvYmplY3QpIHsKICAgIGlmIChvYmplY3QudHlwZSAhPT0gJ05vdGUnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGl0ZW0gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gLCBjb250ZW50ICB9ID0gb2JqZWN0OwogICAgaWYgKHR5cGVvZiBhdHRyaWJ1dGVkVG8gIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke29iamVjdH1gKTsKICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke29iamVjdH1gKTsKICAgIHJldHVybiB7CiAgICAgICAgYXR0cmlidXRlZFRvLAogICAgICAgIGNvbnRlbnQsCiAgICAgICAgcmVwbGllczogW10KICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gY29sbGVjdENvbW1lbnRlcnMoY29tbWVudCwgb3B0cykgewogICAgY29uc3QgYXR0cmlidXRlZFRvcyA9IG5ldyBTZXQoKTsKICAgIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKGNvbW1lbnQsIGF0dHJpYnV0ZWRUb3MpOwogICAgY29uc3QgcnQgPSBuZXcgTWFwKCk7CiAgICBmb3IgKGNvbnN0IGF0dHJpYnV0ZWRUbyBvZiBhdHRyaWJ1dGVkVG9zKXsKICAgICAgICBjb25zdCBjb21tZW50ZXIgPSBhd2FpdCBmZXRjaENvbW1lbnRlcihhdHRyaWJ1dGVkVG8sIG9wdHMpOwogICAgICAgIHJ0LnNldChhdHRyaWJ1dGVkVG8sIGNvbW1lbnRlcik7CiAgICB9CiAgICByZXR1cm4gcnQ7Cn0KYXN5bmMgZnVuY3Rpb24gZmV0Y2hDb21tZW50ZXIodXJsLCBvcHRzKSB7CiAgICBjb25zdCBvYmogPSBhd2FpdCBvcHRzLmZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgIGNvbnN0IHBlcnNvbiA9IG9iajsKICAgIHJldHVybiBjb21wdXRlQ29tbWVudGVyKHBlcnNvbik7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pIHsKICAgIGlmICh0eXBlb2YgcGVyc29uLmljb24gIT09ICdvYmplY3QnIHx8IGlzUmVhZG9ubHlBcnJheShwZXJzb24uaWNvbikgfHwgcGVyc29uLmljb24udHlwZSAhPT0gJ0ltYWdlJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5pY29uIG5vdCBpbXBsZW1lbnRlZDogJHtwZXJzb24uaWNvbn1gKTsKICAgIGNvbnN0IGljb24gPSBjb21wdXRlSWNvbihwZXJzb24uaWNvbik7CiAgICBjb25zdCB7IG5hbWUgLCB1cmwgIH0gPSBwZXJzb247CiAgICBpZiAodHlwZW9mIG5hbWUgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLm5hbWUgbm90IGltcGxlbWVudGVkOiAke25hbWV9YCk7CiAgICBpZiAodHlwZW9mIHVybCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBwZXJzb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBjb25zdCBmcVVzZXJuYW1lID0gY29tcHV0ZUZxVXNlcm5hbWUodXJsKTsKICAgIHJldHVybiB7CiAgICAgICAgaWNvbiwKICAgICAgICBuYW1lLAogICAgICAgIHVybCwKICAgICAgICBmcVVzZXJuYW1lCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGljb24pIHsKICAgIGNvbnN0IHsgdXJsICwgbWVkaWFUeXBlICB9ID0gaWNvbjsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIGljb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBpZiAodHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBpY29uLm1lZGlhVHlwZSBub3QgaW1wbGVtZW50ZWQ6ICR7bWVkaWFUeXBlfWApOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWVkaWFUeXBlCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVGcVVzZXJuYW1lKHVybCkgewogICAgY29uc3QgdSA9IG5ldyBVUkwodXJsKTsKICAgIGNvbnN0IG0gPSBjaGVja01hdGNoZXNSZXR1cm5NYXRjaGVyKCd1cmwucGF0aG5hbWUnLCB1LnBhdGhuYW1lLCAvXlwvKEBbXlwvXSspJC8pOwogICAgcmV0dXJuIGAke21bMV19QCR7dS5ob3N0bmFtZX1gOwp9CmZ1bmN0aW9uIGNvbGxlY3RBdHRyaWJ1dGVkVG9zKGNvbW1lbnQsIGF0dHJpYnV0ZWRUb3MpIHsKICAgIGF0dHJpYnV0ZWRUb3MuYWRkKGNvbW1lbnQuYXR0cmlidXRlZFRvKTsKICAgIGZvciAoY29uc3QgcmVwbHkgb2YgY29tbWVudC5yZXBsaWVzKXsKICAgICAgICBjb2xsZWN0QXR0cmlidXRlZFRvcyhyZXBseSwgYXR0cmlidXRlZFRvcyk7CiAgICB9Cn0KZnVuY3Rpb24gaXNSZWFkb25seUFycmF5KGFyZykgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJnKTsKfQpmdW5jdGlvbiBwYXJzZUZlZWRYbWwoeG1sKSB7CiAgICByZXR1cm4gZ2V0VHJhdmVyc2FsT2JqJDEoeG1sLCB7CiAgICAgICAgaWdub3JlQXR0cmlidXRlczogZmFsc2UKICAgIH0pOwp9CmZ1bmN0aW9uIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcykgewogICAgaWYgKHhtbC50YWduYW1lICE9PSAnIXhtbCcpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBCYWQgeG1sLnRhZ25hbWU6ICR7eG1sLnRhZ25hbWV9YCk7CiAgICBpZiAoT2JqZWN0LmtleXMoeG1sLmF0dHJzTWFwKS5sZW5ndGggPiAwKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC5hdHRyc01hcDogJHt4bWwuYXR0cnNNYXB9YCk7CiAgICBjb25zdCBuYW1lc3BhY2VzID0gbmV3IFhtbE5hbWVzcGFjZXMoKTsKICAgIGNvbnN0IHJzcyA9IGdldFNpbmdsZUNoaWxkKHhtbCwgJ3JzcycsIGNhbGxiYWNrcyk7CiAgICBpZiAoIXJzcykgcmV0dXJuOwogICAgdmFsaWRhdGVSc3MocnNzLCBjYWxsYmFja3MsIG5hbWVzcGFjZXMpOwogICAgY2hlY2tFcXVhbCgnbmFtZXNwYWNlcy5zdGFja1NpemUnLCBuYW1lc3BhY2VzLnN0YWNrU2l6ZSwgMCk7Cn0KZnVuY3Rpb24gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCkgewogICAgbGV0IG1hcDsKICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhhdHRyc01hcCkpewogICAgICAgIGlmICghbmFtZS5zdGFydHNXaXRoKCdAXycpKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCBhdHRyc01hcCBuYW1lOiAke25hbWV9LCAke2F0dHJzTWFwfWApOwogICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgbWFwLnNldChuYW1lLnN1YnN0cmluZygyKSwgdmFsdWUpOwogICAgfQogICAgcmV0dXJuIG1hcCB8fCBFTVBUWV9NQVA7Cn0KY29uc3QgRU1QVFlfTUFQID0gbmV3IE1hcCgpOwpjb25zdCBFTVBUWV9YTUxfTk9ERV9BUlJBWSA9IFtdOwpmdW5jdGlvbiBnZXRTaW5nbGVDaGlsZChub2RlLCB0YWdOYW1lLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IGNoaWxkcmVuID0gbm9kZS5jaGlsZFt0YWdOYW1lXSB8fCBbXTsKICAgIGlmIChjaGlsZHJlbi5sZW5ndGggIT09IDEpIHsKICAgICAgICBjYWxsYmFja3Mub25FcnJvcihub2RlLCBgRXhwZWN0ZWQgc2luZ2xlICR7dGFnTmFtZX0gY2hpbGQgZWxlbWVudCB1bmRlciAke25vZGUudGFnbmFtZX0sIGZvdW5kICR7Y2hpbGRyZW4ubGVuZ3RofWApOwogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9CiAgICByZXR1cm4gY2hpbGRyZW5bMF07Cn0KZnVuY3Rpb24gdmFsaWRhdGVSc3MocnNzLCBjYWxsYmFja3MsIG5hbWVzcGFjZXMpIHsKICAgIGNvbnN0IGF0dHJzID0gbmFtZXNwYWNlcy5wdXNoKHJzcy5hdHRyc01hcCk7CiAgICB0cnkgewogICAgICAgIGlmIChyc3MudGFnbmFtZSAhPT0gJ3JzcycpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcihyc3MsIGBCYWQgcnNzLnRhZ25hbWU6ICR7cnNzLnRhZ25hbWV9YCk7CiAgICAgICAgY29uc3QgdmVyc2lvbiA9IGF0dHJzLmdldCgndmVyc2lvbicpOwogICAgICAgIGlmICh2ZXJzaW9uICE9PSAnMi4wJykgY2FsbGJhY2tzLm9uV2FybmluZyhyc3MsIGBCYWQgcnNzLnZlcnNpb246ICR7dmVyc2lvbn0sIGV4cGVjdGVkIDIuMGApOwogICAgICAgIGNvbnN0IGNoYW5uZWwgPSBnZXRTaW5nbGVDaGlsZChyc3MsICdjaGFubmVsJywgY2FsbGJhY2tzKTsKICAgICAgICBpZiAoIWNoYW5uZWwpIHJldHVybjsKICAgICAgICB2YWxpZGF0ZUNoYW5uZWwoY2hhbm5lbCwgY2FsbGJhY2tzLCBuYW1lc3BhY2VzKTsKICAgIH0gZmluYWxseXsKICAgICAgICBuYW1lc3BhY2VzLnBvcCgpOwogICAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlQ2hhbm5lbChjaGFubmVsLCBjYWxsYmFja3MsIG5hbWVzcGFjZXMpIHsKICAgIG5hbWVzcGFjZXMucHVzaChjaGFubmVsLmF0dHJzTWFwKTsKICAgIHRyeSB7CiAgICAgICAgaWYgKGNoYW5uZWwudGFnbmFtZSAhPT0gJ2NoYW5uZWwnKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoY2hhbm5lbCwgYEJhZCBjaGFubmVsLnRhZ25hbWU6ICR7Y2hhbm5lbC50YWduYW1lfWApOwogICAgICAgIGZvciAoY29uc3QgaXRlbSBvZiBjaGFubmVsLmNoaWxkLml0ZW0gfHwgW10pewogICAgICAgICAgICB2YWxpZGF0ZUl0ZW0oaXRlbSwgY2FsbGJhY2tzLCBuYW1lc3BhY2VzKTsKICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgfQogICAgfSBmaW5hbGx5ewogICAgICAgIG5hbWVzcGFjZXMucG9wKCk7CiAgICB9Cn0KZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcywgbmFtZXNwYWNlcykgewogICAgbmFtZXNwYWNlcy5wdXNoKGl0ZW0uYXR0cnNNYXApOwogICAgdHJ5IHsKICAgICAgICBjb25zdCBzb2NpYWxJbnRlcmFjdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCBuYW1lc3BhY2VzLCB7CiAgICAgICAgICAgIG5hbWU6ICdzb2NpYWxJbnRlcmFjdCcsCiAgICAgICAgICAgIG5hbWVzcGFjZVVyaTogJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCcKICAgICAgICB9KTsKICAgICAgICBmb3IgKGNvbnN0IHNvY2lhbEludGVyYWN0IG9mIHNvY2lhbEludGVyYWN0cyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbkluZm8oc29jaWFsSW50ZXJhY3QsICdGb3VuZCBzb2NpYWxJbnRlcmFjdCEnKTsKICAgICAgICB9CiAgICB9IGZpbmFsbHl7CiAgICAgICAgbmFtZXNwYWNlcy5wb3AoKTsKICAgIH0KfQpmdW5jdGlvbiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCBuYW1lc3BhY2VzLCBxbmFtZSkgewogICAgbGV0IHJ0OwogICAgZm9yIChjb25zdCBbbmFtZSwgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG5vZGUuY2hpbGQpKXsKICAgICAgICBjb25zdCBjaGlsZFFuYW1lID0gY29tcHV0ZVFuYW1lKG5hbWUsIG5hbWVzcGFjZXMpOwogICAgICAgIGlmIChjaGlsZFFuYW1lLm5hbWUgPT09IHFuYW1lLm5hbWUgJiYgY2hpbGRRbmFtZS5uYW1lc3BhY2VVcmkgPT09IHFuYW1lLm5hbWVzcGFjZVVyaSkgewogICAgICAgICAgICBydCA9IHJ0IHx8IFtdOwogICAgICAgICAgICBydC5wdXNoKC4uLnZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gcnQgfHwgRU1QVFlfWE1MX05PREVfQVJSQVk7Cn0KZnVuY3Rpb24gY29tcHV0ZVFuYW1lKG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsIG5hbWVzcGFjZXMpIHsKICAgIGNvbnN0IGkgPSBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5maW5kTmFtZXNwYWNlVXJpKCcnKQogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoaSArIDEpLAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5nZXROYW1lc3BhY2VVcmkobmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoMCwgaSkpCiAgICB9Owp9CmNsYXNzIFhtbE5hbWVzcGFjZXMgewogICAgc3RhY2sgPSBbXTsKICAgIGdldCBzdGFja1NpemUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2subGVuZ3RoOwogICAgfQogICAgcHVzaChhdHRyc01hcCkgewogICAgICAgIGNvbnN0IGF0dHJzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCk7CiAgICAgICAgbGV0IG1hcDsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgYXR0cnMuZW50cmllcygpKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICd4bWxucycpIHsKICAgICAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICBtYXAuc2V0KCcnLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5zdGFydHNXaXRoKCd4bWxuczonKSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWUuc3Vic3RyaW5nKDYpOwogICAgICAgICAgICAgICAgbWFwLnNldChwcmVmaXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnN0YWNrLnB1c2gobWFwIHx8IEVNUFRZX01BUCk7CiAgICAgICAgcmV0dXJuIGF0dHJzOwogICAgfQogICAgcG9wKCkgewogICAgICAgIHRoaXMuc3RhY2sucG9wKCk7CiAgICB9CiAgICBmaW5kTmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgZ2V0TmFtZXNwYWNlVXJpKHByZWZpeCkgewogICAgICAgIGZvcihsZXQgaSA9IHRoaXMuc3RhY2subGVuZ3RoIC0gMTsgaSA+PSAwOyBpLS0pewogICAgICAgICAgICBjb25zdCBydCA9IHRoaXMuc3RhY2tbaV0uZ2V0KHByZWZpeCk7CiAgICAgICAgICAgIGlmIChydCkgcmV0dXJuIHJ0OwogICAgICAgIH0KICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGdldE5hbWVzcGFjZVVyaTogcHJlZml4IG5vdCBmb3VuZDogJHtwcmVmaXh9YCk7CiAgICB9Cn0KY2xhc3MgVmFsaWRhdG9yQXBwVk0gewogICAgX3ZhbGlkYXRpbmcgPSBmYWxzZTsKICAgIGdldCB2YWxpZGF0aW5nKCkgewogICAgICAgIHJldHVybiB0aGlzLl92YWxpZGF0aW5nOwogICAgfQogICAgX3N0YXR1cyA9ICcnOwogICAgZ2V0IHN0YXR1cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5fc3RhdHVzOwogICAgfQogICAgX21lc3NhZ2VzID0gW107CiAgICBnZXQgbWVzc2FnZXMoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX21lc3NhZ2VzOwogICAgfQogICAgX3htbDsKICAgIGdldCB4bWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3htbDsKICAgIH0KICAgIF9mZXRjaENvbW1lbnRzUmVzdWx0OwogICAgZ2V0IGZldGNoQ29tbWVudHNSZXN1bHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2ZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICB9CiAgICBvbkNoYW5nZSA9ICgpPT57CiAgICB9OwogICAgc3RhcnQoKSB7CiAgICB9CiAgICB2YWxpZGF0ZUZlZWQoZmVlZFVybFN0cikgewogICAgICAgIGZlZWRVcmxTdHIgPSBmZWVkVXJsU3RyLnRyaW0oKTsKICAgICAgICB0aGlzLl9zdGF0dXMgPSAnVmFsaWRhdGluZyAnICsgZmVlZFVybFN0cjsKICAgICAgICB0aGlzLl9tZXNzYWdlcy5zcGxpY2UoMCk7CiAgICAgICAgdGhpcy5feG1sID0gdW5kZWZpbmVkOwogICAgICAgIHRoaXMuX3ZhbGlkYXRpbmcgPSB0cnVlOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0aGlzLnZhbGlkYXRlRmVlZEFzeW5jKGZlZWRVcmxTdHIpLmNhdGNoKChlKT0+ewogICAgICAgICAgICB0aGlzLl9tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcicsCiAgICAgICAgICAgICAgICB0ZXh0OiBlLm1lc3NhZ2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMuX3ZhbGlkYXRpbmcgPSBmYWxzZTsKICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgIH0pOwogICAgfQogICAgY2FuY2VsVmFsaWRhdGlvbigpIHsKICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRpbmcpIHJldHVybjsKICAgICAgICB0aGlzLl92YWxpZGF0aW5nID0gZmFsc2U7CiAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgfQogICAgYXN5bmMgdmFsaWRhdGVGZWVkQXN5bmMoZmVlZFVybFN0cikgewogICAgICAgIGNvbnN0IGFjdGl2aXR5UHViUm9vdENvbW1lbnROb2RlVXJscyA9IFtdOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGlmIChmZWVkVXJsU3RyID09PSAnJykgdGhyb3cgbmV3IEVycm9yKGBCYWQgdXJsOiA8Ymxhbms+YCk7CiAgICAgICAgICAgIGNvbnN0IGZlZWRVcmwgPSB0cnlQYXJzZVVybChmZWVkVXJsU3RyKTsKICAgICAgICAgICAgaWYgKCFmZWVkVXJsKSB0aHJvdyBuZXcgRXJyb3IoYEJhZCB1cmw6ICR7ZmVlZFVybFN0cn1gKTsKICAgICAgICAgICAgY2hlY2tNYXRjaGVzKCdmZWVkVXJsLnByb3RvY29sJywgZmVlZFVybC5wcm90b2NvbCwgL15odHRwcz86JC8pOwogICAgICAgICAgICBmZWVkVXJsLnNlYXJjaFBhcmFtcy5zZXQoJ190JywgRGF0ZS5ub3coKS50b1N0cmluZygpKTsKICAgICAgICAgICAgY29uc3QgaGVhZGVycyA9IHsKICAgICAgICAgICAgICAgICdBY2NlcHQtRW5jb2RpbmcnOiAnZ3ppcCcsCiAgICAgICAgICAgICAgICAnVXNlci1BZ2VudCc6IG5hdmlnYXRvci51c2VyQWdlbnQsCiAgICAgICAgICAgICAgICAnQ2FjaGUtQ29udHJvbCc6ICduby1zdG9yZScKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgLCBmZXRjaFRpbWUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2goZmVlZFVybC50b1N0cmluZygpLCB7CiAgICAgICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRpbmcpIHJldHVybjsKICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9tZXNzYWdlcy5wdXNoKHsKICAgICAgICAgICAgICAgICAgICB0eXBlOiAnd2FybmluZycsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogYExvY2FsIGZlZWQgZmV0Y2ggZmFpbGVkOiBDT1JTIGlzc3VlP2AKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGNoZWNrRXF1YWwoJ3Jlc3BvbnNlLnN0YXR1cycsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgICAgICAgICAgdGhpcy5fbWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAnaW5mbycsCiAgICAgICAgICAgICAgICB0ZXh0OiBgUmVzcG9uc2Ugc3RhdHVzPSR7cmVzcG9uc2Uuc3RhdHVzfSwgY29udGVudC10eXBlPSR7cmVzcG9uc2UuaGVhZGVycy5nZXQoJ0NvbnRlbnQtVHlwZScpfSwgY29udGVudC1sZW5ndGg9JHtyZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1MZW5ndGgnKX1gCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICBjb25zdCB0ZXh0ID0gYXdhaXQgcmVzcG9uc2UudGV4dCgpOwogICAgICAgICAgICBpZiAoIXRoaXMuX3ZhbGlkYXRpbmcpIHJldHVybjsKICAgICAgICAgICAgY29uc3QgcmVhZFRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgbGV0IHBhcnNlVGltZSA9IDA7CiAgICAgICAgICAgIGxldCB4bWw7CiAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICB4bWwgPSBwYXJzZUZlZWRYbWwodGV4dCk7CiAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgICAgIHR5cGU6ICdlcnJvcicsCiAgICAgICAgICAgICAgICAgICAgdGV4dDogYFhtbCBwYXJzZSBmYWlsZWQ6ICR7ZS5tZXNzYWdlfWAKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgICAgICBwYXJzZVRpbWUgPSBEYXRlLm5vdygpIC0gc3RhcnQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5feG1sID0geG1sOwogICAgICAgICAgICBjb25zb2xlLmxvZyh4bWwpOwogICAgICAgICAgICBsZXQgdmFsaWRhdGVUaW1lOwogICAgICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICAgICAgICBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgICAgICBjb25zdCBjYWxsYmFja3MgPSB7CiAgICAgICAgICAgICAgICAgICAgb25FcnJvcjogKF8sIG1lc3NhZ2UpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2Vycm9yJywKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IG1lc3NhZ2UKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBvbldhcm5pbmc6IChfLCBtZXNzYWdlKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4obWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogJ3dhcm5pbmcnLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGV4dDogbWVzc2FnZQogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIG9uSW5mbzogKG5vZGUsIG1lc3NhZ2UpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhtZXNzYWdlKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fbWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnaW5mbycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0ZXh0OiBtZXNzYWdlCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWVzc2FnZS5pbmNsdWRlcygnc29jaWFsSW50ZXJhY3QnKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG5vZGUudmFsICYmIG5vZGUudmFsICE9PSAnJyAmJiBjb21wdXRlQXR0cmlidXRlTWFwKG5vZGUuYXR0cnNNYXApLmdldCgncGxhdGZvcm0nKSA9PT0gJ2FjdGl2aXR5cHViJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViUm9vdENvbW1lbnROb2RlVXJscy5wdXNoKG5vZGUudmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB2YWxpZGF0ZUZlZWRYbWwoeG1sLCBjYWxsYmFja3MpOwogICAgICAgICAgICAgICAgdmFsaWRhdGVUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgdHlwZTogJ2luZm8nLAogICAgICAgICAgICAgICAgdGV4dDogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgICAgIGZldGNoVGltZSwKICAgICAgICAgICAgICAgICAgICByZWFkVGltZSwKICAgICAgICAgICAgICAgICAgICBwYXJzZVRpbWUsCiAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVUaW1lLAogICAgICAgICAgICAgICAgICAgIHRleHRMZW5ndGg6IHRleHQubGVuZ3RoCiAgICAgICAgICAgICAgICB9KQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgaWYgKGFjdGl2aXR5UHViUm9vdENvbW1lbnROb2RlVXJscy5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICBmb3IgKGNvbnN0IGFjdGl2aXR5UHViUm9vdENvbW1lbnROb2RlVXJsIG9mIGFjdGl2aXR5UHViUm9vdENvbW1lbnROb2RlVXJscyl7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fc3RhdHVzID0gYFZhbGlkYXRpbmcgYWN0aXZpdHlQdWJSb290Q29tbWVudE5vZGVVcmw6ICR7YWN0aXZpdHlQdWJSb290Q29tbWVudE5vZGVVcmx9YDsKICAgICAgICAgICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2VlcEdvaW5nID0gKCk9PnRoaXMuX3ZhbGlkYXRpbmcKICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcmVtb3RlT25seU9yaWdpbnMgPSBuZXcgU2V0KCk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY29tcHV0ZVVzZVNpZGUgPSAodXJsKT0+cmVtb3RlT25seU9yaWdpbnMuaGFzKG5ldyBVUkwodXJsKS5vcmlnaW4pID8gJ3JlbW90ZScgOiB1bmRlZmluZWQKICAgICAgICAgICAgICAgICAgICA7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hBY3Rpdml0eVB1YiA9IGFzeW5jICh1cmwpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB7IG9iaiAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1cmwuaW5jbHVkZXMoJy9hcGkvdjEvc3RhdHVzZXMnKSAmJiB0eXBlb2Ygb2JqLnVyaSA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybCA9IG9iai51cmk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByZXMgPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2hGZXRjaEFjdGl2aXR5UHViKHVybCwgY29tcHV0ZVVzZVNpZGUodXJsKSwgMCk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm4gdW5kZWZpbmVkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgb2JqID0gcmVzLm9iajsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNpZGUgPSByZXMuc2lkZTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdyZW1vdGUnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvcmlnaW4gPSBuZXcgVVJMKHVybCkub3JpZ2luOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFyZW1vdGVPbmx5T3JpZ2lucy5oYXMob3JpZ2luKSkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX21lc3NhZ2VzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAnd2FybmluZycsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRleHQ6IGBMb2NhbCBBY3Rpdml0eVB1YiBmZXRjaCBmYWlsZWQgKENPUlMgaXNzdWU/KTogJHt1cmx9YAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZW1vdGVPbmx5T3JpZ2lucy5hZGQob3JpZ2luKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gb2JqOwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgY29uc3QgZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmwoYWN0aXZpdHlQdWJSb290Q29tbWVudE5vZGVVcmwsIHsKICAgICAgICAgICAgICAgICAgICAgICAga2VlcEdvaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBmZXRjaEFjdGl2aXR5UHViCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5fZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBjYXRjaCAoZTEpIHsKICAgICAgICAgICAgdGhpcy5fbWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAnZXJyb3InLAogICAgICAgICAgICAgICAgdGV4dDogZTEubWVzc2FnZQogICAgICAgICAgICB9KTsKICAgICAgICB9IGZpbmFsbHl7CiAgICAgICAgICAgIHRoaXMuX3N0YXR1cyA9ICcnOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsKHVybCkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IFVSTCh1cmwpOwogICAgfSBjYXRjaCAgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KZnVuY3Rpb24gc2xlZXAobXMpIHsKICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSk9PnNldFRpbWVvdXQocmVzb2x2ZSwgbXMpCiAgICApOwp9CmFzeW5jIGZ1bmN0aW9uIGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCB1c2VTaWRlLCBzbGVlcE1pbGxpc0JldHdlZW5DYWxscykgewogICAgaWYgKHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzID4gMCkgYXdhaXQgc2xlZXAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMpOwogICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCB7CiAgICAgICAgaGVhZGVyczogewogICAgICAgICAgICAnQWNjZXB0JzogJ2FwcGxpY2F0aW9uL2FjdGl2aXR5K2pzb24nCiAgICAgICAgfSwKICAgICAgICB1c2VTaWRlCiAgICB9KTsKICAgIGNoZWNrRXF1YWwoJ3Jlcy5zdGF0dXMnLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICBjb25zb2xlLmxvZyhbCiAgICAgICAgLi4ucmVzcG9uc2UuaGVhZGVycwogICAgXS5tYXAoKHYpPT52LmpvaW4oJzogJykKICAgICkpOwogICAgY29uc3QgY29udGVudFR5cGUgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnQ29udGVudC1UeXBlJyk7CiAgICBjaGVja1RydWUoJ3Jlcy5jb250ZW50VHlwZScsIGNvbnRlbnRUeXBlLCAoY29udGVudFR5cGUgfHwgJycpLmluY2x1ZGVzKCdqc29uJykpOwogICAgY29uc3Qgb2JqID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgcmV0dXJuIHsKICAgICAgICBvYmosCiAgICAgICAgc2lkZQogICAgfTsKfQphc3luYyBmdW5jdGlvbiBsb2NhbE9yUmVtb3RlRmV0Y2godXJsLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCB7IGhlYWRlcnMgLCB1c2VTaWRlICB9ID0gb3B0czsKICAgIGlmICh1c2VTaWRlICE9PSAncmVtb3RlJykgewogICAgICAgIHRyeSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKGBsb2NhbCBmZXRjaDogJHt1cmx9YCk7CiAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaCh1cmwsIHsKICAgICAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICBmZXRjaFRpbWU6IERhdGUubm93KCkgLSBzdGFydCwKICAgICAgICAgICAgICAgIHNpZGU6ICdsb2NhbCcsCiAgICAgICAgICAgICAgICByZXNwb25zZQogICAgICAgICAgICB9OwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5sb2coJ0ZhaWxlZCB0byBsb2NhbCBmZXRjaCwgdHJ5aW5nIHJlbW90ZScsIGUpOwogICAgICAgIH0KICAgIH0KICAgIGNvbnNvbGUubG9nKGByZW1vdGUgZmV0Y2g6ICR7dXJsfWApOwogICAgY29uc3Qgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgL2YvJHt1cmwucmVwbGFjZUFsbCgvW15hLXpBLVowLTkuXSsvZywgJ18nKX1gLCB7CiAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICB9KQogICAgfSk7CiAgICByZXR1cm4gewogICAgICAgIGZldGNoVGltZTogRGF0ZS5ub3coKSAtIHN0YXJ0LAogICAgICAgIHNpZGU6ICdyZW1vdGUnLAogICAgICAgIHJlc3BvbnNlCiAgICB9Owp9CmNvbnN0IENPTU1FTlRTX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJjb21tZW50cyI+PC9vdXRwdXQ+CmA7CmNvbnN0IENPTU1FTlRTX0NTUyA9IGNzc2AKCi5jb21tZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7Cn0KCi5jb21tZW50IC5pY29uIHsKICAgIHdpZHRoOiAzcmVtOwogICAgaGVpZ2h0OiAzcmVtOwogICAgYm9yZGVyLXJhZGl1czogMC41cmVtOwogICAgbWFyZ2luOiAxcmVtOwp9CgouY29tbWVudCAucmhzIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBmbGV4LWRpcmVjdGlvbjogY29sdW1uOwogICAgbWFyZ2luOiAxcmVtIDFyZW0gMCAwOwp9CgouY29tbWVudCAucmhzIHAgewogICAgbWFyZ2luLWJsb2NrLXN0YXJ0OiAwLjVyZW07CiAgICBtYXJnaW4tYmxvY2stZW5kOiAwLjVyZW07CiAgICBsaW5lLWhlaWdodDogMS40Owp9CgpgOwpmdW5jdGlvbiBpbml0Q29tbWVudHMoZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBjb21tZW50c091dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdjb21tZW50cycpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdm0uZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgICAgICBpZiAocmVzdWx0ICE9PSBfcmVuZGVyZWRSZXN1bHQpIHsKICAgICAgICAgICAgcmVuZGVyQ29tbWVudHMocmVzdWx0LCBjb21tZW50c091dHB1dCk7CiAgICAgICAgICAgIF9yZW5kZXJlZFJlc3VsdCA9IHJlc3VsdDsKICAgICAgICB9CiAgICB9Owp9CmxldCBfcmVuZGVyZWRSZXN1bHQ7CmZ1bmN0aW9uIHJlbmRlckNvbW1lbnRzKHJlc3VsdCwgY29tbWVudHNPdXRwdXQpIHsKICAgIHdoaWxlKGNvbW1lbnRzT3V0cHV0LmZpcnN0Q2hpbGQpY29tbWVudHNPdXRwdXQucmVtb3ZlQ2hpbGQoY29tbWVudHNPdXRwdXQuZmlyc3RDaGlsZCk7CiAgICBpZiAocmVzdWx0KSByZW5kZXJOb2RlKHJlc3VsdC5yb290Q29tbWVudCwgcmVzdWx0LmNvbW1lbnRlcnMsIGNvbW1lbnRzT3V0cHV0LCAwKTsKfQpmdW5jdGlvbiByZW5kZXJOb2RlKGNvbW1lbnQsIGNvbW1lbnRlcnMsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsKSB7CiAgICBjb25zdCBjb21tZW50ZXIgPSBjb21tZW50ZXJzLmdldChjb21tZW50LmF0dHJpYnV0ZWRUbyk7CiAgICBjb25zdCBjb21tZW50RGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICBjb21tZW50RGl2LmNsYXNzTGlzdC5hZGQoJ2NvbW1lbnQnKTsKICAgIGlmIChsZXZlbCA+IDApIGNvbW1lbnREaXYuc3R5bGUubWFyZ2luTGVmdCA9IGAke2xldmVsICogNH1yZW1gOwogICAgY29uc3QgaWNvbkltZyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2ltZycpOwogICAgaWNvbkltZy5jbGFzc0xpc3QuYWRkKCdpY29uJyk7CiAgICBpY29uSW1nLnNyYyA9IGNvbW1lbnRlciA/IGNvbW1lbnRlci5pY29uLnVybCA6ICcjJzsKICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQoaWNvbkltZyk7CiAgICBjb25zdCByaHNEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIHJoc0Rpdi5jbGFzc0xpc3QuYWRkKCdyaHMnKTsKICAgIGNvbnN0IGF0dHJpYnV0ZWRUb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgaWYgKGNvbW1lbnRlcikgewogICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYS5ocmVmID0gY29tbWVudGVyLnVybDsKICAgICAgICBhLnRhcmdldCA9ICdfYmxhbmsnOwogICAgICAgIGEudGV4dENvbnRlbnQgPSBjb21tZW50ZXIubmFtZSArICcgJyArIGNvbW1lbnRlci5mcVVzZXJuYW1lOwogICAgICAgIGF0dHJpYnV0ZWRUb0Rpdi5hcHBlbmRDaGlsZChhKTsKICAgIH0gZWxzZSB7CiAgICAgICAgYXR0cmlidXRlZFRvRGl2LmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKGNvbW1lbnQuYXR0cmlidXRlZFRvKSk7CiAgICB9CiAgICByaHNEaXYuYXBwZW5kQ2hpbGQoYXR0cmlidXRlZFRvRGl2KTsKICAgIGNvbnN0IGNvbnRlbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbnRlbnREaXYuaW5uZXJIVE1MID0gY29tbWVudC5jb250ZW50OwogICAgcmhzRGl2LmFwcGVuZENoaWxkKGNvbnRlbnREaXYpOwogICAgY29tbWVudERpdi5hcHBlbmRDaGlsZChyaHNEaXYpOwogICAgY29udGFpbmVyRWxlbWVudC5hcHBlbmRDaGlsZChjb21tZW50RGl2KTsKICAgIGZvciAoY29uc3QgcmVwbHkgb2YgY29tbWVudC5yZXBsaWVzKXsKICAgICAgICByZW5kZXJOb2RlKHJlcGx5LCBjb21tZW50ZXJzLCBjb250YWluZXJFbGVtZW50LCBsZXZlbCArIDEpOwogICAgfQp9CmNvbnN0IEZPUk1fSFRNTCA9IGh0bWxgCjxmb3JtIGlkPSJpbnB1dCI+CiAgICA8aW5wdXQgaWQ9ImZlZWQtdXJsIiB0eXBlPSJ0ZXh0IiBwbGFjZWhvbGRlcj0iRmVlZCB1cmwiIGF1dG9jb21wbGV0ZT0ib24iIHJlcXVpcmVkPgogICAgPGJ1dHRvbiBpZD0ic3VibWl0IiB0eXBlPSJzdWJtaXQiPlZhbGlkYXRlPC9idXR0b24+CjwvZm9ybT4KPG91dHB1dCBpZD0ic3RhdHVzIj48L291dHB1dD4KYDsKY29uc3QgRk9STV9DU1MgPSBjc3NgCgojaW5wdXQgewogICAgZGlzcGxheTogZmxleDsKfQoKI2ZlZWQtdXJsIHsKICAgIGZvbnQtc2l6ZTogMXJlbTsKICAgIHBhZGRpbmc6IDAuNXJlbTsKICAgIGZsZXgtZ3JvdzogMTsKfQoKI2lucHV0IGJ1dHRvbiB7CiAgICBwYWRkaW5nOiAwLjVyZW0gMXJlbTsKfQoKYDsKZnVuY3Rpb24gaW5pdEZvcm0oZG9jdW1lbnQsIHZtKSB7CiAgICBjb25zdCBpbnB1dEZvcm0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnaW5wdXQnKTsKICAgIGNvbnN0IGZlZWRVcmxJbnB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmZWVkLXVybCcpOwogICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Ym1pdCcpOwogICAgY29uc3Qgc3RhdHVzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXR1cycpOwogICAgaW5wdXRGb3JtLm9uc3VibWl0ID0gKGUpPT57CiAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgIGlmICh2bS52YWxpZGF0aW5nKSB7CiAgICAgICAgICAgIHZtLmNhbmNlbFZhbGlkYXRpb24oKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB2bS52YWxpZGF0ZUZlZWQoZmVlZFVybElucHV0LnZhbHVlKTsKICAgICAgICB9CiAgICB9OwogICAgZmVlZFVybElucHV0LmZvY3VzKCk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBzdGF0dXNPdXRwdXQudGV4dENvbnRlbnQgPSB2bS5zdGF0dXM7CiAgICAgICAgc3VibWl0QnV0dG9uLnRleHRDb250ZW50ID0gdm0udmFsaWRhdGluZyA/ICdDYW5jZWwnIDogJ1ZhbGlkYXRlJzsKICAgIH07Cn0KY29uc3QgTUVTU0FHRVNfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9Im1lc3NhZ2VzIj48L291dHB1dD4KYDsKY29uc3QgTUVTU0FHRVNfQ1NTID0gY3NzYAoKYDsKZnVuY3Rpb24gaW5pdE1lc3NhZ2VzKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgbWVzc2FnZXNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVzc2FnZXMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKE1FU1NBR0VfSFRNTCh2bSksIG1lc3NhZ2VzT3V0cHV0KTsKICAgIH07Cn0KY29uc3QgTUVTU0FHRV9IVE1MID0gKHZtKT0+aHRtbGAKICAgICR7dm0ubWVzc2FnZXMubWFwKChtZXNzYWdlKT0+aHRtbGA8ZGl2PiR7bWVzc2FnZS50ZXh0fTwvZGl2PmAKICAgICl9YAo7CmNsYXNzIFRoZW1lIHsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IyMDBIZXggPSAnIzY5YjdmZic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMzAwSGV4ID0gJyMwMDg4RkYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjkwMEhleCA9ICcjMDA1Y2NiJzsKICAgIHN0YXRpYyBiYWNrZ3JvdW5kQ29sb3JIZXggPSAnIzEyMTIxMic7CiAgICBzdGF0aWMgdGV4dENvbG9ySGV4ID0gJyNlZWVlZWUnOwogICAgc3RhdGljIHNhbnNTZXJpZkZvbnRGYW1pbHkgPSAnLWFwcGxlLXN5c3RlbSwgQmxpbmtNYWNTeXN0ZW1Gb250LCBhdmVuaXIgbmV4dCwgYXZlbmlyLCBoZWx2ZXRpY2EgbmV1ZSwgaGVsdmV0aWNhLCBVYnVudHUsIHJvYm90bywgbm90bywgc2Vnb2UgdWksIGFyaWFsLCBzYW5zLXNlcmlmJzsKICAgIHN0YXRpYyBtb25vc3BhY2VGb250RmFtaWx5ID0gJ01lbmxvLCAiU0YgTW9ubyIsICJBbmRhbGUgTW9ubyIsICJSb2JvdG8gTW9ubyIsIE1vbmFjbywgbW9ub3NwYWNlJzsKfQpjb25zdCBYTUxfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InhtbCI+PC9vdXRwdXQ+CmA7CmNvbnN0IFhNTF9DU1MgPSBjc3NgCiN4bWwgewogICAgZm9udC1mYW1pbHk6ICR7dW5zYWZlQ1NTKFRoZW1lLm1vbm9zcGFjZUZvbnRGYW1pbHkpfTsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGxpbmUtaGVpZ2h0OiAxcmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9Owp9CgojeG1sIGEgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnByaW1hcnlDb2xvcjMwMEhleCl9OwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICAjeG1sIGE6aG92ZXIgewogICAgICAgIHRleHQtZGVjb3JhdGlvbjogdW5kZXJsaW5lOwogICAgfQp9CgojeG1sIC5pbmRlbnQgewogICAgbWFyZ2luLWxlZnQ6IDFyZW07Cn0KCiN4bWwgLmluZGVudDIgewogICAgbWFyZ2luLWxlZnQ6IDJyZW07Cn0KCnN1bW1hcnkuZW1wdHkgeyBsaXN0LXN0eWxlOiBub25lOyB9CnN1bW1hcnkuZW1wdHk6Oi13ZWJraXQtZGV0YWlscy1tYXJrZXIgeyBkaXNwbGF5OiBub25lOyB9CgpgOwpmdW5jdGlvbiBpbml0WG1sKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgeG1sT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3htbCcpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3QgeG1sID0gdm0ueG1sOwogICAgICAgIGlmICh4bWwgIT09IF9yZW5kZXJlZFhtbCkgewogICAgICAgICAgICByZW5kZXJYbWwoeG1sLCB4bWxPdXRwdXQpOwogICAgICAgICAgICBfcmVuZGVyZWRYbWwgPSB4bWw7CiAgICAgICAgfQogICAgfTsKfQpsZXQgX3JlbmRlcmVkWG1sOwpmdW5jdGlvbiByZW5kZXJYbWwoeG1sLCB4bWxPdXRwdXQpIHsKICAgIHdoaWxlKHhtbE91dHB1dC5maXJzdENoaWxkKXhtbE91dHB1dC5yZW1vdmVDaGlsZCh4bWxPdXRwdXQuZmlyc3RDaGlsZCk7CiAgICBpZiAoeG1sKSByZW5kZXJOb2RlMSh4bWwsIHhtbE91dHB1dCwgMCwgbmV3IFNldCgpLCB1bmRlZmluZWQpOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUxKG5vZGUsIGNvbnRhaW5lckVsZW1lbnQsIGxldmVsLCBjb250ZXh0LCBpdGVtTnVtYmVyKSB7CiAgICBjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGV0YWlscycpOwogICAgY29uc3QgdGV4dCA9IG5vZGUudmFsIHx8ICcnOwogICAgZGV0YWlscy5vcGVuID0gIWNvbnRleHQuaGFzKCdmb3VuZC1pdGVtJykgfHwgdGV4dC5sZW5ndGggPiAwOwogICAgaWYgKGxldmVsID4gMCkgZGV0YWlscy5jbGFzc0xpc3QuYWRkKCdpbmRlbnQnKTsKICAgIGNvbnN0IHN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICBjb25zdCBhdHRzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChub2RlLmF0dHJzTWFwKTsKICAgIHJlbmRlclRleHRQaWVjZXMoc3VtbWFyeSwgJzwnLCBub2RlLnRhZ25hbWUsIC4uLlsKICAgICAgICAuLi5hdHRzLmVudHJpZXMoKQogICAgXS5mbGF0TWFwKCh2KT0+WwogICAgICAgICAgICBgICR7dlswXX09ImAsCiAgICAgICAgICAgIHZbMV0sCiAgICAgICAgICAgICciJwogICAgICAgIF0KICAgICksICc+JywgaXRlbU51bWJlciA/IGAgIyR7aXRlbU51bWJlcn1gIDogJycpOwogICAgZGV0YWlscy5hcHBlbmRDaGlsZChzdW1tYXJ5KTsKICAgIGxldCBjaGlsZENvdW50ID0gMDsKICAgIGlmICh0ZXh0Lmxlbmd0aCA+IDApIHsKICAgICAgICBjb25zdCBkaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKGRpdiwgdGV4dCk7CiAgICAgICAgZGl2LmNsYXNzTGlzdC5hZGQoJ2luZGVudDInKTsKICAgICAgICBkZXRhaWxzLmFwcGVuZENoaWxkKGRpdik7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgZm9yIChjb25zdCBbXywgdmFsdWVdIG9mIE9iamVjdC5lbnRyaWVzKG5vZGUuY2hpbGQpKXsKICAgICAgICBsZXQgaXRlbU51bWJlciA9IDE7CiAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgIHJlbmRlck5vZGUxKGNoaWxkLCBkZXRhaWxzLCBsZXZlbCArIDEsIGNvbnRleHQsIHZhbHVlLmxlbmd0aCA+IDEgPyBpdGVtTnVtYmVyIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgY2hpbGRDb3VudCsrOwogICAgICAgICAgICBpdGVtTnVtYmVyKys7CiAgICAgICAgfQogICAgfQogICAgaWYgKGNoaWxkQ291bnQgPT09IDApIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgnZW1wdHknLCAnaW5kZW50Jyk7CiAgICBjb250YWluZXJFbGVtZW50LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgaWYgKG5vZGUudGFnbmFtZSA9PT0gJ2l0ZW0nKSBjb250ZXh0LmFkZCgnZm91bmQtaXRlbScpOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRQaWVjZXMoZWxlbWVudCwgLi4ucGllY2VzKSB7CiAgICBmb3IgKGNvbnN0IHBpZWNlIG9mIHBpZWNlcyl7CiAgICAgICAgaWYgKC9eaHR0cHM/OlwvXC9bXlxzKV0rJC8udGVzdChwaWVjZSkpIHsKICAgICAgICAgICAgY29uc3QgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2EnKTsKICAgICAgICAgICAgYS5ocmVmID0gcGllY2U7CiAgICAgICAgICAgIGEudGFyZ2V0ID0gJ19ibGFuayc7CiAgICAgICAgICAgIGEucmVsID0gJ25vcmVmZXJyZXIgbm9vcGVuZXIgbm9mb2xsb3cnOwogICAgICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHBpZWNlKSk7CiAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoYSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShwaWVjZSkpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKbWFpbiB7CiAgICBtYXJnaW46IDJyZW07CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQpgOwpjb25zdCBhcHBIdG1sID0gaHRtbGAKPG1haW4+CiR7Rk9STV9IVE1MfQoke01FU1NBR0VTX0hUTUx9CiR7Q09NTUVOVFNfSFRNTH0KJHtYTUxfSFRNTH0KPC9tYWluPgpgOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgYXBwQ3NzLmNzc1RleHQsCiAgICBGT1JNX0NTUy5jc3NUZXh0LAogICAgTUVTU0FHRVNfQ1NTLmNzc1RleHQsCiAgICBDT01NRU5UU19DU1MuY3NzVGV4dCwKICAgIFhNTF9DU1MuY3NzVGV4dCwgCl0pOwpMaXRFbGVtZW50LnJlbmRlcihhcHBIdG1sLCBkb2N1bWVudC5ib2R5KTsKZnVuY3Rpb24gcGFyc2VTdGF0aWNEYXRhKCkgewogICAgY29uc3Qgc2NyaXB0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N0YXRpYy1kYXRhLXNjcmlwdCcpOwogICAgY29uc3QgZGF0YSA9IEpTT04ucGFyc2Uoc2NyaXB0LnRleHQpOwogICAgY29uc3QgdmVyc2lvbiA9IHR5cGVvZiBkYXRhLnZlcnNpb24gPT09ICdzdHJpbmcnID8gZGF0YS52ZXJzaW9uIDogdW5kZWZpbmVkOwogICAgY29uc3QgZmxhZ3MgPSB0eXBlb2YgZGF0YS5mbGFncyA9PT0gJ3N0cmluZycgPyBkYXRhLmZsYWdzIDogdW5kZWZpbmVkOwogICAgY29uc3QgZGVidWcgPSB0eXBlb2YgZGF0YS5kZWJ1ZyA9PT0gJ29iamVjdCcgPyBkYXRhLmRlYnVnIDogdW5kZWZpbmVkOwogICAgcmV0dXJuIHsKICAgICAgICB2ZXJzaW9uLAogICAgICAgIGZsYWdzLAogICAgICAgIGRlYnVnCiAgICB9Owp9CnBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCB2bSA9IG5ldyBWYWxpZGF0b3JBcHBWTSgpOwpjb25zdCB1cGRhdGVGb3JtID0gaW5pdEZvcm0oZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlTWVzc2FnZXMgPSBpbml0TWVzc2FnZXMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlQ29tbWVudHMgPSBpbml0Q29tbWVudHMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlWG1sID0gaW5pdFhtbChkb2N1bWVudCwgdm0pOwp2bS5vbkNoYW5nZSA9ICgpPT57CiAgICB1cGRhdGVGb3JtKCk7CiAgICB1cGRhdGVNZXNzYWdlcygpOwogICAgdXBkYXRlQ29tbWVudHMoKTsKICAgIHVwZGF0ZVhtbCgpOwp9Owp2bS5zdGFydCgpOwpzZXRBcHBTdGF0ZSgnc3RhcnRlZCcpOwo=';