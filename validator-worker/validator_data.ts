export const VALIDATOR_APP_HASH = '12a894d5841d47b89175ee0f4f2071793dc32288';
export const VALIDATOR_APP_B64 = 'Y29uc3QgZGlyZWN0aXZlcyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IGlzRGlyZWN0aXZlID0gKG8pPT57CiAgICByZXR1cm4gdHlwZW9mIG8gPT09ICJmdW5jdGlvbiIgJiYgZGlyZWN0aXZlcy5oYXMobyk7Cn07CmNvbnN0IGlzQ0VQb2x5ZmlsbCA9IHR5cGVvZiB3aW5kb3cgIT09ICJ1bmRlZmluZWQiICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cyAhPSBudWxsICYmIHdpbmRvdy5jdXN0b21FbGVtZW50cy5wb2x5ZmlsbFdyYXBGbHVzaENhbGxiYWNrICE9PSB2b2lkIDA7CmNvbnN0IHJlcGFyZW50Tm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCwgYmVmb3JlID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIuaW5zZXJ0QmVmb3JlKHN0YXJ0LCBiZWZvcmUpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3QgcmVtb3ZlTm9kZXMgPSAoY29udGFpbmVyLCBzdGFydCwgZW5kID0gbnVsbCk9PnsKICAgIHdoaWxlKHN0YXJ0ICE9PSBlbmQpewogICAgICAgIGNvbnN0IG4gPSBzdGFydC5uZXh0U2libGluZzsKICAgICAgICBjb250YWluZXIucmVtb3ZlQ2hpbGQoc3RhcnQpOwogICAgICAgIHN0YXJ0ID0gbjsKICAgIH0KfTsKY29uc3Qgbm9DaGFuZ2UgPSB7Cn07CmNvbnN0IG5vdGhpbmcgPSB7Cn07CmNvbnN0IG1hcmtlciA9IGB7e2xpdC0ke1N0cmluZyhNYXRoLnJhbmRvbSgpKS5zbGljZSgyKX19fWA7CmNvbnN0IG5vZGVNYXJrZXIgPSBgPCEtLSR7bWFya2VyfS0tPmA7CmNvbnN0IG1hcmtlclJlZ2V4ID0gbmV3IFJlZ0V4cChgJHttYXJrZXJ9fCR7bm9kZU1hcmtlcn1gKTsKY29uc3QgYm91bmRBdHRyaWJ1dGVTdWZmaXggPSAiJGxpdCQiOwpjbGFzcyBUZW1wbGF0ZSB7CiAgICBjb25zdHJ1Y3RvcihyZXN1bHQsIGVsZW1lbnQpewogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIGNvbnN0IG5vZGVzVG9SZW1vdmUgPSBbXTsKICAgICAgICBjb25zdCBzdGFjayA9IFtdOwogICAgICAgIGNvbnN0IHdhbGtlciA9IGRvY3VtZW50LmNyZWF0ZVRyZWVXYWxrZXIoZWxlbWVudC5jb250ZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgbGFzdFBhcnRJbmRleCA9IDA7CiAgICAgICAgbGV0IGluZGV4ID0gLTE7CiAgICAgICAgbGV0IHBhcnRJbmRleCA9IDA7CiAgICAgICAgY29uc3QgeyBzdHJpbmdzICwgdmFsdWVzOiB7IGxlbmd0aCAgfSAgfSA9IHJlc3VsdDsKICAgICAgICB3aGlsZShwYXJ0SW5kZXggPCBsZW5ndGgpewogICAgICAgICAgICBjb25zdCBub2RlID0gd2Fsa2VyLm5leHROb2RlKCk7CiAgICAgICAgICAgIGlmIChub2RlID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICB3YWxrZXIuY3VycmVudE5vZGUgPSBzdGFjay5wb3AoKTsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGluZGV4Kys7CiAgICAgICAgICAgIGlmIChub2RlLm5vZGVUeXBlID09PSAxKSB7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5oYXNBdHRyaWJ1dGVzKCkpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVzID0gbm9kZS5hdHRyaWJ1dGVzOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgbGVuZ3RoOiBsZW5ndGgyICB9ID0gYXR0cmlidXRlczsKICAgICAgICAgICAgICAgICAgICBsZXQgY291bnQgPSAwOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsZW5ndGgyOyBpKyspewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoZW5kc1dpdGgoYXR0cmlidXRlc1tpXS5uYW1lLCBib3VuZEF0dHJpYnV0ZVN1ZmZpeCkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvdW50Kys7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgd2hpbGUoY291bnQtLSA+IDApewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdHJpbmdGb3JQYXJ0ID0gc3RyaW5nc1twYXJ0SW5kZXhdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBuYW1lID0gbGFzdEF0dHJpYnV0ZU5hbWVSZWdleC5leGVjKHN0cmluZ0ZvclBhcnQpWzJdOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVMb29rdXBOYW1lID0gbmFtZS50b0xvd2VyQ2FzZSgpICsgYm91bmRBdHRyaWJ1dGVTdWZmaXg7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGF0dHJpYnV0ZVZhbHVlID0gbm9kZS5nZXRBdHRyaWJ1dGUoYXR0cmlidXRlTG9va3VwTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUucmVtb3ZlQXR0cmlidXRlKGF0dHJpYnV0ZUxvb2t1cE5hbWUpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBzdGF0aWNzID0gYXR0cmlidXRlVmFsdWUuc3BsaXQobWFya2VyUmVnZXgpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogImF0dHJpYnV0ZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdHJpbmdzOiBzdGF0aWNzCiAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJ0SW5kZXggKz0gc3RhdGljcy5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChub2RlLnRhZ05hbWUgPT09ICJURU1QTEFURSIpIHsKICAgICAgICAgICAgICAgICAgICBzdGFjay5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIHdhbGtlci5jdXJyZW50Tm9kZSA9IG5vZGUuY29udGVudDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmIChub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBkYXRhID0gbm9kZS5kYXRhOwogICAgICAgICAgICAgICAgaWYgKGRhdGEuaW5kZXhPZihtYXJrZXIpID49IDApIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBwYXJlbnQgPSBub2RlLnBhcmVudE5vZGU7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgc3RyaW5nczIgPSBkYXRhLnNwbGl0KG1hcmtlclJlZ2V4KTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBsYXN0SW5kZXggPSBzdHJpbmdzMi5sZW5ndGggLSAxOwogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgaSA9IDA7IGkgPCBsYXN0SW5kZXg7IGkrKyl7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBpbnNlcnQ7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBzID0gc3RyaW5nczJbaV07CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChzID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gY3JlYXRlTWFya2VyKCk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBtYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChtYXRjaCAhPT0gbnVsbCAmJiBlbmRzV2l0aChtYXRjaFsyXSwgYm91bmRBdHRyaWJ1dGVTdWZmaXgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9IHMuc2xpY2UoMCwgbWF0Y2guaW5kZXgpICsgbWF0Y2hbMV0gKyBtYXRjaFsyXS5zbGljZSgwLCAtYm91bmRBdHRyaWJ1dGVTdWZmaXgubGVuZ3RoKSArIG1hdGNoWzNdOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5zZXJ0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUocyk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50Lmluc2VydEJlZm9yZShpbnNlcnQsIG5vZGUpOwogICAgICAgICAgICAgICAgICAgICAgICB0aGlzLnBhcnRzLnB1c2goewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHlwZTogIm5vZGUiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXg6ICsraW5kZXgKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChzdHJpbmdzMltsYXN0SW5kZXhdID09PSAiIikgewogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICAgICAgbm9kZXNUb1JlbW92ZS5wdXNoKG5vZGUpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG5vZGUuZGF0YSA9IHN0cmluZ3MyW2xhc3RJbmRleF07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCArPSBsYXN0SW5kZXg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobm9kZS5ub2RlVHlwZSA9PT0gOCkgewogICAgICAgICAgICAgICAgaWYgKG5vZGUuZGF0YSA9PT0gbWFya2VyKSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgcGFyZW50ID0gbm9kZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChub2RlLnByZXZpb3VzU2libGluZyA9PT0gbnVsbCB8fCBpbmRleCA9PT0gbGFzdFBhcnRJbmRleCkgewogICAgICAgICAgICAgICAgICAgICAgICBpbmRleCsrOwogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQuaW5zZXJ0QmVmb3JlKGNyZWF0ZU1hcmtlcigpLCBub2RlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgbGFzdFBhcnRJbmRleCA9IGluZGV4OwogICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6ICJub2RlIiwKICAgICAgICAgICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS5uZXh0U2libGluZyA9PT0gbnVsbCkgewogICAgICAgICAgICAgICAgICAgICAgICBub2RlLmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBub2Rlc1RvUmVtb3ZlLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGluZGV4LS07CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgaSA9IC0xOwogICAgICAgICAgICAgICAgICAgIHdoaWxlKChpID0gbm9kZS5kYXRhLmluZGV4T2YobWFya2VyLCBpICsgMSkpICE9PSAtMSl7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMucGFydHMucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiAibm9kZSIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbmRleDogLTEKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcnRJbmRleCsrOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IG4gb2Ygbm9kZXNUb1JlbW92ZSl7CiAgICAgICAgICAgIG4ucGFyZW50Tm9kZS5yZW1vdmVDaGlsZChuKTsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgZW5kc1dpdGggPSAoc3RyLCBzdWZmaXgpPT57CiAgICBjb25zdCBpbmRleCA9IHN0ci5sZW5ndGggLSBzdWZmaXgubGVuZ3RoOwogICAgcmV0dXJuIGluZGV4ID49IDAgJiYgc3RyLnNsaWNlKGluZGV4KSA9PT0gc3VmZml4Owp9Owpjb25zdCBpc1RlbXBsYXRlUGFydEFjdGl2ZSA9IChwYXJ0KT0+cGFydC5pbmRleCAhPT0gLTEKOwpjb25zdCBjcmVhdGVNYXJrZXIgPSAoKT0+ZG9jdW1lbnQuY3JlYXRlQ29tbWVudCgiIikKOwpjb25zdCBsYXN0QXR0cmlidXRlTmFtZVJlZ2V4ID0gLyhbIFx4MDlceDBhXHgwY1x4MGRdKShbXlwwLVx4MUZceDdGLVx4OUYgIic+PS9dKykoWyBceDA5XHgwYVx4MGNceDBkXSo9WyBceDA5XHgwYVx4MGNceDBkXSooPzpbXiBceDA5XHgwYVx4MGNceDBkIidgPD49XSp8IlteIl0qfCdbXiddKikpJC87CmNsYXNzIFRlbXBsYXRlSW5zdGFuY2UgewogICAgY29uc3RydWN0b3IodGVtcGxhdGUsIHByb2Nlc3Nvciwgb3B0aW9ucyl7CiAgICAgICAgdGhpcy5fX3BhcnRzID0gW107CiAgICAgICAgdGhpcy50ZW1wbGF0ZSA9IHRlbXBsYXRlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7CiAgICB9CiAgICB1cGRhdGUodmFsdWVzKSB7CiAgICAgICAgbGV0IGkgPSAwOwogICAgICAgIGZvciAoY29uc3QgcGFydCBvZiB0aGlzLl9fcGFydHMpewogICAgICAgICAgICBpZiAocGFydCAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0LnNldFZhbHVlKHZhbHVlc1tpXSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaSsrOwogICAgICAgIH0KICAgICAgICBmb3IgKGNvbnN0IHBhcnQxIG9mIHRoaXMuX19wYXJ0cyl7CiAgICAgICAgICAgIGlmIChwYXJ0MSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICBwYXJ0MS5jb21taXQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIF9jbG9uZSgpIHsKICAgICAgICBjb25zdCBmcmFnbWVudCA9IGlzQ0VQb2x5ZmlsbCA/IHRoaXMudGVtcGxhdGUuZWxlbWVudC5jb250ZW50LmNsb25lTm9kZSh0cnVlKSA6IGRvY3VtZW50LmltcG9ydE5vZGUodGhpcy50ZW1wbGF0ZS5lbGVtZW50LmNvbnRlbnQsIHRydWUpOwogICAgICAgIGNvbnN0IHN0YWNrID0gW107CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy50ZW1wbGF0ZS5wYXJ0czsKICAgICAgICBjb25zdCB3YWxrZXIgPSBkb2N1bWVudC5jcmVhdGVUcmVlV2Fsa2VyKGZyYWdtZW50LCAxMzMsIG51bGwsIGZhbHNlKTsKICAgICAgICBsZXQgcGFydEluZGV4ID0gMDsKICAgICAgICBsZXQgbm9kZUluZGV4ID0gMDsKICAgICAgICBsZXQgcGFydDsKICAgICAgICBsZXQgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgIHdoaWxlKHBhcnRJbmRleCA8IHBhcnRzMi5sZW5ndGgpewogICAgICAgICAgICBwYXJ0ID0gcGFydHMyW3BhcnRJbmRleF07CiAgICAgICAgICAgIGlmICghaXNUZW1wbGF0ZVBhcnRBY3RpdmUocGFydCkpIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHZvaWQgMCk7CiAgICAgICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHdoaWxlKG5vZGVJbmRleCA8IHBhcnQuaW5kZXgpewogICAgICAgICAgICAgICAgbm9kZUluZGV4Kys7CiAgICAgICAgICAgICAgICBpZiAobm9kZS5ub2RlTmFtZSA9PT0gIlRFTVBMQVRFIikgewogICAgICAgICAgICAgICAgICAgIHN0YWNrLnB1c2gobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gbm9kZS5jb250ZW50OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKChub2RlID0gd2Fsa2VyLm5leHROb2RlKCkpID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgd2Fsa2VyLmN1cnJlbnROb2RlID0gc3RhY2sucG9wKCk7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IHdhbGtlci5uZXh0Tm9kZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmIChwYXJ0LnR5cGUgPT09ICJub2RlIikgewogICAgICAgICAgICAgICAgY29uc3QgcGFydDIgPSB0aGlzLnByb2Nlc3Nvci5oYW5kbGVUZXh0RXhwcmVzc2lvbih0aGlzLm9wdGlvbnMpOwogICAgICAgICAgICAgICAgcGFydDIuaW5zZXJ0QWZ0ZXJOb2RlKG5vZGUucHJldmlvdXNTaWJsaW5nKTsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKHBhcnQyKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX19wYXJ0cy5wdXNoKC4uLnRoaXMucHJvY2Vzc29yLmhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKG5vZGUsIHBhcnQubmFtZSwgcGFydC5zdHJpbmdzLCB0aGlzLm9wdGlvbnMpKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKGlzQ0VQb2x5ZmlsbCkgewogICAgICAgICAgICBkb2N1bWVudC5hZG9wdE5vZGUoZnJhZ21lbnQpOwogICAgICAgICAgICBjdXN0b21FbGVtZW50cy51cGdyYWRlKGZyYWdtZW50KTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGZyYWdtZW50OwogICAgfQp9CmNvbnN0IHBvbGljeSA9IHdpbmRvdy50cnVzdGVkVHlwZXMgJiYgdHJ1c3RlZFR5cGVzLmNyZWF0ZVBvbGljeSgibGl0LWh0bWwiLCB7CiAgICBjcmVhdGVIVE1MOiAocyk9PnMKfSk7CmNvbnN0IGNvbW1lbnRNYXJrZXIgPSBgICR7bWFya2VyfSBgOwpjbGFzcyBUZW1wbGF0ZVJlc3VsdCB7CiAgICBjb25zdHJ1Y3RvcihzdHJpbmdzLCB2YWx1ZXMsIHR5cGUsIHByb2Nlc3Nvcil7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgICAgICB0aGlzLnZhbHVlcyA9IHZhbHVlczsKICAgICAgICB0aGlzLnR5cGUgPSB0eXBlOwogICAgICAgIHRoaXMucHJvY2Vzc29yID0gcHJvY2Vzc29yOwogICAgfQogICAgZ2V0SFRNTCgpIHsKICAgICAgICBjb25zdCBsID0gdGhpcy5zdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgbGV0IGh0bWwyID0gIiI7CiAgICAgICAgbGV0IGlzQ29tbWVudEJpbmRpbmcgPSBmYWxzZTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgbDsgaSsrKXsKICAgICAgICAgICAgY29uc3QgcyA9IHRoaXMuc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgY29tbWVudE9wZW4gPSBzLmxhc3RJbmRleE9mKCI8IS0tIik7CiAgICAgICAgICAgIGlzQ29tbWVudEJpbmRpbmcgPSAoY29tbWVudE9wZW4gPiAtMSB8fCBpc0NvbW1lbnRCaW5kaW5nKSAmJiBzLmluZGV4T2YoIi0tPiIsIGNvbW1lbnRPcGVuICsgMSkgPT09IC0xOwogICAgICAgICAgICBjb25zdCBhdHRyaWJ1dGVNYXRjaCA9IGxhc3RBdHRyaWJ1dGVOYW1lUmVnZXguZXhlYyhzKTsKICAgICAgICAgICAgaWYgKGF0dHJpYnV0ZU1hdGNoID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzICsgKGlzQ29tbWVudEJpbmRpbmcgPyBjb21tZW50TWFya2VyIDogbm9kZU1hcmtlcik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBodG1sMiArPSBzLnN1YnN0cigwLCBhdHRyaWJ1dGVNYXRjaC5pbmRleCkgKyBhdHRyaWJ1dGVNYXRjaFsxXSArIGF0dHJpYnV0ZU1hdGNoWzJdICsgYm91bmRBdHRyaWJ1dGVTdWZmaXggKyBhdHRyaWJ1dGVNYXRjaFszXSArIG1hcmtlcjsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBodG1sMiArPSB0aGlzLnN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIGh0bWwyOwogICAgfQogICAgZ2V0VGVtcGxhdGVFbGVtZW50KCkgewogICAgICAgIGNvbnN0IHRlbXBsYXRlID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgidGVtcGxhdGUiKTsKICAgICAgICBsZXQgdmFsdWUgPSB0aGlzLmdldEhUTUwoKTsKICAgICAgICBpZiAocG9saWN5ICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgdmFsdWUgPSBwb2xpY3kuY3JlYXRlSFRNTCh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHRlbXBsYXRlLmlubmVySFRNTCA9IHZhbHVlOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjbGFzcyBTVkdUZW1wbGF0ZVJlc3VsdCBleHRlbmRzIFRlbXBsYXRlUmVzdWx0IHsKICAgIGdldEhUTUwoKSB7CiAgICAgICAgcmV0dXJuIGA8c3ZnPiR7c3VwZXIuZ2V0SFRNTCgpfTwvc3ZnPmA7CiAgICB9CiAgICBnZXRUZW1wbGF0ZUVsZW1lbnQoKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSBzdXBlci5nZXRUZW1wbGF0ZUVsZW1lbnQoKTsKICAgICAgICBjb25zdCBjb250ZW50ID0gdGVtcGxhdGUuY29udGVudDsKICAgICAgICBjb25zdCBzdmdFbGVtZW50ID0gY29udGVudC5maXJzdENoaWxkOwogICAgICAgIGNvbnRlbnQucmVtb3ZlQ2hpbGQoc3ZnRWxlbWVudCk7CiAgICAgICAgcmVwYXJlbnROb2Rlcyhjb250ZW50LCBzdmdFbGVtZW50LmZpcnN0Q2hpbGQpOwogICAgICAgIHJldHVybiB0ZW1wbGF0ZTsKICAgIH0KfQpjb25zdCBpc1ByaW1pdGl2ZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCB8fCAhKHR5cGVvZiB2YWx1ZSA9PT0gIm9iamVjdCIgfHwgdHlwZW9mIHZhbHVlID09PSAiZnVuY3Rpb24iKTsKfTsKY29uc3QgaXNJdGVyYWJsZSA9ICh2YWx1ZSk9PnsKICAgIHJldHVybiBBcnJheS5pc0FycmF5KHZhbHVlKSB8fCAhISh2YWx1ZSAmJiB2YWx1ZVtTeW1ib2wuaXRlcmF0b3JdKTsKfTsKY2xhc3MgQXR0cmlidXRlQ29tbWl0dGVyIHsKICAgIGNvbnN0cnVjdG9yKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpewogICAgICAgIHRoaXMuZGlydHkgPSB0cnVlOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTsKICAgICAgICB0aGlzLnN0cmluZ3MgPSBzdHJpbmdzOwogICAgICAgIHRoaXMucGFydHMgPSBbXTsKICAgICAgICBmb3IobGV0IGkgPSAwOyBpIDwgc3RyaW5ncy5sZW5ndGggLSAxOyBpKyspewogICAgICAgICAgICB0aGlzLnBhcnRzW2ldID0gdGhpcy5fY3JlYXRlUGFydCgpOwogICAgICAgIH0KICAgIH0KICAgIF9jcmVhdGVQYXJ0KCkgewogICAgICAgIHJldHVybiBuZXcgQXR0cmlidXRlUGFydCh0aGlzKTsKICAgIH0KICAgIF9nZXRWYWx1ZSgpIHsKICAgICAgICBjb25zdCBzdHJpbmdzID0gdGhpcy5zdHJpbmdzOwogICAgICAgIGNvbnN0IGwgPSBzdHJpbmdzLmxlbmd0aCAtIDE7CiAgICAgICAgY29uc3QgcGFydHMyID0gdGhpcy5wYXJ0czsKICAgICAgICBpZiAobCA9PT0gMSAmJiBzdHJpbmdzWzBdID09PSAiIiAmJiBzdHJpbmdzWzFdID09PSAiIikgewogICAgICAgICAgICBjb25zdCB2ID0gcGFydHMyWzBdLnZhbHVlOwogICAgICAgICAgICBpZiAodHlwZW9mIHYgPT09ICJzeW1ib2wiKSB7CiAgICAgICAgICAgICAgICByZXR1cm4gU3RyaW5nKHYpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGlmICh0eXBlb2YgdiA9PT0gInN0cmluZyIgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgIHJldHVybiB2OwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGxldCB0ZXh0ID0gIiI7CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGw7IGkrKyl7CiAgICAgICAgICAgIHRleHQgKz0gc3RyaW5nc1tpXTsKICAgICAgICAgICAgY29uc3QgcGFydCA9IHBhcnRzMltpXTsKICAgICAgICAgICAgaWYgKHBhcnQgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgY29uc3QgdiA9IHBhcnQudmFsdWU7CiAgICAgICAgICAgICAgICBpZiAoaXNQcmltaXRpdmUodikgfHwgIWlzSXRlcmFibGUodikpIHsKICAgICAgICAgICAgICAgICAgICB0ZXh0ICs9IHR5cGVvZiB2ID09PSAic3RyaW5nIiA/IHYgOiBTdHJpbmcodik7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGZvciAoY29uc3QgdCBvZiB2KXsKICAgICAgICAgICAgICAgICAgICAgICAgdGV4dCArPSB0eXBlb2YgdCA9PT0gInN0cmluZyIgPyB0IDogU3RyaW5nKHQpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0ZXh0ICs9IHN0cmluZ3NbbF07CiAgICAgICAgcmV0dXJuIHRleHQ7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnQuc2V0QXR0cmlidXRlKHRoaXMubmFtZSwgdGhpcy5fZ2V0VmFsdWUoKSk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIEF0dHJpYnV0ZVBhcnQgewogICAgY29uc3RydWN0b3IoY29tbWl0dGVyKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuY29tbWl0dGVyID0gY29tbWl0dGVyOwogICAgfQogICAgc2V0VmFsdWUodmFsdWUpIHsKICAgICAgICBpZiAodmFsdWUgIT09IG5vQ2hhbmdlICYmICghaXNQcmltaXRpdmUodmFsdWUpIHx8IHZhbHVlICE9PSB0aGlzLnZhbHVlKSkgewogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgICAgIGlmICghaXNEaXJlY3RpdmUodmFsdWUpKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbW1pdHRlci5kaXJ0eSA9IHRydWU7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgd2hpbGUoaXNEaXJlY3RpdmUodGhpcy52YWx1ZSkpewogICAgICAgICAgICBjb25zdCBkaXJlY3RpdmUyID0gdGhpcy52YWx1ZTsKICAgICAgICAgICAgdGhpcy52YWx1ZSA9IG5vQ2hhbmdlOwogICAgICAgICAgICBkaXJlY3RpdmUyKHRoaXMpOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy52YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICB0aGlzLmNvbW1pdHRlci5jb21taXQoKTsKICAgIH0KfQpjbGFzcyBOb2RlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihvcHRpb25zKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgdGhpcy5vcHRpb25zID0gb3B0aW9uczsKICAgIH0KICAgIGFwcGVuZEludG8oY29udGFpbmVyKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSBjb250YWluZXIuYXBwZW5kQ2hpbGQoY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IGNvbnRhaW5lci5hcHBlbmRDaGlsZChjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlck5vZGUocmVmKSB7CiAgICAgICAgdGhpcy5zdGFydE5vZGUgPSByZWY7CiAgICAgICAgdGhpcy5lbmROb2RlID0gcmVmLm5leHRTaWJsaW5nOwogICAgfQogICAgYXBwZW5kSW50b1BhcnQocGFydCkgewogICAgICAgIHBhcnQuX19pbnNlcnQodGhpcy5zdGFydE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICAgICAgcGFydC5fX2luc2VydCh0aGlzLmVuZE5vZGUgPSBjcmVhdGVNYXJrZXIoKSk7CiAgICB9CiAgICBpbnNlcnRBZnRlclBhcnQocmVmKSB7CiAgICAgICAgcmVmLl9faW5zZXJ0KHRoaXMuc3RhcnROb2RlID0gY3JlYXRlTWFya2VyKCkpOwogICAgICAgIHRoaXMuZW5kTm9kZSA9IHJlZi5lbmROb2RlOwogICAgICAgIHJlZi5lbmROb2RlID0gdGhpcy5zdGFydE5vZGU7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICBpZiAodGhpcy5zdGFydE5vZGUucGFyZW50Tm9kZSA9PT0gbnVsbCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgIGlmICh2YWx1ZSA9PT0gbm9DaGFuZ2UpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcmltaXRpdmUodmFsdWUpKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSAhPT0gdGhpcy52YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlUmVzdWx0KSB7CiAgICAgICAgICAgIHRoaXMuX19jb21taXRUZW1wbGF0ZVJlc3VsdCh2YWx1ZSk7CiAgICAgICAgfSBlbHNlIGlmICh2YWx1ZSBpbnN0YW5jZW9mIE5vZGUpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUodmFsdWUpOwogICAgICAgIH0gZWxzZSBpZiAoaXNJdGVyYWJsZSh2YWx1ZSkpIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKTsKICAgICAgICB9IGVsc2UgaWYgKHZhbHVlID09PSBub3RoaW5nKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBub3RoaW5nOwogICAgICAgICAgICB0aGlzLmNsZWFyKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdFRleHQodmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIF9faW5zZXJ0KG5vZGUpIHsKICAgICAgICB0aGlzLmVuZE5vZGUucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUobm9kZSwgdGhpcy5lbmROb2RlKTsKICAgIH0KICAgIF9fY29tbWl0Tm9kZSh2YWx1ZSkgewogICAgICAgIGlmICh0aGlzLnZhbHVlID09PSB2YWx1ZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIHRoaXMuY2xlYXIoKTsKICAgICAgICB0aGlzLl9faW5zZXJ0KHZhbHVlKTsKICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRleHQodmFsdWUpIHsKICAgICAgICBjb25zdCBub2RlID0gdGhpcy5zdGFydE5vZGUubmV4dFNpYmxpbmc7CiAgICAgICAgdmFsdWUgPSB2YWx1ZSA9PSBudWxsID8gIiIgOiB2YWx1ZTsKICAgICAgICBjb25zdCB2YWx1ZUFzU3RyaW5nID0gdHlwZW9mIHZhbHVlID09PSAic3RyaW5nIiA/IHZhbHVlIDogU3RyaW5nKHZhbHVlKTsKICAgICAgICBpZiAobm9kZSA9PT0gdGhpcy5lbmROb2RlLnByZXZpb3VzU2libGluZyAmJiBub2RlLm5vZGVUeXBlID09PSAzKSB7CiAgICAgICAgICAgIG5vZGUuZGF0YSA9IHZhbHVlQXNTdHJpbmc7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fX2NvbW1pdE5vZGUoZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUodmFsdWVBc1N0cmluZykpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICB9CiAgICBfX2NvbW1pdFRlbXBsYXRlUmVzdWx0KHZhbHVlKSB7CiAgICAgICAgY29uc3QgdGVtcGxhdGUgPSB0aGlzLm9wdGlvbnMudGVtcGxhdGVGYWN0b3J5KHZhbHVlKTsKICAgICAgICBpZiAodGhpcy52YWx1ZSBpbnN0YW5jZW9mIFRlbXBsYXRlSW5zdGFuY2UgJiYgdGhpcy52YWx1ZS50ZW1wbGF0ZSA9PT0gdGVtcGxhdGUpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS51cGRhdGUodmFsdWUudmFsdWVzKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCBpbnN0YW5jZSA9IG5ldyBUZW1wbGF0ZUluc3RhbmNlKHRlbXBsYXRlLCB2YWx1ZS5wcm9jZXNzb3IsIHRoaXMub3B0aW9ucyk7CiAgICAgICAgICAgIGNvbnN0IGZyYWdtZW50ID0gaW5zdGFuY2UuX2Nsb25lKCk7CiAgICAgICAgICAgIGluc3RhbmNlLnVwZGF0ZSh2YWx1ZS52YWx1ZXMpOwogICAgICAgICAgICB0aGlzLl9fY29tbWl0Tm9kZShmcmFnbWVudCk7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBpbnN0YW5jZTsKICAgICAgICB9CiAgICB9CiAgICBfX2NvbW1pdEl0ZXJhYmxlKHZhbHVlKSB7CiAgICAgICAgaWYgKCFBcnJheS5pc0FycmF5KHRoaXMudmFsdWUpKSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUgPSBbXTsKICAgICAgICAgICAgdGhpcy5jbGVhcigpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpdGVtUGFydHMgPSB0aGlzLnZhbHVlOwogICAgICAgIGxldCBwYXJ0SW5kZXggPSAwOwogICAgICAgIGxldCBpdGVtUGFydDsKICAgICAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgdmFsdWUpewogICAgICAgICAgICBpdGVtUGFydCA9IGl0ZW1QYXJ0c1twYXJ0SW5kZXhdOwogICAgICAgICAgICBpZiAoaXRlbVBhcnQgPT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgaXRlbVBhcnQgPSBuZXcgTm9kZVBhcnQodGhpcy5vcHRpb25zKTsKICAgICAgICAgICAgICAgIGl0ZW1QYXJ0cy5wdXNoKGl0ZW1QYXJ0KTsKICAgICAgICAgICAgICAgIGlmIChwYXJ0SW5kZXggPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBpdGVtUGFydC5hcHBlbmRJbnRvUGFydCh0aGlzKTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgaXRlbVBhcnQuaW5zZXJ0QWZ0ZXJQYXJ0KGl0ZW1QYXJ0c1twYXJ0SW5kZXggLSAxXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaXRlbVBhcnQuc2V0VmFsdWUoaXRlbSk7CiAgICAgICAgICAgIGl0ZW1QYXJ0LmNvbW1pdCgpOwogICAgICAgICAgICBwYXJ0SW5kZXgrKzsKICAgICAgICB9CiAgICAgICAgaWYgKHBhcnRJbmRleCA8IGl0ZW1QYXJ0cy5sZW5ndGgpIHsKICAgICAgICAgICAgaXRlbVBhcnRzLmxlbmd0aCA9IHBhcnRJbmRleDsKICAgICAgICAgICAgdGhpcy5jbGVhcihpdGVtUGFydCAmJiBpdGVtUGFydC5lbmROb2RlKTsKICAgICAgICB9CiAgICB9CiAgICBjbGVhcihzdGFydE5vZGUgPSB0aGlzLnN0YXJ0Tm9kZSkgewogICAgICAgIHJlbW92ZU5vZGVzKHRoaXMuc3RhcnROb2RlLnBhcmVudE5vZGUsIHN0YXJ0Tm9kZS5uZXh0U2libGluZywgdGhpcy5lbmROb2RlKTsKICAgIH0KfQpjbGFzcyBCb29sZWFuQXR0cmlidXRlUGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICB0aGlzLnZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2b2lkIDA7CiAgICAgICAgaWYgKHN0cmluZ3MubGVuZ3RoICE9PSAyIHx8IHN0cmluZ3NbMF0gIT09ICIiIHx8IHN0cmluZ3NbMV0gIT09ICIiKSB7CiAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiQm9vbGVhbiBhdHRyaWJ1dGVzIGNhbiBvbmx5IGNvbnRhaW4gYSBzaW5nbGUgZXhwcmVzc2lvbiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmVsZW1lbnQgPSBlbGVtZW50OwogICAgICAgIHRoaXMubmFtZSA9IG5hbWU7CiAgICAgICAgdGhpcy5zdHJpbmdzID0gc3RyaW5nczsKICAgIH0KICAgIHNldFZhbHVlKHZhbHVlKSB7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IHZhbHVlOwogICAgfQogICAgY29tbWl0KCkgewogICAgICAgIHdoaWxlKGlzRGlyZWN0aXZlKHRoaXMuX19wZW5kaW5nVmFsdWUpKXsKICAgICAgICAgICAgY29uc3QgZGlyZWN0aXZlMiA9IHRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgICAgICAgICAgZGlyZWN0aXZlMih0aGlzKTsKICAgICAgICB9CiAgICAgICAgaWYgKHRoaXMuX19wZW5kaW5nVmFsdWUgPT09IG5vQ2hhbmdlKSB7CiAgICAgICAgICAgIHJldHVybjsKICAgICAgICB9CiAgICAgICAgY29uc3QgdmFsdWUgPSAhIXRoaXMuX19wZW5kaW5nVmFsdWU7CiAgICAgICAgaWYgKHRoaXMudmFsdWUgIT09IHZhbHVlKSB7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgdGhpcy5lbGVtZW50LnNldEF0dHJpYnV0ZSh0aGlzLm5hbWUsICIiKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuZWxlbWVudC5yZW1vdmVBdHRyaWJ1dGUodGhpcy5uYW1lKTsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLnZhbHVlID0gdmFsdWU7CiAgICAgICAgfQogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSBub0NoYW5nZTsKICAgIH0KfQpjbGFzcyBQcm9wZXJ0eUNvbW1pdHRlciBleHRlbmRzIEF0dHJpYnV0ZUNvbW1pdHRlciB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKXsKICAgICAgICBzdXBlcihlbGVtZW50LCBuYW1lLCBzdHJpbmdzKTsKICAgICAgICB0aGlzLnNpbmdsZSA9IHN0cmluZ3MubGVuZ3RoID09PSAyICYmIHN0cmluZ3NbMF0gPT09ICIiICYmIHN0cmluZ3NbMV0gPT09ICIiOwogICAgfQogICAgX2NyZWF0ZVBhcnQoKSB7CiAgICAgICAgcmV0dXJuIG5ldyBQcm9wZXJ0eVBhcnQodGhpcyk7CiAgICB9CiAgICBfZ2V0VmFsdWUoKSB7CiAgICAgICAgaWYgKHRoaXMuc2luZ2xlKSB7CiAgICAgICAgICAgIHJldHVybiB0aGlzLnBhcnRzWzBdLnZhbHVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gc3VwZXIuX2dldFZhbHVlKCk7CiAgICB9CiAgICBjb21taXQoKSB7CiAgICAgICAgaWYgKHRoaXMuZGlydHkpIHsKICAgICAgICAgICAgdGhpcy5kaXJ0eSA9IGZhbHNlOwogICAgICAgICAgICB0aGlzLmVsZW1lbnRbdGhpcy5uYW1lXSA9IHRoaXMuX2dldFZhbHVlKCk7CiAgICAgICAgfQogICAgfQp9CmNsYXNzIFByb3BlcnR5UGFydCBleHRlbmRzIEF0dHJpYnV0ZVBhcnQgewp9CmxldCBldmVudE9wdGlvbnNTdXBwb3J0ZWQgPSBmYWxzZTsKKCgpPT57CiAgICB0cnkgewogICAgICAgIGNvbnN0IG9wdGlvbnMgPSB7CiAgICAgICAgICAgIGdldCBjYXB0dXJlICgpIHsKICAgICAgICAgICAgICAgIGV2ZW50T3B0aW9uc1N1cHBvcnRlZCA9IHRydWU7CiAgICAgICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCJ0ZXN0Iiwgb3B0aW9ucywgb3B0aW9ucyk7CiAgICAgICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoInRlc3QiLCBvcHRpb25zLCBvcHRpb25zKTsKICAgIH0gY2F0Y2ggKF9lKSB7CiAgICB9Cn0pKCk7CmNsYXNzIEV2ZW50UGFydCB7CiAgICBjb25zdHJ1Y3RvcihlbGVtZW50LCBldmVudE5hbWUsIGV2ZW50Q29udGV4dCl7CiAgICAgICAgdGhpcy52YWx1ZSA9IHZvaWQgMDsKICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gdm9pZCAwOwogICAgICAgIHRoaXMuZWxlbWVudCA9IGVsZW1lbnQ7CiAgICAgICAgdGhpcy5ldmVudE5hbWUgPSBldmVudE5hbWU7CiAgICAgICAgdGhpcy5ldmVudENvbnRleHQgPSBldmVudENvbnRleHQ7CiAgICAgICAgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQgPSAoZSk9PnRoaXMuaGFuZGxlRXZlbnQoZSkKICAgICAgICA7CiAgICB9CiAgICBzZXRWYWx1ZSh2YWx1ZSkgewogICAgICAgIHRoaXMuX19wZW5kaW5nVmFsdWUgPSB2YWx1ZTsKICAgIH0KICAgIGNvbW1pdCgpIHsKICAgICAgICB3aGlsZShpc0RpcmVjdGl2ZSh0aGlzLl9fcGVuZGluZ1ZhbHVlKSl7CiAgICAgICAgICAgIGNvbnN0IGRpcmVjdGl2ZTIgPSB0aGlzLl9fcGVuZGluZ1ZhbHVlOwogICAgICAgICAgICB0aGlzLl9fcGVuZGluZ1ZhbHVlID0gbm9DaGFuZ2U7CiAgICAgICAgICAgIGRpcmVjdGl2ZTIodGhpcyk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9fcGVuZGluZ1ZhbHVlID09PSBub0NoYW5nZSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IG5ld0xpc3RlbmVyID0gdGhpcy5fX3BlbmRpbmdWYWx1ZTsKICAgICAgICBjb25zdCBvbGRMaXN0ZW5lciA9IHRoaXMudmFsdWU7CiAgICAgICAgY29uc3Qgc2hvdWxkUmVtb3ZlTGlzdGVuZXIgPSBuZXdMaXN0ZW5lciA9PSBudWxsIHx8IG9sZExpc3RlbmVyICE9IG51bGwgJiYgKG5ld0xpc3RlbmVyLmNhcHR1cmUgIT09IG9sZExpc3RlbmVyLmNhcHR1cmUgfHwgbmV3TGlzdGVuZXIub25jZSAhPT0gb2xkTGlzdGVuZXIub25jZSB8fCBuZXdMaXN0ZW5lci5wYXNzaXZlICE9PSBvbGRMaXN0ZW5lci5wYXNzaXZlKTsKICAgICAgICBjb25zdCBzaG91bGRBZGRMaXN0ZW5lciA9IG5ld0xpc3RlbmVyICE9IG51bGwgJiYgKG9sZExpc3RlbmVyID09IG51bGwgfHwgc2hvdWxkUmVtb3ZlTGlzdGVuZXIpOwogICAgICAgIGlmIChzaG91bGRSZW1vdmVMaXN0ZW5lcikgewogICAgICAgICAgICB0aGlzLmVsZW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcih0aGlzLmV2ZW50TmFtZSwgdGhpcy5fX2JvdW5kSGFuZGxlRXZlbnQsIHRoaXMuX19vcHRpb25zKTsKICAgICAgICB9CiAgICAgICAgaWYgKHNob3VsZEFkZExpc3RlbmVyKSB7CiAgICAgICAgICAgIHRoaXMuX19vcHRpb25zID0gZ2V0T3B0aW9ucyhuZXdMaXN0ZW5lcik7CiAgICAgICAgICAgIHRoaXMuZWxlbWVudC5hZGRFdmVudExpc3RlbmVyKHRoaXMuZXZlbnROYW1lLCB0aGlzLl9fYm91bmRIYW5kbGVFdmVudCwgdGhpcy5fX29wdGlvbnMpOwogICAgICAgIH0KICAgICAgICB0aGlzLnZhbHVlID0gbmV3TGlzdGVuZXI7CiAgICAgICAgdGhpcy5fX3BlbmRpbmdWYWx1ZSA9IG5vQ2hhbmdlOwogICAgfQogICAgaGFuZGxlRXZlbnQoZXZlbnQpIHsKICAgICAgICBpZiAodHlwZW9mIHRoaXMudmFsdWUgPT09ICJmdW5jdGlvbiIpIHsKICAgICAgICAgICAgdGhpcy52YWx1ZS5jYWxsKHRoaXMuZXZlbnRDb250ZXh0IHx8IHRoaXMuZWxlbWVudCwgZXZlbnQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMudmFsdWUuaGFuZGxlRXZlbnQoZXZlbnQpOwogICAgICAgIH0KICAgIH0KfQpjb25zdCBnZXRPcHRpb25zID0gKG8pPT5vICYmIChldmVudE9wdGlvbnNTdXBwb3J0ZWQgPyB7CiAgICAgICAgY2FwdHVyZTogby5jYXB0dXJlLAogICAgICAgIHBhc3NpdmU6IG8ucGFzc2l2ZSwKICAgICAgICBvbmNlOiBvLm9uY2UKICAgIH0gOiBvLmNhcHR1cmUpCjsKY2xhc3MgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yIHsKICAgIGhhbmRsZUF0dHJpYnV0ZUV4cHJlc3Npb25zKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCBwcmVmaXggPSBuYW1lWzBdOwogICAgICAgIGlmIChwcmVmaXggPT09ICIuIikgewogICAgICAgICAgICBjb25zdCBjb21taXR0ZXIyID0gbmV3IFByb3BlcnR5Q29tbWl0dGVyKGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIHN0cmluZ3MpOwogICAgICAgICAgICByZXR1cm4gY29tbWl0dGVyMi5wYXJ0czsKICAgICAgICB9CiAgICAgICAgaWYgKHByZWZpeCA9PT0gIkAiKSB7CiAgICAgICAgICAgIHJldHVybiBbCiAgICAgICAgICAgICAgICBuZXcgRXZlbnRQYXJ0KGVsZW1lbnQsIG5hbWUuc2xpY2UoMSksIG9wdGlvbnMuZXZlbnRDb250ZXh0KQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBpZiAocHJlZml4ID09PSAiPyIpIHsKICAgICAgICAgICAgcmV0dXJuIFsKICAgICAgICAgICAgICAgIG5ldyBCb29sZWFuQXR0cmlidXRlUGFydChlbGVtZW50LCBuYW1lLnNsaWNlKDEpLCBzdHJpbmdzKQogICAgICAgICAgICBdOwogICAgICAgIH0KICAgICAgICBjb25zdCBjb21taXR0ZXIgPSBuZXcgQXR0cmlidXRlQ29tbWl0dGVyKGVsZW1lbnQsIG5hbWUsIHN0cmluZ3MpOwogICAgICAgIHJldHVybiBjb21taXR0ZXIucGFydHM7CiAgICB9CiAgICBoYW5kbGVUZXh0RXhwcmVzc2lvbihvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIG5ldyBOb2RlUGFydChvcHRpb25zKTsKICAgIH0KfQpjb25zdCBkZWZhdWx0VGVtcGxhdGVQcm9jZXNzb3IgPSBuZXcgRGVmYXVsdFRlbXBsYXRlUHJvY2Vzc29yKCk7CmZ1bmN0aW9uIHRlbXBsYXRlRmFjdG9yeShyZXN1bHQpIHsKICAgIGxldCB0ZW1wbGF0ZUNhY2hlID0gdGVtcGxhdGVDYWNoZXMuZ2V0KHJlc3VsdC50eXBlKTsKICAgIGlmICh0ZW1wbGF0ZUNhY2hlID09PSB2b2lkIDApIHsKICAgICAgICB0ZW1wbGF0ZUNhY2hlID0gewogICAgICAgICAgICBzdHJpbmdzQXJyYXk6IG5ldyBXZWFrTWFwKCksCiAgICAgICAgICAgIGtleVN0cmluZzogbmV3IE1hcCgpCiAgICAgICAgfTsKICAgICAgICB0ZW1wbGF0ZUNhY2hlcy5zZXQocmVzdWx0LnR5cGUsIHRlbXBsYXRlQ2FjaGUpOwogICAgfQogICAgbGV0IHRlbXBsYXRlID0gdGVtcGxhdGVDYWNoZS5zdHJpbmdzQXJyYXkuZ2V0KHJlc3VsdC5zdHJpbmdzKTsKICAgIGlmICh0ZW1wbGF0ZSAhPT0gdm9pZCAwKSB7CiAgICAgICAgcmV0dXJuIHRlbXBsYXRlOwogICAgfQogICAgY29uc3Qga2V5ID0gcmVzdWx0LnN0cmluZ3Muam9pbihtYXJrZXIpOwogICAgdGVtcGxhdGUgPSB0ZW1wbGF0ZUNhY2hlLmtleVN0cmluZy5nZXQoa2V5KTsKICAgIGlmICh0ZW1wbGF0ZSA9PT0gdm9pZCAwKSB7CiAgICAgICAgdGVtcGxhdGUgPSBuZXcgVGVtcGxhdGUocmVzdWx0LCByZXN1bHQuZ2V0VGVtcGxhdGVFbGVtZW50KCkpOwogICAgICAgIHRlbXBsYXRlQ2FjaGUua2V5U3RyaW5nLnNldChrZXksIHRlbXBsYXRlKTsKICAgIH0KICAgIHRlbXBsYXRlQ2FjaGUuc3RyaW5nc0FycmF5LnNldChyZXN1bHQuc3RyaW5ncywgdGVtcGxhdGUpOwogICAgcmV0dXJuIHRlbXBsYXRlOwp9CmNvbnN0IHRlbXBsYXRlQ2FjaGVzID0gbmV3IE1hcCgpOwpjb25zdCBwYXJ0cyA9IG5ldyBXZWFrTWFwKCk7CmNvbnN0IHJlbmRlciA9IChyZXN1bHQsIGNvbnRhaW5lciwgb3B0aW9ucyk9PnsKICAgIGxldCBwYXJ0ID0gcGFydHMuZ2V0KGNvbnRhaW5lcik7CiAgICBpZiAocGFydCA9PT0gdm9pZCAwKSB7CiAgICAgICAgcmVtb3ZlTm9kZXMoY29udGFpbmVyLCBjb250YWluZXIuZmlyc3RDaGlsZCk7CiAgICAgICAgcGFydHMuc2V0KGNvbnRhaW5lciwgcGFydCA9IG5ldyBOb2RlUGFydChPYmplY3QuYXNzaWduKHsKICAgICAgICAgICAgdGVtcGxhdGVGYWN0b3J5CiAgICAgICAgfSwgb3B0aW9ucykpKTsKICAgICAgICBwYXJ0LmFwcGVuZEludG8oY29udGFpbmVyKTsKICAgIH0KICAgIHBhcnQuc2V0VmFsdWUocmVzdWx0KTsKICAgIHBhcnQuY29tbWl0KCk7Cn07CmlmICh0eXBlb2Ygd2luZG93ICE9PSAidW5kZWZpbmVkIikgewogICAgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gfHwgKHdpbmRvd1sibGl0SHRtbFZlcnNpb25zIl0gPSBbXSkpLnB1c2goIjEuNC4xIik7Cn0KY29uc3QgaHRtbCA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT5uZXcgVGVtcGxhdGVSZXN1bHQoc3RyaW5ncywgdmFsdWVzLCAiaHRtbCIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwpjb25zdCBzdmcgPSAoc3RyaW5ncywgLi4udmFsdWVzKT0+bmV3IFNWR1RlbXBsYXRlUmVzdWx0KHN0cmluZ3MsIHZhbHVlcywgInN2ZyIsIGRlZmF1bHRUZW1wbGF0ZVByb2Nlc3NvcikKOwp2YXIgX2E7CndpbmRvdy5KU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5ID0gKHByb3AsIF9vYmopPT5wcm9wCjsKY29uc3QgZGVmYXVsdENvbnZlcnRlciA9IHsKICAgIHRvQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlID8gIiIgOiBudWxsOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PSBudWxsID8gdmFsdWUgOiBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB2YWx1ZTsKICAgIH0sCiAgICBmcm9tQXR0cmlidXRlICh2YWx1ZSwgdHlwZSkgewogICAgICAgIHN3aXRjaCh0eXBlKXsKICAgICAgICAgICAgY2FzZSBCb29sZWFuOgogICAgICAgICAgICAgICAgcmV0dXJuIHZhbHVlICE9PSBudWxsOwogICAgICAgICAgICBjYXNlIE51bWJlcjoKICAgICAgICAgICAgICAgIHJldHVybiB2YWx1ZSA9PT0gbnVsbCA/IG51bGwgOiBOdW1iZXIodmFsdWUpOwogICAgICAgICAgICBjYXNlIE9iamVjdDoKICAgICAgICAgICAgY2FzZSBBcnJheToKICAgICAgICAgICAgICAgIHJldHVybiBKU09OLnBhcnNlKHZhbHVlKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHZhbHVlOwogICAgfQp9Owpjb25zdCBub3RFcXVhbCA9ICh2YWx1ZSwgb2xkKT0+ewogICAgcmV0dXJuIG9sZCAhPT0gdmFsdWUgJiYgKG9sZCA9PT0gb2xkIHx8IHZhbHVlID09PSB2YWx1ZSk7Cn07CmNvbnN0IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uID0gewogICAgYXR0cmlidXRlOiB0cnVlLAogICAgdHlwZTogU3RyaW5nLAogICAgY29udmVydGVyOiBkZWZhdWx0Q29udmVydGVyLAogICAgcmVmbGVjdDogZmFsc2UsCiAgICBoYXNDaGFuZ2VkOiBub3RFcXVhbAp9Owpjb25zdCBTVEFURV9IQVNfVVBEQVRFRCA9IDE7CmNvbnN0IFNUQVRFX1VQREFURV9SRVFVRVNURUQgPSAxIDw8IDI7CmNvbnN0IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fQVRUUklCVVRFID0gMSA8PCAzOwpjb25zdCBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZID0gMSA8PCA0Owpjb25zdCBmaW5hbGl6ZWQgPSAiZmluYWxpemVkIjsKY2xhc3MgVXBkYXRpbmdFbGVtZW50IGV4dGVuZHMgSFRNTEVsZW1lbnQgewogICAgY29uc3RydWN0b3IoKXsKICAgICAgICBzdXBlcigpOwogICAgICAgIHRoaXMuaW5pdGlhbGl6ZSgpOwogICAgfQogICAgc3RhdGljIGdldCBvYnNlcnZlZEF0dHJpYnV0ZXMoKSB7CiAgICAgICAgdGhpcy5maW5hbGl6ZSgpOwogICAgICAgIGNvbnN0IGF0dHJpYnV0ZXMgPSBbXTsKICAgICAgICB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnsKICAgICAgICAgICAgY29uc3QgYXR0ciA9IHRoaXMuX2F0dHJpYnV0ZU5hbWVGb3JQcm9wZXJ0eShwLCB2KTsKICAgICAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5zZXQoYXR0ciwgcCk7CiAgICAgICAgICAgICAgICBhdHRyaWJ1dGVzLnB1c2goYXR0cik7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgICAgICByZXR1cm4gYXR0cmlidXRlczsKICAgIH0KICAgIHN0YXRpYyBfZW5zdXJlQ2xhc3NQcm9wZXJ0aWVzKCkgewogICAgICAgIGlmICghdGhpcy5oYXNPd25Qcm9wZXJ0eShKU0NvbXBpbGVyX3JlbmFtZVByb3BlcnR5KCJfY2xhc3NQcm9wZXJ0aWVzIiwgdGhpcykpKSB7CiAgICAgICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcyA9IG5ldyBNYXAoKTsKICAgICAgICAgICAgY29uc3Qgc3VwZXJQcm9wZXJ0aWVzID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKHRoaXMpLl9jbGFzc1Byb3BlcnRpZXM7CiAgICAgICAgICAgIGlmIChzdXBlclByb3BlcnRpZXMgIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgc3VwZXJQcm9wZXJ0aWVzLmZvckVhY2goKHYsIGspPT50aGlzLl9jbGFzc1Byb3BlcnRpZXMuc2V0KGssIHYpCiAgICAgICAgICAgICAgICApOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIGNyZWF0ZVByb3BlcnR5KG5hbWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2NsYXNzUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKG9wdGlvbnMubm9BY2Nlc3NvciB8fCB0aGlzLnByb3RvdHlwZS5oYXNPd25Qcm9wZXJ0eShuYW1lKSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGtleSA9IHR5cGVvZiBuYW1lID09PSAic3ltYm9sIiA/IFN5bWJvbCgpIDogYF9fJHtuYW1lfWA7CiAgICAgICAgY29uc3QgZGVzY3JpcHRvciA9IHRoaXMuZ2V0UHJvcGVydHlEZXNjcmlwdG9yKG5hbWUsIGtleSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGRlc2NyaXB0b3IgIT09IHZvaWQgMCkgewogICAgICAgICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkodGhpcy5wcm90b3R5cGUsIG5hbWUsIGRlc2NyaXB0b3IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXRpYyBnZXRQcm9wZXJ0eURlc2NyaXB0b3IobmFtZSwga2V5LCBvcHRpb25zKSB7CiAgICAgICAgcmV0dXJuIHsKICAgICAgICAgICAgZ2V0ICgpIHsKICAgICAgICAgICAgICAgIHJldHVybiB0aGlzW2tleV07CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHNldCAodmFsdWUpIHsKICAgICAgICAgICAgICAgIGNvbnN0IG9sZFZhbHVlID0gdGhpc1tuYW1lXTsKICAgICAgICAgICAgICAgIHRoaXNba2V5XSA9IHZhbHVlOwogICAgICAgICAgICAgICAgdGhpcy5yZXF1ZXN0VXBkYXRlSW50ZXJuYWwobmFtZSwgb2xkVmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB9LAogICAgICAgICAgICBjb25maWd1cmFibGU6IHRydWUsCiAgICAgICAgICAgIGVudW1lcmFibGU6IHRydWUKICAgICAgICB9OwogICAgfQogICAgc3RhdGljIGdldFByb3BlcnR5T3B0aW9ucyhuYW1lKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX2NsYXNzUHJvcGVydGllcyAmJiB0aGlzLl9jbGFzc1Byb3BlcnRpZXMuZ2V0KG5hbWUpIHx8IGRlZmF1bHRQcm9wZXJ0eURlY2xhcmF0aW9uOwogICAgfQogICAgc3RhdGljIGZpbmFsaXplKCkgewogICAgICAgIGNvbnN0IHN1cGVyQ3RvciA9IE9iamVjdC5nZXRQcm90b3R5cGVPZih0aGlzKTsKICAgICAgICBpZiAoIXN1cGVyQ3Rvci5oYXNPd25Qcm9wZXJ0eShmaW5hbGl6ZWQpKSB7CiAgICAgICAgICAgIHN1cGVyQ3Rvci5maW5hbGl6ZSgpOwogICAgICAgIH0KICAgICAgICB0aGlzW2ZpbmFsaXplZF0gPSB0cnVlOwogICAgICAgIHRoaXMuX2Vuc3VyZUNsYXNzUHJvcGVydGllcygpOwogICAgICAgIHRoaXMuX2F0dHJpYnV0ZVRvUHJvcGVydHlNYXAgPSBuZXcgTWFwKCk7CiAgICAgICAgaWYgKHRoaXMuaGFzT3duUHJvcGVydHkoSlNDb21waWxlcl9yZW5hbWVQcm9wZXJ0eSgicHJvcGVydGllcyIsIHRoaXMpKSkgewogICAgICAgICAgICBjb25zdCBwcm9wcyA9IHRoaXMucHJvcGVydGllczsKICAgICAgICAgICAgY29uc3QgcHJvcEtleXMgPSBbCiAgICAgICAgICAgICAgICAuLi5PYmplY3QuZ2V0T3duUHJvcGVydHlOYW1lcyhwcm9wcyksCiAgICAgICAgICAgICAgICAuLi50eXBlb2YgT2JqZWN0LmdldE93blByb3BlcnR5U3ltYm9scyA9PT0gImZ1bmN0aW9uIiA/IE9iamVjdC5nZXRPd25Qcm9wZXJ0eVN5bWJvbHMocHJvcHMpIDogW10KICAgICAgICAgICAgXTsKICAgICAgICAgICAgZm9yIChjb25zdCBwIG9mIHByb3BLZXlzKXsKICAgICAgICAgICAgICAgIHRoaXMuY3JlYXRlUHJvcGVydHkocCwgcHJvcHNbcF0pOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgc3RhdGljIF9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGF0dHJpYnV0ZSA9IG9wdGlvbnMuYXR0cmlidXRlOwogICAgICAgIHJldHVybiBhdHRyaWJ1dGUgPT09IGZhbHNlID8gdm9pZCAwIDogdHlwZW9mIGF0dHJpYnV0ZSA9PT0gInN0cmluZyIgPyBhdHRyaWJ1dGUgOiB0eXBlb2YgbmFtZSA9PT0gInN0cmluZyIgPyBuYW1lLnRvTG93ZXJDYXNlKCkgOiB2b2lkIDA7CiAgICB9CiAgICBzdGF0aWMgX3ZhbHVlSGFzQ2hhbmdlZCh2YWx1ZSwgb2xkLCBoYXNDaGFuZ2VkID0gbm90RXF1YWwpIHsKICAgICAgICByZXR1cm4gaGFzQ2hhbmdlZCh2YWx1ZSwgb2xkKTsKICAgIH0KICAgIHN0YXRpYyBfcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpIHsKICAgICAgICBjb25zdCB0eXBlID0gb3B0aW9ucy50eXBlOwogICAgICAgIGNvbnN0IGNvbnZlcnRlciA9IG9wdGlvbnMuY29udmVydGVyIHx8IGRlZmF1bHRDb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgZnJvbUF0dHJpYnV0ZSA9IHR5cGVvZiBjb252ZXJ0ZXIgPT09ICJmdW5jdGlvbiIgPyBjb252ZXJ0ZXIgOiBjb252ZXJ0ZXIuZnJvbUF0dHJpYnV0ZTsKICAgICAgICByZXR1cm4gZnJvbUF0dHJpYnV0ZSA/IGZyb21BdHRyaWJ1dGUodmFsdWUsIHR5cGUpIDogdmFsdWU7CiAgICB9CiAgICBzdGF0aWMgX3Byb3BlcnR5VmFsdWVUb0F0dHJpYnV0ZSh2YWx1ZSwgb3B0aW9ucykgewogICAgICAgIGlmIChvcHRpb25zLnJlZmxlY3QgPT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IHR5cGUgPSBvcHRpb25zLnR5cGU7CiAgICAgICAgY29uc3QgY29udmVydGVyID0gb3B0aW9ucy5jb252ZXJ0ZXI7CiAgICAgICAgY29uc3QgdG9BdHRyaWJ1dGUgPSBjb252ZXJ0ZXIgJiYgY29udmVydGVyLnRvQXR0cmlidXRlIHx8IGRlZmF1bHRDb252ZXJ0ZXIudG9BdHRyaWJ1dGU7CiAgICAgICAgcmV0dXJuIHRvQXR0cmlidXRlKHZhbHVlLCB0eXBlKTsKICAgIH0KICAgIGluaXRpYWxpemUoKSB7CiAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSAwOwogICAgICAgIHRoaXMuX3VwZGF0ZVByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzKT0+dGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHJlcwogICAgICAgICk7CiAgICAgICAgdGhpcy5fY2hhbmdlZFByb3BlcnRpZXMgPSBuZXcgTWFwKCk7CiAgICAgICAgdGhpcy5fc2F2ZUluc3RhbmNlUHJvcGVydGllcygpOwogICAgICAgIHRoaXMucmVxdWVzdFVwZGF0ZUludGVybmFsKCk7CiAgICB9CiAgICBfc2F2ZUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLmNvbnN0cnVjdG9yLl9jbGFzc1Byb3BlcnRpZXMuZm9yRWFjaCgoX3YsIHApPT57CiAgICAgICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KHApKSB7CiAgICAgICAgICAgICAgICBjb25zdCB2YWx1ZSA9IHRoaXNbcF07CiAgICAgICAgICAgICAgICBkZWxldGUgdGhpc1twXTsKICAgICAgICAgICAgICAgIGlmICghdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgdGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzLnNldChwLCB2YWx1ZSk7CiAgICAgICAgICAgIH0KICAgICAgICB9KTsKICAgIH0KICAgIF9hcHBseUluc3RhbmNlUHJvcGVydGllcygpIHsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMuZm9yRWFjaCgodiwgcCk9PnRoaXNbcF0gPSB2CiAgICAgICAgKTsKICAgICAgICB0aGlzLl9pbnN0YW5jZVByb3BlcnRpZXMgPSB2b2lkIDA7CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICB0aGlzLmVuYWJsZVVwZGF0aW5nKCk7CiAgICB9CiAgICBlbmFibGVVcGRhdGluZygpIHsKICAgICAgICBpZiAodGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgIHRoaXMuX2VuYWJsZVVwZGF0aW5nUmVzb2x2ZXIoKTsKICAgICAgICAgICAgdGhpcy5fZW5hYmxlVXBkYXRpbmdSZXNvbHZlciA9IHZvaWQgMDsKICAgICAgICB9CiAgICB9CiAgICBkaXNjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgIH0KICAgIGF0dHJpYnV0ZUNoYW5nZWRDYWxsYmFjayhuYW1lLCBvbGQsIHZhbHVlKSB7CiAgICAgICAgaWYgKG9sZCAhPT0gdmFsdWUpIHsKICAgICAgICAgICAgdGhpcy5fYXR0cmlidXRlVG9Qcm9wZXJ0eShuYW1lLCB2YWx1ZSk7CiAgICAgICAgfQogICAgfQogICAgX3Byb3BlcnR5VG9BdHRyaWJ1dGUobmFtZSwgdmFsdWUsIG9wdGlvbnMgPSBkZWZhdWx0UHJvcGVydHlEZWNsYXJhdGlvbikgewogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IGF0dHIgPSBjdG9yLl9hdHRyaWJ1dGVOYW1lRm9yUHJvcGVydHkobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgaWYgKGF0dHIgIT09IHZvaWQgMCkgewogICAgICAgICAgICBjb25zdCBhdHRyVmFsdWUgPSBjdG9yLl9wcm9wZXJ0eVZhbHVlVG9BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0clZhbHVlID09PSB2b2lkIDApIHsKICAgICAgICAgICAgICAgIHJldHVybjsKICAgICAgICAgICAgfQogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgICAgIGlmIChhdHRyVmFsdWUgPT0gbnVsbCkgewogICAgICAgICAgICAgICAgdGhpcy5yZW1vdmVBdHRyaWJ1dGUoYXR0cik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aGlzLnNldEF0dHJpYnV0ZShhdHRyLCBhdHRyVmFsdWUpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfSVNfUkVGTEVDVElOR19UT19BVFRSSUJVVEU7CiAgICAgICAgfQogICAgfQogICAgX2F0dHJpYnV0ZVRvUHJvcGVydHkobmFtZSwgdmFsdWUpIHsKICAgICAgICBpZiAodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX0FUVFJJQlVURSkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGNvbnN0IGN0b3IgPSB0aGlzLmNvbnN0cnVjdG9yOwogICAgICAgIGNvbnN0IHByb3BOYW1lID0gY3Rvci5fYXR0cmlidXRlVG9Qcm9wZXJ0eU1hcC5nZXQobmFtZSk7CiAgICAgICAgaWYgKHByb3BOYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3Qgb3B0aW9ucyA9IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKHByb3BOYW1lKTsKICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgICAgIHRoaXNbcHJvcE5hbWVdID0gY3Rvci5fcHJvcGVydHlWYWx1ZUZyb21BdHRyaWJ1dGUodmFsdWUsIG9wdGlvbnMpOwogICAgICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlICYgflNUQVRFX0lTX1JFRkxFQ1RJTkdfVE9fUFJPUEVSVFk7CiAgICAgICAgfQogICAgfQogICAgcmVxdWVzdFVwZGF0ZUludGVybmFsKG5hbWUsIG9sZFZhbHVlLCBvcHRpb25zKSB7CiAgICAgICAgbGV0IHNob3VsZFJlcXVlc3RVcGRhdGUgPSB0cnVlOwogICAgICAgIGlmIChuYW1lICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgY29uc3QgY3RvciA9IHRoaXMuY29uc3RydWN0b3I7CiAgICAgICAgICAgIG9wdGlvbnMgPSBvcHRpb25zIHx8IGN0b3IuZ2V0UHJvcGVydHlPcHRpb25zKG5hbWUpOwogICAgICAgICAgICBpZiAoY3Rvci5fdmFsdWVIYXNDaGFuZ2VkKHRoaXNbbmFtZV0sIG9sZFZhbHVlLCBvcHRpb25zLmhhc0NoYW5nZWQpKSB7CiAgICAgICAgICAgICAgICBpZiAoIXRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLmhhcyhuYW1lKSkgewogICAgICAgICAgICAgICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzLnNldChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5yZWZsZWN0ID09PSB0cnVlICYmICEodGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9JU19SRUZMRUNUSU5HX1RPX1BST1BFUlRZKSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcyA9PT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB0aGlzLl9yZWZsZWN0aW5nUHJvcGVydGllcy5zZXQobmFtZSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBzaG91bGRSZXF1ZXN0VXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUgJiYgc2hvdWxkUmVxdWVzdFVwZGF0ZSkgewogICAgICAgICAgICB0aGlzLl91cGRhdGVQcm9taXNlID0gdGhpcy5fZW5xdWV1ZVVwZGF0ZSgpOwogICAgICAgIH0KICAgIH0KICAgIHJlcXVlc3RVcGRhdGUobmFtZSwgb2xkVmFsdWUpIHsKICAgICAgICB0aGlzLnJlcXVlc3RVcGRhdGVJbnRlcm5hbChuYW1lLCBvbGRWYWx1ZSk7CiAgICAgICAgcmV0dXJuIHRoaXMudXBkYXRlQ29tcGxldGU7CiAgICB9CiAgICBhc3luYyBfZW5xdWV1ZVVwZGF0ZSgpIHsKICAgICAgICB0aGlzLl91cGRhdGVTdGF0ZSA9IHRoaXMuX3VwZGF0ZVN0YXRlIHwgU1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgICAgICB0cnkgewogICAgICAgICAgICBhd2FpdCB0aGlzLl91cGRhdGVQcm9taXNlOwogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICB9CiAgICAgICAgY29uc3QgcmVzdWx0ID0gdGhpcy5wZXJmb3JtVXBkYXRlKCk7CiAgICAgICAgaWYgKHJlc3VsdCAhPSBudWxsKSB7CiAgICAgICAgICAgIGF3YWl0IHJlc3VsdDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuICF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGU7CiAgICB9CiAgICBnZXQgX2hhc1JlcXVlc3RlZFVwZGF0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fdXBkYXRlU3RhdGUgJiBTVEFURV9VUERBVEVfUkVRVUVTVEVEOwogICAgfQogICAgZ2V0IGhhc1VwZGF0ZWQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVN0YXRlICYgMTsKICAgIH0KICAgIHBlcmZvcm1VcGRhdGUoKSB7CiAgICAgICAgaWYgKCF0aGlzLl9oYXNSZXF1ZXN0ZWRVcGRhdGUpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAodGhpcy5faW5zdGFuY2VQcm9wZXJ0aWVzKSB7CiAgICAgICAgICAgIHRoaXMuX2FwcGx5SW5zdGFuY2VQcm9wZXJ0aWVzKCk7CiAgICAgICAgfQogICAgICAgIGxldCBzaG91bGRVcGRhdGUgPSBmYWxzZTsKICAgICAgICBjb25zdCBjaGFuZ2VkUHJvcGVydGllcyA9IHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzOwogICAgICAgIHRyeSB7CiAgICAgICAgICAgIHNob3VsZFVwZGF0ZSA9IHRoaXMuc2hvdWxkVXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICAgICAgaWYgKHNob3VsZFVwZGF0ZSkgewogICAgICAgICAgICAgICAgdGhpcy51cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhpcy5fbWFya1VwZGF0ZWQoKTsKICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgc2hvdWxkVXBkYXRlID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICAgICAgICAgIHRocm93IGU7CiAgICAgICAgfQogICAgICAgIGlmIChzaG91bGRVcGRhdGUpIHsKICAgICAgICAgICAgaWYgKCEodGhpcy5fdXBkYXRlU3RhdGUgJiAxKSkgewogICAgICAgICAgICAgICAgdGhpcy5fdXBkYXRlU3RhdGUgPSB0aGlzLl91cGRhdGVTdGF0ZSB8IFNUQVRFX0hBU19VUERBVEVEOwogICAgICAgICAgICAgICAgdGhpcy5maXJzdFVwZGF0ZWQoY2hhbmdlZFByb3BlcnRpZXMpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHRoaXMudXBkYXRlZChjaGFuZ2VkUHJvcGVydGllcyk7CiAgICAgICAgfQogICAgfQogICAgX21hcmtVcGRhdGVkKCkgewogICAgICAgIHRoaXMuX2NoYW5nZWRQcm9wZXJ0aWVzID0gbmV3IE1hcCgpOwogICAgICAgIHRoaXMuX3VwZGF0ZVN0YXRlID0gdGhpcy5fdXBkYXRlU3RhdGUgJiB+U1RBVEVfVVBEQVRFX1JFUVVFU1RFRDsKICAgIH0KICAgIGdldCB1cGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5fZ2V0VXBkYXRlQ29tcGxldGUoKTsKICAgIH0KICAgIF9nZXRVcGRhdGVDb21wbGV0ZSgpIHsKICAgICAgICByZXR1cm4gdGhpcy5nZXRVcGRhdGVDb21wbGV0ZSgpOwogICAgfQogICAgZ2V0VXBkYXRlQ29tcGxldGUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuX3VwZGF0ZVByb21pc2U7CiAgICB9CiAgICBzaG91bGRVcGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgcmV0dXJuIHRydWU7CiAgICB9CiAgICB1cGRhdGUoX2NoYW5nZWRQcm9wZXJ0aWVzKSB7CiAgICAgICAgaWYgKHRoaXMuX3JlZmxlY3RpbmdQcm9wZXJ0aWVzICE9PSB2b2lkIDAgJiYgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMuZm9yRWFjaCgodiwgayk9PnRoaXMuX3Byb3BlcnR5VG9BdHRyaWJ1dGUoaywgdGhpc1trXSwgdikKICAgICAgICAgICAgKTsKICAgICAgICAgICAgdGhpcy5fcmVmbGVjdGluZ1Byb3BlcnRpZXMgPSB2b2lkIDA7CiAgICAgICAgfQogICAgICAgIHRoaXMuX21hcmtVcGRhdGVkKCk7CiAgICB9CiAgICB1cGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQogICAgZmlyc3RVcGRhdGVkKF9jaGFuZ2VkUHJvcGVydGllcykgewogICAgfQp9Cl9hID0gZmluYWxpemVkOwpVcGRhdGluZ0VsZW1lbnRbX2FdID0gdHJ1ZTsKY29uc3QgRWxlbWVudFByb3RvID0gRWxlbWVudC5wcm90b3R5cGU7CkVsZW1lbnRQcm90by5tc01hdGNoZXNTZWxlY3RvciB8fCBFbGVtZW50UHJvdG8ud2Via2l0TWF0Y2hlc1NlbGVjdG9yOwpjb25zdCBzdXBwb3J0c0Fkb3B0aW5nU3R5bGVTaGVldHMgPSB3aW5kb3cuU2hhZG93Um9vdCAmJiAod2luZG93LlNoYWR5Q1NTID09PSB2b2lkIDAgfHwgd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgJiYgImFkb3B0ZWRTdHlsZVNoZWV0cyIgaW4gRG9jdW1lbnQucHJvdG90eXBlICYmICJyZXBsYWNlIiBpbiBDU1NTdHlsZVNoZWV0LnByb3RvdHlwZTsKY29uc3QgY29uc3RydWN0aW9uVG9rZW4gPSBTeW1ib2woKTsKY2xhc3MgQ1NTUmVzdWx0IHsKICAgIGNvbnN0cnVjdG9yKGNzc1RleHQsIHNhZmVUb2tlbil7CiAgICAgICAgaWYgKHNhZmVUb2tlbiAhPT0gY29uc3RydWN0aW9uVG9rZW4pIHsKICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCJDU1NSZXN1bHQgaXMgbm90IGNvbnN0cnVjdGFibGUuIFVzZSBgdW5zYWZlQ1NTYCBvciBgY3NzYCBpbnN0ZWFkLiIpOwogICAgICAgIH0KICAgICAgICB0aGlzLmNzc1RleHQgPSBjc3NUZXh0OwogICAgfQogICAgZ2V0IHN0eWxlU2hlZXQoKSB7CiAgICAgICAgaWYgKHRoaXMuX3N0eWxlU2hlZXQgPT09IHZvaWQgMCkgewogICAgICAgICAgICBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICB0aGlzLl9zdHlsZVNoZWV0ID0gbmV3IENTU1N0eWxlU2hlZXQoKTsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQucmVwbGFjZVN5bmModGhpcy5jc3NUZXh0KTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRoaXMuX3N0eWxlU2hlZXQgPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzLl9zdHlsZVNoZWV0OwogICAgfQogICAgdG9TdHJpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3NzVGV4dDsKICAgIH0KfQpjb25zdCB1bnNhZmVDU1MgPSAodmFsdWUpPT57CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChTdHJpbmcodmFsdWUpLCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07CmNvbnN0IHRleHRGcm9tQ1NTUmVzdWx0ID0gKHZhbHVlKT0+ewogICAgaWYgKHZhbHVlIGluc3RhbmNlb2YgQ1NTUmVzdWx0KSB7CiAgICAgICAgcmV0dXJuIHZhbHVlLmNzc1RleHQ7CiAgICB9IGVsc2UgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gIm51bWJlciIpIHsKICAgICAgICByZXR1cm4gdmFsdWU7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVmFsdWUgcGFzc2VkIHRvICdjc3MnIGZ1bmN0aW9uIG11c3QgYmUgYSAnY3NzJyBmdW5jdGlvbiByZXN1bHQ6ICR7dmFsdWV9LiBVc2UgJ3Vuc2FmZUNTUycgdG8gcGFzcyBub24tbGl0ZXJhbCB2YWx1ZXMsIGJ1dAogICAgICAgICAgICB0YWtlIGNhcmUgdG8gZW5zdXJlIHBhZ2Ugc2VjdXJpdHkuYCk7CiAgICB9Cn07CmNvbnN0IGNzcyA9IChzdHJpbmdzLCAuLi52YWx1ZXMpPT57CiAgICBjb25zdCBjc3NUZXh0ID0gdmFsdWVzLnJlZHVjZSgoYWNjLCB2LCBpZHgpPT5hY2MgKyB0ZXh0RnJvbUNTU1Jlc3VsdCh2KSArIHN0cmluZ3NbaWR4ICsgMV0KICAgICwgc3RyaW5nc1swXSk7CiAgICByZXR1cm4gbmV3IENTU1Jlc3VsdChjc3NUZXh0LCBjb25zdHJ1Y3Rpb25Ub2tlbik7Cn07Cih3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdIHx8ICh3aW5kb3dbImxpdEVsZW1lbnRWZXJzaW9ucyJdID0gW10pKS5wdXNoKCIyLjUuMSIpOwpjb25zdCByZW5kZXJOb3RJbXBsZW1lbnRlZCA9IHsKfTsKY2xhc3MgTGl0RWxlbWVudCBleHRlbmRzIFVwZGF0aW5nRWxlbWVudCB7CiAgICBzdGF0aWMgZ2V0U3R5bGVzKCkgewogICAgICAgIHJldHVybiB0aGlzLnN0eWxlczsKICAgIH0KICAgIHN0YXRpYyBfZ2V0VW5pcXVlU3R5bGVzKCkgewogICAgICAgIGlmICh0aGlzLmhhc093blByb3BlcnR5KEpTQ29tcGlsZXJfcmVuYW1lUHJvcGVydHkoIl9zdHlsZXMiLCB0aGlzKSkpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBjb25zdCB1c2VyU3R5bGVzID0gdGhpcy5nZXRTdHlsZXMoKTsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh1c2VyU3R5bGVzKSkgewogICAgICAgICAgICBjb25zdCBhZGRTdHlsZXMgPSAoc3R5bGVzMiwgc2V0Mik9PnN0eWxlczIucmVkdWNlUmlnaHQoKHNldDMsIHMpPT5BcnJheS5pc0FycmF5KHMpID8gYWRkU3R5bGVzKHMsIHNldDMpIDogKHNldDMuYWRkKHMpLCBzZXQzKQogICAgICAgICAgICAgICAgLCBzZXQyKQogICAgICAgICAgICA7CiAgICAgICAgICAgIGNvbnN0IHNldCA9IGFkZFN0eWxlcyh1c2VyU3R5bGVzLCBuZXcgU2V0KCkpOwogICAgICAgICAgICBjb25zdCBzdHlsZXMgPSBbXTsKICAgICAgICAgICAgc2V0LmZvckVhY2goKHYpPT5zdHlsZXMudW5zaGlmdCh2KQogICAgICAgICAgICApOwogICAgICAgICAgICB0aGlzLl9zdHlsZXMgPSBzdHlsZXM7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fc3R5bGVzID0gdXNlclN0eWxlcyA9PT0gdm9pZCAwID8gW10gOiBbCiAgICAgICAgICAgICAgICB1c2VyU3R5bGVzCiAgICAgICAgICAgIF07CiAgICAgICAgfQogICAgICAgIHRoaXMuX3N0eWxlcyA9IHRoaXMuX3N0eWxlcy5tYXAoKHMpPT57CiAgICAgICAgICAgIGlmIChzIGluc3RhbmNlb2YgQ1NTU3R5bGVTaGVldCAmJiAhc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBjc3NUZXh0ID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwocy5jc3NSdWxlcykucmVkdWNlKChjc3MyLCBydWxlKT0+Y3NzMiArIHJ1bGUuY3NzVGV4dAogICAgICAgICAgICAgICAgLCAiIik7CiAgICAgICAgICAgICAgICByZXR1cm4gdW5zYWZlQ1NTKGNzc1RleHQpOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBzOwogICAgICAgIH0pOwogICAgfQogICAgaW5pdGlhbGl6ZSgpIHsKICAgICAgICBzdXBlci5pbml0aWFsaXplKCk7CiAgICAgICAgdGhpcy5jb25zdHJ1Y3Rvci5fZ2V0VW5pcXVlU3R5bGVzKCk7CiAgICAgICAgdGhpcy5yZW5kZXJSb290ID0gdGhpcy5jcmVhdGVSZW5kZXJSb290KCk7CiAgICAgICAgaWYgKHdpbmRvdy5TaGFkb3dSb290ICYmIHRoaXMucmVuZGVyUm9vdCBpbnN0YW5jZW9mIHdpbmRvdy5TaGFkb3dSb290KSB7CiAgICAgICAgICAgIHRoaXMuYWRvcHRTdHlsZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjcmVhdGVSZW5kZXJSb290KCkgewogICAgICAgIHJldHVybiB0aGlzLmF0dGFjaFNoYWRvdyh0aGlzLmNvbnN0cnVjdG9yLnNoYWRvd1Jvb3RPcHRpb25zKTsKICAgIH0KICAgIGFkb3B0U3R5bGVzKCkgewogICAgICAgIGNvbnN0IHN0eWxlcyA9IHRoaXMuY29uc3RydWN0b3IuX3N0eWxlczsKICAgICAgICBpZiAoc3R5bGVzLmxlbmd0aCA9PT0gMCkgewogICAgICAgICAgICByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmICh3aW5kb3cuU2hhZHlDU1MgIT09IHZvaWQgMCAmJiAhd2luZG93LlNoYWR5Q1NTLm5hdGl2ZVNoYWRvdykgewogICAgICAgICAgICB3aW5kb3cuU2hhZHlDU1MuU2NvcGluZ1NoaW0ucHJlcGFyZUFkb3B0ZWRDc3NUZXh0KHN0eWxlcy5tYXAoKHMpPT5zLmNzc1RleHQKICAgICAgICAgICAgKSwgdGhpcy5sb2NhbE5hbWUpOwogICAgICAgIH0gZWxzZSBpZiAoc3VwcG9ydHNBZG9wdGluZ1N0eWxlU2hlZXRzKSB7CiAgICAgICAgICAgIHRoaXMucmVuZGVyUm9vdC5hZG9wdGVkU3R5bGVTaGVldHMgPSBzdHlsZXMubWFwKChzKT0+cyBpbnN0YW5jZW9mIENTU1N0eWxlU2hlZXQgPyBzIDogcy5zdHlsZVNoZWV0CiAgICAgICAgICAgICk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gdHJ1ZTsKICAgICAgICB9CiAgICB9CiAgICBjb25uZWN0ZWRDYWxsYmFjaygpIHsKICAgICAgICBzdXBlci5jb25uZWN0ZWRDYWxsYmFjaygpOwogICAgICAgIGlmICh0aGlzLmhhc1VwZGF0ZWQgJiYgd2luZG93LlNoYWR5Q1NTICE9PSB2b2lkIDApIHsKICAgICAgICAgICAgd2luZG93LlNoYWR5Q1NTLnN0eWxlRWxlbWVudCh0aGlzKTsKICAgICAgICB9CiAgICB9CiAgICB1cGRhdGUoY2hhbmdlZFByb3BlcnRpZXMpIHsKICAgICAgICBjb25zdCB0ZW1wbGF0ZVJlc3VsdCA9IHRoaXMucmVuZGVyKCk7CiAgICAgICAgc3VwZXIudXBkYXRlKGNoYW5nZWRQcm9wZXJ0aWVzKTsKICAgICAgICBpZiAodGVtcGxhdGVSZXN1bHQgIT09IHJlbmRlck5vdEltcGxlbWVudGVkKSB7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IucmVuZGVyKHRlbXBsYXRlUmVzdWx0LCB0aGlzLnJlbmRlclJvb3QsIHsKICAgICAgICAgICAgICAgIHNjb3BlTmFtZTogdGhpcy5sb2NhbE5hbWUsCiAgICAgICAgICAgICAgICBldmVudENvbnRleHQ6IHRoaXMKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgICAgIGlmICh0aGlzLl9uZWVkc1NoaW1BZG9wdGVkU3R5bGVTaGVldHMpIHsKICAgICAgICAgICAgdGhpcy5fbmVlZHNTaGltQWRvcHRlZFN0eWxlU2hlZXRzID0gZmFsc2U7CiAgICAgICAgICAgIHRoaXMuY29uc3RydWN0b3IuX3N0eWxlcy5mb3JFYWNoKChzKT0+ewogICAgICAgICAgICAgICAgY29uc3Qgc3R5bGUgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJzdHlsZSIpOwogICAgICAgICAgICAgICAgc3R5bGUudGV4dENvbnRlbnQgPSBzLmNzc1RleHQ7CiAgICAgICAgICAgICAgICB0aGlzLnJlbmRlclJvb3QuYXBwZW5kQ2hpbGQoc3R5bGUpOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIHJlbmRlck5vdEltcGxlbWVudGVkOwogICAgfQp9CkxpdEVsZW1lbnRbImZpbmFsaXplZCJdID0gdHJ1ZTsKTGl0RWxlbWVudC5yZW5kZXIgPSByZW5kZXI7CkxpdEVsZW1lbnQuc2hhZG93Um9vdE9wdGlvbnMgPSB7CiAgICBtb2RlOiAib3BlbiIKfTsKZnVuY3Rpb24gc2V0SW50ZXJzZWN0KGxocywgcmhzKSB7CiAgICBjb25zdCBydCA9IG5ldyBTZXQoKTsKICAgIGZvciAoY29uc3QgaXRlbSBvZiBsaHMpewogICAgICAgIGlmIChyaHMuaGFzKGl0ZW0pKSBydC5hZGQoaXRlbSk7CiAgICB9CiAgICBmb3IgKGNvbnN0IGl0ZW0xIG9mIHJocyl7CiAgICAgICAgaWYgKGxocy5oYXMoaXRlbTEpKSBydC5hZGQoaXRlbTEpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmNsYXNzIFRoZW1lIHsKICAgIHN0YXRpYyBwcmltYXJ5Q29sb3IyMDBIZXggPSAnIzY5YjdmZic7CiAgICBzdGF0aWMgcHJpbWFyeUNvbG9yMzAwSGV4ID0gJyMwMDg4RkYnOwogICAgc3RhdGljIHByaW1hcnlDb2xvcjkwMEhleCA9ICcjMDA1Y2NiJzsKICAgIHN0YXRpYyBiYWNrZ3JvdW5kQ29sb3JIZXggPSAnIzEyMTIxMic7CiAgICBzdGF0aWMgdGV4dENvbG9ySGV4ID0gJyNlYmViZWInOwogICAgc3RhdGljIHRleHRDb2xvclNlY29uZGFyeUhleCA9ICcjODg4ODg4JzsKICAgIHN0YXRpYyBzYW5zU2VyaWZGb250RmFtaWx5ID0gJy1hcHBsZS1zeXN0ZW0sIEJsaW5rTWFjU3lzdGVtRm9udCwgYXZlbmlyIG5leHQsIGF2ZW5pciwgaGVsdmV0aWNhIG5ldWUsIGhlbHZldGljYSwgVWJ1bnR1LCByb2JvdG8sIG5vdG8sIHNlZ29lIHVpLCBhcmlhbCwgc2Fucy1zZXJpZic7CiAgICBzdGF0aWMgbW9ub3NwYWNlRm9udEZhbWlseSA9ICdNZW5sbywgIlNGIE1vbm8iLCAiQW5kYWxlIE1vbm8iLCAiUm9ib3RvIE1vbm8iLCBNb25hY28sIG1vbm9zcGFjZSc7Cn0KZnVuY3Rpb24gaXNQb2RjYXN0SW1hZ2VzU3JjU2V0KHRyaW1tZWRUZXh0KSB7CiAgICBjb25zdCB3aWR0aHMgPSBuZXcgU2V0KCk7CiAgICBjb25zdCBkZW5zaXRpZXMgPSBuZXcgU2V0KCk7CiAgICBsZXQgd2l0aFdpZHRoQ291bnQgPSAwOwogICAgY29uc3QgcGllY2VzID0gdHJpbW1lZFRleHQuc3BsaXQoLyxccysvKTsKICAgIGZvciAoY29uc3QgcGllY2Ugb2YgcGllY2VzKXsKICAgICAgICBjb25zdCBtID0gL14oW15cc10rKShccysoXGQrd3xcZCsoXC5cZCspP3gpKT8kLy5leGVjKHBpZWNlKTsKICAgICAgICBpZiAoIW0pIHJldHVybiBmYWxzZTsKICAgICAgICBjb25zdCB1cmwgPSBtWzFdOwogICAgICAgIGNvbnN0IGRlc2NyaXB0b3IgPSBtWzNdIHx8ICcnOwogICAgICAgIGlmICghaXNVcmwodXJsKSkgcmV0dXJuIGZhbHNlOwogICAgICAgIGlmIChkZXNjcmlwdG9yLmVuZHNXaXRoKCd3JykpIHsKICAgICAgICAgICAgd2l0aFdpZHRoQ291bnQrKzsKICAgICAgICAgICAgY29uc3Qgd2lkdGggPSBwYXJzZUludChkZXNjcmlwdG9yLnN1YnN0cmluZygwLCBkZXNjcmlwdG9yLmxlbmd0aCAtIDEpKTsKICAgICAgICAgICAgaWYgKHdpZHRoIDw9IDApIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgaWYgKHdpZHRocy5oYXMod2lkdGgpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHdpZHRocy5hZGQod2lkdGgpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGRlbnNpdHkgPSBkZXNjcmlwdG9yLmVuZHNXaXRoKCd4JykgPyBwYXJzZUZsb2F0KGRlc2NyaXB0b3Iuc3Vic3RyaW5nKDAsIGRlc2NyaXB0b3IubGVuZ3RoIC0gMSkpIDogMTsKICAgICAgICAgICAgaWYgKGRlbnNpdHkgPD0gMCkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBpZiAoZGVuc2l0aWVzLmhhcyhkZW5zaXR5KSkgcmV0dXJuIGZhbHNlOwogICAgICAgICAgICBkZW5zaXRpZXMuYWRkKGRlbnNpdHkpOwogICAgICAgIH0KICAgIH0KICAgIGlmICh3aXRoV2lkdGhDb3VudCA+IDAgJiYgd2l0aFdpZHRoQ291bnQgIT09IHBpZWNlcy5sZW5ndGgpIHJldHVybiBmYWxzZTsKICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIGlzTm90RW1wdHkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cmltbWVkVGV4dC5sZW5ndGggPiAwOwp9CmZ1bmN0aW9uIGlzVXJsKHRyaW1tZWRUZXh0KSB7CiAgICBjb25zdCB1ID0gdHJ5UGFyc2VVcmwodHJpbW1lZFRleHQpOwogICAgcmV0dXJuIHUgJiYgdS5wcm90b2NvbCA9PT0gJ2h0dHBzOicgfHwgdT8ucHJvdG9jb2wgPT09ICdodHRwOic7Cn0KZnVuY3Rpb24gaXNVcmkodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiB0cnlQYXJzZVVybCh0cmltbWVkVGV4dCkgIT09IHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBpc01pbWVUeXBlKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15cdytcL1stKy5cd10rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNVdWlkKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bMC05YS1mXXs4fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXs0fS1bMC05YS1mXXsxMn0kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0VtYWlsQWRkcmVzcyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW15AXHNdK0BbXkBcc10rJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNBdE1vc3RDaGFyYWN0ZXJzKG1heENoYXJhY3RlcnMpIHsKICAgIHJldHVybiAodHJpbW1lZFRleHQpPT50cmltbWVkVGV4dC5sZW5ndGggPD0gbWF4Q2hhcmFjdGVycwogICAgOwp9CmZ1bmN0aW9uIGlzU2Vjb25kcyh0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eXGQrKFwuXGQrKT8kLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0dlb0xhdExvbih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eZ2VvOi0/XGR7MSwyfShcLlxkKyk/LC0/XGR7MSwzfShcLlxkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcih0cmltbWVkVGV4dCkgewogICAgcmV0dXJuIC9eW05XUl1cZCsoI1xkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNOb25OZWdhdGl2ZUludGVnZXIodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkKyQvLnRlc3QodHJpbW1lZFRleHQpICYmIHBhcnNlSW50KHRyaW1tZWRUZXh0KSA+PSAwICYmIHBhcnNlSW50KHRyaW1tZWRUZXh0KS50b1N0cmluZygpID09PSB0cmltbWVkVGV4dDsKfQpmdW5jdGlvbiBpc0RlY2ltYWwodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkKyhcLlxkKyk/JC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNSZmMyODIyKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bMC05QS1aYS16OiAtXSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc0lzbzg2MDEodHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlxkezR9LVxkezJ9LVxkezJ9VFxkezJ9OlxkezJ9OlxkezJ9KFwuXGQrKT9aJC8udGVzdCh0cmltbWVkVGV4dCk7Cn0KZnVuY3Rpb24gaXNCb29sZWFuKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL14odHJ1ZXxmYWxzZSkkLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKHRyaW1tZWRUZXh0KSB7CiAgICByZXR1cm4gL15bYS16XSskLy50ZXN0KHRyaW1tZWRUZXh0KTsKfQpmdW5jdGlvbiBpc1BvZGNhc3RNZWRpdW0odHJpbW1lZFRleHQpIHsKICAgIHJldHVybiAvXlthLXpdKyQvLnRlc3QodHJpbW1lZFRleHQpOwp9CmZ1bmN0aW9uIHRyeVBhcnNlVXJsKHN0ciwgYmFzZSkgewogICAgdHJ5IHsKICAgICAgICByZXR1cm4gbmV3IFVSTChzdHIsIGJhc2UpOwogICAgfSBjYXRjaCAgewogICAgICAgIHJldHVybiB1bmRlZmluZWQ7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tNYXRjaGVzKG5hbWUsIHZhbHVlLCBwYXR0ZXJuKSB7CiAgICBpZiAoIXBhdHRlcm4udGVzdCh2YWx1ZSkpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9YCk7CiAgICByZXR1cm4gdmFsdWU7Cn0KZnVuY3Rpb24gY2hlY2tFcXVhbChuYW1lLCB2YWx1ZSwgZXhwZWN0ZWQpIHsKICAgIGlmICh2YWx1ZSAhPT0gZXhwZWN0ZWQpIHRocm93IG5ldyBFcnJvcihgQmFkICR7bmFtZX06ICR7dmFsdWV9LCBleHBlY3RlZCAke2V4cGVjdGVkfWApOwp9CmZ1bmN0aW9uIGNoZWNrVHJ1ZShuYW1lLCB2YWx1ZSwgdGVzdCkgewogICAgaWYgKCF0ZXN0KSB0aHJvdyBuZXcgRXJyb3IoYEJhZCAke25hbWV9OiAke3ZhbHVlfWApOwp9CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFID0gJ2h0dHBzOi8vcG9kY2FzdGluZGV4Lm9yZy9uYW1lc3BhY2UvMS4wJzsKY29uc3QgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfQUxUID0gJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0tOT1dOX01JU1NQRUxMSU5HID0gJ2h0dHBzOi8vcG9kY2FzdGluZGV4Lm9yZy9uYW1lc3BhY2UvMS4wLyc7CmNvbnN0IFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFUyA9IFsKICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFLAogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfQUxULAogICAgUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VfS05PV05fTUlTU1BFTExJTkcKXTsKY29uc3QgUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUyA9IG5ldyBTZXQoKTsKZnVuY3Rpb24gX3BvZGNhc3RJbmRleChuYW1lLCBrbm93biA9IHRydWUpIHsKICAgIGlmIChrbm93bikgUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUy5hZGQobmFtZSk7CiAgICByZXR1cm4gUE9EQ0FTVF9JTkRFWF9OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWUsCiAgICAgICAgICAgIG5hbWVzcGFjZVVyaTogdgogICAgICAgIH0pCiAgICApOwp9CmNvbnN0IE1FRElBX1JTU19OQU1FU1BBQ0UgPSAnaHR0cDovL3NlYXJjaC55YWhvby5jb20vbXJzcy8nOwpmdW5jdGlvbiBfbWVkaWFSc3MobmFtZSkgewogICAgcmV0dXJuIHsKICAgICAgICBuYW1lLAogICAgICAgIG5hbWVzcGFjZVVyaTogTUVESUFfUlNTX05BTUVTUEFDRQogICAgfTsKfQpjbGFzcyBRbmFtZXMgewogICAgc3RhdGljIFBvZGNhc3RJbmRleCA9IHsKICAgICAgICBOQU1FU1BBQ0VTOiBQT0RDQVNUX0lOREVYX05BTUVTUEFDRVMsCiAgICAgICAgS05PV05fTUlTU1BFTExFRF9OQU1FU1BBQ0VTOiBbCiAgICAgICAgICAgIFBPRENBU1RfSU5ERVhfTkFNRVNQQUNFX0tOT1dOX01JU1NQRUxMSU5HCiAgICAgICAgXSwKICAgICAgICBnZXQgS05PV05fTkFNRVMgKCkgewogICAgICAgICAgICByZXR1cm4gUE9EQ0FTVF9JTkRFWF9LTk9XTl9OQU1FUzsKICAgICAgICB9LAogICAgICAgIG9mOiAobmFtZSk9Pl9wb2RjYXN0SW5kZXgobmFtZSwgZmFsc2UpCiAgICAgICAgLAogICAgICAgIGFsdGVybmF0ZUVuY2xvc3VyZTogX3BvZGNhc3RJbmRleCgnYWx0ZXJuYXRlRW5jbG9zdXJlJyksCiAgICAgICAgY2hhcHRlcnM6IF9wb2RjYXN0SW5kZXgoJ2NoYXB0ZXJzJyksCiAgICAgICAgZXBpc29kZTogX3BvZGNhc3RJbmRleCgnZXBpc29kZScpLAogICAgICAgIGZ1bmRpbmc6IF9wb2RjYXN0SW5kZXgoJ2Z1bmRpbmcnKSwKICAgICAgICBndWlkOiBfcG9kY2FzdEluZGV4KCdndWlkJyksCiAgICAgICAgaGl2ZUFjY291bnQ6IF9wb2RjYXN0SW5kZXgoJ2hpdmVBY2NvdW50JyksCiAgICAgICAgaW1hZ2VzOiBfcG9kY2FzdEluZGV4KCdpbWFnZXMnKSwKICAgICAgICBpbnRlZ3JpdHk6IF9wb2RjYXN0SW5kZXgoJ2ludGVncml0eScpLAogICAgICAgIGxpY2Vuc2U6IF9wb2RjYXN0SW5kZXgoJ2xpY2Vuc2UnKSwKICAgICAgICBsb2NhdGlvbjogX3BvZGNhc3RJbmRleCgnbG9jYXRpb24nKSwKICAgICAgICBsb2NrZWQ6IF9wb2RjYXN0SW5kZXgoJ2xvY2tlZCcpLAogICAgICAgIG1lZGl1bTogX3BvZGNhc3RJbmRleCgnbWVkaXVtJyksCiAgICAgICAgcGVyc29uOiBfcG9kY2FzdEluZGV4KCdwZXJzb24nKSwKICAgICAgICBwb2RwaW5nOiBfcG9kY2FzdEluZGV4KCdwb2RwaW5nJyksCiAgICAgICAgc2Vhc29uOiBfcG9kY2FzdEluZGV4KCdzZWFzb24nKSwKICAgICAgICBzb2NpYWw6IF9wb2RjYXN0SW5kZXgoJ3NvY2lhbCcpLAogICAgICAgIHNvY2lhbEludGVyYWN0OiBfcG9kY2FzdEluZGV4KCdzb2NpYWxJbnRlcmFjdCcpLAogICAgICAgIHNvY2lhbFNpZ25VcDogX3BvZGNhc3RJbmRleCgnc29jaWFsU2lnblVwJyksCiAgICAgICAgc291bmRiaXRlOiBfcG9kY2FzdEluZGV4KCdzb3VuZGJpdGUnKSwKICAgICAgICBzb3VyY2U6IF9wb2RjYXN0SW5kZXgoJ3NvdXJjZScpLAogICAgICAgIHRyYWlsZXI6IF9wb2RjYXN0SW5kZXgoJ3RyYWlsZXInKSwKICAgICAgICB0cmFuc2NyaXB0OiBfcG9kY2FzdEluZGV4KCd0cmFuc2NyaXB0JyksCiAgICAgICAgdmFsdWU6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlJyksCiAgICAgICAgdmFsdWVSZWNpcGllbnQ6IF9wb2RjYXN0SW5kZXgoJ3ZhbHVlUmVjaXBpZW50JykKICAgIH07CiAgICBzdGF0aWMgTWVkaWFSc3MgPSB7CiAgICAgICAgTkFNRVNQQUNFOiBNRURJQV9SU1NfTkFNRVNQQUNFLAogICAgICAgIG9mOiAobmFtZSk9Pl9tZWRpYVJzcyhuYW1lKQogICAgICAgICwKICAgICAgICBjb250ZW50OiBfbWVkaWFSc3MoJ2NvbnRlbnQnKQogICAgfTsKfQpjb25zdCBoZXhSZWdleCA9IC9eWy0rXT8weFthLWZBLUYwLTldKyQvOwpjb25zdCBudW1SZWdleCA9IC9eKFtcLVwrXSk/KDAqKShcLlswLTldKyhbZUVdXC0/WzAtOV0rKT98WzAtOV0rKFwuWzAtOV0rKFtlRV1cLT9bMC05XSspPyk/KSQvOwpjb25zdCBjb25zaWRlciA9IHsKICAgIGhleDogdHJ1ZSwKICAgIGxlYWRpbmdaZXJvczogdHJ1ZSwKICAgIGRlY2ltYWxQb2ludDogIi4iCn07CmZ1bmN0aW9uIHRvTnVtYmVyKHN0ciwgb3B0aW9ucyA9IHsKfSkgewogICAgb3B0aW9ucyA9IE9iamVjdC5hc3NpZ24oewogICAgfSwgY29uc2lkZXIsIG9wdGlvbnMpOwogICAgaWYgKCFzdHIgfHwgdHlwZW9mIHN0ciAhPT0gInN0cmluZyIpIHJldHVybiBzdHI7CiAgICBsZXQgdHJpbW1lZFN0ciA9IHN0ci50cmltKCk7CiAgICBpZiAob3B0aW9ucy5za2lwTGlrZSAhPT0gdm9pZCAwICYmIG9wdGlvbnMuc2tpcExpa2UudGVzdCh0cmltbWVkU3RyKSkgcmV0dXJuIHN0cjsKICAgIGVsc2UgaWYgKG9wdGlvbnMuaGV4ICYmIGhleFJlZ2V4LnRlc3QodHJpbW1lZFN0cikpIHsKICAgICAgICByZXR1cm4gTnVtYmVyLnBhcnNlSW50KHRyaW1tZWRTdHIsIDE2KTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3QgbWF0Y2ggPSBudW1SZWdleC5leGVjKHRyaW1tZWRTdHIpOwogICAgICAgIGlmIChtYXRjaCkgewogICAgICAgICAgICBtYXRjaFsxXTsKICAgICAgICAgICAgY29uc3QgbGVhZGluZ1plcm9zID0gbWF0Y2hbMl07CiAgICAgICAgICAgIGNvbnN0IG51bSA9IG1hdGNoWzNdOwogICAgICAgICAgICBtYXRjaFs0XSB8fCBtYXRjaFs2XTsKICAgICAgICAgICAgaWYgKGxlYWRpbmdaZXJvcy5sZW5ndGggPT09IDEgJiYgbnVtWzBdID09PSAiLiIpIHJldHVybiBOdW1iZXIoc3RyKTsKICAgICAgICAgICAgZWxzZSBpZiAoIW9wdGlvbnMubGVhZGluZ1plcm9zICYmIGxlYWRpbmdaZXJvcy5sZW5ndGggPiAwKSByZXR1cm4gc3RyOwogICAgICAgICAgICBlbHNlIHJldHVybiBOdW1iZXIodHJpbW1lZFN0cik7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9CiAgICB9Cn0KdmFyIHN0cm51bSA9IHRvTnVtYmVyOwpmdW5jdGlvbiBjcmVhdGVDb21tb25qc01vZHVsZShmbiwgYmFzZWRpciwgbW9kdWxlKSB7CiAgICByZXR1cm4gbW9kdWxlID0gewogICAgICAgIHBhdGg6IGJhc2VkaXIsCiAgICAgICAgZXhwb3J0czogewogICAgICAgIH0sCiAgICAgICAgcmVxdWlyZTogZnVuY3Rpb24ocGF0aCwgYmFzZSkgewogICAgICAgICAgICByZXR1cm4gY29tbW9uanNSZXF1aXJlKHBhdGgsIGJhc2UgPT09IHZvaWQgMCB8fCBiYXNlID09PSBudWxsID8gbW9kdWxlLnBhdGggOiBiYXNlKTsKICAgICAgICB9CiAgICB9LCBmbihtb2R1bGUsIG1vZHVsZS5leHBvcnRzKSwgbW9kdWxlLmV4cG9ydHM7Cn0KZnVuY3Rpb24gY29tbW9uanNSZXF1aXJlKCkgewogICAgdGhyb3cgbmV3IEVycm9yKCJEeW5hbWljIHJlcXVpcmVzIGFyZSBub3QgY3VycmVudGx5IHN1cHBvcnRlZCBieSBAcm9sbHVwL3BsdWdpbi1jb21tb25qcyIpOwp9CnZhciB1dGlsID0gY3JlYXRlQ29tbW9uanNNb2R1bGUoZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7CiAgICBjb25zdCBuYW1lU3RhcnRDaGFyID0gIjpBLVphLXpfXFx1MDBDMC1cXHUwMEQ2XFx1MDBEOC1cXHUwMEY2XFx1MDBGOC1cXHUwMkZGXFx1MDM3MC1cXHUwMzdEXFx1MDM3Ri1cXHUxRkZGXFx1MjAwQy1cXHUyMDBEXFx1MjA3MC1cXHUyMThGXFx1MkMwMC1cXHUyRkVGXFx1MzAwMS1cXHVEN0ZGXFx1RjkwMC1cXHVGRENGXFx1RkRGMC1cXHVGRkZEIjsKICAgIGNvbnN0IG5hbWVDaGFyID0gbmFtZVN0YXJ0Q2hhciArICJcXC0uXFxkXFx1MDBCN1xcdTAzMDAtXFx1MDM2RlxcdTIwM0YtXFx1MjA0MCI7CiAgICBjb25zdCBuYW1lUmVnZXhwID0gIlsiICsgbmFtZVN0YXJ0Q2hhciArICJdWyIgKyBuYW1lQ2hhciArICJdKiI7CiAgICBjb25zdCByZWdleE5hbWUgPSBuZXcgUmVnRXhwKCJeIiArIG5hbWVSZWdleHAgKyAiJCIpOwogICAgY29uc3QgZ2V0QWxsTWF0Y2hlcyA9IGZ1bmN0aW9uKHN0cmluZywgcmVnZXgpIHsKICAgICAgICBjb25zdCBtYXRjaGVzID0gW107CiAgICAgICAgbGV0IG1hdGNoID0gcmVnZXguZXhlYyhzdHJpbmcpOwogICAgICAgIHdoaWxlKG1hdGNoKXsKICAgICAgICAgICAgY29uc3QgYWxsbWF0Y2hlcyA9IFtdOwogICAgICAgICAgICBhbGxtYXRjaGVzLnN0YXJ0SW5kZXggPSByZWdleC5sYXN0SW5kZXggLSBtYXRjaFswXS5sZW5ndGg7CiAgICAgICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwgbGVuOyBpbmRleCsrKXsKICAgICAgICAgICAgICAgIGFsbG1hdGNoZXMucHVzaChtYXRjaFtpbmRleF0pOwogICAgICAgICAgICB9CiAgICAgICAgICAgIG1hdGNoZXMucHVzaChhbGxtYXRjaGVzKTsKICAgICAgICAgICAgbWF0Y2ggPSByZWdleC5leGVjKHN0cmluZyk7CiAgICAgICAgfQogICAgICAgIHJldHVybiBtYXRjaGVzOwogICAgfTsKICAgIGNvbnN0IGlzTmFtZSA9IGZ1bmN0aW9uKHN0cmluZykgewogICAgICAgIGNvbnN0IG1hdGNoID0gcmVnZXhOYW1lLmV4ZWMoc3RyaW5nKTsKICAgICAgICByZXR1cm4gIShtYXRjaCA9PT0gbnVsbCB8fCB0eXBlb2YgbWF0Y2ggPT09ICJ1bmRlZmluZWQiKTsKICAgIH07CiAgICBleHBvcnRzLmlzRXhpc3QgPSBmdW5jdGlvbih2KSB7CiAgICAgICAgcmV0dXJuIHR5cGVvZiB2ICE9PSAidW5kZWZpbmVkIjsKICAgIH07CiAgICBleHBvcnRzLmlzRW1wdHlPYmplY3QgPSBmdW5jdGlvbihvYmopIHsKICAgICAgICByZXR1cm4gT2JqZWN0LmtleXMob2JqKS5sZW5ndGggPT09IDA7CiAgICB9OwogICAgZXhwb3J0cy5tZXJnZSA9IGZ1bmN0aW9uKHRhcmdldCwgYSwgYXJyYXlNb2RlKSB7CiAgICAgICAgaWYgKGEpIHsKICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGEpOwogICAgICAgICAgICBjb25zdCBsZW4gPSBrZXlzLmxlbmd0aDsKICAgICAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgICAgIGlmIChhcnJheU1vZGUgPT09ICJzdHJpY3QiKSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gWwogICAgICAgICAgICAgICAgICAgICAgICBhW2tleXNbaV1dCiAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgdGFyZ2V0W2tleXNbaV1dID0gYVtrZXlzW2ldXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmdldFZhbHVlID0gZnVuY3Rpb24odikgewogICAgICAgIGlmIChleHBvcnRzLmlzRXhpc3QodikpIHsKICAgICAgICAgICAgcmV0dXJuIHY7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgIH07CiAgICBleHBvcnRzLmJ1aWxkT3B0aW9ucyA9IGZ1bmN0aW9uKG9wdGlvbnMsIGRlZmF1bHRPcHRpb25zMiwgcHJvcHMyKSB7CiAgICAgICAgbGV0IG5ld09wdGlvbnMgPSB7CiAgICAgICAgfTsKICAgICAgICBpZiAoIW9wdGlvbnMpIHsKICAgICAgICAgICAgcmV0dXJuIGRlZmF1bHRPcHRpb25zMjsKICAgICAgICB9CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IHByb3BzMi5sZW5ndGg7IGkrKyl7CiAgICAgICAgICAgIGlmIChvcHRpb25zW3Byb3BzMltpXV0gIT09IHZvaWQgMCkgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gb3B0aW9uc1twcm9wczJbaV1dOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgbmV3T3B0aW9uc1twcm9wczJbaV1dID0gZGVmYXVsdE9wdGlvbnMyW3Byb3BzMltpXV07CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIG5ld09wdGlvbnM7CiAgICB9OwogICAgZXhwb3J0cy5pc1RhZ05hbWVJbkFycmF5TW9kZSA9IGZ1bmN0aW9uKHRhZ05hbWUsIGFycmF5TW9kZSwgcGFyZW50VGFnTmFtZSkgewogICAgICAgIGlmIChhcnJheU1vZGUgPT09IGZhbHNlKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9IGVsc2UgaWYgKGFycmF5TW9kZSBpbnN0YW5jZW9mIFJlZ0V4cCkgewogICAgICAgICAgICByZXR1cm4gYXJyYXlNb2RlLnRlc3QodGFnTmFtZSk7CiAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgYXJyYXlNb2RlID09PSAiZnVuY3Rpb24iKSB7CiAgICAgICAgICAgIHJldHVybiAhIWFycmF5TW9kZSh0YWdOYW1lLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIGFycmF5TW9kZSA9PT0gInN0cmljdCI7CiAgICB9OwogICAgZXhwb3J0cy5pc05hbWUgPSBpc05hbWU7CiAgICBleHBvcnRzLmdldEFsbE1hdGNoZXMgPSBnZXRBbGxNYXRjaGVzOwogICAgZXhwb3J0cy5uYW1lUmVnZXhwID0gbmFtZVJlZ2V4cDsKfSk7CmNvbnN0IGNvbnZlcnRUb0pzb24gPSBmdW5jdGlvbihub2RlLCBvcHRpb25zLCBwYXJlbnRUYWdOYW1lKSB7CiAgICBjb25zdCBqT2JqID0gewogICAgfTsKICAgIGlmICghb3B0aW9ucy5hbHdheXNDcmVhdGVUZXh0Tm9kZSAmJiAoIW5vZGUuY2hpbGQgfHwgdXRpbC5pc0VtcHR5T2JqZWN0KG5vZGUuY2hpbGQpKSAmJiAoIW5vZGUuYXR0cnNNYXAgfHwgdXRpbC5pc0VtcHR5T2JqZWN0KG5vZGUuYXR0cnNNYXApKSkgewogICAgICAgIHJldHVybiB1dGlsLmlzRXhpc3Qobm9kZS52YWwpID8gbm9kZS52YWwgOiAiIjsKICAgIH0KICAgIGlmICh1dGlsLmlzRXhpc3Qobm9kZS52YWwpICYmICEodHlwZW9mIG5vZGUudmFsID09PSAic3RyaW5nIiAmJiAobm9kZS52YWwgPT09ICIiIHx8IG5vZGUudmFsID09PSBvcHRpb25zLmNkYXRhUG9zaXRpb25DaGFyKSkpIHsKICAgICAgICBjb25zdCBhc0FycmF5ID0gdXRpbC5pc1RhZ05hbWVJbkFycmF5TW9kZShub2RlLnRhZ25hbWUsIG9wdGlvbnMuYXJyYXlNb2RlLCBwYXJlbnRUYWdOYW1lKTsKICAgICAgICBqT2JqW29wdGlvbnMudGV4dE5vZGVOYW1lXSA9IGFzQXJyYXkgPyBbCiAgICAgICAgICAgIG5vZGUudmFsCiAgICAgICAgXSA6IG5vZGUudmFsOwogICAgfQogICAgdXRpbC5tZXJnZShqT2JqLCBub2RlLmF0dHJzTWFwLCBvcHRpb25zLmFycmF5TW9kZSk7CiAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMobm9kZS5jaGlsZCk7CiAgICBmb3IobGV0IGluZGV4ID0gMDsgaW5kZXggPCBrZXlzLmxlbmd0aDsgaW5kZXgrKyl7CiAgICAgICAgY29uc3QgdGFnTmFtZSA9IGtleXNbaW5kZXhdOwogICAgICAgIGlmIChub2RlLmNoaWxkW3RhZ05hbWVdICYmIG5vZGUuY2hpbGRbdGFnTmFtZV0ubGVuZ3RoID4gMSkgewogICAgICAgICAgICBqT2JqW3RhZ05hbWVdID0gW107CiAgICAgICAgICAgIGZvcihsZXQgdGFnIGluIG5vZGUuY2hpbGRbdGFnTmFtZV0pewogICAgICAgICAgICAgICAgaWYgKG5vZGUuY2hpbGRbdGFnTmFtZV0uaGFzT3duUHJvcGVydHkodGFnKSkgewogICAgICAgICAgICAgICAgICAgIGpPYmpbdGFnTmFtZV0ucHVzaChjb252ZXJ0VG9Kc29uKG5vZGUuY2hpbGRbdGFnTmFtZV1bdGFnXSwgb3B0aW9ucywgdGFnTmFtZSkpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gY29udmVydFRvSnNvbihub2RlLmNoaWxkW3RhZ05hbWVdWzBdLCBvcHRpb25zLCB0YWdOYW1lKTsKICAgICAgICAgICAgY29uc3QgYXNBcnJheSA9IG9wdGlvbnMuYXJyYXlNb2RlID09PSB0cnVlICYmIHR5cGVvZiByZXN1bHQgPT09ICJvYmplY3QiIHx8IHV0aWwuaXNUYWdOYW1lSW5BcnJheU1vZGUodGFnTmFtZSwgb3B0aW9ucy5hcnJheU1vZGUsIHBhcmVudFRhZ05hbWUpOwogICAgICAgICAgICBqT2JqW3RhZ05hbWVdID0gYXNBcnJheSA/IFsKICAgICAgICAgICAgICAgIHJlc3VsdAogICAgICAgICAgICBdIDogcmVzdWx0OwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBqT2JqOwp9Owp2YXIgY29udmVydFRvSnNvbl8xID0gY29udmVydFRvSnNvbjsKdmFyIG5vZGUyanNvbiA9IHsKICAgIGNvbnZlcnRUb0pzb246IGNvbnZlcnRUb0pzb25fMQp9Owp2YXIgeG1sTm9kZSA9IGZ1bmN0aW9uKHRhZ25hbWUsIHBhcmVudCwgdmFsKSB7CiAgICB0aGlzLnRhZ25hbWUgPSB0YWduYW1lOwogICAgdGhpcy5wYXJlbnQgPSBwYXJlbnQ7CiAgICB0aGlzLmNoaWxkID0gewogICAgfTsKICAgIHRoaXMuYXR0cnNNYXAgPSB7CiAgICB9OwogICAgdGhpcy52YWwgPSB2YWw7CiAgICB0aGlzLmFkZENoaWxkID0gZnVuY3Rpb24oY2hpbGQpIHsKICAgICAgICBpZiAoQXJyYXkuaXNBcnJheSh0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdKSkgewogICAgICAgICAgICB0aGlzLmNoaWxkW2NoaWxkLnRhZ25hbWVdLnB1c2goY2hpbGQpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRoaXMuY2hpbGRbY2hpbGQudGFnbmFtZV0gPSBbCiAgICAgICAgICAgICAgICBjaGlsZAogICAgICAgICAgICBdOwogICAgICAgIH0KICAgIH07Cn07CmNvbnN0IGJ1aWxkT3B0aW9ucyA9IHV0aWwuYnVpbGRPcHRpb25zOwoiPCgoIVxcW0NEQVRBXFxbKFtcXHNcXFNdKj8pKF1dPikpfCgoTkFNRTopPyhOQU1FKSkoW14+XSopPnwoKFxcLykoTkFNRSlcXHMqPikpKFtePF0qKSIucmVwbGFjZSgvTkFNRS9nLCB1dGlsLm5hbWVSZWdleHApOwppZiAoIU51bWJlci5wYXJzZUludCAmJiB3aW5kb3cucGFyc2VJbnQpIHsKICAgIE51bWJlci5wYXJzZUludCA9IHdpbmRvdy5wYXJzZUludDsKfQppZiAoIU51bWJlci5wYXJzZUZsb2F0ICYmIHdpbmRvdy5wYXJzZUZsb2F0KSB7CiAgICBOdW1iZXIucGFyc2VGbG9hdCA9IHdpbmRvdy5wYXJzZUZsb2F0Owp9CmNvbnN0IGRlZmF1bHRPcHRpb25zID0gewogICAgYXR0cmlidXRlTmFtZVByZWZpeDogIkBfIiwKICAgIGF0dHJOb2RlTmFtZTogZmFsc2UsCiAgICB0ZXh0Tm9kZU5hbWU6ICIjdGV4dCIsCiAgICBpZ25vcmVBdHRyaWJ1dGVzOiB0cnVlLAogICAgaWdub3JlTmFtZVNwYWNlOiBmYWxzZSwKICAgIGFsbG93Qm9vbGVhbkF0dHJpYnV0ZXM6IGZhbHNlLAogICAgcGFyc2VOb2RlVmFsdWU6IHRydWUsCiAgICBwYXJzZUF0dHJpYnV0ZVZhbHVlOiBmYWxzZSwKICAgIGFycmF5TW9kZTogZmFsc2UsCiAgICB0cmltVmFsdWVzOiB0cnVlLAogICAgY2RhdGFUYWdOYW1lOiBmYWxzZSwKICAgIGNkYXRhUG9zaXRpb25DaGFyOiAiXFxjIiwKICAgIG51bVBhcnNlT3B0aW9uczogewogICAgICAgIGhleDogdHJ1ZSwKICAgICAgICBsZWFkaW5nWmVyb3M6IHRydWUKICAgIH0sCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgdGFnTmFtZSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSwgYXR0ck5hbWUpIHsKICAgICAgICByZXR1cm4gYTsKICAgIH0sCiAgICBzdG9wTm9kZXM6IFtdLAogICAgYWx3YXlzQ3JlYXRlVGV4dE5vZGU6IGZhbHNlCn07CnZhciBkZWZhdWx0T3B0aW9uc18xID0gZGVmYXVsdE9wdGlvbnM7CmNvbnN0IHByb3BzID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJpZ25vcmVOYW1lU3BhY2UiLAogICAgImFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMiLAogICAgInBhcnNlTm9kZVZhbHVlIiwKICAgICJwYXJzZUF0dHJpYnV0ZVZhbHVlIiwKICAgICJhcnJheU1vZGUiLAogICAgInRyaW1WYWx1ZXMiLAogICAgImNkYXRhVGFnTmFtZSIsCiAgICAiY2RhdGFQb3NpdGlvbkNoYXIiLAogICAgInRhZ1ZhbHVlUHJvY2Vzc29yIiwKICAgICJhdHRyVmFsdWVQcm9jZXNzb3IiLAogICAgInBhcnNlVHJ1ZU51bWJlck9ubHkiLAogICAgIm51bVBhcnNlT3B0aW9ucyIsCiAgICAic3RvcE5vZGVzIiwKICAgICJhbHdheXNDcmVhdGVUZXh0Tm9kZSIKXTsKdmFyIHByb3BzXzEgPSBwcm9wczsKZnVuY3Rpb24gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHZhbCwgb3B0aW9ucykgewogICAgaWYgKHZhbCkgewogICAgICAgIGlmIChvcHRpb25zLnRyaW1WYWx1ZXMpIHsKICAgICAgICAgICAgdmFsID0gdmFsLnRyaW0oKTsKICAgICAgICB9CiAgICAgICAgdmFsID0gb3B0aW9ucy50YWdWYWx1ZVByb2Nlc3Nvcih2YWwsIHRhZ05hbWUpOwogICAgICAgIHZhbCA9IHBhcnNlVmFsdWUodmFsLCBvcHRpb25zLnBhcnNlTm9kZVZhbHVlLCBvcHRpb25zLm51bVBhcnNlT3B0aW9ucyk7CiAgICB9CiAgICByZXR1cm4gdmFsOwp9CmZ1bmN0aW9uIHJlc29sdmVOYW1lU3BhY2UodGFnbmFtZSwgb3B0aW9ucykgewogICAgaWYgKG9wdGlvbnMuaWdub3JlTmFtZVNwYWNlKSB7CiAgICAgICAgY29uc3QgdGFncyA9IHRhZ25hbWUuc3BsaXQoIjoiKTsKICAgICAgICBjb25zdCBwcmVmaXggPSB0YWduYW1lLmNoYXJBdCgwKSA9PT0gIi8iID8gIi8iIDogIiI7CiAgICAgICAgaWYgKHRhZ3NbMF0gPT09ICJ4bWxucyIpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH0KICAgICAgICBpZiAodGFncy5sZW5ndGggPT09IDIpIHsKICAgICAgICAgICAgdGFnbmFtZSA9IHByZWZpeCArIHRhZ3NbMV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHRhZ25hbWU7Cn0KZnVuY3Rpb24gcGFyc2VWYWx1ZSh2YWwsIHNob3VsZFBhcnNlLCBvcHRpb25zKSB7CiAgICBpZiAoc2hvdWxkUGFyc2UgJiYgdHlwZW9mIHZhbCA9PT0gInN0cmluZyIpIHsKICAgICAgICBjb25zdCBuZXd2YWwgPSB2YWwudHJpbSgpOwogICAgICAgIGlmIChuZXd2YWwgPT09ICJ0cnVlIikgcmV0dXJuIHRydWU7CiAgICAgICAgZWxzZSBpZiAobmV3dmFsID09PSAiZmFsc2UiKSByZXR1cm4gZmFsc2U7CiAgICAgICAgZWxzZSByZXR1cm4gc3RybnVtKHZhbCwgb3B0aW9ucyk7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3QodmFsKSkgewogICAgICAgICAgICByZXR1cm4gdmFsOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiAiIjsKICAgICAgICB9CiAgICB9Cn0KY29uc3QgYXR0cnNSZWd4ID0gbmV3IFJlZ0V4cChgKFteXFxzPV0rKVxccyooPVxccyooWyciXSkoLio/KVxcMyk/YCwgImciKTsKZnVuY3Rpb24gYnVpbGRBdHRyaWJ1dGVzTWFwKGF0dHJTdHIsIG9wdGlvbnMpIHsKICAgIGlmICghb3B0aW9ucy5pZ25vcmVBdHRyaWJ1dGVzICYmIHR5cGVvZiBhdHRyU3RyID09PSAic3RyaW5nIikgewogICAgICAgIGF0dHJTdHIgPSBhdHRyU3RyLnJlcGxhY2UoL1xyP1xuL2csICIgIik7CiAgICAgICAgY29uc3QgbWF0Y2hlcyA9IHV0aWwuZ2V0QWxsTWF0Y2hlcyhhdHRyU3RyLCBhdHRyc1JlZ3gpOwogICAgICAgIGNvbnN0IGxlbiA9IG1hdGNoZXMubGVuZ3RoOwogICAgICAgIGNvbnN0IGF0dHJzID0gewogICAgICAgIH07CiAgICAgICAgZm9yKGxldCBpID0gMDsgaSA8IGxlbjsgaSsrKXsKICAgICAgICAgICAgY29uc3QgYXR0ck5hbWUgPSByZXNvbHZlTmFtZVNwYWNlKG1hdGNoZXNbaV1bMV0sIG9wdGlvbnMpOwogICAgICAgICAgICBpZiAoYXR0ck5hbWUubGVuZ3RoKSB7CiAgICAgICAgICAgICAgICBpZiAobWF0Y2hlc1tpXVs0XSAhPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMudHJpbVZhbHVlcykgewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaGVzW2ldWzRdID0gbWF0Y2hlc1tpXVs0XS50cmltKCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIG1hdGNoZXNbaV1bNF0gPSBvcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcihtYXRjaGVzW2ldWzRdLCBhdHRyTmFtZSk7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gcGFyc2VWYWx1ZShtYXRjaGVzW2ldWzRdLCBvcHRpb25zLnBhcnNlQXR0cmlidXRlVmFsdWUsIG9wdGlvbnMubnVtUGFyc2VPcHRpb25zKTsKICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAob3B0aW9ucy5hbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzKSB7CiAgICAgICAgICAgICAgICAgICAgYXR0cnNbb3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4ICsgYXR0ck5hbWVdID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICBpZiAoIU9iamVjdC5rZXlzKGF0dHJzKS5sZW5ndGgpIHsKICAgICAgICAgICAgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAob3B0aW9ucy5hdHRyTm9kZU5hbWUpIHsKICAgICAgICAgICAgY29uc3QgYXR0ckNvbGxlY3Rpb24gPSB7CiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGF0dHJDb2xsZWN0aW9uW29wdGlvbnMuYXR0ck5vZGVOYW1lXSA9IGF0dHJzOwogICAgICAgICAgICByZXR1cm4gYXR0ckNvbGxlY3Rpb247CiAgICAgICAgfQogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KfQpjb25zdCBnZXRUcmF2ZXJzYWxPYmogPSBmdW5jdGlvbih4bWxEYXRhLCBvcHRpb25zKSB7CiAgICB4bWxEYXRhID0geG1sRGF0YS5yZXBsYWNlKC9cclxuPy9nLCAiXG4iKTsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMob3B0aW9ucywgZGVmYXVsdE9wdGlvbnMsIHByb3BzKTsKICAgIGNvbnN0IHhtbE9iaiA9IG5ldyB4bWxOb2RlKCIheG1sIik7CiAgICBsZXQgY3VycmVudE5vZGUgPSB4bWxPYmo7CiAgICBsZXQgdGV4dERhdGEgPSAiIjsKICAgIGZvcihsZXQgaSA9IDA7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBjb25zdCBjaCA9IHhtbERhdGFbaV07CiAgICAgICAgaWYgKGNoID09PSAiPCIpIHsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaSArIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI+IiwgaSwgIkNsb3NpbmcgVGFnIGlzIG5vdCBjbG9zZWQuIik7CiAgICAgICAgICAgICAgICBsZXQgdGFnTmFtZSA9IHhtbERhdGEuc3Vic3RyaW5nKGkgKyAyLCBjbG9zZUluZGV4KS50cmltKCk7CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gdGFnTmFtZS5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnZhbCkgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZSh0YWdOYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gcHJvY2Vzc1RhZ1ZhbHVlKHRhZ05hbWUsIHRleHREYXRhLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5zdG9wTm9kZXMubGVuZ3RoICYmIG9wdGlvbnMuc3RvcE5vZGVzLmluY2x1ZGVzKGN1cnJlbnROb2RlLnRhZ25hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuY2hpbGQgPSBbXTsKICAgICAgICAgICAgICAgICAgICBpZiAoY3VycmVudE5vZGUuYXR0cnNNYXAgPT0gdm9pZCAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLmF0dHJzTWFwID0gewogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB4bWxEYXRhLnN1YnN0cihjdXJyZW50Tm9kZS5zdGFydEluZGV4ICsgMSwgaSAtIGN1cnJlbnROb2RlLnN0YXJ0SW5kZXggLSAxKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlID0gY3VycmVudE5vZGUucGFyZW50OwogICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4OwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgIGkgPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI/PiIsIGksICJQaSBUYWcgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMykgPT09ICIhLS0iKSB7CiAgICAgICAgICAgICAgICBpID0gZmluZENsb3NpbmdJbmRleCh4bWxEYXRhLCAiLS0+IiwgaSwgIkNvbW1lbnQgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMikgPT09ICIhRCIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICI+IiwgaSwgIkRPQ1RZUEUgaXMgbm90IGNsb3NlZC4iKTsKICAgICAgICAgICAgICAgIGNvbnN0IHRhZ0V4cCA9IHhtbERhdGEuc3Vic3RyaW5nKGksIGNsb3NlSW5kZXgpOwogICAgICAgICAgICAgICAgaWYgKHRhZ0V4cC5pbmRleE9mKCJbIikgPj0gMCkgewogICAgICAgICAgICAgICAgICAgIGkgPSB4bWxEYXRhLmluZGV4T2YoIl0+IiwgaSkgKyAxOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIGlmICh4bWxEYXRhLnN1YnN0cihpICsgMSwgMikgPT09ICIhWyIpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGNsb3NlSW5kZXggPSBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsICJdXT4iLCBpLCAiQ0RBVEEgaXMgbm90IGNsb3NlZC4iKSAtIDI7CiAgICAgICAgICAgICAgICBjb25zdCB0YWdFeHAgPSB4bWxEYXRhLnN1YnN0cmluZyhpICsgOSwgY2xvc2VJbmRleCk7CiAgICAgICAgICAgICAgICBpZiAodGV4dERhdGEpIHsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZShjdXJyZW50Tm9kZS50YWduYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgdGV4dERhdGEgPSAiIjsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmNkYXRhVGFnTmFtZSkgewogICAgICAgICAgICAgICAgICAgIGNvbnN0IGNoaWxkTm9kZSA9IG5ldyB4bWxOb2RlKG9wdGlvbnMuY2RhdGFUYWdOYW1lLCBjdXJyZW50Tm9kZSwgdGFnRXhwKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgICAgIGN1cnJlbnROb2RlLnZhbCA9IHV0aWwuZ2V0VmFsdWUoY3VycmVudE5vZGUudmFsKSArIG9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXI7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ0V4cCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUudmFsID0gdGFnRXhwOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUudmFsID0gKGN1cnJlbnROb2RlLnZhbCB8fCAiIikgKyAodGFnRXhwIHx8ICIiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGkgPSBjbG9zZUluZGV4ICsgMjsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IGNsb3NpbmdJbmRleEZvck9wZW5pbmdUYWcoeG1sRGF0YSwgaSArIDEpOwogICAgICAgICAgICAgICAgbGV0IHRhZ0V4cCA9IHJlc3VsdC5kYXRhOwogICAgICAgICAgICAgICAgY29uc3QgY2xvc2VJbmRleCA9IHJlc3VsdC5pbmRleDsKICAgICAgICAgICAgICAgIGNvbnN0IHNlcGFyYXRvckluZGV4ID0gdGFnRXhwLmluZGV4T2YoIiAiKTsKICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0gdGFnRXhwOwogICAgICAgICAgICAgICAgbGV0IHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCA9IHRydWU7CiAgICAgICAgICAgICAgICBpZiAoc2VwYXJhdG9ySW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgdGFnTmFtZSA9IHRhZ0V4cC5zdWJzdHIoMCwgc2VwYXJhdG9ySW5kZXgpLnJlcGxhY2UoL1xzXHMqJC8sICIiKTsKICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdFeHAuc3Vic3RyKHNlcGFyYXRvckluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0aW9ucy5pZ25vcmVOYW1lU3BhY2UpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb2xvbkluZGV4ID0gdGFnTmFtZS5pbmRleE9mKCI6Iik7CiAgICAgICAgICAgICAgICAgICAgaWYgKGNvbG9uSW5kZXggIT09IC0xKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgICAgIHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCA9IHRhZ05hbWUgIT09IHJlc3VsdC5kYXRhLnN1YnN0cihjb2xvbkluZGV4ICsgMSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlICYmIHRleHREYXRhKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGN1cnJlbnROb2RlLnRhZ25hbWUgIT09ICIheG1sIikgewogICAgICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS52YWwgPSB1dGlsLmdldFZhbHVlKGN1cnJlbnROb2RlLnZhbCkgKyAiIiArIHByb2Nlc3NUYWdWYWx1ZShjdXJyZW50Tm9kZS50YWduYW1lLCB0ZXh0RGF0YSwgb3B0aW9ucyk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRhZ0V4cC5sZW5ndGggPiAwICYmIHRhZ0V4cC5sYXN0SW5kZXhPZigiLyIpID09PSB0YWdFeHAubGVuZ3RoIC0gMSkgewogICAgICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lW3RhZ05hbWUubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lID0gdGFnTmFtZS5zdWJzdHIoMCwgdGFnTmFtZS5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICAgICAgdGFnRXhwID0gdGFnTmFtZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0YWdFeHAgPSB0YWdFeHAuc3Vic3RyKDAsIHRhZ0V4cC5sZW5ndGggLSAxKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY29uc3QgY2hpbGROb2RlID0gbmV3IHhtbE5vZGUodGFnTmFtZSwgY3VycmVudE5vZGUsICIiKTsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gdGFnRXhwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkTm9kZS5hdHRyc01hcCA9IGJ1aWxkQXR0cmlidXRlc01hcCh0YWdFeHAsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZS5hZGRDaGlsZChjaGlsZE5vZGUpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjaGlsZE5vZGUgPSBuZXcgeG1sTm9kZSh0YWdOYW1lLCBjdXJyZW50Tm9kZSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKG9wdGlvbnMuc3RvcE5vZGVzLmxlbmd0aCAmJiBvcHRpb25zLnN0b3BOb2Rlcy5pbmNsdWRlcyhjaGlsZE5vZGUudGFnbmFtZSkpIHsKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGROb2RlLnN0YXJ0SW5kZXggPSBjbG9zZUluZGV4OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gdGFnRXhwICYmIHNob3VsZEJ1aWxkQXR0cmlidXRlc01hcCkgewogICAgICAgICAgICAgICAgICAgICAgICBjaGlsZE5vZGUuYXR0cnNNYXAgPSBidWlsZEF0dHJpYnV0ZXNNYXAodGFnRXhwLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgY3VycmVudE5vZGUuYWRkQ2hpbGQoY2hpbGROb2RlKTsKICAgICAgICAgICAgICAgICAgICBjdXJyZW50Tm9kZSA9IGNoaWxkTm9kZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRleHREYXRhID0gIiI7CiAgICAgICAgICAgICAgICBpID0gY2xvc2VJbmRleDsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHRleHREYXRhICs9IHhtbERhdGFbaV07CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHhtbE9iajsKfTsKZnVuY3Rpb24gY2xvc2luZ0luZGV4Rm9yT3BlbmluZ1RhZyhkYXRhLCBpKSB7CiAgICBsZXQgYXR0ckJvdW5kYXJ5OwogICAgbGV0IHRhZ0V4cCA9ICIiOwogICAgZm9yKGxldCBpbmRleCA9IGk7IGluZGV4IDwgZGF0YS5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGxldCBjaCA9IGRhdGFbaW5kZXhdOwogICAgICAgIGlmIChhdHRyQm91bmRhcnkpIHsKICAgICAgICAgICAgaWYgKGNoID09PSBhdHRyQm91bmRhcnkpIGF0dHJCb3VuZGFyeSA9ICIiOwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICciJyB8fCBjaCA9PT0gIiciKSB7CiAgICAgICAgICAgIGF0dHJCb3VuZGFyeSA9IGNoOwogICAgICAgIH0gZWxzZSBpZiAoY2ggPT09ICI+IikgewogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZGF0YTogdGFnRXhwLAogICAgICAgICAgICAgICAgaW5kZXgKICAgICAgICAgICAgfTsKICAgICAgICB9IGVsc2UgaWYgKGNoID09PSAiCSIpIHsKICAgICAgICAgICAgY2ggPSAiICI7CiAgICAgICAgfQogICAgICAgIHRhZ0V4cCArPSBjaDsKICAgIH0KfQpmdW5jdGlvbiBmaW5kQ2xvc2luZ0luZGV4KHhtbERhdGEsIHN0ciwgaSwgZXJyTXNnKSB7CiAgICBjb25zdCBjbG9zaW5nSW5kZXggPSB4bWxEYXRhLmluZGV4T2Yoc3RyLCBpKTsKICAgIGlmIChjbG9zaW5nSW5kZXggPT09IC0xKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGVyck1zZyk7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBjbG9zaW5nSW5kZXggKyBzdHIubGVuZ3RoIC0gMTsKICAgIH0KfQp2YXIgZ2V0VHJhdmVyc2FsT2JqXzEgPSBnZXRUcmF2ZXJzYWxPYmo7CnZhciB4bWxzdHIyeG1sbm9kZSA9IHsKICAgIGRlZmF1bHRPcHRpb25zOiBkZWZhdWx0T3B0aW9uc18xLAogICAgcHJvcHM6IHByb3BzXzEsCiAgICBnZXRUcmF2ZXJzYWxPYmo6IGdldFRyYXZlcnNhbE9ial8xCn07CmNvbnN0IGRlZmF1bHRPcHRpb25zJDEgPSB7CiAgICBhbGxvd0Jvb2xlYW5BdHRyaWJ1dGVzOiBmYWxzZQp9Owpjb25zdCBwcm9wcyQxID0gWwogICAgImFsbG93Qm9vbGVhbkF0dHJpYnV0ZXMiCl07CnZhciB2YWxpZGF0ZSA9IGZ1bmN0aW9uKHhtbERhdGEsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSB1dGlsLmJ1aWxkT3B0aW9ucyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucyQxLCBwcm9wcyQxKTsKICAgIGNvbnN0IHRhZ3MgPSBbXTsKICAgIGxldCB0YWdGb3VuZCA9IGZhbHNlOwogICAgbGV0IHJlYWNoZWRSb290ID0gZmFsc2U7CiAgICBpZiAoeG1sRGF0YVswXSA9PT0gIlx1RkVGRiIpIHsKICAgICAgICB4bWxEYXRhID0geG1sRGF0YS5zdWJzdHIoMSk7CiAgICB9CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgeG1sRGF0YS5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IiAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIj8iKSB7CiAgICAgICAgICAgIGkgKz0gMjsKICAgICAgICAgICAgaSA9IHJlYWRQSSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgaWYgKGkuZXJyKSByZXR1cm4gaTsKICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICBsZXQgdGFnU3RhcnRQb3MgPSBpOwogICAgICAgICAgICBpKys7CiAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiISIpIHsKICAgICAgICAgICAgICAgIGkgPSByZWFkQ29tbWVudEFuZENEQVRBKHhtbERhdGEsIGkpOwogICAgICAgICAgICAgICAgY29udGludWU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBsZXQgY2xvc2luZ1RhZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIGNsb3NpbmdUYWcgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGkrKzsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGxldCB0YWdOYW1lID0gIiI7CiAgICAgICAgICAgICAgICBmb3IoOyBpIDwgeG1sRGF0YS5sZW5ndGggJiYgeG1sRGF0YVtpXSAhPT0gIj4iICYmIHhtbERhdGFbaV0gIT09ICIgIiAmJiB4bWxEYXRhW2ldICE9PSAiCSIgJiYgeG1sRGF0YVtpXSAhPT0gIlxuIiAmJiB4bWxEYXRhW2ldICE9PSAiXHIiOyBpKyspewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgKz0geG1sRGF0YVtpXTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnRyaW0oKTsKICAgICAgICAgICAgICAgIGlmICh0YWdOYW1lW3RhZ05hbWUubGVuZ3RoIC0gMV0gPT09ICIvIikgewogICAgICAgICAgICAgICAgICAgIHRhZ05hbWUgPSB0YWdOYW1lLnN1YnN0cmluZygwLCB0YWdOYW1lLmxlbmd0aCAtIDEpOwogICAgICAgICAgICAgICAgICAgIGktLTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICghdmFsaWRhdGVUYWdOYW1lKHRhZ05hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IG1zZzsKICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZS50cmltKCkubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICJJbnZhbGlkIHNwYWNlIGFmdGVyICc8Jy4iOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1zZyA9ICJUYWcgJyIgKyB0YWdOYW1lICsgIicgaXMgYW4gaW52YWxpZCBuYW1lLiI7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsIG1zZywgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHJlc3VsdCA9IHJlYWRBdHRyaWJ1dGVTdHIoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICBpZiAocmVzdWx0ID09PSBmYWxzZSkgewogICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlcyBmb3IgJyIgKyB0YWdOYW1lICsgIicgaGF2ZSBvcGVuIHF1b3RlLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBsZXQgYXR0clN0ciA9IHJlc3VsdC52YWx1ZTsKICAgICAgICAgICAgICAgIGkgPSByZXN1bHQuaW5kZXg7CiAgICAgICAgICAgICAgICBpZiAoYXR0clN0clthdHRyU3RyLmxlbmd0aCAtIDFdID09PSAiLyIpIHsKICAgICAgICAgICAgICAgICAgICBjb25zdCBhdHRyU3RyU3RhcnQgPSBpIC0gYXR0clN0ci5sZW5ndGg7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0ciA9IGF0dHJTdHIuc3Vic3RyaW5nKDAsIGF0dHJTdHIubGVuZ3RoIC0gMSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkID09PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoaXNWYWxpZC5lcnIuY29kZSwgaXNWYWxpZC5lcnIubXNnLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgYXR0clN0clN0YXJ0ICsgaXNWYWxpZC5lcnIubGluZSkpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoY2xvc2luZ1RhZykgewogICAgICAgICAgICAgICAgICAgIGlmICghcmVzdWx0LnRhZ0Nsb3NlZCkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiQ2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicgZG9lc24ndCBoYXZlIHByb3BlciBjbG9zaW5nLiIsIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpKSk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChhdHRyU3RyLnRyaW0oKS5sZW5ndGggPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJDbG9zaW5nIHRhZyAnIiArIHRhZ05hbWUgKyAiJyBjYW4ndCBoYXZlIGF0dHJpYnV0ZXMgb3IgaW52YWxpZCBzdGFydGluZy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnU3RhcnRQb3MpKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvdGcgPSB0YWdzLnBvcCgpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAodGFnTmFtZSAhPT0gb3RnLnRhZ05hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvcGVuUG9zID0gZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIG90Zy50YWdTdGFydFBvcyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRUYWciLCAiRXhwZWN0ZWQgY2xvc2luZyB0YWcgJyIgKyBvdGcudGFnTmFtZSArICInIChvcGVuZWQgaW4gbGluZSAiICsgb3BlblBvcy5saW5lICsgIiwgY29sICIgKyBvcGVuUG9zLmNvbCArICIpIGluc3RlYWQgb2YgY2xvc2luZyB0YWcgJyIgKyB0YWdOYW1lICsgIicuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIHRhZ1N0YXJ0UG9zKSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHRhZ3MubGVuZ3RoID09IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlYWNoZWRSb290ID0gdHJ1ZTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY29uc3QgaXNWYWxpZCA9IHZhbGlkYXRlQXR0cmlidXRlU3RyaW5nKGF0dHJTdHIsIG9wdGlvbnMpOwogICAgICAgICAgICAgICAgICAgIGlmIChpc1ZhbGlkICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdChpc1ZhbGlkLmVyci5jb2RlLCBpc1ZhbGlkLmVyci5tc2csIGdldExpbmVOdW1iZXJGb3JQb3NpdGlvbih4bWxEYXRhLCBpIC0gYXR0clN0ci5sZW5ndGggKyBpc1ZhbGlkLmVyci5saW5lKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGlmIChyZWFjaGVkUm9vdCA9PT0gdHJ1ZSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiTXVsdGlwbGUgcG9zc2libGUgcm9vdCBub2RlcyBmb3VuZC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHRhZ3MucHVzaCh7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWdOYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGFnU3RhcnRQb3MKICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIHRhZ0ZvdW5kID0gdHJ1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGZvcihpKys7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjwiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2kgKyAxXSA9PT0gIiEiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpID0gcmVhZENvbW1lbnRBbmRDREFUQSh4bWxEYXRhLCBpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaSArIDFdID09PSAiPyIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGkgPSByZWFkUEkoeG1sRGF0YSwgKytpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpLmVycikgcmV0dXJuIGk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIiYiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGFmdGVyQW1wID0gdmFsaWRhdGVBbXBlcnNhbmQoeG1sRGF0YSwgaSk7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIChhZnRlckFtcCA9PSAtMSkgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQ2hhciIsICJjaGFyICcmJyBpcyBub3QgZXhwZWN0ZWQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaSA9IGFmdGVyQW1wOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiPCIpIHsKICAgICAgICAgICAgICAgICAgICBpLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIiAiIHx8IHhtbERhdGFbaV0gPT09ICIJIiB8fCB4bWxEYXRhW2ldID09PSAiXG4iIHx8IHhtbERhdGFbaV0gPT09ICJcciIpIHsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZENoYXIiLCAiY2hhciAnIiArIHhtbERhdGFbaV0gKyAiJyBpcyBub3QgZXhwZWN0ZWQuIiwgZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGkpKTsKICAgICAgICB9CiAgICB9CiAgICBpZiAoIXRhZ0ZvdW5kKSB7CiAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIlN0YXJ0IHRhZyBleHBlY3RlZC4iLCAxKTsKICAgIH0gZWxzZSBpZiAodGFncy5sZW5ndGggPT0gMSkgewogICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZFRhZyIsICJVbmNsb3NlZCB0YWcgJyIgKyB0YWdzWzBdLnRhZ05hbWUgKyAiJy4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgdGFnc1swXS50YWdTdGFydFBvcykpOwogICAgfSBlbHNlIGlmICh0YWdzLmxlbmd0aCA+IDApIHsKICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRYbWwiLCAiSW52YWxpZCAnIiArIEpTT04uc3RyaW5naWZ5KHRhZ3MubWFwKCh0KT0+dC50YWdOYW1lCiAgICAgICAgKSwgbnVsbCwgNCkucmVwbGFjZSgvXHI/XG4vZywgIiIpICsgIicgZm91bmQuIiwgewogICAgICAgICAgICBsaW5lOiAxLAogICAgICAgICAgICBjb2w6IDEKICAgICAgICB9KTsKICAgIH0KICAgIHJldHVybiB0cnVlOwp9OwpmdW5jdGlvbiByZWFkUEkoeG1sRGF0YSwgaSkgewogICAgY29uc3Qgc3RhcnQgPSBpOwogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09ICI/IiB8fCB4bWxEYXRhW2ldID09ICIgIikgewogICAgICAgICAgICBjb25zdCB0YWduYW1lID0geG1sRGF0YS5zdWJzdHIoc3RhcnQsIGkgLSBzdGFydCk7CiAgICAgICAgICAgIGlmIChpID4gNSAmJiB0YWduYW1lID09PSAieG1sIikgewogICAgICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkWG1sIiwgIlhNTCBkZWNsYXJhdGlvbiBhbGxvd2VkIG9ubHkgYXQgdGhlIHN0YXJ0IG9mIHRoZSBkb2N1bWVudC4iLCBnZXRMaW5lTnVtYmVyRm9yUG9zaXRpb24oeG1sRGF0YSwgaSkpOwogICAgICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT0gIj8iICYmIHhtbERhdGFbaSArIDFdID09ICI+IikgewogICAgICAgICAgICAgICAgaSsrOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb250aW51ZTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBpOwp9CmZ1bmN0aW9uIHJlYWRDb21tZW50QW5kQ0RBVEEoeG1sRGF0YSwgaSkgewogICAgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDUgJiYgeG1sRGF0YVtpICsgMV0gPT09ICItIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIi0iKSB7CiAgICAgICAgZm9yKGkgKz0gMzsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIi0iICYmIHhtbERhdGFbaSArIDFdID09PSAiLSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICI+IikgewogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9IGVsc2UgaWYgKHhtbERhdGEubGVuZ3RoID4gaSArIDggJiYgeG1sRGF0YVtpICsgMV0gPT09ICJEIiAmJiB4bWxEYXRhW2kgKyAyXSA9PT0gIk8iICYmIHhtbERhdGFbaSArIDNdID09PSAiQyIgJiYgeG1sRGF0YVtpICsgNF0gPT09ICJUIiAmJiB4bWxEYXRhW2kgKyA1XSA9PT0gIlkiICYmIHhtbERhdGFbaSArIDZdID09PSAiUCIgJiYgeG1sRGF0YVtpICsgN10gPT09ICJFIikgewogICAgICAgIGxldCBhbmdsZUJyYWNrZXRzQ291bnQgPSAxOwogICAgICAgIGZvcihpICs9IDg7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICAgICAgaWYgKHhtbERhdGFbaV0gPT09ICI8IikgewogICAgICAgICAgICAgICAgYW5nbGVCcmFja2V0c0NvdW50Kys7CiAgICAgICAgICAgIH0gZWxzZSBpZiAoeG1sRGF0YVtpXSA9PT0gIj4iKSB7CiAgICAgICAgICAgICAgICBhbmdsZUJyYWNrZXRzQ291bnQtLTsKICAgICAgICAgICAgICAgIGlmIChhbmdsZUJyYWNrZXRzQ291bnQgPT09IDApIHsKICAgICAgICAgICAgICAgICAgICBicmVhazsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0gZWxzZSBpZiAoeG1sRGF0YS5sZW5ndGggPiBpICsgOSAmJiB4bWxEYXRhW2kgKyAxXSA9PT0gIlsiICYmIHhtbERhdGFbaSArIDJdID09PSAiQyIgJiYgeG1sRGF0YVtpICsgM10gPT09ICJEIiAmJiB4bWxEYXRhW2kgKyA0XSA9PT0gIkEiICYmIHhtbERhdGFbaSArIDVdID09PSAiVCIgJiYgeG1sRGF0YVtpICsgNl0gPT09ICJBIiAmJiB4bWxEYXRhW2kgKyA3XSA9PT0gIlsiKSB7CiAgICAgICAgZm9yKGkgKz0gODsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIl0iICYmIHhtbERhdGFbaSArIDFdID09PSAiXSIgJiYgeG1sRGF0YVtpICsgMl0gPT09ICI+IikgewogICAgICAgICAgICAgICAgaSArPSAyOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gaTsKfQpjb25zdCBkb3VibGVRdW90ZSA9ICciJzsKY29uc3Qgc2luZ2xlUXVvdGUgPSAiJyI7CmZ1bmN0aW9uIHJlYWRBdHRyaWJ1dGVTdHIoeG1sRGF0YSwgaSkgewogICAgbGV0IGF0dHJTdHIgPSAiIjsKICAgIGxldCBzdGFydENoYXIgPSAiIjsKICAgIGxldCB0YWdDbG9zZWQgPSBmYWxzZTsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gZG91YmxlUXVvdGUgfHwgeG1sRGF0YVtpXSA9PT0gc2luZ2xlUXVvdGUpIHsKICAgICAgICAgICAgaWYgKHN0YXJ0Q2hhciA9PT0gIiIpIHsKICAgICAgICAgICAgICAgIHN0YXJ0Q2hhciA9IHhtbERhdGFbaV07CiAgICAgICAgICAgIH0gZWxzZSBpZiAoc3RhcnRDaGFyICE9PSB4bWxEYXRhW2ldKSA7CiAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgc3RhcnRDaGFyID0gIiI7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKHhtbERhdGFbaV0gPT09ICI+IikgewogICAgICAgICAgICBpZiAoc3RhcnRDaGFyID09PSAiIikgewogICAgICAgICAgICAgICAgdGFnQ2xvc2VkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIGF0dHJTdHIgKz0geG1sRGF0YVtpXTsKICAgIH0KICAgIGlmIChzdGFydENoYXIgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIGZhbHNlOwogICAgfQogICAgcmV0dXJuIHsKICAgICAgICB2YWx1ZTogYXR0clN0ciwKICAgICAgICBpbmRleDogaSwKICAgICAgICB0YWdDbG9zZWQKICAgIH07Cn0KY29uc3QgdmFsaWRBdHRyU3RyUmVneHAgPSBuZXcgUmVnRXhwKGAoXFxzKikoW15cXHM9XSspKFxccyo9KT8oXFxzKihbJyJdKSgoW1xcc1xcU10pKj8pXFw1KT9gLCAiZyIpOwpmdW5jdGlvbiB2YWxpZGF0ZUF0dHJpYnV0ZVN0cmluZyhhdHRyU3RyLCBvcHRpb25zKSB7CiAgICBjb25zdCBtYXRjaGVzID0gdXRpbC5nZXRBbGxNYXRjaGVzKGF0dHJTdHIsIHZhbGlkQXR0clN0clJlZ3hwKTsKICAgIGNvbnN0IGF0dHJOYW1lcyA9IHsKICAgIH07CiAgICBmb3IobGV0IGkgPSAwOyBpIDwgbWF0Y2hlcy5sZW5ndGg7IGkrKyl7CiAgICAgICAgaWYgKG1hdGNoZXNbaV1bMV0ubGVuZ3RoID09PSAwKSB7CiAgICAgICAgICAgIHJldHVybiBnZXRFcnJvck9iamVjdCgiSW52YWxpZEF0dHIiLCAiQXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGhhcyBubyBzcGFjZSBpbiBzdGFydGluZy4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfSBlbHNlIGlmIChtYXRjaGVzW2ldWzNdID09PSB2b2lkIDAgJiYgIW9wdGlvbnMuYWxsb3dCb29sZWFuQXR0cmlidXRlcykgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgImJvb2xlYW4gYXR0cmlidXRlICciICsgbWF0Y2hlc1tpXVsyXSArICInIGlzIG5vdCBhbGxvd2VkLiIsIGdldFBvc2l0aW9uRnJvbU1hdGNoKG1hdGNoZXNbaV0pKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgYXR0ck5hbWUgPSBtYXRjaGVzW2ldWzJdOwogICAgICAgIGlmICghdmFsaWRhdGVBdHRyTmFtZShhdHRyTmFtZSkpIHsKICAgICAgICAgICAgcmV0dXJuIGdldEVycm9yT2JqZWN0KCJJbnZhbGlkQXR0ciIsICJBdHRyaWJ1dGUgJyIgKyBhdHRyTmFtZSArICInIGlzIGFuIGludmFsaWQgbmFtZS4iLCBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaGVzW2ldKSk7CiAgICAgICAgfQogICAgICAgIGlmICghYXR0ck5hbWVzLmhhc093blByb3BlcnR5KGF0dHJOYW1lKSkgewogICAgICAgICAgICBhdHRyTmFtZXNbYXR0ck5hbWVdID0gMTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gZ2V0RXJyb3JPYmplY3QoIkludmFsaWRBdHRyIiwgIkF0dHJpYnV0ZSAnIiArIGF0dHJOYW1lICsgIicgaXMgcmVwZWF0ZWQuIiwgZ2V0UG9zaXRpb25Gcm9tTWF0Y2gobWF0Y2hlc1tpXSkpOwogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB0cnVlOwp9CmZ1bmN0aW9uIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGxldCByZSA9IC9cZC87CiAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIngiKSB7CiAgICAgICAgaSsrOwogICAgICAgIHJlID0gL1tcZGEtZkEtRl0vOwogICAgfQogICAgZm9yKDsgaSA8IHhtbERhdGEubGVuZ3RoOyBpKyspewogICAgICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiBpOwogICAgICAgIGlmICgheG1sRGF0YVtpXS5tYXRjaChyZSkpIGJyZWFrOwogICAgfQogICAgcmV0dXJuIC0xOwp9CmZ1bmN0aW9uIHZhbGlkYXRlQW1wZXJzYW5kKHhtbERhdGEsIGkpIHsKICAgIGkrKzsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiOyIpIHJldHVybiAtMTsKICAgIGlmICh4bWxEYXRhW2ldID09PSAiIyIpIHsKICAgICAgICBpKys7CiAgICAgICAgcmV0dXJuIHZhbGlkYXRlTnVtYmVyQW1wZXJzYW5kKHhtbERhdGEsIGkpOwogICAgfQogICAgbGV0IGNvdW50ID0gMDsKICAgIGZvcig7IGkgPCB4bWxEYXRhLmxlbmd0aDsgaSsrLCBjb3VudCsrKXsKICAgICAgICBpZiAoeG1sRGF0YVtpXS5tYXRjaCgvXHcvKSAmJiBjb3VudCA8IDIwKSBjb250aW51ZTsKICAgICAgICBpZiAoeG1sRGF0YVtpXSA9PT0gIjsiKSBicmVhazsKICAgICAgICByZXR1cm4gLTE7CiAgICB9CiAgICByZXR1cm4gaTsKfQpmdW5jdGlvbiBnZXRFcnJvck9iamVjdChjb2RlLCBtZXNzYWdlLCBsaW5lTnVtYmVyKSB7CiAgICByZXR1cm4gewogICAgICAgIGVycjogewogICAgICAgICAgICBjb2RlLAogICAgICAgICAgICBtc2c6IG1lc3NhZ2UsCiAgICAgICAgICAgIGxpbmU6IGxpbmVOdW1iZXIubGluZSB8fCBsaW5lTnVtYmVyLAogICAgICAgICAgICBjb2w6IGxpbmVOdW1iZXIuY29sCiAgICAgICAgfQogICAgfTsKfQpmdW5jdGlvbiB2YWxpZGF0ZUF0dHJOYW1lKGF0dHJOYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUoYXR0ck5hbWUpOwp9CmZ1bmN0aW9uIHZhbGlkYXRlVGFnTmFtZSh0YWduYW1lKSB7CiAgICByZXR1cm4gdXRpbC5pc05hbWUodGFnbmFtZSk7Cn0KZnVuY3Rpb24gZ2V0TGluZU51bWJlckZvclBvc2l0aW9uKHhtbERhdGEsIGluZGV4KSB7CiAgICBjb25zdCBsaW5lcyA9IHhtbERhdGEuc3Vic3RyaW5nKDAsIGluZGV4KS5zcGxpdCgvXHI/XG4vKTsKICAgIHJldHVybiB7CiAgICAgICAgbGluZTogbGluZXMubGVuZ3RoLAogICAgICAgIGNvbDogbGluZXNbbGluZXMubGVuZ3RoIC0gMV0ubGVuZ3RoICsgMQogICAgfTsKfQpmdW5jdGlvbiBnZXRQb3NpdGlvbkZyb21NYXRjaChtYXRjaCkgewogICAgcmV0dXJuIG1hdGNoLnN0YXJ0SW5kZXggKyBtYXRjaFsxXS5sZW5ndGg7Cn0KdmFyIHZhbGlkYXRvciA9IHsKICAgIHZhbGlkYXRlCn07CmNvbnN0IF9fY2hhciA9IGZ1bmN0aW9uKGEpIHsKICAgIHJldHVybiBTdHJpbmcuZnJvbUNoYXJDb2RlKGEpOwp9Owpjb25zdCBjaGFycyA9IHsKICAgIG5pbENoYXI6IF9fY2hhcigxNzYpLAogICAgbWlzc2luZ0NoYXI6IF9fY2hhcigyMDEpLAogICAgbmlsUHJlbWl0aXZlOiBfX2NoYXIoMTc1KSwKICAgIG1pc3NpbmdQcmVtaXRpdmU6IF9fY2hhcigyMDApLAogICAgZW1wdHlDaGFyOiBfX2NoYXIoMTc4KSwKICAgIGVtcHR5VmFsdWU6IF9fY2hhcigxNzcpLAogICAgYm91bmRyeUNoYXI6IF9fY2hhcigxNzkpLAogICAgb2JqU3RhcnQ6IF9fY2hhcigxOTgpLAogICAgYXJyU3RhcnQ6IF9fY2hhcigyMDQpLAogICAgYXJyYXlFbmQ6IF9fY2hhcigxODUpCn07CmNvbnN0IGNoYXJzQXJyID0gWwogICAgY2hhcnMubmlsQ2hhciwKICAgIGNoYXJzLm5pbFByZW1pdGl2ZSwKICAgIGNoYXJzLm1pc3NpbmdDaGFyLAogICAgY2hhcnMubWlzc2luZ1ByZW1pdGl2ZSwKICAgIGNoYXJzLmJvdW5kcnlDaGFyLAogICAgY2hhcnMuZW1wdHlDaGFyLAogICAgY2hhcnMuZW1wdHlWYWx1ZSwKICAgIGNoYXJzLmFycmF5RW5kLAogICAgY2hhcnMub2JqU3RhcnQsCiAgICBjaGFycy5hcnJTdGFydApdOwpjb25zdCBfZSA9IGZ1bmN0aW9uKG5vZGUsIGVfc2NoZW1hLCBvcHRpb25zKSB7CiAgICBpZiAodHlwZW9mIGVfc2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgIGlmIChub2RlICYmIG5vZGVbMF0gJiYgbm9kZVswXS52YWwgIT09IHZvaWQgMCkgewogICAgICAgICAgICByZXR1cm4gZ2V0VmFsdWUobm9kZVswXS52YWwpOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIHJldHVybiBnZXRWYWx1ZShub2RlKTsKICAgICAgICB9CiAgICB9IGVsc2UgewogICAgICAgIGNvbnN0IGhhc1ZhbGlkRGF0YSA9IGhhc0RhdGEobm9kZSk7CiAgICAgICAgaWYgKGhhc1ZhbGlkRGF0YSA9PT0gdHJ1ZSkgewogICAgICAgICAgICBsZXQgc3RyID0gIiI7CiAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KGVfc2NoZW1hKSkgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFyclN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3QgaXRlbVNjaGVtYSA9IGVfc2NoZW1hWzBdOwogICAgICAgICAgICAgICAgY29uc3QgYXJyX2xlbiA9IG5vZGUubGVuZ3RoOwogICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtU2NoZW1hID09PSAic3RyaW5nIikgewogICAgICAgICAgICAgICAgICAgIGZvcihsZXQgYXJyX2kgPSAwOyBhcnJfaSA8IGFycl9sZW47IGFycl9pKyspewogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCByID0gZ2V0VmFsdWUobm9kZVthcnJfaV0udmFsKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBmb3IobGV0IGFycl9pID0gMDsgYXJyX2kgPCBhcnJfbGVuOyBhcnJfaSsrKXsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgciA9IF9lKG5vZGVbYXJyX2ldLCBpdGVtU2NoZW1hLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLmFycmF5RW5kOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgc3RyICs9IGNoYXJzLm9ialN0YXJ0OwogICAgICAgICAgICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGVfc2NoZW1hKTsKICAgICAgICAgICAgICAgIGlmIChBcnJheS5pc0FycmF5KG5vZGUpKSB7CiAgICAgICAgICAgICAgICAgICAgbm9kZSA9IG5vZGVbMF07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBmb3IobGV0IGkgaW4ga2V5cyl7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2V5ID0ga2V5c1tpXTsKICAgICAgICAgICAgICAgICAgICBsZXQgcjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyAmJiBub2RlLmF0dHJzTWFwICYmIG5vZGUuYXR0cnNNYXBba2V5XSkgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5hdHRyc01hcFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGtleSA9PT0gb3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgciA9IF9lKG5vZGUudmFsLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICByID0gX2Uobm9kZS5jaGlsZFtrZXldLCBlX3NjaGVtYVtrZXldLCBvcHRpb25zKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgc3RyID0gcHJvY2Vzc1ZhbHVlKHN0ciwgcik7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgcmV0dXJuIHN0cjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICByZXR1cm4gaGFzVmFsaWREYXRhOwogICAgICAgIH0KICAgIH0KfTsKY29uc3QgZ2V0VmFsdWUgPSBmdW5jdGlvbihhKSB7CiAgICBzd2l0Y2goYSl7CiAgICAgICAgY2FzZSB2b2lkIDA6CiAgICAgICAgICAgIHJldHVybiBjaGFycy5taXNzaW5nUHJlbWl0aXZlOwogICAgICAgIGNhc2UgbnVsbDoKICAgICAgICAgICAgcmV0dXJuIGNoYXJzLm5pbFByZW1pdGl2ZTsKICAgICAgICBjYXNlICIiOgogICAgICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlWYWx1ZTsKICAgICAgICBkZWZhdWx0OgogICAgICAgICAgICByZXR1cm4gYTsKICAgIH0KfTsKY29uc3QgcHJvY2Vzc1ZhbHVlID0gZnVuY3Rpb24oc3RyLCByKSB7CiAgICBpZiAoIWlzQXBwQ2hhcihyWzBdKSAmJiAhaXNBcHBDaGFyKHN0cltzdHIubGVuZ3RoIC0gMV0pKSB7CiAgICAgICAgc3RyICs9IGNoYXJzLmJvdW5kcnlDaGFyOwogICAgfQogICAgcmV0dXJuIHN0ciArIHI7Cn07CmNvbnN0IGlzQXBwQ2hhciA9IGZ1bmN0aW9uKGNoKSB7CiAgICByZXR1cm4gY2hhcnNBcnIuaW5kZXhPZihjaCkgIT09IC0xOwp9OwpmdW5jdGlvbiBoYXNEYXRhKGpPYmopIHsKICAgIGlmIChqT2JqID09PSB2b2lkIDApIHsKICAgICAgICByZXR1cm4gY2hhcnMubWlzc2luZ0NoYXI7CiAgICB9IGVsc2UgaWYgKGpPYmogPT09IG51bGwpIHsKICAgICAgICByZXR1cm4gY2hhcnMubmlsQ2hhcjsKICAgIH0gZWxzZSBpZiAoak9iai5jaGlsZCAmJiBPYmplY3Qua2V5cyhqT2JqLmNoaWxkKS5sZW5ndGggPT09IDAgJiYgKCFqT2JqLmF0dHJzTWFwIHx8IE9iamVjdC5rZXlzKGpPYmouYXR0cnNNYXApLmxlbmd0aCA9PT0gMCkpIHsKICAgICAgICByZXR1cm4gY2hhcnMuZW1wdHlDaGFyOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH0KfQpjb25zdCBidWlsZE9wdGlvbnMkMSA9IHV0aWwuYnVpbGRPcHRpb25zOwpjb25zdCBjb252ZXJ0Mm5pbW4gPSBmdW5jdGlvbihub2RlLCBlX3NjaGVtYSwgb3B0aW9ucykgewogICAgb3B0aW9ucyA9IGJ1aWxkT3B0aW9ucyQxKG9wdGlvbnMsIHhtbHN0cjJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5wcm9wcyk7CiAgICByZXR1cm4gX2Uobm9kZSwgZV9zY2hlbWEsIG9wdGlvbnMpOwp9Owp2YXIgY29udmVydDJuaW1uXzEgPSBjb252ZXJ0Mm5pbW47CnZhciBuaW1uZGF0YSA9IHsKICAgIGNvbnZlcnQybmltbjogY29udmVydDJuaW1uXzEKfTsKY29uc3QgYnVpbGRPcHRpb25zJDIgPSB1dGlsLmJ1aWxkT3B0aW9uczsKY29uc3QgY29udmVydFRvSnNvblN0cmluZyA9IGZ1bmN0aW9uKG5vZGUsIG9wdGlvbnMpIHsKICAgIG9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMihvcHRpb25zLCB4bWxzdHIyeG1sbm9kZS5kZWZhdWx0T3B0aW9ucywgeG1sc3RyMnhtbG5vZGUucHJvcHMpOwogICAgb3B0aW9ucy5pbmRlbnRCeSA9IG9wdGlvbnMuaW5kZW50QnkgfHwgIiI7CiAgICByZXR1cm4gX2NUb0pzb25TdHIobm9kZSwgb3B0aW9ucyk7Cn07CmNvbnN0IF9jVG9Kc29uU3RyID0gZnVuY3Rpb24obm9kZSwgb3B0aW9ucywgbGV2ZWwpIHsKICAgIGxldCBqT2JqID0gInsiOwogICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKG5vZGUuY2hpbGQpOwogICAgZm9yKGxldCBpbmRleCA9IDA7IGluZGV4IDwga2V5cy5sZW5ndGg7IGluZGV4KyspewogICAgICAgIGNvbnN0IHRhZ25hbWUgPSBrZXlzW2luZGV4XTsKICAgICAgICBpZiAobm9kZS5jaGlsZFt0YWduYW1lXSAmJiBub2RlLmNoaWxkW3RhZ25hbWVdLmxlbmd0aCA+IDEpIHsKICAgICAgICAgICAgak9iaiArPSAnIicgKyB0YWduYW1lICsgJyIgOiBbICc7CiAgICAgICAgICAgIGZvcihsZXQgdGFnIGluIG5vZGUuY2hpbGRbdGFnbmFtZV0pewogICAgICAgICAgICAgICAgak9iaiArPSBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdW3RhZ10sIG9wdGlvbnMpICsgIiAsICI7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgak9iaiA9IGpPYmouc3Vic3RyKDAsIGpPYmoubGVuZ3RoIC0gMSkgKyAiIF0gIjsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBqT2JqICs9ICciJyArIHRhZ25hbWUgKyAnIiA6ICcgKyBfY1RvSnNvblN0cihub2RlLmNoaWxkW3RhZ25hbWVdWzBdLCBvcHRpb25zKSArICIgLCI7CiAgICAgICAgfQogICAgfQogICAgdXRpbC5tZXJnZShqT2JqLCBub2RlLmF0dHJzTWFwKTsKICAgIGlmICh1dGlsLmlzRW1wdHlPYmplY3Qoak9iaikpIHsKICAgICAgICByZXR1cm4gdXRpbC5pc0V4aXN0KG5vZGUudmFsKSA/IG5vZGUudmFsIDogIiI7CiAgICB9IGVsc2UgewogICAgICAgIGlmICh1dGlsLmlzRXhpc3Qobm9kZS52YWwpKSB7CiAgICAgICAgICAgIGlmICghKHR5cGVvZiBub2RlLnZhbCA9PT0gInN0cmluZyIgJiYgKG5vZGUudmFsID09PSAiIiB8fCBub2RlLnZhbCA9PT0gb3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhcikpKSB7CiAgICAgICAgICAgICAgICBqT2JqICs9ICciJyArIG9wdGlvbnMudGV4dE5vZGVOYW1lICsgJyIgOiAnICsgc3RyaW5ndmFsKG5vZGUudmFsKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGlmIChqT2JqW2pPYmoubGVuZ3RoIC0gMV0gPT09ICIsIikgewogICAgICAgIGpPYmogPSBqT2JqLnN1YnN0cigwLCBqT2JqLmxlbmd0aCAtIDIpOwogICAgfQogICAgcmV0dXJuIGpPYmogKyAifSI7Cn07CmZ1bmN0aW9uIHN0cmluZ3ZhbCh2KSB7CiAgICBpZiAodiA9PT0gdHJ1ZSB8fCB2ID09PSBmYWxzZSB8fCAhaXNOYU4odikpIHsKICAgICAgICByZXR1cm4gdjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuICciJyArIHYgKyAnIic7CiAgICB9Cn0KdmFyIGNvbnZlcnRUb0pzb25TdHJpbmdfMSA9IGNvbnZlcnRUb0pzb25TdHJpbmc7CnZhciBub2RlMmpzb25fc3RyID0gewogICAgY29udmVydFRvSnNvblN0cmluZzogY29udmVydFRvSnNvblN0cmluZ18xCn07CmNvbnN0IGJ1aWxkT3B0aW9ucyQzID0gdXRpbC5idWlsZE9wdGlvbnM7CmNvbnN0IGRlZmF1bHRPcHRpb25zJDIgPSB7CiAgICBhdHRyaWJ1dGVOYW1lUHJlZml4OiAiQF8iLAogICAgYXR0ck5vZGVOYW1lOiBmYWxzZSwKICAgIHRleHROb2RlTmFtZTogIiN0ZXh0IiwKICAgIGlnbm9yZUF0dHJpYnV0ZXM6IHRydWUsCiAgICBjZGF0YVRhZ05hbWU6IGZhbHNlLAogICAgY2RhdGFQb3NpdGlvbkNoYXI6ICJcXGMiLAogICAgZm9ybWF0OiBmYWxzZSwKICAgIGluZGVudEJ5OiAiICAiLAogICAgc3VwcmVzc0VtcHR5Tm9kZTogZmFsc2UsCiAgICB0YWdWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfSwKICAgIGF0dHJWYWx1ZVByb2Nlc3NvcjogZnVuY3Rpb24oYSkgewogICAgICAgIHJldHVybiBhOwogICAgfQp9Owpjb25zdCBwcm9wcyQyID0gWwogICAgImF0dHJpYnV0ZU5hbWVQcmVmaXgiLAogICAgImF0dHJOb2RlTmFtZSIsCiAgICAidGV4dE5vZGVOYW1lIiwKICAgICJpZ25vcmVBdHRyaWJ1dGVzIiwKICAgICJjZGF0YVRhZ05hbWUiLAogICAgImNkYXRhUG9zaXRpb25DaGFyIiwKICAgICJmb3JtYXQiLAogICAgImluZGVudEJ5IiwKICAgICJzdXByZXNzRW1wdHlOb2RlIiwKICAgICJ0YWdWYWx1ZVByb2Nlc3NvciIsCiAgICAiYXR0clZhbHVlUHJvY2Vzc29yIiwKICAgICJyb290Tm9kZU5hbWUiCl07CmZ1bmN0aW9uIFBhcnNlcihvcHRpb25zKSB7CiAgICB0aGlzLm9wdGlvbnMgPSBidWlsZE9wdGlvbnMkMyhvcHRpb25zLCBkZWZhdWx0T3B0aW9ucyQyLCBwcm9wcyQyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuaWdub3JlQXR0cmlidXRlcyB8fCB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgdGhpcy5pc0F0dHJpYnV0ZSA9IGZ1bmN0aW9uKCkgewogICAgICAgICAgICByZXR1cm4gZmFsc2U7CiAgICAgICAgfTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5hdHRyUHJlZml4TGVuID0gdGhpcy5vcHRpb25zLmF0dHJpYnV0ZU5hbWVQcmVmaXgubGVuZ3RoOwogICAgICAgIHRoaXMuaXNBdHRyaWJ1dGUgPSBpc0F0dHJpYnV0ZTsKICAgIH0KICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lKSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gaXNDREFUQTsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pc0NEQVRBID0gZnVuY3Rpb24oKSB7CiAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICB9OwogICAgfQogICAgdGhpcy5yZXBsYWNlQ0RBVEFzdHIgPSByZXBsYWNlQ0RBVEFzdHI7CiAgICB0aGlzLnJlcGxhY2VDREFUQWFyciA9IHJlcGxhY2VDREFUQWFycjsKICAgIHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUgPSBwcm9jZXNzVGV4dE9yT2JqTm9kZTsKICAgIGlmICh0aGlzLm9wdGlvbnMuZm9ybWF0KSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBpbmRlbnRhdGU7CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj5cbiI7CiAgICAgICAgdGhpcy5uZXdMaW5lID0gIlxuIjsKICAgIH0gZWxzZSB7CiAgICAgICAgdGhpcy5pbmRlbnRhdGUgPSBmdW5jdGlvbigpIHsKICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgIH07CiAgICAgICAgdGhpcy50YWdFbmRDaGFyID0gIj4iOwogICAgICAgIHRoaXMubmV3TGluZSA9ICIiOwogICAgfQogICAgaWYgKHRoaXMub3B0aW9ucy5zdXByZXNzRW1wdHlOb2RlKSB7CiAgICAgICAgdGhpcy5idWlsZFRleHROb2RlID0gYnVpbGRFbXB0eVRleHROb2RlOwogICAgICAgIHRoaXMuYnVpbGRPYmpOb2RlID0gYnVpbGRFbXB0eU9iak5vZGU7CiAgICB9IGVsc2UgewogICAgICAgIHRoaXMuYnVpbGRUZXh0Tm9kZSA9IGJ1aWxkVGV4dFZhbE5vZGU7CiAgICAgICAgdGhpcy5idWlsZE9iak5vZGUgPSBidWlsZE9iamVjdE5vZGU7CiAgICB9CiAgICB0aGlzLmJ1aWxkVGV4dFZhbE5vZGUgPSBidWlsZFRleHRWYWxOb2RlOwogICAgdGhpcy5idWlsZE9iamVjdE5vZGUgPSBidWlsZE9iamVjdE5vZGU7Cn0KUGFyc2VyLnByb3RvdHlwZS5wYXJzZSA9IGZ1bmN0aW9uKGpPYmopIHsKICAgIGlmIChBcnJheS5pc0FycmF5KGpPYmopICYmIHRoaXMub3B0aW9ucy5yb290Tm9kZU5hbWUgJiYgdGhpcy5vcHRpb25zLnJvb3ROb2RlTmFtZS5sZW5ndGggPiAxKSB7CiAgICAgICAgak9iaiA9IHsKICAgICAgICAgICAgW3RoaXMub3B0aW9ucy5yb290Tm9kZU5hbWVdOiBqT2JqCiAgICAgICAgfTsKICAgIH0KICAgIHJldHVybiB0aGlzLmoyeChqT2JqLCAwKS52YWw7Cn07ClBhcnNlci5wcm90b3R5cGUuajJ4ID0gZnVuY3Rpb24oak9iaiwgbGV2ZWwpIHsKICAgIGxldCBhdHRyU3RyID0gIiI7CiAgICBsZXQgdmFsID0gIiI7CiAgICBmb3IobGV0IGtleSBpbiBqT2JqKXsKICAgICAgICBpZiAodHlwZW9mIGpPYmpba2V5XSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICBlbHNlIGlmIChqT2JqW2tleV0gPT09IG51bGwpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgICAgICB9IGVsc2UgaWYgKGpPYmpba2V5XSBpbnN0YW5jZW9mIERhdGUpIHsKICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShqT2JqW2tleV0sIGtleSwgIiIsIGxldmVsKTsKICAgICAgICB9IGVsc2UgaWYgKHR5cGVvZiBqT2JqW2tleV0gIT09ICJvYmplY3QiKSB7CiAgICAgICAgICAgIGNvbnN0IGF0dHIgPSB0aGlzLmlzQXR0cmlidXRlKGtleSk7CiAgICAgICAgICAgIGlmIChhdHRyKSB7CiAgICAgICAgICAgICAgICBhdHRyU3RyICs9ICIgIiArIGF0dHIgKyAnPSInICsgdGhpcy5vcHRpb25zLmF0dHJWYWx1ZVByb2Nlc3NvcigiIiArIGpPYmpba2V5XSkgKyAnIic7CiAgICAgICAgICAgIH0gZWxzZSBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIGlmIChqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdKSB7CiAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucmVwbGFjZUNEQVRBc3RyKGpPYmpbdGhpcy5vcHRpb25zLnRleHROb2RlTmFtZV0sIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQXN0cigiIiwgak9ialtrZXldKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGlmIChrZXkgPT09IHRoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWUpIHsKICAgICAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMuY2RhdGFUYWdOYW1lXSkgOwogICAgICAgICAgICAgICAgICAgIGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmJ1aWxkVGV4dE5vZGUoak9ialtrZXldLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoak9ialtrZXldKSkgewogICAgICAgICAgICBpZiAodGhpcy5pc0NEQVRBKGtleSkpIHsKICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCk7CiAgICAgICAgICAgICAgICBpZiAoak9ialt0aGlzLm9wdGlvbnMudGV4dE5vZGVOYW1lXSkgewogICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLnJlcGxhY2VDREFUQWFycihqT2JqW3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdLCBqT2JqW2tleV0pOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5yZXBsYWNlQ0RBVEFhcnIoIiIsIGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBjb25zdCBhcnJMZW4gPSBqT2JqW2tleV0ubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IGFyckxlbjsgaisrKXsKICAgICAgICAgICAgICAgICAgICBjb25zdCBpdGVtID0gak9ialtrZXldW2pdOwogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2YgaXRlbSA9PT0gInVuZGVmaW5lZCIpIDsKICAgICAgICAgICAgICAgICAgICBlbHNlIGlmIChpdGVtID09PSBudWxsKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbCArPSB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIGlmICh0eXBlb2YgaXRlbSA9PT0gIm9iamVjdCIpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMucHJvY2Vzc1RleHRPck9iak5vZGUoaXRlbSwga2V5LCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsICs9IHRoaXMuYnVpbGRUZXh0Tm9kZShpdGVtLCBrZXksICIiLCBsZXZlbCk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaWYgKHRoaXMub3B0aW9ucy5hdHRyTm9kZU5hbWUgJiYga2V5ID09PSB0aGlzLm9wdGlvbnMuYXR0ck5vZGVOYW1lKSB7CiAgICAgICAgICAgICAgICBjb25zdCBLcyA9IE9iamVjdC5rZXlzKGpPYmpba2V5XSk7CiAgICAgICAgICAgICAgICBjb25zdCBMID0gS3MubGVuZ3RoOwogICAgICAgICAgICAgICAgZm9yKGxldCBqID0gMDsgaiA8IEw7IGorKyl7CiAgICAgICAgICAgICAgICAgICAgYXR0clN0ciArPSAiICIgKyBLc1tqXSArICc9IicgKyB0aGlzLm9wdGlvbnMuYXR0clZhbHVlUHJvY2Vzc29yKCIiICsgak9ialtrZXldW0tzW2pdXSkgKyAnIic7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB2YWwgKz0gdGhpcy5wcm9jZXNzVGV4dE9yT2JqTm9kZShqT2JqW2tleV0sIGtleSwgbGV2ZWwpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHsKICAgICAgICBhdHRyU3RyLAogICAgICAgIHZhbAogICAgfTsKfTsKZnVuY3Rpb24gcHJvY2Vzc1RleHRPck9iak5vZGUob2JqZWN0LCBrZXksIGxldmVsKSB7CiAgICBjb25zdCByZXN1bHQgPSB0aGlzLmoyeChvYmplY3QsIGxldmVsICsgMSk7CiAgICBpZiAob2JqZWN0W3RoaXMub3B0aW9ucy50ZXh0Tm9kZU5hbWVdICE9PSB2b2lkIDAgJiYgT2JqZWN0LmtleXMob2JqZWN0KS5sZW5ndGggPT09IDEpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZFRleHROb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRPYmpOb2RlKHJlc3VsdC52YWwsIGtleSwgcmVzdWx0LmF0dHJTdHIsIGxldmVsKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFzdHIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIHJldHVybiBzdHIucmVwbGFjZSh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIsICI8IVtDREFUQVsiICsgY2RhdGEgKyAiXV0iICsgdGhpcy50YWdFbmRDaGFyKTsKICAgIH0KfQpmdW5jdGlvbiByZXBsYWNlQ0RBVEFhcnIoc3RyLCBjZGF0YSkgewogICAgc3RyID0gdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKCIiICsgc3RyKTsKICAgIGlmICh0aGlzLm9wdGlvbnMuY2RhdGFQb3NpdGlvbkNoYXIgPT09ICIiIHx8IHN0ciA9PT0gIiIpIHsKICAgICAgICByZXR1cm4gc3RyICsgIjwhW0NEQVRBWyIgKyBjZGF0YS5qb2luKCJdXT48IVtDREFUQVsiKSArICJdXSIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9IGVsc2UgewogICAgICAgIGZvcihsZXQgdiBpbiBjZGF0YSl7CiAgICAgICAgICAgIHN0ciA9IHN0ci5yZXBsYWNlKHRoaXMub3B0aW9ucy5jZGF0YVBvc2l0aW9uQ2hhciwgIjwhW0NEQVRBWyIgKyBjZGF0YVt2XSArICJdXT4iKTsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHN0ciArIHRoaXMubmV3TGluZTsKICAgIH0KfQpmdW5jdGlvbiBidWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKSB7CiAgICBpZiAoYXR0clN0ciAmJiB2YWwuaW5kZXhPZigiPCIpID09PSAtMSkgewogICAgICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdmFsICsgIjwvIiArIGtleSArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyB0aGlzLnRhZ0VuZENoYXIgKyB2YWwgKyB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwogICAgfQp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlPYmpOb2RlKHZhbCwga2V5LCBhdHRyU3RyLCBsZXZlbCkgewogICAgaWYgKHZhbCAhPT0gIiIpIHsKICAgICAgICByZXR1cm4gdGhpcy5idWlsZE9iamVjdE5vZGUodmFsLCBrZXksIGF0dHJTdHIsIGxldmVsKTsKICAgIH0gZWxzZSB7CiAgICAgICAgcmV0dXJuIHRoaXMuaW5kZW50YXRlKGxldmVsKSArICI8IiArIGtleSArIGF0dHJTdHIgKyAiLyIgKyB0aGlzLnRhZ0VuZENoYXI7CiAgICB9Cn0KZnVuY3Rpb24gYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLmluZGVudGF0ZShsZXZlbCkgKyAiPCIgKyBrZXkgKyBhdHRyU3RyICsgIj4iICsgdGhpcy5vcHRpb25zLnRhZ1ZhbHVlUHJvY2Vzc29yKHZhbCkgKyAiPC8iICsga2V5ICsgdGhpcy50YWdFbmRDaGFyOwp9CmZ1bmN0aW9uIGJ1aWxkRW1wdHlUZXh0Tm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpIHsKICAgIGlmICh2YWwgIT09ICIiKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuYnVpbGRUZXh0VmFsTm9kZSh2YWwsIGtleSwgYXR0clN0ciwgbGV2ZWwpOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gdGhpcy5pbmRlbnRhdGUobGV2ZWwpICsgIjwiICsga2V5ICsgYXR0clN0ciArICIvIiArIHRoaXMudGFnRW5kQ2hhcjsKICAgIH0KfQpmdW5jdGlvbiBpbmRlbnRhdGUobGV2ZWwpIHsKICAgIHJldHVybiB0aGlzLm9wdGlvbnMuaW5kZW50QnkucmVwZWF0KGxldmVsKTsKfQpmdW5jdGlvbiBpc0F0dHJpYnV0ZShuYW1lKSB7CiAgICBpZiAobmFtZS5zdGFydHNXaXRoKHRoaXMub3B0aW9ucy5hdHRyaWJ1dGVOYW1lUHJlZml4KSkgewogICAgICAgIHJldHVybiBuYW1lLnN1YnN0cih0aGlzLmF0dHJQcmVmaXhMZW4pOwogICAgfSBlbHNlIHsKICAgICAgICByZXR1cm4gZmFsc2U7CiAgICB9Cn0KZnVuY3Rpb24gaXNDREFUQShuYW1lKSB7CiAgICByZXR1cm4gbmFtZSA9PT0gdGhpcy5vcHRpb25zLmNkYXRhVGFnTmFtZTsKfQp2YXIganNvbjJ4bWwgPSBQYXJzZXI7CnZhciBwYXJzZXIgPSBjcmVhdGVDb21tb25qc01vZHVsZShmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKICAgIGNvbnN0IHgyeG1sbm9kZSA9IHhtbHN0cjJ4bWxub2RlOwogICAgY29uc3QgYnVpbGRPcHRpb25zMiA9IHV0aWwuYnVpbGRPcHRpb25zOwogICAgZXhwb3J0cy5wYXJzZSA9IGZ1bmN0aW9uKHhtbERhdGEsIGdpdmVuT3B0aW9ucyA9IHsKICAgIH0sIHZhbGlkYXRpb25PcHRpb24pIHsKICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbikgewogICAgICAgICAgICBpZiAodmFsaWRhdGlvbk9wdGlvbiA9PT0gdHJ1ZSkgdmFsaWRhdGlvbk9wdGlvbiA9IHsKICAgICAgICAgICAgfTsKICAgICAgICAgICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlKHhtbERhdGEsIHZhbGlkYXRpb25PcHRpb24pOwogICAgICAgICAgICBpZiAocmVzdWx0ICE9PSB0cnVlKSB7CiAgICAgICAgICAgICAgICB0aHJvdyBFcnJvcihyZXN1bHQuZXJyLm1zZyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgaWYgKGdpdmVuT3B0aW9ucy5wYXJzZVRydWVOdW1iZXJPbmx5ICYmIGdpdmVuT3B0aW9ucy5wYXJzZU5vZGVWYWx1ZSAhPT0gZmFsc2UgJiYgIWdpdmVuT3B0aW9ucy5udW1QYXJzZU9wdGlvbnMpIHsKICAgICAgICAgICAgZ2l2ZW5PcHRpb25zLm51bVBhcnNlT3B0aW9ucyA9IHsKICAgICAgICAgICAgICAgIGxlYWRpbmdaZXJvczogZmFsc2UKICAgICAgICAgICAgfTsKICAgICAgICB9CiAgICAgICAgbGV0IG9wdGlvbnMgPSBidWlsZE9wdGlvbnMyKGdpdmVuT3B0aW9ucywgeDJ4bWxub2RlLmRlZmF1bHRPcHRpb25zLCB4MnhtbG5vZGUucHJvcHMpOwogICAgICAgIGNvbnN0IHRyYXZlcnNhYmxlT2JqID0geG1sc3RyMnhtbG5vZGUuZ2V0VHJhdmVyc2FsT2JqKHhtbERhdGEsIG9wdGlvbnMpOwogICAgICAgIHJldHVybiBub2RlMmpzb24uY29udmVydFRvSnNvbih0cmF2ZXJzYWJsZU9iaiwgb3B0aW9ucyk7CiAgICB9OwogICAgZXhwb3J0cy5jb252ZXJ0VG9uaW1uID0gbmltbmRhdGEuY29udmVydDJuaW1uOwogICAgZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmogPSB4bWxzdHIyeG1sbm9kZS5nZXRUcmF2ZXJzYWxPYmo7CiAgICBleHBvcnRzLmNvbnZlcnRUb0pzb24gPSBub2RlMmpzb24uY29udmVydFRvSnNvbjsKICAgIGV4cG9ydHMuY29udmVydFRvSnNvblN0cmluZyA9IG5vZGUyanNvbl9zdHIuY29udmVydFRvSnNvblN0cmluZzsKICAgIGV4cG9ydHMudmFsaWRhdGUgPSB2YWxpZGF0b3IudmFsaWRhdGU7CiAgICBleHBvcnRzLmoyeFBhcnNlciA9IGpzb24yeG1sOwogICAgZXhwb3J0cy5wYXJzZVRvTmltbiA9IGZ1bmN0aW9uKHhtbERhdGEsIHNjaGVtYSwgb3B0aW9ucykgewogICAgICAgIHJldHVybiBleHBvcnRzLmNvbnZlcnRUb25pbW4oZXhwb3J0cy5nZXRUcmF2ZXJzYWxPYmooeG1sRGF0YSwgb3B0aW9ucyksIHNjaGVtYSwgb3B0aW9ucyk7CiAgICB9Owp9KTsKcGFyc2VyLmNvbnZlcnRUb0pzb247CnBhcnNlci5jb252ZXJ0VG9Kc29uU3RyaW5nOwpwYXJzZXIuY29udmVydFRvbmltbjsKdmFyIGdldFRyYXZlcnNhbE9iaiQxID0gcGFyc2VyLmdldFRyYXZlcnNhbE9iajsKcGFyc2VyLmoyeFBhcnNlcjsKcGFyc2VyLnBhcnNlOwpwYXJzZXIucGFyc2VUb05pbW47CnBhcnNlci52YWxpZGF0ZTsKZnVuY3Rpb24gcGFyc2VYbWwoeG1sKSB7CiAgICBjb25zdCBydCA9IGdldFRyYXZlcnNhbE9iaiQxKHhtbCwgewogICAgICAgIGlnbm9yZUF0dHJpYnV0ZXM6IGZhbHNlLAogICAgICAgIHBhcnNlQXR0cmlidXRlVmFsdWU6IGZhbHNlLAogICAgICAgIHBhcnNlTm9kZVZhbHVlOiBmYWxzZQogICAgfSk7CiAgICBjb25zdCBuYW1lc3BhY2VzID0gbmV3IFhtbE5hbWVzcGFjZXMoKTsKICAgIGFwcGx5UW5hbWVzKHJ0LCBuYW1lc3BhY2VzKTsKICAgIGNoZWNrRXF1YWwoJ25hbWVzcGFjZXMuc3RhY2tTaXplJywgbmFtZXNwYWNlcy5zdGFja1NpemUsIDApOwogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRyaWJ1dGVNYXAoYXR0cnNNYXApIHsKICAgIGxldCBtYXA7CiAgICBpZiAoYXR0cnNNYXApIHsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoYXR0cnNNYXApKXsKICAgICAgICAgICAgaWYgKCFuYW1lLnN0YXJ0c1dpdGgoJ0BfJykpIHRocm93IG5ldyBFcnJvcihgQmFkIGF0dHJzTWFwIG5hbWU6ICR7bmFtZX0sICR7YXR0cnNNYXB9YCk7CiAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgIG1hcC5zZXQobmFtZS5zdWJzdHJpbmcoMiksIHZhbHVlKTsKICAgICAgICB9CiAgICB9CiAgICByZXR1cm4gbWFwIHx8IEVNUFRZX1NUUklOR19NQVA7Cn0KZnVuY3Rpb24gZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4ucW5hbWVzKSB7CiAgICBsZXQgcnQ7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgcW5hbWUgb2YgcW5hbWVzKXsKICAgICAgICAgICAgZm9yIChjb25zdCBjaGlsZCBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICAgICAgaWYgKHFuYW1lLm5hbWUgPT09ICcqJyA/IHFuYW1lLm5hbWVzcGFjZVVyaSA9PT0gZXh0Q2hpbGQucW5hbWUubmFtZXNwYWNlVXJpIDogcW5hbWVFcShxbmFtZSwgZXh0Q2hpbGQucW5hbWUpKSB7CiAgICAgICAgICAgICAgICAgICAgcnQgPSBydCB8fCBbXTsKICAgICAgICAgICAgICAgICAgICBydC5wdXNoKGV4dENoaWxkKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiBydCB8fCBFTVBUWV9YTUxfTk9ERV9BUlJBWTsKfQpmdW5jdGlvbiBmaW5kRWxlbWVudFJlY3Vyc2l2ZShyb290LCB0ZXN0KSB7CiAgICBpZiAodGVzdChyb290KSkgcmV0dXJuIHJvb3Q7CiAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMocm9vdC5jaGlsZCkpewogICAgICAgIGZvciAoY29uc3QgY2hpbGQgb2YgdmFsdWUpewogICAgICAgICAgICBjb25zdCBleHRDaGlsZCA9IGNoaWxkOwogICAgICAgICAgICBjb25zdCBydCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKGV4dENoaWxkLCB0ZXN0KTsKICAgICAgICAgICAgaWYgKHJ0KSByZXR1cm4gcnQ7CiAgICAgICAgfQogICAgfQogICAgcmV0dXJuIHVuZGVmaW5lZDsKfQpmdW5jdGlvbiBxbmFtZUVxKGxocywgcmhzKSB7CiAgICByZXR1cm4gbGhzLm5hbWUgPT09IHJocy5uYW1lICYmIGxocy5uYW1lc3BhY2VVcmkgPT09IHJocy5uYW1lc3BhY2VVcmk7Cn0KZnVuY3Rpb24gcW5hbWVzSW5jbHVkZShsaHMsIHJocykgewogICAgcmV0dXJuIGxocy5zb21lKCh2KT0+cW5hbWVFcSh2LCByaHMpCiAgICApOwp9CmNvbnN0IEVNUFRZX1NUUklOR19NQVAgPSBuZXcgTWFwKCk7CmNvbnN0IEVNUFRZX1hNTF9OT0RFX0FSUkFZID0gW107CmZ1bmN0aW9uIGFwcGx5UW5hbWVzKG5vZGUsIG5hbWVzcGFjZXMpIHsKICAgIHRyeSB7CiAgICAgICAgY29uc3QgYXR0cyA9IG5hbWVzcGFjZXMucHVzaChub2RlLmF0dHJzTWFwKTsKICAgICAgICBjb25zdCBub2RlQXNBbnkgPSBub2RlOwogICAgICAgIG5vZGVBc0FueS5hdHRzID0gYXR0czsKICAgICAgICBub2RlQXNBbnkucW5hbWUgPSBjb21wdXRlUW5hbWUobm9kZS50YWduYW1lLCBuYW1lc3BhY2VzKTsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlIG9mIE9iamVjdC52YWx1ZXMobm9kZS5jaGlsZCkpewogICAgICAgICAgICBmb3IgKGNvbnN0IGNoaWxkTm9kZSBvZiB2YWx1ZSl7CiAgICAgICAgICAgICAgICBhcHBseVFuYW1lcyhjaGlsZE5vZGUsIG5hbWVzcGFjZXMpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSBmaW5hbGx5ewogICAgICAgIG5hbWVzcGFjZXMucG9wKCk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZVFuYW1lKG5hbWVXaXRoT3B0aW9uYWxQcmVmaXgsIG5hbWVzcGFjZXMpIHsKICAgIGNvbnN0IGkgPSBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LmluZGV4T2YoJzonKTsKICAgIGlmIChpIDwgMCkgcmV0dXJuIHsKICAgICAgICBuYW1lOiBuYW1lV2l0aE9wdGlvbmFsUHJlZml4LAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5maW5kTmFtZXNwYWNlVXJpKCcnKQogICAgfTsKICAgIHJldHVybiB7CiAgICAgICAgbmFtZTogbmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoaSArIDEpLAogICAgICAgIG5hbWVzcGFjZVVyaTogbmFtZXNwYWNlcy5nZXROYW1lc3BhY2VVcmkobmFtZVdpdGhPcHRpb25hbFByZWZpeC5zdWJzdHJpbmcoMCwgaSkpCiAgICB9Owp9CmNsYXNzIFhtbE5hbWVzcGFjZXMgewogICAgc3RhY2sgPSBbXTsKICAgIGdldCBzdGFja1NpemUoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuc3RhY2subGVuZ3RoOwogICAgfQogICAgcHVzaChhdHRyc01hcCkgewogICAgICAgIGNvbnN0IGF0dHJzID0gY29tcHV0ZUF0dHJpYnV0ZU1hcChhdHRyc01hcCk7CiAgICAgICAgbGV0IG1hcDsKICAgICAgICBmb3IgKGNvbnN0IFtuYW1lLCB2YWx1ZV0gb2YgYXR0cnMuZW50cmllcygpKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICd4bWxucycpIHsKICAgICAgICAgICAgICAgIG1hcCA9IG1hcCB8fCBuZXcgTWFwKCk7CiAgICAgICAgICAgICAgICBtYXAuc2V0KCcnLCB2YWx1ZSk7CiAgICAgICAgICAgIH0gZWxzZSBpZiAobmFtZS5zdGFydHNXaXRoKCd4bWxuczonKSkgewogICAgICAgICAgICAgICAgbWFwID0gbWFwIHx8IG5ldyBNYXAoKTsKICAgICAgICAgICAgICAgIGNvbnN0IHByZWZpeCA9IG5hbWUuc3Vic3RyaW5nKDYpOwogICAgICAgICAgICAgICAgbWFwLnNldChwcmVmaXgsIHZhbHVlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICB0aGlzLnN0YWNrLnB1c2gobWFwIHx8IEVNUFRZX1NUUklOR19NQVApOwogICAgICAgIHJldHVybiBhdHRyczsKICAgIH0KICAgIHBvcCgpIHsKICAgICAgICB0aGlzLnN0YWNrLnBvcCgpOwogICAgfQogICAgZmluZE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KICAgIGdldE5hbWVzcGFjZVVyaShwcmVmaXgpIHsKICAgICAgICBmb3IobGV0IGkgPSB0aGlzLnN0YWNrLmxlbmd0aCAtIDE7IGkgPj0gMDsgaS0tKXsKICAgICAgICAgICAgY29uc3QgcnQgPSB0aGlzLnN0YWNrW2ldLmdldChwcmVmaXgpOwogICAgICAgICAgICBpZiAocnQpIHJldHVybiBydDsKICAgICAgICB9CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBnZXROYW1lc3BhY2VVcmk6IHByZWZpeCBub3QgZm91bmQ6ICR7cHJlZml4fWApOwogICAgfQp9CmZ1bmN0aW9uIHZhbGlkYXRlRmVlZFhtbCh4bWwsIGNhbGxiYWNrcykgewogICAgaWYgKHhtbC50YWduYW1lICE9PSAnIXhtbCcpIHJldHVybiBjYWxsYmFja3Mub25FcnJvcih4bWwsIGBCYWQgeG1sLnRhZ25hbWU6ICR7eG1sLnRhZ25hbWV9YCk7CiAgICBpZiAoT2JqZWN0LmtleXMoeG1sLmF0dHJzTWFwKS5sZW5ndGggPiAwKSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgQmFkIHhtbC5hdHRyc01hcDogJHt4bWwuYXR0cnNNYXB9YCk7CiAgICBjb25zdCBkb2NFbGVtZW50ID0gT2JqZWN0LnZhbHVlcyh4bWwuY2hpbGQpLmZsYXRNYXAoKHYpPT52CiAgICApWzBdOwogICAgaWYgKCFkb2NFbGVtZW50KSByZXR1cm4gY2FsbGJhY2tzLm9uRXJyb3IoeG1sLCBgTm8geG1sIHJvb3QgZWxlbWVudGApOwogICAgdmFsaWRhdGVSc3MoZG9jRWxlbWVudCwgY2FsbGJhY2tzKTsKfQpmdW5jdGlvbiBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoaHJlZikgewogICAgcmV0dXJuIHsKICAgICAgICBydWxlc2V0OiAncG9kY2FzdGluZGV4JywKICAgICAgICBocmVmCiAgICB9Owp9CmZ1bmN0aW9uIGdldFNpbmdsZUNoaWxkKG5vZGUsIG5hbWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgY2hpbGRyZW4gPSBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCB7CiAgICAgICAgbmFtZQogICAgfSk7CiAgICBpZiAoY2hpbGRyZW4ubGVuZ3RoICE9PSAxKSB7CiAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgRXhwZWN0ZWQgc2luZ2xlIDwke25hbWV9PiBjaGlsZCBlbGVtZW50IHVuZGVyIDwke25vZGUudGFnbmFtZX0+LCBmb3VuZCAke2NoaWxkcmVuLmxlbmd0aCA9PT0gMCA/ICdub25lJyA6IGNoaWxkcmVuLmxlbmd0aH1gLCBvcHRzKTsKICAgICAgICByZXR1cm4gdW5kZWZpbmVkOwogICAgfQogICAgcmV0dXJuIGNoaWxkcmVuWzBdOwp9CmZ1bmN0aW9uIHZhbGlkYXRlUnNzKHJzcywgY2FsbGJhY2tzKSB7CiAgICBjb25zdCBvcHRzID0gewogICAgICAgIHJlZmVyZW5jZTogewogICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgaHJlZjogJ2h0dHBzOi8vY3liZXIuaGFydmFyZC5lZHUvcnNzL3Jzcy5odG1sI3doYXRJc1JzcycKICAgICAgICB9CiAgICB9OwogICAgaWYgKHJzcy50YWduYW1lICE9PSAncnNzJykgcmV0dXJuIGNhbGxiYWNrcy5vbkVycm9yKHJzcywgYEJhZCB4bWwgcm9vdCB0YWc6ICR7cnNzLnRhZ25hbWV9LCBleHBlY3RlZCByc3NgLCBvcHRzKTsKICAgIGNvbnN0IHZlcnNpb24gPSByc3MuYXR0cy5nZXQoJ3ZlcnNpb24nKTsKICAgIGlmICh2ZXJzaW9uICE9PSAnMi4wJykgY2FsbGJhY2tzLm9uV2FybmluZyhyc3MsIGBCYWQgcnNzLnZlcnNpb246ICR7dmVyc2lvbn0sIGV4cGVjdGVkIDIuMGAsIG9wdHMpOwogICAgY29uc3QgaXR1bmVzT3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL3BvZGNhc3RlcnMuYXBwbGUuY29tL3N1cHBvcnQvODIzLXBvZGNhc3QtcmVxdWlyZW1lbnRzIzp+OnRleHQ9UG9kY2FzdCUyMFJTUyUyMGZlZWQlMjB0ZWNobmljYWwlMjByZXF1aXJlbWVudHMnCiAgICAgICAgfQogICAgfTsKICAgIGNvbnN0IGhhc0l0dW5lc1ByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnaXR1bmVzOicpCiAgICApICE9PSB1bmRlZmluZWQ7CiAgICBpZiAoaGFzSXR1bmVzUHJlZml4KSBjaGVja0F0dHJpYnV0ZUVxdWFsKHJzcywgJ3htbG5zOml0dW5lcycsICdodHRwOi8vd3d3Lml0dW5lcy5jb20vZHRkcy9wb2RjYXN0LTEuMC5kdGQnLCBjYWxsYmFja3MsIGl0dW5lc09wdHMpOwogICAgY29uc3QgaGFzQ29udGVudFByZWZpeCA9IGZpbmRFbGVtZW50UmVjdXJzaXZlKHJzcywgKHYpPT52LnRhZ25hbWUuc3RhcnRzV2l0aCgnY29udGVudDonKQogICAgKSAhPT0gdW5kZWZpbmVkOwogICAgaWYgKGhhc0NvbnRlbnRQcmVmaXgpIGNoZWNrQXR0cmlidXRlRXF1YWwocnNzLCAneG1sbnM6Y29udGVudCcsICdodHRwOi8vcHVybC5vcmcvcnNzLzEuMC9tb2R1bGVzL2NvbnRlbnQvJywgY2FsbGJhY2tzLCBpdHVuZXNPcHRzKTsKICAgIGNvbnN0IGNoYW5uZWwgPSBnZXRTaW5nbGVDaGlsZChyc3MsICdjaGFubmVsJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGlmICghY2hhbm5lbCkgcmV0dXJuOwogICAgdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcyk7Cn0KZnVuY3Rpb24gdmFsaWRhdGVDaGFubmVsKGNoYW5uZWwsIGNhbGxiYWNrcykgewogICAgY29uc3Qgb3B0cyA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ3JzcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNyZXF1aXJlZENoYW5uZWxFbGVtZW50cycKICAgICAgICB9CiAgICB9OwogICAgY29uc3QgdGl0bGUgPSBnZXRTaW5nbGVDaGlsZChjaGFubmVsLCAndGl0bGUnLCBjYWxsYmFja3MsIG9wdHMpOwogICAgY2hlY2tUZXh0KHRpdGxlLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIG9wdHMpOwogICAgY29uc3QgbGluayA9IGdldFNpbmdsZUNoaWxkKGNoYW5uZWwsICdsaW5rJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChsaW5rLCBpc1VybCwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNvbnN0IGRlc2NyaXB0aW9uID0gZ2V0U2luZ2xlQ2hpbGQoY2hhbm5lbCwgJ2Rlc2NyaXB0aW9uJywgY2FsbGJhY2tzLCBvcHRzKTsKICAgIGNoZWNrVGV4dChkZXNjcmlwdGlvbiwgaXNOb3RFbXB0eSwgY2FsbGJhY2tzLCBvcHRzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNndWlkJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguZ3VpZCkuY2hlY2tWYWx1ZShpc1V1aWQsIChndWlkVGV4dCk9PnsKICAgICAgICBjb25zdCB2ZXJzaW9uID0gZ3VpZFRleHQuY2hhckF0KDE0KTsKICAgICAgICBpZiAodmVyc2lvbiAhPT0gJzUnKSB7CiAgICAgICAgICAgIHJldHVybiBgZXhwZWN0ZWQgYSBVVUlEdjUsIGZvdW5kIGEgVVVJRHYke3ZlcnNpb259YDsKICAgICAgICB9CiAgICB9KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NrZWQnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5sb2NrZWQpLmNoZWNrVmFsdWUoKHYpPT4vXih5ZXN8bm8pJC8udGVzdCh2KQogICAgKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdvd25lcicsIGlzRW1haWxBZGRyZXNzKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIGZvciAoY29uc3QgZnVuZGluZyBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmZ1bmRpbmcpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgZnVuZGluZywgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNmdW5kaW5nJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzKTsKICAgIGZvciAoY29uc3QgdHJhaWxlciBvZiBmaW5kQ2hpbGRFbGVtZW50cyhjaGFubmVsLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYWlsZXIpKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgdHJhaWxlciwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFpbGVyJykpLmNoZWNrVmFsdWUoaXNOb3RFbXB0eSkuY2hlY2tWYWx1ZShpc0F0TW9zdENoYXJhY3RlcnMoMTI4KSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndXJsJywgaXNVcmwpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3B1YmRhdGUnLCBpc1JmYzI4MjIpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnc2Vhc29uJywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0TGljZW5zZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBjaGVja1BvZGNhc3RWYWx1ZSgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcyk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnY2hhbm5lbCcsIGNoYW5uZWwsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjbWVkaXVtJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgubWVkaXVtKS5jaGVja1ZhbHVlKGlzUG9kY2FzdE1lZGl1bSkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RJbWFnZXMoJ2NoYW5uZWwnLCBjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3Qgc29jaWFscyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsKTsKICAgIGNvbnN0IHNvY2lhbFJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL3Byb3Bvc2FsLWRvY3Mvc29jaWFsL3NvY2lhbC5tZCNzb2NpYWwtZWxlbWVudCcpOwogICAgY29uc3Qgc29jaWFsU2lnblVwUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9zb2NpYWwvc29jaWFsLm1kI3NvY2lhbHNpZ251cC1lbGVtZW50Jyk7CiAgICBmb3IgKGNvbnN0IHNvY2lhbCBvZiBzb2NpYWxzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdjaGFubmVsJywgc29jaWFsLCBjYWxsYmFja3MsIHNvY2lhbFJlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncGxhdGZvcm0nLCBpc05vdEVtcHR5KS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdwb2RjYXN0QWNjb3VudElkJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncG9kY2FzdEFjY291bnRVcmwnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHJpb3JpdHknLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgY29uc3Qgc29jaWFsU2lnblVwcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsU2lnblVwKTsKICAgICAgICBmb3IgKGNvbnN0IHNvY2lhbFNpZ25VcCBvZiBzb2NpYWxTaWduVXBzKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgnc29jaWFsJywgc29jaWFsU2lnblVwLCBjYWxsYmFja3MsIHNvY2lhbFNpZ25VcFJlZmVyZW5jZSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnaG9tZVVybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdzaWduVXBVcmwnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgncHJpb3JpdHknLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICAgICAgfQogICAgfQogICAgY29uc3QgYmFkU29jaWFsU2lnbnVwcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGNoYW5uZWwsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc29jaWFsU2lnblVwKTsKICAgIGlmIChiYWRTb2NpYWxTaWdudXBzLmxlbmd0aCA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKGJhZFNvY2lhbFNpZ251cHNbMF0sIGBCYWQgPCR7YmFkU29jaWFsU2lnbnVwc1swXS50YWduYW1lfT46IHNob3VsZCBiZSBhIGNoaWxkIG9mIDxwb2RjYXN0OnNvY2lhbD4sIG5vdCBjaGFubmVsYCk7CiAgICB9CiAgICBjb25zdCBwb2RwaW5nUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9wb2RwaW5nL3BvZHBpbmcubWQjc3BlY2lmaWNhdGlvbicpOwogICAgY29uc3QgcG9kcGluZyA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdjaGFubmVsJywgY2hhbm5lbCwgY2FsbGJhY2tzLCBwb2RwaW5nUmVmZXJlbmNlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBvZHBpbmcpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3VzZXNQb2RwaW5nJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKS5ub2RlOwogICAgaWYgKHBvZHBpbmcpIHsKICAgICAgICBmb3IgKGNvbnN0IGhpdmVBY2NvdW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHBvZHBpbmcsIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguaGl2ZUFjY291bnQpKXsKICAgICAgICAgICAgRWxlbWVudFZhbGlkYXRpb24uZm9yRWxlbWVudCgncG9kcGluZycsIGhpdmVBY2NvdW50LCBjYWxsYmFja3MsIHBvZHBpbmdSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2FjY291bnQnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9CiAgICBjaGVja1BvZGNhc3RUYWdVc2FnZShjaGFubmVsLCBjYWxsYmFja3MpOwogICAgY29uc3QgaXRlbXMgPSBjaGFubmVsLmNoaWxkLml0ZW0gfHwgW107CiAgICBsZXQgaXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ID0gMDsKICAgIGxldCBpdGVtc1ZhbGlkYXRlZCA9IDA7CiAgICBmb3IgKGNvbnN0IGl0ZW0gb2YgaXRlbXMpewogICAgICAgIGlmIChpdGVtc1ZhbGlkYXRlZCA8IDEpIHsKICAgICAgICAgICAgdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcyk7CiAgICAgICAgICAgIGl0ZW1zVmFsaWRhdGVkKys7CiAgICAgICAgfQogICAgICAgIGNvbnN0IGVsZW1lbnRzID0gZmluZENoaWxkRWxlbWVudHMoaXRlbSwgewogICAgICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgICAgIH0pOwogICAgICAgIGlmIChlbGVtZW50cy5sZW5ndGggPiAwKSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQrKzsKICAgIH0KICAgIGNhbGxiYWNrcy5vblJzc0l0ZW1zRm91bmQoaXRlbXMubGVuZ3RoLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpOwp9CmZ1bmN0aW9uIGNoZWNrUG9kY2FzdFBlcnNvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBmb3IgKGNvbnN0IHBlcnNvbiBvZiBmaW5kQ2hpbGRFbGVtZW50cyhub2RlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnBlcnNvbikpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQobGV2ZWwsIHBlcnNvbiwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNwZXJzb24nKSkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyb2xlJywgaXNOb3RFbXB0eSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZ3JvdXAnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdpbWcnLCBpc1VybCkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnaHJlZicsIGlzVXJsKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMb2NhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZChsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNsb2NhdGlvbicpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmxvY2F0aW9uKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdnZW8nLCBpc0dlb0xhdExvbikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnb3NtJywgaXNPcGVuU3RyZWV0TWFwSWRlbnRpZmllcikuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RMaWNlbnNlKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2xpY2Vuc2UnKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5saWNlbnNlKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tWYWx1ZShpc05vdEVtcHR5KS5jaGVja1ZhbHVlKGlzQXRNb3N0Q2hhcmFjdGVycygxMjgpKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RWYWx1ZShsZXZlbCwgbm9kZSwgY2FsbGJhY2tzKSB7CiAgICBjb25zdCB2YWx1ZSA9IEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3ZhbHVlJyksIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXgudmFsdWUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdtZXRob2QnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdzdWdnZXN0ZWQnLCBpc0RlY2ltYWwpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpLm5vZGU7CiAgICBpZiAodmFsdWUpIHsKICAgICAgICBmb3IgKGNvbnN0IHZhbHVlUmVjaXBpZW50IG9mIGZpbmRDaGlsZEVsZW1lbnRzKHZhbHVlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnZhbHVlUmVjaXBpZW50KSl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ3ZhbHVlJywgdmFsdWVSZWNpcGllbnQsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjdmFsdWUtcmVjaXBpZW50JykpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21LZXknLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjdXN0b21WYWx1ZScsIGlzTm90RW1wdHkpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3R5cGUnLCBpc1BvZGNhc3RWYWx1ZVR5cGVTbHVnKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCdhZGRyZXNzJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3BsaXQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnZmVlJywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICB9CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tQb2RjYXN0SW1hZ2VzKGxldmVsLCBub2RlLCBjYWxsYmFja3MpIHsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKGxldmVsLCBub2RlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ltYWdlcycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmltYWdlcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnc3Jjc2V0JywgaXNQb2RjYXN0SW1hZ2VzU3JjU2V0KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKfQpmdW5jdGlvbiBjaGVja1BvZGNhc3RUYWdVc2FnZShub2RlLCBjYWxsYmFja3MpIHsKICAgIGNvbnN0IGtub3duID0gbmV3IFNldCgpOwogICAgY29uc3QgdW5rbm93biA9IG5ldyBTZXQoKTsKICAgIGNvbnN0IG5hbWVzcGFjZVVyaXMgPSBuZXcgU2V0KCk7CiAgICBmb3IgKGNvbnN0IGVsZW1lbnQgb2YgZmluZENoaWxkRWxlbWVudHMobm9kZSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLm1hcCgodik9Pih7CiAgICAgICAgICAgIG5hbWU6ICcqJywKICAgICAgICAgICAgbmFtZXNwYWNlVXJpOiB2CiAgICAgICAgfSkKICAgICkpKXsKICAgICAgICBjb25zdCBpc0tub3duID0gUW5hbWVzLlBvZGNhc3RJbmRleC5LTk9XTl9OQU1FUy5oYXMoZWxlbWVudC5xbmFtZS5uYW1lKTsKICAgICAgICAoaXNLbm93biA/IGtub3duIDogdW5rbm93bikuYWRkKGVsZW1lbnQucW5hbWUubmFtZSk7CiAgICAgICAgaWYgKGVsZW1lbnQucW5hbWUubmFtZXNwYWNlVXJpKSBuYW1lc3BhY2VVcmlzLmFkZChlbGVtZW50LnFuYW1lLm5hbWVzcGFjZVVyaSk7CiAgICB9CiAgICBpZiAoa25vd24uc2l6ZSArIHVua25vd24uc2l6ZSA+IDApIHsKICAgICAgICBjYWxsYmFja3Mub25Qb2RjYXN0SW5kZXhUYWdOYW1lc0ZvdW5kKGtub3duLCB1bmtub3duLCBuYW1lc3BhY2VVcmlzKTsKICAgIH0KfQpmdW5jdGlvbiBjaGVja0F0dHJpYnV0ZUVxdWFsKG5vZGUsIGF0dE5hbWUsIGF0dEV4cGVjdGVkVmFsdWUsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgY29uc3QgYXR0VmFsdWUgPSBub2RlLmF0dHMuZ2V0KGF0dE5hbWUpOwogICAgaWYgKCFhdHRWYWx1ZSkgewogICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYE1pc3NpbmcgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUsIGV4cGVjdGVkICR7YXR0RXhwZWN0ZWRWYWx1ZX1gLCBvcHRzKTsKICAgIH0gZWxzZSBpZiAoYXR0VmFsdWUgIT09IGF0dEV4cGVjdGVkVmFsdWUpIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBCYWQgPCR7bm9kZS50YWduYW1lfT4gJHthdHROYW1lfSBhdHRyaWJ1dGUgdmFsdWU6ICR7YXR0VmFsdWV9LCBleHBlY3RlZCAke2F0dEV4cGVjdGVkVmFsdWV9YCwgb3B0cyk7CiAgICB9Cn0KZnVuY3Rpb24gY2hlY2tUZXh0KG5vZGUsIHRlc3QsIGNhbGxiYWNrcywgb3B0cyA9IHsKfSkgewogICAgaWYgKG5vZGUpIHsKICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IChub2RlLnZhbCB8fCAnJykudHJpbSgpOwogICAgICAgIGlmICghdGVzdCh0cmltbWVkVGV4dCkpIHsKICAgICAgICAgICAgY2FsbGJhY2tzLm9uV2FybmluZyhub2RlLCBgQmFkIDwke25vZGUudGFnbmFtZX0+IHZhbHVlOiAke3RyaW1tZWRUZXh0ID09PSAnJyA/ICc8ZW1wdHk+JyA6IHRyaW1tZWRUZXh0fWAsIG9wdHMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJpbW1lZFRleHQ7CiAgICB9CiAgICByZXR1cm4gdW5kZWZpbmVkOwp9CmZ1bmN0aW9uIGZpbmRGaXJzdENoaWxkRWxlbWVudChub2RlLCBxbmFtZSwgY2FsbGJhY2tzLCBvcHRzID0gewp9KSB7CiAgICBjb25zdCBlbGVtZW50cyA9IGZpbmRDaGlsZEVsZW1lbnRzKG5vZGUsIHFuYW1lKTsKICAgIGlmIChlbGVtZW50cy5sZW5ndGggPT09IDApIHsKICAgICAgICBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBJdGVtIGlzIG1pc3NpbmcgYW4gPCR7cW5hbWUubmFtZX0+IGVsZW1lbnRgLCBvcHRzKTsKICAgIH0gZWxzZSB7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEl0ZW0gaGFzIG11bHRpcGxlIDwke3FuYW1lLm5hbWV9PiBlbGVtZW50c2AsIG9wdHMpOwogICAgICAgIHJldHVybiBlbGVtZW50c1swXTsKICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KZnVuY3Rpb24gdmFsaWRhdGVJdGVtKGl0ZW0sIGNhbGxiYWNrcykgewogICAgY29uc3QgaXR1bmVzT3B0czEgPSB7CiAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgIHJ1bGVzZXQ6ICdpdHVuZXMnLAogICAgICAgICAgICBocmVmOiAnaHR0cHM6Ly9wb2RjYXN0ZXJzLmFwcGxlLmNvbS9zdXBwb3J0LzgyMy1wb2RjYXN0LXJlcXVpcmVtZW50cyM6fjp0ZXh0PVBvZGNhc3QlMjBSU1MlMjBmZWVkJTIwdGVjaG5pY2FsJTIwcmVxdWlyZW1lbnRzJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCBpdHVuZXNPcHRzMiA9IHsKICAgICAgICByZWZlcmVuY2U6IHsKICAgICAgICAgICAgcnVsZXNldDogJ2l0dW5lcycsCiAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2hlbHAuYXBwbGUuY29tL2l0Yy9wb2RjYXN0c19jb25uZWN0LyMvaXRjYjU0MzUzMzkwJwogICAgICAgIH0KICAgIH07CiAgICBjb25zdCB0aXRsZSA9IGZpbmRGaXJzdENoaWxkRWxlbWVudChpdGVtLCB7CiAgICAgICAgbmFtZTogJ3RpdGxlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAodGl0bGUpIHsKICAgICAgICBjaGVja1RleHQodGl0bGUsIGlzTm90RW1wdHksIGNhbGxiYWNrcywgaXR1bmVzT3B0czIpOwogICAgfQogICAgY29uc3QgZW5jbG9zdXJlID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZW5jbG9zdXJlJwogICAgfSwgY2FsbGJhY2tzLCBpdHVuZXNPcHRzMik7CiAgICBpZiAoZW5jbG9zdXJlKSB7CiAgICAgICAgY29uc3QgcnNzRW5jbG9zdXJlT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGVuY2xvc3VyZWd0U3ViZWxlbWVudE9mTHRpdGVtZ3QnCiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IHVybCA9IGVuY2xvc3VyZS5hdHRzLmdldCgndXJsJyk7CiAgICAgICAgaWYgKCF1cmwpIGNhbGxiYWNrcy5vbldhcm5pbmcoZW5jbG9zdXJlLCBgTWlzc2luZyBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodXJsICYmICFpc1VybCh1cmwpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IHVybCBhdHRyaWJ1dGUgdmFsdWU6ICR7dXJsfSwgZXhwZWN0ZWQgdXJsYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICAgICAgY29uc3QgbGVuZ3RoID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCdsZW5ndGgnKTsKICAgICAgICBpZiAoIWxlbmd0aCkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBNaXNzaW5nIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAobGVuZ3RoICYmICFpc05vbk5lZ2F0aXZlSW50ZWdlcihsZW5ndGgpKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYEJhZCBpdGVtIDxlbmNsb3N1cmU+IGxlbmd0aCBhdHRyaWJ1dGUgdmFsdWU6ICR7bGVuZ3RofSwgZXhwZWN0ZWQgbm9uLW5lZ2F0aXZlIGludGVnZXJgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBjb25zdCB0eXBlID0gZW5jbG9zdXJlLmF0dHMuZ2V0KCd0eXBlJyk7CiAgICAgICAgaWYgKCF0eXBlKSBjYWxsYmFja3Mub25XYXJuaW5nKGVuY2xvc3VyZSwgYE1pc3NpbmcgPGVuY2xvc3VyZT4gdHlwZSBhdHRyaWJ1dGVgLCByc3NFbmNsb3N1cmVPcHRzKTsKICAgICAgICBpZiAodHlwZSAmJiAhaXNNaW1lVHlwZSh0eXBlKSkgY2FsbGJhY2tzLm9uV2FybmluZyhlbmNsb3N1cmUsIGBCYWQgaXRlbSA8ZW5jbG9zdXJlPiB0eXBlIGF0dHJpYnV0ZSB2YWx1ZTogJHt0eXBlfSwgZXhwZWN0ZWQgTUlNRSB0eXBlYCwgcnNzRW5jbG9zdXJlT3B0cyk7CiAgICB9CiAgICBjb25zdCBndWlkID0gZmluZEZpcnN0Q2hpbGRFbGVtZW50KGl0ZW0sIHsKICAgICAgICBuYW1lOiAnZ3VpZCcKICAgIH0sIGNhbGxiYWNrcywgaXR1bmVzT3B0czEpOwogICAgaWYgKGd1aWQpIHsKICAgICAgICBjb25zdCBndWlkVGV4dCA9IGNoZWNrVGV4dChndWlkLCBpc05vdEVtcHR5LCBjYWxsYmFja3MsIGl0dW5lc09wdHMxKTsKICAgICAgICBjb25zdCByc3NHdWlkT3B0cyA9IHsKICAgICAgICAgICAgcmVmZXJlbmNlOiB7CiAgICAgICAgICAgICAgICBydWxlc2V0OiAncnNzJywKICAgICAgICAgICAgICAgIGhyZWY6ICdodHRwczovL2N5YmVyLmhhcnZhcmQuZWR1L3Jzcy9yc3MuaHRtbCNsdGd1aWRndFN1YmVsZW1lbnRPZkx0aXRlbWd0JwogICAgICAgICAgICB9CiAgICAgICAgfTsKICAgICAgICBjb25zdCBtaXNzcGVsbGluZ3MgPSBbCiAgICAgICAgICAgIC4uLmd1aWQuYXR0cy5rZXlzKCkKICAgICAgICBdLmZpbHRlcigodik9PnYgIT09ICdpc1Blcm1hTGluaycgJiYgdi50b0xvd2VyQ2FzZSgpID09PSAnaXNwZXJtYWxpbmsnCiAgICAgICAgKTsKICAgICAgICBmb3IgKGNvbnN0IG1pc3NwZWxsaW5nIG9mIG1pc3NwZWxsaW5ncyl7CiAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcoZ3VpZCwgYEJhZCBpdGVtIDxndWlkPiBpc1Blcm1hTGluayBhdHRyaWJ1dGUgc3BlbGxpbmc6ICR7bWlzc3BlbGxpbmd9YCwgcnNzR3VpZE9wdHMpOwogICAgICAgIH0KICAgICAgICBjb25zdCBpc1Blcm1hTGluayA9IGd1aWQuYXR0cy5nZXQoJ2lzUGVybWFMaW5rJykgfHwgJ3RydWUnOwogICAgICAgIGlmIChpc1Blcm1hTGluayA9PT0gJ3RydWUnICYmIGd1aWRUZXh0ICYmICFpc1VybChndWlkVGV4dCkgJiYgbWlzc3BlbGxpbmdzLmxlbmd0aCA9PT0gMCkgY2FsbGJhY2tzLm9uV2FybmluZyhndWlkLCBgQmFkIGl0ZW0gPGd1aWQ+IHZhbHVlOiAke2d1aWRUZXh0fSwgZXhwZWN0ZWQgdXJsIHdoZW4gaXNQZXJtYUxpbms9InRydWUiIG9yIHVuc3BlY2lmaWVkYCwgcnNzR3VpZE9wdHMpOwogICAgfQogICAgY29uc3QgdHJhbnNjcmlwdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnRyYW5zY3JpcHQpOwogICAgZm9yIChjb25zdCB0cmFuc2NyaXB0IG9mIHRyYW5zY3JpcHRzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgdHJhbnNjcmlwdCwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCN0cmFuc2NyaXB0JykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VybCcsIGlzVXJsKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd0eXBlJywgaXNNaW1lVHlwZSkuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZ3VhZ2UnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdyZWwnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgIH0KICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNjaGFwdGVycycpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmNoYXB0ZXJzKS5jaGVja1JlcXVpcmVkQXR0cmlidXRlKCd1cmwnLCBpc1VybCkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgY29uc3Qgc291bmRiaXRlcyA9IGZpbmRDaGlsZEVsZW1lbnRzKGl0ZW0sIC4uLlFuYW1lcy5Qb2RjYXN0SW5kZXguc291bmRiaXRlKTsKICAgIGZvciAoY29uc3Qgc291bmRiaXRlIG9mIHNvdW5kYml0ZXMpewogICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2l0ZW0nLCBzb3VuZGJpdGUsIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjc291bmRiaXRlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3N0YXJ0VGltZScsIGlzU2Vjb25kcykuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgnZHVyYXRpb24nLCBpc1NlY29uZHMpLmNoZWNrVmFsdWUoaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgfQogICAgY2hlY2tQb2RjYXN0UGVyc29uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdExvY2F0aW9uKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvclNpbmdsZUNoaWxkKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNzZWFzb24nKSwgLi4uUW5hbWVzLlBvZGNhc3RJbmRleC5zZWFzb24pLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ25hbWUnLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDEyOCkodikKICAgICkuY2hlY2tWYWx1ZShpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcywgcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQjZXBpc29kZScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmVwaXNvZGUpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ2Rpc3BsYXknLCAodik9PmlzTm90RW1wdHkodikgJiYgaXNBdE1vc3RDaGFyYWN0ZXJzKDMyKSh2KQogICAgKS5jaGVja1ZhbHVlKGlzRGVjaW1hbCkuY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCk7CiAgICBjaGVja1BvZGNhc3RMaWNlbnNlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZXMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmFsdGVybmF0ZUVuY2xvc3VyZSk7CiAgICBmb3IgKGNvbnN0IGFsdGVybmF0ZUVuY2xvc3VyZSBvZiBhbHRlcm5hdGVFbmNsb3N1cmVzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2FsdGVybmF0ZS1lbmNsb3N1cmUnKSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ2xlbmd0aCcsIGlzTm9uTmVnYXRpdmVJbnRlZ2VyKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdiaXRyYXRlJywgaXNEZWNpbWFsKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdoZWlnaHQnLCBpc05vbk5lZ2F0aXZlSW50ZWdlcikuY2hlY2tPcHRpb25hbEF0dHJpYnV0ZSgnbGFuZycsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3RpdGxlJywgKHYpPT5pc05vdEVtcHR5KHYpICYmIGlzQXRNb3N0Q2hhcmFjdGVycygzMikodikKICAgICAgICApLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3JlbCcsICh2KT0+aXNOb3RFbXB0eSh2KSAmJiBpc0F0TW9zdENoYXJhY3RlcnMoMzIpKHYpCiAgICAgICAgKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb2RlY3MnLCBpc05vdEVtcHR5KS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdkZWZhdWx0JywgaXNCb29sZWFuKS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JTaW5nbGVDaGlsZCgnYWx0ZXJuYXRlRW5jbG9zdXJlJywgYWx0ZXJuYXRlRW5jbG9zdXJlLCBjYWxsYmFja3MsIHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI2ludGVncml0eScpLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LmludGVncml0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndHlwZScsICh2KT0+L14oc3JpfHBncC1zaWduYXR1cmUpJC8udGVzdCh2KQogICAgICAgICkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgndmFsdWUnLCBpc05vdEVtcHR5KS5jaGVja1JlbWFpbmluZ0F0dHJpYnV0ZXMoKTsKICAgICAgICBjb25zdCBzb3VyY2VzID0gZmluZENoaWxkRWxlbWVudHMoYWx0ZXJuYXRlRW5jbG9zdXJlLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvdXJjZSk7CiAgICAgICAgZm9yIChjb25zdCBzb3VyY2Ugb2Ygc291cmNlcyl7CiAgICAgICAgICAgIEVsZW1lbnRWYWxpZGF0aW9uLmZvckVsZW1lbnQoJ2FsdGVybmF0ZUVuY2xvc3VyZScsIHNvdXJjZSwgY2FsbGJhY2tzLCBwb2RjYXN0SW5kZXhSZWZlcmVuY2UoJ2h0dHBzOi8vZ2l0aHViLmNvbS9Qb2RjYXN0aW5kZXgtb3JnL3BvZGNhc3QtbmFtZXNwYWNlL2Jsb2IvbWFpbi9kb2NzLzEuMC5tZCNhbHRlcm5hdGUtZW5jbG9zdXJlJykpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3VyaScsIGlzVXJpKS5jaGVja09wdGlvbmFsQXR0cmlidXRlKCdjb250ZW50VHlwZScsIGlzTWltZVR5cGUpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIH0KICAgIH0KICAgIGNoZWNrUG9kY2FzdFZhbHVlKCdpdGVtJywgaXRlbSwgY2FsbGJhY2tzKTsKICAgIGNoZWNrUG9kY2FzdEltYWdlcygnaXRlbScsIGl0ZW0sIGNhbGxiYWNrcyk7CiAgICBjb25zdCBzb2NpYWxJbnRlcmFjdHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhpdGVtLCAuLi5RbmFtZXMuUG9kY2FzdEluZGV4LnNvY2lhbEludGVyYWN0KTsKICAgIGNvbnN0IHNvY2lhbEludGVyYWN0UmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vcHJvcG9zYWwtZG9jcy9zb2NpYWwvc29jaWFsLm1kI3NvY2lhbGludGVyYWN0LWVsZW1lbnQnKTsKICAgIGZvciAoY29uc3Qgc29jaWFsSW50ZXJhY3Qgb2Ygc29jaWFsSW50ZXJhY3RzKXsKICAgICAgICBFbGVtZW50VmFsaWRhdGlvbi5mb3JFbGVtZW50KCdpdGVtJywgc29jaWFsSW50ZXJhY3QsIGNhbGxiYWNrcywgc29jaWFsSW50ZXJhY3RSZWZlcmVuY2UpLmNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUoJ3BsYXRmb3JtJywgaXNOb3RFbXB0eSkuY2hlY2tSZXF1aXJlZEF0dHJpYnV0ZSgncG9kY2FzdEFjY291bnRJZCcsIGlzTm90RW1wdHkpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3B1YkRhdGUnLCBpc0lzbzg2MDEpLmNoZWNrT3B0aW9uYWxBdHRyaWJ1dGUoJ3ByaW9yaXR5JywgaXNOb25OZWdhdGl2ZUludGVnZXIpLmNoZWNrVmFsdWUoaXNVcmkpLmNoZWNrUmVtYWluaW5nQXR0cmlidXRlcygpOwogICAgICAgIGNhbGxiYWNrcy5vbkdvb2Qoc29jaWFsSW50ZXJhY3QsICdGb3VuZCA8cG9kY2FzdDpzb2NpYWxJbnRlcmFjdD4sIG5pY2UhJywgewogICAgICAgICAgICB0YWc6ICdzb2NpYWwtaW50ZXJhY3QnLAogICAgICAgICAgICByZWZlcmVuY2U6IHNvY2lhbEludGVyYWN0UmVmZXJlbmNlCiAgICAgICAgfSk7CiAgICB9CiAgICBjaGVja1BvZGNhc3RUYWdVc2FnZShpdGVtLCBjYWxsYmFja3MpOwp9CmNsYXNzIEVsZW1lbnRWYWxpZGF0aW9uIHsKICAgIHN0YXRpYyBFTVBUWV9TVFJJTkdfU0VUID0gbmV3IFNldCgpOwogICAgbm9kZTsKICAgIGxldmVsOwogICAgY2FsbGJhY2tzOwogICAgb3B0czsKICAgIHJlbWFpbmluZ0F0dE5hbWVzOwogICAgY29uc3RydWN0b3IobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgb3B0cyl7CiAgICAgICAgdGhpcy5sZXZlbCA9IGxldmVsOwogICAgICAgIHRoaXMubm9kZSA9IG5vZGU7CiAgICAgICAgdGhpcy5jYWxsYmFja3MgPSBjYWxsYmFja3M7CiAgICAgICAgdGhpcy5vcHRzID0gb3B0czsKICAgICAgICB0aGlzLnJlbWFpbmluZ0F0dE5hbWVzID0gbm9kZSA/IG5ldyBTZXQobm9kZS5hdHRzLmtleXMoKSkgOiBFbGVtZW50VmFsaWRhdGlvbi5FTVBUWV9TVFJJTkdfU0VUOwogICAgfQogICAgc3RhdGljIGZvckVsZW1lbnQobGV2ZWwsIG5vZGUsIGNhbGxiYWNrcywgcmVmZXJlbmNlKSB7CiAgICAgICAgcmV0dXJuIG5ldyBFbGVtZW50VmFsaWRhdGlvbihsZXZlbCwgbm9kZSwgY2FsbGJhY2tzLCB7CiAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgIH0pOwogICAgfQogICAgc3RhdGljIGZvclNpbmdsZUNoaWxkKGxldmVsLCBwYXJlbnQsIGNhbGxiYWNrcywgcmVmZXJlbmNlLCAuLi5xbmFtZXMpIHsKICAgICAgICBjaGVja1RydWUoJ3FuYW1lcy5sZW5ndGgnLCBxbmFtZXMubGVuZ3RoLCBxbmFtZXMubGVuZ3RoID4gMCk7CiAgICAgICAgY29uc3QgZWxlbWVudHMgPSBmaW5kQ2hpbGRFbGVtZW50cyhwYXJlbnQsIC4uLnFuYW1lcyk7CiAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgaWYgKGVsZW1lbnRzLmxlbmd0aCA+IDEpIGNhbGxiYWNrcy5vbldhcm5pbmcoZWxlbWVudHNbMV0sIGBNdWx0aXBsZSAke2xldmVsfSA8JHtlbGVtZW50c1sxXS50YWduYW1lfT4gZWxlbWVudHMgYXJlIG5vdCBhbGxvd2VkYCwgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBjb25zdCBlbGVtZW50ID0gZWxlbWVudHNbMF07CiAgICAgICAgICAgIHJldHVybiBuZXcgRWxlbWVudFZhbGlkYXRpb24obGV2ZWwsIGVsZW1lbnQsIGNhbGxiYWNrcywgewogICAgICAgICAgICAgICAgcmVmZXJlbmNlCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgICAgICByZXR1cm4gbmV3IEVsZW1lbnRWYWxpZGF0aW9uKGxldmVsLCB1bmRlZmluZWQsIGNhbGxiYWNrcywgewogICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICB9KTsKICAgIH0KICAgIGNoZWNrVmFsdWUodGVzdCwgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICBjb25zdCB7IG5vZGUgLCBjYWxsYmFja3MgLCBvcHRzICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB0cmltbWVkVGV4dCA9IGNoZWNrVGV4dChub2RlLCB0ZXN0LCBjYWxsYmFja3MsIG9wdHMpOwogICAgICAgICAgICBpZiAodHJpbW1lZFRleHQgJiYgYWRkaXRpb25hbFRlc3QpIHsKICAgICAgICAgICAgICAgIGNvbnN0IHdhcm5pbmdTdWZmaXggPSBhZGRpdGlvbmFsVGVzdCh0cmltbWVkVGV4dCk7CiAgICAgICAgICAgICAgICBpZiAod2FybmluZ1N1ZmZpeCkgewogICAgICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCA8JHtub2RlLnRhZ25hbWV9PiB2YWx1ZTogJHt0cmltbWVkVGV4dCA9PT0gJycgPyAnPGVtcHR5PicgOiB0cmltbWVkVGV4dH0sICR7d2FybmluZ1N1ZmZpeH1gLCBvcHRzKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0KICAgICAgICByZXR1cm4gdGhpczsKICAgIH0KICAgIGNoZWNrUmVxdWlyZWRBdHRyaWJ1dGUobmFtZSwgdGVzdCkgewogICAgICAgIGNvbnN0IHsgbm9kZSAsIGNhbGxiYWNrcyAsIG9wdHMgLCBsZXZlbCAgfSA9IHRoaXM7CiAgICAgICAgaWYgKG5vZGUpIHsKICAgICAgICAgICAgY29uc3QgdmFsdWUgPSBub2RlLmF0dHMuZ2V0KG5hbWUpOwogICAgICAgICAgICBpZiAoIXZhbHVlKSBjYWxsYmFja3Mub25XYXJuaW5nKG5vZGUsIGBNaXNzaW5nICR7bGV2ZWx9IDwke25vZGUudGFnbmFtZX0+ICR7bmFtZX0gYXR0cmlidXRlYCwgb3B0cyk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tPcHRpb25hbEF0dHJpYnV0ZShuYW1lLCB0ZXN0KSB7CiAgICAgICAgY29uc3QgeyBub2RlICwgY2FsbGJhY2tzICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBjb25zdCB2YWx1ZSA9IG5vZGUuYXR0cy5nZXQobmFtZSk7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAhdGVzdCh2YWx1ZSkpIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiAke25hbWV9IGF0dHJpYnV0ZSB2YWx1ZTogJHt2YWx1ZX1gLCBvcHRzKTsKICAgICAgICAgICAgdGhpcy5yZW1haW5pbmdBdHROYW1lcy5kZWxldGUobmFtZSk7CiAgICAgICAgfQogICAgICAgIHJldHVybiB0aGlzOwogICAgfQogICAgY2hlY2tSZW1haW5pbmdBdHRyaWJ1dGVzKCkgewogICAgICAgIGNvbnN0IHsgcmVtYWluaW5nQXR0TmFtZXMgLCBjYWxsYmFja3MgLCBub2RlICwgb3B0cyAsIGxldmVsICB9ID0gdGhpczsKICAgICAgICBpZiAobm9kZSkgewogICAgICAgICAgICBpZiAocmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgIGNhbGxiYWNrcy5vbldhcm5pbmcobm9kZSwgYEJhZCAke2xldmVsfSA8JHtub2RlLnRhZ25hbWV9PiBhdHRyaWJ1dGUgbmFtZSR7cmVtYWluaW5nQXR0TmFtZXMuc2l6ZSA+IDEgPyAncycgOiAnJ306ICR7WwogICAgICAgICAgICAgICAgICAgIC4uLnJlbWFpbmluZ0F0dE5hbWVzCiAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgb3B0cyk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgcmV0dXJuIHRoaXM7CiAgICB9Cn0KZnVuY3Rpb24gaXNSZWFkb25seUFycmF5KGFyZykgewogICAgcmV0dXJuIEFycmF5LmlzQXJyYXkoYXJnKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRzRm9yVXJsKHVybCwgc3ViamVjdCwgb3B0cykgewogICAgY29uc3Qgcm9vdENvbW1lbnQgPSBhd2FpdCBmZXRjaENvbW1lbnRzRm9yVXJsXyh1cmwsIG9wdHMpOwogICAgaWYgKCFyb290Q29tbWVudCkgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IGNvbW1lbnRlcnMgPSBhd2FpdCBjb2xsZWN0Q29tbWVudGVycyhyb290Q29tbWVudCwgb3B0cyk7CiAgICByZXR1cm4gewogICAgICAgIHN1YmplY3QsCiAgICAgICAgcm9vdENvbW1lbnQsCiAgICAgICAgY29tbWVudGVycwogICAgfTsKfQpmdW5jdGlvbiBjb21wdXRlQ29tbWVudENvdW50KGNvbW1lbnQpIHsKICAgIHJldHVybiAxICsgY29tbWVudC5yZXBsaWVzLm1hcChjb21wdXRlQ29tbWVudENvdW50KS5yZWR1Y2UoKGEsIGIpPT5hICsgYgogICAgLCAwKTsKfQphc3luYyBmdW5jdGlvbiBmZXRjaENvbW1lbnRzRm9yVXJsXyh1cmwsIG9wdHMpIHsKICAgIGNvbnN0IHsgZmV0Y2hBY3Rpdml0eVB1YiAgfSA9IG9wdHM7CiAgICBjb25zdCBvYmogPSBvcHRzLm9iaiB8fCBhd2FpdCBmZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGlmIChvYmoudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uJykgewogICAgICAgIGNvbnN0IGVtcHR5Q29tbWVudCA9IHsKICAgICAgICAgICAgY29udGVudDogJyhPcmRlcmVkQ29sbGVjdGlvbiknLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHM6IFtdCiAgICAgICAgfTsKICAgICAgICBjb25zdCBvcmRlcmVkQ29sbGVjdGlvbiA9IG9iajsKICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGVtcHR5Q29tbWVudCwgb3B0cywgbmV3IFNldCgpKTsKICAgICAgICByZXR1cm4gZW1wdHlDb21tZW50OwogICAgfQogICAgY29uc3Qgbm90ZU9yUG9kY2FzdEVwaXNvZGUgPSBvYmo7CiAgICBjb25zdCByb290Q29tbWVudCA9IGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhub3RlT3JQb2RjYXN0RXBpc29kZSk7CiAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMobm90ZU9yUG9kY2FzdEVwaXNvZGUsIHJvb3RDb21tZW50LCBvcHRzLCB1cmwpOwogICAgcmV0dXJuIHJvb3RDb21tZW50Owp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RDb21tZW50c0Zyb21PcmRlcmVkQ29sbGVjdGlvbihvcmRlcmVkQ29sbGVjdGlvbiwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCkgewogICAgaWYgKChvcmRlcmVkQ29sbGVjdGlvbi5pdGVtcz8ubGVuZ3RoIHx8IDApID4gMCB8fCAob3JkZXJlZENvbGxlY3Rpb24ub3JkZXJlZEl0ZW1zPy5sZW5ndGggfHwgMCkgPiAwKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvcmRlcmVkQ29sbGVjdGlvbi5pdGVtcy9vcmRlcmVkSXRlbXMgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob3JkZXJlZENvbGxlY3Rpb24pfWApOwogICAgfQogICAgaWYgKG9yZGVyZWRDb2xsZWN0aW9uLmZpcnN0ID09PSB1bmRlZmluZWQgJiYgb3JkZXJlZENvbGxlY3Rpb24udG90YWxJdGVtcyA9PT0gMCkgewogICAgfSBlbHNlIGlmICh0eXBlb2Ygb3JkZXJlZENvbGxlY3Rpb24uZmlyc3QgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgYXdhaXQgZmV0Y2hQYWdlcyhvcmRlcmVkQ29sbGVjdGlvbi5maXJzdCwgY29tbWVudCwgb3B0cywgZmV0Y2hlZCk7CiAgICB9IGVsc2UgewogICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogb3JkZXJlZENvbGxlY3Rpb24uZmlyc3Qgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob3JkZXJlZENvbGxlY3Rpb24pfWApOwogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGNvbGxlY3RDb21tZW50cyhub3RlLCBjb21tZW50LCBvcHRzLCB1cmwpIHsKICAgIGNvbnN0IHsga2VlcEdvaW5nICwgZmV0Y2hBY3Rpdml0eVB1YiAgfSA9IG9wdHM7CiAgICBjb25zdCBmZXRjaGVkID0gbmV3IFNldCgpOwogICAgY29uc3QgcG9kY2FzdEVwaXNvZGVDb21tZW50cyA9IG5vdGUudHlwZSA9PT0gJ1BvZGNhc3RFcGlzb2RlJyA/IG5vdGUuY29tbWVudHMgOiBub3RlLnJlcGxpZXM7CiAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cykgewogICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cyA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgY29uc3QgdXJsID0gcG9kY2FzdEVwaXNvZGVDb21tZW50czsKICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgIGlmICghb2JqKSByZXR1cm47CiAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKEpTT04uc3RyaW5naWZ5KG9iaiwgdW5kZWZpbmVkLCAyKSk7CiAgICAgICAgICAgIGlmIChvYmoudHlwZSA9PT0gJ09yZGVyZWRDb2xsZWN0aW9uJykgewogICAgICAgICAgICAgICAgY29uc3Qgb3JkZXJlZENvbGxlY3Rpb24gPSBvYmo7CiAgICAgICAgICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHNGcm9tT3JkZXJlZENvbGxlY3Rpb24ob3JkZXJlZENvbGxlY3Rpb24sIGNvbW1lbnQsIG9wdHMsIGZldGNoZWQpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBvYmoudHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmopfWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdCA9PT0gJ29iamVjdCcgJiYgcG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnKSB7CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcyAmJiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lml0ZW1zLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICBhd2FpdCBjb2xsZWN0SXRlbXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5pdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0KSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKHR5cGVvZiBwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0Lm5leHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGF3YWl0IGZldGNoUGFnZXMocG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0LCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKTsKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0Lm5leHQgbm90IGltcGxlbWVudGVkICR7cG9kY2FzdEVwaXNvZGVDb21tZW50cy5maXJzdC5uZXh0fWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogZmlyc3QgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmZpcnN0fWApOwogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KHBvZGNhc3RFcGlzb2RlQ29tbWVudHMpKSB7CiAgICAgICAgICAgIGlmIChwb2RjYXN0RXBpc29kZUNvbW1lbnRzLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgVE9ETzogbm9uLXN0YW5kYXJkIHBvZGNhc3RFcGlzb2RlQ29tbWVudHMgYXJyYXkgbm90IGVtcHR5YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGZpcnN0IG5vdCBmb3VuZCwgaW1wbGVtZW50IGl0ZW1zYCk7CiAgICAgICAgfQogICAgfQp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoUGFnZXModXJsLCBjb21tZW50LCBvcHRzLCBmZXRjaGVkKSB7CiAgICBjb25zdCB7IGZldGNoQWN0aXZpdHlQdWIgLCBrZWVwR29pbmcgIH0gPSBvcHRzOwogICAgbGV0IG9iaiA9IGF3YWl0IGZldGNoQWN0aXZpdHlQdWIodXJsKTsKICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgIGlmICghb2JqKSByZXR1cm47CiAgICBmZXRjaGVkLmFkZCh1cmwpOwogICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgIGxldCBrZWVwQ29sbGVjdGluZyA9IHRydWU7CiAgICB3aGlsZShrZWVwQ29sbGVjdGluZyl7CiAgICAgICAgaWYgKG9iai50eXBlICE9PSAnQ29sbGVjdGlvblBhZ2UnICYmIG9iai50eXBlICE9PSAnT3JkZXJlZENvbGxlY3Rpb25QYWdlJykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2Ugb2JqLnR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqKX1gKTsKICAgICAgICB9CiAgICAgICAgY29uc3QgcGFnZSA9IG9iai50eXBlID09PSAnQ29sbGVjdGlvblBhZ2UnID8gb2JqIDogb2JqOwogICAgICAgIGlmIChwYWdlLml0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLml0ZW1zLCBjb21tZW50LCBvcHRzLCB1cmwpOwogICAgICAgICAgICBpZiAoIWtlZXBHb2luZygpKSByZXR1cm47CiAgICAgICAgfQogICAgICAgIGlmIChwYWdlLnR5cGUgPT09ICdPcmRlcmVkQ29sbGVjdGlvblBhZ2UnICYmIHBhZ2Uub3JkZXJlZEl0ZW1zKSB7CiAgICAgICAgICAgIGF3YWl0IGNvbGxlY3RJdGVtcyhwYWdlLm9yZGVyZWRJdGVtcywgY29tbWVudCwgb3B0cywgdXJsKTsKICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuOwogICAgICAgIH0KICAgICAgICBpZiAocGFnZS5uZXh0KSB7CiAgICAgICAgICAgIGlmICh0eXBlb2YgcGFnZS5uZXh0ID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgaWYgKGZldGNoZWQuaGFzKHBhZ2UubmV4dCkpIHsKICAgICAgICAgICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICB1cmwgPSBwYWdlLm5leHQ7CiAgICAgICAgICAgICAgICAgICAgb2JqID0gYXdhaXQgZmV0Y2hBY3Rpdml0eVB1Yih1cmwpOwogICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybjsKICAgICAgICAgICAgICAgICAgICBpZiAoIW9iaikgcmV0dXJuOwogICAgICAgICAgICAgICAgICAgIGZldGNoZWQuYWRkKHVybCk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IHBhZ2UubmV4dCBub3QgaW1wbGVtZW50ZWQgJHtwYWdlLm5leHR9YCk7CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBrZWVwQ29sbGVjdGluZyA9IGZhbHNlOwogICAgICAgIH0KICAgIH0KfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0SXRlbXMoaXRlbXMsIGNvbW1lbnQsIG9wdHMsIHVybCkgewogICAgZm9yIChjb25zdCBpdGVtIG9mIGl0ZW1zKXsKICAgICAgICBpZiAodHlwZW9mIGl0ZW0gPT09ICdzdHJpbmcnICYmICFpdGVtLnN0YXJ0c1dpdGgoJ3snKSkgewogICAgICAgICAgICBjb25zdCByZXBseSA9IGF3YWl0IGZldGNoQ29tbWVudHNGb3JVcmxfKGl0ZW0sIG9wdHMpOwogICAgICAgICAgICBpZiAocmVwbHkpIHsKICAgICAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGNvbnN0IGl0ZW1PYmogPSB0eXBlb2YgaXRlbSA9PT0gJ3N0cmluZycgPyBKU09OLnBhcnNlKGl0ZW0pIDogaXRlbTsKICAgICAgICAgICAgY29uc3QgcmVwbHkgPSBpbml0Q29tbWVudEZyb21PYmplY3RPckxpbmsoaXRlbU9iaik7CiAgICAgICAgICAgIGNvbW1lbnQucmVwbGllcy5wdXNoKHJlcGx5KTsKICAgICAgICAgICAgaWYgKHR5cGVvZiBpdGVtID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgb3B0cy53YXJuKHJlcGx5LCB1cmwsICdGb3VuZCBpdGVtIGluY29ycmVjdGx5IGRvdWJsZSBlbmNvZGVkIGFzIGEganNvbiBzdHJpbmcnKTsKICAgICAgICAgICAgfQogICAgICAgICAgICBhd2FpdCBjb2xsZWN0Q29tbWVudHMoaXRlbSwgcmVwbHksIG9wdHMsIHVybCk7CiAgICAgICAgfQogICAgfQp9CmZ1bmN0aW9uIGluaXRDb21tZW50RnJvbU9iamVjdE9yTGluayhvYmplY3QpIHsKICAgIGlmIChvYmplY3QudHlwZSA9PT0gJ05vdGUnKSB7CiAgICAgICAgY29uc3QgeyBhdHRyaWJ1dGVkVG8gLCBjb250ZW50ICwgcHVibGlzaGVkICB9ID0gb2JqZWN0OwogICAgICAgIGNvbnN0IHVybCA9IG9iamVjdC51cmwgPT09IG51bGwgPyB1bmRlZmluZWQgOiBvYmplY3QudXJsOwogICAgICAgIGlmICh0eXBlb2YgYXR0cmlidXRlZFRvICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmF0dHJpYnV0ZWRUbyB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHR5cGVvZiBjb250ZW50ICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLmNvbnRlbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHt0eXBlb2YgY29udGVudH0gJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGlmICh0eXBlb2YgcHVibGlzaGVkICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBOb3RlLnB1Ymxpc2hlZCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgaWYgKHVybCAhPT0gdW5kZWZpbmVkICYmIHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IE5vdGUudXJsIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBjb25zdCBhdHRhY2htZW50cyA9IGNvbXB1dGVBdHRhY2htZW50cyhvYmplY3QpOwogICAgICAgIHJldHVybiB7CiAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgYXR0cmlidXRlZFRvLAogICAgICAgICAgICBjb250ZW50LAogICAgICAgICAgICBwdWJsaXNoZWQsCiAgICAgICAgICAgIHJlcGxpZXM6IFtdLAogICAgICAgICAgICBhdHRhY2htZW50cwogICAgICAgIH07CiAgICB9CiAgICBpZiAob2JqZWN0LnR5cGUgPT09ICdQb2RjYXN0RXBpc29kZScpIHsKICAgICAgICBjb25zdCBwb2RjYXN0RXBpc29kZSA9IG9iamVjdDsKICAgICAgICBjb25zdCB7IGF0dHJpYnV0ZWRUbyAsIHB1Ymxpc2hlZCAsIGRlc2NyaXB0aW9uICwgaW1hZ2UgIH0gPSBwb2RjYXN0RXBpc29kZTsKICAgICAgICBpZiAodHlwZW9mIGF0dHJpYnV0ZWRUbyAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuYXR0cmlidXRlZFRvIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIHB1Ymxpc2hlZCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUucHVibGlzaGVkIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgICAgICBpZiAodHlwZW9mIGRlc2NyaXB0aW9uICE9PSAnb2JqZWN0JyB8fCBkZXNjcmlwdGlvbi50eXBlICE9PSAnTm90ZScpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuZGVzY3JpcHRpb24gdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgICAgIGNvbnN0IHsgY29udGVudCAgfSA9IGRlc2NyaXB0aW9uOwogICAgICAgIGlmICh0eXBlb2YgY29udGVudCAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETzogUG9kY2FzdEVwaXNvZGUuY29udGVudCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke3R5cGVvZiBjb250ZW50fSAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICAgICAgY29uc3QgdXJsID0gdW5kZWZpbmVkOwogICAgICAgIGNvbnN0IGF0dGFjaG1lbnRzID0gaW1hZ2UgPyBbCiAgICAgICAgICAgIGNvbXB1dGVBdHRhY2htZW50KGltYWdlKQogICAgICAgIF0gOiBbXTsKICAgICAgICByZXR1cm4gewogICAgICAgICAgICB1cmwsCiAgICAgICAgICAgIGF0dHJpYnV0ZWRUbywKICAgICAgICAgICAgY29udGVudCwKICAgICAgICAgICAgcHVibGlzaGVkLAogICAgICAgICAgICByZXBsaWVzOiBbXSwKICAgICAgICAgICAgYXR0YWNobWVudHMKICAgICAgICB9OwogICAgfQogICAgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBpdGVtIHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKfQpmdW5jdGlvbiBjb21wdXRlQXR0YWNobWVudHMob2JqZWN0KSB7CiAgICBjb25zdCBydCA9IFtdOwogICAgaWYgKCFvYmplY3QuYXR0YWNobWVudCkgcmV0dXJuIHJ0OwogICAgY29uc3QgYXR0YWNobWVudHMgPSBpc1JlYWRvbmx5QXJyYXkob2JqZWN0LmF0dGFjaG1lbnQpID8gb2JqZWN0LmF0dGFjaG1lbnQgOiBbCiAgICAgICAgb2JqZWN0LmF0dGFjaG1lbnQKICAgIF07CiAgICBmb3IgKGNvbnN0IGF0dGFjaG1lbnQgb2YgYXR0YWNobWVudHMpewogICAgICAgIHJ0LnB1c2goY29tcHV0ZUF0dGFjaG1lbnQoYXR0YWNobWVudCkpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmZ1bmN0aW9uIGNvbXB1dGVBdHRhY2htZW50KG9iamVjdCkgewogICAgaWYgKHR5cGVvZiBvYmplY3QgIT09ICdvYmplY3QnIHx8IG9iamVjdC50eXBlICE9PSAnRG9jdW1lbnQnICYmIG9iamVjdC50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE86IGF0dGFjaG1lbnQgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgY29uc3QgeyBtZWRpYVR5cGUgLCB3aWR0aCAsIGhlaWdodCAsIHVybCAgfSA9IG9iamVjdDsKICAgIGlmICh0eXBlb2YgbWVkaWFUeXBlICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiBtZWRpYVR5cGUgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgaWYgKHdpZHRoICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIHdpZHRoICE9PSAnbnVtYmVyJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB3aWR0aCB0eXBlIG5vdCBpbXBsZW1lbnRlZCAke0pTT04uc3RyaW5naWZ5KG9iamVjdCl9YCk7CiAgICBpZiAoaGVpZ2h0ICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIGhlaWdodCAhPT0gJ251bWJlcicpIHRocm93IG5ldyBFcnJvcihgVE9ETzogaGVpZ2h0IHR5cGUgbm90IGltcGxlbWVudGVkICR7SlNPTi5zdHJpbmdpZnkob2JqZWN0KX1gKTsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPOiB1cmwgdHlwZSBub3QgaW1wbGVtZW50ZWQgJHtKU09OLnN0cmluZ2lmeShvYmplY3QpfWApOwogICAgcmV0dXJuIHsKICAgICAgICBtZWRpYVR5cGUsCiAgICAgICAgd2lkdGgsCiAgICAgICAgaGVpZ2h0LAogICAgICAgIHVybAogICAgfTsKfQphc3luYyBmdW5jdGlvbiBjb2xsZWN0Q29tbWVudGVycyhjb21tZW50LCBvcHRzKSB7CiAgICBjb25zdCBhdHRyaWJ1dGVkVG9zID0gbmV3IFNldCgpOwogICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcyk7CiAgICBjb25zdCBydCA9IG5ldyBNYXAoKTsKICAgIGZvciAoY29uc3QgYXR0cmlidXRlZFRvIG9mIGF0dHJpYnV0ZWRUb3MpewogICAgICAgIGNvbnN0IGNvbW1lbnRlciA9IGF3YWl0IGZldGNoQ29tbWVudGVyKGF0dHJpYnV0ZWRUbywgb3B0cyk7CiAgICAgICAgaWYgKCFjb21tZW50ZXIpIHJldHVybiBydDsKICAgICAgICBydC5zZXQoYXR0cmlidXRlZFRvLCBjb21tZW50ZXIpOwogICAgfQogICAgcmV0dXJuIHJ0Owp9CmFzeW5jIGZ1bmN0aW9uIGZldGNoQ29tbWVudGVyKHVybCwgb3B0cykgewogICAgY29uc3Qgb2JqID0gYXdhaXQgb3B0cy5mZXRjaEFjdGl2aXR5UHViKHVybCk7CiAgICBpZiAoIW9iaikgcmV0dXJuIHVuZGVmaW5lZDsKICAgIGNvbnN0IHBlcnNvbiA9IG9iajsKICAgIHJldHVybiBjb21wdXRlQ29tbWVudGVyKHBlcnNvbik7Cn0KZnVuY3Rpb24gY29tcHV0ZUNvbW1lbnRlcihwZXJzb24pIHsKICAgIGxldCBpY29uOwogICAgaWYgKHBlcnNvbi5pY29uKSB7CiAgICAgICAgaWYgKHR5cGVvZiBwZXJzb24uaWNvbiAhPT0gJ29iamVjdCcgfHwgaXNSZWFkb25seUFycmF5KHBlcnNvbi5pY29uKSB8fCBwZXJzb24uaWNvbi50eXBlICE9PSAnSW1hZ2UnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLmljb24gbm90IGltcGxlbWVudGVkOiAke0pTT04uc3RyaW5naWZ5KHBlcnNvbi5pY29uKX1gKTsKICAgICAgICBpY29uID0gY29tcHV0ZUljb24ocGVyc29uLmljb24pOwogICAgfQogICAgY29uc3QgeyBuYW1lICwgdXJsICB9ID0gcGVyc29uOwogICAgaWYgKHR5cGVvZiBuYW1lICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIHBlcnNvbi5uYW1lIG5vdCBpbXBsZW1lbnRlZDogJHtuYW1lfWApOwogICAgaWYgKHR5cGVvZiB1cmwgIT09ICdzdHJpbmcnKSB0aHJvdyBuZXcgRXJyb3IoYFRPRE8gcGVyc29uLnVybCBub3QgaW1wbGVtZW50ZWQ6ICR7dXJsfWApOwogICAgY29uc3QgZnFVc2VybmFtZSA9IGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcGVyc29uLnByZWZlcnJlZFVzZXJuYW1lKTsKICAgIHJldHVybiB7CiAgICAgICAgaWNvbiwKICAgICAgICBuYW1lLAogICAgICAgIHVybCwKICAgICAgICBmcVVzZXJuYW1lCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVJY29uKGljb24pIHsKICAgIGNvbnN0IHsgdXJsICwgbWVkaWFUeXBlICB9ID0gaWNvbjsKICAgIGlmICh0eXBlb2YgdXJsICE9PSAnc3RyaW5nJykgdGhyb3cgbmV3IEVycm9yKGBUT0RPIGljb24udXJsIG5vdCBpbXBsZW1lbnRlZDogJHt1cmx9YCk7CiAgICBpZiAobWVkaWFUeXBlICE9PSB1bmRlZmluZWQgJiYgdHlwZW9mIG1lZGlhVHlwZSAhPT0gJ3N0cmluZycpIHRocm93IG5ldyBFcnJvcihgVE9ETyBpY29uLm1lZGlhVHlwZSBub3QgaW1wbGVtZW50ZWQ6ICR7bWVkaWFUeXBlfWApOwogICAgcmV0dXJuIHsKICAgICAgICB1cmwsCiAgICAgICAgbWVkaWFUeXBlCiAgICB9Owp9CmZ1bmN0aW9uIGNvbXB1dGVGcVVzZXJuYW1lKHVybCwgcHJlZmVycmVkVXNlcm5hbWUpIHsKICAgIGNvbnN0IHUgPSBuZXcgVVJMKHVybCk7CiAgICBjb25zdCBtID0gL15cLyhAW15cL10rKSQvLmV4ZWModS5wYXRobmFtZSk7CiAgICBjb25zdCB1c2VybmFtZSA9IG0gPyBtWzFdIDogcHJlZmVycmVkVXNlcm5hbWU7CiAgICBpZiAoIXVzZXJuYW1lKSB0aHJvdyBuZXcgRXJyb3IoYFVuYWJsZSB0byBjb21wdXRlIHVzZXJuYW1lIGZyb20gdXJsOiAke3VybH1gKTsKICAgIHJldHVybiBgJHt1c2VybmFtZX1AJHt1Lmhvc3RuYW1lfWA7Cn0KZnVuY3Rpb24gY29sbGVjdEF0dHJpYnV0ZWRUb3MoY29tbWVudCwgYXR0cmlidXRlZFRvcykgewogICAgaWYgKGNvbW1lbnQuYXR0cmlidXRlZFRvKSBhdHRyaWJ1dGVkVG9zLmFkZChjb21tZW50LmF0dHJpYnV0ZWRUbyk7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIGNvbW1lbnQucmVwbGllcyl7CiAgICAgICAgY29sbGVjdEF0dHJpYnV0ZWRUb3MocmVwbHksIGF0dHJpYnV0ZWRUb3MpOwogICAgfQp9CmNsYXNzIFZhbGlkYXRvckFwcFZNIHsKICAgIG5leHRKb2JJZCA9IDE7CiAgICBjdXJyZW50Sm9iOwogICAgZ2V0IHZhbGlkYXRpbmcoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmICF0aGlzLmN1cnJlbnRKb2IuZG9uZTsKICAgIH0KICAgIGdldCBtZXNzYWdlcygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iID8gdGhpcy5jdXJyZW50Sm9iLm1lc3NhZ2VzIDogW107CiAgICB9CiAgICBnZXQgaXNTZWFyY2goKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYiAhPT0gdW5kZWZpbmVkICYmIHRoaXMuY3VycmVudEpvYi5zZWFyY2g7CiAgICB9CiAgICBnZXQgc2VhcmNoUmVzdWx0cygpIHsKICAgICAgICByZXR1cm4gdGhpcy5jdXJyZW50Sm9iID8gdGhpcy5jdXJyZW50Sm9iLnNlYXJjaFJlc3VsdHMgOiBbXTsKICAgIH0KICAgIGdldCB4bWwoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8ueG1sOwogICAgfQogICAgZ2V0IHhtbFN1bW1hcnlUZXh0KCkgewogICAgICAgIHJldHVybiB0aGlzLmN1cnJlbnRKb2I/LnhtbFN1bW1hcnlUZXh0OwogICAgfQogICAgZ2V0IGZldGNoQ29tbWVudHNSZXN1bHQoKSB7CiAgICAgICAgcmV0dXJuIHRoaXMuY3VycmVudEpvYj8uZmV0Y2hDb21tZW50c1Jlc3VsdDsKICAgIH0KICAgIG9uQ2hhbmdlID0gKCk9PnsKICAgIH07CiAgICBzdGFydCgpIHsKICAgIH0KICAgIGNvbnRpbnVlV2l0aCh1cmwpIHsKICAgICAgICBjb25zdCB7IGN1cnJlbnRKb2IgIH0gPSB0aGlzOwogICAgICAgIGlmIChjdXJyZW50Sm9iKSB7CiAgICAgICAgICAgIGN1cnJlbnRKb2IuZG9uZSA9IGZhbHNlOwogICAgICAgICAgICBjdXJyZW50Sm9iLnNlYXJjaCA9IGZhbHNlOwogICAgICAgICAgICBjdXJyZW50Sm9iLnNlYXJjaFJlc3VsdHMuc3BsaWNlKDApOwogICAgICAgICAgICBjdXJyZW50Sm9iLm1lc3NhZ2VzWzBdID0gewogICAgICAgICAgICAgICAgdHlwZTogJ3J1bm5pbmcnLAogICAgICAgICAgICAgICAgdGV4dDogJ1ZhbGlkYXRpbmcnCiAgICAgICAgICAgIH07CiAgICAgICAgICAgIGN1cnJlbnRKb2IubWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlOiAnaW5mbycsCiAgICAgICAgICAgICAgICB0ZXh0OiAnQ29udGludWluZyB3aXRoIGZlZWQgZnJvbSBzZWFyY2gnLAogICAgICAgICAgICAgICAgdXJsCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgICAgIHRoaXMudmFsaWRhdGVBc3luYyh1cmwsIGN1cnJlbnRKb2IpOwogICAgICAgIH0KICAgIH0KICAgIHN0YXJ0VmFsaWRhdGlvbihpbnB1dCwgb3B0aW9ucykgewogICAgICAgIGNvbnN0IGpvYiA9IHsKICAgICAgICAgICAgaWQ6IHRoaXMubmV4dEpvYklkKyssCiAgICAgICAgICAgIG1lc3NhZ2VzOiBbXSwKICAgICAgICAgICAgc2VhcmNoUmVzdWx0czogW10sCiAgICAgICAgICAgIHRpbWVzOiB7CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIG9wdGlvbnMsCiAgICAgICAgICAgIHNlYXJjaDogZmFsc2UsCiAgICAgICAgICAgIGRvbmU6IGZhbHNlLAogICAgICAgICAgICBjYW5jZWxsZWQ6IGZhbHNlCiAgICAgICAgfTsKICAgICAgICB0aGlzLmN1cnJlbnRKb2IgPSBqb2I7CiAgICAgICAgam9iLm1lc3NhZ2VzLnB1c2goewogICAgICAgICAgICB0eXBlOiAncnVubmluZycsCiAgICAgICAgICAgIHRleHQ6ICdWYWxpZGF0aW5nJwogICAgICAgIH0pOwogICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB0aGlzLnZhbGlkYXRlQXN5bmMoaW5wdXQsIGpvYik7CiAgICB9CiAgICBjYW5jZWxWYWxpZGF0aW9uKCkgewogICAgICAgIGlmICh0aGlzLmN1cnJlbnRKb2IgJiYgIXRoaXMuY3VycmVudEpvYi5kb25lKSB7CiAgICAgICAgICAgIHRoaXMuY3VycmVudEpvYi5jYW5jZWxsZWQgPSB0cnVlOwogICAgICAgICAgICB0aGlzLmN1cnJlbnRKb2IuZG9uZSA9IHRydWU7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9CiAgICB9CiAgICBhc3luYyB2YWxpZGF0ZUFzeW5jKGlucHV0LCBqb2IpIHsKICAgICAgICBpbnB1dCA9IG5vcm1hbGl6ZUlucHV0KGlucHV0KTsKICAgICAgICBjb25zdCB7IG1lc3NhZ2VzICB9ID0gam9iOwogICAgICAgIGNvbnN0IHNldFN0YXR1cyA9ICh0ZXh0LCBvcHRzID0gewogICAgICAgIH0pPT57CiAgICAgICAgICAgIGNvbnN0IHsgdXJsICwgdHlwZSAgfSA9IG9wdHM7CiAgICAgICAgICAgIG1lc3NhZ2VzWzBdID0gewogICAgICAgICAgICAgICAgdHlwZTogdHlwZSB8fCBtZXNzYWdlc1swXS50eXBlLAogICAgICAgICAgICAgICAgdGV4dCwKICAgICAgICAgICAgICAgIHVybAogICAgICAgICAgICB9OwogICAgICAgICAgICB0aGlzLm9uQ2hhbmdlKCk7CiAgICAgICAgfTsKICAgICAgICBjb25zdCBhZGRNZXNzYWdlID0gKHR5cGUsIHRleHQsIG9wdHMgPSB7CiAgICAgICAgfSk9PnsKICAgICAgICAgICAgY29uc3QgeyB1cmwgLCB0YWcgLCBjb21tZW50ICwgcmVmZXJlbmNlICB9ID0gb3B0czsKICAgICAgICAgICAgbWVzc2FnZXMucHVzaCh7CiAgICAgICAgICAgICAgICB0eXBlLAogICAgICAgICAgICAgICAgdGV4dCwKICAgICAgICAgICAgICAgIHRhZywKICAgICAgICAgICAgICAgIHVybCwKICAgICAgICAgICAgICAgIGNvbW1lbnQsCiAgICAgICAgICAgICAgICByZWZlcmVuY2UKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICB9OwogICAgICAgIGxldCBhY3Rpdml0eVB1YjsKICAgICAgICBjb25zdCBoZWFkZXJzID0gewogICAgICAgICAgICAnQWNjZXB0LUVuY29kaW5nJzogJ2d6aXAnLAogICAgICAgICAgICAnVXNlci1BZ2VudCc6IGpvYi5vcHRpb25zLnVzZXJBZ2VudCwKICAgICAgICAgICAgJ0NhY2hlLUNvbnRyb2wnOiAnbm8tc3RvcmUnCiAgICAgICAgfTsKICAgICAgICBsZXQgY29udGludWVXaXRoVXJsOwogICAgICAgIGNvbnN0IGpvYlN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICB0cnkgewogICAgICAgICAgICBpbnB1dCA9IGlucHV0LnRyaW0oKTsKICAgICAgICAgICAgaWYgKGlucHV0ID09PSAnJykgdGhyb3cgbmV3IEVycm9yKGBObyBpbnB1dGApOwogICAgICAgICAgICBpZiAoL15odHRwcz86XC9cLy4rL2kudGVzdChpbnB1dCkpIHsKICAgICAgICAgICAgICAgIGNvbnN0IGlucHV0VXJsID0gdHJ5UGFyc2VVcmwxKGlucHV0KTsKICAgICAgICAgICAgICAgIGlmICghaW5wdXRVcmwpIHRocm93IG5ldyBFcnJvcihgQmFkIHVybDogJHtpbnB1dH1gKTsKICAgICAgICAgICAgICAgIGNoZWNrTWF0Y2hlcygnaW5wdXRVcmwucHJvdG9jb2wnLCBpbnB1dFVybC5wcm90b2NvbCwgL15odHRwcz86JC8pOwogICAgICAgICAgICAgICAgaW5wdXRVcmwuc2VhcmNoUGFyYW1zLnNldCgnX3QnLCBEYXRlLm5vdygpLnRvU3RyaW5nKCkpOwogICAgICAgICAgICAgICAgY29uc3QgeyByZXNwb25zZSAsIHNpZGUgLCBmZXRjaFRpbWUgIH0gPSBhd2FpdCBsb2NhbE9yUmVtb3RlRmV0Y2goaW5wdXRVcmwudG9TdHJpbmcoKSwgewogICAgICAgICAgICAgICAgICAgIGhlYWRlcnMKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgaWYgKGpvYi5kb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICBqb2IudGltZXMuZmV0Y2hUaW1lID0gZmV0Y2hUaW1lOwogICAgICAgICAgICAgICAgaWYgKHNpZGUgPT09ICdsb2NhbCcpIHsKICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdnb29kJywgYExvY2FsIGZldGNoIHN1Y2NlZWRlZCAoQ09SUyBlbmFibGVkKWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBpbnB1dAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgY2hlY2tFcXVhbChgJHtpbnB1dFVybC5ob3N0fSByZXNwb25zZSBzdGF0dXNgLCByZXNwb25zZS5zdGF0dXMsIDIwMCk7CiAgICAgICAgICAgICAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgICAgICAgICAgICAgIGxldCB2YWxpZGF0ZUZlZWQgPSB0cnVlOwogICAgICAgICAgICAgICAgaWYgKGNvbnRlbnRUeXBlICYmIGNvbnRlbnRUeXBlLmluY2x1ZGVzKCcvaHRtbCcpKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGb3VuZCBodG1sLCB3aWxsIHRyeSBhZ2FpbiBhcyBBY3Rpdml0eVB1YicpOwogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJwogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoY29udGVudFR5cGUgJiYgY29udGVudFR5cGUuc3RhcnRzV2l0aCgnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicpKSB7CiAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsICdGb3VuZCBBY3Rpdml0eVB1YiBqc29uJyk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qgb2JqID0gYXdhaXQgcmVzcG9uc2UuanNvbigpOwogICAgICAgICAgICAgICAgICAgIHZhbGlkYXRlRmVlZCA9IGZhbHNlOwogICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGlucHV0LAogICAgICAgICAgICAgICAgICAgICAgICBzdWJqZWN0OiAnaW5wdXQgdXJsJywKICAgICAgICAgICAgICAgICAgICAgICAgb2JqCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGlmICh2YWxpZGF0ZUZlZWQpIHsKICAgICAgICAgICAgICAgICAgICBsZXQgc3RhcnQgPSBEYXRlLm5vdygpOwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHRleHQgPSBhd2FpdCByZXNwb25zZS50ZXh0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGpvYi5kb25lKSByZXR1cm47CiAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnJlYWRUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBsZXQgeG1sOwogICAgICAgICAgICAgICAgICAgIHRyeSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHhtbCA9IHBhcnNlWG1sKHRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmxvZyh4bWwpOwogICAgICAgICAgICAgICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBgWG1sIHBhcnNlIGZhaWxlZDogJHtlLm1lc3NhZ2V9YCk7CiAgICAgICAgICAgICAgICAgICAgfSBmaW5hbGx5ewogICAgICAgICAgICAgICAgICAgICAgICBqb2IudGltZXMucGFyc2VUaW1lID0gRGF0ZS5ub3coKSAtIHN0YXJ0OwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBpZiAoeG1sKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3Qgb25NZXNzYWdlID0gKHR5cGUsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKHR5cGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKG9wdHM/LnRhZyA9PT0gJ3NvY2lhbC1pbnRlcmFjdCcpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAobm9kZS52YWwgJiYgbm9kZS52YWwgIT09ICcnICYmIGNvbXB1dGVBdHRyaWJ1dGVNYXAobm9kZS5hdHRyc01hcCkuZ2V0KCdwbGF0Zm9ybScpID09PSAnYWN0aXZpdHlwdWInKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGVwaXNvZGVUaXRsZSA9IGZpbmRFcGlzb2RlVGl0bGUobm9kZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViID0gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsOiBub2RlLnZhbCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN1YmplY3Q6IGVwaXNvZGVUaXRsZSA/IGDigJwke2VwaXNvZGVUaXRsZX3igJ1gIDogJ2VwaXNvZGUnCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBrbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdW5rbm93blBpVGFncyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGlOYW1lc3BhY2VVcmlzID0gbmV3IFNldCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgcnNzSXRlbUluZm87CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGNhbGxiYWNrcyA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uR29vZDogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnZ29vZCcsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uRXJyb3I6IChub2RlLCBtZXNzYWdlLCBvcHRzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IobWVzc2FnZSk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb25NZXNzYWdlKCdlcnJvcicsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uV2FybmluZzogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS53YXJuKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnd2FybmluZycsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uSW5mbzogKG5vZGUsIG1lc3NhZ2UsIG9wdHMpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5pbmZvKG1lc3NhZ2UpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uTWVzc2FnZSgnaW5mbycsIG5vZGUsIG1lc3NhZ2UsIG9wdHMpOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG9uUG9kY2FzdEluZGV4VGFnTmFtZXNGb3VuZDogKGtub3duLCB1bmtub3duLCBuYW1lc3BhY2VVcmlzKT0+ewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtub3duLmZvckVhY2goKHYpPT5rbm93blBpVGFncy5hZGQodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVua25vd24uZm9yRWFjaCgodik9PnVua25vd25QaVRhZ3MuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBuYW1lc3BhY2VVcmlzLmZvckVhY2goKHYpPT5waU5hbWVzcGFjZVVyaXMuYWRkKHYpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvblJzc0l0ZW1zRm91bmQ6IChpdGVtc0NvdW50LCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQpPT57CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcnNzSXRlbUluZm8gPSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zQ291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGl0ZW1zV2l0aEVuY2xvc3VyZXNDb3VudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCB4bWxTdW1tYXJ5VGV4dCA9ICdYbWwgc3RydWN0dXJlJzsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWRhdGVGZWVkWG1sKHhtbCwgY2FsbGJhY2tzKTsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLnZhbGlkYXRlVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHJzc0l0ZW1JbmZvKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB7IGl0ZW1zQ291bnQgLCBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQgIH0gPSByc3NJdGVtSW5mbzsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IGl0ZW1zV2l0aG91dEVuY2xvc3VyZXNDb3VudCA9IGl0ZW1zQ291bnQgLSBpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwaWVjZXMgPSBbCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYEZvdW5kICR7dW5pdFN0cmluZyhpdGVtc1dpdGhFbmNsb3N1cmVzQ291bnQsICdlcGlzb2RlJyl9YAogICAgICAgICAgICAgICAgICAgICAgICAgICAgXTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIChpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQgPiAwKSBwaWVjZXMucHVzaChgYW5kICR7dW5pdFN0cmluZyhpdGVtc1dpdGhvdXRFbmNsb3N1cmVzQ291bnQsICdpdGVtJyl9IHdpdGhvdXQgZW5jbG9zdXJlc2ApOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGllY2VzLnB1c2goYGluIGEgJHtmb3JtYXRCeXRlcyh0ZXh0Lmxlbmd0aCl9IGZlZWRgKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCBwaWVjZXMuam9pbignICcpKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHhtbFN1bW1hcnlUZXh0ID0gYCR7aXRlbXNXaXRoRW5jbG9zdXJlc0NvdW50ID4gMSA/ICdQb2RjYXN0IGZlZWQnIDogJ0ZlZWQnfSBzdHJ1Y3R1cmVgOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBpUmVmZXJlbmNlID0gcG9kY2FzdEluZGV4UmVmZXJlbmNlKCdodHRwczovL2dpdGh1Yi5jb20vUG9kY2FzdGluZGV4LW9yZy9wb2RjYXN0LW5hbWVzcGFjZS9ibG9iL21haW4vZG9jcy8xLjAubWQnKTsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgdGFnU3RyaW5nID0gKHNldCk9PlsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAuLi5zZXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF0ubWFwKCh2KT0+YDxwb2RjYXN0OiR7dn0+YAogICAgICAgICAgICAgICAgICAgICAgICAgICAgKS5qb2luKCcsICcpCiAgICAgICAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGtub3duUGlUYWdzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCdnb29kJywgYEZvdW5kICR7dW5pdFN0cmluZyhrbm93blBpVGFncy5zaXplLCAncG9kY2FzdCBuYW1lc3BhY2UgdGFnJyl9OiAke3RhZ1N0cmluZyhrbm93blBpVGFncyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZTogcGlSZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICh1bmtub3duUGlUYWdzLnNpemUgPiAwKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgYEZvdW5kICR7dW5pdFN0cmluZyh1bmtub3duUGlUYWdzLnNpemUsICd1bmtub3duIHBvZGNhc3QgbmFtZXNwYWNlIHRhZycpfTogJHt0YWdTdHJpbmcodW5rbm93blBpVGFncyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZTogcGlSZWZlcmVuY2UKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG1pc3NwZWxsZWROYW1lc3BhY2VzID0gc2V0SW50ZXJzZWN0KHBpTmFtZXNwYWNlVXJpcywgbmV3IFNldChRbmFtZXMuUG9kY2FzdEluZGV4LktOT1dOX01JU1NQRUxMRURfTkFNRVNQQUNFUykpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAobWlzc3BlbGxlZE5hbWVzcGFjZXMuc2l6ZSA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlZmVyZW5jZSA9IHBvZGNhc3RJbmRleFJlZmVyZW5jZSgnaHR0cHM6Ly9naXRodWIuY29tL1BvZGNhc3RpbmRleC1vcmcvcG9kY2FzdC1uYW1lc3BhY2UvYmxvYi9tYWluL2RvY3MvMS4wLm1kI3Jzcy1uYW1lc3BhY2UtZXh0ZW5zaW9uLWZvci1wb2RjYXN0aW5nLXRhZy1zcGVjaWZpY2F0aW9uJyk7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgYEZvdW5kICR7dW5pdFN0cmluZyhtaXNzcGVsbGVkTmFtZXNwYWNlcy5zaXplLCAnbWlzc3BlbGxlZCBwb2RjYXN0IG5hbWVzcGFjZSB1cmknKX06ICR7WwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC4uLm1pc3NwZWxsZWROYW1lc3BhY2VzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBdLmpvaW4oJywgJyl9YCwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlZmVyZW5jZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHhtbCAmJiBPYmplY3Qua2V5cyh4bWwpLmxlbmd0aCA+IDApIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpvYi54bWwgPSB4bWw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBqb2IueG1sU3VtbWFyeVRleHQgPSB4bWxTdW1tYXJ5VGV4dDsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMub25DaGFuZ2UoKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIGNvbnN0IHZhbGlkYXRlQ29tbWVudHMgPSBqb2Iub3B0aW9ucy52YWxpZGF0ZUNvbW1lbnRzICE9PSB1bmRlZmluZWQgPyBqb2Iub3B0aW9ucy52YWxpZGF0ZUNvbW1lbnRzIDogdHJ1ZTsKICAgICAgICAgICAgICAgIGlmIChhY3Rpdml0eVB1YiAmJiAhdmFsaWRhdGVDb21tZW50cykgewogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnQ29tbWVudHMgdmFsaWRhdGlvbiBkaXNhYmxlZCwgbm90IGZldGNoaW5nIEFjdGl2aXR5UHViJyk7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGFjdGl2aXR5UHViKSB7CiAgICAgICAgICAgICAgICAgICAgc2V0U3RhdHVzKGBWYWxpZGF0aW5nIEFjdGl2aXR5UHViIGZvciAke2FjdGl2aXR5UHViLnN1YmplY3R9YCwgewogICAgICAgICAgICAgICAgICAgICAgICB1cmw6IGFjdGl2aXR5UHViLnVybAogICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2luZm8nLCAnRmV0Y2hpbmcgQWN0aXZpdHlQdWIgY29tbWVudHMnLCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVybDogYWN0aXZpdHlQdWIudXJsCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgY29uc3Qga2VlcEdvaW5nID0gKCk9PiFqb2IuZG9uZQogICAgICAgICAgICAgICAgICAgIDsKICAgICAgICAgICAgICAgICAgICBjb25zdCByZW1vdGVPbmx5T3JpZ2lucyA9IG5ldyBTZXQoKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBjb21wdXRlVXNlU2lkZSA9ICh1cmwpPT57CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiByZW1vdGVPbmx5T3JpZ2lucy5oYXMobmV3IFVSTCh1cmwpLm9yaWdpbikgPyAncmVtb3RlJyA6IHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGxldCBhY3Rpdml0eVB1YkNhbGxzID0gMDsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmZXRjaEFjdGl2aXR5UHViID0gYXN5bmMgKHVybCk9PnsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IHsgb2JqICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCBjb21wdXRlVXNlU2lkZSh1cmwpLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFrZWVwR29pbmcoKSkgcmV0dXJuIHVuZGVmaW5lZDsKICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHVybC5pbmNsdWRlcygnL2FwaS92MS9zdGF0dXNlcycpICYmIHR5cGVvZiBvYmoudXJpID09PSAnc3RyaW5nJykgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsID0gb2JqLnVyaTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHJlcyA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaEZldGNoQWN0aXZpdHlQdWIodXJsLCBjb21wdXRlVXNlU2lkZSh1cmwpLCAwKTsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmICgha2VlcEdvaW5nKCkpIHJldHVybiB1bmRlZmluZWQ7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBvYmogPSByZXMub2JqOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2lkZSA9IHJlcy5zaWRlOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkob2JqLCB1bmRlZmluZWQsIDIpKTsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICBpZiAoc2lkZSA9PT0gJ3JlbW90ZScpIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IG9yaWdpbiA9IG5ldyBVUkwodXJsKS5vcmlnaW47CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXJlbW90ZU9ubHlPcmlnaW5zLmhhcyhvcmlnaW4pKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnd2FybmluZycsIGBMb2NhbCBBY3Rpdml0eVB1YiBmZXRjaCBmYWlsZWQgKENPUlMgZGlzYWJsZWQ/KWAsIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdXJsLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0YWc6ICdjb3JzJwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlbW90ZU9ubHlPcmlnaW5zLmFkZChvcmlnaW4pOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgICAgIGFjdGl2aXR5UHViQ2FsbHMrKzsKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG9iajsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHdhcm4gPSAoY29tbWVudCwgdXJsLCBtZXNzYWdlKT0+ewogICAgICAgICAgICAgICAgICAgICAgICBhZGRNZXNzYWdlKCd3YXJuaW5nJywgbWVzc2FnZSwgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29tbWVudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHVybAogICAgICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgICAgICAgICAgICAgICAgICBjb25zdCBmZXRjaENvbW1lbnRzUmVzdWx0ID0gYXdhaXQgZmV0Y2hDb21tZW50c0ZvclVybChhY3Rpdml0eVB1Yi51cmwsIGFjdGl2aXR5UHViLnN1YmplY3QsIHsKICAgICAgICAgICAgICAgICAgICAgICAga2VlcEdvaW5nLAogICAgICAgICAgICAgICAgICAgICAgICBmZXRjaEFjdGl2aXR5UHViLAogICAgICAgICAgICAgICAgICAgICAgICB3YXJuCiAgICAgICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgICAgICAgICAgaWYgKGZldGNoQ29tbWVudHNSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgam9iLnRpbWVzLmNvbW1lbnRzVGltZSA9IERhdGUubm93KCkgLSBzdGFydDsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGBGb3VuZCAke3VuaXRTdHJpbmcoY29tcHV0ZUNvbW1lbnRDb3VudChmZXRjaENvbW1lbnRzUmVzdWx0LnJvb3RDb21tZW50KSwgJ2NvbW1lbnQnKX0gYW5kICR7dW5pdFN0cmluZyhmZXRjaENvbW1lbnRzUmVzdWx0LmNvbW1lbnRlcnMuc2l6ZSwgJ3BhcnRpY2lwYW50Jyl9LCBtYWRlICR7dW5pdFN0cmluZyhhY3Rpdml0eVB1YkNhbGxzLCAnQWN0aXZpdHlQdWIgY2FsbCcpfWApOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBqb2IuZmV0Y2hDb21tZW50c1Jlc3VsdCA9IGZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgICAgICAgICAgICAgdGhpcy5vbkNoYW5nZSgpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgam9iLnNlYXJjaCA9IHRydWU7CiAgICAgICAgICAgICAgICBzZXRTdGF0dXMoJ1NlYXJjaGluZycpOwogICAgICAgICAgICAgICAgY29uc3Qgc2VhcmNoUmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgL3NgLCB7CiAgICAgICAgICAgICAgICAgICAgbWV0aG9kOiAnUE9TVCcsCiAgICAgICAgICAgICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoewogICAgICAgICAgICAgICAgICAgICAgICBpbnB1dCwKICAgICAgICAgICAgICAgICAgICAgICAgaGVhZGVycwogICAgICAgICAgICAgICAgICAgIH0pCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGNoZWNrRXF1YWwoJ3NlYXJjaFJlc3BvbnNlLnN0YXR1cycsIHNlYXJjaFJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgICAgICAgICAgICAgIGNvbnN0IHNlYXJjaFJlc3VsdCA9IGF3YWl0IHNlYXJjaFJlc3BvbnNlLmpzb24oKTsKICAgICAgICAgICAgICAgIGlmIChzZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQpIHsKICAgICAgICAgICAgICAgICAgICBpZiAodHlwZW9mIHNlYXJjaFJlc3VsdC5waVNlYXJjaFJlc3VsdCA9PT0gJ3N0cmluZycpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBzZWFyY2hSZXN1bHQucGlTZWFyY2hSZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGpvYi5zZWFyY2hSZXN1bHRzLnB1c2goLi4uc2VhcmNoUmVzdWx0LnBpU2VhcmNoUmVzdWx0LmZlZWRzLnNsaWNlKDAsIDIwKSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfSBlbHNlIGlmIChzZWFyY2hSZXN1bHQucGlJZFJlc3VsdCkgewogICAgICAgICAgICAgICAgICAgIGlmICh0eXBlb2Ygc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQgPT09ICdzdHJpbmcnKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGFkZE1lc3NhZ2UoJ2Vycm9yJywgc2VhcmNoUmVzdWx0LnBpSWRSZXN1bHQpOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGlmICghaXNSZWFkb25seUFycmF5KHNlYXJjaFJlc3VsdC5waUlkUmVzdWx0LmZlZWQpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZVdpdGhVcmwgPSBzZWFyY2hSZXN1bHQucGlJZFJlc3VsdC5mZWVkLnVybDsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgIH0gY2F0Y2ggKGUpIHsKICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKTsKICAgICAgICAgICAgYWRkTWVzc2FnZSgnZXJyb3InLCBlLm1lc3NhZ2UpOwogICAgICAgIH0gZmluYWxseXsKICAgICAgICAgICAgYWRkTWVzc2FnZSgnaW5mbycsIGAke2pvYi5zZWFyY2ggPyAnU2VhcmNoIHRvb2snIDogJ1Rvb2snfSAke2Zvcm1hdFRpbWUoRGF0ZS5ub3coKSAtIGpvYlN0YXJ0KX0ke2NvbXB1dGVKb2JUaW1lc1N0cmluZ1N1ZmZpeChqb2IpfWApOwogICAgICAgICAgICBpZiAoY29udGludWVXaXRoVXJsKSB7CiAgICAgICAgICAgICAgICB0aGlzLmNvbnRpbnVlV2l0aChjb250aW51ZVdpdGhVcmwpOwogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgam9iLmRvbmUgPSB0cnVlOwogICAgICAgICAgICAgICAgY29uc3Qgc3RhdHVzID0gam9iLmNhbmNlbGxlZCA/ICdDYW5jZWxsZWQnIDogam9iLnNlYXJjaCAmJiBqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGggPT09IDAgPyAnRm91bmQgbm8gcG9kY2FzdHMnIDogam9iLnNlYXJjaCAmJiBqb2Iuc2VhcmNoUmVzdWx0cy5sZW5ndGggPT09IDEgPyAnRm91bmQgb25lIHBvZGNhc3QsIHNlbGVjdCB0byBjb250aW51ZScgOiBqb2Iuc2VhcmNoID8gYEZvdW5kICR7am9iLnNlYXJjaFJlc3VsdHMubGVuZ3RofSBwb2RjYXN0cywgc2VsZWN0IG9uZSB0byBjb250aW51ZWAgOiAnRG9uZSc7CiAgICAgICAgICAgICAgICBzZXRTdGF0dXMoc3RhdHVzLCB7CiAgICAgICAgICAgICAgICAgICAgdHlwZTogJ2RvbmUnCiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpmdW5jdGlvbiBmb3JtYXRCeXRlcyhieXRlcykgewogICAgbGV0IGFtb3VudCA9IGJ5dGVzOwogICAgaWYgKGFtb3VudCA8IDEwMjQpIHJldHVybiBgJHthbW91bnR9LWJ5dGVgOwogICAgYW1vdW50ID0gYW1vdW50IC8gMTAyNDsKICAgIGlmIChhbW91bnQgPCAxMDI0KSByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfWtiYDsKICAgIGFtb3VudCA9IGFtb3VudCAvIDEwMjQ7CiAgICByZXR1cm4gYCR7TWF0aC5yb3VuZChhbW91bnQgKiAxMDApIC8gMTAwfW1iYDsKfQpmdW5jdGlvbiBmb3JtYXRUaW1lKG1pbGxpcykgewogICAgaWYgKG1pbGxpcyA8IDEwMDApIHJldHVybiBgJHttaWxsaXN9bXNgOwogICAgcmV0dXJuIGAke01hdGgucm91bmQobWlsbGlzIC8gMTAwMCAqIDEwMCkgLyAxMDB9c2A7Cn0KZnVuY3Rpb24gY29tcHV0ZUpvYlRpbWVzU3RyaW5nU3VmZml4KGpvYikgewogICAgY29uc3QgcnQgPSBbCiAgICAgICAgWwogICAgICAgICAgICAnZmV0Y2gnLAogICAgICAgICAgICBqb2IudGltZXMuZmV0Y2hUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdyZWFkJywKICAgICAgICAgICAgam9iLnRpbWVzLnJlYWRUaW1lCiAgICAgICAgXSwKICAgICAgICBbCiAgICAgICAgICAgICdwYXJzZScsCiAgICAgICAgICAgIGpvYi50aW1lcy5wYXJzZVRpbWUKICAgICAgICBdLAogICAgICAgIFsKICAgICAgICAgICAgJ3ZhbGlkYXRlJywKICAgICAgICAgICAgam9iLnRpbWVzLnZhbGlkYXRlVGltZQogICAgICAgIF0sCiAgICAgICAgWwogICAgICAgICAgICAnY29tbWVudHMnLAogICAgICAgICAgICBqb2IudGltZXMuY29tbWVudHNUaW1lCiAgICAgICAgXQogICAgXS5maWx0ZXIoKHYpPT52WzFdICE9PSB1bmRlZmluZWQKICAgICkubWFwKCh2KT0+YCR7dlswXX09JHtmb3JtYXRUaW1lKHZbMV0pfWAKICAgICkuam9pbignLCAnKTsKICAgIHJldHVybiBydCA9PT0gJycgPyAnJyA6IGAgKCR7cnR9KWA7Cn0KZnVuY3Rpb24gdW5pdFN0cmluZyhhbW91bnQsIHVuaXQpIHsKICAgIHJldHVybiBgJHthbW91bnQgPT09IDAgPyAnbm8nIDogYW1vdW50ID09PSAxID8gJ29uZScgOiBuZXcgSW50bC5OdW1iZXJGb3JtYXQoKS5mb3JtYXQoYW1vdW50KX0gJHt1bml0fSR7YW1vdW50ID09PSAxID8gJycgOiAncyd9YDsKfQpmdW5jdGlvbiBub3JtYWxpemVJbnB1dChpbnB1dCkgewogICAgaW5wdXQgPSBpbnB1dC50cmltKCk7CiAgICBjb25zdCBtID0gL15odHRwczpcL1wvcG9kY2FzdHNcLmFwcGxlXC5jb21cLy4qPyhpZFxkKykkLy5leGVjKGlucHV0KTsKICAgIGlmIChtKSByZXR1cm4gbVsxXTsKICAgIHJldHVybiBpbnB1dDsKfQpmdW5jdGlvbiB0cnlQYXJzZVVybDEodXJsKSB7CiAgICB0cnkgewogICAgICAgIHJldHVybiBuZXcgVVJMKHVybCk7CiAgICB9IGNhdGNoICB7CiAgICAgICAgcmV0dXJuIHVuZGVmaW5lZDsKICAgIH0KfQpmdW5jdGlvbiBzbGVlcChtcykgewogICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKT0+c2V0VGltZW91dChyZXNvbHZlLCBtcykKICAgICk7Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoRmV0Y2hBY3Rpdml0eVB1Yih1cmwsIHVzZVNpZGUsIHNsZWVwTWlsbGlzQmV0d2VlbkNhbGxzKSB7CiAgICBpZiAoc2xlZXBNaWxsaXNCZXR3ZWVuQ2FsbHMgPiAwKSBhd2FpdCBzbGVlcChzbGVlcE1pbGxpc0JldHdlZW5DYWxscyk7CiAgICBjb25zdCB7IHJlc3BvbnNlICwgc2lkZSAgfSA9IGF3YWl0IGxvY2FsT3JSZW1vdGVGZXRjaCh1cmwsIHsKICAgICAgICBoZWFkZXJzOiB7CiAgICAgICAgICAgICdBY2NlcHQnOiAnYXBwbGljYXRpb24vYWN0aXZpdHkranNvbicKICAgICAgICB9LAogICAgICAgIHVzZVNpZGUKICAgIH0pOwogICAgY2hlY2tFcXVhbCgncmVzLnN0YXR1cycsIHJlc3BvbnNlLnN0YXR1cywgMjAwKTsKICAgIGNvbnNvbGUubG9nKFsKICAgICAgICAuLi5yZXNwb25zZS5oZWFkZXJzCiAgICBdLm1hcCgodik9PnYuam9pbignOiAnKQogICAgKSk7CiAgICBjb25zdCBjb250ZW50VHlwZSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdDb250ZW50LVR5cGUnKTsKICAgIGlmICghKGNvbnRlbnRUeXBlIHx8ICcnKS5pbmNsdWRlcygnanNvbicpKSB7CiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdGb3VuZCBodG1sLCBub3QgQWN0aXZpdHlQdWInKTsKICAgIH0KICAgIGNvbnN0IG9iaiA9IGF3YWl0IHJlc3BvbnNlLmpzb24oKTsKICAgIHJldHVybiB7CiAgICAgICAgb2JqLAogICAgICAgIHNpZGUKICAgIH07Cn0KYXN5bmMgZnVuY3Rpb24gbG9jYWxPclJlbW90ZUZldGNoKHVybCwgb3B0cyA9IHsKfSkgewogICAgY29uc3QgeyBoZWFkZXJzICwgdXNlU2lkZSAgfSA9IG9wdHM7CiAgICBpZiAodXNlU2lkZSAhPT0gJ3JlbW90ZScpIHsKICAgICAgICB0cnkgewogICAgICAgICAgICBjb25zb2xlLmxvZyhgbG9jYWwgZmV0Y2g6ICR7dXJsfWApOwogICAgICAgICAgICBjb25zdCBzdGFydCA9IERhdGUubm93KCk7CiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJsLCB7CiAgICAgICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgICAgIH0pOwogICAgICAgICAgICByZXR1cm4gewogICAgICAgICAgICAgICAgZmV0Y2hUaW1lOiBEYXRlLm5vdygpIC0gc3RhcnQsCiAgICAgICAgICAgICAgICBzaWRlOiAnbG9jYWwnLAogICAgICAgICAgICAgICAgcmVzcG9uc2UKICAgICAgICAgICAgfTsKICAgICAgICB9IGNhdGNoIChlKSB7CiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdGYWlsZWQgdG8gbG9jYWwgZmV0Y2gsIHRyeWluZyByZW1vdGUnLCBlKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zb2xlLmxvZyhgcmVtb3RlIGZldGNoOiAke3VybH1gKTsKICAgIGNvbnN0IHN0YXJ0ID0gRGF0ZS5ub3coKTsKICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2goYC9mLyR7dXJsLnJlcGxhY2VBbGwoL1teYS16QS1aMC05Ll0rL2csICdfJyl9YCwgewogICAgICAgIG1ldGhvZDogJ1BPU1QnLAogICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KHsKICAgICAgICAgICAgdXJsLAogICAgICAgICAgICBoZWFkZXJzCiAgICAgICAgfSkKICAgIH0pOwogICAgcmV0dXJuIHsKICAgICAgICBmZXRjaFRpbWU6IERhdGUubm93KCkgLSBzdGFydCwKICAgICAgICBzaWRlOiAncmVtb3RlJywKICAgICAgICByZXNwb25zZQogICAgfTsKfQpmdW5jdGlvbiBmaW5kRXBpc29kZVRpdGxlKHNvY2lhbEludGVyYWN0KSB7CiAgICBjb25zdCBpdGVtID0gc29jaWFsSW50ZXJhY3QucGFyZW50OwogICAgaWYgKGl0ZW0pIHsKICAgICAgICBjb25zdCB0aXRsZSA9IGl0ZW0uY2hpbGRbJ3RpdGxlJ107CiAgICAgICAgaWYgKHRpdGxlLmxlbmd0aCA+IDAgJiYgdGl0bGVbMF0udmFsKSB7CiAgICAgICAgICAgIGNvbnN0IHZhbCA9IHRpdGxlWzBdLnZhbC50cmltKCk7CiAgICAgICAgICAgIGlmICh2YWwubGVuZ3RoID4gMCkgewogICAgICAgICAgICAgICAgcmV0dXJuIHZhbDsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIHJldHVybiB1bmRlZmluZWQ7Cn0KY29uc3QgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTID0gY3NzYAoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciB7CiAgICAtd2Via2l0LWFwcGVhcmFuY2U6IG5vbmU7CiAgICAtbW96LWFwcGVhcmFuY2U6IG5vbmU7CiAgICBhcHBlYXJhbmNlOiBub25lOwogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJvcmRlcjogbm9uZTsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHBhZGRpbmc6IDAuMjVlbTsKICAgIHdpZHRoOiAzZW07CiAgICBoZWlnaHQ6IDNlbTsKICAgIGNvbG9yOiB2YXIoLS1wdXJlLW1hdGVyaWFsLXByaW1hcnktcmdiLCByZ2IoMzMsIDE1MCwgMjQzKSk7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGZvbnQtc2l6ZTogMTZweDsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOjotd2Via2l0LXByb2dyZXNzLWJhciB7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKfQoKLyogSW5kZXRlcm1pbmF0ZSAqLwoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlIHsKICAgIC13ZWJraXQtbWFzay1pbWFnZTogbGluZWFyLWdyYWRpZW50KHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKSwgbGluZWFyLWdyYWRpZW50KHRvIHJpZ2h0LCB0cmFuc3BhcmVudCA1MCUsIGJsYWNrIDUwJSk7CiAgICBtYXNrLWltYWdlOiBsaW5lYXItZ3JhZGllbnQodHJhbnNwYXJlbnQgNTAlLCBibGFjayA1MCUpLCBsaW5lYXItZ3JhZGllbnQodG8gcmlnaHQsIHRyYW5zcGFyZW50IDUwJSwgYmxhY2sgNTAlKTsKICAgIGFuaW1hdGlvbjogcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhciA2cyBpbmZpbml0ZSBjdWJpYy1iZXppZXIoMC4zLCAwLjYsIDEsIDEpOwp9Cgo6LW1zLWxhbmcoeCksIC5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGUgewogICAgYW5pbWF0aW9uOiBub25lOwp9CgoucHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhcjppbmRldGVybWluYXRlOjpiZWZvcmUsCi5wdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyOmluZGV0ZXJtaW5hdGU6Oi13ZWJraXQtcHJvZ3Jlc3MtdmFsdWUgewogICAgY29udGVudDogIiI7CiAgICBkaXNwbGF5OiBibG9jazsKICAgIGJveC1zaXppbmc6IGJvcmRlci1ib3g7CiAgICBtYXJnaW4tYm90dG9tOiAwLjI1ZW07CiAgICBib3JkZXI6IHNvbGlkIDAuMjVlbSB0cmFuc3BhcmVudDsKICAgIGJvcmRlci10b3AtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIGJvcmRlci1yYWRpdXM6IDUwJTsKICAgIHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gMC43NXMgaW5maW5pdGUgbGluZWFyIGFsdGVybmF0ZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LW1vei1wcm9ncmVzcy1iYXIgewogICAgYm94LXNpemluZzogYm9yZGVyLWJveDsKICAgIGJvcmRlcjogc29saWQgMC4yNWVtIHRyYW5zcGFyZW50OwogICAgYm9yZGVyLXRvcC1jb2xvcjogY3VycmVudENvbG9yOwogICAgYm9yZGVyLXJhZGl1czogNTAlOwogICAgd2lkdGg6IDEwMCU7CiAgICBoZWlnaHQ6IDEwMCU7CiAgICBiYWNrZ3JvdW5kLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIGFuaW1hdGlvbjogcHVyZS1tYXRlcmlhbC1wcm9ncmVzcy1jaXJjdWxhci1wc2V1ZG8gMC43NXMgaW5maW5pdGUgbGluZWFyIGFsdGVybmF0ZTsKfQoKLnB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXI6aW5kZXRlcm1pbmF0ZTo6LW1zLWZpbGwgewogICAgYW5pbWF0aW9uLW5hbWU6IC1tcy1yaW5nOwp9CgpAa2V5ZnJhbWVzIHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXIgewogICAgMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDBkZWcpOwogICAgfQogICAgMTIuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE4MGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgMjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSg2MzBkZWcpOwogICAgfQogICAgMzcuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDgxMGRlZyk7CiAgICAgICAgYW5pbWF0aW9uLXRpbWluZy1mdW5jdGlvbjogbGluZWFyOwogICAgfQogICAgNTAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxMjYwZGVnKTsKICAgIH0KICAgIDYyLjUlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgxNDQwZGVnKTsKICAgICAgICBhbmltYXRpb24tdGltaW5nLWZ1bmN0aW9uOiBsaW5lYXI7CiAgICB9CiAgICA3NSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDE4OTBkZWcpOwogICAgfQogICAgODcuNSUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDIwNzBkZWcpOwogICAgICAgIGFuaW1hdGlvbi10aW1pbmctZnVuY3Rpb246IGxpbmVhcjsKICAgIH0KICAgIDEwMCUgewogICAgICAgIHRyYW5zZm9ybTogcm90YXRlKDI1MjBkZWcpOwogICAgfQp9CgpAa2V5ZnJhbWVzIHB1cmUtbWF0ZXJpYWwtcHJvZ3Jlc3MtY2lyY3VsYXItcHNldWRvIHsKICAgIDAlIHsKICAgICAgICB0cmFuc2Zvcm06IHJvdGF0ZSgtMzBkZWcpOwogICAgfQogICAgMjkuNCUgewogICAgICAgIGJvcmRlci1sZWZ0LWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIH0KICAgIDI5LjQxJSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgIH0KICAgIDY0LjclIHsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiB0cmFuc3BhcmVudDsKICAgIH0KICAgIDY0LjcxJSB7CiAgICAgICAgYm9yZGVyLWJvdHRvbS1jb2xvcjogY3VycmVudENvbG9yOwogICAgfQogICAgMTAwJSB7CiAgICAgICAgYm9yZGVyLWxlZnQtY29sb3I6IGN1cnJlbnRDb2xvcjsKICAgICAgICBib3JkZXItYm90dG9tLWNvbG9yOiBjdXJyZW50Q29sb3I7CiAgICAgICAgdHJhbnNmb3JtOiByb3RhdGUoMjI1ZGVnKTsKICAgIH0KfQpgOwpmdW5jdGlvbiBleHRlcm5hbGl6ZUFuY2hvcihhbmNob3IpIHsKICAgIGFuY2hvci50YXJnZXQgPSAnX2JsYW5rJzsKICAgIGFuY2hvci5yZWwgPSAnbm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyc7Cn0KY29uc3QgQ09NTUVOVFNfSFRNTCA9IGh0bWxgCjxkZXRhaWxzIGlkPSJjb21tZW50cy1kZXRhaWxzIiBvcGVuPgogICAgPHN1bW1hcnk+Q29tbWVudHMgZm9yIDxzcGFuIGlkPSJjb21tZW50cy1zdWJqZWN0Ij5zdWJqZWN0PC9zcGFuPjwvc3VtbWFyeT4KICAgIDxvdXRwdXQgaWQ9ImNvbW1lbnRzIj48L291dHB1dD4KPC9kZXRhaWxzPgpgOwpjb25zdCBDT01NRU5UU19DU1MgPSBjc3NgCgojY29tbWVudHMtZGV0YWlscyB7CiAgICBkaXNwbGF5OiBub25lOwogICAgZm9udC1zaXplOiAwLjc1cmVtOwogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvckhleCl9OwogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIG1heC13aWR0aDogMTAwJTsKICAgIG92ZXJmbG93OiBoaWRkZW47Cn0KCi5jb21tZW50IHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBtYXgtd2lkdGg6IDgwY2g7CiAgICBsaW5lLWhlaWdodDogMS41Owp9CgouY29tbWVudCAuaWNvbiB7CiAgICB3aWR0aDogM2VtOwogICAgaGVpZ2h0OiAzZW07CiAgICBib3JkZXItcmFkaXVzOiAwLjVlbTsKICAgIG1hcmdpbjogMC43NWVtIDFlbSAxZW0gMDsKfQoKLmNvbW1lbnQgLnJocyB7CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKICAgIG1hcmdpbjogMC43NWVtIDFlbSAwIDA7CiAgICBmbGV4LWdyb3c6IDE7Cn0KCi5jb21tZW50IC5oZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41ZW07CiAgICBhbGlnbi1pdGVtczogYmFzZWxpbmU7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0KCi5jb21tZW50IC5oZWFkZXIgLnVybCB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9yU2Vjb25kYXJ5SGV4KX07Cn0KCi5jb21tZW50IC5yaHMgcCB7CiAgICBtYXJnaW4tYmxvY2stc3RhcnQ6IDBlbTsKICAgIG1hcmdpbi1ibG9jay1lbmQ6IDBlbTsKfQoKLmNvbW1lbnQgaW1nIHsKICAgIG1heC13aWR0aDogODBjaDsKICAgIHdpZHRoOiBhdXRvOwogICAgaGVpZ2h0OiBhdXRvOwp9CgoucmVwbHkgZmllbGRzZXQgewogICAgZGlzcGxheTogZmxleDsKICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICBib3JkZXI6IHNvbGlkIDFweCAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfSAKCi5yZXBseSB0ZXh0YXJlYSB7CiAgICB3aWR0aDogMTAwJTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKICAgIGJhY2tncm91bmQtY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLmJhY2tncm91bmRDb2xvckhleCl9Owp9CgoucmVwbHkgYnV0dG9uIHsKICAgIHBhZGRpbmc6IDAuMjVyZW0gMnJlbTsKICAgIGFsaWduLXNlbGY6IGZsZXgtZW5kOwogICAgbWFyZ2luOiAwLjVyZW0gMDsKfQoKYDsKZnVuY3Rpb24gaW5pdENvbW1lbnRzKGRvY3VtZW50LCB2bSkgewogICAgY29uc3QgY29tbWVudHNEZXRhaWxzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2NvbW1lbnRzLWRldGFpbHMnKTsKICAgIGNvbnN0IGNvbW1lbnRzU3ViamVjdFNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMtc3ViamVjdCcpOwogICAgY29uc3QgY29tbWVudHNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnY29tbWVudHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHJlc3VsdCA9IHZtLmZldGNoQ29tbWVudHNSZXN1bHQ7CiAgICAgICAgY29tbWVudHNEZXRhaWxzLnN0eWxlLmRpc3BsYXkgPSByZXN1bHQgPyAnYmxvY2snIDogJ25vbmUnOwogICAgICAgIGNvbW1lbnRzU3ViamVjdFNwYW4udGV4dENvbnRlbnQgPSByZXN1bHQ/LnN1YmplY3QgfHwgJ3N1YmplY3QnOwogICAgICAgIGlmIChyZXN1bHQgIT09IF9yZW5kZXJlZFJlc3VsdCkgewogICAgICAgICAgICByZW5kZXJDb21tZW50cyhyZXN1bHQsIGNvbW1lbnRzT3V0cHV0LCB2bSk7CiAgICAgICAgICAgIF9yZW5kZXJlZFJlc3VsdCA9IHJlc3VsdDsKICAgICAgICB9CiAgICB9Owp9CmxldCBfcmVuZGVyZWRSZXN1bHQ7CmZ1bmN0aW9uIHJlbmRlckNvbW1lbnRzKHJlc3VsdCwgY29tbWVudHNPdXRwdXQsIHZtKSB7CiAgICB3aGlsZShjb21tZW50c091dHB1dC5maXJzdENoaWxkKWNvbW1lbnRzT3V0cHV0LnJlbW92ZUNoaWxkKGNvbW1lbnRzT3V0cHV0LmZpcnN0Q2hpbGQpOwogICAgaWYgKHJlc3VsdCkgcmVuZGVyTm9kZShyZXN1bHQucm9vdENvbW1lbnQsIHJlc3VsdC5jb21tZW50ZXJzLCBjb21tZW50c091dHB1dCwgMCwgdm0pOwp9CmZ1bmN0aW9uIHJlbmRlck5vZGUoY29tbWVudCwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwsIHZtKSB7CiAgICBjb25zdCBjb21tZW50ZXIgPSBjb21tZW50LmF0dHJpYnV0ZWRUbyA/IGNvbW1lbnRlcnMuZ2V0KGNvbW1lbnQuYXR0cmlidXRlZFRvKSA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGNvbW1lbnREaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGNvbW1lbnREaXYuY2xhc3NMaXN0LmFkZCgnY29tbWVudCcpOwogICAgaWYgKGxldmVsID4gMCkgY29tbWVudERpdi5zdHlsZS5tYXJnaW5MZWZ0ID0gYCR7bGV2ZWwgKiA0fWVtYDsKICAgIGNvbnN0IGljb25JbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgIGljb25JbWcuY2xhc3NMaXN0LmFkZCgnaWNvbicpOwogICAgaWNvbkltZy5zcmMgPSBjb21tZW50ZXIgJiYgY29tbWVudGVyLmljb24gPyBjb21tZW50ZXIuaWNvbi51cmwgOiAnIyc7CiAgICBjb21tZW50RGl2LmFwcGVuZENoaWxkKGljb25JbWcpOwogICAgY29uc3QgcmhzRGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7CiAgICByaHNEaXYuY2xhc3NMaXN0LmFkZCgncmhzJyk7CiAgICBjb25zdCBoZWFkZXJEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgIGhlYWRlckRpdi5jbGFzc0xpc3QuYWRkKCdoZWFkZXInKTsKICAgIGNvbnN0IGF0dHJpYnV0ZWRUb0RpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgYXR0cmlidXRlZFRvRGl2LmNsYXNzTGlzdC5hZGQoJ2F0dHJpYnV0ZWQtdG8nKTsKICAgIGlmIChjb21tZW50ZXIpIHsKICAgICAgICBjb25zdCBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIGEuaHJlZiA9IGNvbW1lbnRlci51cmw7CiAgICAgICAgYS50YXJnZXQgPSAnX2JsYW5rJzsKICAgICAgICBhLnRleHRDb250ZW50ID0gY29tbWVudGVyLm5hbWUgKyAnICcgKyBjb21tZW50ZXIuZnFVc2VybmFtZTsKICAgICAgICBhdHRyaWJ1dGVkVG9EaXYuYXBwZW5kQ2hpbGQoYSk7CiAgICB9IGVsc2UgewogICAgICAgIGF0dHJpYnV0ZWRUb0Rpdi5hcHBlbmRDaGlsZChkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZShjb21tZW50LmF0dHJpYnV0ZWRUbyB8fCAnPHVua25vd24+JykpOwogICAgfQogICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGF0dHJpYnV0ZWRUb0Rpdik7CiAgICBjb25zdCBhZ2VUZXh0ID0gZG9jdW1lbnQuY3JlYXRlVGV4dE5vZGUoY29tbWVudC5wdWJsaXNoZWQgPyBjb21wdXRlQWdlKG5ldyBEYXRlKGNvbW1lbnQucHVibGlzaGVkKSkgOiAnJyk7CiAgICBpZiAoY29tbWVudC51cmwpIHsKICAgICAgICBjb25zdCBhZ2VBbmNob3IgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgYWdlQW5jaG9yLmNsYXNzTGlzdC5hZGQoJ3VybCcpOwogICAgICAgIGFnZUFuY2hvci5ocmVmID0gY29tbWVudC51cmw7CiAgICAgICAgZXh0ZXJuYWxpemVBbmNob3IoYWdlQW5jaG9yKTsKICAgICAgICBhZ2VBbmNob3IuYXBwZW5kQ2hpbGQoYWdlVGV4dCk7CiAgICAgICAgaGVhZGVyRGl2LmFwcGVuZENoaWxkKGFnZUFuY2hvcik7CiAgICB9IGVsc2UgewogICAgICAgIGhlYWRlckRpdi5hcHBlbmRDaGlsZChhZ2VUZXh0KTsKICAgIH0KICAgIHJoc0Rpdi5hcHBlbmRDaGlsZChoZWFkZXJEaXYpOwogICAgY29uc3QgY29udGVudERpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgY29udGVudERpdi5pbm5lckhUTUwgPSBjb21tZW50LmNvbnRlbnQ7CiAgICBjb250ZW50RGl2LnF1ZXJ5U2VsZWN0b3JBbGwoJ2EnKS5mb3JFYWNoKGV4dGVybmFsaXplQW5jaG9yKTsKICAgIHJoc0Rpdi5hcHBlbmRDaGlsZChjb250ZW50RGl2KTsKICAgIGZvciAoY29uc3QgYXR0YWNobWVudCBvZiBjb21tZW50LmF0dGFjaG1lbnRzKXsKICAgICAgICBjb25zdCBhdHRhY2htZW50RGV0YWlscyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RldGFpbHMnKTsKICAgICAgICBjb25zdCBzdW1tYXJ5ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3VtbWFyeScpOwogICAgICAgIHN1bW1hcnkudGV4dENvbnRlbnQgPSBgQXR0YWNobWVudCAoJHthdHRhY2htZW50Lm1lZGlhVHlwZX0pYDsKICAgICAgICBhdHRhY2htZW50RGV0YWlscy5hcHBlbmRDaGlsZChzdW1tYXJ5KTsKICAgICAgICBjb25zdCBpbWcgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdpbWcnKTsKICAgICAgICBpbWcuc3JjID0gYXR0YWNobWVudC51cmw7CiAgICAgICAgaWYgKGF0dGFjaG1lbnQud2lkdGggJiYgYXR0YWNobWVudC5oZWlnaHQpIHsKICAgICAgICAgICAgaW1nLndpZHRoID0gYXR0YWNobWVudC53aWR0aDsKICAgICAgICAgICAgaW1nLmhlaWdodCA9IGF0dGFjaG1lbnQuaGVpZ2h0OwogICAgICAgIH0KICAgICAgICBhdHRhY2htZW50RGV0YWlscy5hcHBlbmRDaGlsZChpbWcpOwogICAgICAgIHJoc0Rpdi5hcHBlbmRDaGlsZChhdHRhY2htZW50RGV0YWlscyk7CiAgICB9CiAgICBpZiAoY29tbWVudC51cmwpIHsKICAgICAgICBjb25zdCByZXBseVRvVXJsID0gY29tbWVudC51cmw7CiAgICAgICAgY29uc3QgcmVwbHlEaXYgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdkaXYnKTsKICAgICAgICByZXBseURpdi5jbGFzc05hbWUgPSAncmVwbHknOwogICAgICAgIGNvbnN0IHJlcGx5QW5jaG9yID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnYScpOwogICAgICAgIHJlcGx5QW5jaG9yLnRleHRDb250ZW50ID0gIlJlcGx5IOKGkiI7CiAgICAgICAgcmVwbHlBbmNob3IuaHJlZiA9ICcjJzsKICAgICAgICByZXBseURpdi5hcHBlbmRDaGlsZChyZXBseUFuY2hvcik7CiAgICAgICAgY29uc3QgcmVwbHlGaWVsZHNldENvbnRhaW5lciA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIHJlcGx5RGl2LmFwcGVuZENoaWxkKHJlcGx5RmllbGRzZXRDb250YWluZXIpOwogICAgICAgIHJlcGx5QW5jaG9yLm9uY2xpY2sgPSAoZSk9PnsKICAgICAgICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpOwogICAgICAgICAgICB0b2dnbGVSZXBseUJveChyZXBseUFuY2hvciwgcmVwbHlGaWVsZHNldENvbnRhaW5lciwgcmVwbHlUb1VybCwgdm0pOwogICAgICAgIH07CiAgICAgICAgcmhzRGl2LmFwcGVuZENoaWxkKHJlcGx5RGl2KTsKICAgIH0KICAgIGNvbW1lbnREaXYuYXBwZW5kQ2hpbGQocmhzRGl2KTsKICAgIGNvbnRhaW5lckVsZW1lbnQuYXBwZW5kQ2hpbGQoY29tbWVudERpdik7CiAgICBmb3IgKGNvbnN0IHJlcGx5IG9mIGNvbW1lbnQucmVwbGllcyl7CiAgICAgICAgcmVuZGVyTm9kZShyZXBseSwgY29tbWVudGVycywgY29udGFpbmVyRWxlbWVudCwgbGV2ZWwgKyAxLCB2bSk7CiAgICB9Cn0KZnVuY3Rpb24gY29tcHV0ZUFnZShkYXRlKSB7CiAgICBjb25zdCBtaWxsaXMgPSBEYXRlLm5vdygpIC0gZGF0ZS5nZXRUaW1lKCk7CiAgICBjb25zdCBzZWNvbmRzID0gbWlsbGlzIC8gMTAwMDsKICAgIGNvbnN0IG1pbnV0ZXMgPSBzZWNvbmRzIC8gNjA7CiAgICBpZiAobWludXRlcyA8IDYwKSByZXR1cm4gYCR7TWF0aC5tYXgoTWF0aC5mbG9vcihtaW51dGVzKSwgMSl9bWA7CiAgICBjb25zdCBob3VycyA9IG1pbnV0ZXMgLyA2MDsKICAgIGlmIChob3VycyA8IDI0KSByZXR1cm4gYCR7TWF0aC5mbG9vcihob3Vycyl9aGA7CiAgICBjb25zdCBkYXlzID0gaG91cnMgLyAyNDsKICAgIHJldHVybiBgJHtNYXRoLmZsb29yKGRheXMpfWRgOwp9CmZ1bmN0aW9uIHRvZ2dsZVJlcGx5Qm94KGFuY2hvciwgZmllbGRzZXRDb250YWluZXIsIHJlcGx5VG9VcmwsIF92bSkgewogICAgaWYgKGFuY2hvci50ZXh0Q29udGVudD8uc3RhcnRzV2l0aCgnUmVwbHknKSkgewogICAgICAgIGFuY2hvci50ZXh0Q29udGVudCA9ICdDYW5jZWwg4oW5JzsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihSRVBMWV9CT1gsIGZpZWxkc2V0Q29udGFpbmVyKTsKICAgICAgICBjb25zdCBhID0gZmllbGRzZXRDb250YWluZXIuZ2V0RWxlbWVudHNCeVRhZ05hbWUoJ2EnKVswXTsKICAgICAgICBjb25zdCB0ZXh0YXJlYSA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCd0ZXh0YXJlYScpWzBdOwogICAgICAgIGNvbnN0IGJ1dHRvbiA9IGZpZWxkc2V0Q29udGFpbmVyLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdidXR0b24nKVswXTsKICAgICAgICBjb25zdCBvcmlnaW4gPSBuZXcgVVJMKHJlcGx5VG9VcmwpLm9yaWdpbjsKICAgICAgICBhLnRleHRDb250ZW50ID0gYExvZ2luIGF0ICR7b3JpZ2lufS4uLmA7CiAgICAgICAgYS5vbmNsaWNrID0gKGUpPT57CiAgICAgICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICAgICAgY29uc3QgdyA9IHdpbmRvdy5vcGVuKGAvbG9naW4/b3JpZ2luPSR7ZW5jb2RlVVJJQ29tcG9uZW50KG9yaWdpbil9YCwgJ2xvZ2luJyk7CiAgICAgICAgICAgIGlmICh3KSB7CiAgICAgICAgICAgICAgICBnbG9iYWxUaGlzLm9ubWVzc2FnZSA9IChlKT0+ewogICAgICAgICAgICAgICAgICAgIGNvbnN0IHsgZGF0YSAgfSA9IGU7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coJ29ubWVzc2FnZScsIGRhdGEpOwogICAgICAgICAgICAgICAgICAgIGlmIChkYXRhLm9yaWdpbiAmJiBkYXRhLnRva2VuUmVzcG9uc2UpIHsKICAgICAgICAgICAgICAgICAgICAgICAgdy5jbG9zZSgpOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgIH0KICAgICAgICB9OwogICAgICAgIGNvbnN0IGxvZ2dlZEluID0gZmFsc2U7CiAgICAgICAgY29uc3QgdXBkYXRlID0gKCk9PnsKICAgICAgICAgICAgYS5zdHlsZS5kaXNwbGF5ID0gbG9nZ2VkSW4gPyAnbm9uZScgOiAnYmxvY2snOwogICAgICAgICAgICB0ZXh0YXJlYS5zdHlsZS5kaXNwbGF5ID0gYnV0dG9uLnN0eWxlLmRpc3BsYXkgPSBsb2dnZWRJbiA/ICdibG9jaycgOiAnbm9uZSc7CiAgICAgICAgfTsKICAgICAgICB1cGRhdGUoKTsKICAgIH0gZWxzZSB7CiAgICAgICAgTGl0RWxlbWVudC5yZW5kZXIodW5kZWZpbmVkLCBmaWVsZHNldENvbnRhaW5lcik7CiAgICAgICAgYW5jaG9yLnRleHRDb250ZW50ID0gIlJlcGx5IOKGkiI7CiAgICB9Cn0KY29uc3QgUkVQTFlfQk9YID0gaHRtbGAKPGZpZWxkc2V0PgogICAgPGxlZ2VuZD5SZXBseTwvbGVnZW5kPgogICAgPGEgaHJlZj0iIyI+TG9naW4gdG8gLi4uPC9hPgogICAgPHRleHRhcmVhIHR5cGU9InRleHQiIG5hbWU9ImNvbnRlbnQiIHJvd3M9IjQiIHBsYWNlaG9sZGVyPSJZb3VyIHJlcGx5Li4uIj48L3RleHRhcmVhPgogICAgPGJ1dHRvbiB0eXBlPSJzdWJtaXQiPlNlbmQ8L2J1dHRvbj4KPC9maWVsZHNldD4KYDsKY29uc3QgSU5GT19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMSA3aDJ2MmgtMnptMCA0aDJ2NmgtMnptMS05QzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHoiLz48L3N2Zz5gOwpjb25zdCBXQVJOSU5HX0lDT04gPSBzdmdgPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PHBhdGggZD0iTTEyIDUuOTlMMTkuNTMgMTlINC40N0wxMiA1Ljk5TTIuNzQgMThjLS43NyAxLjMzLjE5IDMgMS43MyAzaDE1LjA2YzEuNTQgMCAyLjUtMS42NyAxLjczLTNMMTMuNzMgNC45OWMtLjc3LTEuMzMtMi42OS0xLjMzLTMuNDYgMEwyLjc0IDE4ek0xMSAxMXYyYzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMXYtMmMwLS41NS0uNDUtMS0xLTFzLTEgLjQ1LTEgMXptMCA1aDJ2MmgtMnoiLz48L3N2Zz5gOwpjb25zdCBFUlJPUl9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0yMC43MSA3Ljk4TDE2LjAzIDMuM2MtLjE5LS4xOS0uNDUtLjMtLjcxLS4zSDguNjhjLS4yNiAwLS41Mi4xMS0uNy4yOUwzLjI5IDcuOThjLS4xOC4xOC0uMjkuNDQtLjI5Ljd2Ni42M2MwIC4yNy4xMS41Mi4yOS43MWw0LjY4IDQuNjhjLjE5LjE5LjQ1LjMuNzEuM2g2LjYzYy4yNyAwIC41Mi0uMTEuNzEtLjI5bDQuNjgtNC42OGMuMTktLjE5LjI5LS40NC4yOS0uNzFWOC42OGMuMDEtLjI2LS4xLS41Mi0uMjgtLjd6TTE5IDE0LjlMMTQuOSAxOUg5LjFMNSAxNC45VjkuMUw5LjEgNWg1LjhMMTkgOS4xdjUuOHoiLz48Y2lyY2xlIGN4PSIxMiIgY3k9IjE2IiByPSIxIi8+PHBhdGggZD0iTTEyIDdjLS41NSAwLTEgLjQ1LTEgMXY1YzAgLjU1LjQ1IDEgMSAxczEtLjQ1IDEtMVY4YzAtLjU1LS40NS0xLTEtMXoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS19JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBoZWlnaHQ9IjI0cHgiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjI0cHgiIGZpbGw9IiNGRkZGRkYiPjxwYXRoIGQ9Ik0wIDBoMjR2MjRIMFYweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGQ9Ik0xMiAyQzYuNDggMiAyIDYuNDggMiAxMnM0LjQ4IDEwIDEwIDEwIDEwLTQuNDggMTAtMTBTMTcuNTIgMiAxMiAyem0wIDE4Yy00LjQxIDAtOC0zLjU5LTgtOHMzLjU5LTggOC04IDggMy41OSA4IDgtMy41OSA4LTggOHptMy44OC0xMS43MUwxMCAxNC4xN2wtMS44OC0xLjg4Yy0uMzktLjM5LTEuMDItLjM5LTEuNDEgMC0uMzkuMzktLjM5IDEuMDIgMCAxLjQxbDIuNTkgMi41OWMuMzkuMzkgMS4wMi4zOSAxLjQxIDBMMTcuMyA5LjdjLjM5LS4zOS4zOS0xLjAyIDAtMS40MS0uMzktLjM5LTEuMDMtLjM5LTEuNDIgMHoiLz48L3N2Zz5gOwpjb25zdCBDSEVDS0xJU1RfSUNPTiA9IHN2Z2A8c3ZnIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMjQgMjQiIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iI0ZGRkZGRiI+PGc+PHJlY3QgZmlsbD0ibm9uZSIgaGVpZ2h0PSIyNCIgd2lkdGg9IjI0Ii8+PC9nPjxnPjxnPjxwYXRoIGQ9Ik01LDVoMnYxYzAsMS4xLDAuOSwyLDIsMmg2YzEuMSwwLDItMC45LDItMlY1aDJ2NWgyVjVjMC0xLjEtMC45LTItMi0yaC00LjE4QzE0LjQsMS44NCwxMy4zLDEsMTIsMVM5LjYsMS44NCw5LjE4LDNINSBDMy45LDMsMywzLjksMyw1djE0YzAsMS4xLDAuOSwyLDIsMmg2di0ySDVWNXogTTEyLDNjMC41NSwwLDEsMC40NSwxLDFzLTAuNDUsMS0xLDFzLTEtMC40NS0xLTFTMTEuNDUsMywxMiwzeiIvPjxwYXRoIGQ9Ik0yMS43NSwxMi4yNWMtMC40MS0wLjQxLTEuMDktMC40MS0xLjUsMEwxNS41MSwxN2wtMi4yNi0yLjI1Yy0wLjQxLTAuNDEtMS4wOC0wLjQxLTEuNSwwbDAsMGMtMC40MSwwLjQxLTAuNDEsMS4wOSwwLDEuNSBsMy4wNSwzLjA0YzAuMzksMC4zOSwxLjAyLDAuMzksMS40MSwwbDUuNTMtNS41NEMyMi4xNiwxMy4zNCwyMi4xNiwxMi42NiwyMS43NSwxMi4yNXoiLz48L2c+PC9nPjwvc3ZnPmA7CmNvbnN0IFNRVUFSRV9JQ09OID0gc3ZnYDxzdmcgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiBlbmFibGUtYmFja2dyb3VuZD0ibmV3IDAgMCAyNCAyNCIgaGVpZ2h0PSIyNHB4IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNHB4IiBmaWxsPSIjRkZGRkZGIj48Zz48cmVjdCBmaWxsPSJub25lIiBoZWlnaHQ9IjI0IiB3aWR0aD0iMjQiLz48L2c+PGc+PGc+PHBhdGggZD0iTTMsM3YxOGgxOFYzSDN6IE0xOSwxOUg1VjVoMTRWMTl6Ii8+PC9nPjwvZz48L3N2Zz5gOwpjb25zdCBGT1JNX0hUTUwgPSBodG1sYAo8aGVhZGVyPiR7Q0hFQ0tMSVNUX0lDT059PGgxPkxpdmV3aXJlIFBvZGNhc3QgVmFsaWRhdG9yIDxzcGFuIGlkPSJ2ZXJzaW9uIj52MC4yPC9zcGFuPjwvaDE+PC9oZWFkZXI+Cjxmb3JtIGlkPSJmb3JtIj4KICAgIDxpbnB1dCBpZD0idGV4dC1pbnB1dCIgdHlwZT0idGV4dCIgcGxhY2Vob2xkZXI9IlBvZGNhc3QgZmVlZCB1cmwsIEFjdGl2aXR5UHViIHVybCwgQXBwbGUgUG9kY2FzdHMgdXJsLCBvciBzZWFyY2ggdGV4dCIgYXV0b2NvbXBsZXRlPSJ1cmwiIHJlcXVpcmVkPgogICAgPGJ1dHRvbiBpZD0ic3VibWl0IiB0eXBlPSJzdWJtaXQiPlZhbGlkYXRlPC9idXR0b24+CjwvZm9ybT4KYDsKY29uc3QgRk9STV9DU1MgPSBjc3NgCgpoZWFkZXIgewogICAgZGlzcGxheTogZmxleDsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBnYXA6IDFyZW07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwogICAgb3BhY2l0eTogMC43NTsKfQoKaGVhZGVyIGgxIHsKICAgIG1hcmdpbjogMDsKfQoKaGVhZGVyIHN2ZyB7CiAgICB0cmFuc2Zvcm06IHNjYWxlKDEuNSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiN2ZXJzaW9uIHsKICAgIG9wYWNpdHk6IDAuMjU7Cn0KCiNmb3JtIHsKICAgIGRpc3BsYXk6IGZsZXg7CiAgICBnYXA6IDFyZW07CiAgICBtYXJnaW4tYm90dG9tOiAxcmVtOwp9CgovKiogaW9zIHJlc2V0cyAqLwpAc3VwcG9ydHMgKC13ZWJraXQtdG91Y2gtY2FsbG91dDogbm9uZSkgewogICAgaW5wdXQsIHRleHRhcmVhLCBidXR0b24gewogICAgICAgIC13ZWJraXQtYXBwZWFyYW5jZTogbm9uZTsKICAgICAgICBib3JkZXItcmFkaXVzOiAwOwogICAgfQoKICAgIGJ1dHRvbiB7CiAgICAgICAgYm9yZGVyOiBzb2xpZCAxcHggd2hpdGU7CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDY1MHB4KSB7CgogICAgaGVhZGVyIHsKICAgICAgICBmb250LXNpemU6IDY2JTsKICAgICAgICBnYXA6IDAuNXJlbTsKICAgIH0KCiAgICBoZWFkZXIgc3ZnIHsKICAgICAgICB0cmFuc2Zvcm06IHNjYWxlKDEuMCk7CiAgICB9CgogICAgI2Zvcm0gewogICAgICAgIGZsZXgtZGlyZWN0aW9uOiBjb2x1bW47CiAgICB9Cgp9CgpAbWVkaWEgb25seSBzY3JlZW4gYW5kIChtYXgtd2lkdGg6IDUwMHB4KSB7CgogICAgI3ZlcnNpb24gewogICAgICAgIGRpc3BsYXk6IG5vbmU7CiAgICB9Cgp9CgojdGV4dC1pbnB1dCB7CiAgICBmb250LXNpemU6IDFyZW07CiAgICBmbGV4LWdyb3c6IDE7CiAgICBwYWRkaW5nOiAwLjVyZW0gMC41cmVtOwogICAgYmFja2dyb3VuZC1jb2xvcjogaW5oZXJpdDsKICAgIGJvcmRlcjogc29saWQgMXB4IHdoaXRlOwogICAgb3V0bGluZTogbm9uZTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3RleHQtaW5wdXQ6cmVhZC1vbmx5IHsKICAgIG9wYWNpdHk6IDAuNTsgCn0KCmlucHV0Oi13ZWJraXQtYXV0b2ZpbGwsIGlucHV0Oi13ZWJraXQtYXV0b2ZpbGw6Zm9jdXMgewogICAgdHJhbnNpdGlvbjogYmFja2dyb3VuZC1jb2xvciA2MDAwMDBzIDBzLCBjb2xvciA2MDAwMDBzIDBzOwp9CgojZm9ybSBidXR0b24gewogICAgcGFkZGluZzogMC41cmVtIDFyZW07CiAgICBtaW4td2lkdGg6IDhyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRGb3JtKGRvY3VtZW50LCB2bSwgc3RhdGljRGF0YSkgewogICAgY29uc3QgZm9ybSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdmb3JtJyk7CiAgICBjb25zdCB0ZXh0SW5wdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndGV4dC1pbnB1dCcpOwogICAgY29uc3Qgc3VibWl0QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3N1Ym1pdCcpOwogICAgY29uc3QgdmVyc2lvblNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmVyc2lvbicpOwogICAgY29uc3QgdmVyc2lvbiA9IFsKICAgICAgICBzdGF0aWNEYXRhLnZlcnNpb24sCiAgICAgICAgc3RhdGljRGF0YS5wdXNoSWQKICAgIF0ubWFwKCh2KT0+KHYgfHwgJycpLnRyaW0oKQogICAgKS5maWx0ZXIoKHYpPT52Lmxlbmd0aCA+IDAKICAgICkuam9pbignLicpOwogICAgdmVyc2lvblNwYW4udGV4dENvbnRlbnQgPSBzdGF0aWNEYXRhLnZlcnNpb24gPyBgdiR7dmVyc2lvbn1gIDogJyc7CiAgICBjb25zdCB7IHNlYXJjaFBhcmFtcyAgfSA9IG5ldyBVUkwoZG9jdW1lbnQuVVJMKTsKICAgIGNvbnN0IHZhbGlkYXRlID0gc2VhcmNoUGFyYW1zLmdldCgndmFsaWRhdGUnKSB8fCB1bmRlZmluZWQ7CiAgICBjb25zdCBpbnB1dCA9IHNlYXJjaFBhcmFtcy5nZXQoJ2lucHV0JykgfHwgdW5kZWZpbmVkOwogICAgY29uc3Qgbm9jb21tZW50cyA9IHNlYXJjaFBhcmFtcy5oYXMoJ25vY29tbWVudHMnKTsKICAgIGNvbnN0IHN0YXJ0VmFsaWRhdGlvbiA9ICgpPT52bS5zdGFydFZhbGlkYXRpb24odGV4dElucHV0LnZhbHVlLCB7CiAgICAgICAgICAgIHZhbGlkYXRlQ29tbWVudHM6ICFub2NvbW1lbnRzLAogICAgICAgICAgICB1c2VyQWdlbnQ6IG5hdmlnYXRvci51c2VyQWdlbnQKICAgICAgICB9KQogICAgOwogICAgZm9ybS5vbnN1Ym1pdCA9IChlKT0+ewogICAgICAgIGUucHJldmVudERlZmF1bHQoKTsKICAgICAgICBpZiAodm0udmFsaWRhdGluZykgewogICAgICAgICAgICB2bS5jYW5jZWxWYWxpZGF0aW9uKCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgc3RhcnRWYWxpZGF0aW9uKCk7CiAgICAgICAgfQogICAgfTsKICAgIGlmICh2YWxpZGF0ZSkgewogICAgICAgIHRleHRJbnB1dC52YWx1ZSA9IHZhbGlkYXRlOwogICAgICAgIHNldFRpbWVvdXQoc3RhcnRWYWxpZGF0aW9uLCAwKTsKICAgIH0gZWxzZSBpZiAoaW5wdXQpIHsKICAgICAgICB0ZXh0SW5wdXQudmFsdWUgPSBpbnB1dDsKICAgIH0KICAgIHRleHRJbnB1dC5mb2N1cygpOwogICAgcmV0dXJuICgpPT57CiAgICAgICAgY29uc3Qgd2FzRGlzYWJsZWQgPSB0ZXh0SW5wdXQuZGlzYWJsZWQ7CiAgICAgICAgdGV4dElucHV0LmRpc2FibGVkID0gdm0udmFsaWRhdGluZzsKICAgICAgICB0ZXh0SW5wdXQucmVhZE9ubHkgPSB2bS52YWxpZGF0aW5nOwogICAgICAgIHN1Ym1pdEJ1dHRvbi50ZXh0Q29udGVudCA9IHZtLnZhbGlkYXRpbmcgPyAnQ2FuY2VsJyA6ICdWYWxpZGF0ZSc7CiAgICAgICAgaWYgKHdhc0Rpc2FibGVkICYmICF0ZXh0SW5wdXQuZGlzYWJsZWQpIHsKICAgICAgICAgICAgdGV4dElucHV0LmZvY3VzKCk7CiAgICAgICAgfQogICAgfTsKfQpjb25zdCBNRVNTQUdFU19IVE1MID0gaHRtbGAKPG91dHB1dCBpZD0ibWVzc2FnZXMiPjwvb3V0cHV0PgpgOwpjb25zdCBNRVNTQUdFU19DU1MgPSBjc3NgCgojbWVzc2FnZXMgewogICAgbWFyZ2luLWJvdHRvbTogMXJlbTsKICAgIGRpc3BsYXk6IGdyaWQ7CiAgICBncmlkLXRlbXBsYXRlLWNvbHVtbnM6IDJyZW0gYXV0bzsKICAgIGFsaWduLWl0ZW1zOiBjZW50ZXI7CiAgICBmb250LXNpemU6IDAuNzVyZW07Cn0KCiNtZXNzYWdlcyA+IGRpdiwgI21lc3NhZ2VzID4gYSB7CiAgICBhbmltYXRpb246IGZhZGVJbkFuaW1hdGlvbiAwLjRzOwp9CgojbWVzc2FnZXMgc3ZnIHsKICAgIHRyYW5zZm9ybTogc2NhbGUoMC43NSk7CiAgICBmaWxsOiBjdXJyZW50Q29sb3I7Cn0KCiNtZXNzYWdlcyA+IGRpdi5pbmZvIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKfQoKI21lc3NhZ2VzID4gZGl2Lmdvb2QgewogICAgY29sb3I6ICM0M2EwNDc7Cn0KI21lc3NhZ2VzID4gZGl2Lndhcm5pbmcgewogICAgY29sb3I6ICNlNjUxMDA7Cn0KCiNtZXNzYWdlcyA+IGRpdi5lcnJvciB7CiAgICBjb2xvcjogI2I3MWMxYzsKfQoKI21lc3NhZ2VzID4gZGl2LnJ1bm5pbmcsICNtZXNzYWdlcyA+IGRpdi5kb25lIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI21lc3NhZ2VzIC5pY29uIHsKICAgIGdyaWQtY29sdW1uOiAxOwogICAgd2lkdGg6IDI0cHg7CiAgICBoZWlnaHQ6IDI0cHg7CiAgICBkaXNwbGF5OiBmbGV4OwogICAganVzdGlmeS1jb250ZW50OiBjZW50ZXI7CiAgICBhbGlnbi1pdGVtczogY2VudGVyOwp9CgojbWVzc2FnZXMgLm1lc3NhZ2UgewogICAgZ3JpZC1jb2x1bW46IDI7Cn0KCiNtZXNzYWdlcyAudXJsIHsKICAgIGdyaWQtY29sdW1uOiAyOwogICAgbWFyZ2luLWJvdHRvbTogMC4yNXJlbTsKICAgIG92ZXJmbG93OiBoaWRkZW47CiAgICB0ZXh0LW92ZXJmbG93OiBlbGxpcHNpczsKfQoKI21lc3NhZ2VzIHByb2dyZXNzIHsKICAgIGZvbnQtc2l6ZTogMC4zNXJlbTsKfQoKI21lc3NhZ2VzIC5yZWZlcmVuY2UgewogICAgZGlzcGxheTogaW5saW5lLWJsb2NrOwogICAgbWFyZ2luLWxlZnQ6IDAuMjVyZW07Cn0KCmA7CmZ1bmN0aW9uIGluaXRNZXNzYWdlcyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IG1lc3NhZ2VzT3V0cHV0ID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ21lc3NhZ2VzJyk7CiAgICByZXR1cm4gKCk9PnsKICAgICAgICBMaXRFbGVtZW50LnJlbmRlcihNRVNTQUdFX0hUTUwodm0pLCBtZXNzYWdlc091dHB1dCk7CiAgICB9Owp9CmNvbnN0IE1FU1NBR0VfSFRNTCA9ICh2bSk9Pmh0bWxgCiAgICAke3ZtLm1lc3NhZ2VzLmZpbHRlcihmaWx0ZXJEdXBsaWNhdGVzKCkpLm1hcCgobWVzc2FnZSk9Pmh0bWxgCiAgICAgICAgPGRpdiBjbGFzcz0iJHttZXNzYWdlLnR5cGV9IGljb24iPiR7aWNvbihtZXNzYWdlLnR5cGUpfTwvZGl2PgogICAgICAgIDxkaXYgY2xhc3M9IiR7bWVzc2FnZS50eXBlfSBtZXNzYWdlIj4ke21lc3NhZ2UudGV4dH0ke1JFRkVSRU5DRV9IVE1MKG1lc3NhZ2UucmVmZXJlbmNlKX08L2Rpdj4KICAgICAgICAke0FOQ0hPUl9IVE1MKG1lc3NhZ2UudXJsKX1gCiAgICApfWAKOwpjb25zdCBSRUZFUkVOQ0VfSFRNTCA9IChyZWZlcmVuY2UpPT5yZWZlcmVuY2UgPyBodG1sYDxhIGNsYXNzPSJyZWZlcmVuY2UiIGhyZWY9JHtyZWZlcmVuY2UuaHJlZn0gdGFyZ2V0PSJfYmxhbmsiIHJlbD0ibm9yZWZlcnJlciBub29wZW5lciBub2ZvbGxvdyI+WyR7cmVmZXJlbmNlLnJ1bGVzZXR9XTwvYT5gIDogdW5kZWZpbmVkCjsKY29uc3QgQU5DSE9SX0hUTUwgPSAodXJsKT0+dXJsID8gaHRtbGA8YSBocmVmPSR7dXJsfSB0YXJnZXQ9Il9ibGFuayIgcmVsPSJub3JlZmVycmVyIG5vb3BlbmVyIG5vZm9sbG93IiBjbGFzcz0idXJsIj4ke3VybH08L2E+YCA6IHVuZGVmaW5lZAo7CmZ1bmN0aW9uIGljb24odHlwZSkgewogICAgcmV0dXJuIHR5cGUgPT09ICdydW5uaW5nJyA/IGh0bWxgPHByb2dyZXNzIGNsYXNzPSJwdXJlLW1hdGVyaWFsLXByb2dyZXNzLWNpcmN1bGFyIj48L3Byb2dyZXNzPmAgOiB0eXBlID09PSAnZG9uZScgPyBDSEVDS19JQ09OIDogdHlwZSA9PT0gJ2Vycm9yJyA/IEVSUk9SX0lDT04gOiB0eXBlID09PSAnd2FybmluZycgPyBXQVJOSU5HX0lDT04gOiB0eXBlID09PSAnZ29vZCcgPyBDSEVDS19JQ09OIDogSU5GT19JQ09OOwp9CmZ1bmN0aW9uIGZpbHRlckR1cGxpY2F0ZXMoKSB7CiAgICBjb25zdCB0YWdVcmxzID0gbmV3IFNldCgpOwogICAgcmV0dXJuIChtZXNzYWdlKT0+ewogICAgICAgIGNvbnN0IHsgdGFnICwgdXJsICB9ID0gbWVzc2FnZTsKICAgICAgICBpZiAodGFnICYmIHVybCkgewogICAgICAgICAgICBjb25zdCB0YWdVcmwgPSBgJHt0YWd9fCR7dXJsfWA7CiAgICAgICAgICAgIGlmICh0YWdVcmxzLmhhcyh0YWdVcmwpKSByZXR1cm4gZmFsc2U7CiAgICAgICAgICAgIHRhZ1VybHMuYWRkKHRhZ1VybCk7CiAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgIH0KICAgICAgICByZXR1cm4gdHJ1ZTsKICAgIH07Cn0KY29uc3QgU0VBUkNIX1JFU1VMVFNfSFRNTCA9IGh0bWxgCjxvdXRwdXQgaWQ9InNlYXJjaC1yZXN1bHRzIj48L291dHB1dD4KYDsKY29uc3QgU0VBUkNIX1JFU1VMVFNfQ1NTID0gY3NzYAoKI3NlYXJjaC1yZXN1bHRzIHsKICAgIG1hcmdpbi1ib3R0b206IDFyZW07CiAgICBkaXNwbGF5OiBub25lOwp9Cgojc2VhcmNoLXJlc3VsdHMgPiBkaXYgewogICAgZGlzcGxheTogZmxleDsKICAgIGdhcDogMC41cmVtOwogICAgYWxpZ24taXRlbXM6IGNlbnRlcjsKICAgIGZvbnQtc2l6ZTogMC43NXJlbTsKICAgIGFuaW1hdGlvbjogZmFkZUluQW5pbWF0aW9uIDAuNHM7CiAgICBtYXJnaW4tYm90dG9tOiAwLjc1cmVtOwogICAgY3Vyc29yOiBwb2ludGVyOwp9Cgojc2VhcmNoLXJlc3VsdHMgLmljb24sICNzZWFyY2gtcmVzdWx0cyBpbWcgewogICAgd2lkdGg6IDEuNXJlbTsKICAgIGhlaWdodDogMS41cmVtOwp9Cgojc2VhcmNoLXJlc3VsdHMgLnRpdGxlIHsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JIZXgpfTsKfQoKI3NlYXJjaC1yZXN1bHRzIC5hdXRob3IgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnRleHRDb2xvclNlY29uZGFyeUhleCl9Owp9CgpgOwpmdW5jdGlvbiBpbml0U2VhcmNoUmVzdWx0cyhkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHNlYXJjaFJlc3VsdHNPdXRwdXQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VhcmNoLXJlc3VsdHMnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIExpdEVsZW1lbnQucmVuZGVyKFJFU1VMVFNfSFRNTCh2bSksIHNlYXJjaFJlc3VsdHNPdXRwdXQpOwogICAgICAgIHNlYXJjaFJlc3VsdHNPdXRwdXQuc3R5bGUuZGlzcGxheSA9IHZtLmlzU2VhcmNoID8gJ2Jsb2NrJyA6ICdub25lJzsKICAgIH07Cn0KY29uc3QgUkVTVUxUU19IVE1MID0gKHZtKT0+aHRtbGAKICAgICR7dm0uc2VhcmNoUmVzdWx0cy5tYXAoKHJlc3VsdCk9Pmh0bWxgPGRpdiBjbGFzcz0ic2VhcmNoLXJlc3VsdCIgQGNsaWNrPSIke3NlbGVjdFJlc3VsdCh2bSwgcmVzdWx0LnVybCl9Ij48ZGl2IGNsYXNzPSJpY29uIj4ke0lNQUdFX0hUTUwocmVzdWx0LmFydHdvcmspfTwvZGl2PjxkaXYgY2xhc3M9InRpdGxlIj4ke3Jlc3VsdC50aXRsZX08L2Rpdj48ZGl2IGNsYXNzPSJhdXRob3IiPiR7cmVzdWx0LmF1dGhvcn08L2Rpdj48L2Rpdj5gCiAgICApfWAKOwpjb25zdCBJTUFHRV9IVE1MID0gKGFydHdvcmspPT5hcnR3b3JrID8gaHRtbGA8aW1nIHNyYz0ke2FydHdvcmt9PmAgOiBTUVVBUkVfSUNPTgo7CmZ1bmN0aW9uIHNlbGVjdFJlc3VsdCh2bSwgdXJsKSB7CiAgICByZXR1cm4gKCk9PnZtLmNvbnRpbnVlV2l0aCh1cmwpCiAgICA7Cn0KY29uc3QgWE1MX0hUTUwgPSBodG1sYAo8b3V0cHV0IGlkPSJ4bWwiPjwvb3V0cHV0PgpgOwpjb25zdCBYTUxfQ1NTID0gY3NzYAojeG1sIHsKICAgIGZvbnQtZmFtaWx5OiAke3Vuc2FmZUNTUyhUaGVtZS5tb25vc3BhY2VGb250RmFtaWx5KX07CiAgICBmb250LXNpemU6IDAuNzVyZW07CiAgICBsaW5lLWhlaWdodDogMXJlbTsKICAgIGNvbG9yOiAke3Vuc2FmZUNTUyhUaGVtZS50ZXh0Q29sb3JTZWNvbmRhcnlIZXgpfTsKICAgIG92ZXJmbG93LXdyYXA6IGJyZWFrLXdvcmQ7CiAgICBsaW5lLWhlaWdodDogMS40Owp9CgojeG1sIC5yb290IHsKICAgIGZvbnQtZmFtaWx5OiAke3Vuc2FmZUNTUyhUaGVtZS5zYW5zU2VyaWZGb250RmFtaWx5KX07CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07CiAgICBsaW5lLWhlaWdodDogMjsKfQoKI3htbCAuY29udGVudCB7CiAgICBjb2xvcjogJHt1bnNhZmVDU1MoVGhlbWUudGV4dENvbG9ySGV4KX07Cn0KCiN4bWwgLnBvZGNhc3QgewogICAgY29sb3I6ICNhYjQ3YmM7Cn0KCiN4bWwgLmluZGVudCB7CiAgICBtYXJnaW4tbGVmdDogMC43NXJlbTsKfQoKI3htbCAuaW5kZW50MiB7CiAgICBtYXJnaW4tbGVmdDogMS41cmVtOwp9CgpzdW1tYXJ5LmVtcHR5IHsgbGlzdC1zdHlsZTogbm9uZTsgY3Vyc29yOiB0ZXh0OyB9CnN1bW1hcnkuZW1wdHk6Oi13ZWJraXQtZGV0YWlscy1tYXJrZXIgeyBkaXNwbGF5OiBub25lOyB9CgojeG1sIGF1ZGlvIHsKICAgIG1hcmdpbjogMC41cmVtIDFyZW07Cn0KYDsKZnVuY3Rpb24gaW5pdFhtbChkb2N1bWVudCwgdm0pIHsKICAgIGNvbnN0IHhtbE91dHB1dCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd4bWwnKTsKICAgIHJldHVybiAoKT0+ewogICAgICAgIGNvbnN0IHhtbCA9IHZtLnhtbDsKICAgICAgICBpZiAoeG1sICE9PSBfcmVuZGVyZWRYbWwpIHsKICAgICAgICAgICAgcmVuZGVyWG1sKHhtbCwgeG1sT3V0cHV0LCB2bS54bWxTdW1tYXJ5VGV4dCk7CiAgICAgICAgICAgIF9yZW5kZXJlZFhtbCA9IHhtbDsKICAgICAgICB9CiAgICB9Owp9CmxldCBfcmVuZGVyZWRYbWw7CmZ1bmN0aW9uIHJlbmRlclhtbCh4bWwsIHhtbE91dHB1dCwgeG1sU3VtbWFyeVRleHQpIHsKICAgIHdoaWxlKHhtbE91dHB1dC5maXJzdENoaWxkKXhtbE91dHB1dC5yZW1vdmVDaGlsZCh4bWxPdXRwdXQuZmlyc3RDaGlsZCk7CiAgICBpZiAoeG1sKSByZW5kZXJOb2RlMSh4bWwsIHhtbE91dHB1dCwgMCwgbmV3IFNldCgpLCB1bmRlZmluZWQsIHhtbFN1bW1hcnlUZXh0KTsKfQpmdW5jdGlvbiByZW5kZXJOb2RlMShub2RlLCBjb250YWluZXJFbGVtZW50LCBsZXZlbCwgY29udGV4dCwgaXRlbU51bWJlciwgeG1sU3VtbWFyeVRleHQpIHsKICAgIGNvbnN0IHsgYXR0cyAgfSA9IG5vZGU7CiAgICBjb25zdCBkZXRhaWxzID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGV0YWlscycpOwogICAgY29uc3QgdGV4dCA9IG5vZGUudmFsIHx8ICcnOwogICAgZGV0YWlscy5vcGVuID0gIWNvbnRleHQuaGFzKCdmb3VuZC1pdGVtJykgfHwgdGV4dC5sZW5ndGggPiAwOwogICAgaWYgKGxldmVsID4gMCkgZGV0YWlscy5jbGFzc0xpc3QuYWRkKCdpbmRlbnQnKTsKICAgIGNvbnN0IHN1bW1hcnkgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdzdW1tYXJ5Jyk7CiAgICBpZiAobGV2ZWwgPT09IDApIHsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKHN1bW1hcnksIHhtbFN1bW1hcnlUZXh0IHx8ICdYbWwnKTsKICAgICAgICBzdW1tYXJ5LmNsYXNzTGlzdC5hZGQoJ3Jvb3QnKTsKICAgIH0gZWxzZSB7CiAgICAgICAgY29uc3Qgc3BhbkNsYXNzID0gUW5hbWVzLlBvZGNhc3RJbmRleC5OQU1FU1BBQ0VTLmluY2x1ZGVzKG5vZGUucW5hbWUubmFtZXNwYWNlVXJpIHx8ICcnKSA/ICdwb2RjYXN0JyA6IHVuZGVmaW5lZDsKICAgICAgICByZW5kZXJUZXh0UGllY2VzKHN1bW1hcnksICc8JywgewogICAgICAgICAgICB0ZXh0OiBub2RlLnRhZ25hbWUsCiAgICAgICAgICAgIHNwYW5DbGFzcwogICAgICAgIH0sIC4uLlsKICAgICAgICAgICAgLi4uYXR0cy5lbnRyaWVzKCkKICAgICAgICBdLmZsYXRNYXAoKHYpPT5bCiAgICAgICAgICAgICAgICBgICR7dlswXX09ImAsCiAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgdGV4dDogdlsxXSwKICAgICAgICAgICAgICAgICAgICBzcGFuQ2xhc3M6ICdjb250ZW50JwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICciJwogICAgICAgICAgICBdCiAgICAgICAgKSwgJz4nLCBpdGVtTnVtYmVyID8gYCAjJHtpdGVtTnVtYmVyfWAgOiAnJyk7CiAgICB9CiAgICBkZXRhaWxzLmFwcGVuZENoaWxkKHN1bW1hcnkpOwogICAgbGV0IGNoaWxkQ291bnQgPSAwOwogICAgaWYgKHRleHQubGVuZ3RoID4gMCkgewogICAgICAgIGNvbnN0IGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpOwogICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCdjb250ZW50Jyk7CiAgICAgICAgcmVuZGVyVGV4dFBpZWNlcyhkaXYsIHRleHQpOwogICAgICAgIGRpdi5jbGFzc0xpc3QuYWRkKCdpbmRlbnQyJyk7CiAgICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChkaXYpOwogICAgICAgIGNoaWxkQ291bnQrKzsKICAgIH0KICAgIGZvciAoY29uc3QgW25hbWUsIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhub2RlLmNoaWxkKSl7CiAgICAgICAgbGV0IGl0ZW1OdW1iZXIgPSAxOwogICAgICAgIGxldCBpdGVtc05vdFNob3duID0gMDsKICAgICAgICBmb3IgKGNvbnN0IGNoaWxkIG9mIHZhbHVlKXsKICAgICAgICAgICAgaWYgKG5hbWUgPT09ICdpdGVtJyAmJiBpdGVtTnVtYmVyID4gMjApIHsKICAgICAgICAgICAgICAgIGl0ZW1zTm90U2hvd24rKzsKICAgICAgICAgICAgICAgIGNvbnRpbnVlOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJlbmRlck5vZGUxKGNoaWxkLCBkZXRhaWxzLCBsZXZlbCArIDEsIGNvbnRleHQsIHZhbHVlLmxlbmd0aCA+IDEgPyBpdGVtTnVtYmVyIDogdW5kZWZpbmVkKTsKICAgICAgICAgICAgY2hpbGRDb3VudCsrOwogICAgICAgICAgICBpdGVtTnVtYmVyKys7CiAgICAgICAgfQogICAgICAgIGlmIChpdGVtc05vdFNob3duID4gMCkgewogICAgICAgICAgICBjb25zdCBmYWtlTm9kZSA9IHsKICAgICAgICAgICAgICAgIHRhZ25hbWU6IGAuLi5hbmQgJHtuZXcgSW50bC5OdW1iZXJGb3JtYXQoKS5mb3JtYXQoaXRlbXNOb3RTaG93bil9IG1vcmUgaXRlbXNgLAogICAgICAgICAgICAgICAgYXR0czogbmV3IE1hcCgpLAogICAgICAgICAgICAgICAgcW5hbWU6IHsKICAgICAgICAgICAgICAgICAgICBuYW1lOiAnJwogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIGF0dHJzTWFwOiB7CiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgY2hpbGQ6IHsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICAgICAgcmVuZGVyTm9kZTEoZmFrZU5vZGUsIGRldGFpbHMsIGxldmVsIC0gMSwgY29udGV4dCwgdW5kZWZpbmVkKTsKICAgICAgICB9CiAgICB9CiAgICBjb25zdCBhdWRpb1VybCA9IG5vZGUudGFnbmFtZSA9PT0gJ2VuY2xvc3VyZScgJiYgYXR0cy5nZXQoJ3VybCcpIHx8IG5vZGUucW5hbWUubmFtZXNwYWNlVXJpICYmIHFuYW1lc0luY2x1ZGUoUW5hbWVzLlBvZGNhc3RJbmRleC5zb3VyY2UsIG5vZGUucW5hbWUpICYmIGF0dHMuZ2V0KCd1cmknKSB8fCBxbmFtZUVxKG5vZGUucW5hbWUsIFFuYW1lcy5NZWRpYVJzcy5jb250ZW50KSAmJiAoYXR0cy5nZXQoJ3R5cGUnKSB8fCAnJykuc3RhcnRzV2l0aCgnYXVkaW8nKSAmJiBhdHRzLmdldCgndXJsJyk7CiAgICBpZiAoYXVkaW9VcmwpIHsKICAgICAgICBjb25zdCBhdWRpbyA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2F1ZGlvJyk7CiAgICAgICAgYXVkaW8uY29udHJvbHMgPSB0cnVlOwogICAgICAgIGF1ZGlvLnByZWxvYWQgPSAnbm9uZSc7CiAgICAgICAgYXVkaW8uc3JjID0gYXVkaW9Vcmw7CiAgICAgICAgZGV0YWlscy5hcHBlbmRDaGlsZChhdWRpbyk7CiAgICAgICAgY2hpbGRDb3VudCsrOwogICAgfQogICAgaWYgKGNoaWxkQ291bnQgPT09IDApIHN1bW1hcnkuY2xhc3NMaXN0LmFkZCgnZW1wdHknLCAnaW5kZW50Jyk7CiAgICBjb250YWluZXJFbGVtZW50LmFwcGVuZENoaWxkKGRldGFpbHMpOwogICAgaWYgKG5vZGUudGFnbmFtZSA9PT0gJ2l0ZW0nKSBjb250ZXh0LmFkZCgnZm91bmQtaXRlbScpOwp9CmZ1bmN0aW9uIHJlbmRlclRleHRQaWVjZXMoZWxlbWVudCwgLi4ucGllY2VzKSB7CiAgICBmb3IgKGNvbnN0IHBpZWNlIG9mIHBpZWNlcyl7CiAgICAgICAgY29uc3QgdGV4dCA9IHR5cGVvZiBwaWVjZSA9PT0gJ3N0cmluZycgPyBwaWVjZSA6IHBpZWNlLnRleHQ7CiAgICAgICAgY29uc3Qgc3BhbkNsYXNzID0gdHlwZW9mIHBpZWNlID09PSAnb2JqZWN0JyA/IHBpZWNlLnNwYW5DbGFzcyA6IHVuZGVmaW5lZDsKICAgICAgICBpZiAoL15odHRwcz86XC9cL1teXHMpXSskLy50ZXN0KHRleHQpKSB7CiAgICAgICAgICAgIGNvbnN0IGEgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCdhJyk7CiAgICAgICAgICAgIGEuaHJlZiA9IHRleHQ7CiAgICAgICAgICAgIGV4dGVybmFsaXplQW5jaG9yKGEpOwogICAgICAgICAgICBhLmFwcGVuZENoaWxkKGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpKTsKICAgICAgICAgICAgZWxlbWVudC5hcHBlbmRDaGlsZChhKTsKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBjb25zdCB0ZXh0Tm9kZSA9IGRvY3VtZW50LmNyZWF0ZVRleHROb2RlKHRleHQpOwogICAgICAgICAgICBpZiAoc3BhbkNsYXNzKSB7CiAgICAgICAgICAgICAgICBjb25zdCBzcGFuID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc3BhbicpOwogICAgICAgICAgICAgICAgc3Bhbi5jbGFzc0xpc3QuYWRkKHNwYW5DbGFzcyk7CiAgICAgICAgICAgICAgICBzcGFuLmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgICAgIGVsZW1lbnQuYXBwZW5kQ2hpbGQoc3Bhbik7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBlbGVtZW50LmFwcGVuZENoaWxkKHRleHROb2RlKTsKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQpjb25zdCBhcHBNb2R1bGVTY3JpcHQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnYXBwLW1vZHVsZS1zY3JpcHQnKTsKZnVuY3Rpb24gc2V0QXBwU3RhdGUoYXBwU3RhdGUpIHsKICAgIGFwcE1vZHVsZVNjcmlwdC5kYXRhc2V0LnN0YXRlID0gYXBwU3RhdGU7Cn0Kc2V0QXBwU3RhdGUoJ3N0YXJ0aW5nJyk7CmNvbnN0IGFwcENzcyA9IGNzc2AKCmEgewogICAgY29sb3I6ICR7dW5zYWZlQ1NTKFRoZW1lLnByaW1hcnlDb2xvcjMwMEhleCl9OwogICAgdGV4dC11bmRlcmxpbmUtb2Zmc2V0OiAwLjJyZW07CiAgICB0ZXh0LWRlY29yYXRpb246IG5vbmU7Cn0KCkBtZWRpYSAoaG92ZXI6IGhvdmVyKSB7CiAgICBhOmhvdmVyIHsKICAgICAgICB0ZXh0LWRlY29yYXRpb246IHVuZGVybGluZTsKICAgIH0KfQoKbWFpbiB7CiAgICBtYXJnaW46IDJyZW07CiAgICBkaXNwbGF5OiBmbGV4OwogICAgZmxleC1kaXJlY3Rpb246IGNvbHVtbjsKfQoKQGtleWZyYW1lcyBmYWRlSW5BbmltYXRpb24gewogICAgMCUgewogICAgICAgIG9wYWNpdHk6IDA7CiAgICB9CiAgICAxMDAlIHsKICAgICAgICBvcGFjaXR5OiAxOwogICAgfQp9CgpzdW1tYXJ5IHsKICAgIGN1cnNvcjogcG9pbnRlcjsKfQoKYDsKY29uc3QgYXBwSHRtbCA9IGh0bWxgCjxtYWluPgoke0ZPUk1fSFRNTH0KJHtNRVNTQUdFU19IVE1MfQoke1NFQVJDSF9SRVNVTFRTX0hUTUx9CiR7Q09NTUVOVFNfSFRNTH0KJHtYTUxfSFRNTH0KPC9tYWluPgpgOwpmdW5jdGlvbiBhcHBlbmRTdHlsZXNoZWV0cyhjc3NUZXh0cykgewogICAgY29uc3Qgc3R5bGVTaGVldCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7CiAgICBzdHlsZVNoZWV0LnR5cGUgPSAndGV4dC9jc3MnOwogICAgc3R5bGVTaGVldC50ZXh0Q29udGVudCA9IGNzc1RleHRzLmpvaW4oJ1xuXG4nKTsKICAgIGRvY3VtZW50LmhlYWQuYXBwZW5kQ2hpbGQoc3R5bGVTaGVldCk7Cn0KYXBwZW5kU3R5bGVzaGVldHMoWwogICAgYXBwQ3NzLmNzc1RleHQsCiAgICBGT1JNX0NTUy5jc3NUZXh0LAogICAgTUVTU0FHRVNfQ1NTLmNzc1RleHQsCiAgICBTRUFSQ0hfUkVTVUxUU19DU1MuY3NzVGV4dCwKICAgIENPTU1FTlRTX0NTUy5jc3NUZXh0LAogICAgWE1MX0NTUy5jc3NUZXh0LAogICAgQ0lSQ1VMQVJfUFJPR1JFU1NfQ1NTLmNzc1RleHQsIApdKTsKTGl0RWxlbWVudC5yZW5kZXIoYXBwSHRtbCwgZG9jdW1lbnQuYm9keSk7CmZ1bmN0aW9uIHBhcnNlU3RhdGljRGF0YSgpIHsKICAgIGNvbnN0IHNjcmlwdCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdzdGF0aWMtZGF0YS1zY3JpcHQnKTsKICAgIGNvbnN0IGRhdGEgPSBKU09OLnBhcnNlKHNjcmlwdC50ZXh0KTsKICAgIGNvbnN0IHZlcnNpb24gPSB0eXBlb2YgZGF0YS52ZXJzaW9uID09PSAnc3RyaW5nJyA/IGRhdGEudmVyc2lvbiA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGZsYWdzID0gdHlwZW9mIGRhdGEuZmxhZ3MgPT09ICdzdHJpbmcnID8gZGF0YS5mbGFncyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IGRlYnVnID0gdHlwZW9mIGRhdGEuZGVidWcgPT09ICdvYmplY3QnID8gZGF0YS5kZWJ1ZyA6IHVuZGVmaW5lZDsKICAgIGNvbnN0IHB1c2hJZCA9IHR5cGVvZiBkYXRhLnB1c2hJZCA9PT0gJ3N0cmluZycgPyBkYXRhLnB1c2hJZCA6IHVuZGVmaW5lZDsKICAgIHJldHVybiB7CiAgICAgICAgdmVyc2lvbiwKICAgICAgICBmbGFncywKICAgICAgICBkZWJ1ZywKICAgICAgICBwdXNoSWQKICAgIH07Cn0KY29uc3Qgc3RhdGljRGF0YSA9IHBhcnNlU3RhdGljRGF0YSgpOwpjb25zdCB2bSA9IG5ldyBWYWxpZGF0b3JBcHBWTSgpOwpjb25zdCB1cGRhdGVGb3JtID0gaW5pdEZvcm0oZG9jdW1lbnQsIHZtLCBzdGF0aWNEYXRhKTsKY29uc3QgdXBkYXRlTWVzc2FnZXMgPSBpbml0TWVzc2FnZXMoZG9jdW1lbnQsIHZtKTsKY29uc3QgdXBkYXRlU2VhcmNoUmVzdWx0cyA9IGluaXRTZWFyY2hSZXN1bHRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZUNvbW1lbnRzID0gaW5pdENvbW1lbnRzKGRvY3VtZW50LCB2bSk7CmNvbnN0IHVwZGF0ZVhtbCA9IGluaXRYbWwoZG9jdW1lbnQsIHZtKTsKdm0ub25DaGFuZ2UgPSAoKT0+ewogICAgdXBkYXRlRm9ybSgpOwogICAgdXBkYXRlTWVzc2FnZXMoKTsKICAgIHVwZGF0ZVNlYXJjaFJlc3VsdHMoKTsKICAgIHVwZGF0ZUNvbW1lbnRzKCk7CiAgICB1cGRhdGVYbWwoKTsKfTsKdm0uc3RhcnQoKTsKc2V0QXBwU3RhdGUoJ3N0YXJ0ZWQnKTsK';
